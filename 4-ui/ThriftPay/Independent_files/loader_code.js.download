(function(){
var hola_ldr_require;(function(){if(!navigator||!navigator.userAgent||/ MSIE [1-8]\./.test(navigator.userAgent)){return}var E={};hola_ldr_require=E;E.zdot=function(name){var zdot;if((zdot=window.spark_loader&&window.spark_loader.zdot)&&name in zdot)return zdot[name];if(1)

return {
json: undefined,
customer: "mediahuis",
agents: [],
all_agents: {},
version: "1.164.595",
qs_ver: 'ver=1.164.595',
disabled: !!+false,
host: 'player.h-cdn.com',
zlxc: +'0',
videojs: '/svc/cdn/pub/video-js.swf?md5=18467-517c596c',
videojs_osmf: '/svc/cdn/pub/videojs-osmf.swf?md5=186245-ec749577',
videojs_flashls: '/svc/cdn/pub/videojs-flashls.swf?md5=74609-97e11010',
videojs5_osmf: '/svc/cdn/pub/videojs5-osmf.swf?md5=189643-2d3bd98a',
videojs5: '/svc/cdn/pub/videojs-5/video-js.swf?md5=92486-46aeeea9',
videojs5_10: '/svc/cdn/pub/videojs_swf_sv.swf?md5=92547-f789b0cf',
thumbnails: '/svc/cdn/pub/css/videojs.thumbnails.css?md5=874-39aa2ea2',
tpl: "/svc/cdn/pub/loader.js?minify=true&snapshot=&host=player.h-cdn.com&percent=undefined&no_conf=1",
languages: undefined,
stats_css: '/css/stats.css?md5=24994-40fa0bc7',
cdngraph_js: '/svc/cdn/pub/cdngraph.js?md5=70587-065dd6d8',
hls_js: '/svc/cdn/pub/hls.js?md5=523418-00e00a91',
flow_hls_engine: '/svc/cdn/pub/flowplayer_hls_engine.js?md5=46884-c1150199',
flow_dash_engine: '/svc/cdn/pub/flowplayer_dash_engine.js?md5=20155-6413735a',
vjs_hls_provider: '/svc/cdn/pub/vjs_hls_provider.js?md5=12415-3bb37e3a',
vstat: '/svc/cdn/pub/vstat.js?md5=29859-35440a7a',
watch_later_css: '/svc/cdn/pub/css/watch_later.css?md5=31387-a074625c',
video_panel_css: '/svc/cdn/pub/css/video_panel.css?md5=1298-0dd2ff97',
widget_css: '/svc/cdn/pub/css/widget.css?md5=14051-2ca47f0e',
player_shortcuts_css: '//player2.h-cdn.com/svc/cdn/pub/css/player_shortcuts.css?md5=2469-7f4f386d',
seek_zones_css: '//player2.h-cdn.com/svc/cdn/pub/css/seek_zones.css?md5=2289-e85f9bee',
spark_logo_svg: '/svc/cdn/pub/img/spark_logo.svg?md5=2785-1ff6ddab',
watch_later_add_svg: '/svc/cdn/pub/img/watch_later_add.svg?md5=574-1f2c2604',
watch_later_wait_gif: '/svc/cdn/pub/img/watch_later_wait.gif?md5=29931-34fa5045',
watch_later_done_svg: '/svc/cdn/pub/img/watch_later_done.svg?md5=704-007c5b96',
watch_later_add_black_svg: '/svc/cdn/pub/img/watch_later_add_black.svg?md5=619-7fcdfa92',
watch_later_add_blue_svg: '/svc/cdn/pub/img/watch_later_add_blue.svg?md5=624-5cf7f91d',
watch_later_done_round_svg: '/svc/cdn/pub/img/watch_later_done_round.svg?md5=336-2ea5ca92',
watch_later_heart_add_svg: '/svc/cdn/pub/img/watch_later_heart_add.svg?md5=1355-1c5b9bb3',
watch_later_heart_add_hover_svg: '/svc/cdn/pub/img/watch_later_heart_add_hover.svg?md5=1348-c48aaf93',
watch_later_heart_wait_gif: '/svc/cdn/pub/img/watch_later_heart_wait.gif?md5=6772-844b3b57',
watch_later_heart_done_svg: '/svc/cdn/pub/img/watch_later_heart_done.svg?md5=953-5ea95b82',
playlist_css: '/svc/cdn/pub/css/playlist.css?md5=25204-04f9a1eb',
video_search_css: '/svc/cdn/pub/css/video_search.css?md5=15795-6a54f434',
share_css: '/svc/cdn/pub/css/share.css?md5=10538-b1000841',
share_dark_css: '/svc/cdn/pub/css/share_dark.css?md5=13704-6452ca88',
autoclick_css: '/svc/cdn/pub/css/autoclick.css?md5=887-4c3638ee',
casting_css: '/svc/cdn/pub/css/casting.css?md5=2632-4e80e829',
previews_widget_css: '//player.h-cdn.com/svc/cdn/pub/css/previews_widget.css?md5=7309-eaf2dcf3',
previews_widget_html: '//player.h-cdn.com/svc/cdn/pub/inc/previews_widget.html?md5=1811-08d2e5c2',
font_roboto_css: '//player2.h-cdn.com/svc/cdn/pub/css/font_roboto.css?md5=2351-c405d498',
}[name];
return{}[name]};var console=window.console;function ie9_console(){if(console)return;console={log:function(){},error:function(){}}}ie9_console();function escape_qs(param,opt){opt=opt||{};var qs=opt.qs||"";var sep=qs||opt.amp?"&":"";if(!param)return qs;var uri_comp=encodeURIComponent;var uri_comp_val=uri_comp;for(var i in param){var val=param[i];if(val===undefined)continue;var key=uri_comp(i);qs+=sep;if(val===null)qs+=key;else if(Array.isArray(val)){if(!val.length)continue;qs+=val.map(function(_val){return key+"="+uri_comp_val(_val)}).join("&")}else qs+=key+"="+uri_comp_val(val);sep="&"}return qs}function send_beacon(url,data){if(navigator&&navigator.sendBeacon){if(navigator.sendBeacon(url,to_form_data(data)))return}var is_xdr=window.XDomainRequest!==undefined;var xhr=is_xdr?new XDomainRequest:new XMLHttpRequest;xhr.open("POST",url);if(window.FormData&&!is_xdr)data=to_form_data(data);else{data=escape_qs(data);if(!is_xdr){xhr.setRequestHeader("Accept","*/*");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8")}else{return}}xhr.send(data)}function to_form_data(o){var data=new FormData;for(var k in o)data.append(k,o[k]);return data}function perr_raw(opt){var data={},qs={},zone,ver,hola_mode;if(window.hola_cdn){zone=window.hola_cdn.zone;ver=window.hola_cdn.ver;hola_mode=window.hola_cdn.mode}var root_top_url;try{root_top_url=window.top.location.href}catch(e){}qs.browser=window.chrome?"chrome":"other";qs.id=opt.id;qs.ver=ver;data.build="platform: "+navigator.platform+"\n"+"user_agent: "+navigator.userAgent;data.is_json=1;data.info=opt.info||{};data.info.customer=customer;data.info.zone=zone;data.info.hola_mode=hola_mode;data.info.location_url=location.href;data.info.page_url=root_top_url||location.href;data.info.referrer=document.referrer;data.info.injected=window.hola_dbg_conf&&window.hola_dbg_conf.loader&&window.hola_dbg_conf.loader.injected;data.info=JSON.stringify(data.info);data.bt=opt.bt;var protocol=window&&window.location&&window.location.protocol;protocol=!protocol||!protocol.startsWith("http")?"http:":protocol;var url=protocol+"//perr.h-cdn.com/be_client_cgi/perr?"+escape_qs(qs);send_beacon(url,data)}function array_reduce(callback){if(this===null){throw new TypeError("Array.prototype.reduce called on null or"+" undefined")}if(typeof callback!=="function")throw new TypeError(callback+" is not a function");var t=Object(this),len=t.length>>>0,k=0,value;if(arguments.length==2)value=arguments[1];else{while(k<len&&!(k in t))k++;if(k>=len)throw new TypeError("Reduce of empty array with no initial value");value=t[k++]}for(;k<len;k++){if(k in t)value=callback(value,t[k],k,t)}return value}function fix_obj_props(obj,prop,test,fix){if(!obj[prop]||!test()){if(!fix)return;obj[prop]=fix}Object.defineProperty(obj,prop,{writable:false})}var site_errors,hola_errors,js_errors,ldr_errors,is_loader;var customer=E.zdot("customer"),tpl=E.zdot("tpl");is_loader=/^\/svc\/cdn\/pub\/loader.js/.test(tpl);if(is_loader){window.addEventListener("error",function(e){try{var send_perr;js_errors=(js_errors||0)+1;if(e.error){if(/\.h-cdn.com/.test(e.filename)){hola_errors=(hola_errors||0)+1;send_perr=hola_errors==1}else site_errors=(site_errors||0)+1}if(send_perr){perr_raw({id:"www_cdn_db_hola_js_error",bt:(e.error||{}).stack,info:{filename:e.filename,err:""+e.error,hola_errors:hola_errors,js_errors:js_errors,site_errors:site_errors,ldr_errors:ldr_errors}})}}catch(err){console.error("ldr_require error handler error",err);ldr_errors=(ldr_errors||0)+1}})}fix_obj_props(Array.prototype,"reduce",function(){return[].reduce(String,1)==1},array_reduce);if(window.Prototype){delete Object.prototype.toJSON;delete Array.prototype.toJSON;delete String.prototype.toJSON;delete Number.prototype.toJSON;for(var p in[])Object.defineProperty(Array.prototype,p,{enumerable:false})}E.module_registry={};E.aliases={};E.config=function(config){if(config.map!==undefined)E.aliases=config.map};function init_module(module,req){if(module.inited==true)return module.init;var args=get_args(module);if(module.inited==true)return module.init;module.init=typeof module.init!=="function"?module.init:module.init.apply(null,args);if(module.init instanceof Object){for(var prop in module.exports){if(module.exports.hasOwnProperty(prop))module.init[prop]=module.exports[prop]}}else if(!module.init){console.error("empty module: "+req);ldr_errors=(ldr_errors||0)+1}else module.init=module.exports;module.inited=true;return module.init}function get_args(requirments){var args=[];var reqs=Array.isArray(requirments)?requirments:requirments.reqs;for(var i=0,len=reqs.length;i<len;i++){var req=reqs[i];switch(req){case"exports":if(!requirments.exports)throw new Error("ldr_require: invalid dependence!");args.push(requirments.exports);break;default:var module=E.module_registry[req]||(E.aliases[req]?E.module_registry[E.aliases[req]]:undefined);if(!module)throw new Error("ldr_require: missing module: "+req);args.push(init_module(module,req));break}}return args}E.define=function(name,requirements,init){if(typeof name!="string")throw new Error("ldr_require: module name is needed");if(init===undefined&&!Array.isArray(requirements)){init=requirements;requirements=[]}E.module_registry[name]={init:init,reqs:requirements,inited:false,exports:{}}};E.specified=function(name){return!!E.module_registry[name]};E.require=function(requirements,fn){var args=get_args(requirements);if(requirements&&requirements.length>5){setTimeout(function(){fn.apply(null,args)},10);return}fn.apply(null,args)};if(is_loader)window.hola_cdn_require=E.require})();function define(name,deps,init){if(hola_ldr_require)return hola_ldr_require.define(name,deps,init)}define.amd=true;var waiting_conf=hola_ldr_require&&!hola_ldr_require.zdot("json")&&[];if(waiting_conf){window.addEventListener("spark_config_loaded",function(){var funcs=waiting_conf;waiting_conf=false;funcs.forEach(function(f){f()})},false)}function require(reqs,fn){if(!hola_ldr_require)return;if(waiting_conf)return void waiting_conf.push(require.bind(null,reqs,fn));hola_ldr_require.require(reqs,fn)}require.config=function(){return require};require.specified=function(name){return hola_ldr_require.specified(name)};require.zdot=function(name){return hola_ldr_require.zdot(name)};define("/svc/cdn/pub/ldr_require.js",function(){});
define("/svc/cdn/pub/typedarray_shim.js",{__stub:1});
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=function(setup){module.exports=setup()};define("/util/es6_shim.js",[],function(){var E={t:{}};function add_prop(obj,prop,fn){if(obj[prop])return;Object.defineProperty(obj,prop,{enumerable:false,writable:true,configurable:true,value:fn})}E.t.object_assign=function(obj){for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source)continue;for(var prop in source){if(source.hasOwnProperty(prop))obj[prop]=source[prop]}}return obj};add_prop(Object,"assign",E.t.object_assign);E.t.object_values=function(obj){if(obj==null)throw new TypeError("Cannot convert undefined or null to object");var res=[];for(var prop in obj){if(obj.hasOwnProperty(prop))res.push(obj[prop])}return res};add_prop(Object,"values",E.t.object_values);E.t.object_entries=function(obj){if(obj==null)throw new TypeError("Cannot convert undefined or null to object");var res=[];for(var prop in obj){if(obj.hasOwnProperty(prop))res.push([prop,obj[prop]])}return res};add_prop(Object,"entries",E.t.object_entries);var can_set_proto={__proto__:[]}instanceof Array;E.t.object_setPrototypeOf=function(obj,proto){if(can_set_proto)obj.__proto__=proto;else{for(var prop in proto)obj[prop]=proto[prop]}return true};add_prop(Object,"setPrototypeOf",E.t.object_setPrototypeOf);E.t.string_startsWith=function(head){head=""+head;return!head||this.slice(0,head.length)===head};add_prop(String.prototype,"startsWith",E.t.string_startsWith);E.t.string_endsWith=function(tail){tail=""+tail;return!tail||this.slice(-tail.length)==tail};add_prop(String.prototype,"endsWith",E.t.string_endsWith);E.t.string_includes=function(search,index){return this.indexOf(search,index)>=0};add_prop(String.prototype,"includes",E.t.string_includes);E.t.string_repeat=function(n){var s="";for(var i=0;i<n;i++)s+=this;return s};add_prop(String.prototype,"repeat",E.t.string_repeat);E.t.string_trimLeft=function(){return this.replace(/^\s+/,"")};add_prop(String.prototype,"trimLeft",E.t.string_trimLeft);E.t.string_trimRight=function(){return this.replace(/\s+$/,"")};add_prop(String.prototype,"trimRight",E.t.string_trimRight);E.t.string_padStart=function(len,val){val=val||" ";var l=len-this.length;return l<=0?this:val.repeat(Math.ceil(l/val.length)).slice(0,l)+this};add_prop(String.prototype,"padStart",E.t.string_padStart);E.t.string_padEnd=function(len,val){val=val||" ";var l=len-this.length;return l<=0?this:this+val.repeat(Math.ceil(l/val.length)).slice(0,l)};add_prop(String.prototype,"padEnd",E.t.string_padEnd);E.t.array_includes=function(search,index){return this.indexOf(search,index)>=0};add_prop(Array.prototype,"includes",E.t.array_includes);E.t.array_find=function(fn,this_arg){var a=this,value;for(var i=0;i<a.length;i++){value=a[i];if(i in a&&fn.call(this_arg,value,i,a))return value}};add_prop(Array.prototype,"find",E.t.array_find);E.t.array_findIndex=function(fn,this_arg){var a=this,value;for(var i=0;i<a.length;i++){value=a[i];if(i in a&&fn.call(this_arg,value,i,a))return i}return-1};add_prop(Array.prototype,"findIndex",E.t.array_findIndex);E.t.array_of=function(){return Array.prototype.slice.call(arguments)};add_prop(Array,"of",E.t.array_of);E.t.array_from=function(a,fn,_this){a=Array.prototype.slice.call(a);return!fn?a:a.map(fn,_this)};add_prop(Array,"from",E.t.array_from);E.t.arraybuffer_slice=function(begin,end){begin=begin|0;end=(end==null?this.byteLength:end)|0;if(begin<0)begin+=this.byteLength;if(end<0)end+=this.byteLength;begin=Math.min(Math.max(0,begin),this.byteLength);end=Math.min(Math.max(0,end),this.byteLength);if(end-begin<=0)return new ArrayBuffer(0);var result=new ArrayBuffer(end-begin);var resultBytes=new Uint8Array(result);var sourceBytes=new Uint8Array(this,begin,end-begin);resultBytes.set(sourceBytes);return result};if(typeof ArrayBuffer!="undefined")add_prop(ArrayBuffer.prototype,"slice",E.t.arraybuffer_slice);add_prop(Number,"EPSILON",Math.pow(2,-52));E.t.number_isFinite=function(x){return typeof x=="number"&&isFinite(x)};add_prop(Number,"isFinite",E.t.number_isFinite);E.t.math_sign=function(x){x=+x;return x!==x?NaN:!x?x:x<0?-1:1};add_prop(Math,"sign",E.t.math_sign);E.t.math_trunc=function(x){x=+x;return x!==x?NaN:x<0?Math.ceil(x):Math.floor(x)};add_prop(Math,"trunc",E.t.math_trunc);E.t.math_imul=function(x,y){var hix=x>>>16&65535;var lox=x&65535;var hiy=y>>>16&65535;var loy=y&65535;return lox*loy+(hix*loy+lox*hiy<<16>>>0)|0};add_prop(Math,"imul",E.t.math_imul);function ie9_console(){if(typeof window!="object")return;if(window.console){if(!window.console.debug)window.console.debug=window.console.info;return}var console=window.console={};["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profiles","profileEnd","show","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"].forEach(function(p){console[p]=function(){}});["memory"].forEach(function(p){console[p]={}})}ie9_console();function ie9_location_origin(){if(typeof window!="object"||!window.location||"origin"in window.location){return}var location=window.location;var default_ports={"http:":80,"https:":443};var port=location.port;if(default_ports[location.protocol]==port)port=null;location.origin=location.protocol+"//"+location.hostname+(port?":"+port:"")}ie9_location_origin();function element_matches(){if(typeof Element!="object"&&typeof Element!="function"||Element.prototype.matches){return}Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector;if(Element.prototype.matches)return;Element.prototype.matches=function(s){var matches=(this.document||this.ownerDocument).querySelectorAll(s);var i=matches.length;while(--i>=0&&matches.item(i)!==this);return i>-1}}element_matches();function ie_edge_closest(){if(typeof Element!="object"&&typeof Element!="function"||Element.prototype.closest){return}Element.prototype.closest=function(selector){var el=this;while(el){if(el.matches(selector))return el;el=el.parentElement}return null}}ie_edge_closest();E.t.function_name=function(){var n=this.toString().match(/^function\s+([^\s(]+)/);return n&&n[1]||""};function ie_function_name(){if(ie_function_name.name=="ie_function_name")return;Object.defineProperty(Function.prototype,"name",{enumerable:false,configurable:false,get:E.t.function_name})}ie_function_name();function android18_animFrame(){if(typeof window!="object"||window.requestAnimationFrame)return;var start=Date.now();window.requestAnimationFrame=function(cb){setTimeout(function(){cb(Date.now()-start)},16)}}android18_animFrame();return E})})();
if(typeof hola_ldr_require!="undefined")hola_ldr_require.config({map:{events:"/util/events.js"}});define("/svc/cdn/pub/config.js",[],function(){return{}});require(["/util/es6_shim.js","/svc/cdn/pub/typedarray_shim.js"],function(){});
define("mp4box",{__stub:1});




define("muxjs",{__stub:1});



(function(){var __hola_stub_define,node_util;var is_node=typeof module=="object"&&module.exports&&module.children;var is_rn=typeof global=="object"&&!!global.nativeRequire||typeof navigator=="object"&&navigator.product=="ReactNative";if(is_rn)define=require("./require_node.js").define(module,"../");else if(!is_node)define=define||self.define;else{node_util=require("util");define=require("./require_node.js").define(module,"../")}define("/util/util.js",[],function(){var E={};E._is_mocha=undefined;E.is_mocha=function(){if(E._is_mocha!==undefined)return E._is_mocha;if(typeof process!="undefined"&&typeof process.env!="undefined")return E._is_mocha=process.env.IS_MOCHA||false;return E._is_mocha=false};E.is_lxc=function(){return is_node&&+process.env.LXC};E.f_mset=function(flags,mask,bits){return flags&~mask|bits};E.f_lset=function(flags,bits,logic){return E.f_mset(flags,bits,logic?bits:0)};E.f_meq=function(flags,mask,bits){return(flags&mask)==bits};E.f_eq=function(flags,bits){return(flags&bits)==bits};E.f_cmp=function(f1,f2,mask){return(f1&mask)==(f2&mask)};E.xor=function(a,b){return!a!=!b};E.div_ceil=function(a,b){return Math.floor((a+b-1)/b)};E.ceil_mul=function(a,b){return E.div_ceil(a,b)*b};E.floor_mul=function(a,b){return Math.floor(a/b)*b};E.range=function(x,a,b){return x>=a&&x<=b};E.range.ii=function(x,a,b){return x>=a&&x<=b};E.range.ie=function(x,a,b){return x>=a&&x<b};E.range.ei=function(x,a,b){return x>a&&x<=b};E.range.ee=function(x,a,b){return x>a&&x<b};E.clamp=function(lower_bound,value,upper_bound){if(value<lower_bound)return lower_bound;if(value<upper_bound)return value;return upper_bound};E.revcmp=function(a,b){return a>b?-1:a<b?1:0};E.union_with=function(fn){var res={},args;if(arguments.length==2&&typeof arguments[1]=="object")args=arguments[1];else args=Array.prototype.slice.call(arguments,1);for(var i=0;i<args.length;++i){for(var key in args[i]){var arg=args[i];res[key]=res.hasOwnProperty(key)?fn(res[key],arg[key]):arg[key]}}return res};function _clone_deep(obj){var i,n,ret;if(obj instanceof Array){ret=new Array(obj.length);n=obj.length;for(i=0;i<n;i++)ret[i]=obj[i]instanceof Object?_clone_deep(obj[i]):obj[i];return ret}else if(obj instanceof Date)return new Date(obj);else if(obj instanceof RegExp)return new RegExp(obj);else if(obj instanceof Function)return obj;ret={};for(i in obj)ret[i]=obj[i]instanceof Object?_clone_deep(obj[i]):obj[i];return ret}E.clone_deep=function(obj){if(!(obj instanceof Object))return obj;return _clone_deep(obj)};E.extend=function(obj){for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source)continue;for(var prop in source)obj[prop]=source[prop]}return obj};function is_object(obj){return obj&&obj.constructor==Object}E.extend_deep=function(obj){if(!is_object(obj))return obj;for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source)continue;for(var prop in source){if(is_object(source[prop])&&is_object(obj[prop]))E.extend_deep(obj[prop],source[prop]);else obj[prop]=source[prop]}}return obj};E.extend_deep_del_null=function(obj){for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source)continue;for(var prop in source){if(is_object(source[prop])){if(!is_object(obj[prop]))obj[prop]={};E.extend_deep_del_null(obj[prop],source[prop])}else if(source[prop]==null)delete obj[prop];else obj[prop]=source[prop]}}return obj};E.defaults=function(obj){if(!obj)obj={};for(var i=1;i<arguments.length;i++){var source=arguments[i];if(obj===undefined)continue;for(var prop in source){if(obj[prop]===undefined)obj[prop]=source[prop]}}return obj};E.defaults_deep=function(obj){if(obj!==undefined&&!is_object(obj))return obj;for(var i=1;i<arguments.length;i++){var source=arguments[i];if(obj===undefined)obj=E.clone_deep(source);else if(is_object(source)){for(var prop in source){var s=source[prop],d=obj[prop];if(d===undefined)obj[prop]=E.clone_deep(s);else E.defaults_deep(d,s)}}}return obj};E.clone=function(obj){if(!(obj instanceof Object))return obj;if(obj instanceof Array){var a=new Array(obj.length);for(var i=0;i<obj.length;i++)a[i]=obj[i];return a}return E.extend({},obj)};E.freeze_deep=function(obj){if(typeof obj=="object"){for(var prop in obj){if(obj.hasOwnProperty(prop))E.freeze_deep(obj[prop])}}return Object.freeze(obj)};E.equal_deep=function(a,b){var i;if(a===b)return true;if(!a||!b||a.constructor!==b.constructor)return false;if(a instanceof Function||a instanceof RegExp)return a.toString()==b.toString();if(a instanceof Date)return+a==+b;if(Array.isArray(a)){if(a.length!=b.length)return false;for(i=0;i<a.length;i++){if(!E.equal_deep(a[i],b[i]))return false}return true}if(is_object(a)){var a_keys=Object.keys(a),b_keys=Object.keys(b);if(a_keys.length!=b_keys.length)return false;for(i=0;i<a_keys.length;i++){var key=a_keys[i];if(!E.equal_deep(a[key],b[key]))return false}return true}return false};E.map_obj=function(obj,fn){var ret={};for(var i in obj)ret[i]=fn(obj[i],i,obj);return ret};E.sort_obj=function(obj,fn){if(obj instanceof Array||!(obj instanceof Object))return obj;var ret={},keys=Object.keys(obj).sort(fn);for(var i=0;i<keys.length;i++)ret[keys[i]]=E.sort_obj(obj[keys[i]],fn);return ret};E.forEach=function(obj,fn,_this){for(var i in obj)fn.call(_this,obj[i],i,obj)};E.find=function(obj,fn,_this){for(var i in obj){if(fn.call(_this,obj[i],i,obj))return obj[i]}};E.find_prop=function(obj,prop,val){return E.find(obj,function(o){return o[prop]===val})};E.isspace=function(c){return/\s/.test(c)};E.isdigit=function(c){return c>="0"&&c<="9"};E.isalpha=function(c){return c>="a"&&c<="z"||c>="A"&&c<="Z"};E.isalnum=function(c){return E.isdigit(c)||E.isalpha(c)};E.obj_pluck=function(obj,prop){var val=obj[prop];delete obj[prop];return val};E.proto_keys=function(proto){var keys=[];for(var i in proto)keys.push(i);return keys};E.values=function(obj){var values=[];for(var i in obj)values.push(obj[i]);return values};E.path=function(path){if(Array.isArray(path))return path;path=""+path;if(!path)return[];return path.split(".")};E.get=function(o,path,def){path=E.path(path);for(var i=0;i<path.length;i++){if(!o||typeof o!="object"&&typeof o!="function"||!(path[i]in o))return def;o=o[path[i]]}return o};E.set=function(o,path,value){var orig=o;path=E.path(path);for(var i=0;i<path.length-1;i++){var p=path[i];o=o[p]||(o[p]={})}o[path[path.length-1]]=value;return orig};E.unset=function(o,path){path=E.path(path);for(var i=0;i<path.length-1;i++){var p=path[i];if(!o[p])return;o=o[p]}delete o[path[path.length-1]]};var has_unique={};E.has=function(o,path){return E.get(o,path,has_unique)!==has_unique};E.own=function(o,prop){return Object.prototype.hasOwnProperty.call(o,prop)};E.bool_lookup=function(a,split){var ret={},i;if(typeof a=="string")a=a.split(split||/\s/);for(i=0;i<a.length;i++)ret[a[i]]=true;return ret};E.clone_inplace=function(dst,src){if(dst===src)return dst;if(Array.isArray(dst)){for(var i=0;i<src.length;i++)dst[i]=src[i];dst.splice(src.length)}else if(typeof dst=="object"){var k;for(k in src)dst[k]=src[k];for(k in dst){if(!src.hasOwnProperty(k))delete dst[k]}}return dst};if(node_util&&node_util.inherits)E.inherits=node_util.inherits;else{E.inherits=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}E.inherit_init=function(obj,ctor,params){var orig_proto=Object.getPrototypeOf(obj);var ctor_proto=Object.assign({},ctor.prototype);Object.setPrototypeOf(ctor_proto,orig_proto);Object.setPrototypeOf(obj,ctor_proto);return ctor.apply(obj,params)};E.pick=function(obj){var i,o={};for(i=1;i<arguments.length;i++){if(E.own(obj,arguments[i]))o[arguments[i]]=obj[arguments[i]]}return o};E.omit=function(obj,omit){var i,o={};obj=Object(obj);for(i in obj){if(!omit.includes(i))o[i]=obj[i]}return o};E.if_set=function(val,o,name){if(val!==undefined)o[name]=val};E.escape_dotted_keys=function(obj,repl){if(!Array.isArray(obj)&&!is_object(obj))return obj;repl=repl||"_";for(var prop in obj){if(E.own(obj,prop)){var new_prop=prop.replace(/\./g,repl);if(prop!=new_prop){obj[new_prop]=obj[prop];delete obj[prop]}if(Array.isArray(obj[new_prop])){obj[new_prop].forEach(function(e){E.escape_dotted_keys(e,repl)})}else if(is_object(obj[new_prop]))E.escape_dotted_keys(obj[new_prop],repl)}}};E.ensure_array=function(v,split){if(v==null||Array.isArray(v))return v||[];if(split&&typeof v=="string")return v.split(split==true?/[ ,]+/:split).filter(Boolean);return[v]};return E})})();
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;var is_rn=typeof global=="object"&&!!global.nativeRequire||typeof navigator=="object"&&navigator.product=="ReactNative";var qs;if(is_rn)define=require("./require_node.js").define(module,"../");else if(!is_node)define=define||self.define;else{define=require("./require_node.js").define(module,"../");var _require=require;qs=_require("querystring")}define("/util/url.js",["/util/util.js"],function(zutil){var assign=Object.assign;var E={};function replace_slashes(url){return url.replace(/\\/gi,"/")}E.add_proto=function(url){if(!url.match(/^([a-z0-9]+:)?\/\//i))url="http://"+url;return url};E.rel_proto_to_abs=function(url){var proto=is_node?"http:":location.protocol;return url.replace(/^\/\//,proto+"//")};E.get_top_level_domain=function(host){var n=host.match(/\.([^.]+)$/);return n?n[1]:""};E.get_host=function(url){var n=replace_slashes(url).match(/^(https?:)?\/\/([^\/]+)\/.*$/);return n?n[2]:""};E.get_host_without_tld=function(host){return host.replace(/^([^.]+)\.[^.]{2,3}(\.[^.]{2,3})?$/,"$1")};var generic_2ld={com:1,biz:1,net:1,org:1,xxx:1,edu:1,gov:1,ac:1,co:1,or:1,ne:1,kr:1,jp:1,jpn:1,cn:1};E.get_root_domain=function(domain){if(E.is_ip(domain))return domain;var s=domain.split("."),root=s,len=s.length;if(len>2){var hd=0;if(s[len-1]=="hola"){hd=2;if(s[len-2].match(/^\d+$/))hd=3}if(generic_2ld[s[len-2-hd]])root=s.slice(-3-hd,len-hd);else root=s.slice(-2-hd,len-hd)}return root.join(".")};E.get_domain_email=function(email){var match=email.toLowerCase().match(/^[a-z0-9_.\-+]+@(.*)$/);return match&&match[1]};E.get_root_domain_email=function(email){var domain=E.get_domain_email(email);return domain&&E.get_root_domain(domain)};E.get_path=function(url){var n=url.match(/^https?:\/\/[^\/]+(\/.*$)/);return n?n[1]:""};E.get_proto=function(url){var n=url.match(/^([a-z0-9]+):\/\//);return n?n[1]:""};E.get_host_gently=function(url){var n=replace_slashes(url).match(/^(?:(?:[a-z0-9]+?:)?\/\/)?([^\/]+)/);return n?n[1]:""};E.is_ip=function(host){var m=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/.exec(host);if(!m)return false;for(var i=1;i<=4;i++){if(+m[i]>255)return false}return true};E.is_ip_mask=function(host){var m=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/.exec(host);if(!m)return false;if(E.ip2num(host)==0)return false;var final=false;var check_num_mask=function(num){var arr=(num>>>0).toString(2).split(""),final=false;for(var i=0;i<arr.length;i++){if(final&&arr[i]=="1")return false;if(!final&&arr[i]=="0")final=true}return true};for(var i=1;i<=4;i++){if(+m[i]>255)return false;if(final&&+m[i]>0)return false;if(!final&&+m[i]<255){if(!check_num_mask(+m[i]))return false;final=true}}return!!final};E.ip2num=function(ip){var num=0;ip.split(".").forEach(function(octet){num<<=8;num+=+octet});return num>>>0};E.num2ip=function(num){return(num>>>24)+"."+(num>>16&255)+"."+(num>>8&255)+"."+(num&255)};E.is_ip_subnet=function(host){var m=/(.+?)\/(\d+)$/.exec(host);return m&&E.is_ip(m[1])&&+m[2]<=32};E.is_ip_netmask=function(host){if(!host||typeof host.split!=="function")return false;var ips=host.split("/");if(ips.length!=2||!E.is_ip(ips[0])||!E.is_ip_mask(ips[1]))return false;return true};E.is_ip_range=function(host){if(typeof host.split!=="function")return false;var ips=host.split("-");if(ips.length!=2||!E.is_ip(ips[0])||!E.is_ip(ips[1]))return false;return E.ip2num(ips[0])<E.ip2num(ips[1])};E.is_ip_port=function(host){var m=/(.+?)(?::(\d{1,5}))?$/.exec(host);return m&&E.is_ip(m[1])&&!(+m[2]>65535)};E.is_valid_url=function(url){return/^(https?:\/\/)?([a-z0-9-]+\.)+[a-z0-9-]+(\/.*)?$/i.test(url)};E.is_valid_domain=function(domain){return/^([a-z0-9]([a-z0-9-_]*[a-z0-9])?\.)+[a-z]{2,63}$/.test(domain)};E.is_hola_domain=function(domain){return E.is_valid_domain(domain)&&domain.search(/^(.*\.)?(hola\.org|holacdn\.com|h-cdn\.com)$/)!=-1};E.is_spark_domain=function(domain){return E.is_valid_domain(domain)&&domain.search(/^(.*\.)?(holaspark.com)/)!=-1};E.is_valid_email=function(email){var re=/^[a-z0-9_\-+]+(?:\.[a-z0-9_\-+]+)*@(.*)$/;var n=email.toLowerCase().match(re);return!!(n&&E.is_valid_domain(n[1]))};E.is_alias_email=function(email){if(!E.is_valid_email(email))return false;var n=email.toLowerCase().match(/^([a-z0-9_.\-+]+)@.*$/);return!!(n&&/.+\+.+/.test(n[1]))};E.get_main_email=function(email){if(!E.is_valid_email(email))return;if(E.is_alias_email(email))return email.replace(/\+.+@/,"@");return email};E.is_ip_in_range=function(ips_range,ip){if(!E.is_ip_range(ips_range)||!E.is_ip(ip))return false;var ips=ips_range.split("-");var min_ip=E.ip2num(ips[0]),max_ip=E.ip2num(ips[1]);var num_ip=E.ip2num(ip);return num_ip>=min_ip&&num_ip<=max_ip};E.is_ip_local=function(ip){return E.is_ip_in_range("10.0.0.0-10.255.255.255",ip)||E.is_ip_in_range("172.16.0.0-172.31.255.255",ip)||E.is_ip_in_range("192.168.0.0-192.168.255.255",ip)||E.is_ip_in_range("169.254.0.0-169.254.255.255",ip)};E.host_lookup=function(lookup,host){var pos;while(1){if(host in lookup)return lookup[host];if((pos=host.indexOf("."))<0)return;host=host.slice(pos+1)}};E.uri_obj_href=function(uri){return(uri.protocol||"")+(uri.slashes?"//":"")+(uri.host?(uri.auth?uri.auth+"@":"")+uri.host:"")+uri.path+(uri.hash||"")};var protocol_re=/^((?:about|http|https|file|ftp|ws|wss):)?(\/\/)?/i;var host_section_re=/^(.*?)(?:[\/?#]|$)/;var host_re=/^(?:(([^:@]*):?([^:@]*))?@)?([a-zA-Z0-9._+-]*)(?::(\d*))?/;var path_section_re=/^([^?#]*)(\?[^#]*)?(#.*)?$/;var path_re_loose=/^(\/(?:.(?![^\/]*\.[^\/.]+$))*\/?)?([^\/]*?(?:\.([^.]+))?)$/;var path_re_strict=/^(\/(?:.(?![^\/]*(?:\.[^\/.]+)?$))*\/?)?([^\/]*?(?:\.([^.]+))?)$/;E.parse=function(url,strict){function re(expr,str){var m;try{m=expr.exec(str)}catch(e){m=null}if(!m)return m;for(var i=0;i<m.length;i++)m[i]=m[i]===undefined?null:m[i];return m}url=url||location.href;var uri={orig:url};url=replace_slashes(url);var m,remaining=url;if(!(m=re(protocol_re,remaining)))return{};uri.protocol=m[1];if(uri.protocol!==null)uri.protocol=uri.protocol.toLowerCase();uri.slashes=!!m[2];if(!uri.protocol&&!uri.slashes){uri.protocol="http:";uri.slashes=true}remaining=remaining.slice(m[0].length);if(!(m=re(host_section_re,remaining)))return{};uri.authority=m[1];remaining=remaining.slice(m[1].length);if(!(m=re(host_re,uri.authority)))return{};uri.auth=m[1];uri.user=m[2];uri.password=m[3];uri.hostname=m[4];uri.port=m[5];if(uri.hostname!==null){uri.hostname=uri.hostname.toLowerCase();uri.host=uri.hostname+(uri.port?":"+uri.port:"")}if(!(m=re(path_section_re,remaining)))return{};uri.relative=m[0];uri.pathname=m[1];uri.search=m[2];uri.query=uri.search?uri.search.substring(1):null;uri.hash=m[3];if(!(m=re(strict?path_re_strict:path_re_loose,uri.pathname)))return{};uri.directory=m[1];uri.file=m[2];uri.ext=m[3];if(uri.file=="."+uri.ext)uri.ext=null;if(!uri.pathname)uri.pathname="/";uri.path=uri.pathname+(uri.search||"");uri.href=E.uri_obj_href(uri);return uri};E.qs_parse=function(q,bin,safe){var obj={};q=q.length?q.split("&"):[];var len=q.length;var unescape_val=bin?function(val){return qs.unescapeBuffer(val,true).toString("binary")}:safe?function(val){try{return decodeURIComponent(val.replace(/\+/g," "))}catch(e){return val}}:function(val){return decodeURIComponent(val.replace(/\+/g," "))};for(var i=0;i<len;++i){var x=q[i];var idx=x.indexOf("=");var kstr=idx>=0?x.substr(0,idx):x;var vstr=idx>=0?x.substr(idx+1):"";var k=unescape_val(kstr);var v=unescape_val(vstr);if(obj[k]===undefined)obj[k]=v;else if(Array.isArray(obj[k]))obj[k].push(v);else obj[k]=[obj[k],v]}return obj};function token_regex(s,end){return end?"^"+s+"$":s}E.http_glob_host=function(host,end){var port="";var parts=host.split(":");host=parts[0];if(parts.length>1)port=":"+parts[1].replace("*","[0-9]+");var n=host.match(/^(|.*[^*])(\*+)$/);if(n){host=E.http_glob_host(n[1])+(n[2].length==1?"[^./]+":"[^/]"+(n[1]?"*":"+"));return token_regex(host+port,end)}host=host.replace(/\*\*\./,"**").replace(/\*\./,"*").replace(/\./g,"\\.").replace(/\*\*/g,"(([^./]+\\.)+)?").replace(/\*/g,"[^./]+\\.");return token_regex(host+port,end)};E.http_glob_path=function(path,end){if(path[0]=="*")return E.http_glob_path("/"+path,end);var n=path.match(/^(|.*[^*])(\*+)([^*^\/]*)$/);if(n){path=E.http_glob_path(n[1])+(n[2].length==1?"[^/]+":".*")+E.http_glob_path(n[3]);return token_regex(path,end)}path=path.replace(/\*\*\//,"**").replace(/\*\//,"*").replace(/\//g,"\\/").replace(/\./g,"\\.").replace(/\*\*/g,"(([^/]+\\/)+)?").replace(/\*/g,"[^/]+\\/");return token_regex(path,end)};E.http_glob_url=function(url,end){var n=url.match(/^((.*):\/\/)?([^\/]+)(\/.*)?$/);if(!n)return null;var prot=n[1]?n[2]:"*";var host=n[3];var path=n[4]||"**";if(prot=="*")prot="https?";host=E.http_glob_host(host);path=E.http_glob_path(path);return token_regex(prot+":\\/\\/"+host+path,end)};E.root_url_cmp=function(a,b){var a_s=a.match(/^[*.]*([^*]+)$/);var b_s=b.match(/^[*.]*([^*]+)$/);if(!a_s&&!b_s)return false;var re,s;if(a_s&&b_s&&a_s[1].length>b_s[1].length||a_s&&!b_s){s=a_s[1];re=b}else{s=b_s[1];re=a}s=E.add_proto(s)+"/";if(!(re=E.http_glob_url(re,1)))return false;try{re=new RegExp(re)}catch(e){return false}return re.test(s)};E.qs_strip=function(url){return/^[^?#]*/.exec(url)[0]};E.qs_str=function(qs){var q=[];for(var k in qs){(Array.isArray(qs[k])?qs[k]:[qs[k]]).forEach(function(v){q.push(encodeURIComponent(k)+"="+encodeURIComponent(v))})}return q.join("&")};E.qs_add=function(url,qs){var u=E.parse(url),q=assign(u.query?E.qs_parse(u.query):{},qs);u.path=u.pathname+"?"+E.qs_str(q);return E.uri_obj_href(u)};E.qs_parse_url=function(url){return E.qs_parse(url.replace(/(^.*\?)|(^[^\?]*$)/,""))};E.safe_redir=function(url,default_hostname){if(!url)return;var u=E.parse(url,true);var hostname=u.hostname||default_hostname;if(!/^https?:$/.test(u.protocol)||!hostname)return;if(E.is_hola_domain(hostname)||E.is_spark_domain(hostname)||zutil.is_mocha()&&hostname=="localhost"){return"https://"+hostname+encodeURI(u.path)}};return E})})();
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/escape.js",[],function(){var E={};E.un={};var html_escape_table={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};E.html=function(html){return html.replace(/[&<>"']/g,function(m){return html_escape_table[m[0]]})};E.sh=function(s_or_a){function single(s){s=""+s;if(!s)return'""';if(/^[a-z0-9_\-.\/:]+$/i.test(s))return s;return'"'+s.replace(/([\\"`$])/g,"\\$1")+'"'}if(arguments.length==1&&!Array.isArray(s_or_a))return single(s_or_a);var s="",a=Array.isArray(s_or_a)?s_or_a:arguments;for(var i=0;i<a.length;i++)s+=(i?" ":"")+single(a[i]);return s};E.un_sh=function(s,keep_esc){var state={PARSE_STATE_INIT:0,PARSE_STATE_NORMAL_ARG:1,PARSE_STATE_QUOTE_ARG:2},cur_state=state.PARSE_STATE_INIT;var i,quote=0,argv=[],a="";for(i=0;i<s.length;i++){var esc=0;a+=s[i];if(s[i]=="\\"&&s[1]){if(!keep_esc)a=a.slice(0,-1);esc=1;i++;a+=s[i]}switch(cur_state){case state.PARSE_STATE_INIT:switch(s[i]){case"\r":case"\n":case" ":case"	":if(!esc){a="";break}case'"':case"'":if(!esc){cur_state=state.PARSE_STATE_QUOTE_ARG;if(!keep_esc)a=a.slice(0,-1);quote=s[i];break}default:cur_state=state.PARSE_STATE_NORMAL_ARG}break;case state.PARSE_STATE_NORMAL_ARG:switch(s[i]){case"\r":case"\n":case" ":case"	":if(!esc){cur_state=state.PARSE_STATE_INIT;a=a.slice(0,-1);argv.push(a);a=""}break;case'"':case"'":if(!esc){cur_state=state.PARSE_STATE_QUOTE_ARG;quote=s[i];if(!keep_esc)a=a.slice(0,-1)}break}break;case state.PARSE_STATE_QUOTE_ARG:if(s[i]==quote&&!esc){cur_state=state.PARSE_STATE_NORMAL_ARG;if(!keep_esc)a=a.slice(0,-1)}break}}if(cur_state==state.PARSE_STATE_NORMAL_ARG){cur_state=state.PARSE_STATE_INIT;argv.push(a)}if(cur_state!=state.PARSE_STATE_INIT)throw"error parsing shell";return argv};E.regex=function(s){return s.replace(/[[\]{}()*+?.\\^$|\/]/g,"\\$&")};E.uri_comp=function(s){return encodeURIComponent(s).replace(/%20/g,"+")};var http_escape_chars=[];(function(){var i;for(i=0;i<256;i++){var c=String.fromCharCode(i);http_escape_chars[i]=/^[a-zA-Z0-9_.~,\-]$/.test(c)?c:"%"+("0"+i.toString(16)).slice(-2)}})();E.encodeURIComponent_bin=function(s_or_b){var s=typeof Buffer!="undefined"&&s_or_b instanceof Buffer?s_or_b.toString("binary"):""+s_or_b;var esc="";for(var i=0;i<s.length;i++)esc+=http_escape_chars[s.charCodeAt(i)]||encodeURIComponent(s[i]);return esc};E.qs=function(param,opt){opt=opt||{};var qs=opt.qs||"";var sep=qs||opt.amp?"&":"";if(!param)return qs;var uri_comp=opt.space_plus===undefined||opt.space_plus?E.uri_comp:encodeURIComponent;var uri_comp_val=opt.bin?E.encodeURIComponent_bin:uri_comp;for(var i in param){var val=param[i];if(val===undefined)continue;var key=uri_comp(i);qs+=sep;if(val===null)qs+=key;else if(Array.isArray(val)){if(!val.length)continue;qs+=val.map(function(val){return key+"="+uri_comp_val(val)}).join("&")}else qs+=key+"="+uri_comp_val(val);sep="&"}return qs};E.uri=function(uri,qs,hash){var opt;if(typeof uri=="string")opt={uri:uri,_qs:qs,hash:hash};else{opt=Object.assign({},uri);opt._qs=opt.qs;opt.qs=undefined}uri=opt.uri;qs=typeof opt._qs=="string"?opt._qs:E.qs(opt._qs,opt);hash=typeof opt.hash=="string"?opt.hash:E.qs(opt.hash,opt);if(qs){if(!uri.includes("?"))uri+="?";else if(uri[uri.length-1]!="?"&&uri[uri.length-1]!="&")uri+="&"}else qs="";if(hash)hash="#"+hash;else hash="";return uri+qs+hash};E.mailto_url=function(mail){return"mailto:"+(mail.to||"")+"?"+E.qs({cc:mail.cc,bcc:mail.bcc,subject:mail.subject,body:mail.body},{space_plus:false})};E.parse={};E.parse.eat_token=function(s_obj,re){var match;if(!(match=re.exec(s_obj.s)))return match;s_obj.s=s_obj.s.substr(match.index+match[0].length);return match};E.parse.http_words=function(val){var res=[],o={s:val},eat_token=E.parse.eat_token,match;while(o.s){if(match=eat_token(o,/^\s*(=*[^\s=;,]+)/)){var v=match[1];if(match=eat_token(o,/^\s*=\s*\"([^\"\\]*(?:\\.[^\"\\]*)*)\"/))res.push([v,match[1].replace(/\\(.)/,"$1")]);else if(match=eat_token(o,/^\s*=\s*([^;,\s]*)/))res.push([v,match[1].replace(/\s+$/,"")]);else res.push([v,null])}else if(match=eat_token(o,/^\s*,/));else if((match=eat_token(o,/^\s*;/))||(match=eat_token(o,/^\s+/)));else throw new Error("This should not happen: "+o.s)}return res};return E})})();
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;if(!is_node)define=define||self.define;else define=function(setup){module.exports=setup()};define("/util/user_agent.js",[],function(){var E={};var win_versions={"10.0":"10.0",6.3:"8.1",6.2:"8",6.1:"7","6.0":"vista",5.2:"2003",5.1:"xp","5.0":"2000"};var arch_mapping={x86_64:"64",i686:"32",arm:"arm"};var check_hola=/\bhola_android\b/i;var check_android_cdn=/Android.* CDNService\/([0-9\.]+)$/;var check_ios_cdn=/ CDNService\/([0-9\.]+)$/;var check_hola_player_app=/ (Spark|Hola)Player/;var check_opera=/\bOPR\b\/(\d+)/i;var check_edge=/\bEdge\b\/(\d+)/i;var check_xbox=/\bxbox\b/i;var check_ucbrowser=/\bUCBrowser\b\/(\d+)/i;var check_webview=/ Version\/(\d+)(\.\d)/;var is_browser=!is_node&&typeof window!="undefined";function ios_ua(ua,safari_ver){var res;if(res=/(?:iPhone|iPad|iPod|iPod touch);.*?OS ([\d._]+)/.exec(ua)){var ios_ver=res[1];var is_chrome=/CriOS/.test(ua);var is_firefox=/FxiOS/.test(ua);var is_hola_ios=is_browser&&(window.hola_cdn_sdk||window.spark_ios_sdk)||check_ios_cdn.test(ua);var ucbrowser_ver=(check_ucbrowser.exec(ua)||[])[1];var is_ucbrowser=!!ucbrowser_ver;return{browser:"safari",version:safari_ver||ios_ver,ios:ios_ver,hola_ios:is_hola_ios,chrome:is_chrome,firefox:is_firefox,ucbrowser:is_ucbrowser,ucbrowser_version:ucbrowser_ver,webview:/Twitter/.test(ua)?"twitter":/GSA\/\d+/.test(ua)?"googlesearch":/FBAV\/\d+/.test(ua)?"facebook":!safari_ver&&!is_chrome&&!is_firefox&&!is_ucbrowser&&!is_hola_ios}}if(/HolaCDN iOS/.exec(ua))return{browser:"safari",hola_ios:true}}function check_chromium(ua){if(check_webview.test(ua)||/Android/.test(ua)||/ Mobile /.test(ua)||check_opera.test(ua)){return false}var group="(?: (\\w*)\\/)?",ver="\\/[\\d\\.]+";var res=new RegExp("AppleWebKit"+ver+"(?: \\(.*\\))?"+group+".* Chrome"+ver+group+".* Safari"+ver+group).exec(ua);return res&&(res[1]||res[2]||res[3])}E.guess_browser=function(ua){var res;ua=ua||(is_browser?window.navigator&&navigator.userAgent:"");if(res=/\bOpera Mini\/(\d+)/.exec(ua))return{browser:"opera_mini",version:res[1]};var ucbrowser=check_ucbrowser.exec(ua);if(res=/[( ]MSIE ([6789]|10).\d[);]/.exec(ua))return{browser:"ie",version:res[1],xbox:check_xbox.test(ua)};if(res=/[( ]Trident\/\d+(\.\d)+.*rv:(\d\d)(\.\d)+[);]/.exec(ua))return{browser:"ie",version:res[2],xbox:check_xbox.test(ua)};if(res=/ Chrome\/(\d+)(\.\d+)+.* Safari\/\d+(\.\d+)+/.exec(ua)){var opera=check_opera.exec(ua);var edge;if(edge=check_edge.exec(ua))return{browser:"edge",version:edge[1]};var chromium_based=check_chromium(ua);return{browser:"chrome",version:res[1],android:ua.match(/Android/),webview:ua.match(check_webview),hola_android:check_hola.test(ua),hola_browser:chromium_based=="Hola",hola_app:check_android_cdn.test(ua),hola_player_app:check_hola_player_app.test(ua),chromium_based:chromium_based,opera:opera&&!!opera[1],opera_version:opera?opera[1]:undefined,ucbrowser:ucbrowser&&!!ucbrowser[1],ucbrowser_version:ucbrowser?ucbrowser[1]:undefined,webos_app:/Web0S/.test(ua),samsung_browser:/SamsungBrowser/.test(ua)}}if(res=/ QupZilla\/(\d+\.\d+\.\d+).* Safari\/\d+.\d+/.exec(ua))return{browser:"qupzilla",version:res[1]};if(res=/\(PlayStation (\d+) (\d+\.\d+)\).* AppleWebKit\/\d+.\d+/.exec(ua)){return{browser:"playstation"+res[1],version:res[2]}}if(res=/\(SMART-TV; Linux; Tizen ([0-9.]+)\) AppleWebkit\//.exec(ua))return{browser:"samsung_tizen",version:res[1]};if(res=/ Version\/(\d+)(\.\d)+.* Safari\/\d+.\d+/.exec(ua)){if(!ua.match(/Android/))return ios_ua(ua,res[1])||{browser:"safari",version:res[1]};return{browser:"chrome",version:res[1],android:true,webview:true,hola_android:check_hola.test(ua),hola_app:check_android_cdn.test(ua),hola_player_app:check_hola_player_app.test(ua),ucbrowser:ucbrowser&&!!ucbrowser[1],ucbrowser_version:ucbrowser?ucbrowser[1]:undefined,samsung_browser:/SamsungBrowser/.test(ua)}}if(res=/ (Firefox|PaleMoon)\/(\d+).\d/.exec(ua)){return{browser:"firefox",version:res[2],palemoon:res[1]=="PaleMoon"}}if(/Hola\/\d+\.\d+.*?(?:iPhone|iPad|iPod)/.exec(ua))return{browser:"safari",version:"Hola"};if(res=ios_ua(ua))return res;return{}};E.browser_to_string=function(browser){if(typeof browser!="object"||!browser.browser)return"unknown";var s=browser.browser=="ie"&&browser.version>11?"edge":browser.browser;if(browser.version)s+=" "+browser.version;if(browser.chrome)s+=" chrome";if(browser.firefox)s+=" firefox";if(browser.xbox)s+=" xbox";if(browser.android)s+=" android";if(browser.webview){s+=" webview";if(typeof browser.webview=="string")s+="-"+browser.webview}if(browser.chromium_based)s+=" chromium_based";if(browser.samsung_browser)s+=" samsung";if(browser.opera){s+=" opera";if(browser.opera_version)s+="-"+browser.opera_version}if(browser.hola_android)s+=" hola_android";if(browser.hola_app)s+=" hola_app";if(browser.hola_player_app)s+=" hola_player_app";if(browser.ucbrowser){s+=" ucbrowser";if(browser.ucbrowser_version)s+="-"+browser.ucbrowser_version}if(browser.palemoon)s+=" palemoon";if(browser.ios)s+=" ios";if(browser.webos_app)s+=" webos_app";return s?s:"unknown"};E.guess=function(ua,platform){var res;ua=ua||(is_browser?navigator.userAgent:"");platform=platform||(is_browser?navigator.platform:"");if(check_xbox.exec(ua))return{os:"xbox",mobile:false};if(res=/Windows(?: NT(?: (.*?))?)?[);]/.exec(ua)){return{os:"windows",version:win_versions[res[1]],release_version:res[1],arch:ua.match(/WOW64|Win64|x64/)?"64":"32",mobile:false}}if(/Windows Phone/.exec(ua))return{os:"winphone",mobile:true};if(/Macintosh/.exec(ua)){if(is_browser&&navigator.maxTouchPoints>1)return{os:"ios",mobile:true};if(res=/Macintosh.*; (?:Intel|PPC) Mac OS X (\d+[._]\d+)/.exec(ua)){return{os:"macos",version:res[1].replace("_","."),mobile:false}}return{os:"macos",mobile:false}}if(/Web0S.*SmartTV/.exec(ua)){return{os:"webos",version:/Chrome/.test(ua)?"3":"2",mobile:false,tv:true}}if(res=/(Android|Andr0id)(?: (\d+\.\d+))?/.exec(ua))return{os:"android",version:res[2],mobile:true};if(res=/(Linux|CrOS|OpenBSD|FreeBSD)(?: (x86_64|i686|arm))?/.exec(ua)){if(check_opera.test(ua)&&res[1]=="Linux"&&res[2]=="x86_64"&&/^Linux arm/.test(platform)){return{os:"android",mobile:true}}return{os:res[1].toLowerCase(),arch:arch_mapping[res[2]],nix:true,mobile:false}}if(res=/(?:iPhone|iPad|iPod|iPod touch);.*?OS (\d+[._]\d+)/.exec(ua))return{os:"ios",version:res[1].replace("_","."),mobile:true};if(/iPhone|iPad|iPod|HolaCDN iOS/.exec(ua))return{os:"ios",mobile:true};if(/PLAYSTATION/.exec(ua))return{os:"ps",mobile:false};if(/HitLeap Viewer/.exec(ua))return{os:"windows",mobile:false};return{}};E.guess_device=function(ua){var res;ua=ua||(is_browser?navigator.userAgent:"");if(res=/(iPhone|iPad|iPod)/.exec(ua))return{device:res[1].toLowerCase()};return{}};E.support_fullscreen=function(){return!!(is_browser&&typeof document!="undefined"&&(document.fullscreenEnabled||document.mozFullScreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled))};E.support_hover=function(){if(!is_browser)return false;if(window.matchMedia&&window.matchMedia("(hover: hover)").matches)return true;return!E.guess().mobile};return E})})();
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;var is_rn=typeof global=="object"&&!!global.nativeRequire||typeof navigator=="object"&&navigator.product=="ReactNative";if(!is_node&&!is_rn)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/events.js",[],function(){function EventEmitter(){this._events={}}EventEmitter.prototype.listeners=function listeners(name){var events=this._events&&this._events[name]||[];var length=events.length,listeners=[],event;for(var i=0;i<length;event=events[++i])listeners.push(events[i].fn);return listeners};EventEmitter.prototype.emit=function emit(name,a1,a2,a3,a4,a5){if(!this._events||!this._events[name])return false;var listeners=this._events[name],length=listeners.length;var len=arguments.length,event=listeners[0],args,i;if(length===1){switch(len){case 1:event.fn.call(event.context||this);break;case 2:event.fn.call(event.context||this,a1);break;case 3:event.fn.call(event.context||this,a1,a2);break;case 4:event.fn.call(event.context||this,a1,a2,a3);break;case 5:event.fn.call(event.context||this,a1,a2,a3,a4);break;case 6:event.fn.call(event.context||this,a1,a2,a3,a4,a5);break;default:for(i=1,args=new Array(len-1);i<len;i++)args[i-1]=arguments[i];event.fn.apply(event.context||this,args)}if(event.once)remove_listener.apply(this,[name,event])}else{for(i=1,args=new Array(len-1);i<len;i++)args[i-1]=arguments[i];for(i=0;i<length;event=listeners[++i]){event.fn.apply(event.context||this,args);if(event.once)remove_listener.apply(this,[name,event])}}return true};function add_listener(name,fn,opt){opt=opt||{};if(!this._events)this._events={};if(!this._events[name])this._events[name]=[];var event={fn:fn};if(opt.context)event.context=opt.context;if(opt.once)event.once=opt.once;if(opt.prepend)this._events[name].unshift(event);else this._events[name].push(event);return this}function remove_listener(name,listener){if(!this._events||!this._events[name])return this;var listeners=this._events[name],events=[];var is_fn=typeof listener=="function";for(var i=0,length=listeners.length;i<length;i++){if(!listener)continue;if(is_fn&&listeners[i].fn!==listener||!is_fn&&listeners[i]!==listener){events.push(listeners[i])}}if(events.length)this._events[name]=events;else this._events[name]=null;return this}EventEmitter.prototype.on=function on(name,fn,context){return add_listener.apply(this,[name,fn,{context:context}])};EventEmitter.prototype.once=function once(name,fn,context){return add_listener.apply(this,[name,fn,{context:context,once:true}])};EventEmitter.prototype.prependListener=function prependListener(name,fn,context){return add_listener.apply(this,[name,fn,{context:context,prepend:true}])};EventEmitter.prototype.prependOnceListener=function prependOnceListener(name,fn,context){return this.prependListener(name,fn,{context:context,prepend:true,once:true})};EventEmitter.prototype.removeListener=function removeListener(name,fn){return remove_listener.apply(this,[name,fn])};EventEmitter.prototype.removeAllListeners=function removeAllListeners(name){if(!this._events)return this;if(name)this._events[name]=null;else this._events={};return this};EventEmitter.prototype.off=EventEmitter.prototype.removeListener;EventEmitter.prototype.addListener=EventEmitter.prototype.on;EventEmitter.prototype.setMaxListeners=function setMaxListeners(){return this};EventEmitter.prototype.eventNames=function eventNames(){var _this=this;return Object.keys(this._events).filter(function(e){return _this._events[e]!==null})};EventEmitter.EventEmitter=EventEmitter;EventEmitter.EventEmitter2=EventEmitter;EventEmitter.EventEmitter3=EventEmitter;return EventEmitter})})();
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");define=function(name,deps,fn){return define_node(name,["/util/url.js","/util/escape.js","/util/user_agent.js","/util/util.js","/util/events.js"],fn)}}define("/svc/cdn/pub/util.js",["/util/url.js","/util/escape.js","/util/user_agent.js","/util/util.js","/util/events.js"],function(zurl,zescape,user_agent,zutil,events){var E={conf:{}};var assign=Object.assign;var ms_sec=1e3,ms_min=60*ms_sec;E.is_enabled=function(module){return!!module&&!module.__stub};if(is_node){E.uri_opts_list=[]}else{E.geoip={};E.player_url="https://player.h-cdn.com";E.jtest={};E.uri_opts_list=["tech"];var protocol=typeof window!="undefined"&&window.location&&window.location.protocol;E.protocol=!protocol||!protocol.startsWith("http")?"http:":protocol;E.is_spark_site=typeof window!="undefined"&&!!window.document.referrer.match(/https?:\/\/holaspark\.com\/$/);E.is_top=typeof window!="undefined"&&window.top==window||E.is_spark_site;var top_url;try{top_url=!!window.top.location.href}catch(e){top_url=false}E.is_friendly_iframe=!E.is_top&&top_url;E.is_unfriendly_iframe=!E.is_top&&!top_url;E.mvp_marker=null;E.log={crit:function(){},debug:function(){},err:function(){},info:function(){},notice:function(){},set_module:function(){},warn:function(){}};E.ERR={failed:-1,ranges_unsupported:-2,aborted:-3,head_unsupported:-4,disconnected:-5,unicode_bom:-6,busy:-7};E.ERR_str={"-1":"failed","-2":"ranges_unsupported","-3":"aborted","-4":"head_unsupported","-5":"disconnected","-6":"unicode_bom","-7":"busy"};E.BEFOREUNLOAD=typeof navigator!="undefined"&&navigator.userAgent.match(/iPad|iPhone|iPod/)?"pagehide":"beforeunload";E.has_beacon=typeof navigator!="undefined"&&navigator.sendBeacon;E.browser_init=function(ua,platform){var browser=E.browser=user_agent.guess_browser(ua);var guess=E.guess=user_agent.guess(ua,platform);E.browser_support_fullscreen=user_agent.support_fullscreen();E.browser_string=user_agent.browser_to_string(E.browser);E.is_chrome=browser.browser=="chrome"&&!browser.opera;E.is_firefox=browser.browser=="firefox";E.is_edge=browser.browser=="edge";E.is_ie=browser.browser=="ie";E.is_opera=browser.opera;E.is_samsung=browser.samsung_browser;E.is_ucbrowser=browser.ucbrowser;E.is_safari=browser.browser=="safari";E.is_webview=!!browser.webview;E.is_windows=guess.os=="windows";E.is_android=guess.os=="android";E.is_winphone=guess.os=="winphone";E.is_mac=guess.os=="macos";E.is_ios=guess.os=="ios";E.is_linux=guess.os=="linux";E.is_webos=guess.os=="webos";E.is_mobile=guess.mobile;E.is_arch_32=guess.arch=="32";E.is_tv=guess.tv;E.is_ios_sdk=browser.hola_ios;E.is_android_sdk=browser.hola_app;E.is_app=browser.hola_player_app;E.browser_rule_s=E.browser.opera?"opera":E.browser.hola_app?"android_app":E.browser.hola_ios?"ios_app":E.browser.webos_app?"webos_app":E.browser.chromium_based?"chromium_based":E.browser.browser};E.browser_init();E.fix_url=function(url){return url.startsWith("//")?E.protocol+url:url};function dom_query_fn(method){return function(selector){var method_exists_on=function(root){return root&&root[method]};var query=function(root){return root&&root[method]?root[method](selector):null};if(method_exists_on(document))return query(document);if(method_exists_on(document.body)||method_exists_on(document.head)){return query(document.body)||query(document.head)}return query(document.createElement("div"))}}E.dom_query=dom_query_fn("querySelector");E.dom_query_all=dom_query_fn("querySelectorAll");E.dom_query_foreach=function(selector,cb){var nodes=E.dom_query_all(selector);for(var i=0;i<nodes.length;i++)cb(nodes[i])};E.new_event=function(name,init){if(typeof Event=="function")return new Event(name,init);var evt=document.createEvent("Event");evt.initEvent(name,true,true);return evt};E.clone_event=function(evt){return E.new_event(evt.type,evt)};E.is_numeric=function(n){return!isNaN(n)&&n!=null&&n!=Infinity};E.valid_ranges=function(ranges){return ranges&&(!ranges.length||ranges.every(function(r){return E.is_numeric(r.from)&&E.is_numeric(r.to)}))};E.remove_from_qs=function(qs,remove){var pairs=qs.split("&"),params={};pairs.forEach(function(p){var split=p.split("=");params[split[0]]=split[1]});Object.keys(params).forEach(function(param){if(remove.includes(decodeURIComponent(param)))delete params[param]});qs="";for(var p in params){qs+=(qs.length?"&":"")+p+(params[p]!==undefined?"="+params[p]:"")}return qs};E.get_platform_conf=function(conf){var pconf;conf=conf||{};if(E.is_app&&conf.app){pconf=conf.app.use_desktop_conf?assign({},conf.desktop,{disable:conf.app.disable}):conf.app}else if((E.is_mobile||E.is_app)&&conf.mobile){pconf=conf.mobile.use_desktop_conf?assign({},conf.desktop,{disable:conf.mobile.disable,use_desktop_conf:true}):conf.mobile}if(!E.is_mobile&&!E.is_app&&conf.desktop)pconf=conf.desktop;if(pconf){conf=assign({},zutil.omit(conf,["desktop","mobile","app"]),pconf)}return conf};E.get_feature_conf=function(conf,default_conf){var pconf=E.get_platform_conf(conf);conf=zutil.defaults_deep({},pconf,default_conf);var fn;if(!(fn=conf.custom_conf_fn||conf.custom_options_func))return conf;try{if(typeof fn=="string")fn=new Function(fn);conf=zutil.defaults_deep(fn(),conf);delete conf.custom_conf_fn;delete conf.custom_options_func}catch(e){E.log.err("invalid custom_conf_fn function: "+(e&&e.toString()))}return conf};E.get_tooltip_position=function(player_conf){if(E.is_mobile)return"hidden";var pos=player_conf.tooltip_position||"auto";if(pos=="auto")return player_conf.position.includes("l")?"right":"left";return player_conf.tooltip_position};E.conv_playlist_for_widget=function(list){return list.map(function(obj){obj.video_info=obj.video_info||{};return{description:obj.video_info.description||"",dur:obj.video_info.dur||0,page_url:obj.location||"",poster:obj.video_info.poster||"",video_poster:obj.video_info.video_poster||"",video_url:obj.video_info.url||"",title:obj.video_info.title||"",total:obj.video_info.total||0,ts:obj.video_info.ts||0}})};E.init=function(conf){if(E.inited)return;E.inited=true;E.mvp_marker=null;E.conf=zutil.extend_deep({},conf);E.has_ext=E.conf.loader&&E.conf.loader.injected;E.ver=E.conf.ver;E._events=new E.events;if(typeof window!="undefined")window.addEventListener(E.BEFOREUNLOAD,on_beforeunload);if(typeof document!="undefined"&&document.visibilityState){E.is_hidden=document.visibilityState!="visible";document.addEventListener("visibilitychange",on_visibilitychange)}};function on_beforeunload(){E.is_beforeunload=true;E._events.emit("beforeunload");E._events.emit("zbeforeunload",{type:"beforeunload"})}function on_visibilitychange(){if(document.visibilityState=="visible"){E.is_hidden=false;E._events.emit("visible_state");if(E.is_mobile)E._events.emit("visibility_start")}else if(document.visibilityState=="hidden"){E.is_hidden=true;E._events.emit("hidden_state");if(E.is_mobile){E._events.emit("visibility_end");E._events.emit("zbeforeunload",{type:"visibility_end"})}}}E.is_mode_stats=function(zone){return zone.CG("mode")=="stats"};E.is_mode_cdn=function(zone){return zone.CG("mode")=="cdn"};E.is_mode_bwsaver=function(zone){return zone.CG("mode")=="bwsaver"};E.is_mode_cdn_or_bwsaver=function(zone){return E.is_mode_cdn(zone)||E.is_mode_bwsaver(zone)};E.uninit=function(){if(!E.inited)return;if(typeof window!="undefined")window.removeEventListener(E.BEFOREUNLOAD,on_beforeunload);if(typeof document!="undefined"&&document.visibilityState)document.removeEventListener("visibilitychange",on_visibilitychange);E._events.emit("uninit");E.inited=false;E.conf={}};E.get_connection_type=function(){var connection=navigator&&(navigator.connection||navigator.mozConnection||navigator.webkitConnection);return connection&&connection.type};E.is_mobile_wifi_con=function(){return E.is_mobile&&E.get_connection_type()=="wifi"};E.is_mobile_cellular_con=function(){return E.is_mobile&&E.get_connection_type()=="cellular"}}E.gconf_set=function(path,val){return E.conf_set(E.conf,path,val)};E.conf_set=function(conf,path,val){zutil.set(conf,path,val)};E.gconf_get=function(path,def){return E.conf_get(E.conf,path,def)};E.conf_get=function(conf,path,def){return zutil.get(conf,path,def)};E.CG=E.gconf_get;E.CS=E.gconf_set;E.parse_function=function(f){var m=/^function\s*([\w$]+)?\s*\(\n?([\s\w$,]*?)(\s*\/\*`*\*\/)?\)\s*\{\n?([\s\S]*?)\n?\}$/.exec(f);return{name:m[1]||null,args:m[2]?m[2].split(/\s*,\s*/):[],body:m[4]}};E.gconf_apply=function(path,args,def,_this,throw_ex){return E.conf_apply(E.conf,path,args,def,_this,throw_ex)};E.conf_apply=function(conf,path,args,def,_this,throw_ex){var func=E.conf_get(conf,path,def),ret;if(!func||typeof func!="function"&&!func.__Function__)return func||def;if(func.__Function__){if(!args.length)args=func.args;var info=E.parse_function(func.__Function__);func=new Function(info.args.join(","),info.body)}try{ret=func.apply(_this,args)}catch(e){E.log.info("conf_apply of path "+path+" failed with err "+e);if(throw_ex)throw e;ret=def}return ret};E.fullsize_from_xhr=function(xhr){return E.fullsize_from_hdrs(E.get_resp_hdrs(xhr),xhr.status==206)};E.fullsize_from_hdrs=function(hdrs,is_range){if(!hdrs)return;var fs,v;if(v=hdrs["x-hola-fullsize"])fs=+v;else if(v=hdrs["content-range"])fs=+v.split("/")[1];else if((v=hdrs["content-length"])&&!is_range)fs=+v;return fs};E.guess_link_type=function(url){var type=E.get_video_type(url);switch(type){case"mp4":return"video/mp4";case"hls":return"application/x-mpegurl";case"hds":return"application/adobe-f4m";case"dash":return"application/dash+xml";case"flv":return"video/flv";case"webm":return"video/webm";default:E.log.debug('could not guess link type: "'+url+'" assuming mp4');return"video/mp4"}};E.mime_to_type=function(mime){switch(mime){case"video/mp4":return"mp4";case"application/vnd.apple.mpegurl":case"application/x-mpegurl":return"hls";case"application/adobe-f4m":return"hds";case"application/dash+xml":return"dash";case"video/flv":return"flv";case"video/webm":return"webm"}};E.events=function(){this.events=new events;return this};E.events.prototype.on=function on(event,fn,context){this.events.on(event,fn,context)};E.events.prototype.once=function once(event,fn,context){this.events.once(event,fn,context)};E.events.prototype.one=E.events.prototype.once;E.events.prototype.off=function off(event,fn){this.events.off(event,fn)};E.events.prototype.multi_on=function multi_on(handlers,context){Object.keys(handlers).forEach(function(e){this.events.on(e,handlers[e],context)},this)};E.events.prototype.multi_off=function multi_off(handlers,context){Object.keys(handlers).forEach(function(e){this.events.off(e,handlers[e],context)},this)};E.events.prototype.emit=function emit(event,a1,a2,a3,a4,a5){this.events.emit("pre-"+event,a1,a2,a3,a4,a5);this.events.emit(event,a1,a2,a3,a4,a5);this.events.emit("post-"+event,a1,a2,a3,a4,a5)};E.on=function(event,fn,ctx){E._events.on(event,fn,ctx)};E.off=function(event,fn){E._events.off(event,fn)};var web_sockets={};E.ws=function(host,opt){opt=opt||{};var ws_c=opt.ws_c||typeof WebSocket!="undefined"&&WebSocket;if(typeof ws_c!="function"||!host)return;if(!(this instanceof E.ws))return new E.ws(host,opt);var path,customer,zone;if(typeof opt=="string")path=opt;else if(typeof opt=="object"){path=opt.path;customer=opt.customer;zone=opt.zone}var _protocol=opt.protocol||(E.protocol=="https:"?"wss":"ws");this.url=_protocol+"://"+host+"/"+path;this.url=zescape.uri(this.url,{customer:customer,zone:zone});if(web_sockets[this.url])return web_sockets[this.url];this.id=0;this.minor=!!opt.minor;this.pending=[];try{this.ws=new ws_c(this.url)}catch(e){return}this.ws.binaryType="arraybuffer";this.ws.onopen=this.onopen.bind(this);this.ws.onclose=this.onclose.bind(this);this.ws.onerror=this.onerror.bind(this);this.ws.onmessage=this.onmessage.bind(this);this.log=opt.log||E.log;this.timer=undefined;this.timedout=false;if(opt.timeout){this.timer=setTimeout(this.ontimedout.bind(this),opt.timeout==true?5e3:opt.timeout)}web_sockets[this.url]=this;return this};zutil.inherits(E.ws,events.EventEmitter);E.ws.prototype.close=function(){if(this.ws&&this.ws.readyState<this.ws.CLOSING)this.ws.close();web_sockets[this.url]=undefined};E.ws.prototype.is_ready=function(){return this.ws&&this.ws.readyState==this.ws.OPEN};E.ws.prototype.send=function(cmd,route,data,onmessage){if(!this.ws||this.ws.readyState>=this.ws.CLOSING)return;if(this.ws.readyState<this.ws.OPEN){this.pending.push({cmd:cmd,route:route,data:data,onmessage:onmessage});return}if(typeof data=="string")data=JSON.parse(data);if(Array.isArray(data))data={data:data};var msg={__id:this.id++,cmd:cmd,route:route,data:data||{}};if(onmessage)this.once(msg.__id,onmessage);msg=JSON.stringify(msg);try{this.ws.send(msg)}catch(e){this.log.info("error in websocket send: state "+this.ws.readyState+" "+" msg "+e.message+" url "+this.url)}return msg.length};E.ws.prototype.onopen=function(){var _this=this;if(this.timer){clearTimeout(this.timer);this.timer=undefined}this.pending.forEach(function(item){_this.send(item.cmd,item.route,item.data,item.onmessage)});this.pending=[];this.emit("open")};E.ws.prototype.onclose=function(){if(!this.ws)return;if(this.timer){clearTimeout(this.timer);this.timer=undefined}this.ws=undefined;this.log.info("closed websocket "+this.url);this.emit("close")};E.ws.prototype.onerror=function(e){this.log.info("error websocket "+this.url+" "+e.type);if(this.minor){this.log.info("Note: WebSockets only transmit auxilliary information "+"between clients and servers. WebSocket errors do not impact "+"HolaCDN functionality in any way.")}this.emit("error",e);this.close()};function dv2str(dv,start){var len=dv.getUint32(start);var str="",end=start+len+4;for(var i=start+4;i<end;i+=2)str+=String.fromCharCode(dv.getUint16(i));return str}function bin2json(msg){if(typeof msg=="string")return JSON.parse(msg);if(!msg.byteLength||msg.byteLength<9)throw new Error("bad message");var ctrl=new DataView(msg);var ver=ctrl.getUint8(0);if(ver!=2)throw new Error("unsupported version");var str_part=dv2str(ctrl,4);var obj=JSON.parse(str_part);var offset=str_part.length*2+8;while(offset<msg.byteLength){var id_str=dv2str(ctrl,offset);offset+=id_str.length*2+4;var bin_len=ctrl.getUint32(offset);var bin_data=new Uint8Array(msg,offset+4,bin_len);offset+=bin_len+4;zutil.set(obj,id_str,bin_data)}return obj}E.ws.prototype.onmessage=function(ev){if(typeof ev.data.byteLength=="number"){if(ev.data.byteLength<9)return this.emit("message",{err:"bad message"});var ctrl=new DataView(ev.data,0,8);var ver=ctrl.getUint8(0);if(ver!=1&&ver!=2)return this.emit("message",{err:"unsupported version"});if(ver==1){var bid=ctrl.getUint32(4);var data=new Uint8Array(ev.data,8);return this.emit(bid,{body:data})}}var json;try{json=bin2json(ev.data)}catch(e){json={err:e}}this.emit(json.__id===undefined?"message":json.__id,json.res||json)};E.ws.prototype.ontimedout=function(){if(this.timer){clearTimeout(this.timer);this.timer=undefined}if(!this.ws)return;this.timedout=true;this.close()};E.ms_since=function(since){return Math.round(E.date_monotonic()-(since||0))};E.origin_is_allowed=function(origin,origins){return E._origin_is_allowed(origins||E.gconf_get("agent.origins"),origin)};E.origin_is_allowed_url=function(url,origins){var o=zurl.parse(url);if(!o||!o.hostname)return;return E.origin_is_allowed(o.hostname,origins)};E.get_api=function(){var g=typeof window!="undefined"?window:typeof global!="undefined"?global:self;return(g.hola_cdn||(g.hola_cdn={api:{}})).api};var mp4_suffix=/\.(mp4|m4p|m4v|mov)\/?$/i;var hls_suffix=/\.m3u8\/?$/;var hds_suffix=/\.f4m\/?$/;var dash_suffix=/\.mpd\/?$/;var flv_suffix=/\.flv\/?$/;var webm_suffix=/\.webm\/?$/;function is_rx_link(v,rx){return!!v&&rx.test(zurl.parse(v).pathname.split(";")[0])}E.is_mp4_link=function(v){return is_rx_link(v,mp4_suffix)};E.is_hls_link=function(v){return is_rx_link(v,hls_suffix)};E.is_hds_link=function(v){return is_rx_link(v,hds_suffix)};E.is_dash_link=function(v){return is_rx_link(v,dash_suffix)};E.is_flv_link=function(v){return is_rx_link(v,flv_suffix)};E.is_webm_link=function(v){return is_rx_link(v,webm_suffix)};E.is_youtube_link=function(v){return v&&/^(.*\.)?youtube.com$/.test(zurl.get_host(v))};E.get_video_type=function(v){if(E.is_youtube_link(v))return"yt";if(E.is_mp4_link(v))return"mp4";if(E.is_flv_link(v))return"flv";if(E.is_webm_link(v))return"webm";if(E.is_hls_link(v))return"hls";if(E.is_hds_link(v))return"hds";if(E.is_dash_link(v))return"dash";return null};E.is_adaptive=function(type){return["hls","hds","dash"].indexOf(type)>-1};E.is_progressive=function(type){return["mp4","flv","webm"].indexOf(type)>-1};E.get_method_type=function(type){if(E.is_progressive(type))return"progressive";if(E.is_adaptive(type))return type;return"unknown"};E.get_adaptive_by_type=function(type){if(E.is_adaptive(type)||type=="yt")return type;return null};E.get_adaptive_type=function(v){var type=E.get_video_type(v);return E.get_adaptive_by_type(type)};E.is_blob_url=function(u){return!!(u&&(u.startsWith("blob:")||u.startsWith("mediasource:")))};E.is_proxy_url=function(u){var o=zurl.parse(u);return o.hostname==require.zdot("host")};E.is_ad_url=function(u){var ad_sources=E.gconf_get("ad_sources",[]);return ad_sources.length&&E.check_url(u,{include:ad_sources})};E.get_proxy_url=function(customer,zone,src){return"//"+require.zdot("host")+"/api/zagent_get?customer="+customer+"&zone="+zone+"&url="+encodeURIComponent(src)};E.proxy2origin=function(src){return decodeURIComponent(src.replace(/.*?&url=(.*)$/,"$1"))};function check_re(lst,s){if(!lst)return false;for(var i=0;i<lst.length;i++){var re=lst[i];if(re===s||re instanceof RegExp&&re.test(s))return true}return false}E._origin_is_allowed=function(origins,origin){return origins=="*"||check_re(origins,origin)};E.video_filtered_out=function(video_url,filter_out_js){if(!filter_out_js)return;var u=E.get_location_urls();var filter_opt={url:u.frame_url||u.top_url,video_url:video_url};try{var filter_fn=new Function("opt",filter_out_js);if(filter_fn(filter_opt))return true}catch(e){E.log.err(e.stack||""+e)}};E.video_format_is_enabled=function(video_url,media_filter_in){if(!media_filter_in)return true;for(var i=0;i<media_filter_in.length;i++){var test_func=E["is_"+media_filter_in[i]+"_link"];if(test_func&&test_func(video_url))return true}return false};E.match_url=function(url,rule){if(!rule)return false;try{return new RegExp("^"+zurl.http_glob_url(rule)).test(url)}catch(e){return void E.log.err(e.stack||""+e)}};E.check_url=function(url,filter){if(!filter)return true;var include=filter.include||[];var exclude=filter.exclude||[];var match=E.match_url.bind(null,url);if(exclude.find(match))return false;if(!include.length||include.find(match))return true;return false};E.get_perr_link_msg=function(customer,bugid){return"report sent id "+bugid+"\nbug location url "+"http://holaspark.com/cp/admin/debug/err_problem_report?"+zescape.qs({cust:customer,filter:"info.bugid=="+bugid})};E.get_resp_hdrs=function(xhr){if(!xhr||!xhr.getAllResponseHeaders)return{};var hdrs=xhr.getAllResponseHeaders();if(!hdrs)return{};hdrs=hdrs.split("\n");var ret={},count=1;hdrs.forEach(function(h){if(!h.length||h=="\r")return;var args=h.split(/:(.+)/);var key=args[0].trim().toLowerCase();if(ret[key])key+="_dup"+count++;ret[key]=args[1]&&args[1].trim()});return ret};E.close_to_end=function(cur,dur){return Math.floor(dur)-Math.round(cur)<=0};E.try_wrapper_silent=function(func){return function(){try{return func.apply(this,arguments)}catch(e){}}};E.inject_hook=function(object,prop,opt){function get_property_descriptor_data(o,p){while(o&&!o.hasOwnProperty(p))o=Object.getPrototypeOf(o);return{obj:o,pd:o&&Object.getOwnPropertyDescriptor(o,p)}}function can_install(o,p){var pd=Object.getOwnPropertyDescriptor(o,p);return!pd||pd.configurable}function throw_wrapper(error){if(opt.exit_on_failure)return;throw new Error(error)}if(!object)return throw_wrapper("injecting hook, but no object");if(!can_install(object,prop))return throw_wrapper("injecting hook on unconfigurable property");if(typeof opt=="function")opt={exec:opt};var setup={func_hook:{get_hook:function(){return typeof object[prop]=="function"&&object[prop].hook},install:function(hook){var _hook=function(){return hook("exec",this,arguments)};_hook.hook=hook;hook._orig_handler=object[prop];hook._orig_handler_inherited=!object.hasOwnProperty(prop);Object.defineProperty(object,prop,{configurable:true,writable:true,enumerable:true,value:_hook});if(typeof hook._orig_handler!="function")return{exec:function(){}};return{exec:hook._orig_handler}},uninstall:function(hook){if(hook._orig_handler_inherited||!hook._orig_handler)delete object[prop];else object[prop]=hook._orig_handler}},value_hook:{get_hook:function(){var data=get_property_descriptor_data(object,prop);return data.pd&&(data.pd.get||data.pd.set||{}).hook},install:function(hook){var data=hook._orig_desc_data=get_property_descriptor_data(object,prop);var pd=data.pd;if(!pd||!pd.set&&!pd.get){var v=pd?pd.value:undefined;pd={get:function(){return v},set:function(_v){v=_v}}}var _hook=function(type){var h=function(){return hook(type,this,arguments)};h.hook=hook;return h};Object.defineProperty(object,prop,{configurable:true,enumerable:true,set:pd.set&&_hook("set"),get:pd.get&&_hook("get")});return{get:pd.get,set:pd.set}},uninstall:function(hook){var pd=hook._orig_desc_data.pd||{configurable:true,writable:true,enumarable:true};if(pd.writable)pd.value=object[prop];var target=hook._orig_desc_data.obj||object;if(target!=object)delete object[prop];Object.defineProperty(target,prop,pd)}}};var oh,hook,is_exec=opt.exec||opt.post_exec;var hook_method=is_exec?setup.func_hook:setup.value_hook;if(!(hook=hook_method.get_hook())){hook=function(origin,owner,args){var e={set_handled:function(){e._handled=true},is_intercepted:function(){return!!e._handled}};var iterate_listeners=function(is_post){var ret,listener,_origin=is_post?"post_"+origin:origin;for(var i=0;i<hook.listeners.length;i++){listener=hook.listeners[i];if(!listener[_origin])continue;ret=listener[_origin].call(owner,e,args);if(!is_post&&e.is_intercepted())return ret}};e.retval=iterate_listeners();if(!e.is_intercepted()&&hook.original_handlers[origin])e.retval=hook.original_handlers[origin].apply(owner,args);iterate_listeners(true);return e.retval};hook.listeners=[];hook.original_handlers=hook_method.install(hook);hook.uninstall=function(){if(hook_method.get_hook()!=hook)return;hook_method.uninstall(hook)}}hook.listeners.push(opt);oh=hook.original_handlers;return{count:function(){return hook.listeners.length},remove:function(){var index=hook.listeners.indexOf(opt);if(index<0)return;hook.listeners.splice(index,1);if(!hook.listeners.length)hook.uninstall()},original_handlers:{exec:is_exec&&oh.exec&&oh.exec.bind(object),get:!is_exec&&oh.get&&oh.get.bind(object),set:!is_exec&&oh.set&&oh.set.bind(object)}}};E.absolute_uri=function(s,unwrap_empty){if(!s&&!unwrap_empty)return s;var el=document.createElement("source");el.src=s||"";return el.src};E.set_url_param=function(name,value,delim){return E.set_param(name,value&&encodeURIComponent(value),delim)};E.set_param=function(name,value,delim){if([false,undefined].includes(value))return"";delim=delim||"&";return delim+name+([null,true].includes(value)?"":"="+value)};E.parse={};E.parse.cache_control=function(s){var cc=zescape.parse.http_words(s),ret={};for(var i=0;i<cc.length;i++)ret[cc[i][0]]=cc[i][1]||true;return ret};E.get_spark_uri=function(location,key,def_val){var loc=typeof window!="undefined"&&window.location;if(typeof location!="object"){def_val=key;key=location;location=loc}else if(!location)location=loc;if(!key||!loc)return def_val;var o_url=zurl.parse(window.top===window?location.href:document.referrer);var o_qs=zurl.qs_parse((o_url.search||"").substr(1));var o_hash=zurl.qs_parse((o_url.hash||"").substr(1));return o_qs[key]||o_hash[key]||def_val};E.get_uri_conf=function(){var conf={};E.uri_opts_list.forEach(function(key){var value=E.get_spark_uri("hola_"+key);if(value!==undefined)conf[key]=value});return conf};E.load_script=function(url,onload,attrs){var script=document.createElement("script");script.src=E.fix_url(url);script.onload=onload;if(attrs)Object.assign(script,attrs);if(document.getElementsByTagName("head").length)document.getElementsByTagName("head")[0].appendChild(script);else if(document.getElementsByTagName("body").length)document.getElementsByTagName("body")[0].appendChild(script);else if(document.head)document.head.appendChild(script)};E.script_exists=function(url){return!!E.dom_query('script[src="'+E.fix_url(url)+'"]')};E.fnv1a=function(chunk){var hash=2166136261,arr=new Uint8Array(chunk);for(var i=0;i<arr.length;i++){hash^=arr[i];hash=hash+(hash<<1)+(hash<<4)+(hash<<7)+(hash<<8)+(hash<<24)>>>0}return hash};E.create_fake_xhr=function(opt){var fake_xhr={setup:{},req_headers:[]};opt.log=opt.log.set_module("util");fake_xhr.open=function(verb,url){fake_xhr.verb=verb;fake_xhr.url=url};fake_xhr.setRequestHeader=function(header,value){fake_xhr.req_headers.push([header,value])};fake_xhr.getAllResponseHeaders=function(){return""};fake_xhr.send=function(){fake_xhr.sent=true;opt.onsend()};fake_xhr.abort=function(){if(!fake_xhr.req||fake_xhr.req.error===E.ERR.aborted||fake_xhr.req.info.rate){return}fake_xhr.req.abort();if(opt.onabort)opt.onabort();opt.log.notice("req aborted",fake_xhr.req.name);if(fake_xhr.onabort)fake_xhr.onabort();if(fake_xhr.onloadend)fake_xhr.onloadend()};return fake_xhr};E.update_fake_xhr=function(req){var fake_xhr=req.info.segment.fake_xhr,err=req.error;fake_xhr.response=err?null:req.res.data;fake_xhr.status=err?404:200;fake_xhr.responseURL=fake_xhr.url;fake_xhr.resp_hdrs=(req.resp||{}).hdrs;if(!err){var ev={loaded:req.res.size,total:req.res.size,target:fake_xhr,lengthComputable:true};if(fake_xhr.onload)fake_xhr.onload(ev)}if(fake_xhr.onloadend)fake_xhr.onloadend();return fake_xhr};E.parse_range_header=function(hdr){var r=hdr.split("=").pop().split("-");return{from:+r[0],to:+r[1]}};E.module_fn=function(module,target){var name=typeof target=="function"?target.name:target;function get_orig(){var s=module.Player.super_,proto_fn=s&&s.prototype[name];return typeof target=="string"&&proto_fn?proto_fn:target}module.Player.prototype[name]=function(a1,a2,a3){var len=arguments.length,mod_fn=this.module&&this.module[name];var fn=mod_fn||get_orig(),fn_this=mod_fn?this.module:this;if(typeof fn!="function")return;switch(len){case 0:return fn.call(fn_this);case 1:return fn.call(fn_this,a1);case 2:return fn.call(fn_this,a1,a2);case 3:return fn.call(fn_this,a1,a2,a3);default:var args=new Array(len);for(var i=0;i<len;i++)args[i]=arguments[i];return fn.apply(fn_this,args)}};module.Player.prototype[name].orig=get_orig};E.call_super=function(module,pl,name){var in_len=arguments.length,s,fn,out_len=in_len-3;if(!(s=module.Player?module.Player.super_:module.super_))return;var a=new Array(out_len>0?out_len:0);for(var i=3;i<in_len;i++)a[i-3]=arguments[i];return name?(fn=s.prototype[name])&&fn.apply(pl,a):s.apply(pl,a)};E.create_forwarding_emit=function(player){var events=(player.module||{}).event_list,_events,in_call=false;if(!events)return;function forward_fn(e){return function(o1,o2){if(in_call)return;in_call=true;try{player.old_emit(e,o1,o2)}finally{in_call=false}}}player.old_emit=player.old_emit||player.emit;player.emit=function(e,o1,o2){return!events.includes(e)&&player.old_emit(e,o1,o2)};_events=events.map(function(e){return{name:e,cb:forward_fn(e)}});_events.forEach(function(e){player.module.on(e.name,e.cb)});return function(){delete player.old_emit;delete player.emit;_events.forEach(function(e){player.module.off(e.name,e.cb)})}};E.resolve_url=function(base_url,path){var m=path.match(/^([^:\/?#]+:)?(?:\/\/(?:([^:@\/?#]*)(?::([^:@\/?#]*))?@)?((?:[^:\/?#]*)(?::(?:\d*))?))?([^?#]*)(\?[^#]*)?(#[\s\S]*)?/);var _protocol=m[1]||"";var user=m[2]||"";var password=m[3]||"";var host=m[4]||"";var pathname=m[5]||"";var search=m[6]||"";var hash=m[7]||"";if(!/(\w+:)?\/\//.test(base_url))base_url=E.resolve_url(location.href,base_url);var base=zurl.parse(base_url);var is_full=!!_protocol||!!host||!!user;if(!is_full&&!pathname&&!search)search=base.search||"";if(!is_full&&pathname.charAt(0)!="/"){pathname=pathname?((base.host||base.user)&&!base.pathname?"/":"")+base.pathname.slice(0,base.pathname.lastIndexOf("/")+1)+pathname:base.pathname}var output=[];pathname.replace(/^(\.\.?(\/|$))+/,"").replace(/\/(\.(\/|$))+/g,"/").replace(/\/\.\.$/,"/../").replace(/\/?[^\/]*/g,function(p){if(p=="/..")output.pop();else output.push(p)});pathname=output.join("").replace(/^\//,pathname.charAt(0)=="/"?"/":"");if(!is_full){host=base.host;password=base.password;user=base.user}if(!_protocol)_protocol=base.protocol;return _protocol+"//"+(user?user+(password?":"+password:"")+"@":"")+host+pathname+search+hash};E.is_enabled=function(module){return!!module&&!module.__stub};E.assert_enabled=function(module,message){if(!E.is_enabled(module))throw new Error(message||"module is disabled")};E.is_hola_hls_js=function(hls){return!!zutil.get(hls,"streamController.onFragChunkLoaded")};E.is_hola_hls_js_constructor=function(Hls){if(Hls.is_hola_hls===undefined){var test=new Hls;Hls.is_hola_hls=E.is_hola_hls_js(test);test.destroy()}return Hls.is_hola_hls};E.get_hls_sc=function(hls){return hls.streamController||hls.mediaController};E.def_hola_hls_config=function(conf_get){var ret={fragLoadingLoopThreshold:1e3,manifestLoadingTimeOut:20*ms_sec,manifestLoadingMaxRetry:4,levelLoadingTimeOut:20*ms_sec,levelLoadingMaxRetry:4};conf_get=conf_get||E.gconf_get;assign(ret,conf_get("loader.dailymotion.config")||{});return ret};E.get_size_name=function(width,height){if(!isFinite(width)||!isFinite(height))return"unknown";return Math.round(width/100)*100+"x"+Math.round(height/100)*100};E.get_width_name=function(width){return!isFinite(width)||width<=0?"width_unknown":width<300?"width_300":width<600?"width_600":width<900?"width_900":width<1200?"width_1200":"width_over_1200"};E.get_height_name=function(height){return!isFinite(height)||height<=0?"height_unknown":height<300?"height_300":height<600?"height_600":height<900?"height_900":height<1200?"height_1200":"height_over_1200"};E.get_top_name=function(){if(typeof window=="undefined")return;var ret={name:window.name};if(window.top!=window)try{ret.root_name=window.top.name}catch(e){}ret.name=ret.root_name||ret.name;return ret.name};E.get_top_url=function(loaded_in_debug){return E.get_location_urls(loaded_in_debug).top_url};E.get_location_urls=function(loaded_in_debug){if(typeof window=="undefined")return{};var ret={top_url:loaded_in_debug||location.href};if(window.top!=window){ret.referrer=document.referrer;ret.frame_url=location.href;try{ret.root_top_url=window.top.location.href}catch(e){}}ret.top_url=ret.root_top_url||ret.referrer||ret.top_url;return ret};E.referrer_type=function(url,ref,regex){if(!ref)return"none";var url_host=zurl.get_host(url),ref_host=zurl.get_host(ref);if(!url_host||!ref_host)return"invalid";return(regex?regex.test(ref_host):url_host==ref_host)?"internal":"external"};E.data_snapshot=function(data,fields){var past=zutil.clone_deep(data);fields=fields||Object.keys(data);return{diff:function(now){var res=zutil.clone_deep(now);fields.forEach(function(path){var val_past=zutil.get(past,path);var val_now=zutil.get(now,path);var val_res=typeof val_past=="number"&&typeof val_now=="number"?val_now-val_past:val_now;zutil.set(res,path,val_res)});return res}}};E.def_url2cache=function(_url){return _url.replace(/([^?#]+).*/,"$1")};E.clean_top_url=function(url){var fn=E.CG("transform.clean_top_url");if(typeof fn!="function")return url;return fn(url)};E.page2cache=function(url,zone){url=url.replace(/\/\/www\./,"//");if((!zone||!zone.is_agent)&&E.CG("transform.page2cache")){url=E.gconf_apply("transform.page2cache",[url,{mobile:E.is_mobile}],E.def_url2cache(url))}else if(zone)url=E.def_url2cache(url);return url.replace(/^((?:http|https):)?(\/\/)?/i,"http://")};E.def_page2domain=function(url){return url&&(zurl.parse(url).hostname||"").replace(/^www\./,"");
};E.page2domain=function(url){return E.gconf_apply("transform.page2domain",[url],E.def_page2domain(url))};E.page2link=function(url){return E.gconf_apply("transform.page2link",[url],url)};E.url2videotype=function(url){return E.gconf_apply("transform.url2videotype",[url])};E.player2offset=function(player){return E.gconf_apply("transform.player2offset",[player],0)};E.url2category=function(url){return E.gconf_apply("transform.url2category",[url])};E.show_url2category=function(url){return E.gconf_apply("transform.show_url2category",[url])||E.url2category(url)};E.url2lang=function(url){return E.gconf_apply("transform.url2lang",[url])};E.video2cache=function(url,zone){if((!zone||!zone.is_agent)&&E.CG("transform.url2cache")){url=E.gconf_apply("transform.url2cache",[url],E.def_url2cache(url))}else url=E.def_url2cache(url);return E.strip_hostname(url)};E.segment2cache=function(url){return E.strip_hostname(E.gconf_apply("transform.segment2cache",[url],E.def_url2cache(url)))};E.video2type=function(url){return E.gconf_apply("transform.video2type",[url],url)};E.game_title=function(url){return E.gconf_apply("transform.game_title",[url],function(u){return u.replace(/ -.*$/,"")})};E.url2sparkorigin=function(url){return E.gconf_apply("transform.url2sparkorigin",[url])};E.strip_hostname=function(url){return url.replace(/^(https?:)?\/\/([^\/]+)/,"")};E.err_ex=function(err,opt){var e=new Error(err);assign(e,opt);return e};E.parse_segment_url=function(s,opt){var url=zurl.parse(s);if(!opt.proxy)return url;var proxy_path_re=new RegExp(url.hostname+"/"+E.conf.customer+"/"+opt.zone+"/");var hola_param_re=/[?&]hola.*$/;var hola_playlist_re=/.*[?&]hola.*playlist=([^&]*).*/;var hola_manifest_re=/.*[?&]hola.*manifest=([^&]*)$/;url=zurl.parse(s.replace(proxy_path_re,"").replace(hola_param_re,""));var force=url.force_params={};if(hola_playlist_re.test(s))force.playlist=decodeURIComponent(s.replace(hola_playlist_re,"$1"));if(hola_manifest_re.test(s))force.manifest=decodeURIComponent(s.replace(hola_manifest_re,"$1"));return url};E.get_stylesheet=function(styles){var res=[];for(var selector in styles){var keys=Object.keys(styles[selector]).filter(function(key){return!!styles[selector][key]});var css=keys.map(function(key){return"    "+key+": "+styles[selector][key]+";\n"});if(css.length)res.push(selector+" {\n"+css.join("")+"}")}return res.join("\n")};E.stack_to_pprint=function(str){return str&&str.replace(/^Error/,"")};E.debounce=function(func,wait){var timeout;return function(){var context=this,args=arguments;var later=function(){timeout=null;func.apply(context,args)};clearTimeout(timeout);timeout=setTimeout(later,wait)}};E.throttle=function(func,wait){var ctx,args,rtn,timeout;var last=0;var call=function(){timeout=null;last=new Date;rtn=func.apply(ctx,args);ctx=null;args=null};return function(){ctx=this;args=arguments;var delta=new Date-last;if(!timeout){if(delta>=wait)call();else timeout=setTimeout(call,wait-delta)}return rtn}};E.wrap_onclick=function(el,cb,opt){opt=opt||{};function get_touch_pos(e,coord){return e.changedTouches?e.changedTouches[0][coord]:e[coord]}function is_same_coord(c1,c2){return Math.abs(c1-c2)<10}function on_touchstart(e){ctx.starts=E.date_monotonic();ctx.startx=get_touch_pos(e,"pageX");ctx.starty=get_touch_pos(e,"pageY")}function on_touchend(e){var dur=E.ms_since(ctx.starts);var click_ival=opt.click_ival||{from:0,to:700};if(is_same_coord(ctx.startx,get_touch_pos(e,"pageX"))&&is_same_coord(ctx.starty,get_touch_pos(e,"pageY"))&&dur>click_ival.from&&dur<click_ival.to){cb(e)}}var ctx={};el.on("touchstart",on_touchstart);el.on("touchend",on_touchend);return function(){el.off("touchstart",on_touchstart);el.off("touchend",on_touchend)}};var script_timing={};E.get_script_timing=function(all){var timing_key=all?"all":"signle";if(script_timing[timing_key])return script_timing[timing_key];if(!window||!window.performance)return;var timing={};if(true)return script_timing[timing_key]=timing;if(window.performance.timing){var t=window.performance.timing;timing.nav_start=t.navigationStart;timing.page_load_ms=t.domContentLoadedEventEnd-t.navigationStart;timing.win_load_ms=t.loadEventEnd-t.navigationStart}if(window.performance.now)timing.script_load_ms=window.performance.now();if(window.performance.getEntries){var host="//player[^.]*\\.h-cdn\\.com/";var scripts={small:"(loader_[^/]+\\.js|loader\\.js\\?.*customer=)",full:"loader\\.js\\?customer=[^&]+\\&no_conf=true\\&md5=",config:"config\\.js\\?customer=[^&]+\\&md5="};Object.keys(scripts).forEach(function(k){scripts[k]=new RegExp(host+scripts[k])});var results={};var entries=window.performance.getEntries();var get_result=function(e){var ret={};var check_set=function(key,value){if(value>=0&&value<2*ms_min)ret[key+"_ms"]=value};check_set("connect",e.connectEnd-e.connectStart);check_set("dns",e.domainLookupEnd-e.domainLookupStart);check_set("duration",e.duration);check_set("redirect",e.redirectEnd-e.redirectStart);check_set("response",e.responseEnd-e.responseStart);ret.response_end_ms=e.responseEnd;if(timing.script_load_ms&&ret.response_end_ms)ret.init_ms=timing.script_load_ms-ret.response_end_ms;if(!isFinite(ret.response_ms)||!isFinite(ret.duration_ms)||ret.response_ms>ret.duration_ms){return}if(ret.response_ms==0){Object.keys(ret).forEach(function(key){ret["cached_"+key]=ret[key];delete ret[key]})}return ret};for(var i=0;i<entries.length;i++){var e=entries[i];var name=scripts.full.test(e.name)&&!results.full?"full":scripts.config.test(e.name)&&!results.config?"config":scripts.small.test(e.name)&&!results.small?"small":null;if(!name)continue;results[name]=get_result(e);if(Object.keys(results).length==Object.keys(scripts).length)break}if(!results.full&&results.small){results.full=results.small;delete results.small}assign(timing,results.full);if(all){for(var r in results){for(var k in results[r])timing[r+"_"+k]=results[r][k]}}}return script_timing[timing_key]=timing};E.custom_fn=function(fn,args){if(typeof fn=="string"){try{fn=args?new Function(args,fn):new Function(fn)}catch(e){E.log.err("Invalid custom_fn: "+(e&&e.toString()))}}if(typeof fn!="function")return function(){};return function(){try{return fn.apply(null,arguments)}catch(e){E.log.err("Invalid custom_fn: "+(e&&e.toString()))}}};E.get_json=function(url,cb){var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.onreadystatechange=function(){if(xhr.readyState!=xhr.DONE)return;if(xhr.status!=200)return cb({});var data;try{data=JSON.parse(xhr.responseText)}catch(e){cb({})}cb(data)};xhr.send()};E.is_item_allowed=function(rules,item){if(!rules||!item)return true;var include=rules.include||[];var exclude=rules.exclude||[];if(exclude.includes(item))return false;if(!include.length||include.includes(item))return true;return false};E.is_poster_allowed=function(url){return url&&!/^data:image|^blob:|^file:|\.h-cdn\.com\//i.test(url)&&!/[^a-z]logo[^a-z]|\.svg$|\.webp$/i.test(url)&&/\./.test(url)};E.date_monotonic=function(){var adjust=0,last=0;if(typeof window=="object"&&window.performance&&window.performance.now){adjust=Date.now()-window.performance.now();return function(){return window.performance.now()+adjust}}return function(){var now=Date.now()+adjust;if(now>=last)return last=now;adjust+=last-now;return last}}();function pad(num,size){return("000"+num).slice(-size)}E.date_ms_to_dur=function(_ms){var s="",sec=Math.floor(_ms/1e3);if(sec<0){s+="-";sec=-sec}var days=Math.floor(sec/(60*60*24));sec-=days*60*60*24;var hours=Math.floor(sec/(60*60));sec-=hours*60*60;var mins=Math.floor(sec/60);sec-=mins*60;if(days)s+=days+" "+(days>1?"Days":"Day")+" ";return s+pad(hours,2)+":"+pad(mins,2)+":"+pad(sec,2)};E.date_to_sql_ms=function(d){d=d===undefined?new Date:new Date(d);if(isNaN(d))return"0000-00-00 00:00:00.000";return pad(d.getUTCFullYear(),4)+"-"+pad(d.getUTCMonth()+1,2)+"-"+pad(d.getUTCDate(),2)+" "+pad(d.getUTCHours(),2)+":"+pad(d.getUTCMinutes(),2)+":"+pad(d.getUTCSeconds(),2)+"."+pad(d.getUTCMilliseconds(),3)};E.jdate_now=function(){var d=new Date;var months_short=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return(pad(d.getUTCDate(),2)+"-"+months_short[d.getUTCMonth()]+"-"+pad(d.getUTCFullYear()%100,2)+" "+pad(d.getUTCHours(),2)+":"+pad(d.getUTCMinutes(),2)+":"+pad(d.getUTCSeconds(),2)).replace(/( 00:00)?:00$/,"")};E.array_unique=function(a){var _a=[];for(var i=0;i<a.length;i++){if(!_a.includes(a[i]))_a.push(a[i])}return _a};E.array_rm_elm=function(a,elm){var i=a.indexOf(elm);if(i<0)return;a.splice(i,1);return elm};E.cmp_version=function(v1,v2){if(!v1||!v2)return+!!v1-+!!v2;var _v1=(""+v1).split("."),_v2=(""+v2).split("."),i;for(i=0;i<_v1.length&&i<_v2.length&&+_v1[i]==+_v2[i];i++);if(_v1.length==i||_v2.length==i)return _v1.length-_v2.length;return+_v1[i]-+_v2[i]};function fmt_per(per){if(!per)return"";switch(per){case"s":case"ms":return per;case"%":case"%%":return"%";default:return"/"+per[0]}}var _scale_vals={1e3:[{s:"",n:1},{s:"K",n:1e3},{s:"M",n:1e6},{s:"G",n:1e9},{s:"T",n:1e12},{s:"P",n:1e15}],1024:[{s:"",n:1},{s:"K",n:1024},{s:"M",n:Math.pow(1024,2)},{s:"G",n:Math.pow(1024,3)},{s:"T",n:Math.pow(1024,4)},{s:"P",n:Math.pow(1024,5)}]};E.scaled_number=function(num,opt){opt=opt||{};var sign="",per=opt.per,scale=opt.scale;var base=opt.base==1024?1024:1e3,ratio=opt.ratio||1;var units=opt.units===undefined||opt.units;function _per(){return per?fmt_per(per):""}if(num<0){sign="-";num=-num}if(num===undefined)return"";if(isNaN(num))return opt.nan||"x";if(num==Infinity)return sign+"∞";var scale_vals=_scale_vals[base],i=0;if(scale==null)for(;i<scale_vals.length-1&&num>=scale_vals[i+1].n*ratio;i++);else i=scale_vals.findIndex(function(_scale){return _scale.s==scale});if(per=="ms"&&i){per="s";i--;num=num/1e3}scale=scale_vals[i];if(opt.is_scale)return scale.n;num/=scale.n;if(num<.001)return"0"+_per();if(num>=base-1)num=Math.trunc(num);var str=num.toFixed(num<1?3:num<10?2:num<100?1:0);return sign+str.replace(/((\.\d*[1-9])|\.)0*$/,"$2")+(units?(opt.space?" ":"")+scale.s:"")+_per()};E.conv_str2bin=function(s,offset){var len;if(!s||!(len=s.length))return;offset=offset||0;var arr=new Uint8Array(len-offset);for(var i=offset,j=0;i<len;i++,j++)arr[j]=s.charCodeAt(i);return arr};E.str_longest=function(){var i,s;for(i=0;i<arguments.length;i++)s=(arguments[i]||"").length>(s||"").length?arguments[i]:s;return s};E.str_trunc=function(s,len){if(s.length<=len)return s;return s.slice(0,len)+"..."};function err_has_stack(err){return err instanceof Error&&err.stack}E.zerr_e2s=function(err){if(!is_node&&err_has_stack(err)){var e_str=""+err,e_stack=""+err.stack;return e_stack.startsWith(e_str)?e_stack:e_str+" "+e_stack}return err_has_stack(err)?""+err.stack:""+err};E.zerr_json=function(o,replacer,space){try{return JSON.stringify(o,replacer,space)||""}catch(e){return"[circular]"}};E.clone=zutil.clone;E.clone_deep=zutil.clone_deep;E.defaults=zutil.defaults;E.defaults_deep=zutil.defaults_deep;E.equal_deep=zutil.equal_deep;E.extend_deep=zutil.extend_deep;E.floor_mul=zutil.floor_mul;E.forEach=zutil.forEach;E.get=zutil.get;E.inherits=zutil.inherits;E.is_mocha=zutil.is_mocha;E.map_obj=zutil.map_obj;E.path=zutil.path;E.pick=zutil.pick;E.set=zutil.set;E.unset=zutil.unset;E.t={bin2json:bin2json,ws_onmessage:E.ws.prototype.onmessage};return E})})();
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else define=require("../../../util/require_node.js").define(module,"../");define("/svc/cdn/pub/log.js",["/util/util.js"],function(zutil){var E=log_cdn;E.type="cdn";var assign=Object.assign;var log_levels={no:0,crit:1,err:2,warn:3,notice:4,info:5,debug:6};function date_to_sql_ms(d){var _pad=function(num,size){return("000"+num).slice(-size)};d=d===undefined?new Date:new Date(d);if(isNaN(d))return"0000-00-00 00:00:00.000";return _pad(d.getUTCFullYear(),4)+"-"+_pad(d.getUTCMonth()+1,2)+"-"+_pad(d.getUTCDate(),2)+" "+_pad(d.getUTCHours(),2)+":"+_pad(d.getUTCMinutes(),2)+":"+_pad(d.getUTCSeconds(),2)+"."+_pad(d.getUTCMilliseconds(),3)}function level_to_console(level){switch(level){case"crit":return"error";case"err":return"error";case"warn":return"warn";case"notice":return"log";case"info":return"info";case"debug":return zutil.is_mocha()?"info":"debug";default:console.error("invalid level",level);return"error"}}function log(type,s,opt){opt=opt||{};var logs=opt.logs||E.get_logs(true);var msg=type+(opt.module&&opt.module!=opt.type?"/"+opt.module:"")+": "+s;var slevel=opt.level||"debug";var level=log_levels[slevel];var set_level=log_levels[E.settings.log_level||"notice"];var print=false;if(opt.console_log&&set_level>0)print=true;else if(level<=set_level){var mods=E.settings.log_modules;if(!opt.module||!mods)print=true;else if(mods&&(mods.includes(opt.module)||mods.includes("*")))print=true}var d=zutil.is_mocha()?E.zmocha_date||new Date:new Date;var _msg=date_to_sql_ms(d)+pad(logs.length,3)+" ["+(opt.id||0)+"] "+msg;if(print){var l=level_to_console(slevel);if(zutil.is_mocha()&&E.zmocha_test_log){E.zmocha_console=E.zmocha_console||[];E.zmocha_console.push(l+" "+_msg)}else console[l](_msg)}_msg={type:type,module:opt.module,msg:_msg,level:level};E.full_history.push(_msg);if(level<=Math.max(log_levels.info,set_level))logs.push(_msg);var max_full=E.settings.max_full_history_size||8192;var max_size=E.settings.max_size||2048;if(!E.debug_mode&&E.full_history.length>max_full)E.full_history.splice(0,max_full/2);if(!E.debug_mode&&logs.length>max_size)logs.splice(0,max_size/2)}function log_cdn(){var s;var opt={};try{var args=[].slice.call(arguments);if(typeof args[args.length-1]=="object")opt=args.pop();s=args[0];log(opt.type||E.type,s,opt)}catch(e){console.error("error in log_cdn",opt.type||E.type,s,e)}}function log_is(level){return log_levels[E.settings.log_level]>=log_levels[level]}function log_level_handler(opt,level){var level_opt=level=="console"?{console_log:true,level:"info"}:{level:level};return extend_opt.bind(E,assign({},opt,level_opt))}function extend_opt(def_opt){if(def_opt.muted)return;var args=[].slice.call(arguments,1);var opt={};if(typeof args[args.length-1]=="object")opt=assign({},args.pop());log_cdn.apply(this,args.concat(assign(opt,def_opt)))}function pad(num,size){return E.zmocha_pad||("000"+num).slice(-size)}function set(opt){E.settings=assign({},settings_def(),zutil.clone_deep(opt))}function settings_def(){return{log_level:"notice",max_size:2048,max_full_history_size:8192}}function Journal(opt){opt=opt||{logs:[]};opt.type=opt.type||E.type;assign(this,{crit:log_level_handler(opt,"crit"),err:log_level_handler(opt,"err"),warn:log_level_handler(opt,"warn"),notice:log_level_handler(opt,"notice"),info:log_level_handler(opt,"info"),debug:log_level_handler(opt,"debug"),console:log_level_handler(opt,"console"),set_type:function(type){return new Journal(assign({},opt,{type:type}))},set_module:function(module){return new Journal(assign({},opt,{module:module,type:opt.type}))},reset_module:function(){return this.set_module(null)},mute:function(){return new Journal(assign({},opt,{muted:true}))},unmute:function(){return new Journal(assign({},opt,{muted:false}))},get_logs:function(raw){return raw?opt.logs:opt.logs.map(function(l){return l&&l.msg||l})},reset_logs:function(){opt.logs.splice(0,opt.logs.length)},logs_to_str:function(logs,full_log){return E.logs_to_str(logs||opt.logs)},concat:function(logs,need_sort){return E.concat_logs(opt.logs,logs,need_sort)},fork:function(id){return new Journal(assign({},opt,{id:id,logs:opt.logs.slice()}))},stash:function(){var stash=opt.logs.slice();return function(){zutil.clone_inplace(opt.logs,stash)}},uninit:function(){this.reset_logs()}})}assign(E,new Journal);E.concat_logs=function(logs,logs2,need_sort){var combined_logs=(logs||[]).concat(logs2||[]);if(need_sort){combined_logs.sort(function(a,b){return(a&&a.msg||a).localeCompare(b&&b.msg||b)})}return combined_logs};E.filter_logs=function(logs,types,modules){types=typeof types=="string"?[types]:types&&types.slice();modules=typeof modules=="string"?[modules]:modules;return logs.filter(function(l){if(!l.type)return true;var match_type=types&&types.includes(l.type);var match_module=modules&&modules.includes(l.module);return(!types||match_type)&&(match_type&&!l.module||!modules||match_module)})};E.get_full_history=function(types,modules){return E.filter_logs(E.full_history,types,modules).map(function(l){return l.msg})};E.get_player_logs=function(){var set_level=log_levels[E.settings.log_level||"notice"];return E.filter_logs(E.full_history,"player").filter(function(l){return l.level<=Math.max(log_levels.info,set_level)}).map(function(l){return l.msg})};E.logs_to_str=function(logs,full_log){if(!logs)return"no logs";var size=E.settings.max_size/2;if(!full_log&&logs.length>size)logs=logs.slice(-size);logs=logs.map(function(l){return l&&l.msg||l});return logs.length?logs.join("\n")+"\n":"empty logs"};E.init=function(opt){set(opt)};E.full_history=[];E.settings=settings_def();E.t={level_to_console:level_to_console,log_is:log_is,set:set,settings_def:settings_def};return E})})();
define("/svc/cdn/pub/map.js",["/svc/cdn/pub/util.js","/svc/cdn/pub/log.js"],function(util,_log){var E={};var log=_log.set_module("map");E.Map=function(arg){this.ranges=[];this.sum=0;this.size=-1;this.last_ts=0;if(arg){if(typeof arg=="object"){var add_ranges=util.valid_ranges(arg.ranges)&&(!arg.cache_ranges||typeof arg.cache_ranges!="object"||util.valid_ranges(arg.cache_ranges));this.ranges=add_ranges?arg.ranges:[];this.cache_ranges=add_ranges?arg.cache_ranges:arg.cache_ranges?[]:undefined;this.sum=arg.sum;this.size=arg.size;if(arg.exclude_end)this.exclude_end=arg.exclude_end}else this.size=arg}};E.Map.prototype.reset=function(){this.ranges=[];this.cache_ranges=this.cache_ranges?[]:undefined;this.size=-1};E.Map.prototype.set_size=function(sz,force){if(this.size<0||force)this.size=sz;if(this.size!=sz)log.debug("map err size is "+this.size+" try to set size "+sz)};E.Map.prototype.get_date=function(from,to){var ts=this.date,c;if(c=this.get_cache_range(from,to))ts=c.date;return ts};E.Map.prototype.update=function(from,to,ts,info){if(this.size>=0&&to>=this.size){log.debug("map err update chunk.to "+to+" extends past map size "+this.size)}this.set_cache_range(from,to,ts,info);if(ts&&!this.date||ts>this.date)this.date=ts;this.sum+=to+(this.exclude_end?0:1)-from;this.ranges.push({from:from,to:to});this.last_ts=Date.now();if(!this.cache_ranges)this.info=info;this.compress()};E.Map.prototype.remove=function(from,to){if(this.size>=0&&to>=this.size){log.debug("map err remove chunk.to "+to+" extends past map size "+this.size)}var i,c;if(this.cache_ranges){if(!(c=this.get_cache_range(from,to)))return;util.array_rm_elm(this.cache_ranges,c)}var rm=[],add=[];for(i=0;i<this.ranges.length&&(to<0||this.ranges[i].from<=to);i++){var r=this.ranges[i];if(r.to<from)continue;else if(r.from>=from&&(to<0||r.to<=to))rm.push(r);else if(r.from<from&&r.to>to){add.push({from:to+1,to:r.to});r.to=from-1}else if(r.from<from)r.to=from-1;else if(r.to>=to)r.from=to+1}var _this=this;rm.forEach(function(r){util.array_rm_elm(_this.ranges,r)});add.forEach(function(r){_this.ranges.splice(0,0,r)});this.last_ts=Date.now();this.compress();this.summarize()};E.Map.prototype.get_cache_range=function(from,to){if(!this.cache_ranges)return;for(var i=0;i<this.cache_ranges.length&&(this.cache_ranges[i].from!=from||this.cache_ranges[i].to!=to);i++);return i<this.cache_ranges.length?this.cache_ranges[i]:null};E.Map.prototype.set_cache_range=function(from,to,ts,info){if(!this.cache_ranges)return;var c;if(!(c=this.get_cache_range(from,to)))this.cache_ranges.push({from:from,to:to,date:ts,info:info});else if(!c.date||c.date<ts){c.date=ts;c.info=info}};E.Map.prototype.merge=function(map){var _this=this;map.ranges.forEach(function(r){_this.ranges.push({from:r.from,to:r.to})});if(map.cache_ranges&&this.cache_ranges){map.cache_ranges.forEach(function(r){_this.set_cache_range(r.from,r.to,r.date,r.info)})}if(this.size<0)this.size=map.size;this.last_ts=Math.max(this.last_ts,map.last_ts);this.info=map.info;this.compress()};E.Map.prototype.next_unobtained=function(from,to){if(this.size>=0)to=to>=0?Math.min(to,this.size-1):this.size-1;var i;for(i=0;i<this.ranges.length&&(to<0||from<=to);i++){var c=this.ranges[i];if(c.to+1<from)continue;else if(from<c.from)break;else from=to<0?c.to+1:Math.min(c.to+1,to+1)}return to>=0&&from>to?null:{from:from,to:i==this.ranges.length?to:to<0?this.ranges[i].from-1:Math.min(to,this.ranges[i].from-1)}};E.Map.prototype.next_obtained=function(from,to){for(var i=0;i<this.ranges.length;i++){var c=this.ranges[i];if(c.to<from)continue;if(to>-1&&c.from>to)break;return{from:Math.max(c.from,from),to:to<0?c.to:Math.min(c.to,to),date:this.date,info:this.info}}return null};E.Map.prototype.next_obtained_exact=function(from,to){for(var i=0;i<this.cache_ranges.length;i++){var c=this.cache_ranges[i];if(c.from<from)continue;if(to>-1&&c.from>to)break;return{from:c.from,to:c.to,date:c.date,info:c.info,i:i}}return null};E.Map.prototype.summarize=function(){this.sum=0;this.ranges.forEach(function(r){this.sum+=r.to+(this.exclude_end?0:1)-r.from},this)};E.Map.prototype.compress=function(){this.ranges.sort(function(a,b){return a.from-b.from});if(this.cache_ranges)this.cache_ranges.sort(function(a,b){return a.from-b.from});var changed=1,changed_once=0;while(changed){changed=0;for(var i=this.ranges.length-1;i>=0;i--){if(!i||this.ranges[i-1].to+1<this.ranges[i].from)continue;this.ranges[i-1].to=Math.max(this.ranges[i].to,this.ranges[i-1].to);this.ranges.splice(i,1);changed=changed_once=1}}if(changed_once)this.summarize()};return E});
define("/svc/cdn/pub/storage.js",["/svc/cdn/pub/util.js","/util/events.js"],function(util,events){var E={};var spark,conf;var msg,ms_sec=1e3;var broadcast;function append_actions(from,to){from.forEach(function(a){var idx;if(to.find(function(a2,_idx){idx=_idx;return a2.type=="set"&&a.type=="set"&&util.equal_deep(a2.path,a.path)})){to[idx]=a}else to.push(a)})}function is_storage_active(storage_name){try{var _=window[storage_name];if(_.length)return true;_.setItem("_",0);_.removeItem("_");return true}catch(e){}}var storage_stub={setItem:function(){},getItem:function(){},removeItem:function(){}};var db={_storage:is_storage_active("localStorage")?window.localStorage:storage_stub,on_err:function(){},set:function(key,val){try{return this._storage.setItem(key,val)}catch(e){this.on_err("storage_set",key,e)}},get:function(key){try{return this._storage.getItem(key)}catch(e){this.on_err(e)}},get_int:function(key){return+this.get(key)||0},clr:function(key){try{this._storage.removeItem(key)}catch(e){this.on_err(e)}},set_json:function(key,val){try{return this.set(key,JSON.stringify(val||null))}catch(e){this.on_err(e)}},get_json:function(key){var val=this.get(key);if(!val)return val;try{val=JSON.parse(val)}catch(e){this.on_err(e)}return val}};var session_db={_storage:is_storage_active("sessionStorage")?window.sessionStorage:storage_stub,set:function(key,val){try{return this._storage.setItem(key,val)}catch(e){}},get:function(key){try{return this._storage.getItem(key)}catch(e){}}};function Broadcast(){this._handlers={};this._key="spark_tabs_broadcast";this._init()}Broadcast.prototype._init=function(){var _this=this;window.addEventListener("storage",function(event){if(event.key!=_this._key||!event.newValue)return;var _msg;try{_msg=JSON.parse(event.newValue)}catch(e){return}var handlers;if(!(handlers=_this._handlers[_msg.cmd]))return;for(var i=0;i<handlers.length;i++)handlers[i](_msg)})};Broadcast.prototype.on=function(cmd,cb){this._handlers[cmd]=this._handlers[cmd]||[];this._handlers[cmd].push(cb)};Broadcast.prototype.send=function(cmd,data){var _msg={cmd:cmd,data:data};var json;try{json=JSON.stringify(_msg);if(!json||!window||!window.localStorage)return;window.localStorage.setItem(this._key,json);window.localStorage.removeItem(this._key)}catch(e){}};util.inherits(Storage,events.EventEmitter);function Storage(name,parent,opt){var _this=this;this.name=name;this.opt=opt||{};this.opt.def=this.opt.def||{};this.actions=[];this.allocs=[];this.saved_actions=[];if(parent)return this._init_subsection(parent);if(broadcast){broadcast.on("storage_sync",function(_msg){_this._apply_actions(_msg.data);_this.sync()})}msg.add_top_handler("storage_sync",function(frame_idx,actions){_this._apply_actions(actions);_this.sync()});msg.add_top_handler("storage_get",function(){_this.sync();return db.get_json(_this.name)});if(!util.is_top)spark.on("set_top_url",this._init.bind(this));this._init()}Storage.prototype.alloc=function(path,opt){var s=new Storage(path,this,opt);this.allocs.push(s);return s};Storage.prototype.get=function(path){var o=util.get(this.o,path);return typeof o!="object"?o:this._cleanup(util.clone_deep(o))};Storage.prototype.get_parent=function(path){return this.parent?this.parent.get(path):undefined};Storage.prototype.push=function(path,v){this.actions.push({type:"push",path:(this.parent?util.path(this.name):[]).concat(util.path(path)),v:v});return this._push(path,v)};Storage.prototype.push_and_sync=function(path,v){var ret=this.push(path,v);this.sync();return ret};Storage.prototype.set=function(path,v){this.actions.push({type:"set",path:(this.parent?util.path(this.name):[]).concat(util.path(path)),v:v});return this._set(path,v)};Storage.prototype.set_and_sync=function(path,v){this.set(path,v);this.sync();return v};Storage.prototype.set_leaf_max_stale=function(path,max_stale){return this.set_max_stale(path,max_stale,true)};Storage.prototype.set_max_limit=function(path,max_limit){var o=this._get(path);if(!Array.isArray(o))o=this.set(path,[]);o.___limit=max_limit;this.sync()};Storage.prototype.set_max_stale=function(path,max_stale,leaf){var o=this._get(path);if(!o||o.constructor!=Object)o=this.set(path,{});var now=Date.now();if(leaf){if(o.___leaf_max_stale)return;o.___leaf_max_stale=max_stale;Object.keys(o).forEach(function(l){if(o[l]&&o[l].constructor==Object&&!o[l].___ts)o[l].___ts=now})}else{if(o.___max_stale)return;o.___max_stale=max_stale;o.___ts=now}this.sync()};Storage.prototype.size=function(path){var v=this.get(path);if(v===undefined)return 0;if(v.constructor==Object)return Object.keys(v).length;if(Array.isArray(v)||typeof v=="string")return v.length;if(typeof v=="number")return 1};Storage.prototype.splice=function(path,index,howmany){this.actions.push({type:"splice",path:(this.parent?util.path(this.name):[]).concat(util.path(path)),index:index,howmany:howmany,items:Array.from(arguments).slice(3)});return this._splice.apply(this,Array.from(arguments))};Storage.prototype.sync=function(){if(this.parent){append_actions(this.actions,this.parent.actions);this.actions=[];return this.parent.sync()}if(util.is_unfriendly_iframe){append_actions(this.actions,this.saved_actions);if(this.master_synced){msg.storage_sync(this.saved_actions);this.saved_actions=[]}}var diff,now=Date.now(),limit_arr=[];function scan(o,g,max_stale){var eq=util.equal_deep(o,g);diff=!eq||diff;if(o.___max_stale&&eq&&now-o.___ts>o.___max_stale*ms_sec)return true;if(max_stale&&eq&&o.___ts&&now-o.___ts>max_stale*ms_sec)return true;if(!eq&&(max_stale||o.___max_stale)){o.___ts=now;diff=true}if(o.constructor==Object){Object.keys(o).forEach(function(k){if(Array.isArray(o[k])&&o[k].___limit){if(o[k].length>o[k].___limit){o[k].splice(0,o[k].length-o[k].___limit);diff=true}limit_arr.push(o[k])}if(o[k]===undefined||o[k]==null||o[k].constructor!=Object)return;g[k]=g[k]||{};if(scan(o[k],g[k],o.___leaf_max_stale||max_stale)){o[k]=undefined;diff=true}})}}var o=this.o,orig=this.orig;if(util.is_unfriendly_iframe){o={};orig={}}if(scan(o,orig)){o=util.clone_deep(this.opt.def);diff=true}if(this.actions.length&&broadcast){if(util.is_mocha()&&this.send_broadcast)this.send_broadcast("storage_sync",this.actions);else broadcast.send("storage_sync",this.actions)}this.actions=[];if(diff){limit_arr.forEach(function(a){a.push({___limit:a.___limit})});db.set_json(this.name,o);limit_arr.forEach(function(a){a.splice(-1,1)});this.orig=util.clone_deep(this.o)}};Storage.prototype.unset=function(path){this.actions.push({type:"unset",path:(this.parent?util.path(this.name):[]).concat(util.path(path))});this._unset(path)};Storage.prototype.unset_and_sync=function(path){this.unset(path);this.sync()};Storage.prototype._apply_actions=function(actions){if(!actions)return;for(var i=0;i<actions.length;i++){var a=actions[i];switch(a.type){case"set":this._set(a.path,a.v);break;case"unset":this._unset(a.path);break;case"push":this._push(a.path,a.v);break;case"splice":this._splice.apply(this,[a.path,a.index,a.howmany].concat(a.items||[]));break}this.emit("storage_changed_"+a.path[0])}};Storage.prototype._cleanup=function(o){if(typeof o!="object"||o==null)return o;if(Array.isArray(o)){delete o.___limit;return o}for(var key in o){if(typeof o[key]=="object"){this._cleanup(o[key]);continue}if(key.substr(0,3)=="___")delete o[key]}return o};Storage.prototype._deserialize=function(o){if(typeof o.___ts==="string"&&isFinite(o.___ts))o.___ts=+o.___ts;for(var key in o){if(Array.isArray(o[key])&&o[key].length&&o[key][o[key].length-1]&&o[key][o[key].length-1].constructor==Object&&o[key][o[key].length-1].___limit){o[key].___limit=o[key][o[key].length-1].___limit;o[key].splice(-1,1)}if(o[key]&&o[key].constructor==Object)this._deserialize(o[key])}};Storage.prototype._get=function(path){return util.get(this.o,path)};Storage.prototype._init=function(){if(!this.o){this.o=db.get_json(this.name)||util.clone_deep(this.opt.def);this._deserialize(this.o);this.orig=util.clone_deep(this.o)}if(!util.is_unfriendly_iframe)return;var _this=this;var get_storage=function(){msg.storage_get_cb(function(o){if(!o)return;_this._deserialize(o);_this.master_synced=true;_this.prev=util.clone_deep(_this.o);_this.o=o;if(_this.prev.was_top)_this.o.was_top=_this.prev.was_top;_this.orig=util.clone_deep(_this.o);_this.allocs.forEach(function(s){s._init_subsection(_this);s._apply_actions.call(s.saved_actions)});_this.emit("master_synced")})};if(spark.has_master)return get_storage();msg.once("master_found",get_storage)};Storage.prototype._init_subsection=function(parent){this.parent=parent;if(!(this.o=util.get(this.parent.o,this.name))||typeof this.o!="object"){util.set(this.parent.o,this.name,util.clone_deep(this.opt.def));this.o=util.get(this.parent.o,this.name)}this.orig=util.clone_deep(this.o);this.master_synced=parent.master_synced;var _this=this;this.parent.on("storage_changed_"+this.name,function(){_this.emit("storage_changed")});if(util.is_unfriendly_iframe){this.prev=util.get(this.parent.prev,this.name,{});if(this.master_synced)this.emit("master_synced");else{parent.on("master_synced",function(){_this.master_synced=true;_this.emit("master_synced")})}}};Storage.prototype._push=function(path,v){var o=this._get(path);if(!Array.isArray(o))o=this.set(path,[]);return o.push(v)};Storage.prototype._set=function(path,v){util.set(this.o,path,v);if(v!==undefined&&v.constructor==Object){var p=util.path(path);var o=p.length>1?this._get(p.slice(0,-1)):this.o;if(o.___leaf_max_stale){p.push("___ts");util.set(this.o,p,Date.now())}}return v};Storage.prototype._splice=function(path,index,howmany){var o=this._get(path),args=Array.from(arguments).slice(1);return o.splice.apply(o,args)};Storage.prototype._unset=function(path){return util.unset(this.o,path)};E.db=db;E.session_db=session_db;E.is_stub=function(){return db._storage==storage_stub};E.disable=function(){db._storage=storage_stub;session_db._storage=storage_stub};E.init=function(_spark,_conf){spark=_spark;conf=_conf||{};msg=spark.msg;if(conf.disable)E.disable();else broadcast=new Broadcast;return new Storage("spark_web")};E.t={Broadcast:Broadcast,Storage:Storage};return E});
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");define=function(name,deps,fn){return define_node(name,["/util/escape.js"],fn)}}define("/svc/cdn/pub/ajax.js",["/util/escape.js","/svc/cdn/pub/util.js"],function(zescape,util){var assign=Object.assign;var sec_ms=1e3;var E={};var default_opt={method:"GET",url:null,headers:null,data_type:"text",data:null,qs:null,timeout:20*sec_ms,with_credentials:false,return_headers:false};var type_helpers={text:{setup:function(xhr){if(xhr instanceof XMLHttpRequest){xhr.setRequestHeader("Accept","text/*");xhr.responseType="text"}},extract:function(xhr){return xhr.responseText}},json:{setup:function(xhr){if(xhr instanceof XMLHttpRequest){xhr.setRequestHeader("Accept","application/json");xhr.responseType="text"}},extract:function(xhr){return JSON.parse(xhr.responseText)}}};function get_origin(location){if(location.origin)return location.origin;var default_ports={"http:":80,"https:":443};var port=location.port;if(default_ports[location.protocol]==port)port=null;return location.protocol+"//"+location.hostname+(port?":"+port:"")}var probe_link;function get_url_origin(url){probe_link=probe_link||document.createElement("a");probe_link.href=url;probe_link.href=probe_link.href;return get_origin(probe_link)}var can_use_xdr=typeof XDomainRequest=="function"&&!("withCredentials"in XMLHttpRequest.prototype);function is_current_origin(url){return is_node?false:window.location.origin==get_url_origin(url)}E.raw=function(opt,cb,cb_err){cb_err=cb_err||function(){};opt=assign({},default_opt,opt);var type_helper=type_helpers[opt.data_type];if(!type_helper){return cb_err({status:null,status_text:"Unknown data_type "+opt.data_type,response_text:null})}var req=can_use_xdr&&!is_current_origin(opt.url)?new XDomainRequest:new XMLHttpRequest;var timeout;var clean_wrapper=function(_cb){return function(res){req.onload=req.onerror=null;if(timeout)timeout=clearTimeout(timeout);if(_cb)_cb(res)}};cb=clean_wrapper(cb);cb_err=clean_wrapper(cb_err);var url=zescape.uri(opt.url,opt.qs);if(opt.timeout){timeout=setTimeout(function(){req.abort();cb_err({status:null,status_text:"timeout",response_text:null})},opt.timeout)}req.open(opt.method,url,true);type_helper.setup(req);if(opt.headers&&req.setRequestHeader){for(var header in opt.headers)req.setRequestHeader(header,opt.headers[header])}if(opt.with_credentials&&"withCredentials"in req)req.withCredentials=true;req.onload=function(){var status=req.status||200;if(status==1223)status=204;if(status>=200&&status<300){var res=type_helper.extract(req);if(opt.return_headers){return cb({res:res,headers:req.getAllResponseHeaders?req.getAllResponseHeaders():""})}return cb(res)}cb_err({status:status,status_text:req.statusText,response_text:req.responseText})};req.onerror=function(){cb_err({status:req.status,status_text:req.statusText,response_text:req.responseText})};var data=opt.data;if(data!=null){var type=opt.content_type||"application/x-www-form-urlencoded; charset=UTF-8";switch(typeof data){case"object":if(type=="application/json")data=JSON.stringify(data);else data=zescape.qs(data);break;case"string":data=zescape.uri_comp(data);break;default:data=data+""}if(req.setRequestHeader)req.setRequestHeader("Content-Type",type)}req.send(data)};E.json=function(opt,cb,cb_err){opt=assign({},opt,{data_type:"json"});E.raw(opt,cb,cb_err)};function msstream2bin(xhr,opt){var reader=new window.MSStreamReader;function cb(data,to){var ret={progress:opt.served,data:data,last_progress:util.date_monotonic()};opt.progress=opt.served;opt.served=to;opt.onreadystatechange(xhr,ret)}reader.onprogress=reader.onload=function(ev){update_xhr_progress(xhr,ev);var data=ev.target.result;var to=ev.loaded;if(opt.served!=to)cb(data.slice(opt.served,to),to)};reader.readAsArrayBuffer(xhr.response)}function str2bin(xhr,opt){var arr=util.conv_str2bin(xhr.response,opt.served||0);if(!arr)return;var ret={progress:opt.served,data:arr.buffer,last_progress:util.date_monotonic()};opt.progress=opt.served;opt.served=xhr.response.length;return ret}function update_xhr_progress(xhr,ev){if(ev.lengthComputable)xhr.total=ev.total;xhr.loaded=ev.loaded}E.fetch_bin=function(opt,cb){opt.onreadystatechange=opt.onreadystatechange||function(){};opt.onprogress=opt.onprogress||function(){};var url=zescape.uri(util.fix_url(opt.url));var fallback_wrapper=function(f){return opt.fallback_wrapper?opt.fallback_wrapper(f):f};if(opt.streaming)opt.progress=opt.served=0;var xhr=opt.XHR?new opt.XHR(opt.xhr_opt):new XMLHttpRequest;var fetch_info={url:url,opt:opt,xhr:xhr};var _catch=function(e){_finally({err:e})};var _finally=function(res){if(timeout)timeout=clearTimeout(timeout);opt.aborted=true;if(xhr.readyState<xhr.DONE)xhr.abort();cb(res);cb=function(){}};var timeout=setTimeout(function(){_catch("timeout")},opt.timeout||20*sec_ms);var response_handler=function(res){if(!res)return void _catch("failed fetch request");res.hdrs=util.get_resp_hdrs(xhr);if(!res.fullsize){var v;if(v=util.fullsize_from_xhr(xhr))res.fullsize=+v;else if(!opt.hrange&&(!opt.headers||!opt.headers.Range)){res.fullsize=!res.data?0:res.data.byteLength||res.data.length}}res.had_redirect=url!=xhr.responseURL;res.status=xhr.status;_finally(res)};if(opt.withCredentials)xhr.withCredentials=true;xhr.open(opt.method||(opt.data?"POST":"GET"),url,true);xhr.responseType=opt.response_type||"arraybuffer";xhr.onreadystatechange=fallback_wrapper(function(){if(!opt.streaming||xhr.readyState!=xhr.LOADING)opt.onreadystatechange(xhr)});xhr.onprogress=opt.onprogress;var headers=opt.headers||{};if(headers.Range&&util.browser.browser=="safari")headers["Cache-Control"]="no-store";if(opt.data){var type=opt.content_type||"application/json";if(!opt.no_content_type)headers["Content-Type"]=type;if(type=="application/json"&&typeof opt.data=="object")opt.data=JSON.stringify(opt.data)}for(var hdr in headers)xhr.setRequestHeader(hdr,headers[hdr]);function onload(ev){xhr.success=true;var res=xhr.response;if(opt.response_type=="json"&&xhr.responseType!="json")try{res=JSON.parse(res)}catch(e){}if(xhr.responseType=="ms-stream")res=null;response_handler({data:res,size:ev.total})}xhr.onload=fallback_wrapper(onload);xhr.onerror=function(e){_catch(e)};if(opt.streaming){var b=util.browser.browser,v=util.browser.version;if(b=="chrome"&&v>=7||b=="firefox"&&v>=9&&opt.streaming_text){xhr.responseType="text";xhr.overrideMimeType("text/plain; charset=x-user-defined");xhr.onprogress=fallback_wrapper(function(e){update_xhr_progress(xhr,e);opt.onprogress.call(xhr,e,str2bin(xhr,opt))})}else if((b=="edge"||b=="ie"&&v>=10)&&window.MSStreamReader){xhr.responseType="ms-stream";xhr.onreadystatechange=fallback_wrapper(function(){if(xhr.readyState==xhr.LOADING)msstream2bin(xhr,opt);else opt.onreadystatechange(xhr)})}else if(b=="firefox"&&v>=9){xhr.responseType="moz-chunked-arraybuffer";xhr.onprogress=fallback_wrapper(function(ev){var res=xhr.response;if(!res)return;update_xhr_progress(xhr,ev);opt.progress=opt.served;opt.served=opt.progress+res.byteLength;opt.onprogress.call(xhr,ev,{progress:opt.progress,data:res,last_progress:util.date_monotonic()})})}else opt.streaming=false}xhr.streaming=opt.streaming;xhr.send(opt.data);return fetch_info};E.uninit=function(){};return E})})();
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else define=require("../../../util/require_node.js").define(module,"../");define("/svc/cdn/pub/perr.js",["/util/util.js","/util/escape.js","/svc/cdn/pub/ajax.js","/svc/cdn/pub/log.js","/svc/cdn/pub/util.js"],function(zutil,zescape,ajax,_log,util){var assign=Object.assign;var ms_sec=1e3,ms_min=60*ms_sec,ms_hour=60*ms_min;var E=cdn_perr;var perrs=[];var def_perr_url="//perr.h-cdn.com/be_client_cgi/perr";var perr_url=def_perr_url;var perr_sent={};var perr_rl_hash={};var delayed_timer;var log=_log.set_module("perr");function JSON_stringify(obj){var pos_inf={__Infinity__:1};var neg_inf={__Infinity__:-1};function replace_inf(k,v){switch(v){case Infinity:return pos_inf;case-Infinity:return neg_inf;default:return v}}var s;try{s=JSON.stringify(obj,replace_inf)}finally{}return s}function build_info(){var b={platform:typeof navigator!="undefined"&&navigator.platform,user_agent:typeof navigator!="undefined"&&navigator.userAgent};b.ver=util.ver;b.browser=util.browser_string;b.browser_build=typeof window!="undefined"&&window.conf&&window.conf.browser&&window.conf.browser.name;b.guess=JSON.stringify(util.guess);return b}function build(){var info=build_info(),s="";for(var f in info)s+=(s&&"\n")+f+": "+info[f];return s}function to_form_data(o){var data=new FormData;zutil.forEach(o,function(v,k){data.append(k,v)});return data}function send_beacon(url,data){if(typeof navigator!="undefined"&&navigator.sendBeacon){data.send_type="BEACON";if(navigator.sendBeacon(url,to_form_data(data)))return;data.send_type=undefined}data.send_type="POST";ajax.raw({url:util.fix_url(url),data:data,method:"POST"})}function perr_delayed(opt){if(!zutil.get(util.conf,"loader.delayed_perrs_enable")&&!zutil.get(util.conf,"loader.delayed_perrs_filterin",[]).includes(opt.id)){return}perrs.push(opt);if(delayed_timer)return;delayed_timer=setTimeout(send_delayed_perrs,5*ms_sec)}function send_delayed_perrs(){delayed_timer=clearTimeout(delayed_timer);if(!perrs.length)return;if(!util.is_beforeunload&&!util.is_hidden){var can_send=true;var wrappers=zutil.get(util.loader,"wrapper",[]);wrappers.forEach(function(w){if(!can_send||!w.player||!w.player.is_playing())return;var b=w.player.get_current_buffer();if(b.to-b.from>20)return;can_send=false});if(!can_send)delayed_timer=setTimeout(send_delayed_perrs,5*ms_sec)}var max=25,_perrs=perrs.slice(0,max);perrs=perrs.slice(max);cdn_perr({id:"delayed_perrs",delay:false,delayed_perrs:_perrs});if(perrs.length)delayed_timer=setTimeout(send_delayed_perrs,ms_sec)}function perr_raw(opt){var data={},qs={},delayed=opt.delay===undefined||!!opt.delay;data.info=opt.info;data.bt=opt.bt;data.filehead=opt.filehead;if(opt.delayed_perrs)data.delayed_perrs=JSON.stringify(opt.delayed_perrs);qs.id=opt.id;qs.browser=opt.browser||(util.browser.opera?"opera":util.browser.ucbrowser?"ucbrowser":util.browser.samsung_browser?"samsung":util.browser.browser);qs.browser_ver=util.browser.version;qs.customer=opt.customer;if(opt.tag){qs.tag_id=opt.tag.id;qs.tag_date=+opt.tag.date}if(opt.zone)qs.zone=opt.zone;data.is_json=1;if(delayed&&!+util.get_spark_uri("hola_no_perr_delay")){assign(data,qs);perr_delayed(data);return}data.ver=util.ver;data.build=build();var url=(opt.perr_url||perr_url)+"?"+zescape.qs(qs);if(opt.use_beacon)return void send_beacon(url,data);data.send_type="POST";ajax.raw({url:util.fix_url(url),data:data,method:"POST"})}function rate_limit(rl,ms,n){var now=Date.now();if(!rl.count||rl.ts+ms<now){rl.count=1;rl.ts=now;return true}rl.count++;return rl.count<=n}function perr_rate_limit(opt){if(opt.rate_limit===false)return true;var _rl=assign({ms:ms_hour,count:10},opt.rate_limit);var id=opt.id,rl=perr_rl_hash[id]=perr_rl_hash[id]||{};var ret=rate_limit(rl,_rl.ms,_rl.count);if(!ret){var key="perr_rate_limit_"+id;if(!perr_sent[key])cdn_perr({id:"perr_rate_limit",info:id,rate_limit:false});perr_sent[key]=1}return ret}function db_perr(opt){opt=opt||{};var id=opt.id;if(opt.throttle&&!opt.force&&(opt.throttle>=1&&(perr_sent[id]||0)>=opt.throttle||opt.throttle<1&&Math.random()>opt.throttle)){return}perr_rate_limit(opt);var data=opt.data||{};data.sent=data.sent||{};var info=typeof opt.info!="object"?{_info:opt.info}:opt.info;var customer,zone=opt.zone||{};if(!info.customer&&(customer=util.conf.customer))info.customer=customer;if(!info.zone&&zone.name)info.zone=zone.name;if(!info.method&&zone.method)info.method=zone.method;info.hola_mode=info.hola_mode||zone.mode;info.skip=zone.skip;info.dashboard=";type="+(zone.stream_type||"unknown")+(zone.player_type?";player="+zone.player_type:"")+(zone.tech?";tech="+zone.tech:"");var url_frame=util.get_location_urls();var url=data.url||opt.url||url_frame.top_url;var match=url?url.match(/^http(s)?:\/\/(www\.)?([a-zA-Z0-9-.]+)\/.*$/):null;info.url=url;info.frame=!!url_frame.frame_url;info.location_url=url_frame.frame_url||url_frame.top_url;if(!info.page_url)info.page_url=url_frame.top_url;info.site=match?match[3]:"unknown";info.referrer=typeof document!="undefined"&&document.referrer;info.referrer_type=util.referrer_type(info.location_url,info.referrer,util.gconf_get("loader.referrer_internal_regex"));assign(info,opt.extra,{file:data.file,link:data.link,err:opt.err||info.err});info.is_embed=typeof window!="undefined"&&window.top&&window.top!==window;info.is_touch=typeof document!="undefined"&&"ontouchstart"in document.documentElement;if(util.mvp_marker!=null)info.mvp_marker=util.mvp_marker;info.support_fullscreen=util.browser_support_fullscreen;var nc;if(typeof navigator!="undefined"&&(nc=navigator.connection))info.connection={type:nc.type,downlink_max:nc.downlinkMax};if(zone.bwsaver)info.bw_saving=zone.bwsaver;if(zone.video_url&&!info.video_url)info.video_url=zone.video_url;if(zone.video_live&&info.video_live===undefined)info.video_live=zone.video_live;if(zone.player_info)info.player_info=zone.player_info;if(util.is_beforeunload)info.before_unload=true;perr_sent[id]=perr_sent[id]+1||1;info.tag=zutil.get(util.loader,"tag");info.injected=util.loader&&util.loader.CG("loader.injected");info.analysis_tag=opt.analysis_tag;var info_str;try{info_str=JSON_stringify(info)}catch(e){info_str="[circular]"}perr_raw({tag:info.tag,id:opt.prefix+id,info:info_str,customer:customer,zone:zone.name,bt:opt.bt,browser:opt.browser,filehead:opt.filehead,use_beacon:opt.use_beacon,perr_url:perr_url,delay:opt.delay,delayed_perrs:opt.delayed_perrs})}var skip_perr=false;function cdn_perr(opt){if(skip_perr)return;opt.filehead=opt.filehead?opt.filehead+"\n\n":"";if(opt.add_log){var logs;if(opt.full)logs=_log.get_full_history();else{var log_types=opt.log_types||"cdn";var log_obj=opt.log_obj||(opt.zone?opt.zone.log:_log);logs=_log.filter_logs(log_obj.get_logs(true),log_types,opt.log_modules);logs=_log.concat_logs(logs,_log.get_player_logs(),true)}if(opt.player_logs)logs=_log.concat_logs(logs,opt.player_logs,true);opt.filehead+=_log.logs_to_str(logs,opt.full||opt.full_log)}else opt.filehead+="no log requested";return db_perr(assign(opt,{prefix:"www_cdn_db_"}))}var inited=false;E.init=function(_perr_url){if(inited)return;inited=true;var proto=zutil.get(util.conf,"loader.https_xhr_only")?"https:":"";perr_url=_perr_url||proto+def_perr_url;perr_sent={};perr_rl_hash={};util._events.on("beforeunload",uninit);util._events.on("visible_state",send_delayed_perrs);util._events.on("hidden_state",send_delayed_perrs);util._events.on("uninit",uninit)};function uninit(){send_delayed_perrs();util._events.off("beforeunload",uninit);util._events.off("visible_state",send_delayed_perrs);util._events.off("hidden_state",send_delayed_perrs);util._events.off("uninit",uninit)}E.try_wrapper=function(opt,func){if(typeof opt=="function"){func=opt;opt={}}var throttle=opt.throttle||5;var prefix=opt.prefix||"perr";return function(){try{return func.apply(this,arguments)}catch(e){console.error("error in perr %o",e);if(opt.silent)return;cdn_perr({id:prefix+"_try_wrapper_err",err:e.message,throttle:throttle,delay:false,bt:e.stack,opt:opt});if(log)log.err(prefix+"_try_wrapper_err "+e+" "+e.stack)}}};E.t={disable:function(){skip_perr=true},enable:function(){skip_perr=false}};return E})})();
define("/svc/cdn/pub/cache.js",{__stub:1});
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;if(!is_node)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/rand.js",[],function(){var E={};var is_jtest=false;var jtest_vals={};var MAX_INT=2147483647;var MIN_INT=-MAX_INT-1;function jtest_pop(s){var elm;if(s===undefined)return null;if((elm=jtest_vals[s])===undefined)return null;return elm.shift()}E.rand=function(s){var ret;if(is_jtest&&(ret=jtest_pop(s))!==null)return ret;return Math.random()};E.rand_int32=function(s){var ret;if(is_jtest&&(ret=jtest_pop(s))!==null)return ret;return Math.floor(Math.random()*(MAX_INT-MIN_INT+1))-MAX_INT};E.rand_range=function(from,to,s){var ret;if(is_jtest&&(ret=jtest_pop(s))!==null)return ret;return Math.floor(Math.random()*(to-from))+from};E.rand_element=function(a,s){if(a.length)return a[E.rand_range(0,a.length,s)]};E.rand_subset=function(a,size,s){var shuffled=a.slice(0);for(var i=0;i<size;i++){var j=E.rand_range(i,shuffled.length,s);var tmp=shuffled[j];shuffled[j]=shuffled[i];shuffled[i]=tmp}return shuffled.slice(0,size)};E.jtest_push=function(s,arr){if(!jtest_vals[s])jtest_vals[s]=[];if(Array.isArray(arr))jtest_vals[s].push.apply(jtest_vals[s],arr);else jtest_vals[s].push(arr)};E.jtest_init=function(){is_jtest=true;jtest_vals={}};E.jtest_uninit=function(){is_jtest=false};E.basic_u32=function(v){return 1103515245*v+12345>>>0};E.basic_u31=function(v){return 1103515245*v+12345&2147483647};return E})})();
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/hash.js",[],function(){var E={};function imul64h(a,b){var ah=a>>>16&65535;var al=a&65535;var bh=b>>>16&65535;var bl=b&65535;return ah*bh+(ah*bl+al*bh)>>16|0}E.hash_int=function(val){var xh=imul64h(val,1103515245);var xl=Math.imul(val,1103515245);return xl-xh>>>0};E.hash_string=function(s){if(!s.length)return 0;var hash=E.hash_int(s.length);for(var i=0;i<s.length;i+=2){hash=E.hash_int(hash+(s.charCodeAt(i)<<16)+(s.charCodeAt(i+1)|0)>>>0)}return hash};E.sum_parse=function(str){var parts=/([0-9a-f]+)\s+([ *]?)(.*)/i.exec(str);if(!parts)return null;return{hash:parts[1],type:parts[2]=="*"?"binary":"text",file:parts[3]}};return E})})();
!function(n){function t(n,t){var r=(65535&n)+(65535&t),e=(n>>16)+(t>>16)+(r>>16);return e<<16|65535&r}function r(n,t){return n<<t|n>>>32-t}function e(n,e,o,u,c,f){return t(r(t(t(e,n),t(u,f)),c),o)}function o(n,t,r,o,u,c,f){return e(t&r|~t&o,n,t,u,c,f)}function u(n,t,r,o,u,c,f){return e(t&o|r&~o,n,t,u,c,f)}function c(n,t,r,o,u,c,f){return e(t^r^o,n,t,u,c,f)}function f(n,t,r,o,u,c,f){return e(r^(t|~o),n,t,u,c,f)}function i(n,r){n[r>>5]|=128<<r%32,n[(r+64>>>9<<4)+14]=r;var e,i,a,h,d,l=1732584193,g=-271733879,v=-1732584194,m=271733878;for(e=0;e<n.length;e+=16)i=l,a=g,h=v,d=m,l=o(l,g,v,m,n[e],7,-680876936),m=o(m,l,g,v,n[e+1],12,-389564586),v=o(v,m,l,g,n[e+2],17,606105819),g=o(g,v,m,l,n[e+3],22,-1044525330),l=o(l,g,v,m,n[e+4],7,-176418897),m=o(m,l,g,v,n[e+5],12,1200080426),v=o(v,m,l,g,n[e+6],17,-1473231341),g=o(g,v,m,l,n[e+7],22,-45705983),l=o(l,g,v,m,n[e+8],7,1770035416),m=o(m,l,g,v,n[e+9],12,-1958414417),v=o(v,m,l,g,n[e+10],17,-42063),g=o(g,v,m,l,n[e+11],22,-1990404162),l=o(l,g,v,m,n[e+12],7,1804603682),m=o(m,l,g,v,n[e+13],12,-40341101),v=o(v,m,l,g,n[e+14],17,-1502002290),g=o(g,v,m,l,n[e+15],22,1236535329),l=u(l,g,v,m,n[e+1],5,-165796510),m=u(m,l,g,v,n[e+6],9,-1069501632),v=u(v,m,l,g,n[e+11],14,643717713),g=u(g,v,m,l,n[e],20,-373897302),l=u(l,g,v,m,n[e+5],5,-701558691),m=u(m,l,g,v,n[e+10],9,38016083),v=u(v,m,l,g,n[e+15],14,-660478335),g=u(g,v,m,l,n[e+4],20,-405537848),l=u(l,g,v,m,n[e+9],5,568446438),m=u(m,l,g,v,n[e+14],9,-1019803690),v=u(v,m,l,g,n[e+3],14,-187363961),g=u(g,v,m,l,n[e+8],20,1163531501),l=u(l,g,v,m,n[e+13],5,-1444681467),m=u(m,l,g,v,n[e+2],9,-51403784),v=u(v,m,l,g,n[e+7],14,1735328473),g=u(g,v,m,l,n[e+12],20,-1926607734),l=c(l,g,v,m,n[e+5],4,-378558),m=c(m,l,g,v,n[e+8],11,-2022574463),v=c(v,m,l,g,n[e+11],16,1839030562),g=c(g,v,m,l,n[e+14],23,-35309556),l=c(l,g,v,m,n[e+1],4,-1530992060),m=c(m,l,g,v,n[e+4],11,1272893353),v=c(v,m,l,g,n[e+7],16,-155497632),g=c(g,v,m,l,n[e+10],23,-1094730640),l=c(l,g,v,m,n[e+13],4,681279174),m=c(m,l,g,v,n[e],11,-358537222),v=c(v,m,l,g,n[e+3],16,-722521979),g=c(g,v,m,l,n[e+6],23,76029189),l=c(l,g,v,m,n[e+9],4,-640364487),m=c(m,l,g,v,n[e+12],11,-421815835),v=c(v,m,l,g,n[e+15],16,530742520),g=c(g,v,m,l,n[e+2],23,-995338651),l=f(l,g,v,m,n[e],6,-198630844),m=f(m,l,g,v,n[e+7],10,1126891415),v=f(v,m,l,g,n[e+14],15,-1416354905),g=f(g,v,m,l,n[e+5],21,-57434055),l=f(l,g,v,m,n[e+12],6,1700485571),m=f(m,l,g,v,n[e+3],10,-1894986606),v=f(v,m,l,g,n[e+10],15,-1051523),g=f(g,v,m,l,n[e+1],21,-2054922799),l=f(l,g,v,m,n[e+8],6,1873313359),m=f(m,l,g,v,n[e+15],10,-30611744),v=f(v,m,l,g,n[e+6],15,-1560198380),g=f(g,v,m,l,n[e+13],21,1309151649),l=f(l,g,v,m,n[e+4],6,-145523070),m=f(m,l,g,v,n[e+11],10,-1120210379),v=f(v,m,l,g,n[e+2],15,718787259),g=f(g,v,m,l,n[e+9],21,-343485551),l=t(l,i),g=t(g,a),v=t(v,h),m=t(m,d);return[l,g,v,m]}function a(n){var t,r="";for(t=0;t<32*n.length;t+=8)r+=String.fromCharCode(n[t>>5]>>>t%32&255);return r}function h(n){var t,r=[];for(r[(n.length>>2)-1]=void 0,t=0;t<r.length;t+=1)r[t]=0;for(t=0;t<8*n.length;t+=8)r[t>>5]|=(255&n.charCodeAt(t/8))<<t%32;return r}function d(n){return a(i(h(n),8*n.length))}function l(n,t){var r,e,o=h(n),u=[],c=[];for(u[15]=c[15]=void 0,o.length>16&&(o=i(o,8*n.length)),r=0;16>r;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(h(t)),512+8*t.length),a(i(c.concat(e),640))}function g(n){var t,r,e="0123456789abcdef",o="";for(r=0;r<n.length;r+=1)t=n.charCodeAt(r),o+=e.charAt(t>>>4&15)+e.charAt(15&t);return o}function v(n){return unescape(encodeURIComponent(n))}function m(n){return d(v(n))}function p(n){return g(m(n))}function s(n,t){return l(v(n),v(t))}function C(n,t){return g(s(n,t))}function A(n,t,r){return t?r?s(t,n):C(t,n):r?m(n):p(n)}"function"==typeof define&&define.amd?define("md5",[],function(){return A}):"object"==typeof module&&module.exports?module.exports=A:n.md5=A}(this);
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");var zutil=require("../../../util/util.js");var md5=zutil.is_mocha()&&"/svc/cdn/pub/md5.min.js";define=function(name,deps,fn){return define_node(name,["/svc/cdn/pub/util.js","/util/rand.js",null,md5],fn)}}define("/svc/cdn/pub/cdn_util.js",["/svc/cdn/pub/util.js","/util/rand.js","/svc/cdn/pub/storage.js","md5"],function(util,rand,storage,md5){var E={};var assign=Object.assign;E.get_random=function(salt){var key="hola_random_"+salt;var force=+util.get_spark_uri(key,false);if(force)return force;if(util.gconf_get("loader.real_random")){var saved=storage.db.get_int(key);if(saved)return saved;var random=rand.rand("random_from_storage");storage.db.set(key,random);return random}E.get_random.salt=E.get_random.salt||{};var ip=util.geoip&&util.geoip.ip;if(E.get_random.salt[salt])return E.get_random.salt[salt];if(!ip){if(!E.get_random.salt[salt])E.get_random.salt[salt]=rand.rand("random_by_ip")}else{E.get_random.salt[salt]=parseInt(md5(ip+salt).slice(-4),16)/Math.pow(2,16)}return E.get_random.salt[salt]};E.set_geoip=function(data){if(!data)return;util.geoip=util.clone(data);util.geoip.ver=util.conf.ver;for(var i in util.geoip){if(typeof util.geoip[i]=="string")util.geoip[i]=util.geoip[i].toLowerCase()}if(data.date)util.geoip.date_skew=new Date(util.jdate_now())-new Date(data.date);util.geoip.update=util.jdate_now();storage.db.set_json("hola_geoip",util.geoip);util._events.emit("set_geoip",util.geoip)};E.log_report=function(opt){var bws=opt.video_ctx&&opt.video_ctx.attached_bws;var stats=opt.video_ctx&&opt.video_ctx.attached_stats;if(!opt.zone&&!bws&&!stats||!opt.id)return;if(!opt.add_unittest&&!opt.add_log&&!opt.load_perf&&!opt.exception)return;var zone=(bws||stats||opt).zone;if(!zone)return;var zperr=zone.perr_get();var o={id:opt.id+"_report",delay:false,info:{only_stats:!bws},extra:assign({},opt.extra,!opt.exception&&stats&&stats.get_stats_all()),use_beacon:true,add_log:opt.add_log,log_types:opt.log_types,log_modules:opt.log_modules,analysis_tag:opt.analysis_tag,log_obj:opt.log_obj,full:opt.full,player_logs:opt.player_logs};if(zone.CG("log.full"))o.full=true;if(opt.add_unittest&&bws)o.filehead="last test:\n"+bws.unittest.gen_test();if(bws&&bws.serve_log_arr.length)o.info.serve_log=bws.serve_log_arr;if(opt.load_perf){o.filehead=(o.filehead?o.filehead+"\n":"")+"Load perf:\n";o.filehead+=opt.load_perf;o.info.load_perf=true}if(opt.exception)o.info.exception=opt.exception;zperr(o)};return E})})();
define("json_stable_stringify",[],function(){var json=JSON;var E=function(obj,opts){if(!opts)opts={};if(typeof opts==="function")opts={cmp:opts};var space=opts.space||"";if(typeof space==="number")space=Array(space+1).join(" ");var cycles=typeof opts.cycles==="boolean"?opts.cycles:false;var replacer=opts.replacer||function(key,value){return value};var cmp=opts.cmp&&function(f){return function(node){return function(a,b){var aobj={key:a,value:node[a]};var bobj={key:b,value:node[b]};return f(aobj,bobj)}}}(opts.cmp);var seen=[];return function stringify(parent,key,node,level){var indent=space?"\n"+new Array(level+1).join(space):"";var colonSeparator=space?": ":":";if(node&&node.toJSON&&typeof node.toJSON==="function"){node=node.toJSON()}node=replacer.call(parent,key,node);if(node===undefined){return}if(typeof node!=="object"||node===null){return json.stringify(node)}if(Array.isArray(node)){var out=[];for(var i=0;i<node.length;i++){var item=stringify(node,i,node[i],level+1)||json.stringify(null);out.push(indent+space+item)}return"["+out.join(",")+indent+"]"}else{if(seen.indexOf(node)!==-1){if(cycles)return json.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else seen.push(node);var keys=Object.keys(node).sort(cmp&&cmp(node));var out=[];for(var i=0;i<keys.length;i++){var key=keys[i];var value=stringify(node,key,node[key],level+1);if(!value)continue;var keyValue=json.stringify(key)+colonSeparator+value;out.push(indent+space+keyValue)}seen.splice(seen.indexOf(node),1);return"{"+out.join(",")+indent+"}"}}({"":obj},"",obj,0)};return E});
define("/svc/cdn/pub/zone_match.js",{__stub:1});
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");define=function(name,deps,fn){return define_node(name,["/util/util.js",null,"/svc/cdn/pub/util.js",null,null,null],fn)}}define("/svc/cdn/pub/zone.js",["/util/util.js","/svc/cdn/pub/zone_match.js","/svc/cdn/pub/util.js","/svc/cdn/pub/log.js","/svc/cdn/pub/perr.js","/svc/cdn/pub/cdn_util.js","/svc/cdn/pub/storage.js"],function(zutil,zone_match,util,_log,perr,cdn_util,storage){var E=Zone,assign=Object.assign;var random;function reset_random(set){random=set||undefined}function select_zone(zones,opt){function storage_zone(){try{return storage.session_db.get("hola_zone")||storage.db.get("hola_zone")}catch(e){}}function is_selected(zone){var match=zone.loader?zone.loader.match:zone.match;if(!match||!Object.keys(match).length||zone.kw.disabled||zone.kw.hidden){return}var geoip=util.geoip||{};var current_date=typeof geoip.date_skew=="number"?new Date(Date.now()-geoip.date_skew):null;rand_percent+=match.rand||0;random=random||cdn_util.get_random("zone");var match_opt=assign({url:opt.top_url,browser:util.browser_rule_s,os:util.guess.os,version:util.guess.version,random:random,rand_percent:rand_percent,date:current_date,video_url:opt.video_url,frame_url:opt.frame_url,no_mse:opt.no_mse,no_h264:opt.no_h264,player_n:opt.player_n,video_check_n:opt.video_check_n,player:opt.player},geoip);var matched=false;if(!match.js){match.zone=zone.zone;match.rules=zone.loader&&zone.loader.rules;match.js=zone_match.make_fn(match)}try{var match_fn=new Function("opt",match.js);matched=match_fn(match_opt)}catch(e){_log.err(e.stack||""+e)}if(matched)return zone}var uri_zone=util.get_spark_uri(opt.location||location,"hola_zone");var rand_percent=0,name;if(uri_zone)return uri_zone;if(name=storage_zone())return name;return(zutil.find(zones,is_selected)||{zone:"gen"}).zone}function check_h264(){var type='video/mp4; codecs="avc1.42E01E"';var ms=window.MediaSource;if(ms&&ms.isTypeSupported)return ms.isTypeSupported(type);if(window.hola_cdn_sdk||window.spark_ios_sdk)return true;var el=document.createElement("video");return el.canPlayType&&(el.canPlayType(type)||el.canPlayType(type+', mp4a.40.2"'))}function get_zone_opt(loader){var jtest_location=loader.jtest&&loader.jtest.location;if(jtest_location)return{location:jtest_location,top_url:jtest_location.href};var loaded_in_debug=util.get_spark_uri("hola_debug");var url_frame=util.get_location_urls(loaded_in_debug);return{top_url:url_frame.top_url,frame_url:url_frame.frame_url,no_mse:!window.MediaSource,no_h264:!check_h264()}}Zone.prototype.log_get=function(){return this.log};Zone.prototype.perr_get=function(){var _this=this;return function(opt){opt.zone=assign({},_this.info);opt.zone.name=_this.name;opt.zone.mode=_this.CG("mode");opt.zone.skip=_this.CG("skip");if(opt.add_log)opt.zone.log=_this.log;perr(opt)}};Zone.prototype.conf_set=function(path,val,opt){util.conf_set(this.conf,path,val);if(opt&&opt.reconf)this.reconf();return val};Zone.prototype.conf_mvp=function(path){var percent;if(!(percent=this.conf_get(path+"_mvp"))||util.mvp_marker!=null)return;random=random||cdn_util.get_random("zone");if(random>percent/100)return util.mvp_marker=0;this.conf_set(path,util.mvp_marker=1)};Zone.prototype.conf_get=function(path,def){return util.conf_get(this.conf,path,def)};Zone.prototype.conf_get_json=function(path,def){var s=this.conf_get(path,def);if(!s||typeof s=="object")return s;try{return JSON.parse(s)}catch(e){}};Zone.prototype.conf_enable=function(path){this.conf_set(path,true)};Zone.prototype.conf_disable=function(path){this.conf_set(path,false)};Zone.prototype.conf_have=function(path){return this.conf_get(path)!==undefined};Zone.prototype.conf_test_disable=function(path){if(!this.conf_get(path))return false;this.conf_disable(path);return true};Zone.prototype.conf_apply=function(path,args,def,_this,throw_ex){return util.conf_apply(this.conf,path,args,def,_this,throw_ex)};var aliases={CG:"conf_get",CGJ:"conf_get_json",CS:"conf_set",CE:"conf_enable",CD:"conf_disable",CH:"conf_have",CTD:"conf_test_disable",CMVP:"conf_mvp"};for(var k in aliases)Zone.prototype[k]=Zone.prototype[aliases[k]];Zone.prototype.init=function(conf){this.conf=zutil.extend_deep(conf||{},this._get_dbg_conf(),util.get_uri_conf())};Zone.prototype._get_dbg_conf=function(){return this.loader&&this.loader.get_dbg_conf&&this.loader.get_dbg_conf()||{}};Zone.prototype.uninit=function(){this.inited=false;this.conf={};this.info={}};Zone.prototype.stash=function(){var _this=this;var stash={conf:zutil.clone_deep(this.conf),info:zutil.clone_deep(this.info),name:this.name};return function(){assign(_this,stash);_this.reconf()}};Zone.prototype.customer_conf_get=function(){var _this=this,zones=this.loader.get_zones();var predicate=function(z){return z.zone==_this.name};return this.name=="gen"?zones.gen:zutil.find(zones.zones,predicate)};Zone.prototype.zone_init=function(opt){if(!util.geoip||!util.geoip.country){if(this.loader&&this.loader.loader_conf&&this.loader.loader_conf.geoip_fallback){cdn_util.set_geoip(this.loader.loader_conf.geoip_fallback)}}var zones=this.loader.get_zones();this.name=opt.force_zone?opt.force_zone:select_zone(zones.zones,assign({},opt,get_zone_opt(this.loader)));this.conf=zutil.extend_deep({zone:this.name},zutil.clone_deep(util.conf),zutil.clone_deep(this.customer_conf_get()),this._get_dbg_conf(),util.get_uri_conf());this.inited=true;this.reconf()};function watch_reconf(watch,zone_conf,is_init){var val={},old_val=watch.value,opt=watch.opt,path=opt.conf;if(typeof path=="string")val=zutil.get(zone_conf,path,opt.defval);else{if(!watch.hasOwnProperty("value"))old_val={};Object.keys(path).forEach(function(name){if(zutil.has(zone_conf,path[name]))val[name]=zutil.get(zone_conf,path[name])});val=assign({},opt.defval,val)}if(watch.opt.ontoggle&&(is_init||val!=old_val))watch.opt.ontoggle(watch.ctx,val);else if(watch.opt.onchange&&(is_init||!zutil.equal_deep(old_val,val)))watch.opt.onchange(watch.ctx,old_val,val);watch.value=val}Zone.prototype.conf_watch=function(watches){var _this=this;if(!(watches instanceof Array))watches=[watches];watches.forEach(function(w){var zw={opt:w,ctx:{}};watch_reconf(zw,_this.conf,true);_this.watches.push(zw)});return{uninit:function(){watches.forEach(function(w){var zw=_this.watches.find(function(zw){return zw.opt==w});if(zw.opt.uninit)zw.opt.uninit(zw.ctx,zw.value);_this.watches.splice(_this.watches.indexOf(zw),1)});watches=[]}}};Zone.prototype.reconf=function(watches){var new_conf=this.conf;this.watches.forEach(function(zw){watch_reconf(zw,new_conf)})};function Zone(_loader,conf,id,opt){if(!(this instanceof Zone))return new Zone(_loader);opt=opt||{};this.loader=_loader;this.info={};this.watches=[];this.id=id||0;this.log=(opt.log||_log).reset_module();this.zperr=this.perr_get();if(conf){conf.customer=conf.customer||_loader&&_loader.customer;this.init(conf)}}Zone.prototype.get_link_type=function(link){var type=util.get_video_type(util.video2type(link,this));return util.get_method_type(type)};E.t={select_zone:select_zone,get_zone_opt:get_zone_opt,check_h264:check_h264,reset_random:reset_random,Zone:Zone};return E})})();
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");var zutil=require("../../../util/util.js");var md5=zutil.is_mocha()&&"/svc/cdn/pub/md5.min.js";define=function(name,deps,fn){return define_node(name,["/util/util.js","/svc/cdn/pub/util.js",null,"events","/util/escape.js","/util/rand.js","/util/hash.js","/svc/cdn/pub/ajax.js","/svc/cdn/pub/cdn_util.js",md5,null],fn)}}define("/svc/cdn/pub/cdnlist.js",["/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/storage.js","/util/events.js","/util/escape.js","/util/rand.js","/util/hash.js","/svc/cdn/pub/ajax.js","/svc/cdn/pub/cdn_util.js","md5","/svc/cdn/pub/zone.js"],function(zutil,util,storage,events,zescape,rand,hash,ajax,cdn_util,md5,_zone){var E={};var KB=1024,assign=Object.assign;var ms_since=util.ms_since;var ERR=util.ERR;var ms_sec=1e3,ms_min=60*ms_sec,ms_hour=60*ms_min;E.version="5";E.pool=[];E.next_uid=1;E.Cdn=function Cdn(opt){opt=opt||{};if(!(this instanceof E.Cdn))return new E.Cdn(opt);var info=E.all_agents&&E.all_agents.get(opt.host)||{};this.ms_hdrs=this.bpms=this.bytes=this.fail=0;this.success=this.delayed=this.aborted_bytes=0;this.aborted=this.ttfb_n=this.ttfb=this.ranges_supported=0;this.enabled=1;this.cache={hit:{},miss:{}};this.cost=+opt.cost||info.cost;this.req_uid=opt.req_uid||0;this.uid=opt.uid;this.role=opt.role||info.role;this.origin=opt.origin;this.master=opt.master;this.owner=opt.owner||info.owner;this.host=opt.host;this.type=opt.type||info.type;this.country=opt.country||info.country;this.disconnect=this.disconnect_wait=this.disconnect_ts=0;this.busy=this.busy_wait=this.busy_ts=0;this.hostname=opt.hostname||info.hostname||opt.host;this.name=opt.name||opt.hostname||this.host;this.id="cw"+this.uid;this.learning=assign({},opt.learning);this.progress_bw={bw:0,samples:[],max:opt.max_samples||50};this.success_ts=this.fail_ts=0;this.split=this.split||{};if(opt.progress_bw)this.set_progress_bw(opt.progress_bw);E.pool.push(this);this.zone_specific={};return this};zutil.inherits(E.Cdn,events.EventEmitter);E.Cdn.prototype.using=function(zone){var _this=this,zname=zone.CG("zone")||zone.id;var zctx=this.zone_specific[zname]=this.zone_specific[zname]||{};var obfuscate_links=zone.CG("cdn.send_reqs.obfuscate_links",[]);return zctx.api=zctx.api||{is_head_unsupported:function(){return _this.head_unsupported||_this.is_origin()&&(zone.CG("cdn.send_reqs.origin.head_unsupported")||zone.CG("cdn.send_reqs.origin.auto_head_unsupported")||_this.hostname.search("brightcove")>-1)},is_ranges_unsupported:function(){return!_this.ranges_supported&&(_this.ranges_unsupported||_this.is_origin()&&(zone.CG("cdn.send_reqs.origin.ranges_unsupported")||zone.CG("cdn.send_reqs.origin.auto_ranges_unsupported")))},get_ws:function(){return zctx.ws},get_ws_stats:function(){return zctx.ws_stats},add_ws_listener:function(){if(!_this.is_hola()||_this.is_bootstrap()||typeof WebSocket!="function"){return}if(!zctx.ws){zctx.ws_stats={};zctx.ws=open_ws_listener(zone,_this,zctx.ws_stats,location.protocol)}zctx.ws_ref=(zctx.ws_ref||0)+1;return zctx.ws},remove_ws_listener:function(){if(!zctx.ws||--zctx.ws_ref)return;zctx.ws.close();zctx.ws.removeAllListeners();zctx.ws=zctx.ws.ws=zctx.ws_stats=undefined},send:function(cmd,route,data,cb,opt){if(typeof route=="function"){opt=data;cb=route;data=route=undefined}else if(typeof data=="function"){opt=cb;cb=data;data=undefined}opt=opt||{};route=assign(!util.is_zlxc?{ver:util.ver}:{},util.has_ext?{ext:true}:{},util.is_debug?{debug:true}:{},route);if(opt.fetch_blob){return void this.send_xhr(cmd,route,{response_type:"blob"},cb)}if(opt.ws_only||!opt.xhr_only){if(zctx.ws&&zctx.ws.is_ready())return this.send_ws(cmd,route,data,cb);else if(opt.ws_only)return}this.send_xhr("cmd/"+cmd,route,{data:data},cb)},send_ws:function(cmd,route,data,cb){var ts=util.date_monotonic();if(zctx.ws){zctx.ws.send(cmd,route,data,function(res){if(!cb)return;cb({cmd:cmd,data:data||{},res:res&&!res.err&&!res.error?res:null,description:res&&res.description,err:res?res.err||res.error:"fail",cdn:_this,status:res&&res.status,elapsed:util.date_monotonic()-ts})})}else if(cb){cb({cdn:_this,cmd:cmd,data:data||{},err:"no open websocket"})}},send_xhr:function(cmd,route,opt,cb){cb=cb||function(){};var __this=this,ts=util.date_monotonic();var url=route.final_url;if(!url){var qs=assign({customer:zone.CG("customer")||util.conf.customer,zone:zone.CG("zone")},route);if(qs.url&&typeof btoa=="function"&&obfuscate_links.includes(cmd)){qs.url=btoa(qs.url);qs.obf=true}url="/"+cmd+"?"+zescape.qs(qs)}__this.send_xhr_raw(url,opt,function(res){var ret={cmd:cmd,opt:opt.data||{},res:res&&res.res,err:res?res.err:"fail",status:res&&res.status,cdn:zutil.is_mocha()?undefined:_this,elapsed:zutil.is_mocha()?0:util.date_monotonic()-ts,description:res&&res.description};cb(ret)})},send_xhr_raw:function(url,opt,cb){opt=opt||{};var protocol=zone.CG("loader.https_xhr_only")?"https:":util.protocol;var host=protocol=="https:"?_this.hostname:_this.host;var _opt={url:protocol+"//"+host+url,data:opt.data,response_type:opt.response_type||"json",timeout:opt.timeout||6e4,no_content_type:true};var _cb=function(res){var data=res&&res.status==200?{url:url,res:res.data,status:200}:{status:res&&res.status,err:res&&res.err||"empty_response",description:res&&res.description};if(opt.cb)opt.cb(data);cb(data)};ajax.fetch_bin(_opt,_cb)},uninit:function(){this.remove_ws_listener();if(!zctx.ws)_this.zone_specific[zname]=undefined}}};E.Cdn.prototype.get_progress_bw=function(){return this.progress_bw.bw};E.Cdn.prototype.set_progress_bw=function(bw){if(!bw)return;this.progress_bw.samples.push(bw);if(this.progress_bw.samples.length>this.progress_bw.max)this.progress_bw.samples.splice(0,Math.round(this.progress_bw.max/2));var sum=0;this.progress_bw.samples.forEach(function(a){sum+=a});this.progress_bw.bw=Math.round(sum/this.progress_bw.samples.length)};E.Cdn.prototype.is_hola=function(){return this.owner=="hola"};E.Cdn.prototype.is_origin=function(){return this.origin};E.Cdn.prototype.is_master=function(){return this.master};E.Cdn.prototype.is_single=function(){return this.role=="single_copy"};E.Cdn.prototype.is_fast=function(){return this.role=="fast"};E.Cdn.prototype.is_dedicated_fast=function(){return["fast","efast"].includes(this.type)};E.Cdn.prototype.is_efast=function(){return this.type=="efast"};E.Cdn.prototype.is_bootstrap=function(){return this.role=="bootstrap"};E.Cdn.prototype.is_usable=function(){return this.is_enabled()&&!this.is_disconnected()&&!this.is_busy()};E.Cdn.prototype.is_enabled=function(){return this.enabled};E.Cdn.prototype.is_failed=function(){return(!this.success_ts||this.fail_ts>this.success_ts)&&this.fail_ts&&util.date_monotonic()-this.fail_ts<10*ms_min?this.fail:0};E.Cdn.prototype.enable=function(){this.enabled=1};E.Cdn.prototype.disable=function(){this.enabled=0};E.Cdn.prototype.update_from_hdrs=function(hdrs){hdrs=hdrs||[];this.update_cache_type(hdrs["x-cache"]);this.update_hola_resp(hdrs["x-hola-resp"])};E.Cdn.prototype.update_hola_resp=function(s){var resp=zescape.parse.http_words(s);for(var i=0;i<resp.length;i++){if(resp[i][0]=="ttfb")this.ttfb=resp[i][1];else if(resp[i][0]=="cache")this.update_cache_type(resp[i][1]);else if(resp[i][0]=="age")this.age=resp[i][1]}};E.Cdn.prototype.need_bw_info=function(){return!this.ms_hdrs||this.is_bw_from_cache()};E.Cdn.prototype.is_bw_from_cache=function(){return this.cache_flag&&this.cache[this.cache_flag].from_cache};E.Cdn.prototype.update_cache_type=function(cache_flag){cache_flag=cache_flag?cache_flag.toLowerCase():"hit";if(!["hit","miss"].includes(cache_flag)||cache_flag==this.cache_flag)return;var prev=this.cache_flag;this.cache_flag=cache_flag;if(!prev)return;if(!this.bpms||this.cache[this.cache_flag].bpms)this.bpms=this.cache[this.cache_flag].bpms;if(!this.ms_hdrs||this.cache[this.cache_flag].ms_hdrs)this.ms_hdrs=this.cache[this.cache_flag].ms_hdrs};E.Cdn.prototype.rate=function(sz){return Math.round((sz||512*KB)/this.bpms)};E.Cdn.prototype.set_error=function(err){if(err==ERR.head_unsupported)this.head_unsupported=true;else if(err==ERR.ranges_unsupported)this.ranges_unsupported=true};E.Cdn.prototype.can_get=function(sz,sec,opt){opt=opt||{};var ms=sec*ms_sec;return(!this.bpms||opt.by_hdrs)&&this.ms_hdrs&&this.ms_hdrs<=ms*.4?true:this.calc_ttc(sz)+500<=ms};E.Cdn.prototype.calc_ttc=function(sz){return!sz?this.ms_hdrs||Infinity:this.bpms?Math.round(sz/this.bpms):Infinity};E.Cdn.prototype.bps=function(){return ms_sec*this.bpms};E.Cdn.prototype.compare=function(cdn2,opt){var _this=this;function log(s,r){if(opt.log)opt.log.info(s+(r?" ret "+r:""));return r}function logt(s){return log(_this.id+" "+s,-1)}function logo(s){return log(cdn2.id+" "+s,1)}log("compare "+this.id+" to "+(cdn2?cdn2.id:"unknown")+" sz "+opt.sz+" sec "+opt.sec);if(!cdn2)return logt("cdn2 missing ");var can_get=opt.sz&&opt.sec?!opt.fastest||this.bpms?this.can_get(opt.sz,opt.sec):false:true;var can_get2=opt.sz&&opt.sec?!opt.fastest||cdn2.bpms?cdn2.can_get(opt.sz,opt.sec):false:true;var bpms=this.bpms,bpms2=cdn2.bpms,hdrs=this.ms_hdrs;var hdrs2=cdn2.ms_hdrs;if(can_get!=can_get2){return can_get?logt("can get "+bpms+">"+bpms2):logo("can get "+bpms2+">"+bpms)}if(this.bpms&&!this.is_bw_from_cache()&&(cdn2.is_bw_from_cache()||!cdn2.bpms)&&can_get){return logt("bpms "+this.bpms+" cdn2 from cache or no bpms")}if((!this.bpms||this.is_bw_from_cache())&&cdn2.bpms&&!cdn2.is_bw_from_cache()&&can_get2){return logo("bpms "+cdn2.bpms+" "+this.id+" from cache or no bpms")}if(this.host==cdn2.host||!bpms&&!bpms2&&!hdrs&&!hdrs2)return log("identical",0);if(!hdrs||!hdrs2)return!hdrs?logo("hdrs "+hdrs2):logt("hdrs "+hdrs);if(!bpms||!bpms2){return bpms&&can_get?logt("bpms "+bpms+" and can get"):bpms2&&can_get2?logo("bpms "+bpms2+" and can get"):hdrs==hdrs2?bpms?logt("same hdrs and bpms "+bpms):bpms2?logo("same hdrs and bpms "+bpms2):log("hdrs identical",0):log("hdrs "+hdrs+" hdrs2 "+hdrs2,hdrs-hdrs2*(opt.ratio||1))}return Math.round(opt.rate?log("rate comparison "+this.rate(opt.sz)+" "+cdn2.rate(opt.sz),this.rate(opt.sz)-cdn2.rate(opt.sz)*(opt.ratio||1)):opt.bps?log("bps comparison "+this.bps()+" "+cdn2.bps(),cdn2.bps()-this.bps()*(opt.ratio||1)):log("bpms comparison "+bpms+" "+cdn2.bpms,cdn2.bpms-this.bpms))};E.Cdn.prototype.compare_rate=function(cdn2,opt){return this.compare(cdn2,assign(opt||{},{rate:true}))};E.Cdn.prototype.compare_bps=function(cdn2,opt){return this.compare(cdn2,assign(opt||{},{bps:true}))};E.Cdn.prototype.set_busy=function(){this.busy++;this.busy_ts=util.date_monotonic();this.busy_wait=Math.min(this.busy_wait?this.busy_wait*2:2e3,64e3);this.emit("busy")};E.Cdn.prototype.disconnected=function(){this.disconnect++;this.disconnect_ts=util.date_monotonic();this.disconnect_wait=Math.min(this.disconnect_wait?this.disconnect_wait*2:2e3,64e3);this.emit("disconnect")};E.Cdn.prototype.failed=function(err,adaptive){var disable=err==ERR.ranges_unsupported&&!adaptive||this.is_single();if(this.is_failed()||disable)this.enabled=0;this.fail++;this.fail_ts=util.date_monotonic();this.emit("failed")};function open_ws_listener(zone,cdn,ws_stats,protocol){if(!ws_stats.ts){assign(ws_stats,{pending:1,failed:0,connected:0,to_https:0,lag:0,ts:new Date})}var ws=new util.ws(protocol=="https:"?cdn.hostname:cdn.host,{path:"ws_client",customer:zone.CG("customer"),zone:zone.CG("zone"),minor:true,protocol:protocol=="https:"?"wss":"ws",timeout:protocol=="http:",log:zone.log});if(!ws){ws_stats.pending=0;ws_stats.failed=1;return ws}ws.on("message",function(data){cdn.emit("message",data);cdn.emit("message."+data.cmd,data)});ws.on("open",function(){ws_stats.pending=0;ws_stats.connected=1;ws_stats.lag=Date.now()-ws_stats.ts});if(protocol=="http:"){ws.on("error",function(){ws_stats.to_https=1;open_ws_listener(zone,cdn,ws_stats,"https:")})}if(protocol=="https:"){ws.on("error",function(){ws_stats.pending=0;ws_stats.failed=1})}return ws}E.Cdn.prototype.on_too_slow=function(cache_hit){this.learning.too_slow=this.learning.too_slow||0;this.learning.too_slow++;if(!cache_hit)return;var ip=util.geoip.ip;if(ip&&!this.split[ip]){this.learning.split=this.learning.split||{};if(this.learning.split[ip]=="testing")this.split[ip]="failed";else this.learning.split[ip]="testing"}};E.Cdn.prototype.is_busy=function(){return ms_since(this.busy_ts)<=this.busy_wait};E.Cdn.prototype.is_disconnected=function(){return ms_since(this.disconnect_ts)<=this.disconnect_wait};E.Cdn.prototype.ttfb=function(){return this.ttfb/this.ttfb_n};E.Cdn.prototype.set_ttfb=function(ttfb){this.ttfb_n++;this.ttfb+=ttfb};E.Cdn.prototype.update_stats=function(opt){if(!opt.ms_hdrs&&this.ms_hdrs){if(opt.elapsed<this.ms_hdrs)return;opt.ms_hdrs=opt.elapsed}opt.ms=opt.ms||opt.elapsed-opt.ms_hdrs;this.update_stream_stats(opt);if(!opt.final)return;this.update_cache_stats(opt);if(!opt.error||opt.rate&&this.is_origin()){this.success++;this.success_ts=util.date_monotonic()}if(!opt.error&&opt.range)this.ranges_supported++;this.bytes+=opt.sz;if(opt.rate)this.rate_bytes=(this.rate_bytes||0)+opt.sz};E.Cdn.prototype.update_stream_stats=function(opt){var ms_hdrs=opt.ms_hdrs,ms=opt.ms,sz=opt.sz,elapsed=opt.elapsed;if(!ms_hdrs&&(!this.ms_hdrs||elapsed<=this.ms_hdrs))return;var replace=opt.replace||this.ms_hdrs<ms_hdrs/2||this.ms_hdrs>ms_hdrs*2;var overwrite=!this.ms_hdrs||this.is_bw_from_cache()||replace;var new_ms_hdrs=overwrite?ms_hdrs:Math.round((this.ms_hdrs+ms_hdrs)/2);if(opt.final)this.ms_hdrs=new_ms_hdrs;if(opt.final&&!sz)return this.bpms=overwrite?0:this.bpms;if(!sz&&(!this.bpms||!ms_hdrs)||sz<64*KB&&opt.ttc<Infinity&&elapsed<opt.ttc/2){return}this.ms_hdrs=new_ms_hdrs;var bpms=sz/(ms+ms_hdrs);replace=replace||this.bpms<bpms/2||this.bpms>bpms*2;overwrite=!this.bpms||this.is_bw_from_cache()||replace;this.bpms=Math.round(overwrite?bpms:(this.bpms+bpms)/2)};E.Cdn.prototype.update_cache_stats=function(opt){var ms_hdrs=opt.ms_hdrs,ms=opt.ms,sz=opt.sz,elapsed=opt.elapsed;if(!ms_hdrs&&(!this.ms_hdrs||elapsed<=this.ms_hdrs))return;if(opt.rate&&!ms_hdrs||!opt.rate&&(!sz&&(!this.bpms||!ms_hdrs)||sz<64*KB&&elapsed<opt.ttc/2||ms_hdrs==elapsed)){return}var set=this.cache[this.cache_flag||"hit"],bpms=sz/(ms+ms_hdrs);var prev_rate=Math.round(512*KB/set.bpms);var replace=opt.replace||this.ms_hdrs<ms_hdrs/2||this.ms_hdrs>ms_hdrs*2;set.ms_hdrs=!set.ms_hdrs?ms_hdrs:Math.round((set.ms_hdrs*2+ms_hdrs)/3);if(opt.rate)return this.bpms=replace?0:this.bpms;set.from_cache=undefined;var new_rate=Math.round(512*KB/bpms);if(prev_rate<=new_rate*(opt.rate_decrease||.7))this.emit("rate_decrease",this,prev_rate/new_rate);replace=replace||this.bpms<bpms/2||this.bpms>bpms*2;set.bpms=Math.round(!set.bpms||replace?bpms:(set.bpms*2+bpms)/3);set.bytes=(set.bytes||0)+sz};E.Cdn_list=function Cdn_list(opt){if(!(this instanceof E.Cdn_list))return new E.Cdn_list(opt);var _this=this;opt=opt||{};this.arr=[];this.save_to=opt.save_to;this.length=0;this.zone=opt.zone;this.zperr=opt.zone.perr_get();this.log=opt.zone.log_get().set_module("cdnlist");this.on_cdn_message=function(data){var cdn=this;_this.emit("message",cdn,data);_this.emit("message."+data.cmd,cdn,data)};this.add(opt.cdns,opt.role);return this};zutil.inherits(E.Cdn_list,events.EventEmitter);E.Cdn_list.prototype.find=function(func,a){for(var i=0;i<this.arr.length;i++){if(func.call(a,this.arr[i]))return this.arr[i]}};E.Cdn_list.prototype.count=function(cond){var count=0;for(var i=0;i<this.arr.length;i++)count+=!!cond(this.arr[i]);return count};E.Cdn_list.prototype.add_ws_listener=function(){this.arr.forEach(function(cdn){cdn.using(this.zone).add_ws_listener()},this)};E.Cdn_list.prototype.remove_ws_listener=function(){this.arr.forEach(function(cdn){cdn.using(this.zone).remove_ws_listener()},this)};E.Cdn_list.prototype.some=function(func,a){return this.arr.some(func,a)};E.Cdn_list.prototype.every=function(func,a){return this.arr.every(func,a)};E.Cdn_list.prototype.forEach=function(func,a){this.arr.forEach(func,a)};E.Cdn_list.prototype.filter=function(func,a){return this.arr.filter(func,a)};E.Cdn_list.prototype.add_origin=function(cdn){this.add([{host:cdn.host,cost:cdn.cost||this.zone.CG("cdn.send_reqs.origin.cost")||5,origin:true}]);return this.get_by_host(cdn.host)};E.Cdn_list.prototype.send=function(cmd,route,data,cb,opt){opt=opt||{};var timer=0,timers=[],done,resps=0,_this=this;function _cb(res){resps++;if(!res||res.err||done)return;done=true;timers.forEach(function(t){clearTimeout(t)});if(cb)cb(res&&res.timeout?{err:"timeout"}:res)}this.forEach(function(cdn,index){timers.push(setTimeout(function(){if(opt.on_req)opt.on_req(index);cdn.using(_this.zone).send(cmd,route,data,function(res){if(opt.on_res)opt.on_res(index,res);_cb(res)},opt)},timer));timer+=opt.gap_ms===undefined?300:opt.gap_ms});timers.push(setTimeout(_cb.bind(null,{timeout:true}),opt.timeout||5e3))};E.Cdn_list.prototype.send_xhr=function(cmd,route,opt,cb){this.forEach(function(cdn){cdn.using(this.zone).send_xhr(cmd,route,opt,cb)},this)};E.Cdn_list.prototype.has_usable=function(){return this.arr.some(function(cdn){return cdn.is_enabled()})};E.Cdn_list.prototype.has=function(host){return!!this.get_by_host(host)};E.Cdn_list.prototype.can_get_by_hola=function(sz,sec,allow_fast){return this.can_get(sz,sec,function(){return(allow_fast||!this.is_fast())&&this.is_hola()})};E.Cdn_list.prototype.can_get_by_origin=function(sz,sec){return this.can_get(sz,sec,function(){return this.is_origin()})};E.Cdn_list.prototype.can_get=function(sz,sec,filter_fn){return this.arr.some(function(cdn){return!filter_fn||filter_fn.apply(cdn)?cdn.can_get(sz,sec):false})};E.Cdn_list.prototype.stats=function(opt){var stats=[];opt=opt||{};for(var i=0;i<this.arr.length;i++){var cdn=this.arr[i];var reset_snapshot=this.reset_snapshot&&this.reset_snapshot.cdn[i];var cdn_stats={bpms:cdn.bpms,ms_hdrs:cdn.ms_hdrs,bytes:cdn.bytes,fail:cdn.fail,enabled:cdn.enabled,success:cdn.success,cost:cdn.cost,delayed:cdn.delayed,name:cdn.name,owner:cdn.owner,cache_hit:cdn.cache.hit.bytes,cache_miss:cdn.cache.miss.bytes,aborted:cdn.aborted,aborted_bytes:cdn.aborted_bytes,host:cdn.host,bps:cdn.bps(),role:cdn.role,country:cdn.country,age:cdn.age,too_slow:cdn.learning.too_slow};if(!opt.from_start&&reset_snapshot)cdn_stats=reset_snapshot.diff(cdn_stats);stats.push(cdn_stats)}return stats};E.Cdn_list.prototype.ws_stats=function(opt){var ret={connected:0,pending:0,failed:0,lag:0};opt=opt||{};for(var i=0;i<this.arr.length;i++){var ws_stats=this.arr[i].using(this.zone).get_ws_stats();if(!ws_stats)continue;ret.connected+=ws_stats.connected;ret.pending+=ws_stats.pending;ret.failed+=ws_stats.failed;ret.lag+=ws_stats.lag}if(!opt.from_start&&this.reset_snapshot)ret=this.reset_snapshot.ws.diff(ret);return ret};E.Cdn_list.prototype.reset_stats=function(){this.reset_snapshot={cdn:this.stats({from_start:true}).map(function(cdn_stats){return util.data_snapshot(cdn_stats,["bytes","rate_bytes","cache_hit","cache_miss","cache_revalidate","aborted","aborted_bytes","too_slow"])}),ws:util.data_snapshot(this.ws_stats({from_start:true}))}};E.Cdn_list.prototype.add=function(cdns,role){if(!cdns)return;var _this=this;function add_cdn(opt){var host=opt.host.toLowerCase();var c=_this.get_by_host(host);if(c){if(c.is_fast()&&opt.role!="fast"){_this.log.debug("changed cdn cw"+c.uid+" role "+c.role+"->"+opt.role);c.role=opt.role;c.cost=opt.cost}c.alt_fast=c.is_single()&&opt.role=="fast";c.master=c.master||opt.master;return}var cdn=E.pool.find(function(c){return c.host==host});if(!cdn){var uid=opt.uid||E.next_uid;opt.req_uid=opt.req_uid||(cdn?cdn.req_uid:null);assign(opt,{uid:uid,host:host});cdn=new E.Cdn(assign({role:role,log:_this.log},opt));if(!opt.uid||opt.uid==E.next_uid)E.next_uid++}else if(_this.save_to!=cdn.save_to){cdn.role=opt.role||role;cdn.master=cdn.master||opt.master}cdn.on("message",_this.on_cdn_message);cdn.using(_this.zone).add_ws_listener();_this.update_from_cache(cdn);_this.arr.push(cdn);var cdn_str=JSON.stringify(opt,function(k,v){if(k!="ws")return v});_this.log.debug("added cdn "+cdn_str+" bw "+cdn.get_progress_bw()+" uid "+cdn.uid+" cost "+cdn.cost);_this.emit("cdn_added",cdn)}var src=Array.isArray(cdns)?cdns:cdns.arr;for(var i=0;i<src.length;i++)add_cdn(src[i]);this.arr.sort(function(a,b){return a.cost-b.cost});this.length=this.arr.length};E.Cdn_list.prototype.have_best_cdn_candidates=function(){var candidates=0;this.arr.forEach(function(cdn){if(cdn.bpms&&cdn.is_enabled())candidates++},this);return candidates};E.Cdn_list.prototype.get_lowcost_cdn=function(sz,sec,allow_fast,replace){var lowest,usable,pending,disc_cdn,debug,_this=this;if(zutil.is_mocha()&&this.jtest_lowcost_cdn){var cdn=this.get_by_uid(this.jtest_lowcost_cdn);return{lowcost:cdn,lowcost_usable:cdn}}function log(s,r){if(debug){_this.log.info(s+(r?" ret "+(typeof r=="object"?"json":r):""))}return r}this.arr.forEach(function(cdn){log("checking cdn "+cdn.id+" can_get sz "+sz+" sec "+sec+" "+cdn.can_get(sz,sec)+" cost "+cdn.cost+" bpms "+cdn.bpms+" ms_hdrs "+cdn.ms_hdrs);if(this.zone.CG("cdn.send_reqs.origin_only")&&!cdn.is_origin())return;if(!cdn.is_enabled()||!allow_fast&&cdn.is_fast())return log(cdn.id+" not usable");cdn=this.get_replacement(cdn,replace);if((!usable||cdn.cost<usable.cost||cdn.cost==usable.cost&&cdn.compare_rate(usable,{log:debug&&this.log})<0)&&cdn.can_get(sz,sec)){if(cdn.is_usable()){log("chosen "+cdn.id+" type usable");usable=cdn}else if(ms_since(cdn.disconnect_ts)>2e3&&ms_since(cdn.busy_ts)>2e3&&(!disc_cdn||cdn.compare_rate(disc_cdn,{sz:sz,sec:sec,log:debug&&this.log})<0)){log("chosen "+cdn.id+" type disconnected");disc_cdn=cdn}}if((!pending||cdn.cost<pending.cost)&&!cdn.bpms)pending=cdn;if(lowest&&lowest.cost<cdn.cost)return void log("higher cost than lowest "+lowest.id);if(!lowest||cdn.cost<lowest.cost||cdn.compare_rate(lowest,{log:debug&&this.log})<0){log("chosen "+cdn.id+" type lowest");lowest=cdn}},this);return log("choice lowest "+(lowest?lowest.id:"none")+" lowcost_usable "+(usable||disc_cdn?(usable||disc_cdn).id:"none")+" pending "+(pending?pending.id:"none"),{lowcost:lowest?lowest.replaced||lowest:null,lowcost_usable:usable?usable.replaced||usable:disc_cdn?disc_cdn.replaced||disc_cdn:null,pending:pending?pending.replaced||pending:null})};E.Cdn_list.prototype.get_best_cdn_bw=function(opt){var best_cdn=this.get_best_cdn("get_best_cdn_bw",opt);return best_cdn?best_cdn.bps():0};E.Cdn_list.prototype.get_best_cdn_bw_bits=function(opt){return this.get_best_cdn_bw(opt)*8};E.Cdn_list.prototype.is_origin_disconnected=function(opt){return this.every(function(cdn){return!cdn.is_origin()||cdn.is_disconnected()})};E.Cdn_list.prototype.hola_fast_usable=function(opt){return this.hola_usable({fast:true})};E.Cdn_list.prototype.hola_single_usable=function(opt){return this.hola_usable({single:true})};E.Cdn_list.prototype.hola_usable=function(opt){opt=opt||{};var count=0;this.arr.forEach(function(cdn){count+=cdn.is_hola()&&cdn.is_usable()&&(!opt.fast&&(!opt.single||cdn.is_single()))&&(!opt.single&&(!opt.fast||cdn.is_fast()))});return count};E.Cdn_list.prototype.count_single_busy=function(opt){return this.count_busy({single:true})};E.Cdn_list.prototype.count_busy=function(opt){opt=opt||{};var count=0;this.arr.forEach(function(cdn){count+=cdn.is_hola()&&cdn.is_enabled()&&cdn.is_busy()&&(!opt.single||cdn.is_single())});return count};E.Cdn_list.prototype.is_busy=function(opt){return this.every(function(cdn){return!cdn.is_enabled()||!cdn.is_hola()||cdn.is_busy()})};E.Cdn_list.prototype.is_disconnected=function(opt){return this.every(function(cdn){return cdn.is_disconnected()})};E.Cdn_list.prototype.is_disconnected_on_start=function(opt){return this.every(function(cdn){return!cdn.bytes&&cdn.is_disconnected()})};E.Cdn_list.prototype.get_replacement=function(cdn,replace){var r;if(!replace||!(r=replace.find(function(c){return c.id==cdn.id})))return cdn;var _cdn=zutil.clone_deep(cdn);_cdn.bpms=r.bpms;_cdn.ms_hdrs=r.ms_hdrs;_cdn.replaced=cdn;return _cdn};E.Cdn_list.prototype.get_best_cdn=function(caller,opt){var debug,log=debug?this.log.info:function(){};opt=opt||{};log("get_best_cdn caller "+caller+" opt "+JSON.stringify(opt));if(zutil.is_mocha()&&this.jtest_best_cdn){var cdn=this.get_by_uid(this.jtest_best_cdn);log("chose "+cdn.id+" by jtest_best_cdn");return cdn}var best_cdn,disc_cdn;this.arr.forEach(function(cdn){cdn=this.get_replacement(cdn,opt.replace);var no_ranges=cdn.using(this.zone).is_ranges_unsupported();var sz=no_ranges?opt.fs||opt.sz:opt.sz;log("test cdn "+cdn.id+" usable "+cdn.is_enabled()+" hdrs "+cdn.ms_hdrs+" fast "+cdn.is_fast()+" prev_bpms "+cdn.prev_bpms+" bpms "+cdn.bpms+" best "+(best_cdn&&best_cdn.id)+" ttc "+cdn.calc_ttc(sz)+" for sec "+opt.sec+" sz "+sz);if(this.zone.CG("cdn.send_reqs.origin_only")&&!cdn.is_origin())return;if(opt.ranges_supported&&no_ranges)return;if(cdn.ms_hdrs&&cdn.is_enabled()&&(opt.allow_fast||!cdn.is_fast())&&(!opt.no_cache||!cdn.is_bw_from_cache())&&(!best_cdn||best_cdn.is_failed()>cdn.is_failed()||best_cdn.is_failed()==cdn.is_failed()&&cdn.compare_rate(best_cdn,{sz:sz,sec:opt.sec,log:(debug||opt.debug)&&this.log})<0)){log("chose "+cdn.id+" disconnected "+cdn.is_disconnected());if(cdn.is_usable())best_cdn=cdn;else if(ms_since(cdn.disconnect_ts)>2e3&&ms_since(cdn.busy_ts)>2e3&&(!disc_cdn||cdn.compare_rate(disc_cdn,{sz:sz,sec:opt.sec,log:(debug||opt.debug)&&this.log})<0)){disc_cdn=cdn}}},this);best_cdn=best_cdn||disc_cdn;if(this.prev_best_cdn!==best_cdn){this.emit("new_best_cdn",best_cdn);this.log.debug("new best_cdn "+(best_cdn?best_cdn.id:"none")+" bpms "+(best_cdn?best_cdn.bpms:0)+" hdrs "+(best_cdn?best_cdn.ms_hdrs:0)+" rate "+(best_cdn?best_cdn.rate():0)+" caller "+caller)}this.prev_best_cdn=best_cdn;return best_cdn?best_cdn.replaced||best_cdn:null};E.Cdn_list.prototype.get_by_id=function(id){return this.find(function(cdn){return cdn.id==id})};E.Cdn_list.prototype.get_by_host=function(host){return this.find(function(cdn){return cdn.host==host||cdn.redir_host==host||cdn.name==host||cdn.hostname==host})};E.Cdn_list.prototype.get_by_uid=function(uid){return this.find(function(cdn){return cdn.uid==uid})};E.Cdn_list.prototype.get_origin=function(){return this.find(function(cdn){return cdn.origin})};E.Cdn_list.prototype.get_master=function(){return this.find(function(cdn){return cdn.master})};E.Cdn_list.prototype.read_storage=function(){if(!this.save_to)return{cdns:{}};var data=storage.db.get_json(this.save_to);if(!data||data.version!=E.version){this.log.debug("cdn cache "+(!data?"not found":"version mismatch "+data.version+"!="+E.version));return{cdns:{}}}return data};E.Cdn_list.prototype.update_from_cache=function(cdn){if(!this.cache)this.cache=this.read_storage();cdn.cache=this.cache.cdns[cdn.host]||{success_ts:0,hit:{bpms:0,ms_hdrs:0,bytes:0},miss:{bpms:0,ms_hdrs:0,bytes:0},delayed:0,success:0};cdn.cache.hit=cdn.cache.hit||{};cdn.cache.miss=cdn.cache.miss||{};cdn.save_to=this.save_to;if(cdn.success_ts>=cdn.cache.success_ts)return;cdn.cache_flag=cdn.cache.hit.bpms||!cdn.cache.miss.bpms?"hit":"miss";var cache=cdn.cache[cdn.cache_flag];cdn.bpms=cache.bpms||cdn.bpms;cdn.ms_hdrs=cache.ms_hdrs||cdn.ms_hdrs;if(!zutil.is_mocha()||!util.jtest.snapshot)cdn.cache.hit.from_cache=cdn.cache.miss.from_cache=true;cdn.delayed=cdn.cache.delayed||cdn.delayed;cdn.success=cdn.cache.success||cdn.success;cdn.ranges_supported=cdn.cache.ranges_supported||cdn.ranges_supported;cdn.success_ts=cdn.cache.success_ts||cdn.success_ts;if(cdn.cache.progress_bw)cdn.set_progress_bw(cdn.cache.progress_bw)};E.Cdn_list.prototype.to_json=function(){var json={};for(var i=0;i<this.arr.length;i++){var cdn=this.arr[i];json[cdn.host]={fail:cdn.fail,hit:zutil.clone_deep(cdn.cache.hit||{}),miss:zutil.clone_deep(cdn.cache.miss||{}),delayed:cdn.delayed,success:cdn.success,cost:cdn.cost,role:cdn.role,origin:cdn.origin,owner:cdn.owner,success_ts:cdn.success_ts,ttfb_n:cdn.ttfb_n,progress_bw:cdn.get_progress_bw(),fail_ts:cdn.fail_ts,ttfb:cdn.ttfb,ranges_supported:cdn.ranges_supported}}return json};E.Cdn_list.prototype.save=function(opt){if(!this.save_to)return;opt=opt||{};var now=util.date_monotonic(),cdn;if(!opt.close&&now-this.last_save<=5*ms_sec)return;var data=this.read_storage();assign(data.cdns,this.to_json());try{while(JSON.stringify(data)>this.max_size){var oldest;for(cdn in data.cdns){if(!oldest||data[cdn].success_ts<data[oldest].success_ts)oldest=cdn}if(oldest)delete this.data.cdns[cdn]}data.version=E.version;storage.db.set_json(this.save_to,data);this.last_save=now;this.log.debug("saved "+JSON.stringify(data))}catch(e){this.zperr({id:"cdn_cache_err_failed_save",err:e});storage.db.clr(this.save_to)}};E.Cdn_list.prototype.uninit=function(){this.forEach(function(cdn){cdn.off("message",this.on_cdn_message);cdn.using(this.zone).uninit()},this)};E.init=function(bootstraps,loader,all_agents,no_geoip){E.all_agents=typeof all_agents!="object"?{}:all_agents;E.all_agents.get=function(host){var ret,find=function(c){return c.host==host};if(this.single&&(ret=this.single.find(find))||this.fast&&(ret=this.fast.find(find))||this.efast&&(ret=this.efast.find(find))){ret.owner="hola";ret.role=["fast","efast"].includes(ret.type)?"fast":"single_copy"}return ret}.bind(E.all_agents);if(!bootstraps)return;for(var i=0;i<bootstraps.length;i++){bootstraps[i].owner="hola";bootstraps[i].cost=1}var zone=new _zone(loader,{loader:loader.loader_conf},"cdnlist");var bootstrap_cdns=bootstraps?new E.Cdn_list({cdns:bootstraps,zone:zone,role:"bootstrap"}):undefined;if(bootstrap_cdns)util.on("beforeunload",function(){bootstrap_cdns.uninit()});E.bootstraps=bootstrap_cdns;if(E.bootstraps&&!no_geoip&&(!util.geoip||!util.geoip.update||new Date(util.jdate_now())-new Date(util.geoip.update)>=12*ms_hour)){E.update_geoip()}};E.update_geoip=function(opt){var updated;E.bootstraps.add_ws_listener();E.bootstraps.send("get_geoip",function(e){if(e&&e.res&&!updated){cdn_util.set_geoip(e.res);E.bootstraps.emit("geoip_received",e.res);E.bootstraps.remove_ws_listener();updated=true}},opt)};E.uninit=function(){if(E.bootstraps)E.bootstraps.uninit();E.bootstraps=undefined};function geo_get_rad(p){if(!p.latitude&&!p.longitude)return;return{lat:p.latitude*Math.PI/180,"long":p.longitude*Math.PI/180}}function filter_efast(zone,shards){var res=[],efast=zone.CG("agent.efast","").toLowerCase().split(" ");shards=shards||[];if(efast[0]=="all")return shards;for(var i=0;i<shards.length;i++){var agent=shards[i];if(efast.includes(agent.country.toLowerCase()))res.push(agent)}return res}function get_dist(p1,p2){var a=Math.pow(Math.sin((p2.lat-p1.lat)/2),2)+Math.pow(Math.sin((p2.long-p1.long)/2),2)*Math.cos(p1.lat)*Math.cos(p2.lat);var dist=Math.floor(6371*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));return dist}function get_closest(shards,geoip,filter){var res=[];for(var i=0;i<shards.length;i++){var shard=shards[i];if(filter&&!filter(shard)||!shard.geo)continue;res.push(assign({dist:get_dist(shard.geo,geoip)},shard))}return res.sort(function(i,j){return i.dist-j.dist})}function whitelist_filter(zone){var wl=zone.CG("agent.whitelist");if(!wl)return;return function(shard){return wl.includes(shard.host)||wl.includes(shard.name)}}function hrw_rand(v){return 1103515245*(v|0)+12345|0}E.hrw_select=hrw_select;function hrw_select(shards,url,ntop,filter){var top=[],key_int=E.hrw_get(url);for(var i=0;i<shards.length;i++){var shard=shards[i];if(filter&&!filter(shard))continue;var rank=E.hrw_rank(shard.hrw,key_int);top.push(assign({rank:rank},shard))}return top.sort(function(i,j){return j.rank-i.rank}).slice(0,ntop)}function cache_url(zone,url){return util.video2cache(url,zone)}function page_url(zone,url){return util.page2cache(url,zone)}function read_i32(s){return parseInt(s.slice(0,2),16)|parseInt(s.slice(2,4),16)<<8|parseInt(s.slice(4,6),16)<<16|parseInt(s.slice(6,8),16)<<24}E.get_closest=function(zone,opt,cb){cb=cb||function(){};opt=opt||{};var wait_geoip=function(_cb){if(!E.bootstraps||util.geoip&&util.geoip.ip)return _cb();E.bootstraps.once("geoip_received",_cb)};wait_geoip(function(){var cdns=E.local_url2cdns(zone,E.all_agents,util.geoip,"fake.mp4",{
fast_limit:5});opt.ret=cdns&&cdns.fast&&cdns.fast.length?new E.Cdn_list({cdns:rand.rand_subset(cdns.fast,Math.min(cdns.fast.length,opt.fast_limit||1)),zone:zone,role:"fast"}):null;cb(opt.ret);if(opt.cb)opt.cb(opt.ret)})};E.get_domain_shards=function(zone,agents,domain,opt){var link_shard=zone.CG("agent.pages.link_shard",3);var num_fallbacks=zone.CG("agent.pages.num_fallbacks",2);var filter=whitelist_filter(zone);var shards=agents&&agents.single||[];var hrw_fn=opt.hrw_fn||hrw_select;var domain_shards=[],masters=[],shards_len;if(Array.isArray(shards)){if(filter)shards=shards.filter(filter);shards_len=shards.length}else{var shards_o={};for(var k in shards){var shard=shards[k];if(!filter||filter(shard))shards_o[k]=shard}shards=shards_o;shards_len=Object.keys(shards).length}for(var s=0;masters.length!==link_shard;s++){var d_shards=hrw_fn(shards,domain+":"+s,1+num_fallbacks);var m=d_shards[0],m_name=m&&(m.hostname||m.host||m.name);if(!m_name)break;if(masters.includes(m_name)&&shards_len>=link_shard)continue;domain_shards.push(d_shards);masters.push(m_name)}return domain_shards};E.hrw_get=function(url){var hash=md5(url);return{a:read_i32(hash.slice(0,8))|0,b:read_i32(hash.slice(8,16))|0}};E.hrw_rank=function(shard_md5_int,key_md5_int){var v=hrw_rand(shard_md5_int.a);v=hrw_rand(v+key_md5_int.a);v=hrw_rand(v+shard_md5_int.b);v=hrw_rand(v+key_md5_int.b);return v};E.page_domain=function(zone,url){if(zone.is_agent)return zone.page_domain(url);return util.page2domain(url)};E.page_item_url=function(zone,item,opt){if(zone.is_agent)return zone[item.type=="page"?"page_url":"cache_url"](item.url);if(item.type=="page")return page_url(zone,item.url);return cache_url(zone,item.url)};E.pages2cdns=function(zone,agents,links,opt){opt=opt||{};var domain_shards={},res={};for(var i=0;i<links.length;i++){var link=links[i],url=link.url;var domain=E.page_domain(zone,url);if(!domain)continue;var cache=E.page_item_url(zone,link,opt);var shards=domain_shards[domain]||(domain_shards[domain]=E.get_domain_shards(zone,agents,domain,opt));res[url]=shards[hash.hash_string(cache)%shards.length]}return res};E.local_url2cdns=function(zone,agents,_geoip,_url,opt){opt=opt||{};if(zutil.is_mocha()&&util.jtest&&util.jtest.local_url2cdns){util.jtest.local_url2cdns.extra=util.jtest.extra_singles;return util.jtest.local_url2cdns}if(!agents||(!agents.single||!agents.single.length)&&(!agents.fast||!agents.fast.length)&&(!agents.efast||!agents.efast.length)){return}var res={single:[]};var url=cache_url(zone,_url);var geoip=_geoip&&geo_get_rad(_geoip);var fast_limit=opt.fast_limit||zone.CG("agent.select.fast.limit",2);var filter=whitelist_filter(zone);var s_shards=agents.single||[];var f_shards=[].concat(agents.single||[],agents.fast||[],filter_efast(zone,agents.efast));if(opt.fast_as_single||zone.CG("agent.select.allow_fast_as_single"))s_shards=s_shards.concat(f_shards);var single_limit=opt.single_limit||zone.CG("agent.select.single.limit",5);res.extra=hrw_select(s_shards,url,Math.max(single_limit,opt.extra_limit||zone.CG("agent.select.single.extra_limit",20)),filter);res.single=res.extra.splice(0,single_limit);if(res.single.length){res.single[0]=assign({master:true},res.single[0]);res.master=res.single[0]}if(geoip)res.fast=get_closest(f_shards,geoip,filter).slice(0,fast_limit);return res};E.get_fast_cdns=function(opt){return new E.Cdn_list({cdns:E.pool.filter(function(c){return!opt.dedicated&&c.is_fast()||c.is_dedicated_fast()}),zone:opt.zone})};return E})})();
define("/svc/cdn/pub/load_perf.js",["/svc/cdn/pub/util.js"],function(util){var E={};E.global_events=[];E.zone_events={};E.LOG_THRESHOLD=50;E.init=function(on){E.on=!!on;E.last=util.date_monotonic()};E.enable=function(){E.on=true};E.disable=function(){E.on=false};E.enabled=function(){return E.on};E.clear=function(){E.gloval_events=[];E.zone_events={}};E.push=function(name,zone,report){if(!E.on)return;var now=util.date_monotonic(),diff=now-E.last;var event={name:name,ts:Math.round(now),elapsed:Math.round(diff),report:!!report};E.last=now;if(!zone)return void E.global_events.push(event);E.zone_events[zone.id]=E.zone_events[zone.id]||[];E.zone_events[zone.id].push(event)};E.timeline=function(zone){if(!zone)return E.global_events;var a=E.global_events,b=E.zone_events[zone.id]||[];var al=a.length,bl=b.length,rl=al+bl,res=new Array(rl);for(var i=0,j=0,k=0;k<rl;k++){res[k]=j>=bl||i<al&&a[i].ts<=b[j].ts?a[i++]:b[j++];res[k].elapsed=k>0?res[k].ts-res[k-1].ts:res[k].elapsed}return res};E.timeline_to_str=function(zone,all){var tl=E.timeline(zone),tr=E.LOG_THRESHOLD;function ev2str(e){return e.name+" "+e.ts+"ms +"+e.elapsed+"ms"}tl=all?tl:tl.filter(function(e,i){return e.elapsed>=tr||e.report||i<tl.length-1&&(tl[i+1].elapsed>=tr||tl[i+1].report)});return tl.map(function(e){return ev2str(e)}).join("\n")};return E});
define("/svc/cdn/pub/adaptive.js",{__stub:1});
define("/svc/cdn/pub/progressive.js",{__stub:1});
define("/svc/cdn/pub/unittest.js",{__stub:1});
define("/svc/cdn/pub/req.js",{__stub:1});
define("/svc/cdn/pub/stream.js",{__stub:1});
define("/svc/cdn/pub/aggregator.js",{__stub:1});
define("/svc/cdn/pub/hap_util.js",{__stub:1});
define("/svc/cdn/pub/hola_adaptive.js",{__stub:1});


define("/svc/cdn/pub/mp4.js",{__stub:1});
define("/svc/cdn/pub/webm.js",{__stub:1});
define("/svc/cdn/pub/cdn.js",{__stub:1});

define("/svc/cdn/pub/timeline.js",{__stub:1});
!function(t,e){"function"==typeof define&&define.amd?define("cash",e):"undefined"!=typeof exports?module.exports=e():t.cash=t.$=e()}(this,function(){function t(t,e){e=e||A;var n=q.test(t)?e.getElementsByClassName(t.slice(1)):W.test(t)?e.getElementsByTagName(t):e.querySelectorAll(t);return n}function e(t){if(!w){w=A.implementation.createHTMLDocument("");var e=w.createElement("base");e.href=A.location.href;try{A.domain&&w.domain!==A.domain&&(w.domain=A.domain)}catch(n){}w.head.appendChild(e)}try{var r;if((r=w.body.childNodes)&&r.length)for(var i=0;i<r.length;i++)w.body.removeChild(r[i])}catch(n){}return w.body.innerHTML=t,w.body.childNodes}function n(t){"loading"!==A.readyState?t():A.addEventListener("DOMContentLoaded",t)}function r(r,i){if(!r)return this;if(r.cash&&r!==S)return r;var o,u=r,s=0;if(k(r))u=R.test(r)?A.getElementById(r.slice(1)):D.test(r)?e(r):t(r,i);else if(P(r))return n(r),this;if(!u)return this;if(u.nodeType||u===S)this[0]=u,this.length=1;else for(o=this.length=u.length;s<o;s++)this[s]=u[s];return this}function i(t,e){return new r(t,e)}function o(t,e){for(var n=t.length,r=0;r<n&&e.call(t[r],t[r],r,t)!==!1;r++);}function u(t,e){var n=t&&(t.matches||t.webkitMatchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector);return!!n&&n.call(t,e)}function s(t){return k(t)?u:t.cash?function(e){return t.is(e)}:function(t,e){return t===e}}function c(t){return i(B.call(t).filter(function(t,e,n){return n.indexOf(t)===e}))}function a(t){return t[_]=t[_]||{}}function f(t,e,n){return a(t)[e]=n}function h(t,e){var n=a(t);return void 0===n[e]&&(n[e]=t.dataset?t.dataset[e]:i(t).attr("data-"+e)),n[e]}function l(t,e){var n=a(t);n?delete n[e]:t.dataset?delete t.dataset[e]:i(t).removeAttr("data-"+name)}function d(t){return k(t)&&t.match(j)}function p(t,e){return t.classList?t.classList.contains(e):new RegExp("(^| )"+e+"( |$)","gi").test(t.className)}function v(t,e,n){t.classList?t.classList.add(e):n.indexOf(" "+e+" ")&&(t.className+=" "+e)}function m(t,e){t.classList?t.classList.remove(e):t.className=t.className.replace(e,"")}function g(t,e){return parseInt(S.getComputedStyle(t[0],null)[e],10)||0}function y(t,e,n){var r=h(t,"_cashEvents")||f(t,"_cashEvents",{});r[e]=r[e]||[],r[e].push(n),t.addEventListener(e,n)}function b(t,e,n){var r,i=h(t,"_cashEvents"),u=i&&i[e];u&&(n?(t.removeEventListener(e,n),r=u.indexOf(n),r>=0&&u.splice(r,1)):(o(u,function(n){t.removeEventListener(e,n)}),u=[]))}function x(t,e){return"&"+encodeURIComponent(t)+"="+encodeURIComponent(e).replace(/%20/g,"+")}function L(t){var e=[];return o(t.options,function(t){t.selected&&e.push(t.value)}),e.length?e:null}function N(t){var e=t.selectedIndex;return e>=0?t.options[e].value:null}function C(t){var e=t.type;if(!e)return null;switch(e.toLowerCase()){case"select-one":return N(t);case"select-multiple":return L(t);case"radio":return t.checked?t.value:null;case"checkbox":return t.checked?t.value:null;default:return t.value?t.value:null}}function E(t,e,n){if(n){var r=t.childNodes[0];t.insertBefore(e,r)}else t.appendChild(e)}function T(t,e,n){var r=k(e);return!r&&e.length?void o(e,function(e){return T(t,e,n)}):void o(t,r?function(t){return t.insertAdjacentHTML(n?"afterbegin":"beforeend",e)}:function(t,r){return E(t,0===r?e:e.cloneNode(!0),n)})}var w,A=document,S=window,M=Array.prototype,B=M.slice,I=M.filter,H=M.push,O=function(){},P=function(t){return typeof t==typeof O&&t.call},k=function(t){return"string"==typeof t},R=/^#[\w-]*$/,q=/^\.[\w-]*$/,D=/<.+>/,W=/^\w+$/,$=i.fn=i.prototype=r.prototype={cash:!0,length:0,push:H,splice:M.splice,map:M.map,init:r};Object.defineProperty($,"constructor",{value:i}),i.parseHTML=e,i.noop=O,i.isFunction=P,i.isString=k,i.extend=$.extend=function(t){t=t||{};var e=B.call(arguments),n=e.length,r=1;for(1===e.length&&(t=this,r=0);r<n;r++)if(e[r])for(var i in e[r])e[r].hasOwnProperty(i)&&(t[i]=e[r][i]);return t},i.extend({merge:function(t,e){for(var n=+e.length,r=t.length,i=0;i<n;r++,i++)t[r]=e[i];return t.length=r,t},each:o,matches:u,unique:c,isArray:Array.isArray,isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)}});var _=i.uid="_cash"+Date.now();$.extend({data:function(t,e){if(k(t))return void 0===e?h(this[0],t):this.each(function(n){return f(n,t,e)});for(var n in t)this.data(n,t[n]);return this},removeData:function(t){return this.each(function(e){return l(e,t)})}});var j=/\S+/g;$.extend({addClass:function(t){var e=d(t);return e?this.each(function(t){var n=" "+t.className+" ";o(e,function(e){v(t,e,n)})}):this},attr:function(t,e){if(t){if(k(t))return void 0===e?this[0]?this[0].getAttribute?this[0].getAttribute(t):this[0][t]:void 0:this.each(function(n){n.setAttribute?n.setAttribute(t,e):n[t]=e});for(var n in t)this.attr(n,t[n]);return this}},hasClass:function(t){var e=!1,n=d(t);return n&&n.length&&this.each(function(t){return e=p(t,n[0]),!e}),e},prop:function(t,e){if(k(t))return void 0===e?this[0][t]:this.each(function(n){n[t]=e});for(var n in t)this.prop(n,t[n]);return this},removeAttr:function(t){return this.each(function(e){e.removeAttribute?e.removeAttribute(t):delete e[t]})},removeClass:function(t){if(!arguments.length)return this.attr("class","");var e=d(t);return e?this.each(function(t){o(e,function(e){m(t,e)})}):this},removeProp:function(t){return this.each(function(e){delete e[t]})},toggleClass:function(t,e){if(void 0!==e)return this[e?"addClass":"removeClass"](t);var n=d(t);return n?this.each(function(t){var e=" "+t.className+" ";o(n,function(n){p(t,n)?m(t,n):v(t,n,e)})}):this}}),$.extend({add:function(t,e){return c(i.merge(this,i(t,e)))},each:function(t){return o(this,t),this},eq:function(t){return i(this.get(t))},filter:function(t){if(!t)return this;var e=P(t)?t:s(t);return i(I.call(this,function(n){return e(n,t)}))},first:function(){return this.eq(0)},get:function(t){return void 0===t?B.call(this):t<0?this[t+this.length]:this[t]},index:function(t){var e=t?i(t)[0]:this[0],n=t?this:i(e).parent().children();return B.call(n).indexOf(e)},last:function(){return this.eq(-1)}});var F=function(){var t=/(?:^\w|[A-Z]|\b\w)/g,e=/[\s-_]+/g;return function(n){return n.replace(t,function(t,e){return t[0===e?"toLowerCase":"toUpperCase"]()}).replace(e,"")}}(),U=function(){var t={},e=document,n=e.createElement("div"),r=n.style;return function(e){if(e=F(e),t[e])return t[e];var n=e.charAt(0).toUpperCase()+e.slice(1),i=["webkit","moz","ms","o"],u=(e+" "+i.join(n+" ")+n).split(" ");return o(u,function(n){if(n in r)return t[n]=e=t[e]=n,!1}),t[e]}}();i.prefixedProp=U,i.camelCase=F,$.extend({css:function(t,e){if(k(t))return t=U(t),arguments.length>1?this.each(function(n){return n.style[t]=e}):S.getComputedStyle(this[0])[t];for(var n in t)this.css(n,t[n]);return this}}),o(["Width","Height"],function(t){var e=t.toLowerCase();$[e]=function(){return this[0].getBoundingClientRect()[e]},$["inner"+t]=function(){return this[0]["client"+t]},$["outer"+t]=function(e){return this[0]["offset"+t]+(e?g(this,"margin"+("Width"===t?"Left":"Top"))+g(this,"margin"+("Width"===t?"Right":"Bottom")):0)}}),$.extend({off:function(t,e){return this.each(function(n){return b(n,t,e)})},on:function(t,e,r,i){var o;if(!k(t)){for(var s in t)this.on(s,e,t[s]);return this}return P(e)&&(r=e,e=null),"ready"===t?(n(r),this):(e&&(o=r,r=function(t){for(var n=t.target;!u(n,e);){if(n===this)return n=!1;n=n.parentNode}n&&o.call(n,t)}),this.each(function(e){var n=r;i&&(n=function(){r.apply(this,arguments),b(e,t,n)}),y(e,t,n)}))},one:function(t,e,n){return this.on(t,e,n,!0)},ready:n,trigger:function(t,e){var n=A.createEvent("HTMLEvents");return n.data=e,n.initEvent(t,!0,!1),this.each(function(t){return t.dispatchEvent(n)})}}),$.extend({serialize:function(){var t="";return o(this[0].elements||this,function(e){if(!e.disabled&&"FIELDSET"!==e.tagName){var n=e.name;switch(e.type.toLowerCase()){case"file":case"reset":case"submit":case"button":break;case"select-multiple":var r=C(e);null!==r&&o(r,function(e){t+=x(n,e)});break;default:var i=C(e);null!==i&&(t+=x(n,i))}}}),t.substr(1)},val:function(t){return void 0===t?C(this[0]):this.each(function(e){return e.value=t})}}),$.extend({after:function(t){return i(t).insertAfter(this),this},append:function(t){return T(this,t),this},appendTo:function(t){return T(i(t),this),this},before:function(t){return i(t).insertBefore(this),this},clone:function(){return i(this.map(function(t){return t.cloneNode(!0)}))},empty:function(){return this.html(""),this},html:function(t){if(void 0===t)return this[0].innerHTML;var e=t.nodeType?t[0].outerHTML:t;return this.each(function(t){return t.innerHTML=e})},insertAfter:function(t){var e=this;return i(t).each(function(t,n){var r=t.parentNode,i=t.nextSibling;e.each(function(t){r.insertBefore(0===n?t:t.cloneNode(!0),i)})}),this},insertBefore:function(t){var e=this;return i(t).each(function(t,n){var r=t.parentNode;e.each(function(e){r.insertBefore(0===n?e:e.cloneNode(!0),t)})}),this},prepend:function(t){return T(this,t,!0),this},prependTo:function(t){return T(i(t),this,!0),this},remove:function(){return this.each(function(t){return t.parentNode.removeChild(t)})},text:function(t){return void 0===t?this[0].textContent:this.each(function(e){return e.textContent=t})}});var z=A.documentElement;$.extend({position:function(){var t=this[0];return{left:t.offsetLeft,top:t.offsetTop}},offset:function(){var t=this[0].getBoundingClientRect();return{top:t.top+S.pageYOffset-z.clientTop,left:t.left+S.pageXOffset-z.clientLeft}},offsetParent:function(){return i(this[0].offsetParent)}}),$.extend({children:function(t){var e=[];return this.each(function(t){H.apply(e,t.children)}),e=c(e),t?e.filter(function(e){return u(e,t)}):e},closest:function(t){return!t||this.length<1?i():this.is(t)?this.filter(t):this.parent().closest(t)},is:function(t){if(!t)return!1;var e=!1,n=s(t);return this.each(function(r){return e=n(r,t),!e}),e},find:function(e){if(!e||e.nodeType)return i(e&&this.has(e).length?e:null);var n=[];return this.each(function(r){H.apply(n,t(e,r))}),c(n)},has:function(e){var n=k(e)?function(n){return 0!==t(e,n).length}:function(t){return t.contains(e)};return this.filter(n)},next:function(){return i(this[0].nextElementSibling)},not:function(t){if(!t)return this;var e=s(t);return this.filter(function(n){return!e(n,t)})},parent:function(){var t=[];return this.each(function(e){e&&e.parentNode&&t.push(e.parentNode)}),c(t)},parents:function(t){var e,n=[];return this.each(function(r){for(e=r;e&&e.parentNode&&e!==A.body.parentNode;)e=e.parentNode,(!t||t&&u(e,t))&&n.push(e)}),c(n)},prev:function(){return i(this[0].previousElementSibling)},siblings:function(){var t=this.parent().children(),e=this[0];return t.filter(function(t){return t!==e})}});var z=A.documentElement;return $.extend({jqPosition:function(){var t=this[0];if(t){var e,n,r,o,u=i(t),s={top:0,left:0};if("fixed"===u.css("position"))r=t.getBoundingClientRect();else{for(r=this.offset(),o=t.ownerDocument,e=t.offsetParent||z,n=i(e);e&&(e===o.body||e===z)&&"static"===n.css("position");)e=e.parentNode;e&&e!==t&&1===e.nodeType&&(s=n.offset(),s.top+=parseInt(n.css("borderTopWidth"),10)||0,s.left+=parseInt(n.css("borderLeftWidth"),10)||0)}return{top:r.top-s.top-(parseInt(u.css("marginTop"),10)||0),left:r.left-s.left-(parseInt(u.css("marginLeft"),10)||0)}}}}),i});
define("/svc/cdn/pub/dom_util.js",["cash"],function($){var E={};E.is_resize_observer_supported=typeof ResizeObserver=="function";function class_re(cls){return new RegExp("(^|\\s)"+cls+"($|\\s)")}E.get_elm_resolution=function(elm){var st=elm&&getComputedStyle(elm);if(!st||isNaN(parseInt(st.width))||isNaN(parseInt(st.height)))return;var full_screen=!(document.fullScreenElement===null||document.msFullscreenElement===null||document.mozFullScreen!==undefined&&!document.mozFullScreen||document.webkitIsFullScreen!==undefined&&!document.webkitIsFullScreen);return{width:parseInt(st.width,10),height:parseInt(st.height,10),full_screen:full_screen}};E.get_full_elm_selector=function(elm,skip_class){if(elm&&elm.nodeType==document.DOCUMENT_FRAGMENT_NODE)return"DOCUMENT_FRAGMENT_NODE";return elm.tagName.toLowerCase()+(elm.id?"#"+elm.id:"")+(skip_class||!elm.className?"":(" "+elm.className).replace(/\s+/g,"."))};E.get_elm_selector_path=function(elm,skip_class){return $(elm).add($(elm).parents()).map(function(el){return E.get_full_elm_selector(el,skip_class)}).reverse().join(">")};E.closest=function(elm,selector){if(elm.closest)return elm.closest(selector);if(elm.matches){if(!document.documentElement.contains(elm))return null;do{if(elm.matches(selector))return elm;elm=elm.parentElement}while(elm)}return null};E.matches=function(elm,selector){var method=["matches","matchesSelector","mozMatchesSelector","mozMatchesSelector","msMatchesSelector","oMatchesSelector","webkitMatchesSelector"].find(function(m){return typeof elm[m]=="function"});if(method)return elm[method](selector);var matches=(elm.document||elm.ownerDocument).querySelectorAll(selector);var i=matches.length;while(--i>=0&&matches.item(i)!=elm);return i>-1};E.remove=function(elm){if(elm.parentNode)elm.parentNode.removeChild(elm)};E.has_class=function(elm,cls){if(elm.classList)return elm.classList.contains(cls);return class_re(cls).test(elm.className)};E.is_visible=function(elem){return!!(elem&&(elem.offsetWidth||elem.offsetHeight||elem.getClientRects().length))};E.detect_direction=function(el){if(el&&el.length)el=el[0];var dir="ltr",w=window;for(;;){var styles=getComputedStyle(el);if(!styles)break;var d=styles.direction;if(d!=dir){dir=d;break}try{if(!(el=w.frameElement))break;el=el.parentElement;w=w.parent;continue}catch(e){break}}return dir};E.space_occupied=function(container,element){var top=Math.max(container.top,element.top);var right=Math.min(container.right,element.right);var bottom=Math.min(container.bottom,element.bottom);var left=Math.max(container.left,element.left);if(top>=bottom||left>=right)return 0;return(bottom-top)*(right-left)/((element.bottom-element.top)*(element.right-element.left))};E.visual_viewport=function(){var vp;if(vp=window.visualViewport){return{top:vp.offsetTop,bottom:vp.offsetTop+vp.height,left:vp.offsetLeft,right:vp.offsetLeft+vp.width,height:vp.height,width:vp.width}}var root_rect=document.documentElement.getBoundingClientRect();return{top:root_rect.top+window.pageYOffset,bottom:root_rect.top+window.pageYOffset+window.innerHeight,left:root_rect.left+window.pageXOffset,right:root_rect.left+window.pageXOffset+window.innerWidth,height:window.innerHeight,width:window.innerWidth}};E.client_rect2page_rect=function(rect){var root_rect=document.documentElement.getBoundingClientRect();return{top:rect.top-root_rect.top,bottom:rect.bottom-root_rect.bottom,left:rect.left-root_rect.left,right:rect.right-root_rect.right,height:rect.height,width:rect.width}};E.in_front=function(el,rect){rect=rect||$(el)[0].getBoundingClientRect();var w=rect.width||rect.right-rect.left;var h=rect.hight||rect.bottom-rect.top;var p=$(document.elementFromPoint(rect.left+w/2,rect.top+h/2));return p.closest(el).length||$(el).closest(p.parent()).length};E.preload_css=function(url,doc){if(!doc)doc=document;var css=doc.createElement("link");css.rel="stylesheet";css.href=url;doc.head.appendChild(css)};E.is_img_loaded=function(img){return img.width>1&&img.naturalWidth>1||img.tagName!="IMG"&&img.offsetWidth>1||img.tagName=="PICTURE"&&img.getBoundingClientRect().width>1};E.on_img_load=function(img,cb){var off,unwatch;var on_load=function(){off();if(img.style.display!="none")return void cb();unwatch=E.attr_watch(img,{attr:"style",watch_fn:function(){if(img.style.display=="none")return;unwatch();unwatch=null;cb()}})};off=function(){$(img).off("load",on_load)};$(img).on("load",on_load);return function(){off();if(unwatch)unwatch($(img).off("load",on_load))}};E.is_convertible_to_cashjs=function(val){if(typeof val=="string"||Array.isArray(val))return true;if(typeof window=="undefined")return false;return val instanceof window.Node||val instanceof window.NodeList||val instanceof window.HTMLCollection};E.is_passive_supported=function(){var res=false;try{var opt=Object.defineProperty({},"passive",{get:function(){res=true}});window.addEventListener("__spark_test_passive",null,opt)}catch(e){}return res}();E.non_passive_listener=function(el,ev,handler){if(E.is_passive_supported)return el.addEventListener(ev,handler,{passive:false});el.addEventListener(ev,handler,false)};E.get_fullscreen_element=function(doc){doc=doc||document;return doc.fullscreenElement||doc.mozFullScreenElement||doc.webkitFullscreenElement||doc.msFullscreenElement};E.get_mid_rect=function(h_percentage,w_percentage){h_percentage=(h_percentage||100)/100;w_percentage=(w_percentage||100)/100;var vp=E.visual_viewport();var mid_y=vp.top+vp.height/2;var mid_x=vp.left+vp.width/2;var height=vp.height*h_percentage|0;var width=vp.width*w_percentage|0;return{top:mid_y-height/2|0,left:mid_x-width/2|0,bottom:mid_y+height/2|0,right:mid_x+width/2|0,height:height,width:width}};E.in_rect=function(el,container,is_inside){if(is_inside){return el.top>=container.top&&el.bottom<=container.bottom&&el.left>=container.left&&el.right<=container.right}return el.bottom>=container.top&&el.top<=container.bottom&&el.right>=container.left&&el.left<=container.right};E.add_style=function(attr,css,parent){if(!attr)return;parent=parent||document.head||document.querySelector("head");if(!parent)return;if(parent.querySelector("["+attr+"]"))return;var style=document.createElement("style");style.setAttribute(attr,"");style.innerHTML=css;parent.appendChild(style)};E.offset=function(el){var rect=el.getBoundingClientRect();var doc_el=document.documentElement;return{top:rect.top+window.pageYOffset-doc_el.clientTop,left:rect.left+window.pageXOffset-doc_el.clientLeft}};E.width=function(el){return el.getBoundingClientRect().width};E.height=function(el){return el.getBoundingClientRect().height};E.position=function(el){return{left:el.offsetLeft,top:el.offsetTop}};E.style_important=function(el,css){if(!el||!el.style||!el.style.setProperty)return;for(var property in css)el.style.setProperty(property,css[property],"important")};E.remove=function(el){if(el&&el.length)el=el[0];return el&&el.parentNode&&el.parentNode.removeChild(el)};E.is_fullscreen=function(){return document.fullScreenElement||document.msFullscreenElement||document.mozFullScreen||document.webkitIsFullScreen};E.offset_parent=function(el){var res=null,cur_el=$(el).parent(),tr;while(!res&&cur_el[0].tagName!="HTML"){if(["relative","absolute","fixed"].includes(cur_el.css("position"))||(tr=cur_el.css("transform"))&&tr!="none"){res=cur_el.offset()}cur_el=cur_el.parent()}return res};E.get_position=function(el){var parent_offset=E.offset_parent(el);if(!parent_offset)parent_offset={left:0,top:0};var el_offset=$(el).offset();return{left:el_offset.left-parent_offset.left,top:el_offset.top-parent_offset.top}};E.parse_bg_image=function(bg){var res=/url\(('([^']+)'|"([^"]+)"|([^'")]+))\)/i.exec(bg);return res&&(res[2]||res[3]||res[4])};E.pointer_within=function(el,ev){if(!ev||!/^mouse|^touch/.test(ev.type))return;var r=$(el)[0].getBoundingClientRect();if(r.top<0&&$(el).parents().filter(function(p){return $(p).css("position")=="sticky"}).length){return true}ev=ev.changedTouches&&ev.changedTouches[0]||ev;return ev.clientX<=r.right+3&&ev.clientX>=r.left-3&&ev.clientY<=r.bottom+3&&ev.clientY>=r.top-3};E.is_el_allowed_by_css=function(el,filter){if(!filter)return true;var include=filter.include||[];var exclude=filter.exclude||[];function match(selector){if(!selector||!el)return false;return el.matches(selector)}if(exclude.find(match))return false;if(!include.length||include.find(match))return true;return false};E.is_el_in_page=function(el){return document.documentElement&&document.documentElement.contains(el)};E.get_page_info=function(){var el=document.querySelector('meta[property="og:title"]');var title=el&&el.getAttribute("content")||document.title;el=document.querySelector('meta[property="og:image"]');var poster=el&&el.getAttribute("content");el=document.querySelector('meta[property="og:url"]');var url=el&&el.getAttribute("content")||typeof location!="undefined"&&location.href;return{poster:poster,title:title,url:url}};E.force_redraw=function(el){if(el.length)el=el[0];var display=el.style.display;el.style.display="none";if(el.offsetHeight||true)el.style.display=display};E.dom_listen=function(el,on_dom_change){if(!window.MutationObserver)return function(){};var observer=new window.MutationObserver(on_dom_change);observer.observe(el,{childList:true,subtree:true});E.dom_listen.using_observer=true;return observer.disconnect.bind(observer)};E.attr_watch=function(element,opt){function onchange(from,to){var re;if(re=opt.toggle_pattern){if(re.test(to)==re.test(from))return;from=(from&&from.match(re)||[])[0];to=(to&&to.match(re)||[])[0]}else if(re=opt.change_pattern){from=(from&&from.match(re)||[])[0];to=(to&&to.match(re)||[])[0];if(from==to)return}opt.watch_fn(from,to)}if(window.MutationObserver){var observer=new window.MutationObserver(function(mutations){var first;if(first=mutations.find(function(record){return record.attributeName==opt.attr})){onchange(first.oldValue,element.getAttribute(opt.attr))}});observer.observe(element,{attributes:true,attributeOldValue:true});return observer.disconnect.bind(observer)}};return E});
define("/svc/cdn/pub/stats.js",{__stub:1});

define("/svc/cdn/pub/analysis.js",{__stub:1});
define("/svc/cdn/pub/shaka.js",{__stub:1});
define("/svc/cdn/pub/dash.js",{__stub:1});
define("/svc/cdn/pub/hls.js",{__stub:1});








define("/svc/cdn/pub/dailymotion.js",{__stub:1});
define("/svc/cdn/pub/player_util.js",["cash","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/log.js"],function($,zutil,util,log){var _log=log.set_type("player");var E={log:function(cdn_log,module){return(cdn_log||_log).set_type("player").set_module(module)}};var assign=Object.assign;E.Player=function(opt){var _this=this;util.call_super(E,this);this.log=this.log||E.log(opt.log,"player_util");var stop_monitor;this.on("wrapper.attach_to_player",function(){if(_this.is_paused()&&!_this.is_ad_active()){_this._early_start=true;_this.once("pre-state",function(){_this._early_start=false})}});this.on("wrapper_attached",function(){stop_monitor=_this._monitor_user_activity()});this.on("wrapper_detached",function(){if(stop_monitor)stop_monitor();stop_monitor=undefined});this.on("reconf",function(){if(!stop_monitor)return;stop_monitor();stop_monitor=_this._monitor_user_activity()});function rm_seek_hook(){if(!_this.seek_hook)return;_this.seek_hook.remove();_this.seek_hook=undefined}this.on("started",rm_seek_hook);this.on("uninit",rm_seek_hook);this.on("missing_idr",function(){if(_this.seek_hook)return;if(util.is_firefox&&+util.browser.version>=51&&_this.html5){_this.seek_hook=util.inject_hook(_this.html5,"currentTime",{set:function(e,args){if(_this.is_buffered(args[0])||args[0]==0)return;_this.log.warn("Due to firefox bug "+"https://bugzilla.mozilla.org/show_bug.cgi?id=1345808"+" of handling seeks in video encodings with missing "+"IDR in random access points, seek is disabled");e.set_handled()}})}});if(zutil.is_mocha()){window.dispatchEvent(assign(util.new_event("zmocha.new_player"),{data:{player:this}}))}};zutil.inherits(E.Player,util.events);E.Player.prototype.emit_external=function(e,data){var container=this.get_ui().container||{};if(container.dispatchEvent)container.dispatchEvent(assign(util.new_event(e),{data:data}))};E.Player.prototype.get_current_buffer=function(pos){var b=this.get_buffered()||[];if(pos===undefined)pos=this.get_pos()||0;for(var i=0;i<b.length;i++){if(pos>=b.start(i)&&pos<=b.end(i))return{from:b.start(i),to:b.end(i)}}return{from:pos,to:pos}};E.Player.prototype.get_buffered_sec=function(){var b=this.get_buffered()||[],sum=0;for(var i=0;i<b.length;i++)sum+=b.end(i)-b.start(i);return sum};E.Player.prototype.is_buffered=function(pos){var b=this.get_buffered()||[];for(var i=0;i<b.length;i++){if(pos>=b.start(i)&&pos<=b.end(i))return true}};E.Player.prototype.get_est_bytes=function(){return null};E.Player.prototype.get_video_type_name=function(url){url=url||this.get_url();return util.get_video_type(util.video2type(url))};E.Player.prototype.get_state=function(){return"IDLE"};E.Player.prototype.is_idle=function(){return true};E.Player.prototype.is_paused=function(){return false};E.Player.prototype.is_playing=function(){return false};E.Player.prototype.get_video_type=function(){return""};E.Player.prototype.get_versions=function(){};E.Player.prototype.get_ad_scheme=function(){};E.Player.prototype.is_native_hls=function(){return false};E.Player.prototype.is_interrupted=function(){return false};E.Player.prototype.captions_supported=function(){return true};E.Player.prototype.check_playback_status=function(status_cb){var _this=this,html5=this.html5;if(!html5||!window.MediaSource)return void status_cb({state:"enabled",based_on:"env"});var enabled_reason=html5.readyState>html5.HAVE_NOTHING?"readystate":!util.is_hidden?"visibility":null;this.log.info("playback test request: "+(enabled_reason?"enabled based on "+enabled_reason:"test in progress"));if(enabled_reason)return status_cb({state:"enabled",based_on:enabled_reason});status_cb({state:"checking"});var ms,v,on_sourceopen,on_loadedmetadata;var cleanup=function(){if(ms)ms.removeEventListener("sourceopen",on_sourceopen);if(html5)html5.removeEventListener("loadedmetadata",on_loadedmetadata);ms=v=html5=null};var done=function(reason){_this.log.info("playback test complete: enabled based on "+reason);status_cb({state:"enabled",based_on:reason});cleanup()};on_sourceopen=function(){done("sourceopen")};on_loadedmetadata=function(){done("testfailure")};html5.addEventListener("loadedmetadata",on_loadedmetadata);ms=new window.MediaSource;ms.addEventListener("sourceopen",on_sourceopen);v=document.createElement("video");v.src=window.URL.createObjectURL(ms);return cleanup};E.Player.prototype.get_caps=function(caps){return assign({save_context:[]},caps)};E.Player.prototype.get_media_type=function(){return"video"};E.Player.prototype.get_media_size=function(){if(this.html5&&this.html5.videoWidth&&this.html5.videoHeight)return{width:this.html5.videoWidth,height:this.html5.videoHeight}};E.Player.prototype.is_bitrate_supported=function(){return true};E.Player.prototype.get_current_error=function(){};E.Player.prototype.enable_context_menu=function(){var c=this.get_ui().container;if(!c)return;c.oncontextmenu=this.saved_oncontextmenu};E.Player.prototype.disable_context_menu=function(){var c=this.get_ui().container;if(!c)return;this.saved_oncontextmenu=c.oncontextmenu;c.oncontextmenu=function(){return false}};E.Player.prototype.check_buffer=function(){};E.Player.prototype.is_any_ad_mode=function(){return this.is_ad_active()||this.is_ad_source()};E.Player.prototype.check_seekable=function(){function between(ver,v1,v2){return util.cmp_version(ver,v1)>=0&&util.cmp_version(ver,v2)<=0}var ver=window.Hls&&window.Hls.version||zutil.get(this,"module.hls.version");var result={res:!ver||!between(ver,"0.6.2","0.6.12")&&!between(ver,"0.7.3","0.7.9")||(this.get_buffered()||[]).length};if(!result.res){result.msg="dailymotion/hls.js upgrade to v0.7.10+ required: "+"v"+ver+" overrides seek-on-start"}return result};E.Player.prototype.is_ad_source=function(url){return util.is_ad_url(url||this.get_url())};E.Player.prototype.is_ad_active=function(){return false};E.Player.prototype.is_ad_loading=function(){return false};E.Player.prototype.get_ad_state=function(){return!this.is_ad_active()?"IDLE":this.is_ad_loading()?"LOADING":"PLAYING"};E.Player.prototype.is_ad_playing=function(){return false};E.Player.prototype.is_ad_paused=function(){return false};E.Player.prototype.ad_play=function(){};E.Player.prototype.ad_pause=function(){};E.Player.prototype.get_captions_track=function(){return-1};E.Player.prototype.set_captions_track=function(track){};E.Player.prototype.has_started=function(){return!this.is_idle()&&!this._early_start};E.Player.prototype.play_src=function(src){};E.Player.prototype.is_seeking=function(){return this.html5&&this.html5.seeking};E.Player.prototype.scrubbing=function(is_scrubbing){if(is_scrubbing===undefined){return this.is_scrubbing||this.custom&&this.custom.is_scrubbing&&this.custom.is_scrubbing()}this.is_scrubbing=is_scrubbing};E.Player.prototype.muted=function(v){if(!this.html5)return;if(v===undefined)return this.html5.muted;this.html5.muted=v};E.Player.prototype.volume=function(v){if(!this.html5)return;if(v===undefined)return this.html5.volume;this.html5.volume=v};E.Player.prototype.fullscreen=function(){};E.Player.prototype.is_controlbar_visible=function(){var cb=this.get_ui().control_bar;return cb?$(cb).css("opacity")=="1"&&$(cb).css("display")!="none":true};E.Player.prototype.set_controlbar_visible=function(is_visible){var cb;if(!(cb=$(this.get_ui().control_bar)[0]))return;if(is_visible)cb.style.setProperty("display","");else cb.style.setProperty("display","none","important")};E.Player.prototype.get_player=function(){return this};E.Player.prototype.get_playlist_url=function(){var url=this.get_url();if(url&&!this.is_ad_source(url))return url;return util.gconf_apply("loader.player.guess_url",[this])};E.Player.prototype._monitor_user_activity=function(){var _this=this,$container=$(this.get_ui().container),last_move;var check_inactive_timeout;function on_mousemove(){if(!last_move){_this.user_active=true;_this.emit("user_active")}last_move=util.date_monotonic()}function on_mouseleave(){last_move=null;_this.user_active=false;_this.emit("user_inactive")}$container.on("mousemove",on_mousemove);$container.on("mouseleave",on_mouseleave);function check_inactive(){if(last_move&&util.date_monotonic()-last_move>3e3)on_mouseleave();check_inactive_timeout=setTimeout(check_inactive,500)}check_inactive();return function(){clearTimeout(check_inactive_timeout);$container.off("mousemove",on_mousemove);$container.off("mouseleave",on_mouseleave)}};E.Player.prototype.is_user_active=function(){return this.user_active};E.Player.prototype.is_ready=function(){return true};E.Player.prototype.set_casting=function(state){this.cast_state=state};E.Player.prototype.is_casting=function(){return!!this.cast_state};E.Player.prototype.set_cdn_mode=function(){};E.Player.prototype.get_title=function(){};E.Player.prototype.get_description=function(){};E.Player.prototype.get_poster=function(){};util.module_fn(E,function hap_enabled(){return false});E.build_flash_api=function(_this){function call_api(name,check){var f,slice=Array.prototype.slice;if(_this.swf&&(f=_this.swf["hola_"+name]))return check?!!f:f.apply(_this.swf,slice.call(arguments,2))}return{_call_api:call_api,set_bandwidth:call_api.bind(null,"setBandwidth",false),version:call_api.bind(null,"version",false),avail_version:call_api.bind(null,"version",true),settings:call_api.bind(null,"settings",false),avail_settings:call_api.bind(null,"settings",true),set_timeout:call_api.bind(null,"setTimeout",false),avail_set_timeout:call_api.bind(null,"setTimeout",true)}};E.build_ui=function(container,selector){function s2node(s){return s instanceof Node?s:container.querySelector(s)}var ui={container:container};if(selector.fullscreen)ui.fullscreen=s2node(selector.fullscreen);if(selector.control_bar)ui.control_bar=s2node(selector.control_bar);if(selector.progress_bar)ui.progress_bar=s2node(selector.progress_bar);if(selector.media)ui.media=s2node(selector.media);return ui};E.select_ad_handler=function(player,handlers,opt){var name=Object.keys(handlers).find(function(n){if(!util.is_enabled(handlers[n]))return;return handlers[n].is_enabled(opt)});return name&&new handlers[name](player)};return E});
define("/svc/cdn/pub/html5.js",["cash","/svc/cdn/pub/util.js","/util/util.js","/svc/cdn/pub/shaka.js","/svc/cdn/pub/dash.js","/svc/cdn/pub/dailymotion.js","/svc/cdn/pub/player_util.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/perr.js"],function($,util,zutil,shaka,dash,dailymotion,player_util,dom_util,perr){var E={};var CG=util.gconf_get;E.Player=function(opt){var _this=this;util.call_super(E,this,null,opt);this.log=player_util.log(opt.log,"html5");this.html5=this.video=opt.html5;this.name="html5";this.tech="html5";this.media_src_api=window;this.state="IDLE";this.blob2url={};this.position=0;this.custom=opt.custom||{};this.paused=this.custom.is_paused?this.custom.is_paused():this.html5.paused;this.detect_scrubbing=!zutil.is_mocha()&&!this.custom.is_scrubbing&&!this.get_ui().control_bar;this.src=this.get_url();function check_interrupted(){var player=opt.parent_player||_this,new_url=_this.get_url();if(!player.is_idle()&&_this.src!=new_url){_this.src=new_url;_this.emit("interrupted")}}function is_pending_sourceopen(){if(_this.media_src_url!=E.get_hola_video_source(_this.html5))_this.pending_sourceopen=false;return _this.pending_sourceopen}function is_event_on_ended(){return!_this.is_idle()&&_this.position>0&&_this.duration>0&&_this.html5.readyState==_this.html5.HAVE_NOTHING&&util.close_to_end(_this.position,_this.duration)}function html5_src_ext(){var src=_this.get_url();var hola_src=_this.html5.hola_src||_this.blob2url[_this.html5.src]&&_this.html5.src;return hola_src&&hola_src!=src?src+" (hola="+hola_src+")":src}function change_state(state,ext_event,ext_data){if(_this.state=="IDLE"&&!_this.get_url())return;var prev=_this.state;var external_states={IDLE:"IDLE",PLAYING:"PLAYING",PLAYING_SEEKING:"PLAYING",BUFFERING:"PLAYING",PAUSED:"PAUSED"};_this.state=state;var ext_state=external_states[state];if(ext_state==external_states[prev])return;if(ext_state=="PLAYING"||ext_state=="PAUSED")_this.paused=ext_state=="PAUSED";if(prev=="IDLE")_this.emit("started");if(ext_event)_this.emit(ext_event,ext_data);_this.emit("state",_this.state)}function video_completed(){_this.log.info("html5 ended "+_this.state+" "+html5_src_ext());_this.ended=true;if(_this.scr_to)clearTimeout(_this.scr_to);change_state("IDLE","ended")}this.on_html5=function(event,handler){handler=handler.bind(this);this.html5_events=this.html5_events||{};this.html5_events[event]=[].concat(this.html5_events[event]||[],handler);html5_on(this.html5,event,handler)};this.off_html5=function(event){this.html5_events[event].forEach(function(handler){html5_off(this.html5,event,handler)}.bind(this));this.html5_events[event]=[]};if(window.hola_debug_player){var all_html5_video_events=["abort","canplay","canplaythrough","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","play","playing","pause","progress","ratechange","seeking","seeked","stalled","suspend","waiting"];all_html5_video_events.forEach(function(e){_this.on_html5(e,function(o){_this.log.console("html5 "+e+": "+o.timeStamp)})})}this.on_html5("loadedmetadata",function(e){this.log.info("html5 loadedmetadata "+this.state+" "+html5_src_ext());if(this.pending_seek_ms)this.seek(this.pending_seek_ms)});this.on_html5("seeked",function(e){if(this.state=="PLAYING_SEEKING")change_state("PLAYING");var t=e&&(e.target||this.html5),custom=this.custom;var seek_ended=this.state=="IDLE"&&this.ended&&t.currentTime==0;if(!this.config.seek_no_state_change&&!seek_ended&&!this.paused&&t&&t.paused&&(!custom.is_paused||custom.is_paused())&&!this.scrubbing()){this.do_pause()}if(!this.config.seek_no_state_change&&this.paused&&t&&!t.paused&&(!custom.is_playing||custom.is_playing())){this.do_play()}this.emit("seeked")});this.on_html5("abort",function(){if(is_pending_sourceopen())return;this.log.info("html5 abort "+this.state+" "+html5_src_ext());if(is_event_on_ended())return video_completed();if(this.is_continuous_reload)return;check_interrupted();change_state("IDLE")});this.on_html5("emptied",function(){if(is_pending_sourceopen())return;this.log.info("html5 emptied "+this.state+" "+html5_src_ext());if(is_event_on_ended())return video_completed();if(this.is_continuous_reload)return;check_interrupted();change_state("IDLE")});this.on_html5("loadstart",function(e){this.log.notice("html5 loadstart "+this.state+" "+html5_src_ext());var html5_state=this.html5.paused?"PAUSED":"PLAYING";this.src=this.get_url();if(is_pending_sourceopen()){this.log.info("loadstart after src replacement: ignored");if(this.is_idle())change_state(html5_state);return}if(this.is_continuous_reload){this.log.info("loadstart after load() w/out src change: ignored");this.is_continuous_reload=false;return}if(this.src)change_state(html5_state)});this.on_html5("seeking",function(e){if(this.state=="PLAYING")this.state="PLAYING_SEEKING";this.prev_position=this.position;this.position=this.html5.currentTime;this.emit("seeking",this.prev_position,this.position)});this.on_pause=function(){var t=this.html5,custom=this.custom;if(!custom.is_seeking&&t&&t.seeking||custom.is_seeking&&custom.is_seeking()||custom.is_paused&&!custom.is_paused()){if(this.detect_scrubbing)this.scrubbing(true);return}this.do_pause()};this.on_html5("pause",function(e){var t=e&&(e.target||this.html5),custom=this.custom;if(!custom.is_ended&&t&&t.ended||custom.is_ended&&custom.is_ended()){return video_completed()}if(this.detect_scrubbing){if(this.scr_to)clearTimeout(this.scr_to);return void(this.scr_to=setTimeout(this.on_pause.bind(this)))}this.on_pause()});this.on_html5("ended",function(e){video_completed()});this.on_html5("play",function(e){if(this.scr_to)this.scr_to=clearTimeout(this.scr_to);if(this.detect_scrubbing)this.scrubbing(false);var t=e&&(e.target||this.html5);if(t&&(!this.is_idle()&&(!this.custom.is_seeking&&t.seeking||this.custom.is_seeking&&this.custom.is_seeking())||this.custom.name=="delightvr"&&t.networkState==t.NETWORK_NO_SOURCE)){this.log.info("html5 play ignored net_state "+t.networkState+" seeking "+t.seeking);return}this.do_play()});this.on_html5("waiting",function(e){if(this.state=="PLAYING")change_state("BUFFERING");this.emit("waiting")});this.on_html5("loadedmetadata",function(e){var src=E.get_hola_video_source(this.html5);if(src&&!util.is_blob_url(src)&&this.is_idle())change_state(this.html5.paused?"PAUSED":"PLAYING")});this.on_html5("error",function(e){var err;if(err=html5_get_error(this))this.emit("error",err)});this.on_html5("timeupdate",function(e){var t=e&&(e.target||this.html5);if(t&&t.networkState==t.NETWORK_NO_SOURCE)return;var pos=this.html5.currentTime;if(pos>this.position&&!this.html5.paused&&!this.html5.ended)change_state("PLAYING");this.html5_prev_position=this.position;this.position=pos;this.emit("timeupdate",pos)});this.on_html5("durationchange",function(){this.duration=this.get_duration();this.emit("duration_changed")});this.on_html5("volumechange",function(){this.emit("volumechange")});if(this.html5.networkState&&this.html5.networkState!=this.html5.NETWORK_NO_SOURCE){this.state=this.html5.paused?"PAUSED":"PLAYING"}if(this.custom.on){this.custom_events=["ad_suspend","ad_restore","ad_start","ad_play"];this.custom_events.forEach(function(ev){_this["on_custom_"+ev]=function(_opt){_this.emit(ev,_opt)};_this.custom.on(ev,_this["on_custom_"+ev])})}this.reset_state=function(){delete this.pending_seek_ms;this.ended=false;this.position=0;if(this.config.continue_on_reload){if(this.reload_unhook)this.reload_unhook();this.reload_unhook=E.hacks.on_reload_request(this.html5,function(){_this.is_continuous_reload=true})}}.bind(this);this.on("started",this.reset_state);this.do_pause=function(){this.log.notice("html5 pause");change_state("PAUSED");this.emit("pause")};this.do_play=function(){this.play_count=this.play_count||0;this.log.notice("html5 play "+this.state+" "+html5_src_ext());change_state("PLAYING");this.emit("play");var n=this.config.ignore_num_play_events||0;if(this.play_count<n)this.html5.pause();if(this.adjust_pos&&!this.html5.seeking&&this.html5.currentTime)this.html5.currentTime+=.1;this.play_count++};this.config={ignore_other_error:CG("loader.player.ignore_other_error"),ignore_num_play_events:CG("loader.player.ignore_num_play_events"),disable_ended_fallback:CG("loader.player.disable_ended_fallback"),disable_src_change_hiding:CG("loader.player.disable_src_change_hiding"),lock_reload_request:CG("loader.player.html5.lock_reload_request",CG("loader.player."+this.custom.name+".lock_reload_request")),seek_no_state_change:CG("loader.player.html5.seek_no_state_change"),continue_on_reload:CG("loader.player.html5.continue_on_reload",CG("loader.player."+this.custom.name+".continue_on_reload")),ext_control_logs:CG("loader.player.html5.ext_control_logs",util.debug_mode)};if(opt.shaka){util.assert_enabled(shaka,"shaka module is required but disabled");this.module=new shaka.Module({log:this.log,shaka:opt.shaka})}else if(opt.dashjs){util.assert_enabled(dash,"dash module is required but disabled");this.module=new dash.Module({log:this.log,dashjs:opt.dashjs})}else if(opt.dailymotion){util.assert_enabled(dailymotion,"dailymotion module is required but disabled");this.module=new dailymotion.Module({log:this.log,dailymotion:opt.dailymotion,player:this,state:this.state})}this.rm_forwarding_emit=util.create_forwarding_emit(this);if(this.config.ext_control_logs){E.on_ext_control(this,this.html5,function(log){_this.log.info(log+" state "+_this.state+" src "+html5_src_ext()+" stack "+util.stack_to_pprint((new Error).stack))})}if(!this.is_idle())this.reset_state()};zutil.inherits(E.Player,player_util.Player);E.Player.prototype.uninit=function(){if(this.custom_events){this.custom_events.forEach(function(ev){this.custom.off(ev,this["on_custom_"+ev])},this)}this.off("started",this.reset_state);if(this.rm_forwarding_emit)this.rm_forwarding_emit=this.rm_forwarding_emit();if(this.config.ext_control_logs)E.on_ext_control(this,this.html5,false);if(this.src_unlock)this.src_unlock=this.src_unlock();if(this.reload_unhook)this.reload_unhook=this.reload_unhook();if(this.events&&this.events.removeAllListeners)this.events.removeAllListeners();if(this.module&&this.module.uninit)this.module.uninit();for(var event in this.html5_events)this.off_html5(event)};E.Player.prototype._get_custom_url=function(){if(this.custom.get_url)try{return this.custom.get_url()}catch(e){}};E.Player.prototype.get_url=function(){var src;if(!(src=this._get_custom_url())){src=this.module?this.module.get_url():E.get_video_source(this.html5)}if(util.is_blob_url(src)&&this.blob2url[src])src=this.blob2url[src];return src};E.Player.prototype.seek=function(ms){if(this.custom.seek)return this.custom.seek(ms);if(this.html5.readyState<this.html5.HAVE_METADATA)return this.pending_seek_ms=ms;this.html5.currentTime=ms/1e3};E.Player.prototype.get_pos=function(){if(this.custom.get_pos)return this.custom.get_pos();return this.html5.currentTime};util.module_fn(E,function get_state(){return this.state});E.Player.prototype.refresh_buffered=function(){return this.html5.buffered};E.Player.prototype.get_buffered=function(){return this.html5.buffered};E.Player.prototype.get_duration=function(){if(this.custom.get_duration)return this.custom.get_duration();return this.html5.duration};E.Player.prototype.get_resolution=function(){return dom_util.get_elm_resolution(this.html5)};E.Player.prototype.play=function(){return this.custom.play?this.custom.play():this.html5.play()};E.Player.prototype.pause=function(){return this.custom.pause?this.custom.pause():this.html5.pause()};E.Player.prototype.is_seeking=function(){var custom=this.custom;return!custom.is_seeking&&this.html5&&this.html5.seeking||custom.is_seeking&&custom.is_seeking()};E.Player.prototype.muted=function(v){if(this.custom.muted)return this.custom.muted(v);return util.call_super(E,this,"muted",v)};util.module_fn(E,function play_url(url,opt){var _this=this;opt=opt||{};if(opt.pos){html5_on(this.html5,"loadedmetadata",function cb(){html5_off(_this.html5,"loadedmetadata",cb);html5_wait_for_event(_this.html5,"seeking",500,function retry(){_this.html5.currentTime=opt.pos});_this.html5.currentTime=opt.pos})}this.html5.src=url;if(!opt.is_paused)this.html5.play()});util.module_fn(E,function enable_data_mode(on_sourceopen){if(!this.media_src_api.MediaSource)throw new Error("MediaSource API not available");this.media_src=new this.media_src_api.MediaSource;this.pending_sourceopen=true;var played=!this.html5.paused;this.media_src_url=this.media_src_api.URL.createObjectURL(this.media_src);var current_url=E.get_video_source(this.html5);var original_url=this.blob2url[this.media_src_url]=this.blob2url[current_url]||current_url;this.html5.src=this.media_src_url;if(!this.config.disable_src_change_hiding){if(this.src_unlock)this.src_unlock();this.src_unlock=E.hacks.hide_source_change(this.html5,original_url,this.media_src_url)}if(this.config.lock_reload_request)this.load_unlock=E.hacks.lock_reload_request(this.html5,this.log);this.seek_fix_uninit=E.hacks.seek_jump_workaround(this);var _this=this;if(played){var promise=this.html5.play();if(promise&&promise.catch){promise.catch(function(err){if(err&&err.name=="AbortError")setTimeout(function(){_this.html5.play()})})}}if(!this.config.disable_ended_fallback){this.schedule_end_of_stream_check=function(e){var html5=_this.html5,_ct=html5.currentTime;_this.end_of_stream_timer=clearTimeout(_this.end_of_stream_timer);if(!html5.duration||html5.duration-_ct>.25)return;_this.end_of_stream_timer=setTimeout(function(){var ct=html5.currentTime;if(!html5.duration||!ct||html5.ended&&ct!=_ct||html5.duration-ct>.25){return}perr({id:"html5_ended_fallback",add_log:true,info:{seeking:html5.seeking,last_event:e.type}});html5.dispatchEvent(util.new_event(e.type=="stalled"&&html5.seeking?"timeupdate":"ended"))},500)};html5_on(this.html5,"timeupdate",this.schedule_end_of_stream_check);html5_on(this.html5,"stalled",this.schedule_end_of_stream_check)}this.on_sourceopen=function(e){_this.pending_sourceopen=false;return on_sourceopen(this.media_src,e)}.bind(this);this.media_src.addEventListener("sourceopen",this.on_sourceopen);if(this.media_src.readyState=="open")this.on_sourceopen(this.media_src);this.last_pos=this.metadata=this.stalled=undefined;this.nudge_retry=0});E.Player.prototype.disable_data_mode=function(){if(!this.media_src)return;if(this.load_unlock)this.load_unlock();if(this.seek_fix_uninit)this.seek_fix_uninit();this.media_src.removeEventListener("sourceopen",this.on_sourceopen);if(this.schedule_end_of_stream_check){this.end_of_stream_timer=clearTimeout(this.end_of_stream_timer);html5_off(this.html5,"timeupdate",this.schedule_end_of_stream_check);html5_off(this.html5,"stalled",this.schedule_end_of_stream_check)}this.media_src=this.media_src_url=this.pending_sourceopen=this.schedule_end_of_stream_check=this.on_sourceopen=this.load_unlock=undefined};util.module_fn(E,function is_playing(){if(this.is_idle())return false;return!this.html5.paused});util.module_fn(E,function is_paused(){if(this.is_idle())return false;if(zutil.is_mocha())return this.html5.paused;return this.paused});E.Player.prototype.get_decoded_frames=function(){return E.get_decoded_frames(this.html5)};E.Player.prototype.get_dropped_frames=function(){return E.get_dropped_frames(this.html5)};E.Player.prototype.check_buffer=function(opt){E.check_buffer.call(this,this.html5,opt)};util.module_fn(E,function get_captions_track(){for(var i=0;i<this.html5.textTracks.length;i++){if(this.html5.textTracks[i].mode=="showing")return i}return-1});util.module_fn(E,function set_captions_track(track){for(var i=0;i<this.html5.textTracks.length;i++)this.html5.textTracks[i].mode="disabled";if(track>=0)this.html5.textTracks[track].mode="showing"});util.module_fn(E,function is_idle(){return this.state=="IDLE"});util.module_fn(E,function get_ui(){var ui={};if(this.custom.get_ui)ui=this.custom.get_ui();return Object.assign({container:this.html5,fullscreen:this.html5,media:this.html5},ui)});util.module_fn(E,function get_levels(){});util.module_fn(E,function get_playlists(){});util.module_fn(E,function get_current_playlist(){});util.module_fn(E,function get_segment_info(){});util.module_fn(E,function get_bitrate(){return 0});util.module_fn(E,function is_bitrate_supported(){return true});util.module_fn(E,function init_adaptive(){});util.module_fn(E,function is_live_stream(){return Infinity==this.get_duration()});util.module_fn(E,function get_current_level(){});util.module_fn(E,function ondata_adaptive(){});util.module_fn(E,function get_current_fragment(){});util.module_fn(E,function is_autostart(){if(this.custom.is_autostart)return this.custom.is_autostart();return this.html5.autoplay});E.Player.prototype.get_bandwidth=function(){return 0};E.Player.prototype.get_caps=function(){return player_util.Player.prototype.get_caps({save_context:["progressive"]})};E.Player.prototype.get_est_bytes=function(){var res=null;if(this.module)res=this.module.get_est_bytes();if(!res)res=E.est_bytes_from_tag(this.html5);return res};E.Player.prototype.get_current_error=function(){return html5_get_error(this)};E.Player.prototype.play_src=function(src){src=src[0].file||src[0].url;if(this.custom.play_src)return this.custom.play_src(src);this.html5.src=src;this.html5.load();this.html5.play()};E.Player.prototype.is_ad_source=function(url){return this.custom.is_ad_source&&this.custom.is_ad_source(url)||util.call_super(E,this,"is_ad_source",url)};E.Player.prototype.is_ad_active=function(){if(this.custom.is_ad_active)return this.custom.is_ad_active();return util.call_super(E,this,"is_ad_active")};E.Player.prototype.is_ad_paused=function(){if(this.custom.is_ad_paused)return this.custom.is_ad_paused();return util.call_super(E,this,"is_ad_paused")};E.Player.prototype.ad_play=function(){if(this.custom.ad_play)return this.custom.ad_play();return util.call_super(E,this,"ad_play")};E.Player.prototype.ad_pause=function(){if(this.custom.ad_pause)return this.custom.ad_pause();return util.call_super(E,this,"ad_pause")};E.Player.prototype.get_player=function(){return this.html5};E.Player.prototype.get_versions=function(){var versions={};if(this.custom.get_versions)Object.assign(versions,this.custom.get_versions());if(this.module&&this.module.get_versions)Object.assign(versions,this.module.get_versions());return Object.keys(versions).length?versions:null};E.Player.prototype.fullscreen=function(v){function get(obj,list){for(var i in list){if(obj[list[i]]===undefined)continue;return typeof obj[list[i]]=="function"?obj[list[i]].bind(obj):obj[list[i]]}}var current_fs=get(document,["fullscreenElement","webkitFullscreenElement","mozFullScreenElement","msFullscreenElement"]);if(v===undefined)return current_fs;var player_fs=this.get_ui().fullscreen;if(!current_fs){get(player_fs,["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"])()}else{get(document,["exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen"])()}};E.Player.prototype.scrubbing=function(is_scrubbing){if(is_scrubbing===undefined){return this.is_scrubbing||this.custom&&this.custom.is_scrubbing&&this.custom.is_scrubbing()}this.is_scrubbing=is_scrubbing};function html5_get_error(player){var err_map={1:{message:"download was cancelled",reason:"other"},2:{message:"network error",reason:"media_load"},3:{message:"decode error",reason:"media_decode"},4:{message:"source not supported",reason:"media_support"},5:{message:"encryption error",reason:"media_decode"},unknown:{message:"unknown",reason:"other"}};if(!player.html5.error)return;var code=player.html5.error&&player.html5.error.code;if(!E.get_video_source(player.html5)&&code==4)return;var info=err_map[code]||err_map.unknown;info.message=player.html5.error&&player.html5.error.message||info.message;if(player.config.ignore_other_error&&info.reason=="other"){player.log.err("ignoring other error");return}return{code:code,reason:info.reason,message:info.message}}function html5_wait_for_event(video,event,timeout,on_timeout){var timer;var _finally=function(_timeout){html5_off(video,event,_finally);if(timer)timer=void clearTimeout(timer);if(_timeout)on_timeout()};html5_on(video,event,_finally);timer=setTimeout(function(){_finally(true)},timeout)}function html5_proto(video){return zutil.is_mocha()?video:Object.getPrototypeOf(video)}function html5_on(video,event,cb){html5_proto(video).addEventListener.apply(video,[event,cb])}function html5_off(video,event,cb){html5_proto(video).removeEventListener.apply(video,[event,cb])}E.get_decoded_frames=function(video){if(!video)return;if(video.webkitDecodedFrameCount!==undefined)return video.webkitDecodedFrameCount;if(video.mozDecodedFrames!==undefined)return video.mozDecodedFrames};E.get_dropped_frames=function(video){if(video.webkitDroppedFrameCount!==undefined)return video.webkitDroppedFrameCount};E.get_video_source=function(video){if(!video)return"";var video_url,empty_src_re=/^#?$/;if(video_url=video.src){if(empty_src_re.test(video.getAttribute("src")))video_url=""}else if(video_url=video.currentSrc){var is_src=false;var s=Array.prototype.slice.call(video.querySelectorAll("source"));s.push(video);for(var i=0;i<s.length;i++){if(s[i].src!=video_url)continue;is_src=true;if(empty_src_re.test(s[i].getAttribute("src")))video_url="";break}if(!is_src)video_url=""}return video_url};E.get_hola_video_source=function(video){return video.hola_src||E.get_video_source(video)};E.dump_buffered=function(video){var str="",b=video.buffered,len=b.length;for(var i=0;i<len;i++)str+="["+b.start(i)+","+b.end(i)+"]";return str};E.at_init_position=function(video){return!video.buffered.length||video.currentTime==video.buffered.start(0)};E.est_bytes_from_tag=function(el){if(isFinite(el.webkitAudioDecodedByteCount)&&isFinite(el.webkitVideoDecodedByteCount)&&(el.webkitVideoDecodedByteCount!=0||el.currentTime==0)){return{bytes:el.webkitAudioDecodedByteCount+el.webkitVideoDecodedByteCount,src:"html5"}}return null};E.check_buffer=function(video,opt){if(!video.readyState)return;var ts,spos,_this=this,state=opt.state,pos=video.currentTime;var buf=video.buffered;if(!state.metadata&&buf.length&&buf.start(0)<buf.end(0)){spos=buf.start(0);if(pos==0&&pos!=spos){if(spos<.05&&!video.paused){ts=util.date_monotonic();if(!state.start_stalled){state.start_stalled=ts;return void setTimeout(function(){E.check_buffer.call(_this,video,opt)},100)}else if(ts-state.start_stalled<100)return}this.log.info("position "+pos+" not buffered, seek to "+spos);video.currentTime=spos}state.metadata=true;state.start_stalled=undefined}else if(state.metadata){if(pos!=state.last_pos){state.stalled=undefined;state.nudge_retry=0;state.last_pos=pos}else{if(video.paused||video.ended||!buf.length){state.nudge_retry=0;return state.stalled=undefined}ts=util.date_monotonic();if(!state.stalled)state.stalled=ts;else{var dur=ts-state.stalled,nudge_retry=state.nudge_retry||0;var bsec=opt.bws.sec_in_buffer(pos,true),conf=opt.conf;if(bsec>conf.bsec&&dur>conf.buf_wd*1e3){state.stalled=undefined;state.nudge_retry=++nudge_retry;if(nudge_retry<conf.max_nudge_retry){spos=pos+nudge_retry*conf.offset;this.log.info("adjust position from "+pos+" to "+spos);video.currentTime=spos}else{this.log.info("still stuck at "+pos+" after "+nudge_retry)}}}}}};E.on_ext_control=function(ctx,video,log_fn){if(!log_fn){ctx.ext_seek_hook=ctx.ext_seek_hook&&ctx.ext_seek_hook.remove();ctx.ext_load_hook=ctx.ext_load_hook&&ctx.ext_load_hook.remove();ctx.ext_pause_hook=ctx.ext_pause_hook&&ctx.ext_pause_hook.remove();ctx.ext_play_hook=ctx.ext_play_hook&&ctx.ext_play_hook.remove();ctx.ext_src_change_uninit=ctx.ext_src_change_uninit&&ctx.ext_src_change_uninit();return}ctx.ext_seek_hook=util.inject_hook(video,"currentTime",{set:function(e,args){log_fn("html5 poschange to "+args[0])}});ctx.ext_load_hook=util.inject_hook(video,"load",{exec:function(e,args){log_fn("html5 load")}});ctx.ext_pause_hook=util.inject_hook(video,"pause",{exec:function(e,args){log_fn("html5 pause")}});ctx.ext_play_hook=util.inject_hook(video,"play",{exec:function(e,args){log_fn("html5 play")}});ctx.ext_src_change_uninit=E.hacks.on_source_change(video,function(from,to,stack){log_fn("html5 sourcechange to "+(to||"<empty>"))})};E.hacks={};E.hacks.hide_source_change=function(video,facade_src,surrogate_src){E.polyfill.video_source_access(video);var src_hook_cb=function(e){if(hooks.src.original_handlers.get()!=surrogate_src)return;e.set_handled();return facade_src};var attr_hook_cb=function(e,args){if(args[0]!="src")return;var attr_src=hooks.attr.original_handlers.exec("src");if(util.absolute_uri(attr_src,true)!=surrogate_src)return;e.set_handled();return facade_src};var hola_src_hook_cb=function(e,args){e.set_handled();return hooks.src.original_handlers.get()};var hooks={src:util.inject_hook(video,"src",{get:src_hook_cb}),csrc:util.inject_hook(video,"currentSrc",{get:src_hook_cb}),attr:util.inject_hook(video,"getAttribute",{exec:attr_hook_cb}),hsrc:util.inject_hook(video,"hola_src",{get:hola_src_hook_cb})};E.hacks.lock_no_source_ns(video);return function(){Object.keys(hooks).forEach(function(name){hooks[name].remove()});if(!hooks.hsrc.count())delete video.hola_src}};E.hacks.on_source_change=function(video,cb){E.polyfill.video_source_access(video);var src_hook_cb=function(e,args){cb(E.get_hola_video_source(video),args[0],util.stack_to_pprint((new Error).stack))};var attr_hook_cb=function(e,args){if(args[0]!="src")return;cb(E.get_hola_video_source(video),args[1],util.stack_to_pprint((new Error).stack))};var hooks={src:util.inject_hook(video,"src",{set:src_hook_cb}),attr:util.inject_hook(video,"setAttribute",{exec:attr_hook_cb})};return function(){Object.keys(hooks).forEach(function(name){hooks[name].remove()})}};E.hacks.lock_reload_request=function(video,log){return E.hacks.on_reload_request(video,function(e,args){if(args[0]&&args[0].hola_force)return;e.set_handled();log.info("video.load() call intercepted/ignored, call stack: "+(new Error).stack)})};E.hacks.on_reload_request=function(video,cb){var lock_url=E.get_hola_video_source(video);var hook=util.inject_hook(video,"load",function(e,args){if(E.get_hola_video_source(video)==lock_url)cb(e,args)});return hook.remove.bind(hook)};E.hacks.lock_no_source_ns=function(video){if(CG("loader.html5.disable_ns_lock"))return;var hook=util.inject_hook(video,"networkState",{get:function(e){e.set_handled();var ns=hook.original_handlers.get();return ns==video.NETWORK_NO_SOURCE?video.NETWORK_LOADING:ns}});setTimeout(hook.remove.bind(hook))};E.hacks.seek_jump_workaround=function(player){var video=player.html5,last_seeking_pos,last_fixup_pos;if(!(util.is_safari&&video&&video.hasAttribute("controls"))||CG("loader.html5.disable_seek_jump_fix")){return}function seek_start(){last_seeking_pos=video.currentTime}function seek_complete(){if(last_seeking_pos==last_fixup_pos)return last_seeking_pos=last_fixup_pos=undefined;var pos=player.get_pos();var buf_now=player.get_current_buffer(pos);var buf_seek=player.get_current_buffer(last_seeking_pos);if(buf_now.from==buf_seek.from)return last_seeking_pos=last_fixup_pos=undefined;player.log.info("pos jump detected: "+last_seeking_pos+"["+buf_seek.from+";"+buf_seek.to+"] > "+pos+"["+buf_now.from+";"+buf_now.to+"], reseek now");video.currentTime=last_fixup_pos=buf_seek.from}html5_on(video,"seeking",seek_start);html5_on(video,"seeked",seek_complete);return function(){html5_off(video,"seeking",seek_start);html5_off(video,"seeked",seek_complete)}};E.polyfill={};E.polyfill.video_source_access=function(video){var pd=Object.getOwnPropertyDescriptor(video,"src");if(pd&&!pd.configurable)return false;if(!util.is_safari||util.gconf_get("loader.html5.disable_video_src_polyfill")){return true}var proto=video;while(!proto.hasOwnProperty("src")&&(proto=Object.getPrototypeOf(proto)));if(!proto||!(pd=Object.getOwnPropertyDescriptor(proto,"src"))||pd.get||pd.hasOwnProperty("value")){return true}var orig_set_attr=video.setAttribute,orig_get_attr=video.getAttribute;Object.defineProperty(video,"src",{configurable:true,enumerable:true,set:function(value){orig_set_attr.call(this,"src",value)},get:function(){var src=orig_get_attr.call(this,"src");return src!=null?util.absolute_uri(src,true):""}});perr({id:"html5_source_polyfill"});return true};function get_conf_custom_ops(player_type,instance){var ops_fn;if(!(ops_fn=CG("loader.autodetect."+player_type+".custom_ops")))return;try{if(typeof ops_fn=="string")ops_fn=new Function("instance","$","util",ops_fn);return ops_fn(instance,$,util)}catch(e){}}E.get_handler=function(Player,log,autodetect){return{rels:{shaka:"mod",dashjs:"mod"},ext_handlers:[],get_instances:function(elements){var custom_elements_fn,custom_elements;if(custom_elements_fn=CG("loader.autodetect.custom_video_elements")){custom_elements=custom_elements_fn()}var ext_elements=[];this.ext_handlers.forEach(function(get_instances_fn){ext_elements=ext_elements.concat(get_instances_fn().filter(function(el){return!elements.includes(el)}))});return util.array_unique(elements.filter(function(el){return el.tagName=="VIDEO"}).concat(custom_elements||[]).concat(ext_elements))},validate:function(el){var ignore=CG("loader.autodetect.ignore");var ignore_sel=CG("loader.autodetect.html5.ignore_selector");if(CG("loader.autodetect.theoplayer")){ignore_sel=ignore_sel||"";var theoplayer=autodetect.player_handlers.theoplayer;if(theoplayer)ignore_sel+=", "+theoplayer.sel}return el.src!==undefined&&!(el.src&&el.src.startsWith("data:"))&&(!ignore||!RegExp(ignore).test(el.src))&&(!ignore_sel||!dom_util.matches(el,ignore_sel))&&!el.className.includes("hola_video_preview")&&!el.className.includes("hola_autoplay_muted_overlay")&&!el.className.includes("spark_newsreel_video")},normalize:function(instance){var _this=this;var custom_ops=get_conf_custom_ops("html5",instance);return new Player({setup:function(){if(this.is_ready())return;var __this=this;var cb=function(){if(__this._remove_ready_listeners&&__this.is_ready()){__this._remove_ready_listeners();__this.emit("ready")}};if(custom_ops&&custom_ops.on_ready){this._remove_ready_listeners=custom_ops.on_ready(cb);return}instance.addEventListener("loadstart",cb);instance.addEventListener("play",cb);var off;if(CG("loader.autodetect.html5.attach_no_source")){off=dom_util.dom_listen(instance.parentElement||instance,cb)}this._remove_ready_listeners=function(){instance.removeEventListener("loadstart",cb);instance.removeEventListener("play",cb);if(off)off();delete __this._remove_ready_listeners}},get_element:function(){return instance},is_ready:function(){if(custom_ops&&custom_ops.is_ready)return custom_ops.is_ready();if(instance.className.includes("video-js")||!_this.validate(instance)){return false}if(instance.hola_hls)return true;if(!CG("loader.autodetect.html5.ignore_preload")&&instance.preload=="none"&&!instance.autoplay&&instance.paused){return!!(E.get_video_source(instance)&&(instance.readyState||instance.networkState==2||instance.initNetworkState_==2))}var sel=CG("loader.autodetect.html5.attach_no_source");return!!(E.get_video_source(instance)||sel&&sel(instance,$))},get_opt:function(){var opt={html5:instance};if(custom_ops){opt.custom=get_conf_custom_ops("html5",instance)}return opt},destroy:function(){if(this._remove_ready_listeners)this._remove_ready_listeners()}})}}};return E});
define("/svc/cdn/pub/mode.js",["/svc/cdn/pub/log.js","/svc/cdn/pub/util.js","/svc/cdn/pub/cdn_util.js","/svc/cdn/pub/storage.js"],function(_log,util,cdn_util,storage){var E={};var log=_log.set_module("mode");var formats={mp4:"mp4",m4p:"mp4",m3u8:"hls",mpd:"dash",m4v:"mp4",f4m:"hds",flv:"flv",webm:"webm"};var matrix=function(){var mp4_holavjs_jw={windows:{"*":{chrome:{"*":"*"},opera:{"*":"*"},firefox:function(p){if(p.os_version=="xp")return"";return p.browser_version>=42?"*":"fl"},edge:{"*":"*"},ie:function(p){var bv=p.browser_version;return bv>=11&&p.os_version>=8?"*":bv>=10?"fl":""}}},linux:{"*":{chrome:{"*":"*"},opera:{"*":"fl"},firefox:{"*":"fl"}}},macos:{"*":{chrome:{"*":"*"},opera:{"*":"fl"},firefox:{"*":"fl"},safari:{"*":"*"}}},android:{"*":{chrome:{"*":"h5"}}}};var flv_holavjs_jw=function(p){return p.browser=="ie"&&(p.browser_version==9||p.browser_version==10&&p.os_version==8)?"":"fl"};var h5_if_ms=function(){return window.MediaSource?"h5":""};return{mp4:{hola_vjs:mp4_holavjs_jw,hola_vjs5:mp4_holavjs_jw,vjs6:mp4_holavjs_jw,flowplayer6:mp4_holavjs_jw,flowplayer7:mp4_holavjs_jw,clappr:mp4_holavjs_jw,kaltura:mp4_holavjs_jw,vjs:function(p){return p.browser=="firefox"||p.browser=="ie"||p.os=="linux"&&p.browser=="opera"?"":"h5"},jw:mp4_holavjs_jw,html5:function(p){if(p.browser=="firefox"&&p.os_version=="xp")return"";return h5_if_ms()},byteark:function(p){if(p.browser=="firefox"&&p.os_version=="xp")return"";return h5_if_ms()}},flv:{hola_vjs:flv_holavjs_jw,hola_vjs5:flv_holavjs_jw,jw:flv_holavjs_jw},hds:{hola_vjs:flv_holavjs_jw,hola_vjs5:flv_holavjs_jw},hls:{hola_vjs:function(p){return p.browser=="ie"&&p.browser_version==9?"":"fl"},hola_vjs5:function(p){return p.browser=="ie"&&p.browser_version==9?"":"*"},vjs4:function(p){return p.browser=="ie"&&p.browser_version==9?"":"*"},flowplayer6:function(){return"*"},flowplayer7:function(){return"*"},clappr:function(p){return p.browser=="ie"&&p.browser_version==9?"":"h5"},jw:function(p){return p.browser=="ie"&&p.browser_version==9||p.os=="windows"&&(p.os_version=="8"||p.os_version=="8.1")&&p.browser=="firefox"?"":"*"},dailymotion:function(p){return p.browser=="ie"&&p.browser_version==9?"":"h5"},byteark:function(p){return p.browser=="ie"&&p.browser_version==9?"":"h5"},kaltura:function(p){return p.browser=="ie"&&p.browser_version==9?"":"h5"}},dash:{dashjs:h5_if_ms,shaka:h5_if_ms,hola_vjs5:h5_if_ms,flowplayer6:h5_if_ms,flowplayer7:h5_if_ms},webm:{"*":function(p){return p.browser=="chrome"?"h5":""}}}}();function check_obj_path(obj,path,order){var part=path[order.shift()];if((obj=obj[part]||obj["*"])===undefined)return false;return order.length?typeof obj=="function"?obj(path):check_obj_path(obj,path,order):obj}function get_format(url){var ext=/(?:\.([^.\/?#]+))?([?#].*)?$/.exec(url)[1];return ext?formats[ext]:url}E.get_available_tech_by_env=function(path,order){return check_obj_path(matrix,path,order)};E.get_available_tech=function(url,player){function is_flash_enabled(){try{return!!new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){var mime="application/x-shockwave-flash";return!!(navigator.mimeTypes&&navigator.mimeTypes[mime]&&navigator.mimeTypes[mime].enabledPlugin)}}var guess=util.guess;var browser=util.browser;var path={format:get_format(url),player:player,os:guess.os,os_version:guess.version,browser:browser.opera?"opera":browser.browser,browser_version:browser.version};var order=["format","player","os","os_version","browser","browser_version"];var tech=E.get_available_tech_by_env(path,order.slice());log.notice("Available tech for ["+order.map(function(o){return path[o]}).join(", ")+"] is "+tech);switch(tech){case"fl":return{flash:is_flash_enabled(),html5:false};case"h5":return{flash:false,html5:true};case"*":return{flash:is_flash_enabled(),html5:true};default:return{flash:false,html5:false}}};E.is_ip_blacklisted=function(opt){var blacklist=opt.CG("loader.ip_blacklist")||[];if(util.geoip&&util.geoip.ip&&blacklist.includes(util.geoip.ip))return true};E.is_browser_supported=function(){var version=util.browser.version;if(!util.is_android&&!util.is_windows&&!util.is_linux&&!util.is_ios&&!util.is_mac&&!util.is_webos){return false}if(util.is_android&&util.guess.version<4.4)return false;if(util.is_webos&&util.cmp_version(version,"38")<0)return false;if(util.is_edge)return true;if(util.is_ie&&version>=(util.is_mobile?11:8))return true;if(util.is_chrome&&version>=(util.is_mobile?30:23))return true;if(util.is_firefox&&version>=(util.is_mobile?68:37))return true;if(util.is_opera&&version>=(util.is_mobile?30:15))return true;if(typeof version=="string")version=version.replace(/_/g,".");if(!util.is_safari)return false;return util.is_ios_sdk||util.cmp_version(version,"10")>=0};E.select_mode=function(opt){function storage_mode(){try{return storage.session_db.get("hola_mode")||storage.db.get("hola_mode")}catch(e){}}function debug_compatible_mode(){var debug_compatible;try{debug_compatible=storage.db.get("hola_debug_compatible_browser")}catch(e){}if(debug_compatible!=undefined)debug_compatible=debug_compatible||"disabled";return debug_compatible}function browser_rule_mode(r){if(r.browser&&r.browser!=util.browser_rule_s||r.os&&r.os!=util.guess.os&&r.os!="*"){return false}var rand=cdn_util.get_random("mode");var p=r.cdn||0;if(rand<p)return"cdn";p+=r.bwsaver||0;if(rand<p)return"bwsaver";p+=r.stats||0;if(rand<p)return"stats";return"disabled random"}function mode_create(mode,reason){mode=mode=="hola_cdn"?"cdn":mode=="origin_cdn"?"stats":mode;return{mode:mode,disabled_reason:mode=="disabled"?reason:null,disabled_help:mode=="disabled"&&reason}}var url=opt.location||location;try{url.toString()}catch(e){url=location}var CG=opt.CG,r_mode,mode;if(mode=util.get_spark_uri(url,"spark_disable"))r_mode=mode_create("disabled","uri");else if(opt.suspended){mode="stats";r_mode=mode_create(mode,"force_stats_on_suspended_account")}else if(opt.method=="hls"&&opt.hap_provider_loaded&&CG("provider.register_percent",100)){mode="stats";r_mode=mode_create(mode,"force_stats_on_hls")}else if(mode=util.get_spark_uri(url,"hola_mode"))r_mode=mode_create(mode,"uri");else if(mode=storage_mode())r_mode=mode_create(mode,"storage");else if(require.zdot("disabled"))r_mode=mode_create("disabled","conf");else if(mode=CG("loader.mode"))r_mode=mode_create(mode,"conf");else if(mode=debug_compatible_mode())r_mode=mode_create(mode,"debug_compatible");else if(!E.is_browser_supported())r_mode=mode_create("disabled","browser_unsupported");else if(E.is_ip_blacklisted(opt))r_mode=mode_create("disabled","ip_blacklist");else{var rl=opt.rules||CG("loader.rules")||[],ret;for(var i=0;i<rl.length&&!(ret=browser_rule_mode(rl[i]));i++);ret=(ret||"disabled no_browser_match").split(" ");r_mode=mode_create(ret[0],ret[1])}if(!["disabled","stats","bwsaver","cdn"].includes(r_mode.mode)){log.err("unknown mode="+r_mode.mode+", forcing disabled");r_mode=mode_create("disabled","mode_unknown")}return r_mode};E.get_avail_tech=function(url,player){if(player.startsWith("jwplayer"))player="jw";if(["hola_vjs5_10","vjs5_10","vjs5_16","vjs5","hola_player","brightcove"].includes(player)){player="hola_vjs5"}return E.get_available_tech(url,player)};return E});
define("/svc/cdn/pub/cdn_svc.js",{__stub:1});
define("/svc/cdn/pub/zjwplayer3.js",{__stub:1});

define("/svc/cdn/pub/ad_handlers.js",{__stub:1});
define("/svc/cdn/pub/vjs.js",{__stub:1});

define("/svc/cdn/pub/android.js",{__stub:1});
define("/svc/cdn/pub/youtube.js",{__stub:1});
define("filesaver",{__stub:1});
define("/svc/cdn/pub/flowplayer.js",{__stub:1});
define("/svc/cdn/pub/ios.js",["/svc/cdn/pub/util.js","/util/util.js","/svc/cdn/pub/player_util.js","/svc/cdn/pub/perr.js"],function(util,zutil,player_util,perr){var E={};var get_proxy=function(){return window.hola_ios_proxy||window.spark_ios_proxy};E.detected=function(){return get_proxy()};E.get_players=function(){var proxy=get_proxy();if(!proxy)return null;if(proxy.wrapper_attached)return proxy;var players=[];for(var id in proxy)players.push(proxy[id]);return players.length?players:null};E.Player=function(opt){util.call_super(E,this,null,opt);var _this=this;this.name="ios";this.tech="native";this.proxy=opt.ios;this.player_id=this.proxy&&this.proxy.proxy_id?this.proxy.proxy_id:opt.player_id||1;this.state=this.proxy.get_state();if(this.proxy.get_app_label)this.app_name=this.proxy.get_app_label();if(this.proxy.is_ad_playing)this.ad_in_progress=this.proxy.is_ad_playing();this.log=player_util.log(opt.log,"ios");this.swf={hola_fetchBin:function(o){return{id:_this.proxy.fetch(o.url,o.jsurlstream_req_id,o.rate)}},hola_fetchBinRemove:function(id){_this.proxy.fetch_remove(id)},hola_onFragmentData:function(){},hola_settings:function(opt){return _this.proxy.settings(opt)}};this.flash_api=player_util.build_flash_api(this);var delegate={id:opt.player_id,on_play:function(){_this.state="PLAYING";_this.emit("play")},on_pause:function(){_this.state="PAUSED";_this.emit("pause")},on_idle:function(){_this.state="IDLE";_this.emit("ended")},on_ad_suspend:function(){_this.ad_in_progress=true;_this.emit("ad_suspend");_this.emit("ad_start");_this.emit("ad_play")},on_ad_restore:function(){_this.ad_in_progress=false;_this.emit("ad_restore")},on_timeupdate:function(pos){if(_this.state=="SEEKED")_this.state="PLAYING";_this.emit("timeupdate",pos)},on_seeking:function(){_this.state="SEEKING";_this.emit("seeking")},on_seeked:function(){_this.state="SEEKED";_this.emit("seeked")},on_ended:function(){_this.state="IDLE";_this.emit("ended")},on_error:function(reason){_this.emit("error",{reason:reason})},perr:function(id,data){perr({id:id,info:data})},req:function(data){var req=data.url;var video_type=_this.get_video_type_name(req);if(!_this.cdn_mode||!data.force&&video_type=="hls")_this.proxy.fetch(req,data.req_id);else{data.id="hola.requestFragment";data.player_id=_this.player_id;window.postMessage(data,"*")}},stream_open:function(data){window.postMessage({id:"holaflash.streamOpen",fb_id:data.req_id,player_id:_this.player_id},"*")},stream_response:function(data){window.postMessage({id:"holaflash.streamHttpStatus",fb_id:data.req_id,status:data.status,ms_hdrs:data.ms,player_id:_this.player_id},"*")},stream_progress:function(data){var req_id=data.req_id;window.postMessage({id:"holaflash.streamProgress",player_id:_this.player_id,fb_id:req_id,bytesTotal:data.total,bytesLoaded:data.loaded},"*")},stream_complete:function(data){var req_id=data.req_id;window.postMessage({id:"holaflash.streamComplete",fb_id:req_id,player_id:_this.player_id},"*")},stream_error:function(data){window.postMessage({id:"holaflash.streamError",fb_id:data.req_id,player_id:_this.player_id},"*")}};this.on("wrapper_attached",this.on_attached=function(){_this.off("wrapper_attached",_this.on_attached);_this.proxy.delegate=delegate;_this.emit("started",_this.get_url());_this.proxy.wrapper_attached()})};zutil.inherits(E.Player,player_util.Player);E.Player.prototype.uninit=function(){this.proxy.uninit();this.proxy.delegate=null};E.Player.prototype.get_url=function(){return this.proxy.get_url()};E.Player.prototype.get_duration=function(){var duration=this.proxy.get_duration();return duration===-1?Infinity:duration||0};E.Player.prototype.get_pos=function(){return this.proxy.get_pos()};E.Player.prototype.refresh_buffered=function(){};E.Player.prototype.is_live_stream=function(){return false};E.Player.prototype.is_ad_playing=function(){return!!this.ad_in_progress};E.Player.prototype.get_state=function(){return this.is_ad_playing()?"PAUSED":this.state};E.Player.prototype.is_playing=function(){return this.get_state()=="PLAYING"};E.Player.prototype.is_paused=function(){return this.get_state()=="PAUSED"};E.Player.prototype.is_idle=function(){return this.get_state()=="IDLE"};E.Player.prototype.is_autostart=function(){return false};E.Player.prototype.get_buffered=function(){var ranges=this.proxy.get_buffered();return{length:ranges.length,start:function(i){return ranges[i].start},end:function(i){return ranges[i].end}}};E.Player.prototype.get_bitrate=function(){return this.proxy.get_bitrate()};E.Player.prototype.get_ui=function(){return{}};E.Player.prototype.get_levels=function(cached){return cached&&this.levels?this.levels:this.levels=this.proxy.get_levels()};E.Player.prototype.get_playlists=function(){};E.Player.prototype.get_current_playlist=function(with_segments){};E.Player.prototype.get_current_level=function(){};E.Player.prototype.get_current_fragment=function(){};E.Player.prototype.get_bandwidth=function(){return this.proxy.get_bandwidth()};E.Player.prototype.get_segment_info=function(url){return this.proxy.get_segment_info(url)};E.Player.prototype.seek=function(ms){};E.Player.prototype.play=function(){};E.Player.prototype.pause=function(){};E.Player.prototype.play_url=function(url,opt){};E.Player.prototype.set_cdn_mode=function(on){this.cdn_mode=!!on};E.Player.prototype.enable_data_mode=function(on_sourceopen){};E.Player.prototype.disable_data_mode=function(){};E.Player.prototype.init_adaptive=function(){};E.Player.prototype.ondata_adaptive=function(){};E.Player.prototype.get_decoded_frames=function(){};E.Player.prototype.get_dropped_frames=function(){};E.Player.prototype.get_resolution=function(){};E.get_handler=function(Player){return{init:function(ctrl){window.hola_cdn.api.ios_ready=function(){ctrl.emit("resync")};ctrl.once("uninit",function(){window.hola_cdn.api.ios_ready=undefined})},get_instances:function(){return E.get_players()},normalize:function(instance){return new Player({get_element:function(){return instance},get_opt:function(){return{ios:instance}}})}}};E.t={mocha_setup:function(opt){perr=opt.perr||perr}};return E});
define("/svc/cdn/pub/hola_vjs.js",{__stub:1});
define("/svc/cdn/pub/buffer_monitor.js",["/svc/cdn/pub/util.js","/svc/cdn/pub/perr.js"],function(util,perr){var E={};var CG=util.gconf_get;var defaults={buffer_threshold:20,poll_period:500};E.PlayerExtension=function(player){if(!(this instanceof E.PlayerExtension))return new E.PlayerExtension(player);this.config=Object.assign({},defaults,CG("loader.player.extension.buffer_monitor"));this.player=player;this.enabled=0;this.buffer_poll=this.try_wrapper(function(){var duration;if(!(duration=this.player.get_duration()))return;var last_state=this.state;var buf=this.player.get_current_buffer();if(duration-buf.to>0){var buffer_len=buf.to-this.player.get_pos();this.state=buffer_len>=this.config.buffer_threshold?"buffer_full":buffer_len<=this.config.buffer_threshold-5?"buffer_low":last_state=="buffer_full"?"buffer_full":"buffer_low"}else this.state="buffer_loaded";if(this.state!=last_state)this.player.emit("buffer_monitor",this.state)});this.on_player_state=this.try_wrapper(function(){this.run(!this.player.is_idle())});this.run=function(run){if(!(run^this.running))return;this.state=undefined;this.running=run;if(run){this.buffer_poll_interval=setInterval(this.buffer_poll,this.config.poll_period);this.buffer_poll()}else{this.buffer_poll_interval=clearInterval(this.buffer_poll_interval)}}};E.PlayerExtension.prototype.enable=function(){if(this.enabled++)return;this.player.on("state",this.on_player_state);if(!this.player.is_idle())this.run(true)};E.PlayerExtension.prototype.disable=function(force_close){if(!force_close&&(!this.enabled||--this.enabled))return;this.run(false);this.player.off("state",this.on_player_state)};E.PlayerExtension.prototype.try_wrapper=function(func){return perr.try_wrapper({prefix:"buffer_monitor"},func.bind(this))};E.PlayerExtension.prototype.uninit=function(){this.disable(true)};return E});
define("/svc/cdn/pub/airplay.js",["/svc/cdn/pub/util.js","/svc/cdn/pub/perr.js"],function(util,perr){var E={};var CG=util.gconf_get,assign=Object.assign;var fake_airplay=util.get_spark_uri("hola_fake_airplay");E.api={events:{avail_changed:"webkitplaybacktargetavailabilitychanged",target_changed:"webkitcurrentplaybacktargetiswirelesschanged"},is_available:function(){return fake_airplay||!!window.WebKitPlaybackTargetAvailabilityEvent},show_menu:function(video){if(fake_airplay)return;video.webkitShowPlaybackTargetPicker()},is_disabled:function(video){return video.webkitWirelessVideoPlaybackDisabled||util.is_blob_url(video.currentSrc||video.src)},is_casting:function(video){return!!video.webkitCurrentPlaybackTargetIsWireless}};E.PlayerExtension=function(player){if(!(this instanceof E.PlayerExtension))return new E.PlayerExtension(player);this.player=player;this.config=CG("loader.player.extension.airplay",{});this.shutdown=!E.api.is_available()||!player.html5||this.config.disabled;this.enabled_count=0};E.PlayerExtension.prototype.enable=function(){if(this.shutdown||this.enabled_count++)return;var player=this.player,video=this.player.html5;player.airplay={available:false,casting:false,show_menu:E.api.show_menu.bind(E.api,video)};this.avail_changed_cb=this.try_wrapper(function(e){var now_available=e.availability=="available";if(now_available==player.airplay.available)return;player.airplay.available=now_available;player.emit("airplay.availability",assign({},player.airplay))});this.casting_changed_cb=this.try_wrapper(function(){var now_casting=E.api.is_casting(video);if(now_casting==player.airplay.casting)return;player.airplay.casting=now_casting;player.emit("airplay.casting",assign({},player.airplay))});this.init_timer=setTimeout(this.try_wrapper(function(){this.init_timer=undefined;video.addEventListener(E.api.events.avail_changed,this.avail_changed_cb);video.addEventListener(E.api.events.target_changed,this.casting_changed_cb);this.casting_changed_cb();if(fake_airplay)this.avail_changed_cb({availability:"available"})}),0)};E.PlayerExtension.prototype.disable=function(force_close){if(this.shutdown||!force_close&&--this.enabled_count)return;this.enabled_count=0;if(this.init_timer)return this.init_timer=clearTimeout(this.init_timer);var video=this.player.html5;video.removeEventListener(E.api.events.avail_changed,this.avail_changed_cb);video.removeEventListener(E.api.events.target_changed,this.casting_changed_cb)};E.PlayerExtension.prototype.try_wrapper=function(func){return perr.try_wrapper({prefix:"airplay"},func.bind(this))};E.PlayerExtension.prototype.uninit=function(){this.disable(true);this.shutdown=true};return E});
define("/svc/cdn/pub/ooyala.js",{__stub:1});
define("/svc/cdn/pub/akamai.js",{__stub:1});
define("/svc/cdn/pub/custom_player.js",["cash","/svc/cdn/pub/util.js","/util/util.js","/svc/cdn/pub/html5.js","/svc/cdn/pub/player_util.js"],function($,util,zutil,html5,player_util){var E={};var CG=util.gconf_get;var assign=Object.assign;E.Player=function(opt){util.call_super(E,this,undefined,opt);this.custom_player=custom_player_polyfill(opt.custom);this.name="custom";this.tech="unknown";this.log=player_util.log(opt.log,"custom_player");this.custom_events=["ad_suspend","ad_start","ad_play","ad_restore","ready"];this.custom_events.forEach(function(e){this["on_"+e]=this.emit.bind(this,e);this.custom_player.on(e,this["on_"+e])},this);this._reconf(opt);if(opt.reconf_notifier)opt.reconf_notifier.on("update",this._reconf.bind(this));this.custom_player.init(this)};zutil.inherits(E.Player,player_util.Player);Object.keys(html5.Player.prototype).forEach(function(m){E.Player.prototype[m]=function(){if(this.engine)return this.engine[m].apply(this.engine,arguments);return util.call_super(E,this,m)}});["is_ready","is_autostart","is_idle","is_playing","is_paused","is_live_stream","is_interrupted","is_seeking","is_ad_active","is_ad_loading","is_ad_playing","is_ad_paused","is_controlbar_visible","is_bitrate_supported","play","pause","seek","muted","volume","ad_play","ad_pause","play_url","play_src","check_seekable","fullscreen","captions_supported","enable_context_menu","disable_context_menu","set_controlbar_visible","set_captions_track","get_state","get_pos","get_duration","get_media_type","get_media_size","get_caps","get_player","get_poster","get_ad_scheme","get_captions_track","get_playlist_url","get_title","get_description","get_decoded_frames","get_dropped_frames","get_current_error","get_buffered","get_resolution","get_bandwidth","get_est_bytes"].forEach(function(m){E.Player.prototype[m]=function(){if(this.custom_player[m])return this.custom_player[m].apply(this.custom_player,arguments);if(this.engine)return this.engine[m].apply(this.engine,arguments);return util.call_super(E,this,m)}});E.Player.prototype.uninit=function(){this.custom_events.forEach(function(e){this.custom_player.off(e,this["on_"+e])},this);this.custom_player.uninit();this._reconf()};E.Player.prototype.get_versions=function(){var versions=assign({},this.custom_player.get_versions());if(this.engine)assign(versions,this.engine.get_versions());return versions};E.Player.prototype.get_url=function(){var src;if(this.engine&&(src=this.engine.get_url())&&!util.is_blob_url(src))return src;if(src=this.custom_player.get_url())return src;return util.call_super(E,this,"get_url")};E.Player.prototype.get_ui=function(){var ui={};if(this.engine)assign(ui,this.engine.get_ui());assign(ui,this.custom_player.get_ui());return ui};E.Player.prototype.scrubbing=function(is_scrubbing){if(is_scrubbing===undefined)return this._is_scrubbing||this.custom_player.is_scrubbing();this._is_scrubbing=is_scrubbing;if(this.engine&&typeof this.engine.is_scrubbing=="function")this.engine.is_scrubbing(is_scrubbing)};E.Player.prototype.is_ad_source=function(url){return this.custom_player.is_ad_source(url)||util.call_super(E,this,"is_ad_source",url)};E.Player.prototype._reconf=function(opt){opt=opt||{};if(this._reconf_delayed){this.off("ready",this._reconf_delayed);this._reconf_delayed=undefined}if(this.engine){this.engine_events_uninit();this.engine.uninit();this.engine=this.html5=undefined;this.tech="unknown"}if(!this.is_ready()){this._reconf_delayed=this._reconf.bind(this,opt);return this.on("ready",this._reconf_delayed)}if(opt.html5){this.engine=new Html5Engine(opt);this.engine_events_uninit=this._bind_events_to(this.engine);this.tech="html5";this.html5=opt.html5;if(!this.engine.is_idle())this.emit("started")}this.emit("reconf")};E.Player.prototype._bind_events_to=function(engine){var _this=this;var events=["started","state","seeking","seeked","waiting","timeupdate","duration_changed","pause","play","error","interrupted","ended"];if(engine.module){(engine.module.event_list||[]).forEach(function(e){if(!events.includes(e))events.push(e)})}var handlers=events.map(function(e){return{event:e,cb:_this.emit.bind(_this,e)}});handlers.forEach(function(h){engine.on(h.event,h.cb)});return function(){handlers.forEach(function(h){engine.off(h.event,h.cb)})}};zutil.inherits(Html5Engine,html5.Player);function Html5Engine(opt){this.custom_player=opt.custom||{};util.call_super(Html5Engine,this,undefined,zutil.omit(opt,"custom"))}function custom_player_polyfill(player){var always_true=function(){return true},noop=function(){};var defaults={is_ready:always_true,get_versions:noop,get_ui:noop,is_scrubbing:noop,is_ad_source:noop,on:noop,off:noop,init:noop,uninit:noop};Object.keys(defaults).forEach(function(key){if(!player[key])player[key]=defaults[key]});return player}E.get_handler=function(Player){return{get_instances:function(){var get;if(get=CG("loader.autodetect.custom_player.get_instances"))return get($,util)},normalize:function(instance){var get_opt=CG("loader.autodetect.custom_player.get_opt")||function(){};var get_opt_all=CG("loader.autodetect.custom_player.get_opt_all");return new Player({get_element:function(){return document.body.contains(instance)&&instance},get_opt:function(){if(get_opt_all)return get_opt_all(instance,$,util);return{custom:assign({custom_player:true},get_opt(instance,$,util))}}})}}};return E});
define("/svc/cdn/pub/wrapper.js",["/util/es6_shim.js","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/zjwplayer3.js","/svc/cdn/pub/vjs.js","/svc/cdn/pub/html5.js","/svc/cdn/pub/android.js","/svc/cdn/pub/youtube.js","/util/events.js","filesaver","/svc/cdn/pub/flowplayer.js","/svc/cdn/pub/load_perf.js","/svc/cdn/pub/ios.js","/svc/cdn/pub/hola_vjs.js","/svc/cdn/pub/buffer_monitor.js","/svc/cdn/pub/airplay.js","/svc/cdn/pub/ooyala.js","/svc/cdn/pub/akamai.js","/svc/cdn/pub/custom_player.js","/svc/cdn/pub/perr.js"],function(shim,zutil,util,zjwplayer,vjs,html5,android,youtube,events,filesaver,flowplayer,load_perf,ios,hola_vjs,buffer_monitor,airplay,ooyala,akamai,custom_player,perr){var CG=util.gconf_get;var try_wrapper_n=0,try_wrapper_err;function try_wrapper(opt,func,ctx){opt=opt||{};if(typeof opt=="function"){ctx=func;func=opt;opt={}}var perr_id="wrapper_typeerror";var _this=ctx||this;var wrapped_func=function(){try{try_wrapper_n++;return func.apply(this,arguments)}catch(e){try{var need_perr=!try_wrapper_err&&!e.try_wrapper;try_wrapper_err=true;if(need_perr){perr({id:perr_id,err:""+e.message,bt:e.stack,use_beacon:true,add_log:CG("loader.wrapper.report_typeerror")});this.log.err("detach, wrapper typeerror "+(e.stack||e));if(this.attached)this.detach({err:"typeerror"});e.try_wrapper=true}}catch(e2){console.error("try_wrapper first err",e);console.error("try_wrapper second err",e2);perr({id:"wrapper_try_"+perr_id,err:""+e2.message,bt:e2.stack})}if(opt.can_throw)throw e}finally{try_wrapper_n--;if(!try_wrapper_n)try_wrapper_err=false}};return opt.method?wrapped_func:wrapped_func.bind(_this)}function define_ext(name,obj){if(!obj||require.specified(name))return;this.log.info("reusing external library "+name);define(name,function(){return obj})}zutil.inherits(Wrapper,events.EventEmitter);Wrapper.prototype.new_context=function(){var _this=this;var video_ctx=this.video_ctx=new util.events;video_ctx.video_url=this.video_url;video_ctx.video_type=this.video_type;video_ctx.safe_env=function(cb){var stash_predicate=function(_s){return _s.video_ctx==video_ctx};var s;if(!(s=_this.stash.find(stash_predicate)))return cb();var restore_env=_this.replace_env(s);cb();restore_env()};this.last_video_ctx=undefined;this.video_init();this.log.info("creating video context for "+video_ctx.video_url);this.emit("context_created",video_ctx)};Wrapper.prototype.remove_context=function(video_ctx){if(video_ctx&&this.video_ctx!=video_ctx)return;this.last_video_ctx=this.video_ctx;this.video_ctx=undefined};Wrapper.prototype.uninit_prev=function(opt){opt=opt||{};opt.video_ctx=opt.video_ctx||this.video_ctx;if(!opt.video_ctx)return;this.log.info("closing video context for "+opt.video_ctx.video_url);opt.video_ctx.emit("shutdown",{err:opt.err});this.remove_context(opt.video_ctx)};Wrapper.prototype.verify_attached=function(is_attached){if(!!this.attached!=!!is_attached)return false;var s=is_attached?"already":"not";this.log.info("wrapper.js "+s+" attached to player");perr({id:"wrapper_"+s+"_attached"});return-1};Wrapper.prototype.check_skip_video=function(video_url){var skip_reasons={};if(util.is_blob_url(video_url||this.video_url)){this.log.err("media source url found instead of real video url: "+"probably html5 module not detected");skip_reasons.missing_url="video url not detected"}if(util.get_spark_uri("hola_skip"))skip_reasons.forced_by_uri="skip enforced from page uri";return skip_reasons};Wrapper.prototype.video_init=function(){var video_ctx=this.video_ctx;var video_type=this.player.get_video_type_name(this.video_url);this.adaptive=video_ctx.adaptive=util.get_adaptive_by_type(video_type);this.method=video_ctx.method=util.is_progressive(video_type)?"progressive":this.adaptive=="hls"&&this.player.hap_enabled()?"hap_hls":util.get_method_type(video_type);this.video_check_n=(this.video_check_n||0)+1;if(this.video_check_n>1)this.log.reset_logs();var page_url=util.page2cache(util.get_top_url());if(page_url!=this.page_url){this.page_url=page_url;this.video_seq_n=0;this.video_seq_url=undefined}if(!this.player.is_ad_source()&&this.video_url!=this.video_seq_url){this.video_seq_n++;this.video_seq_url=this.video_url}};Wrapper.prototype.save_context=function(){var supported=this.player.get_caps().save_context;if(!this.video_url||this.player.is_ad_source()||this.player.tech!="html5"||!supported.includes(this.method)){return}this.log.notice("saving interrupted context for "+this.video_url);this.video_ctx.emit("suspend");this.stash.push({video_url:this.video_url,video_check_n:this.video_check_n,video_ctx:this.video_ctx,player_restore:this.player.stash&&this.player.stash(),log_restore:this.log.stash()});this.remove_context()};Wrapper.prototype.restore_context=function(opt){var stash,url=this.video_url;if(!(stash=this.stash.find(function(s){return s.video_url==url})))return;this.stash.splice(this.stash.indexOf(stash),1);if(stash.video_check_n<this.video_check_n)stash.log_restore();if(stash.player_restore)stash.player_restore();this.video_ctx=stash.video_ctx;this.log.notice("restoring context for "+this.video_url);this.video_ctx.emit("restore",opt);return true};Wrapper.prototype.replace_env=function(s){var orig_env=[this.log.stash(),function(ctx){this.video_ctx=ctx}.bind(this,this.video_ctx)];this.video_ctx=s.video_ctx;s.log_restore();return function(){orig_env.forEach(function(restore_cb){restore_cb()})}};Wrapper.prototype.uninit_saved_context=function(){var _this=this;this.stash.forEach(function(s){s.video_ctx.safe_env(function(){_this.log.notice("shutting down suspended context for "+s.video_url);_this.uninit_prev({video_ctx:s.video_ctx})})});this.stash=[]};Wrapper.prototype.attach=try_wrapper({method:true},function(opt){load_perf.push("wrapper_attach_start");var _this=this;this.stash=[];if(this.verify_attached(true))return;this.attached=true;var player=this.player=opt.player_obj;player.extensions={buffer_monitor:util.is_enabled(buffer_monitor)&&new buffer_monitor.PlayerExtension(player),airplay:util.is_enabled(airplay)&&new airplay.PlayerExtension(player)};this.log.notice("wrapper attached to player "+player.name+" "+player.tech);function attach_to_player(o){load_perf.push("wrapper_attach_to_player_start");_this.uninit_prev();o=o||{};_this.video_url=util.absolute_uri(o.url||player.get_url());_this.video_type=player.get_video_type();if(!_this.video_url)return perr({id:"wrapper_attach_to_player_no_url"});if(_this.restore_context())return perr({id:"wrapper_restore_cdn_context"});_this.new_context();_this.video_ctx.emit("started",{init_not_idle:o.init_not_idle})}this.on_started=try_wrapper(function(url){attach_to_player({url:url})},this);this.on_ended=try_wrapper(function(e){this.uninit_prev();if(e&&e.full_complete)this.uninit_saved_context()},this);this.on_state=try_wrapper(function(e){if(!player.is_idle()||player.is_ad_active())return;this.uninit_prev()},this);this.on_error=try_wrapper(function(e){e.stack=util.stack_to_pprint((new Error).stack);this.log.err("player error"+(e.hola_dont_detach?" (non fatal)":"")+": "+(e.message||e.reason||"internal"));if(this.video_ctx){this.video_ctx.emit("error",{type:"player_error",data:e});this.uninit_prev({err:util.zerr_json(e)})}if(this.attached&&!e.hola_dont_detach)this.detach({err:"player"})},this);this.on_fallback=try_wrapper(function(){perr({id:"wrapper_fallback"});this.detach({err:"fallback"})},this);this.on_dispose=try_wrapper(function(){perr({id:"wrapper_dispose"});if(0)this.detach({err:"dispose"})},this);this.on_interrupted=try_wrapper(function(){if(this.video_ctx&&!this.player.is_idle())this.save_context()},this);this.on_resumed=try_wrapper(function(_opt){if(this.restore_context(_opt))return perr({id:"wrapper_restore_cdn_context"})},this);this.before_unload=try_wrapper(function(){this.detach()},this);this.on_hidden_state=try_wrapper(function(){this.log.info("page in hidden state")},this);this.on_visible_state=try_wrapper(function(){this.log.info("page in visible state")},this);this.on_save_logs=this.save_logs.bind(this);player.on("started",this.on_started);player.on("interrupted",this.on_interrupted);player.on("resumed",this.on_resumed);player.on("ended",this.on_ended);player.on("state",this.on_state);player.on("error",this.on_error);player.on("fallback",this.on_fallback);player.on("dispose",this.on_dispose);player.on("save_logs",this.on_save_logs);util.on("beforeunload",this.before_unload);util.on("visible_state",this.on_visible_state);util.on("hidden_state",this.on_hidden_state);player.emit("wrapper_attached");this.emit("wrapper_attached");load_perf.push("wrapper_attach_finish");if(this.attached&&!player.is_idle()){attach_to_player({init_not_idle:true});if(player.is_interrupted())this.on_interrupted()}});Wrapper.prototype.detach=try_wrapper({method:true},function(opt){if(this.verify_attached(false))return;this.save_global();opt=opt||{};this.attached=false;var player=this.player;player.off("started",this.on_started);player.off("interrupted",this.on_interrupted);player.off("resumed",this.on_resumed);player.off("ended",this.on_ended);player.off("state",this.on_state);player.off("error",this.on_error);player.off("fallback",this.on_fallback);player.off("dispose",this.on_dispose);player.off("save_logs",this.on_save_logs);util.off("beforeunload",this.before_unload);util.off("visible_state",this.on_visible_state);util.off("hidden_state",this.on_hidden_state);this.on_started=this.on_ended=this.before_unload=this.on_state=this.on_error=this.on_fallback=this.on_dispose=this.on_visible_state=this.on_hidden_state=undefined;this.log.notice("wrapper detached from player");this.uninit_prev(opt);this.uninit_saved_context();player.emit("wrapper_detached");this.emit("wrapper_detached",{err:opt.err});if(opt.err)this.error=opt.err;if(player.extensions.buffer_monitor)player.extensions.buffer_monitor.uninit();if(player.extensions.airplay)player.extensions.airplay.uninit();player.uninit();this.player=undefined});function use_hola_vjs(){return window.hola_player&&window.hola_player.VERSION}function use_custom_player(opt){return opt.custom.name=="powa"||opt.custom.name=="theo_player_hls"||opt.custom.custom_player||CG("loader.wrapper.use_custom_player")}function attach_player_fn(player_mod,props){return try_wrapper({method:true},function(opt){if(!opt.player_obj){util.assert_enabled(player_mod);opt.player_obj=new player_mod.Player(opt)}this.attach(opt);return opt.player_obj})}Wrapper.prototype.attach_hola=attach_player_fn(hola_vjs);Wrapper.prototype.attach_vjs=attach_player_fn(vjs);Wrapper.prototype.attach_jwplayer=attach_player_fn(zjwplayer);Wrapper.prototype.attach_flowplayer=attach_player_fn(flowplayer);Wrapper.prototype.attach_ooyala=attach_player_fn(ooyala);Wrapper.prototype.attach_akamai=attach_player_fn(akamai);Wrapper.prototype.attach_custom=attach_player_fn(custom_player);Wrapper.prototype.attach_html5=attach_player_fn(html5);Wrapper.prototype.attach_yt=attach_player_fn(youtube);Wrapper.prototype.attach_android=attach_player_fn(android);Wrapper.prototype.attach_ios=attach_player_fn(ios);Wrapper.prototype.attach_jtest=function(opt){return this.attach(opt)};Wrapper.prototype.attach_config=function(opt){var win_vjs=window.vjs||window.videojs;define_ext.call(this,"videojs",win_vjs);define_ext.call(this,"videojs-media-source",win_vjs&&win_vjs.MediaSource);define_ext.call(this,"jquery",window.jQuery);if(this.verify_attached(true))return;opt=opt||{};if(CG("loader.autodetect.auto_akamai"))opt.akamai=opt.akamai||window.amp;if(opt.yt)return this.attach_yt(opt);if(opt.android)return this.attach_android(opt);if(opt.ios)return this.attach_ios(opt);if(opt.flowplayer)return this.attach_flowplayer(opt);if(opt.vjs&&use_hola_vjs())return this.attach_hola(opt);if(opt.vjs)return this.attach_vjs(opt);if(opt.jwplayer)return this.attach_jwplayer(opt);if(opt.ooyala)return this.attach_ooyala(opt);if(opt.akamai&&opt.html5)return this.attach_akamai(opt);if(opt.custom&&use_custom_player(opt))return this.attach_custom(opt);if(opt.html5)return this.attach_html5(opt);if(opt.jtest)return this.attach_jtest(opt);this.log.err("player not found");perr({id:"wrapper_player_not_found"})};Wrapper.prototype.save_logs=function(e){e=e||{};e.data=this.log.logs_to_str(this.log.concat(e.data,true),true);if(this.video_ctx)this.video_ctx.emit("get_logs",e);filesaver(new Blob([e.data],{type:"application/json"}),"cdnlogs.txt")};var global_data={};Wrapper.prototype.load_global=function(key,def){var data=global_data[this.id]=global_data[this.id]||{};if(key)return data[key]!==undefined?data[key]:def;this.init_n=(data.init_n||0)+1;this.page_url=data.page_url;this.video_seq_n=data.video_seq_n||0;this.video_seq_url=data.video_seq_url};Wrapper.prototype.save_global=function(key,value){var data=global_data[this.id]=global_data[this.id]||{};if(key)return data[key]=value;data.init_n=this.init_n;data.page_url=this.page_url;data.video_seq_n=this.video_seq_n;data.video_seq_url=this.video_seq_url};function Wrapper(opt){if(!(this instanceof Wrapper))return new Wrapper(opt);this.id=opt.player_id;this.player_n=opt.player_n;this.load_global();this.log=opt.log.set_module("wrapper");this.try_wrapper=try_wrapper}return Wrapper});
define("/svc/cdn/pub/videojs.js",["cash","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/vjs.js","/svc/cdn/pub/hola_vjs.js"],function($,zutil,util,dom_util,vjs,hola_vjs){var E={};var CG=util.gconf_get;function VCG(key,def){return CG("loader.autodetect.videojs."+key,def)}E.get_handler=function(Player){return{disabled:!util.is_enabled(vjs)&&!util.is_enabled(hola_vjs),rels:{html5:"anc",osmf:"mod",dailymotion:"mod",dashjs:"mod",shaka:"mod"},get_instances:function(elements){var players=[];var vjs_el=function(e){return dom_util.has_class(e,"vjs-tech")};if(window.videojs){players=zutil.values(window.videojs.getPlayers?window.videojs.getPlayers():window.videojs.players||{})}if(!players.length||elements.filter(vjs_el).length!=players.length){$(VCG("selector",".video-js")).each(function(){var el=this;if(el.player&&el.id&&!players.includes(el.player))players.push(el.player)})}var ignore_sel=CG("loader.autodetect.ignore_selector");return players.filter(function(p){if(!p)return false;var is_audio=typeof p.isAudio=="function"&&p.isAudio()||typeof p.currentType=="function"&&p.currentType()=="audio/mp3";if(is_audio)return false;if(zutil.is_mocha())return true;var el=p&&(p.contentEl&&p.contentEl()||p.el&&p.el());return el&&document.body.contains(el)&&(!ignore_sel||!dom_util.matches(el,ignore_sel))})},normalize:function(instance){return new Player({setup:function(){var _this=this;this.ready=false;this.on_dispose=function(){_this.disposed=true;_this.emit("dispose")};instance.ready(function(){_this.ready=true;_this.emit("ready")});instance.one("dispose",this.on_dispose);instance.one("gotSourceUrl",function(e){_this.video_url=e.source})},destroy:function(){if(!this.disposed)instance.off("dispose",this.on_dispose)},get_element:function(){if(this.disposed)return;var el=instance.el().querySelector(".vjs-tech");var selector=VCG("video_selector","video:nth-of-type(2)");return el&&el.tagName=="DIV"?instance.el().querySelector(selector):el},get_container:function(){return instance.el()},get_footprint:function(){return{player_id:instance.id()}},is_ready:function(){return this.ready},get_opt:function(){var opt={vjs:instance};if(this.video_url)opt.video_url=this.video_url;return opt},get_caps:function(){return{init_on_master_ready:VCG("init_on_master"),reconf_by_wrapper:VCG("reconf_by_wrapper")&&["mod"]}}})}}};return E});
define("/svc/cdn/pub/clappr.js",["cash","/util/util.js","/svc/cdn/pub/util.js"],function($,zutil,util){var assign=Object.assign;var E={};var CG=util.gconf_get;function get_conf_custom_ops(player_type,instance){var ops_fn;if(!(ops_fn=CG("loader.autodetect."+player_type+".custom_ops")))return;try{if(typeof ops_fn=="string")ops_fn=new Function("instance","$","util",ops_fn);return ops_fn(instance,$,util)}catch(e){}}E.get_handler=function(Player){return{rels:{html5:"anc",dailymotion:"mod"},get_instances:function(elements){if(!window.Clappr)return;return zutil.get(window,CG("loader.autodetect.clappr.location","hola_cdn.clappr"))},validate:function(instance){return instance instanceof window.Clappr.Player},normalize:function(instance){return new Player({setup:function(){if(!this.is_ready()){instance.once(window.Clappr.Events.PLAYER_READY,this.emit.bind(this,"ready"))}},get_element:function(){var container=instance.options.parentElement;return container&&container.querySelector("video")},get_container:function(){return instance.options.parentElement},is_ready:function(){return instance.isReady},get_opt:function(){var dm,opt={};opt.custom=assign({name:"clappr",is_autostart:function(){return zutil.get(instance,"playerInfo.options.autoPlay")}},get_conf_custom_ops("clappr",instance));if(dm=(instance.getPlugin("hls")||{})._hls)opt.dailymotion=dm;return opt}})}}};return E});
define("/svc/cdn/pub/theoplayer.js",["cash","/svc/cdn/pub/util.js"],function($,util){var E={};var CG=util.gconf_get;E.get_handler=function(Player){return{rels:{html5:"anc"},sel:".theo-player-wrapper > .vjs-tech > div > video",_sel:"video[preload=metadata]",get_instances:function(elements){if(!CG("loader.autodetect.theoplayer"))return;var hls_elts=$(elements).filter(this.sel).filter(this._sel);if(hls_elts.length==2)return hls_elts.parent().get(0)},validate:function(instance){return $(instance).find(this._sel).filter(function(v){return v.src}).length},normalize:function(instance){var container=$(instance).closest(".theoplayer, .video-js").get(0);var player_api=container&&container.player;var get_opt=function(){if(!player_api)return{};var _this=this;return{custom:{name:"theo_player_hls",init:function(player){var started=function(){if(_this.started)return;_this.started=true;player.emit("started")};var play=function(){player.emit("play");started()};var timeupdate=function(){if(!player_api.paused()&&!player_api.ended())started();player.emit("timeupdate",player.get_pos())};var pause=function(){player.emit("pause")};var ended=function(){if(!_this.started)return;_this.started=false;player.emit("ended")};_this.listeners={play:play,timeupdate:timeupdate,pause:pause,ended:ended};for(var key in _this.listeners)player_api.on(key,_this.listeners[key])},uninit:function(){if(!_this.listeners)return;for(var key in _this.listeners)player_api.off(key,_this.listeners[key]);_this.listeners=null},is_idle:function(){return!this.started},play:function(){return player_api.play()},pause:function(){return player_api.pause()},muted:function(mute){return player_api.muted(mute)},volume:function(volume){return player_api.volume(volume)},get_duration:function(){return player_api.duration()},get_pos:function(){return player_api.currentTime()},get_ui:function(){var cont=container||instance;var control_bar=$(cont).find(".vjs-control-bar:not(.theo-top-controlbar)");var progress_bar=$(cont).find(".vjs-progress-control");return{container:cont,fullscreen:cont,media:instance,control_bar:control_bar,progress_bar:progress_bar}},get_url:function(){return player_api.currentSrc()},get_buffered:function(){return player_api.buffered()},play_src:function(src){try{player_api.src([{src:src}]);player_api.load();player_api.play()}catch(e){}},is_ad_active:function(){return container&&container.className.indexOf("fave-ad-playing")>-1},is_paused:function(){return player_api.paused()},is_playing:function(){return!player_api.paused()&&!player_api.ended()&&!player_api.seeking()},is_seeking:function(){return player_api.seeking()}}}};return new Player({get_element:function(){return instance},get_opt:get_opt})}}};return E});
define("/svc/cdn/pub/powa.js",["cash","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/dom_util.js"],function($,zutil,util,dom_util){var assign=Object.assign;var E={};var CG=util.gconf_get;function get_conf_custom_ops(player_type,instance){var ops_fn;if(!(ops_fn=CG("loader.autodetect."+player_type+".custom_ops")))return;try{if(typeof ops_fn=="string")ops_fn=new Function("instance","$","util",ops_fn);return ops_fn(instance,$,util)}catch(e){}}E.get_handler=function(Player){return{rels:{html5:"anc",dailymotion:"mod",dash:"mod",shaka:"mod"},get_instances:function(){if(!window.PoWaSettings||!window.powas)return;return Object.values(window.powas).map(function(p){return p.powa}).filter(function(p){return!!p})},validate:function(el){var ignore_sel=CG("loader.autodetect.powa.ignore_selector");var container=el.getElement&&el.getElement();return!ignore_sel||!container||!dom_util.matches(container,ignore_sel)},normalize:function(instance){return new Player({setup:function(){var _this=this;this._powa_events=new util.events;this._pending_ready=!this.is_ready();this._powa_ads_on=instance.getStatus().adRunning;this._powa_ads_toggle=function(){var new_ad_status=instance.getStatus().adRunning;if(!zutil.xor(_this._powa_ads_on,new_ad_status))return;_this._powa_ads_on=new_ad_status;_this._powa_events.emit(_this._powa_ads_on?"ad_suspend":"ad_restore")};instance.on("start",this._powa_ads_toggle);instance.on("adStart",this._powa_ads_toggle);instance.on("adEnd",this._powa_ads_toggle);var instance_ready=function(){if(_this._pending_ready)_this._pending_ready=_this.emit("ready");_this._powa_events.emit("ready")};instance.on("ready",instance_ready);var powa_ready=function(ev){if(ev.detail.powa!=instance)return;window.removeEventListener("powaReady",powa_ready);instance_ready()};window.addEventListener("powaReady",powa_ready);this._off_powa_ready=function(){instance.off("ready",instance_ready);window.removeEventListener("powaReady",powa_ready)}},destroy:function(){instance.off("start",this._powa_ads_toggle);instance.off("adStart",this._powa_ads_toggle);instance.off("adEnd",this._powa_ads_toggle);if(this._off_powa_ready)this._off_powa_ready=void this._off_powa_ready()},get_element:function(){return $("video#"+instance.getID().replace("powa-","powa-player-"))[0]},is_ready:function(){if(!this.get_element())return true;return!!instance.getStatus().state},get_opt:function(){return{custom:assign({name:"powa",powa:instance,get_url:function(){return instance.getStatus().stream},get_versions:function(){return{powa:zutil.get(instance,"videoData.version")}},play:function(){instance.play()},pause:function(){instance.pause()},muted:function(mute){if(mute===undefined)return instance.getStatus().muted;instance.mute(mute)},volume:function(volume){if(volume===undefined)return instance.getStatus().volume;instance.volume(volume)},get_ui:function(){return{container:instance.getElement()}},is_ready:this.is_ready.bind(this),is_autostart:function(){return instance.getElement().getAttribute("data-autoplay")=="true"},is_ad_active:function(){return instance.getStatus().adRunning},on:this._powa_events.on.bind(this._powa_events),off:this._powa_events.off.bind(this._powa_events)},get_conf_custom_ops("powa",instance))}},get_caps:function(){return{init_on_master_ready:true,reconf_by_wrapper:true}}})}}};return E});
define("/svc/cdn/pub/bluebillywig.js",["/util/util.js"],function(zutil){var E={};E.get_handler=function(Player){return{rels:{html5:"anc",dailymotion:"mod"},get_instances:function(){var predicate=function(p){return p.getWrapper&&p.getWrapper()&&p.getWrapper().querySelector("video")};return window.bluebillywig&&window.bluebillywig.players&&window.bluebillywig.players.filter(predicate)},normalize:function(instance){return new Player({setup:function(){var _this=this;function emit_ready(){_this.emit("ready");instance.off(emit_ready)}if(!instance.isReady())instance.on("ready",emit_ready)},is_ready:function(){return instance.isReady()},get_element:function(){return instance.getWrapper().querySelector("video")},get_opt:function(){var dm,opt={bluebillywig:instance};var dm_path="_internal.Main._programController"+"._headController._heads.Html5HLS_video._hlsHelper._hls";if(dm=zutil.get(instance,dm_path))opt.dailymotion=dm;return opt}})}}};return E});
define("/svc/cdn/pub/kaltura.js",["cash","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/player_util.js"],function($,zutil,util,player_util){var assign=Object.assign;var E={};var CG=util.gconf_get;var CS=util.gconf_set;function get_conf_custom_ops(player_type,instance){var ops_fn;if(!(ops_fn=CG("loader.autodetect."+player_type+".custom_ops")))return;try{if(typeof ops_fn=="string")ops_fn=new Function("instance","$","util",ops_fn);return ops_fn(instance,$,util)}catch(e){}}function set_conf_default(path,def){CS(path,CG(path,def))}E.get_handler=function(Player){return{rels:{html5:"anc",dailymotion:"mod"},init:function(ctrl){set_conf_default("loader.player.kaltura.lock_reload_request",true);set_conf_default("loader.player.kaltura.continue_on_reload",true)},get_instances:function(elements){if(!window.kalturaIframePackageData)return;var pid=window.kalturaIframePackageData.playerId;var sel='[id="'+pid+'"].mwEmbedPlayer';var player=document.querySelector(sel);return player&&player.getPlayerElement()?player:null},normalize:function(instance){return new Player({setup:function(){if(CG("loader.autodetect.kaltura.destroy_on_swap_media")){var _this=this;window.$(instance).on("onChangeMediaDone",function(){_this.emit("reload","reloaded")})}},get_element:function(){return instance.getPlayerElement()},get_opt:function(){var hls,opt={};opt.custom=assign({name:"kaltura",is_autostart:function(){return instance.autoplay},play:function(){instance.play()},muted:function(mute){if(mute===undefined)return instance.isMuted();if(instance.isMuted()==!!mute)return;instance.toggleMute()},volume:function(volume){if(volume===undefined)return instance.volume;instance.setVolume(volume)},get_ui:function(){var container=instance.getInterface()[0];return player_util.build_ui(container,{control_bar:".controlBarContainer",progress_bar:".scrubber",fullscreen:container})}},get_conf_custom_ops("kaltura",instance));if(hls=zutil.get(instance,"plugins.hlsjs.hls"))opt.dailymotion=hls;return opt},get_caps:function(){return{init_on_master_ready:CG("loader.autodetect.kaltura.init_on_master",true)}}})}}};return E});
define("/svc/cdn/pub/delightvr.js",["cash","/svc/cdn/pub/util.js"],function($,util){var assign=Object.assign;var E={};var CG=util.gconf_get;function get_conf_custom_ops(player_type,instance){var ops_fn;if(!(ops_fn=CG("loader.autodetect."+player_type+".custom_ops")))return;try{if(typeof ops_fn=="string")ops_fn=new Function("instance","$","util",ops_fn);return ops_fn(instance,$,util)}catch(e){}}E.get_handler=function(Player){return{rels:{html5:"anc"},get_instances:function(){var instances=Array.from($("dl8-video"));if(window.__dl8__delightVrApp){window.__dl8__delightVrApp._store.getState().data.contents.forEach(function(p){if(!instances.includes(p.domElement))instances.push(p.domElement)})}return instances},normalize:function(instance){return new Player({setup:function(){var _this=this;if(this.is_ready())return;document.addEventListener("x-dl8-evt-start",this._on_start=function(e){if(e.detail.element!=instance)return;_this._removeListeners();_this.emit("ready")})},get_element:function(){return instance.contentElement},is_ready:function(){return $(instance).hasClass("dl8-active")||$(".dl8-loading-overlay",instance).length},get_opt:function(){var src=$('script[src*="cdn.delight-vr.com"]').attr("src");var vm=src&&src.match(/\.com\/(.+)\/.*dl8-/);return{html5:this.get_element(),custom:assign({name:"delightvr",get_versions:function(){return{delightvr:vm?vm[1]:null}},get_ui:function(){var c=$(instance).closest("dl8-video");return{container:c[0],fullscreen:c.find("#dl8-content-container")[0],control_bar:c.find("[class^=PlayerHudView_bottomBar]")[0],progress_bar:c.find("[class^=SeekingView_"+"bar]")[0]}}},get_conf_custom_ops("delightvr",instance))}},destroy:function(){this._removeListeners()},_removeListeners:function(){if(!this._on_start)return;document.removeEventListener("x-dl8-evt-start",this._on_start)}})}}};return E});
define("/svc/cdn/pub/panolens.js",["/svc/cdn/pub/util.js"],function(util){var E={};E.get_handler=function(Player){return{rels:{html5:"anc"},get_instances:function(){return window.PANOLENS&&(window.panorama||typeof(window.player||{}).panorama=="function"&&window.player.panorama()||{}).videoElement},normalize:function(instance){return new Player({get_element:function(){return instance},get_opt:function(){return{html5:instance}}})}}};return E});
define("/svc/cdn/pub/autodetect.js",["cash","/svc/cdn/pub/log.js","/svc/cdn/pub/util.js","/util/util.js","/util/events.js","/svc/cdn/pub/zjwplayer3.js","/svc/cdn/pub/flowplayer.js","/svc/cdn/pub/youtube.js","/svc/cdn/pub/android.js","/svc/cdn/pub/dash.js","/svc/cdn/pub/dailymotion.js","/svc/cdn/pub/html5.js","/svc/cdn/pub/ios.js","/svc/cdn/pub/videojs.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/ooyala.js","/svc/cdn/pub/akamai.js","/svc/cdn/pub/clappr.js","/svc/cdn/pub/custom_player.js","/svc/cdn/pub/theoplayer.js","/svc/cdn/pub/powa.js","/svc/cdn/pub/bluebillywig.js","/svc/cdn/pub/shaka.js","/svc/cdn/pub/kaltura.js","/svc/cdn/pub/delightvr.js","/svc/cdn/pub/panolens.js","/svc/cdn/pub/perr.js"],function($,_log,util,zutil,events,zjwplayer,flowplayer,youtube,android,dash,dailymotion,html5,ios,videojs,dom_util,ooyala,akamai,clappr,custom_player,theoplayer,powa,bluebillywig,shaka,kaltura,delightvr,panolens,perr){var E={};var assign=Object.assign;var CG=util.gconf_get;var log=_log.set_module("autodetect");var ad_ctrl,wrapper_fn;function Player(opt){var default_opt={setup:function(){},is_ready:function(){return true},get_container:function(){return},get_footprint:function(){return{}},get_caps:function(){return{}},destroy:function(){}};assign(this,default_opt,opt);this.setup()}zutil.inherits(Player,events.EventEmitter);var _players={akamai:akamai,android:android,bluebillywig:bluebillywig,clappr:clappr,custom_player:custom_player,dailymotion:dailymotion,dashjs:dash,delightvr:delightvr,flowplayer:flowplayer,html5:html5,ios:ios,jwplayer:zjwplayer,kaltura:kaltura,ooyala:ooyala,panolens:panolens,powa:powa,shaka:shaka,theoplayer:theoplayer,youtube:youtube,videojs:videojs};E.player_handlers={};for(var _player in _players){var module=_players[_player];if(util.is_enabled(module))E.player_handlers[_player]=module.get_handler(Player,log,E)}function Sequence(ctrl){this.ctrl=ctrl;this.ctrl.once("uninit",this.uninit.bind(this));this.init()}Sequence.prototype.init=function(){var _this=this;if(this.inited)return;this.inited=true;this.footprints={};this.on_domupdate=function(arg){if(!arg||!dom_util.dom_listen.using_observer)return;var pid_control=[],retry_attempts=0;do{for(var i=arg.length-1;i>=0;i--){var mutation=arg[i];for(var j=0;j<mutation.removedNodes.length;j++){var rem=mutation.removedNodes[j],hnodes=[];if(rem.hasAttribute&&rem.hasAttribute("hola-pid"))hnodes=[rem];else if(rem.querySelectorAll)hnodes=rem.querySelectorAll("[hola-pid]");if(!hnodes.length)continue;for(var k=0;k<hnodes.length;k++){var parent=mutation.target;var ppid_attr=parent.getAttribute("hola-pid")||"";var pid_attr=hnodes[k].getAttribute("hola-pid");if(!pid_attr||!pid_attr.length)continue;pid_attr.split(",").forEach(function(pid){if(!pid_control.includes(pid))pid_control.push(pid);ppid_attr=ppid_attr?ppid_attr+","+pid:pid});ppid_attr=util.array_unique(ppid_attr.split(",")).join(",");parent.setAttribute("hola-pid",ppid_attr);hnodes[0].removeAttribute("hola-pid")}}}if(pid_control.length){var pids_in_dom=[];util.dom_query_foreach("[hola-pid]",function(node){var _pid_attr;if(!(_pid_attr=node.getAttribute("hola-pid"))||!_pid_attr.length){return}_pid_attr.split(",").forEach(function(pid){pids_in_dom.push(pid)})});pid_control=pid_control.filter(function(pid){return!pids_in_dom.includes(pid)})}}while(pid_control.length&&++retry_attempts<10);if(pid_control.length)_this.report("pid transfer failed",{pids:pid_control.join(",")})};this.on_domupdate_safe=function(arg){try{_this.on_domupdate(arg)}catch(e){_this.report("domupdate failed",{stack:e.stack||""+e})}};this.ctrl.on("pre-domupdate",this.on_domupdate_safe)};Sequence.prototype.uninit=function(){if(!this.inited)return;this.inited=false;this.ctrl.off("pre-domupdate",this.on_domupdate_safe);util.dom_query_foreach("[hola-pid]",function(node){node.removeAttribute("hola-pid")});this.footprints=this.ctrl=undefined};Sequence.prototype.report=function(desc,data){if(CG("autodetect.sequence.disable_report"))return;data=assign({desc:desc,footprints:this.footprints},data);perr({id:"loader_autodetect_seq_failure",add_log:true,full:true,info:assign({},data)})};Sequence.prototype.detect_pid=function(el,footprint){var parent,ppid_attr;if(!(parent=dom_util.closest(el,"[hola-pid]"))||!(ppid_attr=parent.getAttribute("hola-pid"))){return}var match,pid_list=ppid_attr.split(",");if(!(match=this.find_by_footprint(pid_list,footprint))){this.report("pid pickup failed",{pids:ppid_attr,using_footprint:footprint});pid_list.forEach(function(pid){this.remove_footprint(pid)},this);return void parent.removeAttribute("hola-pid")}pid_list.splice(pid_list.indexOf(match),1);if(pid_list.length)parent.setAttribute("hola-pid",pid_list.join(","));else parent.removeAttribute("hola-pid");return match};Sequence.prototype.build_footprint=function(player){function is_element_node(node){return node&&typeof Node!="undefined"&&node.nodeType==Node.ELEMENT_NODE}function get_node_path(node,opt){var path="";for(var i=0;is_element_node(node)&&i<opt.max_depth;i++){path=dom_util.get_full_elm_selector(node)+(path?" "+path:"");node=node.parentNode}return path}var el=player.get_element(),pfp=player.get_footprint();var conf_fn=CG("loader.autodetect.sequence.footprint_fn");return{element_id:el.id||undefined,player_name:player.name,player_id:pfp.player_id?player.name+"/"+pfp.player_id:undefined,conf_id:conf_fn&&util.try_wrapper_silent(conf_fn)(player),debug:{path:get_node_path(el,{max_depth:4})}}};Sequence.prototype.save_footprint=function(pid,footprint){this.footprints[pid]=footprint};Sequence.prototype.remove_footprint=function(pid){delete this.footprints[pid]};Sequence.prototype.find_by_footprint=function(pid_list,fp){var fps=this.footprints;var criterias={match_by_conf:function(){return fp.conf_id&&pid_list.splice(0,pid_list.length).find(function(pid){return fp.conf_id==fps[pid].conf_id})},match_by_id:function(){return pid_list.find(function(pid){return fp.element_id&&fp.element_id==fps[pid].element_id||fp.player_id&&fp.player_id==fps[pid].player_id})},match_by_player_name:function(){pid_list=pid_list.filter(function(pid){return fps[pid]&&fps[pid].player_name==fp.player_name});return pid_list.length==1?pid_list[0]:0}};var pid;Object.keys(criterias).find(function(key){if(!(pid=criterias[key]()))return;log.debug("rediscovered pid "+pid+" using rule "+key);return true});return pid||0};Sequence.prototype.gen_next_pid=function(player){Sequence.pid=Sequence.pid||0;return++Sequence.pid};Sequence.prototype.get_pid=function(player,is_slaved){var pid,el=player.get_element();if(!this.inited||!el||!el.hasAttribute||is_slaved)return this.gen_next_pid();if(el.hasAttribute("hola-pid"))return+el.getAttribute("hola-pid")||this.gen_next_pid();var footprint=this.build_footprint(player);if(!(pid=this.detect_pid(el,footprint))){pid=this.gen_next_pid();this.save_footprint(pid,footprint)}el.setAttribute("hola-pid",""+pid);return pid};Group.id=0;function Group(ctrl,player,pid){this.id=++Group.id;this.pid=pid;this.log=log.fork(this.pid);this.players=[];this.ctrl=ctrl;this.ctrl_handlers=[];this.reconf_notifier=new util.events;this._check_players_ready=this.check_players_ready.bind(this);this._send_reconf_update=this.send_reconf_update.bind(this);this.on_ctrl_event("playerfound",this.on_player_found.bind(this));this.on_ctrl_event("playerlost",this.on_player_lost.bind(this));this.on_ctrl_event("domupdate",this.on_dom_changed.bind(this));this.on_ctrl_event("uninit",this.uninit.bind(this));this.on_player_found(player)}Group.prototype.uninit=function(reason){var _this=this;if(!this.is_destroyed()){this.log.info("autodetect getting shut down ("+reason+")");this.destroy()}this.ctrl_handlers.forEach(function(h){_this.ctrl.off(h.event,h.handler)});this.ctrl_handlers=[];this.players.forEach(function(p){delete p.group});this.players=[];this.log=this.log.uninit();this.master_player=null;this.ctrl=null};Group.prototype.on_ctrl_event=function(event,handler){this.ctrl.on(event,handler);this.ctrl_handlers.push({event:event,handler:handler})};Group.prototype.is_in_relation=function(master,player,rels){var master_rels=master.get_player_info().rels||{};var player_name=player.get_player_info().name;return rels.includes(master_rels[player_name])};Group.prototype.is_reconfed_by_wrapper=function(master,player){var rels=master.get_caps().reconf_by_wrapper;if(rels==true)rels=["mod","anc"];return rels&&this.is_in_relation(master,player,rels)};Group.prototype.on_player_found=function(player){function get_player_info(){return player.get_extra_info?"("+player.get_extra_info()+")":""}var group_element=this.get_group_element();var player_element=player.get_element();var ancestor=$(player_element).closest(".spark_skip_player");if(ancestor&&ancestor.length)return;if(group_element&&player_element!=group_element||!group_element&&this.master_player){return}player.group=this;if(this.is_destroyed()){return this.players.push(player)}this.log.notice("auto-detected "+player.name+" player instance "+get_player_info());var master=this.master_player;var reconf_by_wrapper=master&&this.is_reconfed_by_wrapper(master,player);if(!reconf_by_wrapper&&(this.wrapper||this.wrapper===null)){this.log.notice("player added but group already inited: tech change?");this.players.push(player);return this.destroy()}else if(this.is_new_master(player)){this.players.unshift(player);if(master){this.log.info("changing master from "+master.name+" to "+player.name)}else this.log.info("master "+player.name+" appears");this.set_master(player)}else{this.log.info("added "+player.name+" related to "+master.name+" master");this.players.push(player)}function dispose_reload(e){if(!player.group)return;player.group.log.notice(player.name+" player getting "+(e||"disposed"));player.group.destroy()}player.once("reload",dispose_reload);player.once("dispose",dispose_reload);if(this.wrapper===undefined)this.check_players_ready();else if(this.wrapper&&reconf_by_wrapper)this.send_reconf_update()};Group.prototype.on_player_lost=function(player){if(!this.players.includes(player))return;this.log.notice(player.name+" player instance removed");if(this.is_reconfed_by_wrapper(this.master_player,player)){this.log.notice(this.master_player.name+" master handles the reconf");return this.players.splice(this.players.indexOf(player),1)}this.destroy()};Group.prototype.on_dom_changed=function(){if(!this.master_player)return;var new_element=this.master_player.get_element();if(!this.element||this.is_destroyed())return this.element=new_element;if(new_element!=this.element){this.element=new_element;this.log.notice(this.element?"group video element changed, recreating the group":"group video element purged, destroying the group");this.destroy()}};Group.prototype.get_group_element=function(){return this.element||this.master_player&&this.master_player.get_element()};Group.prototype.is_new_master=function(candidate){function is_player_related(master,rel){var master_rels=master.get_player_info().rels||{};return master_rels[rel.get_player_info().name]}return!this.master_player||is_player_related(candidate,this.master_player)};Group.prototype.set_master=function(master){this.master_player=master;if(!this.element)this.element=this.master_player.get_element()};Group.prototype.get_ready_waiting=function(){var ready_checklist=this.master_player.get_caps().init_on_master_ready?[this.master_player]:this.players;return ready_checklist.filter(function(p){return!p.is_ready()})};Group.prototype.check_players_ready=function(){var _this=this,waiting;this.ctrl.off("post-resync",this._check_players_ready);if(this.ctrl.resyncing)return this.ctrl.once("post-resync",this._check_players_ready);if(this.is_destroyed())return;if((waiting=this.get_ready_waiting()).length){waiting.forEach(function(p){if(p.on_player_ready)p.off("ready",p.on_player_ready);p.on_player_ready=function(){if(_this.get_ready_waiting().length)return;_this.ctrl.once("post-resync",_this._check_players_ready);_this.ctrl.emit("domupdate");_this.ctrl.emit("resync")};p.on("ready",p.on_player_ready)});return}this.players.forEach(function(p){if(!p.on_player_ready)return;p.off("ready",p.on_player_ready);delete p.on_player_ready});if(CG("loader.is_wrapper_allowed")&&!CG("loader.is_wrapper_allowed")(this)){return}this.create_wrapper()};Group.prototype.get_player_names=function(init_opt){return Object.keys(init_opt).map(function(name){return name=="custom"?init_opt[name].name||"custom":name}).join(", ")};Group.prototype.get_players_opt=function(){var opt={};this.players.forEach(function(p){assign(opt,p.get_opt())});return opt};Group.prototype.get_extra_opt=function(){return{player_id:this.pid,player_n:this.id,log:this.log,reconf_notifier:this.reconf_notifier}};Group.prototype.create_wrapper=function(){var _this=this,opt={},missing_player,err;if(err=this.ignore_group_after_error()){this.wrapper=null;return this.log.notice("group ready but stalled due to previous "+"error=%s",err)}if(missing_player=this.is_group_incomplete()){return this.log.notice("group ready but incomplete: "+missing_player+" missing, waiting...")}assign(opt,this.get_players_opt());this.log.info("init wrapper with "+this.get_player_names(opt));assign(opt,this.get_extra_opt());if(!(this.wrapper=wrapper_fn(opt))||this.wrapper.error){this.invalidate_errored_group("wrapper_init_failure");return this.ctrl.emit("wrappererror")}this.wrapper.once("wrapper_detached",function(opt){if(opt.err&&(opt.err!="player"||_this.wrapper&&(_this.wrapper.last_video_ctx||_this.wrapper.video_ctx||{}).attached_cdn)){_this.invalidate_errored_group(opt.err)}});if(this.ctrl)this.ctrl.emit("wrappercreated",this.wrapper)};Group.prototype.send_reconf_update=function(){this.ctrl.off("post-resync",this._send_reconf_update);if(this.ctrl.resyncing)return this.ctrl.once("post-resync",this._send_reconf_update);var opt={};assign(opt,this.get_players_opt());this.log.info("wrapper reconf with "+this.get_player_names(opt));assign(opt,this.get_extra_opt());this.reconf_notifier.emit("update",opt)};Group.prototype.ignore_group_after_error=function(){var err;this.players.find(function(p){return err=p.get_wrapped_player().hola_autodetect_ignore});return err};Group.prototype.invalidate_errored_group=function(err){this.players.forEach(function(p){p.get_wrapped_player().hola_autodetect_ignore=err});this.wrapper=null;this.log.notice("video locked from future re-attach due to error="+err)};function is_group_incomplete(player_list){var include;if(!(include=CG("loader.autodetect.group.include")))return;if(!(include instanceof Array))include=[include];return include.find(function(inc){return!player_list.find(function(player){return player==inc})})}Group.prototype.is_group_incomplete=function(){var player_list=this.players.map(function(p){return p.name});return is_group_incomplete(player_list)};Group.prototype.destroy=function(){if(this.destroyed)return;this.destroyed=true;this.log.info("destroying player group including "+this.players.map(function(p){return p.name}).join(", "));this.ctrl.off("post-resync",this._check_players_ready);this.players.forEach(function(p){if(p.on_player_ready){p.off("ready",p.on_player_ready);delete p.on_player_ready}});if(this.wrapper){if(this.wrapper.attached)this.wrapper.detach();else this.wrapper.emit("wrapper_detached",{});this.wrapper=undefined;this.ctrl.emit("wrapperdestroyed")}};Group.prototype.is_destroyed=function(){return this.destroyed};Group.prototype.get_players=function(){return this.players};Group.prototype.contains_el=function(el){var container=this.master_player.get_container();return container&&container.contains(el)};Group.prototype.describe_state=function(){var e;return this.wrapper===undefined?"beforeready":this.wrapper?"inited":(e=this.ignore_group_after_error())?"posterror/"+e:"shutdown"};function Detector(ctrl){this.players=[];this.nplayers=[];this.elements=[];this.player_handlers=Object.keys(E.player_handlers).filter(function(k){return!E.player_handlers[k].disabled}).map(function(k){return assign({name:k},E.player_handlers[k])});this.player_handlers.forEach(function(ph){if(ph.init)ph.init(ctrl)});this.ctrl=ctrl;this._update_players=this.update_players.bind(this);this._update_elements=this.update_elements.bind(this);this._uninit=this.uninit.bind(this);this.ctrl.on("resync",this._update_players);if(!window.hola_cdn_sdk&&!window.spark_ios_sdk)this.ctrl.on("domupdate",this._update_elements);this.ctrl.once("uninit",this._uninit)}Detector.prototype.uninit=function(){if(!window.hola_cdn_sdk&&!window.spark_ios_sdk)this.ctrl.off("domupdate",this._update_elements);this.ctrl.off("resync",this._update_players);this.nplayers.forEach(function(np){np.destroy()});this.players=this.nplayers=this.elements=this.ctrl=null};Detector.prototype.check_diff=function(old_list,new_list,onchange){old_list.forEach(function(i){if(!new_list.includes(i))onchange(i,false)});new_list.forEach(function(i){if(!old_list.includes(i))onchange(i,true)})};Detector.prototype.update_elements=function(){var _this=this;var old_list=this.elements,new_list;var video_selector_fn=CG("loader.autodetect.video_selector_fn");if(typeof video_selector_fn=="function"){try{new_list=$(video_selector_fn($)).get()}catch(e){new_list=[]}}else new_list=$("video,object,embed").get();this.elements=new_list;this.check_diff(old_list,new_list,function(e,is_added){_this.ctrl.emit(is_added?"elementfound":"elementlost",e)})};Detector.prototype.get_player_list=function(){var list=[],hlist=[],elements=this.elements;this.player_handlers.forEach(function(ph){var instances=ph.get_instances(elements)||[];if(!(instances instanceof Array))instances=[instances];if(ph.validate)instances=instances.filter(ph.validate.bind(ph));list=list.concat(instances);hlist=hlist.concat(instances.map(function(i){return ph}))});return{players:list,handlers:hlist}};Detector.prototype.update_players=function(){var _this=this;var collection=this.get_player_list();var old_list=this.players;var new_list=collection.players;this.ctrl.resyncing=true;this.check_diff(old_list,new_list,function(p,is_added){var np,index,handler;if(is_added){index=collection.players.indexOf(p);handler=collection.handlers[index];np=assign(handler.normalize(p),{name:handler.name,get_wrapped_player:function(){return p},get_player_info:function(){return handler}});if(!np.get_element())perr({id:"loader_autodetect_early_detection"});_this.players.push(p);_this.nplayers.push(np);_this.ctrl.emit("playerfound",np)}else{index=_this.players.indexOf(p);np=_this.nplayers[index];_this.players.splice(index,1);_this.nplayers.splice(index,1);_this.ctrl.emit("playerlost",np);np.destroy()}});this.ctrl.resyncing=false};Detector.prototype.remove_player_from_cache=function(np){var index=this.nplayers.indexOf(np);if(index<0)return;this.players.splice(index,1);this.nplayers.splice(index,1);np.destroy()};function Controller(){var evts=this.events=new util.events;util.on("post-beforeunload",function(){evts.emit("uninit","beforeunload")})}Controller.prototype.start=function(){var _this=this;if(this.running)return;this.running=true;this.groups=[];this.seq=new Sequence(this.events);this.detector=new Detector(this.events);var dom_reset=dom_util.dom_listen(document,function(arg){_this.events.emit("domupdate",arg);_this.events.emit("resync")});this.events.on("post-playerfound",function(player){if(!player.group){_this.groups.push(new Group(_this.events,player,_this.seq.get_pid(player,_this.is_slaved(player))))}});this.events.on("post-resync",this.cleanup_groups.bind(this));this.events.once("uninit",dom_reset);this.events.once("post-uninit",this.stop.bind(this));this.ext_init();this.events.emit("domupdate");this.events.emit("resync");if(CG("loader.custom_resync"))CG("loader.custom_resync")({$:$,E:E,controller:this})};Controller.prototype.ext_init=function(){var ext_init_fn;if(ext_init_fn=CG("loader.autodetect.init_fn"))try{ext_init_fn(this)}catch(e){}};Controller.prototype.is_slaved=function(player){var el=player.get_element();return!!this.groups.find(function(g){return g.contains_el(el)})};Controller.prototype.cleanup_groups=function(){var _this=this;function uninit_group(group){group.get_players().forEach(function(p){_this.detector.remove_player_from_cache(p)});group.uninit()}if(!this.groups.find(function(g){return g.is_destroyed()}))return;this.resync_delayed=setTimeout(function(){delete _this.resync_delayed;_this.groups=_this.groups.filter(function(g){var destroyed;if(destroyed=g.is_destroyed())uninit_group(g);return!destroyed});_this.events.emit("resync")})};Controller.prototype.stop=function(reason){if(!this.running)return;this.running=false;this.events.emit("uninit",reason||"manual");if(this.resync_delayed){clearTimeout(this.resync_delayed);delete this.resync_delayed}this.events.events.removeAllListeners();this.groups=[];this.detector=null};E.init=function(opt){if(ad_ctrl)return ad_ctrl;wrapper_fn=opt.wrapper_fn;ad_ctrl=new Controller;return ad_ctrl};if(zutil.is_mocha())E.t={is_group_incomplete:is_group_incomplete,Sequence:Sequence};return E});
(function(){var __hola_stub_define,is_node=typeof module=="object"&&module.exports;if(!is_node)define=define||self.define;else{var define_node=require("../../../util/require_node.js").define(module,"../");define=function(name,deps,fn){return define_node(name,[],fn)}}define("/svc/cdn/pub/spark_features.js",[],function(){var E={};E.libs={links:{name:"links"},widget:{name:"widget"}};E.features={persistent:{manifest:2,modules:["log","perr","players","stats","watermark"],title:"Floating player",enable:"spark.persistent.enable",platform_dependent_conf:true,metrics:["cdn_ve_video_persistent_events"],counters:["cdn_ve_video_persistent_events"],counters_zone:"vstat",name:"persistent",id:"persistent_video",force_enable:"persistent_video",watermark_on_eval_end:true,wait_for_master_sync:true},video_previews:{manifest:2,modules:["api","links","log","perr","stats","storage","watermark"],title:"Video preview",enable:"spark.video_previews.enable",metrics:["cdn_ve_media_bytes","spark_video_prev_events"],counters:["cdn_preview_req"],counters_zone:"gen",name:"video_previews",module_id:"preview",force_enable:"ve_preview",dep:["links"],watermark_on_eval_end:true,platform_dependent_conf:true},image_previews:{manifest:2,modules:["api","perr","stats","log"],title:"Image preview",enable:"spark.image_previews.enable",metrics:["cdn_ve_media_bytes"],counters:["cdn_image_preview_req"],name:"image_previews",m_name:"image_preview",force_enable:"ve_image_preview",dep:["links"],watermark_on_eval_end:true},playlist:{manifest:2,modules:["api","history","links","log","perr","players","stats"],title:"Watch next",name:"playlist",enable:"spark.playlist.enable",platform_dependent_conf:true,metrics:["cdn_ve_playlist_ctr"],counters:["spark_watch_next_clk"],counters_zone:"glob",force_enable:"ve_playlist",dep:["links","widget"],watermark_on_eval_end:true},thumbnails:{manifest:2,modules:["api","log","players","stats","watermark"],title:"Player thumbnails",enable:"spark.thumbnails.enable",metrics:["cdn_ve_media_bytes","spark_thumb_events"],counters:["cdn_thumb_req"],counters_zone:"gen",name:"thumbnails",watermark_on_eval_end:true},watch_later:{manifest:2,modules:["links","log","perr","players","stats"],title:"Watch later",enable:"spark.watch_later.enable",metrics:["cdn_ve_watch_later_events"],counters:["spark_watch_later_clk"],counters_zone:"glob",name:"watch_later",dep:["links","position_memory","widget"],wait_for_master_sync:true},position_memory:{manifest:2,modules:["links","log","players","stats","storage"],title:"Position memory",enable:"spark.position_memory.enable",platform_dependent_conf:true,metrics:["cdn_ve_position_memory_events"],counters:["cdn_ve_position_memory_events"],name:"position_memory",dep:["links"],wait_for_master_sync:true},autoplay:{manifest:2,modules:["links","log","perr","players","stats"],title:"Player auto play",enable:"spark.autoplay.enable",platform_dependent_conf:true,metrics:["cdn_ve_autoplay_events"],counters:["spark_video_prev_auto_click_clk","spark_image_prev_auto_click_clk","spark_watch_next_auto_click_clk"],counters_zone:"glob",name:"autoplay",force_enable:"video_autoplay",wait_for_master_sync:true},video_search:{manifest:2,modules:["history","log","stats"],title:"Video search",enable:"spark.video_search.enable",platform_dependent_conf:true,name:"video_search",metrics:[],counters:[],counters_zone:"glob",force_enable:["video_search","my_videos"],dep:["links","widget"]},share:{manifest:2,modules:["log","players"],title:"Page sharing",name:"share",enable:"spark.share.enable",metrics:[],counters:[],counters_zone:"glob",platform_dependent_conf:true},casting:{manifest:2,modules:["log","players","stats"],title:"TV video casting",name:"casting",enable:"spark.casting.enable",platform_dependent_conf:true,metrics:[],counters:[],counters_zone:"glob"},youtube_controls:{manifest:2,modules:["log","players"],title:"YouTube-like controls",name:"youtube_controls",enable:"spark.youtube_controls.enable",metrics:[],counters:[],counters_zone:"glob"},video_panel:{manifest:2,modules:["log"],title:"Video panel",enable:"spark.video_panel.enable",force_enable:"hola_my_videos",name:"video_panel",metrics:[],counters:[]},heatmap:{manifest:2,modules:["api","log","players","stats"],title:"Video heatmap",enable:"spark.heatmap.enable",name:"heatmap",metrics:[],counters:[]},newsreel:{manifest:2,modules:["api","links","log","stats"],title:"Newsreel",enable:"spark.newsreel.enable",name:"newsreel",metrics:[],counters:[]},sticky_player:{manifest:2,modules:["stats"],title:"Sticky player",enable:"spark.sticky_player.enable",name:"sticky_player",metrics:[],counters:[]},top_pages:{manifest:2,modules:["api","stats","storage"],title:"Top pages",enable:"spark.top_pages.enable",name:"top_pages",metrics:[],counters:[]}};E.ad_sources=["*.2mdn.net","*.serving-sys.com","*.adctrl.com","*.innovid.com","*.adform.net","*.gvt1.com","*.tubemogul.com","*.adsrvr.org","*.cdn.yimg.com","*.adnxs.com","*.flashtalking.com","*.mathtag.com","*.adformdsp.net","*.amazon-adsystem.com","**.fbcdn.net","*.weborama.fr","*.extremereach.io","*.http.atlas.cdn.yimg.com","*.teads.tv","*.centro.net","http.atlas.cdn.yimg.com","ad.appier.net","pixeltrack.eyeviewads.com","vstatic.fastclick.net","i.r1-cdn.net","studiov8-a.akamaihd.net","video.turncdn.com","*.sascdn.com","*.selectmedia.asia","ads.w55c.net","cache-ssl.celtra.com","*.movad.net","resources.eyereturn.com","twcmediasales.akamaized.net","**.etargetnet.com","**.spotxcdn.com","**.adventori.com","*.zedo.com","*.adtech.de","*.taboola.com","**.criteo.net","**.connatix.com","**.mediaplex.com","**.adocean.pl"];return E})})();
define("/svc/cdn/pub/msg.js",["/svc/cdn/pub/util.js","/util/events.js"],function(util,events){var E=Msg;var id="spark";function get_master(){if(window.top!=window)return{frame:window.top}}util.inherits(Msg,events.EventEmitter);function Msg(domain,opt){if(!(this instanceof Msg))return new Msg(domain,opt);this.uid=Msg.uid;this.domain=domain;this.opt=opt||{};this.magic="SPARK";this.handlers={};this.id=0;this.resps={};this.master=get_master();this._is_master=!this.master;window.addEventListener("message",this._onmessage.bind(this));(this.opt.handlers||[]).forEach(function(h){this._add_handler(h.type,h.name,h.func,h.opt)},this);if(this.opt.child_frames)this._setup_child_frames();this._log("frame messaging inited")}Msg.uid=Math.random().toString(36).substr(2,9);Msg.prototype._add_handler=function(type,name,func,opt){opt=opt||{};if(type=="top"&&this._is_master||type=="frame"&&!this._is_master){if(opt.async){this.handlers[name]=func;if(opt.exec_on_self){this[name]=func;this[name+"_cb"]=function(){var args=Array.prototype.slice.call(arguments);var cb=args.pop()||function(){};return func(null,cb)}}else this[name+"_cb"]=this[name]=function(){}}else{this[name]=opt.exec_on_self?func:function(){};this.handlers[name]=function(){var args=Array.prototype.slice.call(arguments);var cb=args.pop();var res=func.apply(null,args);cb(res)};this[name+"_cb"]=this.handlers[name]}return}this[name]=this[name+"_cb"]=this._create_handler(name,this.master)};Msg.prototype._create_handler=function(name,dst){var _this=this;return function(){var args=Array.prototype.slice.call(arguments);var cb;if(typeof args[args.length-1]=="function")cb=args.pop();else cb=function(){};var data={args:args};var resps=[];var _dst=dst&&[dst];if(!_dst){var frame_idx=data.args.shift();if(frame_idx=="all")_dst=_this.frames;else if(_this.frames[frame_idx])_dst=[_this.frames[frame_idx]];else{_this._log("trying to contact an inexistent frame "+frame_idx);return}}var wait=_dst.length;var _cb=function(){_cb=function(){};if(timeout)timeout=clearTimeout(timeout);cb(!resps.length?undefined:resps.length==1?resps[0]:resps)};var timeout=setTimeout(function(){timeout=undefined;_cb()},1e4);for(var i=0;i<_dst.length;i++){_this._send_req(_dst[i],name,data,function(res){resps.push(res.data);if(!--wait)_cb()})}}};Msg.prototype._find_frame=function(src){var _id=0;for(var f in this.frames){if(this.frames[f].uid==src.uid)_id=f}return _id};Msg.prototype._log=function(){};Msg.prototype._send_msg=function(dst,msg,data){var o=dst.origin||"*";this._log("sent msg "+msg+" to "+o+" with payload "+JSON.stringify(data));dst.frame.postMessage(this.magic+this.uid+JSON.stringify({type:id,domain:this.domain,cmd:msg,data:data}),o)};Msg.prototype._send_req=function(dst,msg,data,cb){if(!dst.frame)return cb({err:"missing frame src"});if(!data)data={};data.resp_id=this.id++;this.resp_id=data.resp_id;var _this=this;var timeout=setTimeout(function(){timeout=undefined;_finally();cb({err:"timeout"})},2e3);var _finally=function(){if(timeout)timeout=clearTimeout(timeout);delete _this.resps[_this.resp_id]};this.resps[data.resp_id]=function(resp){delete resp.resp_id;_finally();cb(resp)};this._send_msg(dst,msg,data)};Msg.prototype._setup_child_frames=function(){var _this=this,timer=500;this.frames={};this.frame_id=1;this.add_top_handler("_msg_hello",function(fid,src){if(fid)return;var _id=_this.frame_id++;_this.frames[_id]=src;_this.emit("frame_found",_id);return _id});this.add_top_handler("_msg_goodbye",function(fid){if(!fid)return;delete _this.frames[fid];_this.emit("frame_removed",fid)});if(!this._is_master){this._log("trying to contact master frame...");var send_hello=function(){_this._msg_hello_cb(function(res){if(!res){setTimeout(send_hello,Math.min(timer*=2,5e3));return}window.addEventListener("unload",_this._msg_goodbye.bind(_this));_this._log("master have responded");_this._has_master=true;_this.emit("master_found")})};send_hello()}};Msg.prototype._onmessage=function(event){var data=event&&event.data;if(typeof data!="string"||!data.startsWith(this.magic))return;var msg=JSON.parse(data.substr(this.magic.length+this.uid.length));msg.uid=data.substr(this.magic.length,this.uid.length);if(!msg||msg.type!=id||msg.domain!=this.domain||!msg.cmd)return;this._log("received msg "+msg.cmd+" with payload "+JSON.stringify(msg.data));if(msg.cmd=="result"){if(this.resps[msg.data.resp_id])this.resps[msg.data.resp_id](msg.data);else this._log("received a result message with unknown resp_id");return}var handler=this.handlers[msg.cmd];if(!handler)return void this._log("received an unknown message "+msg.cmd);var src={frame:event.source,origin:event.origin,uid:msg.uid};if(this._is_master&&this.opt.child_frames)msg.data.args.unshift(this._find_frame(src));var _this=this;var cb=function(_data){if(!src.frame)return;_this._send_msg(src,"result",{data:_data,resp_id:msg.data.resp_id})};msg.data.args.push(src,cb);handler.apply(null,msg.data.args)};Msg.prototype.add_frame_handler=function(name,func,opt){this._add_handler("frame",name,func,opt)};Msg.prototype.add_top_handler=function(name,func,opt){this._add_handler("top",name,func,opt)};return E});
define("/svc/cdn/pub/api.js",["/svc/cdn/pub/util.js","/util/escape.js","/svc/cdn/pub/ajax.js","/svc/cdn/pub/cdnlist.js","/svc/cdn/pub/perr.js","/svc/cdn/pub/zone.js","/util/util.js"],function(util,zescape,ajax,cdnlist,perr,_zone,zutil){var assign=Object.assign;var ccgi_server="https://client.h-cdn.com";var link_server="https://link.h-cdn.com";var ve_server="//ve.h-cdn.com";var sec_ms=1e3,min_ms=60*sec_ms;var E={conf:{}};function get_api_key(){return util.conf.ext_api_key}E.autoplay_preview=function(data,cb,cb_err){var _url=zescape.uri(ccgi_server+"/api/autoplay_preview",assign({customer:E.conf.customer,key:get_api_key()},data));var opt={url:_url,method:"POST",data:data,timeout:2*min_ms};ajax.json(opt,cb,cb_err)};E.preview_sec_ranges=function(data,cb){var _url=zescape.uri(ccgi_server+"/api/preview_sec_ranges",{customer:E.conf.customer,key:get_api_key()});var opt={url:_url,method:"POST",data:data,timeout:min_ms};var cb_err=function(res){if(res&&res.status_text=="timeout")return void cb();cb("Generation failed, please try again")};ajax.json(opt,cb.bind(null,undefined),cb_err)};E.block_preview=function(data,cb,cb_err){var _url=zescape.uri(ccgi_server+"/api/block_preview",{customer:E.conf.customer,key:get_api_key()});var opt={url:_url,method:"POST",data:data,timeout:2*min_ms};ajax.json(opt,cb,cb_err)};E.purge_page=function(page_url,cb,cb_err){var _url=zescape.uri(ccgi_server+"/api/purge_page",{customer:E.conf.customer,key:get_api_key(),url:page_url});ajax.json({url:_url,timeout:min_ms},cb,cb_err)};E.top_pages=function(tag,cb,cb_err){var _url=link_server+"/widget/top_pages?customer="+E.conf.customer;if(tag)_url+="&tag="+tag;ajax.json({url:_url,timeout:10*sec_ms},function(res){if(!res||res.status!="ok"||!res.data)return cb_err();cb(res.data)},cb_err)};E.video_search=function(params,cb,cb_err){ajax.raw({url:ccgi_server+"/cmd/search",qs:params},cb,cb_err)};E.playlist_set_static=function(opt,cb,cb_err){var _url=zescape.uri(ccgi_server+"/api/playlist_set_static",assign({customer:E.conf.customer,key:get_api_key(),zone:E.conf.spark_zone,type:opt.type},opt.info));ajax.json({url:_url,timeout:min_ms},cb,cb_err)};E.has_veedi_game_info=function(title,cb){var url=util.protocol+"//www.veedi.com/player/games_feed.php?title="+encodeURIComponent(util.game_title(title));ajax.raw({url:url},function(res){cb(+res!==0)},cb.bind(null,false))};E.get_from_cdn_host=function(cdn_host,cmd,opt,cb,cb_err){opt=opt||{};var qs=assign({customer:E.conf.customer},opt.qs);var data={url:"https://"+cdn_host+"/"+cmd,qs:qs,timeout:opt.timeout,data_type:"json"};ajax.raw(data,cb,cb_err)};E.get_image_previews=function(pages,cb){var host=typeof window!="undefined"&&window.location&&window.location.host;var opt={url:ve_server+"/image_previews/get_previews",method:"POST",data:{customer:E.conf.customer,image_pages:pages,host:host}};ajax.json(opt,cb)};function get_cdnlist(_cdnlist,zone,route){if(_cdnlist instanceof cdnlist.Cdn_list)return _cdnlist;if(_cdnlist&&_cdnlist.host)return new cdnlist.Cdn_list({cdns:[_cdnlist],zone:zone});if(Array.isArray(_cdnlist))return new cdnlist.Cdn_list({cdns:_cdnlist,zone:zone});if(E.conf.cdns)return new cdnlist.Cdn_list({cdns:E.conf.cdns,zone:zone});var user_agent=typeof navigator!="undefined"&&navigator.userAgent;var opt=assign(util.get_location_urls(),{user_agent:user_agent||"",segment_url:route.segment_url});var cdns=(cdnlist.local_url2cdns(zone,cdnlist.all_agents,util.geoip,route.video_url||route.url,opt)||{}).single;return new cdnlist.Cdn_list({cdns:cdns,zone:zone})}E._fetch_from_singles=function(cmd,route,opt,cb){cb=cb||function(){};var cdns;opt=opt||{};opt.timeout=opt.timeout||1e4;opt.gap_ms=opt.gap_ms||2e3;var sent={};var last_sent;var no_more_cdns=false;var send=function(_cb,_cb_err){var skip_cb=false;var _timeout;var __cb=function(){if(_timeout)_timeout=clearTimeout(_timeout);if(skip_cb)return;skip_cb=true;_cb.apply(null,arguments)};var zone=opt.zone||E.zone;var _cdns=get_cdnlist(opt.cdnlist,zone,route);if(!_cdns||!_cdns.length)return __cb();var cdn=_cdns.find(function(c){return!sent[c.host]});var timeout;if(!cdn){no_more_cdns=true;timeout=Math.max(opt.timeout-opt.gap_ms*_cdns.length,2e3)}else{timeout=opt.gap_ms;cdn.index=_cdns.arr.indexOf(cdn);if(opt.on_req)opt.on_req(cdn.index);sent[cdn.host]={};last_sent=cdn;if(cmd=="map_video_page"&&route&&route.url&&route.customer=="br_de"){var m=route.url.match(/(^.*video\/).*(av:[^\/]*)$/);if(m&&m.length==3){var url2=m[1]+m[2];var route2=zutil.clone(route);var data2=zutil.clone(opt.data);route2.url=url2;if(data2.user_meta){data2.user_meta.top_url=url2;data2.user_meta.frame_url=url2}console.log("sending redirect %s %o %o",url2,route2,data2);cdn.using(zone).send(cmd,route2,data2,function(){},{xhr_only:E.conf.debug,fetch_blob:opt.fetch_blob})}else{cdn.using(zone).send(cmd,route,opt.data,function(res){if(opt.on_res)opt.on_res(res.cdn.index,res);__cb(res)},{xhr_only:E.conf.debug,fetch_blob:opt.fetch_blob})}}else{cdn.using(zone).send(cmd,route,opt.data,function(res){if(opt.on_res)opt.on_res(res.cdn.index,res);__cb(res)},{xhr_only:E.conf.debug,fetch_blob:opt.fetch_blob})}}if(!Object.keys(sent).some(function(e){return!sent[e].err}))return __cb();_timeout=setTimeout(function(){_timeout=undefined;skip_cb=true;_cb_err("timeout")},timeout)};var response_cb=function(res){if(res&&res.cdn){sent[res.cdn.host].err=res.err;sent[res.cdn.host].status=res.status}if(res&&(res.err&&!res.status||[205,503].includes(res.status))&&!no_more_cdns){return send(response_cb,response_cb_err)}res=assign({sent:sent},res||{err:"all failed"});if(opt.cb)opt.cb(res);_finally();cb(res)};var response_cb_err=function(err){if(err=="timeout"&&!no_more_cdns){sent[last_sent.host].timeout=opt.gap_ms;return send(response_cb,response_cb_err)}var res={err:err,sent:sent};if(opt.cb)opt.cb(res);_finally();cb(res)};var _finally=function(){if(cdns instanceof cdnlist.Cdn_list&&cdns!=opt.cdnlist)cdns.uninit()};send(response_cb,response_cb_err)};E.pages2cdns=function(zone,_links){var maps=cdnlist.pages2cdns(zone,cdnlist.all_agents,_links);var res=[];_links.forEach(function(l){var url=typeof l=="object"?l.url:l;var group=res.find(function(g){return util.equal_deep(g.cdnlist,maps[url])});if(!group)group=res[res.push({cdnlist:maps[url],pages:[]})-1];group.pages.push(l)});return res};E.get_any_map_cdn=function(link){var cdns=E.pages2cdns(E.zone,[link]);return cdns&&cdns[0]&&cdns[0].cdnlist&&cdns[0].cdnlist[0]&&cdns[0].cdnlist[0].hostname};function get_groups(cmd,zone,_links,opt){if(opt.cdnlist)return[{cdnlist:opt.cdnlist,pages:_links}];if(cmd=="get_links_info"&&_links.length<E.spark.get_conf("general.max_merged_links",0)){var groups=E.pages2cdns(zone,[_links[0]]);groups[0].pages=_links;return groups}return E.pages2cdns(zone,_links)}E._fetch_from_map_cdns=function(cmd,route,opt,cb,cb_err){opt=opt||{};E.conf.get_top_url(function(top_url){var ret=[];var zone=opt.zone||E.zone;var error,was_timeout;var _links=opt.links||[{url:top_url,type:"page"}];var groups=get_groups(cmd,zone,_links,opt);var wait=groups.length;var timeout=setTimeout(function(){timeout=undefined;was_timeout=true;cb_err({err:timeout})},opt.timeout||18e3);for(var i=0;i<groups.length;i++){var g=groups[i];var _opt=assign({g_id:i},opt,{cdnlist:g.cdnlist,data:opt.data||(opt.links?{items:g.pages,full:opt.full}:undefined),gap_ms:6e3});E._fetch_from_singles(cmd,route,_opt,function(res){if(was_timeout)return;if(opt.cb)opt.cb(res);if(res&&!res.err)ret.push(res);error=error||res&&res.err;if(!--wait){if(timeout)timeout=clearTimeout(timeout);cb(ret.length?ret:{err:error})}})}})};E.get_playlists=function(last,hits,opt,cb,cb_err){cb_err=cb_err||function(){};last=(last||[]).sort().join(" ");opt=opt||{};var key=[];var cache=E.get_playlists.cache=E.get_playlists.cache||{};var cdn_host=opt.cdn_host||util.url2sparkorigin(E.spark.top_url);var p=assign({customer:E.conf.customer,last:last,hits:hits,vinfo:1,spark_zone:E.conf.spark_zone,lxc:util.is_zlxc,cver:1},opt);delete p.cdn_host;for(var e in p)key.push(e+p[e]);key=key.sort().join("_");var c=cache[key]=cache[key]||{};if(c.playlist)return void cb(c.playlist);c._cb=c._cb||[];c._cb.push(cb);c._cb_err=c._cb_err||[];c._cb_err.push(cb_err);if(c._in_progress)return;c._in_progress=true;var finish_response=function(){c._cb=[];c._cb_err=[];c._in_progress=false};var _cb_err=function(){for(var i=0;i<c._cb_err.length;i++)c._cb_err[i].apply(null,arguments);finish_response()};var _cb=function(res){if(!res||res.err)return void _cb_err(res&&res.err);if(!cdn_host){if(!res.length||!res[0])return void _cb_err("empty response");if(res[0].err)return void _cb_err(res[0].err);res=res[0].res}if(!res||res.error)return void _cb_err(res&&res.error);c.playlist=res;for(var i=0;i<c._cb.length;i++)c._cb[i](c.playlist);finish_response()};if(cdn_host){return void E.get_from_cdn_host(cdn_host,"cmd/get_playlists",{qs:p},_cb,_cb_err)}E._fetch_from_map_cdns("get_playlists",p,{timeout:3e4,cdnlist:opt.cdnlist},_cb,_cb_err)};E.get_playlist_popular=function(opt,cb,cb_err){cb_err=cb_err||function(){};if(!["1w","1d","6h"].includes(opt.period))opt.period="1d";E.get_playlists([opt.period],opt.pages_num*2,{},function(pl){if(!pl)return void cb();pl=pl[Object.keys(pl)[0]];if(!pl||!pl.length)return void cb();var _playlist=[];if(typeof opt.prefilter_fn=="function")pl=pl.filter(opt.prefilter_fn);pl.forEach(function(item){var exists=_playlist.some(function(v){return v.location==item.location});if(!exists&&_playlist.length<opt.pages_num)_playlist.push(item)});cb(util.conv_playlist_for_widget(_playlist))},cb_err)};E.send_map=function(data,cdns){var cmd="map_video_page";E.spark.stats.start(cmd);var route={customer:E.conf.customer,url:E.spark.top_url,tag_id:E.spark.tag_id};var opt={data:data,timeout:1e4,cdnlist:cdns,zone:E.zone};var cb=function(){E.spark.stats.stop(cmd)};var cb_err=function(){E.spark.stats.inc_d(cmd+"_fail_n");E.spark.stats.stop(cmd)};E._fetch_from_map_cdns(cmd,route,opt,cb,cb_err)};E.get_ads_txt=function(cb,cb_err){var url=location.protocol+"//"+location.host+"/ads.txt";ajax.raw({url:url,timeout:5*sec_ms},cb,cb_err)};function check_status(prefix,data){var PROCESSING_LIMIT=2*min_ms;var PROCESSING_LIMIT_ACTIVE=8*min_ms;var res;if((res=data.res)&&(res.info&&res.urls||res.size&&res.type))return void E.stats.inc_d(prefix+"success_n");var err;if(err=res&&res.error||data.err){if(/live_video/.test(err))return void E.stats.inc_d(prefix+"skip_live_video_n");if(err=="unsupported_media")return void E.stats.inc_d(prefix+"skip_unsupported_media_n");E.stats.inc(prefix+"fail_n");if(/^\w+$/.test(err))return void E.stats.inc_d(prefix+"fail_"+err+"_n");if(/generate_error/.test(err)){perr({id:"thumbnails_generate_error",throttle:1,info:{error:err}})}var errors={generate_error:/generate_error/,empty_playlist:/empty_playlist/,wrong_origin:/^wrong origin$/,get_video:/get_video_error/,all_failed:/^all failed$/};for(var key in errors){if(errors[key].test(err))return void E.stats.inc_d(prefix+"fail_"+key+"_n")}return void E.stats.inc_d(prefix+"fail_error_n")}var status;if(!(status=res&&res.status)){E.stats.inc(prefix+"fail_n");return void E.stats.inc_d(prefix+"fail_no_status_n")}var elapsed=res.elapsed;var limit=["downloading","generating"].includes(status)?PROCESSING_LIMIT_ACTIVE:PROCESSING_LIMIT;if(elapsed<limit){E.stats.inc_d(prefix+"processing_short_n");return void E.stats.inc_d(prefix+"processing_short_"+status+"_n")}E.stats.inc(prefix+"fail_n");E.stats.inc_d(prefix+"fail_processing_"+status+"_n")}E.get_thumb=function(cdns,video_url,final_url,cb){cdns=(cdns||[]).slice();var cdn_host;if(cdn_host=util.url2sparkorigin(E.spark.top_url))cdns.unshift({host:cdn_host,hostname:cdn_host});var opt={cdnlist:cdns,fetch_blob:true,on_req:function(){E.stats.inc("get_thumb_n")},on_res:function(n,data){check_status("get_thumb_",data)},zone:E.zone};var route={customer:E.conf.customer,final_url:final_url,url:video_url,zone:E.zone.name};if(E.spark.force_enable("thumbnails"))route.ext=1;E._fetch_from_singles("get_thumb",route,opt,cb)};E.get_thumb_info=function(video_url,cb){var opt={on_req:function(){E.stats.inc("get_thumb_info_n")},on_res:function(n,data){check_status("get_thumb_info_",data)},zone:E.zone};var route={customer:E.conf.customer,url:video_url,zone:E.zone.name};if(E.spark.force_enable("thumbnails"))route.ext=1;E._fetch_from_singles("get_thumb_info",route,opt,cb)};E.get_heatmaps=function(video_url,cb){var route={customer:E.conf.customer,url:video_url,zone:E.zone.name};E._fetch_from_singles("get_heatmaps",route,{},cb)};E.get_preview_sizes=function(video_url,zagent,cb){var route={customer:E.conf.customer,url:video_url};var opt={cdnlist:zagent,timeout:10};E._fetch_from_singles("get_preview_sizes",route,opt,cb)};E.get_links_info=function(links,opt,process_cb,cb,cb_err){cb_err=cb_err||function(){};var _opt={links:links,full:opt.full,timeout:1e4,cdnlist:opt.cdns,zone:E.zone,cb:process_cb};var route={customer:E.conf.customer,url:opt.url||E.spark.top_url};if(opt.debug_key)route.debug_key=opt.debug_key;E._fetch_from_map_cdns("get_links_info",route,_opt,cb,cb_err)};E.init=function(spark,conf){E.spark=spark;E.conf=conf;E.stats=conf.stats;E.zone=new _zone(spark.loader,assign({zone:"gen"},spark._gen))};E.t={uninit:function(){E.get_playlists.cache={}}};E.ajax=ajax;return E});
define("/svc/cdn/pub/links.js",["cash","/svc/cdn/pub/util.js","/svc/cdn/pub/spark_features.js","/util/url.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/msg.js","/svc/cdn/pub/api.js"],function($,util,spark_features,zurl,dom_util,_msg,api){var E=new util.events,assign=Object.assign,id="links";var NUM_DB_FAIL=3,NUM_DUPLICATES=5,log;var ms_sec=1e3;var def_opt={unite_img_and_link:"a",img_selector:"img"};var scan_timeout,sent_links={},links_info={};var links_info_page={};var all_links=[],pending_update_db=[];var rejected_origins=["javascript","mailto","bit.ly","facebook.com","goo.gl","google.com","instagram.com","itunes.apple.com","linkedin.com","telegram.me","twitter.com","youtube.com"].map(function(o){return new RegExp("^(https?://)?[^/]*"+o+"([/:].*)?$")}).concat(spark_features.ad_sources.map(function(s){return new RegExp("^"+zurl.http_glob_url(s))}));var rejected_containers='div[id^="google_ads_iframe_"]';var db_fail_cnt=0;function activate_scan(){E.scan();init_scan_on_scroll()}function big_enough(c,p){var cs=c.getBoundingClientRect(),ps=p.getBoundingClientRect();var w=Math.min(cs.right,ps.right)-Math.max(cs.left,ps.left);var h=Math.min(cs.bottom,ps.bottom)-Math.max(cs.top,ps.top);return w>(ps.right-ps.left)*.3&&h>(ps.bottom-ps.top)*.5}function cache_get(store,link){return store[link.url||link]||store[link.cache_url||E.spark.page2cache(link.url||link)]}function clear_duplicates(links){var posters={},descriptions={};var set=function(obj,key){obj[key]=key?(obj[key]||0)+1:0};links.forEach(function(l){set(posters,l.poster);set(descriptions,l.description);if(l.img.length&&!l.by_spark)set(l.img[0],"hola-links-used")});links.forEach(function(l){if(posters[l.poster]>NUM_DUPLICATES){delete l.poster;delete l.nat_size}if(descriptions[l.description]>NUM_DUPLICATES)delete l.description});var dup_images=[];return links.filter(function(l){if(!l.img.length)return true;if(l.img[0]["hola-links-used"]>1)dup_images.push(l.img[0]);delete l.img[0]["hola-links-used"];if(l.by_spark||!dup_images.includes(l.img[0]))return true;l.img=$();return is_link_allowed(l)})}function clear_scan(){scan_timeout=clearTimeout(scan_timeout)}function api_get_links_info(ctx,items,opt,cb,cb_err){E.last_sent_update_db=Date.now();E.stats.set_ms_since("first_sent_info_req_ms","first_scan_ms",3e4);var process_cb=process_responses_db.bind(null,ctx);var _opt={cdns:E.conf.cdns||E.conf.cdn,full:opt.full,url:opt.url};var modal_box=E.conf.modal_box;if(modal_box&&modal_box.enable&&modal_box.use_frame_url)_opt.debug_key="frame_url";api.get_links_info(items,_opt,process_cb,cb,cb_err)}function fetch_from_endpoint(url,ctx,items,opt,cb,cb_err){var disable_fallback=E.spark.get_conf("general.get_links_info.disable_fallback");var data={customer:E.spark.customer,items:items};var page_info;if(page_info=get_page_info())data.page_info=page_info;fetch_from_endpoint.last_sent_url=E.spark.top_url;if(!E.spark.get_orig_conf("general.get_links_info.origin")){data.origin=E.spark.get_conf("general.get_links_info.origin")||api.get_any_map_cdn(items[0])}var _cb=function(res){var _data=res&&{res:res};if(!_data){if(!disable_fallback)return api_get_links_info(ctx,items,opt,cb,cb_err);_data={res:[]}}var item,preview_url;for(var i=0;i<items.length;i++){item=items[i];if(!item.size||item.size=="1x1"||item.size=="0x0"||!item.url){continue}preview_url=_data.res[item.url]&&_data.res[item.url].preview&&_data.res[item.url].preview.url;if(!preview_url)continue;_data.res[item.url].preview.url=preview_url.replace(/&size=\d+x\d+/,"&size="+item.size)}process_responses_db(ctx,_data);cb()};api.ajax.json({url:url,data:data,timeout:5*ms_sec,content_type:"application/json",method:"POST"},_cb,_cb.bind(null,null))}function find_biggest(img){img=img.filter(is_visible);if(img.length<=1)return img;var max,max_size;img.each(function(i){var size=i.clientWidth*i.clientHeight;if(max&&size<=max_size)return;max_size=size;max=i});return $(max)}function get_href(a,opt){if(a.hasAttribute("data-spark_preview_page_url"))return a.getAttribute("data-spark_preview_page_url");var ret=opt.get_href&&opt.get_href(a,window.location.host,$)||a.href;return(opt.href_keep_hash?ret:ret&&ret.replace(/#.*/,""))||""}function get_img(a){var img;if(a.hasAttribute("data-spark_preview_link")&&(img=$(a).find("[data-spark_preview_img]")).length){return img}if(E.conf.get_img){img=E.conf.get_img(a,$);if(!img)return;if(img instanceof $)return find_biggest(img);if(typeof img!="string"&&dom_util.is_convertible_to_cashjs(img))return find_biggest($(img))}var ret=find_biggest($(a).find(E.conf.img_selector));if(ret.length||E.conf.disable_get_img_style)return ret;if(get_img_style(a)&&is_visible(a))return $(a);ret=find_biggest($(a).find("*").filter(function(c){return get_img_style(c)&&big_enough(c,a)}));if(ret.length)return ret;ret=find_biggest($(a).parents().filter(function(p){if(window.Node&&window.Node.ELEMENT_NODE!=p.nodeType)return false;return get_img_style(p)&&big_enough(a,p)}));return ret}function get_img_style(el){if(E.conf.disable_get_img_style)return;var img_src=dom_util.parse_bg_image($(el).css("background-image"));if(img_src!=location.href)return img_src}function get_link_text(a,links,img,opt){var $a=$(a),c;if((c=$a.children(".hola_preview_container"))&&c.length){$a=$a.clone();$a.find(".hola_preview_icon_countdown").remove()}var methods=[function(){return opt.get_link_text&&opt.get_link_text(a)},function(){return $a[0].title},function(){return(c=$a.children(".description")[0])&&c.innerText},function(){return $a[0].innerText},function(){return img[0]&&(img[0].alt||img[0].title)},function(){return $a.text()},function(){return $a.attr("spark_video_title")},function(){return $a.attr("hola_spark_video_title")}];var trim=function(t){return t?t.trim().replace(/\s+/g," "):""};var text;for(var i=0;i<methods.length;i++){if((text=trim(methods[i]()))&&E.is_text_allowed(text))return text}return links.map(function(el){return el.textContent}).map(trim).filter(E.is_text_allowed).sort(function(s1,s2){return s2.length-s1.length})[0]}function get_links(opt){E.stats.inc_d("get_n");var cur_links=[],sel_ar,conf_links;if(!opt.force_link_scan&&(opt.enable===false||opt.disable))sel_ar=[];else{conf_links=opt.links_selector||"a";sel_ar=Array.isArray(conf_links)?conf_links:[conf_links];if(opt.text_links_selector)sel_ar.push(opt.text_links_selector)}var internal_preview_sel="[data-spark_preview_link]";var public_preview_sel="a[spark_ve_preview], a[hola_ve_preview], "+"a[data-spark-ve-preview]";sel_ar.push(internal_preview_sel,public_preview_sel);var text_links=[];sel_ar.forEach(function(sel){var t;if(typeof sel=="function")t=sel($,{editor_mode:!!E.conf.edit_ext,E:E});else t=$(sel);if(sel==opt.text_links_selector)text_links=text_links.concat(t.get());var a=$(t).filter(function(e){return!cur_links.includes(e)&&!e.classList.contains("hola_widget_tile")});if(opt.filter)a=a.filter(opt.filter);if(!a.length)return;cur_links=cur_links.concat(a.get())});opt.text_links=text_links;var ret=[],link_info;for(var i=0;i<cur_links.length;i++){if(!is_link_parent_allowed(cur_links[i]))continue;if(!(link_info=E.get_link_info(cur_links[i],opt,true)))continue;if(is_link_allowed(link_info))ret.push(link_info)}return clear_duplicates(ret)}function get_links_db(links,opt,cb){cb=cb||function(){};var cmd="get_links_info";var items_data={};var items=links.sort(function(l1,l2){return-E.size_util.compare(l1.size,l2.size)}).filter(function(l){return!items_data[l.url]&&(items_data[l.url]=l)}).map(function(l){var r=util.pick(l,"url","type","by_spark","current","size","nat_size");if(l.live)r.live=true;if(l.self||l.by_spark)return r;return assign(r,util.pick(l,"poster","description"))});if(!items.length)return void cb();items.forEach(function(l){if(!cache_get(sent_links,l)||E.size_util.compare(l.size,cache_get(sent_links,l))>0){sent_links[l.url]=l.size||"0x0"}});var count=E.stats.start(cmd);if([5,10,20,50].indexOf(count)>-1)E.stats.inc_d(cmd+"_over_"+count+"_n");E.stats.inc_d(cmd+"_url_n",items.length);var ctx={items:items,items_data:items_data,links:links};var _ret;var response_handler=function(){try{var ret=ctx.ret||{};var missing={};items.forEach(function(i){if(!(i.url in ret))missing[i.url]=null});if(Object.keys(missing).length)process_responses(ctx,missing);_ret={res:ret}}catch(e){cb_err()}_finally()};var cb_err=function(){E.stats.inc_d(cmd+"_fail_n");if(db_fail_cnt++<NUM_DB_FAIL){items.forEach(function(l){sent_links[l.url]=0});links.forEach(function(l){scanned(l.link,"error")})}_finally()};var _finally=function(){submit_scan();E.stats.stop(cmd);cb(_ret)};clear_scan();var url=util.get(E.spark.conf,"general.get_links_info.endpoint");if(url)fetch_from_endpoint(url,ctx,items,opt,response_handler,cb_err);else api_get_links_info(ctx,items,opt,response_handler,cb_err)}var get_links_info_page_force_res;function get_links_info_page_force(links,cb){var conf=util.get(E.spark.conf,"general.get_links_info_pages");var inc=function(n){E.stats.inc("get_links_info_playlist_preload_"+n+"_n")};var playlist_preload;if(!conf||!conf.enable||!(playlist_preload=conf.playlist_preload))return void cb();if(!playlist_preload.enable){inc("disabled");return void cb()}inc("enabled");if(Math.random()>playlist_preload.ratio){inc("ratio_off");return void cb()}inc("ratio_on");links=links.filter(function(item){return item.by_spark=="playlist_preload"});if(!links.length){inc("no_links");return void cb()}if(get_links_info_page_force_res)return void cb(get_links_info_page_force_res);var parsed_url=zurl.parse(E.spark.top_url);var route={customer:E.spark.customer,url:parsed_url.protocol+parsed_url.hostname+"/spark_playlist_preload"};inc("req");var cb_success=function(res){if(!res||!res.links||!Object.keys(res.links).length){inc("empty_res");return void cb()}get_links_info_page_force_res=res;inc("got_res");var ret={};links.forEach(function(link){var key=E.spark.page2cache(link.url);if(res.links[key])ret[link.url]=assign({},link,res.links[key])});assign(links_info_page,res.links);cb(ret)};var cb_err=function(){inc("error");cb()};api.get_from_cdn_host(conf.host||"player.h-cdn.com",conf.cmd||"api/get_links_info_page",{qs:route,timeout:conf.timeout||10*ms_sec},cb_success,cb_err)}function get_links_info_route(url){var route={customer:E.spark.customer,url:url||E.spark.top_url};var modal_box=E.conf.modal_box;if(modal_box&&modal_box.enable&&modal_box.use_frame_url)route.debug_key="frame_url";return route}function get_opt(opt){return assign({url:E.spark.top_url},E.conf,opt)}function get_page_info(){if(!util.is_top)return;var data=dom_util.get_page_info();var fn;if(fn=E.spark.get_conf("general.get_links_info.get_page_info_fn"))data=util.custom_fn(fn,"data")(data);if(!data)return;data.was_sent=fetch_from_endpoint.last_sent_url==E.spark.top_url;var tags;if(fn=E.spark.get_conf("general.get_links_info.get_page_tags_fn"))tags=util.custom_fn(fn,"util")(util);if(Array.isArray(tags)&&tags.length)data.tags=tags;return data}function handle_get_links_info_page(links){if(!E.get_links_info_pages_enabled)return links;var unhandled=[],items=[],items_map={};var conf=util.get(E.spark.conf,"general.get_links_info_pages");links.forEach(function(link){var url=link.url;var cache_url=link.cache_url||E.spark.page2cache(url),info;if(!(info=links_info_page[url]||links_info_page[cache_url]))return void unhandled.push(link);items.push(link);info.from_page_links=true;items_map[url]=info;if(info.preview||conf.mark_sent)sent_links[url]=info.size||"0x0";else unhandled.push(link)});var ctx={items:items,items_data:{},links:items};process_responses(ctx,items_map);if(conf.fallback_ratio&&Math.random()>conf.fallback_ratio)return[];return unhandled}function init_links_info_pages(_cb){var conf=E.spark.get_conf("general.get_links_info_pages");var url=E.spark.top_url;if(E.conf.enable===false||E.conf.disable||!conf||!conf.enable||conf.urls&&!util.check_url(url,conf.urls&&!conf.check_urls_on_scan)){return void _cb()}log.info("links_info_pages is active");E.get_links_info_pages_enabled=true;if(conf.transform_url)url=conf.transform_url(url);E.stats.inc("get_links_info_page_n");var opt={qs:get_links_info_route(url),timeout:conf.timeout||3*ms_sec};var cb=function(ret){if(ret&&ret.links&&Object.keys(ret.links).length){E.stats.inc("get_links_info_page_success_n");links_info_page=ret.links}_cb()};var cb_err=function(err){if(err&&err.status_text=="timeout")E.stats.inc("get_links_info_page_timeout_n");else E.stats.inc("get_links_info_page_failed_n");_cb()};api.get_from_cdn_host(conf.host||"player.h-cdn.com",conf.cmd||"api/get_links_info_page",opt,cb,cb_err)}function init_scan_on_scroll(){if(!E.conf.scan_on_scroll)return;E.stats.inc_d("scroll_scan_init_n");var size=document.body&&document.body.innerHTML.length,scroll_timeout;$(window).on("scroll",function(){clearTimeout(scroll_timeout);scroll_timeout=setTimeout(function(){var new_size=document.body&&document.body.innerHTML.length;if(new_size==size)return void E.stats.inc_d("scroll_no_scan_n");size=new_size;E.stats.inc_d("scroll_scan_n");var new_links;if(!(new_links=E.scan()))return;E.stats.inc_d("scroll_scan_found_n");E.stats.inc_d("scroll_scan_found_links_n",new_links)},200)})}function is_link_allowed(l){if(E.conf.is_link_allowed&&!E.conf.is_link_allowed({$:$,E:E,link_info:l})){return false}return!!(l.img.length||l.text_link)}function is_link_parent_allowed(el){return E.conf.disable_reject_check||!$(el).closest(rejected_containers).length}function is_link_url_allowed(url){if(!E.spark.is_video_url_allowed(url))return false;return E.conf.disable_reject_check||!rejected_origins.find(function(o){return o.test(url)})}function is_live_video(a){return!!$(a).attr("spark_ve_preview_live")}function is_playlist_link(a){return $(a).attr("data-spark_feature")=="playlist"}function is_visible(el){var allow=E.conf.allow_hidden;if(allow===true||allow&&typeof allow=="string"&&$(el).parents(allow).length){return true}return dom_util.is_visible(el)}function listen_href_updates(links,opt){var href_prop="hola-links-href";links.forEach(function(l){var link=l.link,$link=$(link);if($link.prop(href_prop))return;$link.prop(href_prop,l.url);dom_util.dom_listen(link,function(){var new_href=E.get_href(link,opt);if($link.prop(href_prop)==new_href)return;$link.prop(href_prop,new_href);E.emit("detach",[link]);scanned(link,0);E.scan()})})}function overwrite_data(data){if(!data)return;if(data.poster&&!E.is_poster_allowed(data.poster))delete data.poster;if(data.video_poster&&!E.is_poster_allowed(data.video_poster))delete data.video_poster;if(data.description&&!E.is_text_allowed(data.description))delete data.description;if(data.video_title&&!E.is_text_allowed(data.video_title))delete data.video_title;if(E.conf.use_video_poster&&E.conf.use_video_poster(data))data.poster=data.video_poster||data.poster;if(E.conf.use_video_title&&E.conf.use_video_title(data))data.description=data.video_title||data.description}function process_responses(ctx,data){var ret={},dom=["link","links","img","unite"];var update_db=function(item,db_data){var url=item.url,info;if(!(info=cache_get(links_info,item)))info=links_info[url]={db:{}};overwrite_data(db_data);ret[url]=util.defaults({},ctx.items_data[url],db_data||info.db);util.extend_deep(info,ret[url]);for(var i=0;i<dom.length;i++)delete info[dom[i]];assign(info.db,db_data);if(url==E.spark.top_url&&db_data){E.emit("update_page_db",E.get_db([item]));E.last_update_page_db=Date.now()}};ctx.items.forEach(function(p){if(p.url in data)update_db(p,data[p.url])});ctx.ret=ctx.ret||{};assign(ctx.ret,ret);var updated=ctx.links.concat(pending_update_db).filter(function(l){return!l.current&&ret[l.url]});if(!updated.length)return;pending_update_db=pending_update_db.filter(function(l){return!updated.includes(l)});E.last_update_db=Date.now();E.emit("update_db",E.get_db(updated))}function process_responses_db(ctx,res){if(!res||res.err||!res.res)return;var data=res.res;E.stats.set_ms_since_d("first_resp_info_req_ms","first_sent_info_req_ms",3e4);Object.keys(data).forEach(function(k){if(typeof data[k]=="string")data[k]={url:data[k]};var video_url=data[k].full_video_url;if(video_url&&!E.spark.is_video_url_allowed(video_url))return delete data[k];if(res.cdn){data[k].cdn=util.protocol=="https:"?res.cdn.hostname:res.cdn.host}});db_fail_cnt=0;process_responses(ctx,data)}function scanned(el,val){return $(el).prop("hola-links-scanned",val)}function set_page_info(info){if(info)links_info[E.spark.top_url]=info;else E.failed_set_page_info=Date.now();E.emit("set_page_info",info)}function stats_init(){E.stats=E.spark.stats.alloc(id,null,E.conf);E.stats.mod_init=function(reset){this.init(reset);this.timers={};this.durations={}};E.stats.changed=E.stats.changed.bind(E.stats,true);E.stats.get_stats=function(){for(var key in this.durations)this.set_d(key+"_ms",this.durations[key]/this.get(key+"_n"));return this.o};E.stats.start=function(s){this.timers[s]=util.date_monotonic();this.durations[s]=this.durations[s]||0;return this.inc_d(s+"_n")};E.stats.stop=function(s){if(!this.timers[s])return;this.durations[s]+=util.date_monotonic()-this.timers[s];delete this.timers[s]};E.stats.mod_init()}function submit_scan(){clear_scan();var diff=Date.now()-E.first_scan;scan_timeout=setTimeout(E.scan,diff<5e3?500:diff<15e3?1e3:3e3)}function uninit(){clear_scan();links_info={};sent_links={};E.off("update");E.off("update_db")}E.size_util={get_size:function(img){return{width:img.clientWidth,height:img.clientHeight}},get_natural_size:function(img,poster,allow_empty){var i;if(!poster)return{width:0,height:0};if((i=img).tagName!="IMG"){i=new Image;i.src=poster||allow_empty&&""}return{width:i.naturalWidth,height:i.naturalHeight}},normalize:function(val){return Math.round(Math.min(val||0,9999))},serialize:function(size){return size&&E.size_util.normalize(size.width)+"x"+E.size_util.normalize(size.height)},parse:function(size){var parsed=/(\d+)x(\d+)/.exec(size);if(!parsed)return;return{width:+parsed[1],height:+parsed[2]}},calc:function(size){var parsed=typeof size=="string"?E.size_util.parse(size):size;if(!parsed)return;return parsed.width*parsed.height},compare:function(s1,s2){return(E.size_util.calc(s1)||0)-(E.size_util.calc(s2)||0)},find_bigger:function(s,sizes){sizes=sizes.slice();sizes.sort(E.size_util.compare);return sizes.find(function(_s){return E.size_util.compare(s,_s)<=0})||sizes[sizes.length-1]},find_bigger_by_width:function(s,sizes){var i,size;sizes=(sizes||[]).slice();if(!sizes.length)return s;for(i=0;i<sizes.length;i++){size=E.size_util.parse(sizes[i])||{width:0};size.size_str=sizes[i];sizes[i]=size}sizes.sort(function(s1,s2){return s1.width-s2.width});s=E.size_util.parse(s)||{width:0,height:0};for(i=0;i<sizes.length;++i){if(s.width<=sizes[i].width)return sizes[i].size_str}return sizes[sizes.length-1].size_str}};E.append_rejected_origins=function(srcs){rejected_origins=rejected_origins.concat(srcs.map(function(o){return new RegExp("^(https?://)?[^/]*"+o+"([/:].*)?$")}))};E.filter=function(links,opt){return links.filter(function(l){return l.current||/^(https?:)?\/\//.test(E.get_href(l.link,get_opt(opt)))})};E.force_get_db=function(links,opt,cb){get_links_info_page_force(links,function(ret){if(ret)return cb(ret);get_links_db(links,assign(get_opt(opt),{force:true}),cb)})};E.get=function(opt){return get_links(get_opt(opt))};E.get_db=function(links,opt){E.stats.inc_d("get_db_n");links=links||E.get(opt);return links.map(function(l){return assign({},l,cache_get(links_info,l))})};E.get_href=function(a,opt){return E.get_video_url(a,opt)||get_href(a,opt)||""};E.get_link_info=function(a,opt,validate_url){var video_url,allow_video;var v_url=E.get_video_url(a,opt);if(allow_video=v_url!="none")video_url=v_url;var page_url=get_href(a,opt);var url=allow_video?E.get_href(a,opt):page_url;var link_url=video_url||url;if(validate_url&&!is_link_url_allowed(link_url))return;var adaptive,cache_v_url;if(video_url){adaptive=!!util.get_adaptive_type(video_url);cache_v_url=E.spark.video2cache(video_url,adaptive)}var cache_url=E.spark.page2cache(url);var unite_sel=opt.unite_img_and_link=="a"&&a.tagName!="A"?a:opt.unite_img_and_link;var $a=$(a),unite,links=$([]);if(unite_sel){var u=$a.closest(unite_sel);if(u.length&&u[0]!=a)unite=u;links=u.find("a[href]").not($a).filter(function(el){return E.get_href(el,opt)==url})}var by_spark=a.getAttribute("data-spark_feature");var img=get_img(a),size,poster,nat_size;if(img.length){var size_el=E.get_img_size_el(img,opt);var s=E.size_util.get_size(size_el[0]);size=E.size_util.serialize(s);var img_src=E.get_img_src(img,opt);var natural_size=E.size_util.get_natural_size(img[0],img_src,by_spark);if(by_spark||util.is_mocha())poster=img_src;else if(!E.is_poster_allowed(img_src,opt))E.stats.inc_d("poster_not_allowed");else if(!natural_size.width)E.stats.inc_d("nat_size_missing");else if(E.size_util.calc(natural_size)>400){E.stats.inc_d("nat_size_ok");poster=img_src;nat_size=E.size_util.serialize(natural_size)}else E.stats.inc_d("nat_size_small")}var text_links=opt.text_links||[];return{link:a,links:links,unite:unite,url:link_url,page_url:page_url,cache_url:cache_v_url||cache_url,type:video_url?"video":"page",img:img,poster:poster,size:size,nat_size:nat_size,description:get_link_text(a,links,img,opt),video_url:cache_v_url,adaptive:adaptive,root:/.*\/\/[^\/]*\/$/.test(url),self:cache_url==E.spark.cache_top_url,by_spark:by_spark,force_video:allow_video&&!!v_url,no_video:!allow_video,text_link:text_links.includes(a),live:is_live_video(a),playlist:is_playlist_link(a)}};E.get_img_size_el=function(img,opt,overlay){var img_size;var selector=overlay?opt.img_size_for_overlay||opt.img_size:opt.img_size;var func=opt.img_size_func;if(selector)img_size=img.closest(selector);if(func)img_size=func(img,{img_size:img_size,overlay:overlay,E:E});if(!img_size||!img_size.length)img_size=img;return img_size};E.get_img_src=function(img,opt){if(img.length)img=img[0];var src;if(src=img.getAttribute("data-spark_preview_img_src"))return src;if(opt.get_img_src&&(src=opt.get_img_src($(img))))return src;if((src=img.src||img.currentSrc)&&!/^data:/.test(src))return src;src=img.getAttribute("data-original")||img.getAttribute("data-src")||img.getAttribute("srcset")||img.getAttribute("data-srcset")||img.getAttribute("data-spark-src");return src||get_img_style(img)};E.get_page_db=function(){return cache_get(links_info,E.spark.top_url)};E.get_video_url=function(a,opt){var v_url=a.getAttribute("data-spark_preview_video_url")||a.getAttribute("spark_ve_preview")||a.getAttribute("data-spark-ve-preview")||a.getAttribute("hola_ve_preview");return v_url||opt.get_video_url&&opt.get_video_url(a,$)||""};E.is_poster_allowed=function(p,opt){opt=opt||E.conf;return p&&util.is_poster_allowed(p)&&!(opt.skip_poster&&opt.skip_poster(p))};E.is_text_allowed=function(t){var m;return t&&t.length>3&&(m=t.match(/[^0-9\s]/g))&&m.length/t.length>.4&&!(E.conf.skip_text&&E.conf.skip_text(t))};E.scan=function(opt){try{if(top===self){var url=top.location.href;if(E.conf.urls&&!util.check_url(url,E.conf.urls))return}}catch(err){console.error("spark error %o",err)}if(opt&&opt.allow_hidden!==undefined)E.conf.allow_hidden=opt.allow_hidden;E.stats.set_ms_since_d("first_scan_ms",6e4);E.stats.start("scan");E.first_scan=E.first_scan||Date.now();clear_scan();var detached=[],all=[];var contains=function(doc,l){return doc.body&&doc.body.contains(l)};all_links.forEach(function(l){if(contains(document,l)||is_playlist_link(l)&&$("div.hola_playlist").get().find(function(i){return i.contains(l)})){return void all.push(l)}detached.push(l);scanned(l,0)});all_links=all;if(detached.length)E.emit("detach",detached);var s;var links=E.get({filter:function(a){return!(s=scanned(a))||s=="error"||s=="update"}});if(E.conf.dynamic_links){listen_href_updates(links.filter(function(l){return $(l.link).is(E.conf.dynamic_links)}),E.conf)}E.stats.stop("scan");if(!cache_get(links_info,E.spark.top_url)&&!cache_get(sent_links,E.spark.top_url)&&(links.length||E.spark.is_feature_enabled("video_previews")||E.conf.scan_top_url||util.is_mocha())){links.push({url:E.spark.top_url,type:"page",current:true})}if(!links.length)return void submit_scan();var new_links=links.filter(function(l){return l.current||!scanned(l.link)});links.forEach(function(l){if(!l.current){scanned(l.link,1);if(!all_links.includes(l.link))all_links.push(l.link)}if(cache_get(sent_links,l)&&!cache_get(links_info,l))pending_update_db.push(l)});links=E.filter(links.filter(function(l){if(!cache_get(sent_links,l.url))return true;if(!l.size||E.size_util.compare(l.size,cache_get(sent_links,l))<=0){return false}E.stats.inc_d("rescan_bigger_n");return true}));if(new_links.length){E.stats.inc_d("found_links_n",new_links.length);E.stats.inc_d("found_n");E.emit("update",new_links)}var overrides=[];links.forEach(function(l){if(l.type!="video")return;E.stats.inc_d("type_video_n");if(!l.page_url||l.url==l.page_url)return;E.stats.inc_d("type_video_override_n");overrides.push(assign({},l,{type:"page",url:l.page_url}))});var unhandled_links=handle_get_links_info_page(links.concat(overrides));log.info("get_links_db count: "+unhandled_links.length);get_links_db(unhandled_links,E.conf,submit_scan)};E.init=function(spark,links_conf){E.spark=spark;log=E.spark.spark_log.fork(id);log.info("inited");spark.links=E;var preview_conf=util.get_platform_conf(E.spark.conf.video_previews);E.conf=assign({},def_opt,preview_conf,links_conf);if(!E.conf.allow_taboola)rejected_containers+=', div[id^="trc_wrapper"]';stats_init();E.msg=new _msg(id,{handlers:[{type:"top",name:"get_top_url_db",func:function(idx,cb){if(E.last_update_page_db)return cb(E.get_page_db());E.once("update_page_db",function(){cb(E.get_page_db())})},opt:{exec_on_self:true,async:true}}]});E.msg.get_top_url_db_cb(function(info){if(info)set_page_info(info)});if(util.is_mocha())init_links_info_pages(activate_scan);else setTimeout(function(){init_links_info_pages(activate_scan)},10)};if(util.is_mocha())E.t={uninit:uninit};return E});
define("/svc/cdn/pub/spark_layout.js",{__stub:1});
define("/svc/cdn/pub/l10n.js",["/util/util.js","/svc/cdn/pub/log.js"],function(zutil,_log){var id="l10n";var E={};var log=_log?_log.set_type(id):{warn:function(){},info:function(){}};var ms={SEC:1e3,MIN:60*1e3,HOUR:60*60*1e3,DAY:24*60*60*1e3,WEEK:7*24*60*60*1e3,MONTH:30*24*60*60*1e3,YEAR:365*24*60*60*1e3};var locales="af,ak,am,ar,az,be,bg,bn,bs,ca,cs,cy,da,de,dv,dz,el,en,es,et,eu,"+"fa,fi,fo,fr,ga,gl,gn,gu,he,hi,hr,ht,hu,hy,id,is,it,ja,ka,kk,km,kn,ko,ky,lb,"+"lo,lt,lv,mg,mk,mn,mr,ms,mt,my,ne,nl,no,pa,pl,ps,pt,pt_br,ro,ru,rw,sd,si,sk,"+"sl,so,sq,sr,ss,st,sv,sw,ta,te,tg,th,ti,tk,tl,tn,to,tr,uk,ur,uz,vi,za,zh_cn,"+"zh_tw".split(",");var get_browser_locale=function(lang){var navlang=(lang||navigator.language||"").replace("-","_").toLowerCase();var choices=[navlang,navlang.substr(0,navlang.indexOf("_"))];for(var i=0;i<choices.length;i++){if(locales.includes(choices[i]))return choices[i]}return"en"};E.get_t=function(context){return function(string,opt){return E.l10n.t(string,opt,context)}};E.spark_t=function(string,opt){return E.l10n.t(string,opt,"spark")};E.override=function(strings,context){return E.l10n.override(strings,context)};E.init=function(opt){if(E.l10n)return;E.spark=opt.spark;var lang,is_auto_lang;var detect_lang_fn=zutil.get(E.spark.conf,"general.detect_lang_fn");if(typeof detect_lang_fn=="function"){try{lang=detect_lang_fn()}catch(e){log.warn("invalid detect_lang_fn function: "+(e&&e.toString())||"JS Error")}}if(!lang){is_auto_lang=zutil.get(E.spark.conf,"general.auto_lang");lang=!is_auto_lang&&zutil.get(E.spark.conf,"general.language","en")}var dictionary={};var dictionary_fn=zutil.get(E.spark.conf,"general.dictionary_fn");if(typeof dictionary_fn=="function"){try{dictionary=dictionary_fn()}catch(e){log.warn("invalid dictionary_fn function: "+(e&&e.toString())||"JS Error")}}var langs=zutil.extend_deep({},require.zdot("languages"),dictionary);E.l10n=new L10n(langs,lang,{disallow_override:is_auto_lang});E.l10n.init()};function describe_interval(_ms){if(_ms<2*ms.MIN){return E.l10n.t("time_ago.sec",{num:Math.round(_ms/ms.SEC)},"general")}if(_ms<2*ms.HOUR){return E.l10n.t("time_ago.min",{num:Math.round(_ms/ms.MIN)},"general")}if(_ms<2*ms.DAY){return E.l10n.t("time_ago.hour",{num:Math.round(_ms/ms.HOUR)},"general")}if(_ms<2*ms.WEEK){return E.l10n.t("time_ago.day",{num:Math.round(_ms/ms.DAY)},"general")}if(_ms<2*ms.MONTH){return E.l10n.t("time_ago.week",{num:Math.round(_ms/ms.WEEK)},"general")}if(_ms<2*ms.YEAR){return E.l10n.t("time_ago.month",{num:Math.round(_ms/ms.MONTH)},"general")}return E.l10n.t("time_ago.year",{num:Math.round(_ms/ms.YEAR)},"general")}E.time_ago=function(d){if(d===undefined)d=Date.now();var _ms=Date.now()-d;if(_ms<1e3)return E.l10n.t("time_ago.now",{},"general");return describe_interval(_ms)};function Polyglot(def_dictionary){this._def_dictionary=def_dictionary||{};this._dictionary={}}Polyglot.prototype.extend=function(dictionary,prefix){if(typeof dictionary!="object")return;prefix=prefix||"";var translation,word_path;for(var word in dictionary){translation=dictionary[word];word_path=prefix?prefix+"."+word:word;if(typeof translation=="object")this.extend(translation,word_path);else this._dictionary[word_path]=translation}};Polyglot.prototype.t=function(string,opt){opt=opt||"";var res=this._dictionary[string]||this._def_dictionary[string]||"";for(var i in opt)res=res.split("%{"+i+"}").join(opt[i]||"");return res};function L10n(languages,lang,opt){opt=opt||{};this.languages=languages;this.current_language=lang;this.disallow_override=opt.disallow_override}L10n.prototype.init=function(){if(!this.current_language)this.current_language=get_browser_locale(this._detect_language());this.polyglot=new Polyglot(this.languages.en);this.polyglot.extend(this.languages[this.current_language])};L10n.prototype.t=function(string,opt,context){if(context)string=context+"."+string;return this.polyglot.t(string,opt)};L10n.prototype.override=function(strings,context){if(this.disallow_override)return;var s={};if(context)s[context]=strings;else s=strings;return this.polyglot.extend(s)};L10n.prototype._detect_language=function(){var nav=window.navigator;var language_keys=["language","browserLanguage","systemLanguage","userLanguage"];var language,i;if(Array.isArray(nav.languages)){for(i=0;i<nav.languages.length;i++){language=nav.languages[i];if(language&&language.length)return language}}for(i=0;i<language_keys.length;i++){language=nav[language_keys[i]];if(language&&language.length)return language}};L10n.prototype._on_warn=function(msg){log.warn(msg)};return E});
define("/svc/cdn/pub/ga.js",["/svc/cdn/pub/util.js"],function(util){var E=Google_analytics;function Google_analytics(conf,spark){this.conf=conf;this.spark=spark;if(!conf.use_existing)this.property_id=this.select_property_id(conf);if(this.property_id)this.attach_ga(this.property_id)}var metrics_index=function(){var _events={"Video View":"video_view_n","Page View":"page_view_n","Video Search: click":"video_search_open_page_n","Video Preview: user click":["preview_click_on_playing_n","preview_click_played_n"],"Video Preview: auto click":"preview_auto_click_on_playing_n","Image Preview: user click":"image_preview_click_on_playing_n","Image Preview: auto click":"image_preview_auto_click_on_playing_n","Floating player":"persistent_video_start_unique","Player Thumbnails: hover":"thumbnails_unique_shown_n","Player Autoplay":"autoplay_play_n","Watch Next: user click":"playlist_next_click_n","Watch Next: auto click":"playlist_next_autoclick_n","Watch Later: click":["watch_later_small_roaster_link_followed_n","watch_later_big_roaster_link_followed_n"],"Video History: click":"history_click_n"};var index={};for(var e in _events){var metrics=Array.isArray(_events[e])?_events[e]:[_events[e]];metrics.forEach(function(m){index[m]=(index[m]||[]).concat(e)})}return index}();Google_analytics.prototype.select_property_id=function(conf){var per_domain=conf.per_domain||[];var spark=this.spark;var rule=per_domain.find(function(r){return util.check_url(spark.top_url,{include:[r.domain]})});return(rule||conf).property_id};Google_analytics.prototype.attach_ga=function(property_id){if(window._gaq){window._gaq.push(["spark._setAccount",property_id]);return this.spark.stats.inc_d("ga_legacy_defined_n")}if(!window.ga){this.spark.stats.inc_d("ga_inject_n");(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date;a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","//www.google-analytics.com/analytics.js","ga")}else this.spark.stats.inc_d("ga_defined_n");window.ga("create",property_id,{name:"spark"})};Google_analytics.prototype.send_stats=function(stats){for(var module in stats){if(typeof stats[module]=="string"){this.report_metric(module,stats[module]);continue}for(var metric in stats[module])this.report_metric(module+"_"+metric,stats[module][metric])}};Google_analytics.prototype.report_metric=function(metric,value){var _this=this;var _events=metrics_index[metric]||[];var spark=this.spark;_events.forEach(function(e){_this.send_event("Spark",e+(spark.is_stats_only?" Stats mode":""),spark.cache_top_url,value)})};Google_analytics.prototype.send_event=function(category,action,label,val){var prefix=this.conf.use_existing?"":"spark.";if(window.ga){window.ga(prefix+"send",{hitType:"event",eventCategory:category,eventAction:action,eventValue:val,eventLabel:label,nonInteraction:true})}else if(window._gaq)window._gaq.push([prefix+"_trackEvent",category,action,label,val]);else this.spark.stats.inc("ga_not_defined_n")};return E});
define("/svc/cdn/pub/spark_stats.js",["/util/util.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/perr.js","/svc/cdn/pub/storage.js"],function(zutil,dom_util,perr,storage){var E=Stats;var assign=Object.assign;var spark,log;function Stats(id,parent,def,conf){if(arguments.length==2&&!(parent instanceof Stats)){def=parent;parent=undefined}this.parent=parent;this.id=id;this.detailed=conf&&conf.detailed_stats||zutil.get(spark.conf,"general.detailed_stats");this.def=def||{};this.allocs=[];this.perr_info={};this.perr_payload={};this.init_ts=parent?parent.init_ts:Date.now();this.mod_init();this.skipped=0}Stats.prototype.start=function(){};Stats.prototype.stop=function(){};Stats.prototype.mod_init=function(reset){this.init(reset)};Stats.prototype.init=function(reset){if(!reset&&this.o&&!zutil.is_mocha())return void log.info(this.id+" stats already initialized");if(this.parent){if(reset||!(this.o=zutil.get(this.parent.o,this.id))||typeof this.o!="object"){zutil.set(this.parent.o,this.id,zutil.clone_deep(this.def));this.o=zutil.get(this.parent.o,this.id)}}else this.o=zutil.clone_deep(this.def);this.inc_d("stats_"+(reset?"reset":"init")+"_n");this.allocs.forEach(function(c){c.mod_init(reset)});this.has_normal=this.has_freq=false;this.skipped=0;this.ms_since={}};Stats.prototype.inc_once_d=function(s,v){return this.detailed?this.inc_once(s,v):0};Stats.prototype.inc_once=function(s,v){this.inc(s,v,true)};Stats.prototype.inc_d=function(s,v,once,freq){return this.detailed?this.inc(s,v,once,freq):0};Stats.prototype.inc=function(s,v,once,freq){if(typeof v!="object"){if(this.get(s)&&once)return;return this.set(s,(this.get(s)||0)+(v||1),freq)}var p=typeof s=="string"?[s]:s;for(var e in v)this.inc(p.concat(e),v[e],once,freq)};Stats.prototype.assign=function(s,v,freq){var a=this.get(s);if(a){assign(a,v);this.changed(freq)}return a};Stats.prototype.push=function(s,v,freq){var o=this.get(s);if(!Array.isArray(o))o=this.set(s,[],freq);this.changed(freq);return o.push(v)};Stats.prototype.changed=function(freq){if(freq)this.has_freq=true;else this.has_normal=true;if(this.parent)this.parent.changed(freq)};Stats.prototype.set_d=function(s,v,freq){return this.detailed?this.set(s,v,freq):v};Stats.prototype.set=function(s,v,freq){this.changed(freq);zutil.set(this.o,s,v);return v};Stats.prototype.set_ms_since_d=function(s,from,max){if(!this.detailed)return;if(arguments.length==2&&typeof from=="number"){max=from;from=undefined}return this.set_ms_since(s,from,max)};Stats.prototype.set_ms_since=function(s,from,max){if(arguments.length==2&&typeof from=="number"){max=from;from=undefined}if(this.get(s)!==undefined)return;from=from||"init_ts";this.ms_since[s]=from;var since=this.init_ts,visited=[];while(from!="init_ts"){visited.push(from);since+=this.get(from);if(!(from=this.ms_since[from]))return;if(visited.includes(from)){log.notice("set_ms_since loop detected trying to step to "+from+" after path "+JSON.stringify(visited));return}}var diff=Date.now()-since;if(!max||diff<=max)return this.set(s,Date.now()-since)};Stats.prototype.if_not_set=function(s,v){return this.get(s)===undefined?this.set(s,v):v};Stats.prototype.get=function(s){return zutil.get(this.o,s)};Stats.prototype.set_avg_d=function(s,total,count){if(this.detailed)return this.set_avg(s,total,count)};Stats.prototype.set_avg=function(s,total,count){total=this.get(total)||total;count=this.get(count)||count;if(total&&count)this.set(s,total/count)};Stats.prototype.get_stats=function(){this.allocs.forEach(function(a){return a.get_stats()});return this.o};Stats.prototype.get_flat_stats=function(){var flat={};function flatten(o,prefix){for(var s in o){var p=prefix?prefix+"_"+s:s;if(typeof o[s]=="object"){flatten(o[s],p);continue}flat[p]=o[s]}}flatten(this.get_stats());return flat};Stats.prototype.alloc=function(path,init,conf){var s=new Stats(path,this,init,conf);this.allocs.push(s);return s};Stats.prototype.update_perr_info=function(player){if(!player.controls)return;var size=player.get_size().container_size||{};var controls=player.controls;var player_info=controls&&controls.name+"/"+controls.tech;assign(this.perr_info,{video_url:player.url,player_info:player_info,method:player.attached&&player.attached.method,video_live:controls&&controls.is_live_stream(),player:{stat:{width:size.width,height:size.height,width_full:dom_util.is_fullscreen()}}});spark.msg.update_perr_info(this.perr_info)};Stats.prototype.add_perr_payload=function(key,value){this.perr_payload[key]=value};Stats.prototype.prepare_billing=function(stats){var to_bill={playlist:["next_click_n","next_autoplay_n"],preview:["auto_navigate_on_hover_n","auto_click_on_playing_n","played_n","autoplay_unique_played_n"],image_preview:["auto_navigate_on_hover_n","auto_click_on_playing_n","image_shown_n"],thumbnails:["hover_n","unique_shown_n"]};var billing={};Object.keys(to_bill).forEach(function(key){var s=stats[key];if(!s)return;to_bill[key].forEach(function(k){if(!s[k])return;billing[key]=billing[key]||{};billing[key][k]=s[k];delete s[k]})});if(Object.keys(billing).length)stats.billing=billing};Stats.prototype.send_perr=function(){if(zutil.get(spark.conf,"general.stats.disable"))return;var stats=this.get_stats();this.prepare_billing(stats);if(spark.google_analytics)spark.google_analytics.send_stats(stats);if(zutil.get(spark.conf,"general.stats.billing_only"))stats={billing:stats.billing};var send_stats={};for(var key in stats){if(typeof stats[key]!="object"||Object.keys(stats[key]).length)send_stats[key]=stats[key]}var spark_random={},sr_conf;if(!storage.is_stub()&&(sr_conf=zutil.get(spark.orig_conf,"general.sync_spark_random"))&&sr_conf.enable){spark_random={spark_random:storage.db.get("spark_random"),synced:storage.db.get("spark_random_synced"),window_synced:window.spark_random_synced,unsynced_cnt:storage.db.get("spark_random_unsynced_cnt")}}var info=assign({},this.perr_info,this.perr_payload,{stats:send_stats,stats_only:spark.is_stats_only,spark_zone:spark.spark_zone.name},spark_random);this.perr_payload={};if(this.prev_info&&zutil.equal_deep(this.prev_info,info))return;this.prev_info=zutil.clone_deep(info);perr({id:this.id+"_stats",delay:false,info:info,use_beacon:!zutil.get(spark.conf,"general.stats.disable_beacon")});this.mod_init(true)};Stats.set_dependecies=function(_spark,_log){spark=_spark;log=_log};return E});
define("/svc/cdn/pub/spark_player.js",["cash","/util/util.js","/svc/cdn/pub/util.js","/util/events.js","/svc/cdn/pub/map.js","/svc/cdn/pub/api.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/msg.js","/svc/cdn/pub/perr.js","/util/url.js"],function($,zutil,util,events,map,api,dom_util,_msg,perr,zurl){var assign=Object.assign;var spark,log;var msg;var EVENTS={SPARK_SIZE_CHANGED:"SPARK_SIZE_CHANGED"};var E={};function init_msg(){if(msg)return;msg=new _msg("players",{child_frames:true,handlers:[{type:"top",name:"report_view",func:report_view},{type:"top",name:"report_video_progress",func:function(idx,progress){if(!msg.frames[idx])return;msg.frames[idx].video_progress=progress}},{type:"top",name:"get_title",opt:{exec_on_self:true},func:function(){return run_player_conf_func("extract_top_title_func")||document.title}},{type:"top",name:"get_description",opt:{exec_on_self:true},func:function(){return run_player_conf_func("extract_description_func")}},{type:"top",name:"get_og_image",func:get_og_image,opt:{exec_on_self:true}},{type:"top",name:"get_page_info",opt:{exec_on_self:true},func:get_page_info}]})}function set_view(player,data){var s,no_mapping;var url=data&&data.url||player.url;var info={cache_url:data&&data.url_key||player.url_key,page_url:spark.top_url,spark_zone:spark.spark_zone.name,have_top:util.is_top||spark.has_master};if(util.is_mobile)info.is_mobile=true;if(spark.params.spark_wn!==undefined)info.watch_next_url=true;if(player&&player.is_video_ignored())info.skip_video=true;if(s=util.url2videotype(url)||util.url2videotype(info.page_url))info.video_type=s;if(s=util.url2category(info.page_url))info.category=s;if(s=util.url2lang(info.page_url))info.lang=s;var is_autostart=player&&player._is_autostart&&player._is_autostart();var handle_player_info=function(_ld){_ld=_ld||{};var ld=_ld.video_info||_ld;if(ld.title&&info.title!=ld.title)info.title=ld.title;if(ld.description&&info.description!=ld.description)info.description=ld.description;if(ld.poster&&info.poster!=ld.poster)info.video_poster=ld.poster;spark.stats.assign(["views",url],info);spark.send_report();info.cache_url=info.cache_url||_ld.url_key||data.url_key;spark.emit("video_view",info)};var _is_mapping_allowed=function(cb){if(data&&data.no_mapping||(spark.play_seq||[]).indexOf(info.cache_url)>0){return cb(false)}player._is_mapping_allowed(cb)};_is_mapping_allowed(function(allowed){if(!allowed)no_mapping=info.no_mapping=true;info.view_type=no_mapping&&!util.is_app?"background":util.is_mobile||!is_autostart?"manual":"autoplay";spark.set_unique_view_info("video",info);spark.stats.update_perr_info(player);assign(info,spark.stats.perr_info);if(!spark.get_conf("general.perr.disable_video_view"))perr({id:"spark_video_view",url:url,info:info,delay:false});if(spark.google_analytics)spark.google_analytics.report_metric("video_view_n",1);if(!spark.links)return;var db=spark.links.get_page_db();data=data||player;url=data.url_key;if(db)assign(db,db.db);var item=!no_mapping&&db&&(db.video_url==url||!spark.get_conf("general.main_video_only")&&(db.videos||[]).find(function(v){return v.url==url}))?db:null;spark.stats.inc(["views",url,"view"],1);spark.stats.if_not_set(["views",url,"view_sec"],[]);info=assign({page_url:db?db.url:spark.top_url,video_url:data.url,dur:data.dur||data.get_duration&&data.get_duration()||0},zutil.pick(info,"video_type","category","lang"));if(s=player&&player.controls&&player.controls.is_live_stream())info.is_live=!!s;if(s=item&&item.poster)info.poster=s;if(s=item&&item.description)info.description=s.replace(/^\d\d:\d\d(\S*)? ?/,"")||s;if(s=item&&item.video_title)info.title=s;if(util.is_app)info.is_app=true;spark.stats.assign(["views",url],info);if(no_mapping)handle_player_info();else if(data!=player||data.video_info)handle_player_info(data);else if(player)player.get_player_info_cb(handle_player_info);else handle_player_info()})}function get_og_image(){var meta_img,url;if(spark.get_conf("general.player.disable_og_image"))return;var w=window,pw=window.top||window;while(1){try{var meta=$(w.document).find('meta[property="og:image"]').get(0);if((url=meta&&meta.content)&&/^https?:\/\//.test(url))meta_img=meta}catch(e){return}if(meta_img||w==pw)break;w=w.parent}if(meta_img&&is_poster_allowed(meta_img.content))return meta_img.content}function report_view(frame_idx,customer,data){if(!data||!spark.links||customer==spark.customer)return;var url=data.manifest_url||data.video_url;var url_key=spark.video2cache(url,!!data.manifest_url);set_view(undefined,{description:data.title,poster:data.poster,dur:data.duration,url:url,url_key:url_key});if(customer!="veedi")return void send_map_video_page(undefined,data);if(!util.is_enabled(api))return;api.has_veedi_game_info(data.video_title||data.title,function(has_info){if(has_info)send_map_video_page(undefined,data)})}function on_view_1sec(player,video_ctx){if(video_ctx.ad_src)return player.ad_mark_by_view(video_ctx);if(video_ctx.attached_spark.on_view_1sec_reported)return;if(!util.is_top){player._get_map_info(function(data){msg.report_view(spark.customer,data)})}set_view(player);video_ctx.attached_spark.on_view_1sec_reported=true}function run_player_conf_func(fn,val,info){if(!(fn=spark.get_conf("general.player."+fn)))return;try{fn=typeof fn=="string"?new Function("$","val","info",fn):fn;return fn($,val,info)}catch(e){log.err("invalid conf_func function: "+(e&&e.toString())||"JS Error")}}function get_ad_mark_event(){return spark.get_conf("general.ad_mark_event","ad_play")}function get_page_info(){return{title:run_player_conf_func("extract_top_title_func")||document.title,description:run_player_conf_func("extract_description_func"),og_img:get_og_image()}}function get_init_data(){var url,adaptive;if(this.controls.is_ad_source()||!(url=this.controls.get_url()))url=this.controls.get_playlist_url();url=util.absolute_uri(url);if(!url||!spark.is_allowed(this.check_skip_video(url)))return{};adaptive=util.get_adaptive_by_type(this.controls.get_video_type_name(url));return{url:url,adaptive:adaptive,url_key:spark.video2cache(url,adaptive)}}function get_view_cb_id(id){var m1=id.match(/^view_([0-9]+)sec$/);var m2=id.match(/^view_last_([0-9]+)sec$/);var m3=id.match(/^buffer_([0-9]+)sec$/);var m4=id.match(/^view_every_([0-9]+)sec$/);var sec=m1&&+m1[1]||m2&&+m2[1]||m3&&+m3[1]||m4&&+m4[1];var s=m1?"v"+sec:m3?"b"+sec:m2?"l"+sec:m4?"e"+sec:"";return s}function on_ended(){var ctx=this.attached||this.detached;if(ctx&&ctx.attached_spark)ctx.attached_spark.ended=true}function on_seeking(pos,seek_pos){var ctx=this.attached.attached_spark;if(!ctx)return;this.set_view_stats(ctx,ctx.last_pushed);ctx.last_viewed=ctx.view_every=ctx.last_pushed=seek_pos;this.update_view_sec("seek");this.ad_summary("on_seeking")}function send_map_video_page(player,data){if(spark&&spark.page_expires)return;if(!util.is_enabled(api))return log.warn("api is disabled; map request is not sent");if(send_map_video_page.was_sent)return;send_map_video_page.was_sent=true;var handle_map_info=function(d){if(d.no_mapping)return;var skip;if((skip=E.conf.skip_map_video_page)&&skip(d,player))return;api.send_map(d,E.conf.cdns||E.conf.cdn)};if(player)player._get_map_info(handle_map_info);else handle_map_info(data)}function is_poster_allowed(p){return spark.links?spark.links.is_poster_allowed(p):util.is_poster_allowed(p)}function is_title_allowed(t){return!spark.links||spark.links.is_text_allowed(t)}function is_player_allowed_by_css(player,filter){var container=player.get_ui().container;return dom_util.is_el_allowed_by_css(container,filter)}function is_player_allowed_by_func(player,func){if(!func)return true;try{var container=player.get_ui().container;return func({$:$,container:container})}catch(err){console.error("is_player_allowed_by_func %s",err);return true}}function on_wrapper_attached(cb){spark.loader.on("wrapper_attached",function(wrapper){if(is_player_allowed_by_css(wrapper.player,spark.get_conf("general.player.filter_by_css")||spark.get_conf("general.filter.player_by_css"))&&is_player_allowed_by_func(wrapper.player,spark.get_conf("general.filter.player_by_func"))){cb(wrapper)}})}function on_wrapper_detached(cb){spark.loader.on("wrapper_detached",cb)}function StateManager(initial_state){this._state=initial_state||{};this.__cbs=[]}StateManager.prototype.destroy=function(){this._state=this.__cbs=undefined;this.get=this.set=this.on=this.off=function(){};this.DESTROYED=true};StateManager.prototype.get=function(prop){if(!prop)return this._state;return this._state[prop]};StateManager.prototype.set=function(changes){var old_state=this._state;var new_state=assign({},this._state);var changed_props=[];for(var prop in changes){if(old_state[prop]!==changes[prop]){new_state[prop]=changes[prop];changed_props.push(prop)}}if(!changed_props.length)return;this._state=new_state;this._on_changed(old_state,new_state,changed_props)};StateManager.prototype.on=function(cb,props){if(!props||!props.length)return void this.__cbs.push([cb]);var props_obj={};for(var i=0;i<props.length;i++)props_obj[props[i]]=true;this.__cbs.push([cb,props_obj])};StateManager.prototype.off=function(cb){for(var i=this.__cbs.length;i>=0;i--){if(this.__cbs[i][0]==cb)this.__cbs.splice(i,1)}};StateManager.prototype._on_changed=function(old_state,new_state,props){var arr_cb;for(var i=0;i<this.__cbs.length;i++){arr_cb=this.__cbs[i];if(!arr_cb[1]){arr_cb[0](old_state,new_state,props);continue}for(var j=0;j<props.length;j++){if(arr_cb[1][props[j]]){arr_cb[0](old_state,new_state,props);break}}}};zutil.inherits(Players,events.EventEmitter);function Players(){this.arr=[];this.length=0;on_wrapper_attached(this.attach_player.bind(this));on_wrapper_detached(this.detach_player.bind(this));var _this=this;(spark.loader.wrapper||[]).forEach(function(w){if(w.attached)_this.attach_player(w)})}Players.prototype.forEach=function(func,a){this.arr.forEach(func,a)};Players.prototype.find=function(func){return this.arr.find(func)};Players.prototype.get_attached=function(){return this.find(function(p){return p.attached})};Players.prototype.attach_player=function(wrapper){var player=new Player(wrapper);player.spark=spark;this.arr.push(player);this.length=this.arr.length;var seek=function(){if(!player.saved_position&&!spark.params.spark_seek)return;player.seek(player.saved_position||+spark.params.spark_seek.slice(0,-1))};var off_seek=function(){spark.off("final_params",seek)};player.once("detach",off_seek);player.once("attach",function(){if(player.saved_position||spark.final_params||spark.params.spark_seek){return void seek()}spark.once("final_params",seek);player.controls.once("play",off_seek)});this.emit("add",player);if(E.conf.on_attach_player)E.conf.on_attach_player({$:$,E:E,player:player})};Players.prototype.detach_player=function(wrapper){var player=this.arr.find(function(p){return p.wrapper==wrapper});if(!player)return;player.uninit();this.arr.splice(this.arr.indexOf(player),1);this.length=this.arr.length;if(E.conf.on_detach_player)E.conf.on_detach_player({$:$,E:E,player:player});this.emit("remove",player)};Players.prototype.update_view_sec=function(){this.arr.forEach(function(p){p.update_view_sec("players")})};Players.prototype.ad_summary=function(){this.arr.forEach(function(p){p.ad_summary("players.ad_summary")})};var player_states={WN_PANEL_ANIMATION:"WN_PANEL_ANIMATION"};zutil.inherits(Player,events.EventEmitter);function Player(wrapper){if(!(this instanceof Player))return new Player(wrapper);this.EVENTS=assign({},EVENTS);this.wrapper=wrapper;this.wrapper.spark=this;this.attached=false;this.force_show_controls=false;this.controls=this.wrapper.player;this.html5=this.controls.html5;this.id=this.controls.name+"_"+wrapper.id;this.container=this.get_container();this.control_bar=this.get_control_bar();this.media=this.controls.get_ui().media;this.ads={events:[],first:true};this.states=player_states;this._state=new StateManager;var _this=this;this.is_slave_ad=(this.controls.is_ad_source()||this.html5&&this.html5.getAttribute("title")=="Advertisement")&&!!spark.players.find(function(pl){return pl.container.contains(_this.html5)});this.controls.on(get_ad_mark_event(),this.ad_mark_by_event.bind(this));this.name=this.controls.custom&&this.controls.custom.name||this.controls.name;this.view=this.pos=0;this.init_video=get_init_data.call(this);this.view_cbs=[];this.before_unload=this.uninit.bind(this);this.on_new_context=function(video_ctx){var handlers={"post-started":this.attach.bind(this,video_ctx,"attach"),"pre-suspend":this.detach.bind(this,video_ctx,"suspend"),"post-restore":this.attach.bind(this,video_ctx,"restore"),"post-shutdown":this.detach.bind(this,video_ctx,"detach")};video_ctx.multi_on(handlers);video_ctx.once("post-shutdown",function(){video_ctx.multi_off(handlers)})}.bind(this);this.wrapper.on("context_created",this.on_new_context);util.on("beforeunload",this.before_unload);if(this.name=="hola")this.hide_share_btn()}Player.prototype.get_container=function(){var container=this.controls.get_ui().container;var c,sel=spark.get_conf("general.player.container");if(sel&&(c=$(container).closest(sel)).length)return c.get(0);return container};Player.prototype.get_fs_container=function(){var container=this.controls.get_ui().fullscreen;var c,sel=spark.get_conf("general.player.fullscreen");if(sel&&(c=$(container).closest(sel)).length)return c.get(0);return container};Player.prototype.get_control_bar=function(){var bar,sel=spark.get_conf("general.player.control_bar");if(sel&&(bar=$(this.container).find(sel)).length)return bar.get(0);return this.controls.get_ui().control_bar};Player.prototype.get_size=function(){var c=this.get_fs_container()||this.container,res={};if(c)res.container_size={width:$(c).width(),height:$(c).height()};if(c=$(this.media)[0])res.media_size={width:c.videoWidth,height:c.videoHeight};return res};Player.prototype.force_show_controls_set=function(state){this.force_show_controls=state};Player.prototype.hide_share_btn=function(){var share_btn=$(this.container).find(".vjs-share-button");if(!share_btn.length)return;$(share_btn).css("display","none")};Player.prototype.once=function(id,cb){var s=get_view_cb_id(id);if(s&&!this.view_cbs.find(function(c){return c.id==s&&c.cb==cb}))this.view_cbs.push({id:s,cb:cb});return Player.super_.prototype.once.call(this,id,cb)};Player.prototype.off=function(id,cb){var s=get_view_cb_id(id),e;if(s&&(e=this.view_cbs.find(function(c){return c.id==s&&c.cb==cb})))this.view_cbs.splice(this.view_cbs.indexOf(e),1);return Player.super_.prototype.off.call(this,id,cb)};Player.prototype.on=function(id,cb){var s=get_view_cb_id(id);if(s&&!this.view_cbs.find(function(c){return c.id==s&&c.cb==cb}))this.view_cbs.push({id:s,cb:cb});return Player.super_.prototype.on.call(this,id,cb)};Player.prototype.fake_activity=function(){if(this.controls.flowplayer)$(this.container).addClass("is-mouseover");else if(this.controls.jwplayer)$(this.container).removeClass("jw-flag-user-inactive");else if(this.controls.vjs){$(this.container).removeClass("vjs-user-inactive").addClass("vjs-user-active")}};Player.prototype.get_pos=function(){return this.controls.get_pos()};Player.prototype.get_duration=function(){var ctx=this.attached&&this.attached.attached_spark;return!ctx?null:ctx.dur!=Infinity&&ctx.dur||(ctx.dur=this.controls.get_duration())};Player.prototype.monitor_playback=function(){if(this.force_show_controls)this.fake_activity();if(!this.attached||!this.attached.ad_src&&this.controls.is_any_ad_mode()){return}var ctx=this.attached.attached_spark;if(!this.attached.ad_src){var size=this.get_size().container_size;if(!this.container_size)this.container_size=size;else if(this.container_size.width!=size.width||this.container_size.height!=size.height){this.container_size=size;this.emit("size_change")}}this.update_view_sec();this.view_cbs.forEach(function(e,i){var sec=e.id;var type=sec[0];sec=sec.substring(1);if(type=="l"&&ctx.dur&&ctx.dur-ctx.pos<=sec){this.view_cbs[i]="del";this.emit("view_last_"+sec+"sec")}else if(type=="v"&&ctx.total_viewed>=sec){this.view_cbs[i]="del";this.emit("view_"+sec+"sec")}else if(type=="e"&&ctx.pos-ctx.view_every>=sec-1&&!(Math.round(ctx.pos)%sec)){ctx.view_every=ctx.pos;this.emit("view_every_"+sec+"sec")}else if(type=="b"&&this.sec_in_buffer()>=sec){this.view_cbs[i]="del";this.emit("buffer_"+sec+"sec")}},this);this.view_cbs=this.view_cbs.filter(function(s){return s!="del"});if(spark.report_frame_video_progress)msg.report_video_progress(ctx.pos)};Player.prototype.update_view_sec=function(type){if(!this.attached)return;var ctx=this.attached.attached_spark;ctx.dur=ctx.dur||this.get_duration();ctx.pos=this.controls.get_pos()||0;ctx.total_viewed+=ctx.pos-ctx.last_viewed;ctx.unique_view_sec.update(ctx.last_viewed,ctx.pos);ctx.last_viewed=ctx.pos;ctx.is_live=this.controls.is_live_stream();ctx.full_view=ctx.dur&&ctx.unique_view_sec.sum>=ctx.dur-5;var conf=spark.get_conf("general.stats",{});var diff=ctx.pos>(conf.view_from||0)&&conf.view_diff||20;if(ctx.pos-ctx.last_pushed<2||!type&&ctx.pos-ctx.last_pushed<diff)return;var last_pushed=ctx.last_pushed;ctx.last_pushed=ctx.last_viewed;if(this.attached.ad_src)return;this.set_view_stats(ctx,last_pushed);if(ctx.final_sec_reported||!ctx.full_view&&!["unload","detach"].includes(type)){return}spark.stats.assign(["views",this.url_key],{final_sec:ctx.unique_view_sec.sum,page_url:spark.top_url});ctx.final_sec_reported=true;spark.send_report()};Player.prototype.set_view_stats=function(ctx,last_pushed){var conf=spark.get_conf("general.stats",{});if(!conf.view_enabled||ctx.is_live)return;var end=ctx.dur&&ctx.pos+1>=ctx.dur;if(end||ctx.ended)spark.stats.set(["views",this.url_key,"ended"],1);if(ctx.full_view)spark.stats.set(["views",this.url_key,"full_view"],1);var min_total=Math.min(conf.view_sec_min_total||10,ctx.dur*.2||10);if(ctx.unique_view_sec.sum<min_total)return;spark.stats.if_not_set(["views",this.url_key,"view_sec"],[]);var views=spark.stats.get(["views",this.url_key,"view_sec"]);var view=views.find(function(v){return v.e==last_pushed});if(!view){spark.stats.push(["views",this.url_key,"view_sec"],{s:last_pushed,e:ctx.last_viewed,d:ctx.dur});return}view.e=ctx.last_viewed;spark.stats.changed()};Player.prototype.play=function(){var _this=this;function check_play_waiting(){pending_play_cancel();return _this.controls.is_any_ad_mode()&&!!(_this.pending_play=setTimeout(_this.play.bind(_this),500))}function pending_play_cancel(){if(!_this.pending_play)return;_this.controls.off("playing",pending_play_cancel);_this.pending_play=clearTimeout(_this.pending_play)}if(check_play_waiting())return;this.pending_play=setTimeout(check_play_waiting,1e3);this.controls.once("playing",pending_play_cancel);this.controls.play()};Player.prototype.seek=function(pos){var _this=this;function seek_to_same_pos(){var now=_this.controls.get_pos(),margin=5;return pos>now-margin&&pos<now+margin}function check_seek_waiting(){pending_seek_cancel();var is_wait=false;var seekable=_this.controls.check_seekable();if(_this.controls.is_any_ad_mode()||_this.controls.ad_active)is_wait=true;else if(!seekable.res){log.warn(seekable.msg);is_wait=true}if(is_wait)_this.pending_seek=setTimeout(_this.seek.bind(_this,pos),500);return is_wait}function pending_seek_cancel(){if(!_this.pending_seek)return;_this.controls.off("seeked",pending_seek_cancel);_this.pending_seek=clearTimeout(_this.pending_seek)}if(isNaN(pos)||pos<0||check_seek_waiting()||seek_to_same_pos())return;this.pending_seek=setTimeout(check_seek_waiting,1e3);this.controls.once("seeked",pending_seek_cancel);this.controls.seek(Math.round(pos*1e3))};Player.prototype.get_poster=function(){var $container=$(this.container);var poster_attr="spark_poster_url";var poster=$container.attr(poster_attr)||$container.find("["+poster_attr+"]").eq(0).attr(poster_attr);if(poster)return poster;poster=this.controls.get_poster()||$(this.controls.html5).attr("poster")||(this.container&&this.container.tagName)=="DL8-VIDEO"&&$container.attr("poster")||this.controls.jwadapter&&this.controls.jwadapter.get_config().image;if(poster&&!is_poster_allowed(poster))return null;return poster};Player.prototype.get_title=function(){var title=$(this.container).find(".vjs-dock-title");return title.length?title[0].innerText:this.controls.get_title()};var sent_poster_css_perr;Player.prototype.get_assoc_img=function(){var img_sel=spark.get_conf("general.player.img")||"img, div";var css_srcs={},$container=$(this.container),fp_class="is-playing";var flowplayer_playing=this.controls.flowplayer&&$container.hasClass(fp_class);if(flowplayer_playing)$container.removeClass(fp_class);var urls;try{urls=$container.find(img_sel).add($container.filter(img_sel)).get().filter(function(el){return!$(el).is(".hola_thumb_img,.cast_btn")}).map(function(el){if(el.tagName=="IMG")return{el:el,src:el.src};var src;if(src=dom_util.parse_bg_image(el.style.backgroundImage))return{el:el,src:src};if(src=dom_util.parse_bg_image($(el).css("background-image"))){css_srcs[src]={img_src:src,bg_image:el.style.backgroundImage}}return{el:el,src:src}}).filter(function(_el){return is_poster_allowed(_el.src)}).filter(function(_el){var $el=$(_el.el),w=$el.width(),h=$el.height();var cw=$container.width(),ch=$container.height();return!w||!h||!cw||!ch||w>cw/2&&h>ch/2}).map(function(_el){return _el.src})}catch(e){}if(flowplayer_playing)$container.addClass(fp_class);if(!urls||!urls.length)return;if(css_srcs[urls[0]]&&!sent_poster_css_perr){perr({id:"spark_video_poster_from_css",info:css_srcs[urls[0]]});sent_poster_css_perr=true}return urls[0]};Player.prototype._get_title=function(){var fn;if(fn=spark.get_conf("general.player.extract_title_func")){try{if(typeof fn=="string")fn=new Function("$",fn);return fn($)}catch(e){log.err("invalid extract_title_func function: "+(e&&e.toString())||"JS Error")}}var title;if(title=this.get_title()){perr({id:"spark_player_title",info:{title:title}});return title}};Player.prototype.get_player_info_cb=function(cb){var _this=this;msg.get_page_info_cb(function(info){info=info||{};var title=_this._get_title();if(!title){title=info.title;if(!title)try{title=window.top.document.title}catch(e){}}var description=info.description;var og_img=info.og_img;var data={};if(title&&is_title_allowed(title))data.title=title;if(description&&is_title_allowed(description))data.description=description;if(!og_img&&!util.is_top)og_img=get_og_image();data.img=og_img;var poster=_this.get_poster();var custom_poster=run_player_conf_func("get_poster",{poster:poster,og_img:og_img,container:_this.container});data.poster=custom_poster||poster||og_img||_this.get_assoc_img();cb(_this.video_info=data)})};Player.prototype.is_floating=function(){var persistent=spark.get_feature_if_inited("persistent");return persistent&&persistent.is_player_floating(this)};Player.prototype.is_playlist_active=function(){var _playlist=spark.get_feature_if_inited("playlist");return _playlist&&_playlist.is_playlist_active(this)};Player.prototype.is_autoplayed=function(){var _autoplay=spark.get_feature_if_inited("autoplay");return _autoplay&&_autoplay.is_autoplayed(this)};Player.prototype.is_wn_played_inline=function(){var _playlist=spark.get_feature_if_inited("playlist");return _playlist&&_playlist.was_played_inline(this)};Player.prototype.is_small=function(){var size=this.get_size().container_size||{};return size.width<=520||size.height<=292};Player.prototype.uninit=function(){if(this.attached)this.detach(this.attached,"uninit");this.ad_summary("uninit");this.wrapper.off("context_created",this.on_new_context);util.off("beforeunload",this.before_unload);this.emit("remove")};Player.prototype.get_main_video_player=function(){if(this.ad_video_ctx)return this.ad_video_ctx;spark.players.forEach(function(p){if(!p.attached&&!p.detached||(p.attached||p.detached||{}).ad_src)return;if(p.detached&&this.ad_video_ctx&&this.ad_video_ctx.attached)return;if(p.detached&&this.ad_video_ctx&&p.detach_ts<this.ad_video_ctx.detach_ts){return}this.ad_video_ctx=p},this);if(!this.ad_video_ctx&&spark.players.arr.length==1)this.ad_video_ctx=this;return this.ad_video_ctx};Player.prototype.ad_mark_by_event=function(info){if(this.ads.type=="view")return;var ctx=this.attached||this.detached;var as=ctx&&ctx.attached_spark;var type=info&&info.ad_type?info.ad_type+"roll":!as||as.last_viewed<10?"preroll":!as.is_live&&as.dur-as.last_viewed<10?"postroll":"midroll";this.ads.type="event";this.ads.events.push({type:type,state:"played",floating:this.is_floating()});log.info("@ ad_mark_by_event - ads "+JSON.stringify(this.ads))};Player.prototype.ad_mark_by_view=function(ad_ctx,state){var player=this.get_main_video_player();if(!player||player.ads.type=="event")return;var as=player&&(player.attached||player.detached).attached_spark;var type=!as||as.last_viewed<10?"preroll":!as.is_live&&as.dur-as.last_viewed<10?"postroll":"midroll";player.ads.type="view";state=state||"played";if(!ad_ctx||!ad_ctx.video_url||!player.ads.events.some(function(a){return a.type==type&&a.url==ad_ctx.video_url&&a.state==state})){player.ads.events.push({type:type,url:ad_ctx&&ad_ctx.video_url,state:state,floating:this.is_floating()})}log.info("@ ad_mark_by_view - ads "+JSON.stringify(player.ads))};Player.prototype.ad_summary=function(caller){if(!this.ads.events.length||!this.url_key)return;var _this=this,prefix=["views",this.url_key,"ads"];["preroll","midroll","postroll"].forEach(function(type){if(!this.ads.events.some(function(t){return t.type==type}))return;var count=function(state,filter){return _this.ads.events.reduce(function(n,v){return n+(v.type==type&&v.state==state&&(!filter||filter(v)))},0)};var t_prefix=prefix.concat(type);["played","watched"].forEach(function(state){spark.stats.inc(t_prefix.concat(state),count(state))});var played;if(!(played=count("played")))return;t_prefix.push("by_spark");var floating=count("played",function(v){return v.floating});if(floating)spark.stats.inc(t_prefix.concat("floating"),floating);if(_this.is_autoplayed())spark.stats.inc(t_prefix.concat("autoplay"),played);if(spark.params.spark_wn!==undefined)spark.stats.inc(t_prefix.concat("wn"),played);if(_this.is_wn_played_inline())spark.stats.inc(t_prefix.concat("wn_inline"),played);if(spark.spark_navigate){spark.stats.inc(t_prefix.concat(spark.spark_navigate==true?"spark_navigate":spark.spark_navigate),played)}},this);log.info("@ ad_summary by "+caller+" views "+JSON.stringify(spark.stats.o.views));if(this.ads.first)spark.stats.set(prefix.concat("first"),1);var unique=spark.set_unique_view_info("ads");var u_prefix=prefix.concat("unique");if(unique)unique.forEach(function(k){spark.stats.set(u_prefix.concat(k),1)});this.ads.first=false;this.ads.events=[];var stat;if((stat=spark.stats.get(["views",this.url_key]))&&stat.ads&&!stat.page_url){stat.page_url=spark.top_url}};Player.prototype.attach=function(video_ctx,reason){if(this.attached)return log.info("attach skipped (already attached");if(this.controls.is_ad_source())video_ctx.ad_src=true;else if(!spark.is_allowed(this.check_skip_video(video_ctx.video_url)))return log.info("attach skipped (not allowed)");if(this._state&&this._state.DESTROYED)this._state=new StateManager;var pos=this.controls.get_pos();if(!video_ctx.attached_spark)spark.stats.inc("new_"+(video_ctx.ad_src?"ad_":"")+"video_ctx_n");video_ctx.attached_spark=video_ctx.attached_spark||{on_view_1sec_cb:on_view_1sec.bind(null,this,video_ctx),on_seeking_cb:on_seeking.bind(this),on_ended_cb:on_ended.bind(this),last_viewed:pos||0,ads:[],total_viewed:0,last_pushed:pos||0,view_every:pos||0,unique_view_sec:new map.Map({sum:0,size:-1,exclude_end:true}),player:this};this.attached=video_ctx;this.adaptive=this.wrapper.adaptive;this.url=this.wrapper.video_url;this.url_key=spark.video2cache(this.url,this.adaptive);this.get_saved_position();var player=this.get_main_video_player();if(this.detached&&this.detached.ad_src&&player&&player.ads&&player.ads.type=="view"){this.ad_mark_by_view(this.detached,"watched")}if(!this.attached.ad_src)this.ad_summary("attach");spark.play_seq=spark.play_seq||[];if(!spark.play_seq.includes(this.url_key))spark.play_seq.push(this.url_key);spark.stats.update_perr_info(this);this.monitor=setInterval(this.monitor_playback.bind(this),1e3);if(dom_util.is_resize_observer_supported){var _this=this;this._resize_observer=new window.ResizeObserver(function(){_this.emit(EVENTS.SPARK_SIZE_CHANGED)});this._resize_observer.observe(this.container)}var as=video_ctx.attached_spark;if(!zutil.is_mocha()||!video_ctx.no_view_listener)this.once("view_1sec",as.on_view_1sec_cb);this.controls.on("seeking",as.on_seeking_cb);this.controls.on("ended",as.on_ended_cb);spark.players.attach_timeout=clearTimeout(spark.players.attach_timeout);log.info("attach to "+this.id);spark.verify_top_url_cb();this.emit("attach"+(this.attached.ad_src?"_ad":""),video_ctx,reason);spark.players.emit("attach"+(this.attached.ad_src?"_ad":""),this,video_ctx,reason)};Player.prototype.check_skip_video=function(video_url){var skip_reasons=this.wrapper.check_skip_video(video_url);var conf={filter_js:spark.get_cdn_conf("cdn.filter_out.js"),origins:spark.get_cdn_conf("agent.origins")};var filter=spark.get_conf("general.filter");if(util.video_filtered_out(video_url,conf.filter_js))skip_reasons.filtered_out="filtered by js conf";if(!util.check_url(video_url,filter))skip_reasons.filtered_out="filtered by spark filter";if(util.video_filtered_out(video_url,filter&&filter.js))skip_reasons.filtered_out="filtered by spark js conf";if(!util.origin_is_allowed_url(video_url,conf.origins)){skip_reasons.origin_not_allowed="origin not allowed";if(!skip_reasons.filtered_out&&!util.is_ad_url(video_url)){perr({id:"spark_missing_origin",info:{url:video_url,page_url:spark.top_url},delay:false,throttle:.01})}}return skip_reasons};Player.prototype.sec_in_buffer=function(){var buffered=this.controls.get_buffered();if(!buffered)return 0;var pos=this.get_pos(),bsec=0,hole=.5;for(var i=0;i<buffered.length&&!bsec;i++){var start=Math.floor(buffered.start(i)),end=buffered.end(i);if(zutil.range(start,pos,pos+hole))start-=hole;while(i<buffered.length-1&&end+hole>=buffered.start(i+1))end=buffered.end(++i);if(zutil.range(pos,start,end))bsec+=end-pos}return Math.round(bsec)};Player.prototype.save_position=function(){this.saved_position=Math.floor(this.get_pos());spark.storage.set_and_sync("spark_seek",{url_key:this.url_key,position:this.saved_position})};Player.prototype.get_saved_position=function(){var spark_seek=spark.storage.get("spark_seek")||{};if(spark_seek.url_key!=this.url_key)return;this.saved_position=spark_seek.position;spark.storage.unset_and_sync("spark_seek");return this.saved_position};Player.prototype.detach=function(video_ctx,reason){if(!this.attached)return;if(this._resize_observer)this._resize_observer=void this._resize_observer.disconnect();this.update_view_sec("detach");this.detached=this.attached;this.detach_ts=new Date;this.pos=this.dur=this.attached=undefined;this.off("view_1sec",video_ctx.attached_spark.on_view_1sec_cb);this.controls.off("seeking",video_ctx.attached_spark.on_seeking_cb);this.controls.off("ended",video_ctx.attached_spark.on_ended_cb);this._state.destroy();if(reason!="suspend"&&this.view)spark.stats.inc("vstats",{view_sec:this.view,init_n:1});if(this.monitor){this.monitor=clearInterval(this.monitor);this.view=this.pos=this.duration=undefined}if(!spark.players.get_attached()){spark.players.attach_timeout=setTimeout(spark.players.ad_summary.bind(spark.players),1e4)}log.info("detach from "+this.id);this.emit("detach"+(this.detached.ad_src?"_ad":""),video_ctx,reason);spark.players.emit("detach"+(this.detached.ad_src?"_ad":""),this,video_ctx,reason)};Player.prototype._is_autostart=function(){return this.controls&&this.controls.is_autostart&&this.controls.is_autostart()};Player.prototype.is_video_ignored=function(){if(!this._is_autostart())return;var filter=spark.get_conf("general.filter.small_video",{});var minw=filter.width||300,minh=filter.height||300;var allow=!util.is_mobile||filter.allow_mobile;var size=this.get_size().container_size||{};if(!filter.disable&&allow&&size.width<=minw&&size.height<=minh)return true};Player.prototype.is_extra_ui_allowed=function(opt){if(opt.feature=="spark_layout"&&this._state.get(player_states.WN_PANEL_ANIMATION)){
return false}if(!this.__is_extra_ui_allowed){var fn=spark.get_conf("general.player.is_extra_ui_allowed_fn");this.__is_extra_ui_allowed=fn?util.custom_fn(fn,"player, opt"):function(){return true}}return this.__is_extra_ui_allowed(this,opt)};Player.prototype.set_state=function(state){this._state.set(state)};Player.prototype.on_state=function(cb,props){this._state.on(cb,props)};Player.prototype.off_state=function(cb){this._state.off(cb)};function get_play_seq(){if(get_play_seq.last_top_url!=spark.top_url){get_play_seq.last_top_url=spark.top_url;get_play_seq.play_seq_n=0}return++get_play_seq.play_seq_n}function serialize(size){return size&&Math.round(Math.min(size.width||0,9999))+"x"+Math.round(Math.min(size.height||0,9999))}Player.prototype._get_map_info=function(cb){var controls=this.controls;var res=controls.get_resolution();var dims=controls.get_media_size();var data={size:res?serialize(res):null,nat_size:dims?serialize(dims):null};var duration;if(controls.is_live_stream())data.live=true;else if((duration=controls.get_duration())&&isFinite(duration))data.duration=duration;if(this.adaptive)data.manifest_url=this.url;else{var playlists=controls.get_playlists();data.video_url=this.url;if(playlists&&playlists.length>1)data.sources=playlists.map(function(p){return p.url})}if(util.is_mobile)data.is_mobile=1;var container=controls.get_ui().container;var sel=container&&dom_util.get_elm_selector_path(container);if(sel&&sel.length>250){sel=dom_util.get_elm_selector_path(container,true);if(sel&&sel.length>250)sel=sel.substr(sel.length-250)}data.user_meta={top_url:spark.top_url,frame_url:spark.frame_url,ua:navigator&&navigator.userAgent&&navigator.userAgent.substr(0,150),tag:spark.version,ext:util.has_ext,sel:sel};var _this=this;spark.verify_top_url_cb(function(top_url){if(!top_url)perr({id:"failed_verify_top_url"});_this._is_mapping_allowed(function(allowed){if(!allowed)data.no_mapping=true;_this.get_player_info_cb(function(ld){data.play_seq_n=get_play_seq();data.title=ld.title;data.description=ld.description;data.poster=ld.poster;cb(data)})})})};Player.prototype._is_mapping_allowed=function(cb){if(util.is_blob_url(this.url))return void cb(false);if(!this._is_mapping_allowed_by_env())return cb(false);if(!E.conf.filter_frame_for_mapping)return cb(true);if(this.frame_allowed_for_mapping!==undefined)return cb(this.frame_allowed_for_mapping);var _this=this;spark.msg.check_frame_css_cb(E.conf.filter_frame_for_mapping,function(allowed){_this.frame_allowed_for_mapping=allowed;cb(allowed)})};Player.prototype._is_mapping_allowed_base=function(){if(util.is_blob_url(this.url))return false;if(!this._is_mapping_allowed_by_env())return false;if(E.conf.filter_frame_for_mapping&&this.frame_allowed_for_mapping!==undefined){return this.frame_allowed_for_mapping}return true};Player.prototype._is_mapping_allowed_by_env=function(){if(!spark.is_spark_site&&spark.is_site_root&&!zurl.parse(spark.top_url).query||spark.top_url_modified||spark.content_modified){return false}var pages={exclude:E.conf.exclude_page_for_mapping||[]};if(!util.check_url(spark.top_url,pages))return false;if(!spark.is_video_url_allowed(this.url,E.conf))return false;if(this.is_video_ignored())return false;var container;if(container=this.controls&&this.controls.get_ui().container){if($(container).parents(".floating-migrated-players,"+".spark_injected_player").length){return false}var sel=E.conf.exclude_container_for_mapping;if(sel&&$(container).closest(sel).length)return false;sel=E.conf.include_container_for_mapping;if(sel&&!$(container).closest(sel).length)return false}if(util.is_samsung)return false;var fn;if((fn=E.conf.is_mapping_allowed)&&!fn($,this))return false;if(E.conf.browsers_for_mapping){var browser=util.browser&&util.browser.browser;if(!E.conf.browsers_for_mapping.includes(browser))return false}return true};E.init=function(_spark,_log){spark=_spark;log=_log;E.conf=util.get_platform_conf(spark.conf.video_previews);init_msg();E.players=new Players;E.players.on("attach",function(player){if(!spark.links)return;if(!player._is_mapping_allowed_base())return;var map_event="view_10sec";var off=function(){player.off(map_event,on_view);player.off("view_last_3sec",on_view)};var on_view=function(){off();spark.verify_top_url_cb(function(){player._is_mapping_allowed(function(allowed){if(allowed)send_map_video_page(player)})})};player.once(map_event,on_view);player.once("view_last_3sec",on_view);player.once("detach",off)});return E.players};return E});
define("/svc/cdn/pub/editor.js",{__stub:1});
define("/svc/cdn/pub/feature/persistent/index.js",["cash","/svc/cdn/pub/util.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/msg.js","/svc/cdn/pub/storage.js"],function($,util,dom_util,_msg,storage){var E={},assign=Object.assign,id="persistent_video",log;var is_touch=typeof document!="undefined"&&"ontouchstart"in document;var _window=typeof window!="undefined"&&window.top;var _document;try{_document=_window.document}catch(e){}var TOP_RIGHT_CORNER=0;var BOTTOM_RIGHT_CORNER=1;var BOTTOM_LEFT_CORNER=2;var TOP_LEFT_CORNER=3;var SINGLE_SWITCHING=0;var SINGLE_PERSISTENT=1;var MULTIPLE_PERSISTENT=2;var HOLDER_STYLES=["display","width","height","top","left","right","bottom","position","margin","marginTop","marginLeft","marginRight","marginBottom","minWidth"];E.default_conf={params:{y_percentage:.5,corner:is_touch?BOTTOM_RIGHT_CORNER:TOP_RIGHT_CORNER,margin_top:5,margin_right:10,margin_bottom:5,margin_left:10,height:"inherit",z_index:2147483547,paused:false,draggable:true,draggable_head:true,pause_on_close:true,sync_frame_size:false,infinite_scroll_aware:false,ad_persistent:true,over_navigation:false,multiple_policy:SINGLE_SWITCHING,clone_frame:false,preserve_aspect_ratio:false,hide_controlbar:false,threshold_selector:null,prevent_size_change:false,allow_off_screen:false,width:util.is_mobile?"200px":"250px"}};E.watermark_conf={delay:function(dur,pos){return dur-pos-Math.min(dur/2,30)}};function add_style_string(str,doc){doc=doc||_document;var node;try{node=doc.createElement("style");node.innerHTML=str;doc.head.appendChild(node)}catch(e){return false}return node}function add_to_floating_list(player){if(!E.floating_head)return E.floating_head=player;var cur=E.floating_head;while(cur.next_floating)cur=cur.next_floating;cur.next_floating=player;player.prev_floating=cur}function animate_player(player,keyframes,done,on_frame_update){if(player.is_animating){if(!player.animation_stack)player.animation_stack=[];player.animation_stack.push({keyframes:keyframes,done:done});return}function done_wrapper(e){done(e);player.fix_ima_size(true);player.is_animating=false;if(player.animation_stack&&player.animation_stack.length){var a=player.animation_stack.shift();animate_player(player,a.keyframes,a.done)}}player.is_animating=true;var dur=.3;if(player.has_googima()&&!player.has_googima_api()){log.debug("Google IMA is active, doing immediate transition");dur=0}if(E.conf.params.disable_animation)dur=0;var start_time=(new Date).getTime();var end_time=dur*1e3;requestAnimationFrame(function frame_update(){if(on_frame_update)on_frame_update();var frame_time=((new Date).getTime()-start_time)/end_time;var animation_end=false;if(frame_time>=1){frame_time=1;animation_end=true}for(var k in keyframes[0]){var val=relative_css_val(keyframes[0][k],keyframes[1][k],frame_time);if(val)set_property(player.container,k,val)}player.fix_ima_size();if(!animation_end)return void requestAnimationFrame(frame_update);done_wrapper()})}function border_radius_hack(style){if(util.is_ie&&style.overflow=="hidden"&&(style.borderTopLeftRadius||style.borderTopRightRadius||style.borderBottomLeftRadius||style.borderBottomRightRadius)){return{"border-radius":"0"}}}function calc_baseline(player){var prev=player.prev_floating;if(!prev)return 0;var c=parseInt(E.conf.params.corner);var m=c==BOTTOM_RIGHT_CORNER||c==BOTTOM_LEFT_CORNER?E.conf.params.margin_bottom:E.conf.params.margin_top;return util.is_mobile?prev.baseline+10*m:prev.baseline+prev.height+m}function calc_floating_size(player){var a=$("<div class=floating-video>&nbsp;</div>");a.css({visibility:"hidden",position:"fixed"});$(_document.body).append(a);player.width=a.width();a.remove();var ms=!E.conf.params.preserve_aspect_ratio&&player.get_media_size();var ratio=ms?ms.height/ms.width:$(player.container).height()/$(player.container).width();player.height=Math.round(player.width*ratio);if(E.conf.params.modify_size_fn){try{var modify_size_fn=E.conf.params.modify_size_fn;if(typeof modify_size_fn=="string")modify_size_fn=new Function("player",modify_size_fn);modify_size_fn(player)}catch(e){log.err("invalid modify_size_fn function")}}}function check_threshold(p){var threshold=$(E.conf.params.threshold_selector)[0];if(!threshold)return;var thr_offset=$(threshold).offset();var pl_offset=$(p.container).offset();var pl_height=$(p.container).height();if(pl_offset.top+pl_height>thr_offset.top){var parent_offset=dom_util.offset_parent(p.container);var top=thr_offset.top-parent_offset.top-pl_height;var left=pl_offset.left-parent_offset.left;set_property(p.container,"position","absolute");set_property(p.container,"top",top+"px");set_property(p.container,"left",left+"px");set_property(p.container,"bottom","auto");set_property(p.container,"right","auto");p.absolute_top=top;p.absolute_left=left;p.translate_x=p.translate_y=0;update_video_control(p);return}if(p.container.style.position!="absolute")return;var vp=dom_util.visual_viewport();if(p.is_playing()&&p.container.getBoundingClientRect().bottom<vp.top)p.pause();var m=get_margins(p.baseline,0,0,true);var bottom_edge=m.top?m.top+pl_height+window.pageYOffset:window.pageYOffset+window.innerHeight-m.bottom;if(thr_offset.top>bottom_edge){p.translate_x=p.translate_y=0;init_floating_position(p);update_video_control(p)}}function close_video_control(player){if(E.conf.params.draggable)disable_draggable(player);if(player.video_control)_document.body.removeChild(player.video_control);if(E.spark_modules.watermark&&player.watermark_overlay){_document.body.removeChild(player.watermark_overlay);E.spark_modules.watermark.remove(player.watermark_overlay)}}function disable_draggable(player){if(!player.video_control)return;log.debug("disable dragging");player.draggable_fns.mouseup();$(player.video_control).off("mousedown",player.draggable_fns.mousedown);$(_document.body).off("mousemove",player.draggable_fns.mousemove);$(_document.body).off("mouseup",player.draggable_fns.mouseup)}function disable_floating(player){if(E.conf.params.pause_on_close||player.migrated)player.pause();end_floating(player,function(){if(!player.migrated){if(!E.conf.params.pause_on_close)E.players.player_remove(player.player);player.was_visible=false;player.was_closed=true;return}if(player.origin_page_url==E.spark.get_top_url()){var original_player=E.players.players.find(function(p){return p!=player&&p.get_url()==player.get_url()});if(original_player){if(player.is_playing())original_player.play();E.players.player_remove(original_player.player)}}E.players.remove_migrated(player.container)})}function disable_touch_gestures(player){if(!player.touch_fns)return;log.debug("disable_touch_gestures");["touchstart","touchmove","touchend"].forEach(function(e){player.container.removeEventListener(e,player.touch_fns[e],false)});if(player.touch_fns.click_uninit)player.touch_fns.click_uninit=player.touch_fns.click_uninit();if(player.click_overlay)player.click_overlay.remove();player.click_overlay=null;player.touch_gestures_enabled=false}function enable_draggable(player){log.debug("enable dragging");player.translate_x=player.translate_x||0;player.translate_y=player.translate_y||0;if(!player.draggable_fns){player.draggable_fns={mousedown:function(e){if(player.video_control!=e.target)return;player.draggable={start_x:e.x,start_y:e.y};player.container.classList.add("floating-video-dragging");e.preventDefault()},mousemove:function(e){if(!player.draggable)return;player.translate_x+=-e.x+player.draggable.start_x;player.translate_y+=e.y-player.draggable.start_y;update_floating_position(player);update_video_control(player);player.update_watermark();player.draggable.start_x=e.x;player.draggable.start_y=e.y;e.preventDefault()},mouseup:function(){player.container.classList.remove("floating-video-dragging");player.draggable=false}}}$(player.video_control).on("mousedown",player.draggable_fns.mousedown);$(_document.body).on("mousemove",player.draggable_fns.mousemove);$(_document.body).on("mouseup",player.draggable_fns.mouseup)}function enable_touch_gestures(player,is_slave){if(!is_slave&&E.conf.params.force_video_control)init_video_control(player);if(!player.is_floating&&!player.is_self_floating||player.ending_floating||player.touch_gestures_enabled){return}log.debug("enable touch gestures");if(!player.touch_fns){var ignore;player.touch_fns={touchstart:function(e){var t=e.touches[0];var top=function(el){return $(el).offset().top};if(ignore=E.conf.check_target&&top(t.target)-top(player.container)<-5){return}if(is_slave)E.msg.touch_start(t.screenX);else player.touch_fns.do_touchstart(t.screenX)},touchmove:function(e){if(ignore)return;e.preventDefault();var t=e.touches[0];if(is_slave)E.msg.touch_move(t.screenX);else player.touch_fns.do_touchmove(t.screenX)},touchend:function(e){if(ignore)return;if(is_slave)E.msg.touch_end();else player.touch_fns.do_touchend()},click:function(e){if(is_slave)E.msg.click();else player.touch_fns.do_click()}};if(!is_slave){var doc_width=_window.innerWidth||_document.documentElement.clientWidth||_document.body.clientWidth;var start_x=null,translate;var pixel_ratio=util.is_android&&util.is_chrome&&Math.abs(doc_width-980)<5&&_window.devicePixelRatio||1;player.touch_fns.do_touchstart=function(x){start_x=x};player.touch_fns.do_touchmove=function(x){if(start_x==null)start_x=x;translate=(start_x-x)*pixel_ratio;update_floating_position(player,translate);$(player.container).css({opacity:Math.max(0,1-Math.abs(translate/(doc_width/2)))})};player.touch_fns.do_touchend=function(){start_x=null;if(doc_width/2<Math.abs(translate))return void disable_floating(player);update_floating_position(player);$(player.container).css({opacity:1})};player.touch_fns.do_click=function(){if(!E.conf.params.skip_scroll_click)scroll_to(player)}}}var events=["touchstart","touchmove","touchend"];if(player.is_narrow&&!player.touch_fns.click_uninit){player.touch_fns.click_uninit=util.wrap_onclick($(player.container),player.touch_fns.click);if(E.conf.add_click_overlay&&player.player&&!player.click_overlay){player.click_overlay=$("<div/>").css({position:"absolute",top:"0",left:"0",height:"100%",width:"100%","z-index":1e3,"pointer-events":"auto"}).appendTo(player.container)}}events.forEach(function(evt){dom_util.non_passive_listener(player.container,evt,player.touch_fns[evt])});player.touch_gestures_enabled=true}function end_floating(player,done,force){log.debug("player id "+player.get_id()+": floating -> normal");hide_video_control(player);if(is_touch)disable_touch_gestures(player);player.ending_floating=true;var np=remove_from_floating_list(player);if(player.container.style.position=="absolute")init_floating_position(player);var is_playing=player.is_playing();var on_end=function(){update_baselines(np);if(player.dom_transform){$(player.holder).before(player.container);if(is_playing){setTimeout(function(){if(_document.body.contains(player.container)&&!player.is_playing()){player.play()}},1)}}else fix_ancestors_styles(player,false);if(player.container.parentNode){player.container.parentNode.classList.remove("floating-video-parent")}if(player.container.nodeName=="IFRAME"){if(player.old_scrolling_attr){$(player.container).attr("scrolling",player.old_scrolling_attr)}else $(player.container).removeAttr("scrolling")}if(player.is_frame)player.sync_frame_size(false);player.container.classList.remove("floating-video");$(player.container).attr("style",player.container_styles);player.holder.classList.add("floating-video-hidden");player.is_self_floating=false;player.ending_floating=false;player.end_floating();player.prevent_size_change(false);if(done)done()};delete player.baseline;if(force||!_document.body.contains(player.container))return on_end();var keyframes=[keyframe_end(player),keyframe_start(player)];animate_player(player,keyframes,on_end,function keyframe_recalc(){assign(keyframes[1],keyframe_start(player))})}function ensure_styles(){if(!E.styles_el||!E.styles_el.parentNode)E.styles_el=generate_styles()}function fix_ancestors_styles(player,enable){var parent=player.container.parentNode;while(parent&&parent!=document.body){if(enable){var computed=window.getComputedStyle(parent);var s,new_style=transform_hack(computed);if(s=border_radius_hack(computed))new_style=assign(new_style||{},s);if(new_style){$(parent).data("spark-prev-style",$(parent).attr("style")||"");$(parent).css(new_style)}}else{var style=$(parent).data("spark-prev-style");if(style!==undefined)$(parent).attr("style",style)}parent=parent.parentNode}if(E.conf.params&&E.conf.params.fix_ancestors_styles){E.conf.params.fix_ancestors_styles({$:$,E:E,player:player,enable:enable})}}function fullscreen_change_handler(player,full_el){if(!player.is_self_floating)return;if(player.container==full_el){player.container.classList.remove("floating-video");player.container.removeAttribute("style");if(is_touch)disable_touch_gestures(player)}else{player.container.classList.add("floating-video");init_floating_position(player);if(is_touch)enable_touch_gestures(player)}if(player.is_pip())end_floating(player)}function generate_styles(){var color_first="#000000";var color_second="rgba(0,0,0,0.3)";var color_contrast="white";var sm_min="768px";var md_min="992px";var lg_min="1200px";var width=parseInt(E.conf.params.width)||200;var height=parseInt(E.conf.params.height);var z_index=E.conf.params.z_index;var css_classes={".floating-video":{width:width+"px !important",position:"fixed !important","z-index":z_index+" !important",border:"1px solid "+color_first,padding:"0 !important","box-shadow":"0 0 5px black","min-height":height?height+"px":undefined,"background-color":"black",transform:"none !important","box-sizing":"border-box"},".floating-video-holder":{display:"block"},".floating-video-hidden":{display:"none !important"},".floating-video-control":{position:"fixed","z-index":z_index+1,cursor:E.conf.params.draggable?"move":"auto","pointer-events":E.conf.params.draggable?"auto":"none","text-align":"left !important"},".floating-video-control .fv-close":{color:color_contrast,width:"20px","line-height":"20px",border:"none",background:"transparent",cursor:"pointer !important","pointer-events":"auto",padding:"0"},".floating-video-control .fv-close::after":{"font-size":"25px","font-family":"monospace",display:"block",transform:"translateY(-2px) rotate(45deg)",content:'"\\00ab"'},".floating-video-control.fv-migrated .fv-close::after":{transform:"none",content:'"\\00d7"'},".floating-video-control .fv-close:hover":{background:color_second},".floating-video-dragging":{"pointer-events":"none"},".floating-video *":{"min-height":"0px !important"},".floating-migrated-players":{width:"0",height:"0",overflow:"hidden"}};var styles=util.get_stylesheet(css_classes);styles+="@media (min-width: "+sm_min+") {"+util.get_stylesheet({".floating-video":{width:width*1.25+"px !important","min-height":height?height*1.25+"px":undefined}})+"}";styles+="@media (min-width: "+md_min+") {"+util.get_stylesheet({".floating-video":{width:width*1.5+"px !important","min-height":height?height*1.25+"px":undefined}})+"}";styles+="@media (min-width: "+lg_min+") {"+util.get_stylesheet({".floating-video":{width:width*1.5+"px !important","min-height":height?height*1.5+"px":undefined}})+"}";return add_style_string(styles)}function get_margins(baseline,translate_x,translate_y,ignore_threshold){var res={},params=E.conf.params;baseline=baseline||0;translate_x=translate_x||0;translate_y=translate_y||0;var thr_offset=ignore_threshold?0:threshold_offset();switch(parseInt(params.corner)){case BOTTOM_RIGHT_CORNER:res.right=params.margin_right+translate_x;res.bottom=baseline+Math.max(params.margin_bottom,thr_offset)-translate_y;break;case BOTTOM_LEFT_CORNER:res.bottom=baseline+Math.max(params.margin_bottom,thr_offset)-translate_y;res.left=params.margin_left-translate_x;break;case TOP_LEFT_CORNER:res.top=baseline+params.margin_top+translate_y;res.left=params.margin_left-translate_x;break;default:res.top=baseline+params.margin_top+translate_y;res.right=params.margin_right+translate_x}if(res.bottom&&util.is_ios&&util.is_safari&&!util.browser.chrome)res.bottom=Math.max(res.bottom,_window.innerHeight*.08||0);if(E.conf.params.modify_pos_fn){try{var modify_pos_fn=E.conf.params.modify_pos_fn;if(typeof modify_pos_fn=="string"){modify_pos_fn=new Function("res","params","spark",modify_pos_fn)}res=modify_pos_fn(res,params,E.spark)}catch(e){log.err("invalid modify_pos_fn function")}}return res}function hide_video_control(player){if(player.video_control)player.video_control.style.display="none";if(E.conf.params.draggable)disable_draggable(player)}function init_floating_position(player,keyframe){if(dom_util.get_fullscreen_element(_document))return;keyframe=keyframe||{};var position;if((position=$(player.container).css("position"))!=""&&position!="fixed"){$(player.container).css("position","fixed")}set_property(player.container,"min-width",player.width+"px");set_property(player.container,"width",keyframe.width||player.width+"px");set_property(player.container,"height",keyframe.height||player.height+"px");set_property(player.container,"min-height",player.height+"px");set_property(player.container,"top",keyframe.top||"auto");set_property(player.container,"right",keyframe.right||"auto");set_property(player.container,"bottom",keyframe.bottom||"auto");set_property(player.container,"left",keyframe.left||"auto");if(!keyframe.left&&!keyframe.right)update_floating_position(player)}function init_video_control(player){if(!player.video_control){player.video_control=_document.createElement("div");player.video_control.classList.add("floating-video-control");if(player.migrated)player.video_control.classList.add("fv-migrated");player.video_control.innerHTML="<button class=fv-close></button>";if(E.conf.params.control_in_player&&player.container)player.container.appendChild(player.video_control);else _document.body.appendChild(player.video_control);$(player.video_control).find("button[class=fv-close]").on("click",function(){disable_floating(player)})}player.video_control.style.display="block";update_video_control(player);if(E.conf.params.draggable)enable_draggable(player)}function is_floating_playing(p){return E.conf.params.ad_persistent?p.is_playing()||p.is_ad_playing():p.is_playing()&&!p.is_ad_playing()}function is_there_master(){if(util.is_friendly_iframe){var win=window.top;try{return!!(win.hola_cdn||win.document.querySelector('script[src*=".h-cdn.com/loader.js"]'))}catch(e){}}return false}function keyframe_start(player){var m=get_margins(player.baseline,player.translate_x,player.translate_y);var el=player.is_self_floating?player.holder:player.container;var cr=el.getBoundingClientRect();var w=$(el).width()+"px";var h=$(el).height()+"px";return{width:w,height:h,"min-width":w,"min-height":h,top:m.top?cr.top+"px":"auto",right:m.right?_window.innerWidth-cr.right+"px":"auto",bottom:m.bottom?_window.innerHeight-cr.bottom+"px":"auto",left:m.left?cr.left+"px":"auto"}}function keyframe_end(player){var m=get_margins(player.baseline,player.translate_x,player.translate_y);var w=player.width+"px";var h=player.height+"px";return{width:w,height:h,"min-width":w,"min-height":h,top:m.top?m.top+"px":"auto",right:m.right?m.right+"px":"auto",bottom:m.bottom?m.bottom+"px":"auto",left:m.left?m.left+"px":"auto"}}function make_visible(pos,player){if(util.is_mobile||typeof E.conf.params.min_margin!="number"||player.width===undefined||player.height===undefined){return pos}var min_margin=E.conf.params.min_margin;var res={};var area_w=document.body.clientWidth||window.innerWidth;var area_h=window.innerHeight;var max_x=area_w-player.width-min_margin;var max_y=area_h-player.height-min_margin;var delta_x=0,delta_y=0;if(pos.left!==undefined){res.left=Math.max(Math.min(max_x,pos.left),min_margin);delta_x=res.left-pos.left}if(pos.right!==undefined){res.right=Math.max(Math.min(max_x,pos.right),min_margin);delta_x=res.right-pos.right}if(pos.top!==undefined){res.top=Math.max(Math.min(max_y,pos.top),min_margin);delta_y=res.top-pos.top}if(pos.bottom!==undefined){res.bottom=Math.max(Math.min(max_y,pos.bottom),min_margin);delta_y=res.bottom-pos.bottom}if(player.translate_x!==undefined)player.translate_x+=delta_x;if(player.translate_y!==undefined)player.translate_y+=delta_y;return res}function process_player_touch(frame_id,msg,x){var p=E.players.get_player_by_frame(frame_id);if(!p||!p.touch_fns)return;switch(msg){case"touch_start":p.touch_fns.do_touchstart(x);break;case"touch_move":p.touch_fns.do_touchmove(x);break;case"touch_end":p.touch_fns.do_touchend();break;case"click":p.touch_fns.do_click();break}}function relative_css_val(v1,v2,ratio){var a=parseFloat(v1);var b=parseFloat(v2);if(v1.endsWith("px")&&v2.endsWith("px"))return(b-a)*ratio+a+"px"}function remove_from_floating_list(player){if(player.prev_floating)player.prev_floating.next_floating=player.next_floating;if(E.floating_head==player)E.floating_head=player.next_floating;if(player.next_floating)player.next_floating.prev_floating=player.prev_floating;var np=player.next_floating;delete player.prev_floating;delete player.next_floating;return np}function replace_in_floating_list(p1,p2){p2.prev_floating=p1.prev_floating;p2.next_floating=p1.next_floating;if(p1.prev_floating)p1.prev_floating.next_floating=p2;if(E.floating_head==p1)E.floating_head=p2;if(p1.next_floating)p1.next_floating.prev_floating=p2;delete p1.prev_floating;delete p1.next_floating}function scroll_to(player,force){var sc,ty,el=player.holder;if(player.is_scrolling||!el)return;for(sc=el.parentNode;sc&&sc.scrollTop==0;sc=sc.parentNode)sc.scrollTop++;if(!sc)return;end_floating(player,undefined,force);var offset=Math.floor((window.screen.height-$(el).height())/2);for(ty=0;el&&el!=sc;el=el.offsetParent)ty+=el.offsetTop;ty-=offset;var it=0,total=10,start=sc.scrollTop,change=ty-sc.scrollTop;if(E.conf.params.disable_scroll_to)return void disable_floating(player);player.is_scrolling=true;requestAnimationFrame(function frame_update(){sc.scrollTop=change*(Math.pow(it/total-1,3)+1)+start;it++;if(it==total||change<0&&sc.scrollTop<=ty||change>0&&sc.scrollTop>=ty){if(it==total)sc.scrollTop=ty;return void(player.is_scrolling=false)}requestAnimationFrame(frame_update)})}function set_property(node,property,value){node.style.setProperty(property,value,"important")}function setup_msg_handlers(){E.msg.on("master_found",function(){E.msg.master_found=true;E.players.init();E.inited=true});E.msg.on("frame_removed",E.players.frame_remove.bind(E.players));E.msg.add_top_handler("player_found",E.players.frame_add.bind(E.players));E.msg.add_top_handler("player_detached",E.players.frame_remove.bind(E.players));E.msg.add_top_handler("player_state",function(frame_id,state){var p;if(p=E.players.get_player_by_frame(frame_id))p.set_state(state)});E.msg.add_top_handler("on_play",function(frame_id){var p;if(p=E.players.get_player_by_frame(frame_id))E.players.check_multiple(p);E.players.on_scroll()});E.msg.add_top_handler("touch_start",function(frame_id,x){process_player_touch(frame_id,"touch_start",x)});E.msg.add_top_handler("touch_move",function(frame_id,x){process_player_touch(frame_id,"touch_move",x)});E.msg.add_top_handler("touch_end",function(frame_id){process_player_touch(frame_id,"touch_end")});E.msg.add_top_handler("click",function(frame_id){process_player_touch(frame_id,"click")});E.msg.add_frame_handler("play",function(){return E.players.first().play()});E.msg.add_frame_handler("pause",function(){return E.players.first().pause()});E.msg.add_frame_handler("seek",function(pos){return E.players.first().seek(pos)});E.msg.add_frame_handler("init_watermark",function(){if(E.spark_modules.watermark)E.players.first().init_watermark()});E.msg.add_frame_handler("fix_ima_size",function(is_final_size){var p=E.players.first();if(p)p.fix_ima_size(is_final_size)});E.msg.add_frame_handler("sync_frame_size",function(is_floating,fdims){var p=E.players.first();if(p)p.sync_frame_size(is_floating,fdims)});E.msg.add_frame_handler("start_floating",function(){$("body").addClass("floating-video-iframe");E.players.first().start_floating();enable_touch_gestures(E.players.first(),true)});E.msg.add_frame_handler("end_floating",function(){$("body").removeClass("floating-video-iframe");var p=E.players.first();if(!p)return;disable_touch_gestures(p);p.end_floating()});E.msg.add_frame_handler("allow_autoplay",function(){var p=E.players.first();if(p.autoplay_allowed)return;var src=p.player.controls.html5.src;p.player.controls.html5.src="";p.player.controls.html5.play();p.player.controls.html5.src=src;p.autoplay_allowed=true})}function start_floating(player){ensure_styles();log.debug("player id "+player.get_id()+": normal -> floating");player.was_closed=false;player.start_floating();if(player.container.nodeName=="IFRAME"){player.old_scrolling_attr=$(player.container).attr("scrolling");$(player.container).attr("scrolling","no")}E.players.check_multiple(player);add_to_floating_list(player);player.baseline=calc_baseline(player);calc_floating_size(player);var keyframes=[keyframe_start(player),keyframe_end(player)];stats_start();if($(player.container).hasClass("hola_playlist_video"))$(player.container).attr("style",player.container.pl_orig_style||"");player.container_styles=$(player.container).attr("style")||"";if(!player.holder){player.holder=_document.createElement("div");$(player.container).after(player.holder);player.holder.setAttribute("class","floating-video-holder")}for(var i=0;i<HOLDER_STYLES.length;i++){$(player.holder).css(HOLDER_STYLES[i],$(player.container).css(HOLDER_STYLES[i]))}if($(player.container).css("display")=="inline")$(player.holder).css("display","inline-block");player.holder.classList.remove("floating-video-hidden");init_floating_position(player,keyframes[0]);player.prevent_size_change(true);if(player.dom_transform){$(_document.body).append(player.container);setTimeout(function(){if(!player.is_playing())player.play()},1)}else fix_ancestors_styles(player,true);player.container.classList.add("floating-video");if(player.container.parentNode)player.container.parentNode.classList.add("floating-video-parent");player.is_self_floating=true;animate_player(player,keyframes,function(){set_property(player.container,"animation","none");update_floating_position(player);setTimeout(function(){if(is_touch)enable_touch_gestures(player);else init_video_control(player);if(E.spark_modules.watermark)player.init_watermark()},0);if(player.is_frame)player.sync_frame_size(true)},function(){keyframes[1]=keyframe_end(player)})}function stats_start(){if(!E.stats.get("start_n"))E.stats.inc("start_unique");E.stats.inc("start_n")}function threshold_offset(){var threshold=$(E.conf.params.threshold_selector)[0];if(!threshold)return 0;var rect=threshold.getBoundingClientRect();var viewport=dom_util.visual_viewport();return Math.max(viewport.bottom-rect.top,0)}function transform_hack(style){var re=/matrix\(1, 0, 0, 1, ([\d.-]+), ([\d.-]+)\)/,m;if(m=style.transform&&style.transform.match(re)){return{transform:"none",position:"relative",top:m[2]+"px",left:m[1]+"px"}}}function update_baselines(first_player){var p=first_player;while(p){var old_baseline=p.baseline;p.baseline=calc_baseline(p);var m1=get_margins(old_baseline,p.translate_x,p.translate_y);var m2=get_margins(p.baseline,p.translate_x,p.translate_y);var keyframes=[{top:m1.top?m1.top+"px":"auto",right:m1.right?m1.right+"px":"auto",bottom:m1.bottom?m1.bottom+"px":"auto",left:m1.left?m1.left+"px":"auto"},{top:m2.top?m2.top+"px":"auto",right:m2.right?m2.right+"px":"auto",bottom:m2.bottom?m2.bottom+"px":"auto",left:m2.left?m2.left+"px":"auto"}];animate_player(p,keyframes,update_video_control.bind(this,p));p=p.next_floating}}function update_floating_position(player,translate_x,translate_y){if(dom_util.get_fullscreen_element(_document))return;if(player.container.style.position=="absolute"){var top=player.absolute_top+(player.translate_y||+translate_y);var left=player.absolute_left-(player.translate_x||+translate_x);set_property(player.container,"top",top+"px");set_property(player.container,"left",left+"px");return}var m=get_margins(player.baseline,player.translate_x||+translate_x,player.translate_y||+translate_y);m=make_visible(m,player);for(var i in m)set_property(player.container,i,m[i]+"px");check_threshold(player)}function update_migrated_close_action(){E.players.players.forEach(function(player){if(!player.migrated||!player.video_control)return;var original_player=E.players.players.some(function(p){return p!=player&&p.get_url()==player.get_url()});$(player.video_control).toggleClass("fv-migrated",!original_player||player.origin_page_url!=E.spark.get_top_url())})}function update_video_control(player){if(!player.video_control)return;set_property(player.video_control,"top","auto");set_property(player.video_control,"right","auto");set_property(player.video_control,"bottom","auto");set_property(player.video_control,"left","auto");set_property(player.video_control,"width",player.width+"px");if(!E.conf.params.draggable_head)set_property(player.video_control,"height",player.height+"px");var vc_width=$(player.video_control).width();var vc_height=$(player.video_control).height();if(player.container.style.position=="absolute"){var offset=$(player.container).offset();set_property(player.video_control,"position","absolute");set_property(player.video_control,"top",offset.top+"px");set_property(player.video_control,"left",offset.left+"px");return}set_property(player.video_control,"position","fixed");var m=get_margins(player.baseline,player.translate_x,player.translate_y);m=make_visible(m,player);for(var i in m){if(i=="bottom")m[i]+=player.height-vc_height;if(i=="left")m[i]+=player.width-vc_width;set_property(player.video_control,i,m[i]+"px")}}function PersistentPlayer(player){if(!(this instanceof PersistentPlayer))return new PersistentPlayer;this.player=player;this.attached=false}PersistentPlayer.prototype.attach=function(){var java_proxy=util.is_app&&util.get(this.player,"controls.hola_java_proxy");if(java_proxy){java_proxy.module_cb(id,"set_conf",JSON.stringify({corner:parseInt(E.conf.params.corner),paused:E.conf.paused,ad_persistent:E.conf.params.ad_persistent}))}if(!this.get_base_container())return;var p=E.players.get_player_by_container(this.get_base_container());if(p&&E.conf.detach_alternate){p.detach();p=null}if(p){p.alternates=p.alternates||[];p.alternates.push(this);return}if(this.skip_player())return;this.container=this.find_container();if(!this.container)return log.err("persistent player - no container");p=E.players.get_player_by_container(this.container);if(p&&E.conf.detach_alternate){p.detach();p=null}if(p)return;this.dom_transform=E.conf.params.dom_transform&&document==_document;this.was_visible=false;this.was_closed=false;if(E.conf.params.infinite_scroll_aware)this.infinite_scroll={};if(this.player){if(this.player.wrapper.load_global("was_floating_before_detach"))this.was_visible=true;if(E.msg.master_found){E.msg.player_found(this.get_state());var _this=this;this.state_upd_int=setInterval(function(){E.msg.player_state(_this.get_state())},500)}this.on_play=function(){if(E.msg.master_found)E.msg.on_play();else{E.players.check_multiple(this);E.players.on_scroll()}}.bind(this);this.player.controls.on("play",this.on_play);this.player.controls.on("ad_play",this.on_play);if(this.is_playing())this.on_play()}this.is_narrow=this.is_narrow_screen();log.debug("attached to "+this.get_type()+" "+this.get_id());this.attached=true};PersistentPlayer.prototype.detach=function(delayed){var new_attached,player=this.player;if(player&&delayed)new_attached=E.players.get_player_by_wrapper_id(player.wrapper.id);else if(player&&E.conf.delay_detach)return void setTimeout(this.detach.bind(this,1),E.conf.delay_detach);if(this.is_self_floating&&!new_attached){if(player)player.wrapper.save_global("was_floating_before_detach",true);end_floating(this)}this.attached=false;if(this.state_upd_int)clearInterval(this.state_upd_int);close_video_control(this);if(this.on_play){player.controls.off("play",this.on_play);player.controls.off("ad_play",this.on_play);this.on_play=null}if(E.msg.master_found&&!new_attached)E.msg.player_detached();log.debug("detached from "+this.get_type()+" "+this.get_id())};PersistentPlayer.prototype.end_floating=function(){
var api=this.player.controls;if(this.is_narrow||E.conf.params.hide_controlbar)api.set_controlbar_visible(true);this.is_floating=false;api.emit("persistent.end_floating");api.enable_context_menu();if(Number.isFinite(this.saved_captions_track))api.set_captions_track(this.saved_captions_track);if(this.on_presentation_mode_changed){api.html5.removeEventListener("webkitpresentationmodechanged",this.on_presentation_mode_changed);delete this.on_presentation_mode_changed}if(this.watermark_overlay)this.watermark_overlay.style.display="none"};PersistentPlayer.prototype.find_container=function(){if(window.top!=window&&!E.msg.master_found&&window.frameElement){var win=window;while(window.top!=win.parent)win=win.parent;return win.frameElement}var container=this.get_base_container();if(E.conf.params.container_js){if(typeof E.conf.params.container_js=="string"){try{var fn=new Function("$","container",E.conf.params.container_js);container=fn($,container)}catch(e){log.err("invalid container_js function: "+(e&&e.toString())||"JS Error")}}}return container};PersistentPlayer.prototype.fix_ima_size=function(is_final_size){if(this.player.controls.is_any_ad_mode()&&this.player.controls.vjs&&this.player.controls.vjs.ima&&this.player.controls.vjs.ima.adsManager){var ima=this.player.controls.vjs.ima;var NORMAL=window.google&&window.google.ima?window.google.ima.ViewMode.NORMAL:"normal";ima.adsManager.resize($(this.container).width(),$(this.container).height(),NORMAL)}else if(is_final_size){if(typeof window.UIEvent==="function")window.dispatchEvent(new window.UIEvent("resize"));else{var evt=document.createEvent("UIEvents");evt.initUIEvent("resize",true,false,window,0);window.dispatchEvent(evt)}}};PersistentPlayer.prototype.get_base_container=function(){return this.player.controls.get_ui().container};PersistentPlayer.prototype.get_id=function(){return this.player.id};PersistentPlayer.prototype.get_media_size=function(){var v;if((v=$(this.container).find(".hola_autoplay_muted_overlay")[0])&&v.videoWidth&&v.videoHeight){return{width:v.videoWidth,height:v.videoHeight}}return this.player.controls.get_media_size()};PersistentPlayer.prototype.get_muted=function(){return this.player.controls.muted()};PersistentPlayer.prototype.get_pos=function(){return this.player.controls.get_pos()};PersistentPlayer.prototype.get_state=function(){var props=["is_playing","is_autostart","is_ad_playing","get_pos","get_video_url","get_url","get_media_size","is_pip","has_googima","has_googima_api","get_volume","get_muted","is_playing_autoplay_muted"];var state={},_this=this;props.forEach(function(prop){state[prop]=_this[prop]()});return state};PersistentPlayer.prototype.get_type=function(){return"player"};PersistentPlayer.prototype.get_url=function(){return this.player.url};PersistentPlayer.prototype.get_video_url=function(){return this.player.controls.get_url()};PersistentPlayer.prototype.get_volume=function(){return this.player.controls.volume()};PersistentPlayer.prototype.has_googima=function(){var el=this.container;return this.player.controls.is_any_ad_mode()&&(!!$(el).find('[id="'+el.id+'_googima"]').length||!!$(el).find('[id="'+el.id+'_ima-ad-container"]').length)};PersistentPlayer.prototype.has_googima_api=function(){return!!(this.player.controls.vjs&&this.player.controls.vjs.ima)};PersistentPlayer.prototype.init_watermark=function(){if(!E.spark_modules.watermark)return;if(!this.watermark_overlay){var d=_document||window.document;var watermark_overlay=d.createElement("div");this.watermark_overlay=watermark_overlay;$(watermark_overlay).css({position:"fixed","z-index":E.conf.params.z_index+2,padding:"0","pointer-events":"none"});d.body.appendChild(watermark_overlay);E.spark_modules.watermark.apply({v:this.player.controls,container:watermark_overlay})}this.watermark_overlay.style.display="block";this.update_watermark()};PersistentPlayer.prototype.is_ad_playing=function(){var p=this.player.controls;return p.is_ad_active()?!p.is_ad_paused():p.is_ad_source()&&p.is_playing()};PersistentPlayer.prototype.is_autostart=function(){return this.player.controls.is_autostart()};PersistentPlayer.prototype.is_narrow_screen=function(){if(!util.is_mobile||E.conf.params.disable_mobile_scroll)return;var swidth=window.screen.width,sheight=window.screen.height;if(swidth>sheight)swidth=sheight;return swidth<=util.get(E.conf.params,"screen_width",700)};PersistentPlayer.prototype.is_pip=function(){var api=this.player.controls;return api.html5&&api.html5.webkitPresentationMode=="picture-in-picture"};PersistentPlayer.prototype.is_playing=function(){return this.player.controls.is_playing()||this.player.container.hola_autoplay_playing_muted};PersistentPlayer.prototype.is_playing_autoplay_muted=function(){return!!this.player.container.hola_autoplay_playing_muted};PersistentPlayer.prototype.is_video_allowed=function(){if(this.infinite_scroll&&this.infinite_scroll.href!=window.location.href){return false}var alts=this.alternates||[];if(!alts.length||this.is_playing())return util.check_url(this.get_video_url(),E.conf.video_url);for(var i=0;i<alts.length;i++){if(alts[i].is_playing())return util.check_url(alts[i].get_video_url(),E.conf.video_url)}return util.check_url(this.get_video_url(),E.conf.video_url)};PersistentPlayer.prototype.is_visible_by_y=function(viewport){var el=this.is_self_floating?this.holder:this.container;var rect=el.getBoundingClientRect();var delta=E.conf.params.y_percentage*rect.height;return rect.top>=viewport.top-delta&&rect.bottom<=viewport.bottom+delta};PersistentPlayer.prototype.pause=function(){if(this.player.controls.is_ad_active())this.player.controls.ad_pause();else this.player.controls.pause()};PersistentPlayer.prototype.play=function(){this.ignore_play=true;this.player.controls.play()};var orig_width_fn,orig_height_fn;PersistentPlayer.prototype.prevent_size_change=function(enable){var _this=this,vjs=this.player.controls.vjs;if(!E.conf.params.prevent_size_change||!vjs)return;orig_width_fn=orig_width_fn||vjs.width;orig_height_fn=orig_height_fn||vjs.height;if(enable){var replace_style=function(name,value){$(_this.holder).css(name,value);var s=_this.container_styles;if(!s)return;var re=new RegExp("^(.*;\\s*)?"+name+":[^;]*");_this.container_styles=s.replace(re,"$1"+name+":"+value)};vjs.width=function(v){replace_style("width",v)};vjs.height=function(v){replace_style("height",v)};return}vjs.width=orig_width_fn;vjs.height=orig_height_fn};PersistentPlayer.prototype.restore_state=function(opt,migrated){if(opt.pos&&!util.get(E.spark,"features.position_memory.inited"))this.seek(opt.pos);if(opt.playing)this.play();if(!migrated)return;this.origin_page_url=opt.origin_page_url;this.set_migrated(true);start_floating(this)};PersistentPlayer.prototype.save_state=function(){return{name:"hola",origin_page_url:this.origin_page_url||E.spark.get_top_url(),width:$(this.container).width(),height:$(this.container).height(),pos:this.get_pos(),volume:this.get_volume(),muted:this.get_muted(),playing:this.is_playing(),video_url:this.get_url()}};PersistentPlayer.prototype.seek=function(pos){var api=this.player.controls;if(!pos||api.is_live_stream())return;this.player.seek(pos)};PersistentPlayer.prototype.set_migrated=function(val){this.migrated=val;if(this.video_control)$(this.video_control).toggleClass("fv-migrated",val)};PersistentPlayer.prototype.should_float=function(){if(this.is_scrolling)return false;var alts=this.alternates||[];var playing=E.conf.paused||is_floating_playing(this);if(!alts.length)return playing;if(!this.player.controls.is_ad_active())return playing;for(var i=0;i<alts.length;i++){if(is_floating_playing(alts[i]))return true}return false};PersistentPlayer.prototype.skip_player=function(){var _this=this;this.is_self_floating=false;this.is_floating=false;var skip_list=[{tag:"VIDEO",skip:function(tag){return tag.currentSrc.indexOf("//ve.h-cdn.com/previews/static/")>=0}},{tag:"IFRAME",skip:function(tag){return tag.src.indexOf("//www.youtube.com/embed")>=0&&!_this.is_youtube}}];var container=this.get_base_container();for(var i=0;i<skip_list.length;i++){if(container.tagName==skip_list[i].tag&&skip_list[i].skip(container))return true}if(!E.conf.params.ignore_player_func)return false;try{var fn=new Function("$","container",E.conf.params.ignore_player_func);return fn($,container)}catch(e){log.err("invalid ignore_player_func function: "+(e&&e.toString())||"JS Error")}};PersistentPlayer.prototype.start_floating=function(){var api=this.player.controls;this.is_floating=true;if(this.is_narrow||E.conf.params.hide_controlbar)api.set_controlbar_visible(false);api.emit("persistent.start_floating");api.disable_context_menu();this.saved_captions_track=api.get_captions_track();if(Number.isFinite(this.saved_captions_track))api.set_captions_track(-1);if(api.html5){this.on_presentation_mode_changed=function(){if(this.is_self_floating&&this.is_pip())end_floating(this)};api.html5.addEventListener("webkitpresentationmodechanged",this.on_presentation_mode_changed)}};PersistentPlayer.prototype.sync_frame_size=function(is_floating,fdims){if(!E.conf.params.sync_frame_size)return;if(!fdims){var s=_window.getComputedStyle(this.container);fdims={width:s.width,height:s.height}}var real_container=this.get_base_container();if(!is_floating){if(this.stored_rcstyle){real_container.style.width=this.stored_rcstyle.width;real_container.style.height=this.stored_rcstyle.height}delete this.stored_rcstyle;return}var cdims=window.getComputedStyle(real_container);if(cdims.width.length!=0&&fdims.width!=cdims.width||cdims.height.length!=0&&fdims.height!=cdims.height){this.stored_rcstyle={};this.stored_rcstyle.width=real_container.style.width;this.stored_rcstyle.height=real_container.style.height;real_container.style.width=fdims.width;real_container.style.height=fdims.height}};PersistentPlayer.prototype.update_watermark=function(){if(!E.spark_modules.watermark||!this.watermark_overlay)return;var m=E.msg.master_found?{top:0,left:0}:get_margins(this.baseline,this.translate_x,this.translate_y);for(var i in m)set_property(this.watermark_overlay,i,m[i]+"px");set_property(this.watermark_overlay,"width",$(this.container).width()+"px");set_property(this.watermark_overlay,"height",$(this.container).height()+"px")};util.inherits(PersistentFrame,PersistentPlayer);function PersistentFrame(frame_id,initial_state,frame_src){if(!(this instanceof PersistentFrame))return new PersistentFrame(frame_id,initial_state,frame_src);this.attached=false;this.frame_id=frame_id;this.is_frame=true;var frames=$("iframe").get();for(var i=0;!this.frame_container&&i<frames.length;i++){if(frames[i].contentWindow===frame_src.frame||frames[i].contentWindow===frame_src.frame.parent){this.frame_container=frames[i]}}this.state=initial_state}PersistentFrame.prototype.allow_autoplay=function(){E.msg.allow_autoplay(this.frame_id)};PersistentFrame.prototype.end_floating=function(){E.msg.end_floating(this.frame_id)};PersistentFrame.prototype.fix_ima_size=function(is_final_size){E.msg.fix_ima_size(this.frame_id,is_final_size)};PersistentFrame.prototype.get_base_container=function(){return this.frame_container};PersistentFrame.prototype.get_id=function(){return this.frame_container.id};PersistentFrame.prototype.get_media_size=function(){return this.state.get_media_size};PersistentFrame.prototype.get_muted=function(){return this.state.get_muted};PersistentFrame.prototype.get_pos=function(){return this.state.get_pos};PersistentFrame.prototype.get_type=function(){return"frame"};PersistentFrame.prototype.get_url=function(){return this.state.get_url};PersistentFrame.prototype.get_video_url=function(){return this.state.get_video_url};PersistentFrame.prototype.get_volume=function(){return this.state.get_volume};PersistentFrame.prototype.has_googima=function(){return this.state.has_googima};PersistentFrame.prototype.has_googima_api=function(){return this.state.has_googima_api};PersistentFrame.prototype.init_watermark=function(){if(E.spark_modules.watermark)E.msg.init_watermark(this.frame_id)};PersistentFrame.prototype.is_ad_playing=function(){return this.state.is_ad_playing};PersistentFrame.prototype.is_autostart=function(){return this.state.is_autostart};PersistentFrame.prototype.is_playing=function(){return this.state.is_playing};PersistentFrame.prototype.is_playing_autoplay_muted=function(){return this.state.is_playing_autoplay_muted};PersistentFrame.prototype.is_pip=function(){return this.state.is_pip};PersistentFrame.prototype.pause=function(){if(E.conf.params.allow_off_screen){this.state.is_ad_playing=false;this.state.is_playing=false}E.msg.pause(this.frame_id)};PersistentFrame.prototype.play=function(){E.msg.play(this.frame_id)};PersistentFrame.prototype.prevent_size_change=function(){};PersistentFrame.prototype.seek=function(pos){E.msg.seek(this.frame_id,pos)};PersistentFrame.prototype.set_state=function(state){this.state=state};PersistentFrame.prototype.start_floating=function(){E.msg.start_floating(this.frame_id)};PersistentFrame.prototype.sync_frame_size=function(is_floating,fdims){if(!fdims){var s=_window.getComputedStyle(this.container);fdims={width:s.width,height:s.height}}E.msg.sync_frame_size(this.frame_id,is_floating,fdims)};PersistentFrame.prototype.update_watermark=function(){};util.inherits(PersistentFake,PersistentPlayer);function PersistentFake(fake_player){if(!(this instanceof PersistentFake))return new PersistentFake(fake_player);this.attached=false;this.fake_player=fake_player}PersistentFake.prototype.get_base_container=function(){return this.fake_player};PersistentFake.prototype.end_floating=function(){};PersistentFake.prototype.fix_ima_size=function(){};PersistentFake.prototype.get_id=function(){return this.fake_player.id};PersistentFake.prototype.get_media_size=function(){};PersistentFake.prototype.get_muted=function(){return false};PersistentFake.prototype.get_pos=function(){return 0};PersistentFake.prototype.get_type=function(){return"fake player"};PersistentFake.prototype.get_url=function(){return""};PersistentFake.prototype.get_video_url=function(){return""};PersistentFake.prototype.get_volume=function(){return 1};PersistentFake.prototype.has_googima=function(){return false};PersistentFake.prototype.has_googima_api=function(){return false};PersistentFake.prototype.init_watermark=function(){};PersistentFake.prototype.is_ad_playing=function(){return false};PersistentFake.prototype.is_autostart=function(){return false};PersistentFake.prototype.is_playing=function(){return true};PersistentFake.prototype.is_pip=function(){return false};PersistentFake.prototype.pause=function(){};PersistentFake.prototype.play=function(){};PersistentFake.prototype.restore_state=function(){};PersistentFake.prototype.prevent_size_change=function(){};PersistentFake.prototype.save_state=function(){};PersistentFake.prototype.seek=function(){};PersistentFake.prototype.start_floating=function(){};PersistentFake.prototype.sync_frame_size=function(){};PersistentFake.prototype.update_watermark=function(){};function PlayersList(){this.players=[];this.migrated_players=[]}PlayersList.prototype.check_multiple=function(player){var policy=E.conf.params.multiple_policy;if(policy==MULTIPLE_PERSISTENT)return;this.players.forEach(function(p){if(p==player||policy!=SINGLE_PERSISTENT&&!p.is_self_floating||policy==SINGLE_PERSISTENT&&p.is_self_floating&&p.ignore_play){return void(p.ignore_play=false)}p.pause();if(policy==SINGLE_SWITCHING)end_floating(p)})};PlayersList.prototype.first=function(){return this.players[0]};PlayersList.prototype.frame_add=function(frame_id,initial_state,msg_src){var p=new PersistentFrame(frame_id,initial_state,msg_src);this._attach(p);if(p.attached&&!p.migrated&&!p.cloned&&E.conf.params.clone_frame&&E.conf.params.over_navigation&&!this.players.some(function(pl){return pl!=p&&pl.get_url()==p.get_url()})){this._clone_frame(p)}};PlayersList.prototype.frame_remove=function(frame_id){this._detach(function(p){return p.frame_id==frame_id})};PlayersList.prototype.get_player_by_container=function(container){var p;for(var i=0;!p&&i<this.players.length;i++){var pcontainer=this.players[i].container;if(pcontainer&&pcontainer.contains&&pcontainer.contains(container))p=this.players[i]}return p};PlayersList.prototype.get_player_by_frame=function(frame_id){for(var i=0;i<this.players.length;i++){if(this.players[i].frame_id==frame_id)return this.players[i]}};PlayersList.prototype.get_player_by_spark_player=function(player){return this.players.find(function(p){return p.player==player})};PlayersList.prototype.get_player_by_wrapper_id=function(wrapper_id){return this.players.find(function(p){return p.player&&p.player.wrapper.id==wrapper_id})};PlayersList.prototype.init=function(){E.spark_modules.players.forEach(this.player_remove.bind(this));E.spark_modules.players.forEach(this.player_add.bind(this));if(E.inited)return;E.spark_modules.players.on("add",this.player_add.bind(this));E.spark_modules.players.on("remove",this.player_remove.bind(this));this._listen_for_fake_players();if(E.msg.master_found)return;_window.addEventListener("scroll",this.on_scroll.bind(this),true);if(E.conf.params.update_interval)setInterval(this.on_scroll.bind(this),E.conf.params.update_interval);_window.addEventListener("resize",this._on_resize.bind(this));_window.addEventListener("orientationchange",this._on_orientationchange.bind(this));if(is_touch){var _this=this;["fullscreenchange","mozfullscreenchange","MSFullscreenChange","webkitfullscreenchange"].forEach(function(e){_document.addEventListener(e,_this._on_fullscreen_change.bind(_this))})}$(_document).ready(this._init_persistent_over_navigation.bind(this))};PlayersList.prototype.on_scroll=function(){var full_el=dom_util.get_fullscreen_element(_document);var _this=this;var vp=dom_util.visual_viewport();var is_valid_screen=!E.conf.params.fullscreen_disabled||!dom_util.is_fullscreen();this.players.forEach(function(p){if(p.is_animating||p.migrated)return;var is_visible=p.is_visible_by_y(vp);if(!p.was_visible&&p.container!=full_el&&is_visible){p.was_visible=true;if(p.infinite_scroll)p.infinite_scroll.href=window.location.href}if(p.is_self_floating){if(p.container!=full_el&&is_visible||!p.is_video_allowed()||p.is_pip()||!is_valid_screen){end_floating(p)}else check_threshold(p)}else{var allow_off_screen=E.conf.params.allow_off_screen&&!p.was_closed&&!p.is_playing_autoplay_muted();if(!is_visible&&p.should_float()&&p.is_video_allowed()&&(p.was_visible||allow_off_screen)&&!p.is_pip()&&_this._is_floating_allowed(p)&&is_valid_screen){start_floating(p)}}})};PlayersList.prototype.player_add=function(player){if(player.is_slave_ad)return;this._attach(new PersistentPlayer(player))};PlayersList.prototype.player_remove=function(player){this._detach(function(p){if(p.player==player)return true;if(p.alternates){for(var i=0;i<p.alternates.length;i++){if(p.alternates[i].player==player){p.alternates.splice(i,1);break}}}return false})};PlayersList.prototype.remove_migrated=function(el){el.remove();for(var i=0;i<this.migrated_players.length;i++){if(this.migrated_players[i].el==el)this.migrated_players.splice(i-1,1)}};PlayersList.prototype._attach=function(player){player.attach();if(player.attached)this.players.push(player);update_migrated_close_action();if(_document)this.on_scroll();var container=player.container;var migrated=$(container).parents(".floating-migrated-players").length;var saved_state=this.migrated_players.find(function(p){return migrated?container==p.el:player.get_url()==p.video_url});if(!saved_state)return;if(saved_state.cloned){player.cloned=true;player.origin_page_url=saved_state.origin_page_url;return}var already_playing=this.players.some(function(p){return p!=player&&!p.migrated&&(p.is_playing()||p.is_autostart())});if(already_playing)saved_state.playing=false;player.restore_state(saved_state,migrated)};PlayersList.prototype._clone_frame=function(p){var new_el=p.container.cloneNode();p.cloned_frame=new_el;$(new_el).css({width:$(p.container).width()+"px",height:$(p.container).height()+"px"});this._get_migrated_container().appendChild(new_el);this.migrated_players.push({el:new_el,cloned:true,origin_page_url:E.spark.get_top_url()})};PlayersList.prototype._detach=function(is_needed_player){var found,i=0;for(;!found&&i<this.players.length;i++)found=is_needed_player(this.players[i]);if(!found)return;this._remove_cloned(this.players[i-1]);this.players[i-1].detach();this.players.splice(i-1,1);update_migrated_close_action()};PlayersList.prototype._get_migrated_container=function(){var el;if(!(el=this.migrated_container)){el=this.migrated_container=document.createElement("div");el.setAttribute("class","floating-migrated-players");_document.body.appendChild(el)}return el};PlayersList.prototype._init_persistent_over_navigation=function(){if(!E.conf.params.over_navigation||!E.spark.is_url_allowed(E.conf.params.over_navigation_urls)){return}log.debug("init persistent over navigation");util.on("beforeunload",this._save_players.bind(this));this._restore_players();this._setup_spa_nav_hook()};PlayersList.prototype._is_floating_allowed=function(player){if(E.conf.params.multiple_policy!=SINGLE_PERSISTENT)return true;return!this.players.find(function(p){return p!=player&&p.is_self_floating})};PlayersList.prototype._listen_for_fake_players=function(){dom_util.dom_listen(document,function(){var fp=util.dom_query_all("iframe[spark_persistent], "+"iframe[hola_spark_persistent]");for(var i=0;i<fp.length;i++)this._attach(new PersistentFake(fp[i]))})};PlayersList.prototype._on_fullscreen_change=function(){var full_el=dom_util.get_fullscreen_element(_document);this.players.forEach(function(p){fullscreen_change_handler(p,full_el)})};PlayersList.prototype._on_orientationchange=function(){ensure_styles();this.players.forEach(function(p){if(p.is_self_floating){log.debug("player id "+p.get_id()+": orientation "+"change, recalc position");calc_floating_size(p);init_floating_position(p)}})};PlayersList.prototype._on_resize=function(){ensure_styles();var full_el=dom_util.get_fullscreen_element(_document);this.players.forEach(function(p){fullscreen_change_handler(p,full_el);if(p.is_self_floating&&!p.is_animating){log.debug("player id "+p.get_id()+": resize, recalc "+"position");calc_floating_size(p);init_floating_position(p);update_video_control(p)}})};PlayersList.prototype._on_spa_navigate=function(){this.players.forEach(function(p){if(p.cloned||p.migrated)return;var playing=p.is_playing();if(!p.is_self_floating&&!playing)return void this._remove_cloned(p);if(p.cloned_frame){var cloned=this.get_player_by_container(p.cloned_frame);replace_in_floating_list(p,cloned);cloned.baseline=p.baseline;cloned.translate_x=p.translate_x;cloned.translate_y=p.translate_y;var anim_state=E.conf.params.disable_animation;E.conf.params.disable_animation=true;cloned.restore_state({pos:p.get_pos(),playing:playing,origin_page_url:cloned.origin_page_url},true);E.conf.params.disable_animation=anim_state;delete p.cloned_frame;return}var width=$(p.container).width();var height=$(p.container).height();this.migrated_players.push({el:p.container,pos:p.get_pos(),volume:p.get_volume(),muted:p.get_muted(),playing:playing,origin_page_url:E.spark.get_top_url()});this._get_migrated_container().appendChild(p.container);$(p.container).css({width:width+"px",height:height+"px"});if(p.is_frame)return void this.frame_remove(p.frame_id);p.set_migrated(true);if(!p.is_self_floating)start_floating(p);if(playing)setTimeout(p.play.bind(p))}.bind(this))};PlayersList.prototype._remove_cloned=function(p){if(!p.cloned_frame)return;this.remove_migrated(p.cloned_frame);delete p.cloned_frame};PlayersList.prototype._restore_hola_player=function(migrated_player){var container=this._get_migrated_container();var init=function(){var opt={autoplay:false,preload:"auto",controls:true,share:false,width:migrated_player.width,height:migrated_player.height,video_url:migrated_player.video_url,volume:{level:migrated_player.volume||1,mute:migrated_player.muted,override_local_storage:true},videojs_options:{fluid:false},player:_document.createElement("div")};log.debug("restore player");container.appendChild(opt.player);window.hola_player(opt,function(vjs){migrated_player.el=vjs.el()})};if(window.hola_player)return void init();log.debug("load Spark Player script");var url=util.fix_url((E.conf.params.hola_player_url||"//player2.h-cdn.com/hola_player.js")+"?customer="+E.spark.customer);var $script=$('script[src="'+url+'"]');if($script.length)$script.one("load",init);else util.load_script(url,init)};PlayersList.prototype._restore_players=function(){var json;try{json=storage.session_db.get("hola_floating_players")}catch(e){}if(!json)return;var arr=this.migrated_players=JSON.parse(json);arr=arr.filter(function(i){return i.origin_page_url!=E.spark.get_top_url()});if(!arr.length||window.top!=window)return;arr.forEach(this._restore_hola_player.bind(this))};PlayersList.prototype._save_players=function(){var arr=[];this.players.forEach(function(p){if(!p.is_self_floating&&!p.is_playing())return;var state;if(state=p.save_state())arr.push(state)});try{storage.session_db.set("hola_floating_players",JSON.stringify(arr))}catch(e){}};PlayersList.prototype._setup_spa_nav_hook=function(){if(!window.history||!window.history.pushState)return;util.inject_hook(window.history,"pushState",E.spark_modules.perr.try_wrapper({prefix:"persistent_spa_navigate"},this._on_spa_navigate.bind(this)));if(!E.conf.params.clone_frame)return;var touchmove=false;_window.document.addEventListener("touchstart",function(e){touchmove=false});_window.document.addEventListener("touchmove",function(e){touchmove=true});_window.document.addEventListener("touchend",function(e){if(touchmove)return;this.players.forEach(function(p){if(p.cloned)p.allow_autoplay()})}.bind(this))};E.app_events=function(data){if(data.event=="start")stats_start()};E.get_holder=function(player){var persistent_player=E.players.get_player_by_spark_player(player);return persistent_player&&persistent_player.holder};E.is_player_floating=function(player){var persistent_player=E.players.get_player_by_spark_player(player);return persistent_player&&persistent_player.is_floating};E.scroll_to=function(player,force){if(!(player=E.players.get_player_by_spark_player(player)))return;scroll_to(player,force)};E.init=function(spark_modules,conf,spark){E.spark_modules=spark_modules;E.spark=spark;log=E.spark_modules.log;log.notice("presistent init conf %o",conf);E.conf=conf;E.stats=spark_modules.stats;E.players=new PlayersList;E.msg=new _msg("persistent_video",{child_frames:true});setup_msg_handlers();if(is_there_master()||util.is_unfriendly_iframe)return;ensure_styles();E.players.init();E.inited=true;log.debug("inited")};return E});
define("/svc/cdn/pub/feature/thumbnails/timeline.js",["cash","/svc/cdn/pub/util.js","/svc/cdn/pub/dom_util.js"],function($,util,dom_util){var E={};var log;E.Widget=Widget;function format_sec(sec){sec=Math.round(sec);var s=sec%60;var min=Math.floor(sec%3600/60);var hour=Math.floor(sec/3600);return(hour?pad(hour,2)+":":"")+pad(min,2)+":"+pad(s,2)+".000"}function pad(num,size){return("000"+num).slice(-size)}function Widget(thumbnails){this.thumbnails=thumbnails;this.strip_url=util.player_url+"/svc/cdn/pub/img/"+"thumbnails_cinema_roll.svg";this.strip_pad_percent=21;this.hor_margin_px=3;this.shown=false;this.thumbs_count=E.conf.params.vt_thumbs_count||10;this.listeners=[];this.player=thumbnails.player;this.spark_player=thumbnails.spark_player;this.container=this.get_container();if(!this.container||!this.container.length)return log.err("visual timeline - no container");this.control_bar=this.get_control_bar();if(!this.control_bar||!this.control_bar.length)return log.err("visual timeline - no control bar");var progress_bar=this.get_progress_bar();if(!progress_bar||!progress_bar.length)return log.err("visual timeline - no progress bar");this.check_reqs_timeout=0;this.player_ratio=this.container.height()/this.container.width();var s=thumbnails.thumbs[0].sprites;this.ratio=s.height/s.width;var _this=this;this.adjust(function(){_this.bind_events();_this.last_move=0;_this.on_timeline_click=function(event){if(!thumbnails.viewer||!E.conf.params.full_frame_thumbnails)return;thumbnails.viewer.display_drag_image(event)};log.info("visual timeline inited")})}Widget.prototype.get_container=function(){if(E.conf.params.abs_container)return $(E.conf.params.abs_container);var container=this.player.get_ui().container;if(E.conf.params.container)return $(container).closest(E.conf.params.container);return $(container)};Widget.prototype.get_control_bar=function(){if(E.conf.params.control_bar)return this.container.find(E.conf.params.control_bar);return $(this.player.get_ui().control_bar)};Widget.prototype.get_progress_bar=function(){if(E.conf.params.progress_bar)return this.control_bar.find(E.conf.params.progress_bar);return $(this.player.get_ui().progress_bar)};Widget.prototype.make_list=function(cb){var duration=this.player.get_duration();var dint=duration/this.max_count;var _t=dint/2;if(!_t||!isFinite(_t))return void cb();var _this=this;var handle_thumbs=function(_thumbs){_t=dint/2;_thumbs=_thumbs.map(function(thumb){return{"background-image":thumb.url?'url("'+thumb.url+'")':"none","background-position":"-"+thumb.img_x/thumb.width*100+"% "+"-"+thumb.img_y/thumb.height*100+"%",pos:util.floor_mul(_t,_this.thumbnails.interval),pos_next:util.floor_mul(_t+=dint,_this.thumbnails.interval)}});cb(_thumbs)};var wait=_this.max_count;var thumbs=[];for(var i=0;i<_this.max_count;i++){this.thumbnails.get(_t+i*dint,false,function(idx,thumb){thumbs[idx]=thumb;if(!--wait)handle_thumbs(thumbs)}.bind(null,i))}};Widget.prototype.timeline_hover=function(){this.timeline_hovered=true;this.blur_slides();if(this.show_watermark)this.show_watermark()};Widget.prototype.timeline_unhover=function(){this.timeline_hovered=false;this.blur_slides();if(this.hide_watermark)this.hide_watermark()};Widget.prototype.blur_slides=function(){if(E.conf.params.vt_no_blur||!this.shown)return;$(this.tlwrap).toggleClass("hola_vt_blur",!this.timeline_hovered);if(this.timeline_hovered)return;var $slides=$(this.tl).find(".hola_vt_slide");if(!$slides.length)return;var pos=this.player.get_pos();var duration=this.player.get_duration();var last_slide=$slides.length-1;$slides.each(function(el,i){var $el=$(el);var slide_pos=i==0?0:$el.data("hola-vt-pos");var slide_pos_next=i==last_slide?duration:$el.data("hola-vt-pos-next");var need_blur=pos<slide_pos||pos>=slide_pos_next;$el.toggleClass("hola_vt_slide_blur",need_blur)})};Widget.prototype.bind_events=function(){this._subscribe(this.container,"mousemove",this.show.bind(this));this._subscribe(this.container,"mouseleave",this.hide.bind(this));var _this=this;var repeat=function(){_this.blur_slides();setTimeout(check_reqs,500)};var check_reqs=function(){var c=_this.control_bar;if(c.css("display")=="none"||c.css("opacity")=="0"||c.css("visibility")=="hidden"){if(Date.now()-_this.last_move>3e3)_this.hide()}if(_this.get_width()!=_this.seekbar_width||_this.player.get_duration()!=_this.video_duration){return void _this.adjust(repeat)}repeat()};check_reqs()};Widget.prototype.get_width=function(){var seekbar_width=this.get_progress_bar().width();if(!seekbar_width)return 0;return E.conf.params.vt_seekbar_width?seekbar_width:this.control_bar.width()};Widget.prototype.adjust=function(cb){this.video_duration=this.player.get_duration();this.seekbar_width=this.get_width();this.max_count=Math.min(Math.floor(this.get_width()/75),this.thumbs_count);var _this=this;this.make_list(function(thumb_list){if(thumb_list){_this.thumb_list=thumb_list;_this.render();if(_this.shown)_this.show(true)}cb()})};Widget.prototype._subscribe=function(elem,name,fn){$(elem).on(name,fn);this.listeners.push({elem:elem,name:name,fn:fn})};Widget.prototype.detach=function(){this.hide();this.listeners.forEach(function(l){$(l.elem).off(l.name,l.fn)});this.listeners=[];if(this.tlwrap)dom_util.remove(this.tlwrap);if(this.check_reqs_timeout)this.check_reqs_timeout=window.clearTimeout(this.check_reqs_timeout)};Widget.prototype.format_time=function(sec){return format_sec(sec).slice(0,-4)};Widget.prototype.render=function(){var _this=this;if(this.tl){$(this.tl).find("div").get().forEach(function(elem){_this.listeners=_this.listeners.filter(function(ev){if(ev.elem==elem)$(elem).off(ev.name,ev.fn);return ev.elem!=elem})});dom_util.remove(this.tlwrap)}var tlwrap=document.createElement("div");$(tlwrap).addClass("hola_visual_timeline_holder");$(tlwrap).css({opacity:0,"background-image":"url("+this.strip_url+")","background-repeat":"no-repeat","background-size":"cover",position:"absolute",bottom:0,left:0,width:"100%"});var tl=document.createElement("div");$(tl).css({display:"flex",position:"absolute",height:100-this.strip_pad_percent*2+"%",top:this.strip_pad_percent+"%"});var thumb_size=this.get_thumb_size();this.thumb_list.forEach(function(item){var elem=document.createElement("div");var elem_dim=document.createElement("div");$(elem_dim).addClass("hola_vt_dim");var $elem=$(elem);$elem.addClass("hola_vt_slide");$elem.css({position:"relative",margin:"0 "+(_this.hor_margin_px+(thumb_size.m||0))+"px",display:"block",cursor:"pointer","justify-content":"flex-start","flex-basis":100/_this.max_count+"%","background-image":item["background-image"],"background-position":item["background-position"],"background-size":"500% 500%","background-repeat":"repeat","pointer-events":"auto"});$elem.attr("data-hola-vt-tooltip",_this.format_time(item.pos));$elem.data("hola-vt-pos",item.pos);$elem.data("hola-vt-pos-next",item.pos_next);_this._subscribe(elem,"click",function(event){event.mouse_time=item.pos;if(_this.on_timeline_click)_this.on_timeline_click(event);log.info("seek to "+item.pos);_this.spark_player.seek(item.pos)});$elem.append(elem_dim);$(tl).append(elem)});tlwrap.appendChild(tl);this.control_bar.after(tlwrap);this.tl=tl;this.tlwrap=tlwrap;this._subscribe(this.tlwrap,"mouseenter",this.timeline_hover.bind(this));this._subscribe(this.tlwrap,"mouseleave",this.timeline_unhover.bind(this))};Widget.prototype.get_thumb_size=function(){var width=this.get_width()/this.max_count-this.hor_margin_px*2;var height=width*(this.ratio>1?this.player_ratio:this.ratio);var _w=0,margin=0;if(this.ratio>1){_w=height/this.ratio;margin=width-_w;width=_w}return{w:width,h:height,m:margin/2}};Widget.prototype.show=function(force){var _this=this;if(Date.now()-this.last_move>200){setTimeout(function(){_this.control_bar.trigger("mousemove",{skip:true})},0)}this.last_move=Date.now();if(!this.thumbnails.is_allowed()||this.spark_player.is_floating()||this.spark_player.is_small()){this.hide();return}if(this.shown&&!force)return;this.shown=true;if(E.conf.params.on_timeline_show)E.conf.params.on_timeline_show({E:E,$:$,_this:this});var thumb_size=this.get_thumb_size();var dt=100*thumb_size.h/(100-this.strip_pad_percent*2);log.debug("show viewer w="+thumb_size.w+", h="+thumb_size.h+", dt="+dt);if(E.conf.params.translate_control_bar)this.control_bar.css({transform:"translateY(-"+dt+"px)"});else this.control_bar.css({bottom:dt+"px",position:"absolute"});$(this.player.get_ui().settings_menu).css({transform:"translateY(-"+dt+"px)"});var left=E.conf.params.vt_seekbar_width?this.get_progress_bar().offset().left-this.control_bar.offset().left:0;this.blur_slides();$(this.tlwrap).css({opacity:1,height:dt+"px"});$(this.tl).css({left:left+"px",width:this.get_width()+"px"});E.stats.inc_d("vtimeline_show_n")};Widget.prototype.hide=function(){if(!this.shown)return;this.shown=false;if(E.conf.params.on_timeline_hide)E.conf.params.on_timeline_hide({E:E,$:$,_this:this});log.info("hide viewer");$(this.tlwrap).css("opacity",0);if(E.conf.params.translate_control_bar)this.control_bar.css({transform:"translateY(0px)"});else{var bottom=E.conf.params.hide_bottom?E.conf.params.hide_bottom:"0px";this.control_bar.css({bottom:bottom,position:"absolute"})}$(this.player.get_ui().settings_menu).css({transform:"translateY(0)"});E.stats.inc_d("vtimeline_hide_n")};E.init=function(spark_modules,conf){log=spark_modules.log;E.stats=spark_modules.stats;E.conf=conf};return E});
define("/svc/cdn/pub/feature/thumbnails/index.js",["cash","/svc/cdn/pub/util.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/html5.js","/svc/cdn/pub/feature/thumbnails/timeline.js"],function($,util,dom_util,html5,timeline){var E={};var assign=Object.assign;var id="thumbnails",log;var def_thumb_height=100;E.watermark_conf={corner:"top-left",delay:function(duration,pos){return 1e6}};var tooltip_bg_img="data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22htt"+"p%3A//www.w3.org/2000/svg%22%20width%3D%2236px%22%20height%3D%2212px%22%3E%3"+"Cpath%20fill%3D%22rgba%2817,%2017,%2017,%200.9%29%22%20transform%3D%22rotate"+"%280%29%22%20d%3D%22M2.658,0.000%20C-13.615,0.000%2050.938,0.000%2034.662,0."+"000%20C28.662,0.000%2023.035,12.002%2018.660,12.002%20C14.285,12.002%208.594"+",0.000%202.658,0.000%20Z%22/%3E%3C/svg%3E";var css=["[data-hola-vt-tooltip] {","  transition: all .18s ease-out .18s;","  position: relative;","}","[data-hola-vt-tooltip]:before,[data-hola-vt-tooltip]:after {","  opacity: 0;","  pointer-events: none;","  bottom: 100%;","  left: 50%;","  position: absolute;","  z-index: 2147483647;","  transform: translate(-50%, 10px);","  transform-origin: top;","  transition: all .18s ease-out .18s;","}","[data-hola-vt-tooltip]:after {","  background: rgba(17,17,17,0.9);","  border-radius: 4px;","  color: #fff;","  content: attr(data-hola-vt-tooltip);","  font-size: 12px;","  padding: .5em 1em;","  white-space: nowrap;","  margin-bottom: 11px;","}","[data-hola-vt-tooltip]:before {",'  background: url("'+tooltip_bg_img+'") no-repeat;',"  background-size: 100% auto;","  height: 6px;","  width: 18px;",'  content: "";',"  margin-bottom: 5px;","}","[data-hola-vt-tooltip]:hover:before,[data-hola-vt-tooltip]:hover:after {","  opacity: 1;","  pointer-events: auto;","  transform: translate(-50%, 0);","}",".hola_thumb_holder {","  height: 0!important;","  width: 0!important;","  overflow: visible!important;","  position: absolute!important;","}",".hola_thumb_img {","  position: absolute!important;","  left: 0;","  color: #fff!important;","  background-position: 0 0;","  background-repeat: no-repeat;","  background-attachment: scroll;","  background-origin: content-box;","  background-clip: content-box;","  background-color: rgba(0,0,0,0.7);","  border: 2px solid rgba(0,0,0,0.7)!important;","  border-radius: 3px;","  box-sizing: content-box;","}",".hola_thumb_img .hola_thumb_text_wrapper {","  display: block;","  position: absolute;","  line-height: normal;","  width: 100%;","  bottom: 0;","  text-align: center;","}",".hola_thumb_img .hola_thumb_text {","  padding: 2px 4px 0 4px;","  font-size: 12px;","  background: rgba(0,0,0,0.7);","}",".hola_thumb_msg {","  position: relative;","  width: 100%;","  text-align: center;","  font-size: 15px;","}",".hola_thumb_fullscreen {","  position: absolute;","  top: 0;","  bottom: 0;","  left: 0;","  right: 0;","  overflow: hidden;","  background: #000;","}",".hola_thumb_drag_handler {","  position: absolute;","  background: none!important;","  top: 0;","  bottom: 0;","  left: 0;","  right: 0;","  z-index: 2;","}",".hola_video_wrapper {","  padding: 0!important;","  border-box: content-box!important;","}",".hola_video_wrapper video {","  margin: 0!important;","}",".hola_vt_dim {","  position: absolute;","  top: 0;","  left: 0;","  display: block;","  width: 100%;","  height: 100%;","  background: #fff;","  opacity: 0;","  pointer-events: none;","  transition: opacity .3s ease-in-out;","}",".hola_vt_blur .hola_vt_slide_blur .hola_vt_dim {","  opacity: .4;","}"].join("\n");function get_event_point(event,offset){var obj={left:event.changedTouches?event.changedTouches[0].pageX:event.pageX,top:event.changedTouches?event.changedTouches[0].pageY:event.pageY};if(offset){obj.left=obj.left-offset.left;obj.top=obj.top-offset.top}return obj}function format_sec(sec){sec=Math.round(sec);var s=sec%60;var min=Math.floor(sec%3600/60);var hour=Math.floor(sec/3600);return(hour?pad(hour,2)+":":"")+pad(min,2)+":"+pad(s,2)+".000"}function on_player_attach(player,video_ctx,reason){var controls=player.controls;if(E.conf.is_player_allowed&&!E.conf.is_player_allowed({E:E,player:player,video_ctx:video_ctx})){return log.info("player is excluded")}if(!controls)return log.err("player.controls is undefined");var video_url=util.absolute_uri(player.controls.get_url());if(!util.check_url(video_url,E.conf.video_url))return log.info("video_url ("+video_url+") is excluded");var thumbnails=video_ctx.attached_thumbnails;if(!thumbnails){thumbnails=new Thumbnails(player,video_ctx);video_ctx.attached_thumbnails=thumbnails;thumbnails.on_float=thumbnails.hide.bind(thumbnails);thumbnails.on_float_end=thumbnails.show.bind(thumbnails);thumbnails.check_attached=thumbnails.check_attached.bind(thumbnails)}else if(reason=="restore"){if(!player.is_floating())thumbnails.show()}controls.on("persistent.start_floating",thumbnails.on_float);controls.on("persistent.end_floating",thumbnails.on_float_end);controls.on("play",thumbnails.check_attached);controls.on("pause",thumbnails.check_attached);player.once("detach",function(_video_ctx,_reason){controls.off("persistent.start_floating",thumbnails.on_float);controls.off("persistent.end_floating",thumbnails.on_float_end);controls.off("play",thumbnails.check_attached);controls.off("pause",thumbnails.check_attached);if(_reason=="suspend")return thumbnails.hide();thumbnails.detach();_video_ctx.attached_thumbnails=undefined})}function pad(num,size){return("000"+num).slice(-size)}function Viewer(thumbnails){this.listeners=[];this.thumbnails=thumbnails;this.player=thumbnails.player;this.spark_player=thumbnails.spark_player;this.container=this.get_container();if(!this.container||!this.container.length)return log.err("thumbnails - no container");this.el_container=this.container.length?this.container[0]:this.container;if(document.body.contains(this.el_container))dom_util.add_style("data-spark-thumbnails",css);else{dom_util.add_style("data-spark-thumbnails",css,this.el_container.parentNode)}this.inited=true;this.div=document.createElement("div");this.div.style.display="none";this.div.className="hola_thumb_holder hola_top_element";this.img=document.createElement("div");this.div.appendChild(this.img);this.img.className="hola_thumb_img";this.pending_msg=document.createElement("div");this.pending_msg.className="hola_thumb_msg";this.pending_msg.style.display="none";this.pending_msg.textContent="Refresh for thumbnails";this.img.appendChild(this.pending_msg);var text_wrapper=$("<div class=hola_thumb_text_wrapper></div>").appendTo($(this.img));this.text_el=$("<span class=hola_thumb_text></span>").appendTo(text_wrapper);var colors=E.conf.params.colors;if(colors){assign(this.img.style,{"border-color":colors.bg,color:colors.text})}this.video_offset=util.player2offset(this.player);this.insert_after_video(this.div);this.add_styles();var on_move=this.on_move.bind(this);if(this.native_controls&&util.is_android&&util.is_chrome&&util.browser.version>66){var video=this.player.html5,_this=this;this.subscribe(video,null,"seeking",function(evt){var area;if(!(area=_this.get_hover_area()))return;var offset=_this.container.offset();evt.pageX=area.left+area.width*video.currentTime/video.duration+offset.left;evt.pageY=area.top-area.height/2+offset.top;on_move(evt)})}this.subscribe(this.container,null,["touchmove",util.is_ios?"touchstart":"mousemove"],on_move,true);this.subscribe(this.container,null,["mouseout","touchcancel","touchend"],this.move_cancel.bind(this),true)}Viewer.prototype.insert_after_video=function(elem){if(E.conf.params.insert_after_video_func){var fn=new Function("$","elem","video",E.conf.params.insert_after_video_func);return fn($,elem,this.player.html5)}var insert_after_sel=E.conf.params.insert_after_video_sel||".fp-waiting";var insert_after=this.container.find(insert_after_sel).first();if(!insert_after.length)insert_after=this.player.get_ui().media;return $(elem).css("z-index",$(insert_after).css("z-index")).insertAfter(insert_after)};Viewer.prototype.init_drag=function(event){if(this.native_controls||E.conf.params.disable_drag_area)return;var progress_bar=this.get_progress_bar();if(!progress_bar||!progress_bar.length){return log.debug("progress bar is required for full frame "+"thumbnails")}if(this.drag_inited){if(progress_bar.find(this.drag_handler).length)return;this.uninit_drag()}if(E.conf.params.full_frame_thumbnails)this.drag_enabled=true;this.drag_inited=true;this.drag_div=document.createElement("div");this.drag_div.style.display="none";this.drag_div.className="hola_thumb_fullscreen hola_top_element";this.drag_img=document.createElement("div");this.drag_pending_msg=document.createElement("div");this.drag_pending_msg.className="hola_thumb_msg";this.drag_pending_msg.style.display="none";this.drag_pending_msg.textContent="Refresh for thumbnails";this.drag_img.appendChild(this.drag_pending_msg);this.drag_div.appendChild(this.drag_img);this.drag_handler=document.createElement("div");this.drag_handler.className="hola_thumb_drag_handler";progress_bar.append(this.drag_handler);this.update_drag_handler();this.insert_after_video(this.drag_div);this.subscribe(window,null,["contextmenu"],this.disable_contextmenu.bind(this),true);this.subscribe(this.drag_handler,null,["mousedown","touchstart","pointerdown"],this.drag_start.bind(this),true);this.subscribe(this.div,null,["mousedown","touchstart","pointerdown"],this.drag_start.bind(this),true);this.subscribe(window,null,["mouseup","touchend","touchcancel","pointerup"],this.drag_end.bind(this),true);this.subscribe(document.body,null,["mousemove","touchmove"],this.on_drag.bind(this),true);if(util.is_mobile&&dom_util.pointer_within(this.drag_handler,event))this.drag_start(event)};Viewer.prototype.uninit_drag=function(){if(!this.drag_inited)return;this.drag_inited=false;this.unsubscribe(window);this.unsubscribe(this.drag_handler);this.unsubscribe(this.div);this.unsubscribe(document.body);dom_util.remove(this.drag_handler);dom_util.remove(this.drag_img);dom_util.remove(this.drag_div)};Viewer.prototype.disable_contextmenu=function(e){if(!this.dragging)return;e.stopPropagation();e.preventDefault()};Viewer.prototype.drag_start=function(event){var handler;if(!E.conf.params.pass_event||!(handler=E.conf.params.pass_event(event,this.get_progress_bar()))){event.stopPropagation()}else if(handler.length&&dom_util.pointer_within(handler,event))handler[0].dispatchEvent(util.clone_event(event));if(this.on_seeked)this.player.off("seeked",this.on_seeked);this.on_seeked=null;if(this.player.is_any_ad_mode()||this.dragging)return;if(this.off_scrubbing)this.off_scrubbing();this.player.scrubbing(this.dragging=true);if(!E.conf.params.disable_pause_on_drag){this.was_playing_before_drag=this.player.is_playing()||this.player.seeking;var vjs=this.player.vjs;if(this.was_playing_before_drag&&E.conf.params.hide_big_play_button&&vjs&&vjs.bigPlayButton){vjs.on("pause",function on_pause(){vjs.bigPlayButton.hide();vjs.off("pause",on_pause)})}this.player.pause()}setTimeout(this.on_drag.bind(this,event))};Viewer.prototype.on_drag=function(event){if(!this.dragging||this.player.is_any_ad_mode())return;this.on_move(event);this.update_play_progress(this.get_mouse_progress(event));if(this.drag_enabled)this.update_drag_image(event)};Viewer.prototype.drag_end=function(event){if(!this.dragging)return;this.display_drag_image(event);var player=this.player;if(this.was_playing_before_drag){var _this=this;player.once("seeked",this.on_seeked=function(){_this.on_seeked=null;player.play();if(player.is_playing()&&!player.is_paused())return void player.scrubbing(false);_this.off_scrubbing=function(){player.scrubbing(false);player.off("play",_this.off_scrubbing);delete _this.off_scrubbing};player.once("play",_this.off_scrubbing)})}this.spark_player.seek(this.get_mouse_time(event));if(!this.was_playing_before_drag)player.scrubbing(false);this.dragging=false;this.move_cancel()};Viewer.prototype.get_container=function(){if(E.conf.params.abs_container)return $(E.conf.params.abs_container);var container=$(this.player.get_ui().fullscreen);if(E.conf.params.container)return container.closest(E.conf.params.container);if(this.player.html5&&(this.player.html5.controls&&container[0]==this.player.html5||E.conf.params.native_controls)){this.native_controls=1;var wrapper=container.closest(".hola_video_wrapper");if(wrapper.length)return wrapper;log.info("wrap native html5 player");wrapper=$(document.createElement("div"));var position=container.css("position");wrapper.insertAfter(container).css({position:position=="static"?"relative":position,"z-index":container.css("z-index"),width:container.width()+"px",height:container.height()+"px",margin:container.css("margin")}).addClass("hola_video_wrapper");container.appendTo(wrapper);return wrapper}return container};Viewer.prototype.update_play_progress=function(progress){var sel;if(E.conf.params.play_progress)sel=E.conf.params.play_progress;else if(this.player.vjs)sel=".vjs-play-progress.vjs-slider-bar";this.container.find(sel).css("width",progress*100+"%")};Viewer.prototype.get_progress_bar=function(){if(E.conf.params.progress_bar)return this.container.find(E.conf.params.progress_bar);return $(this.player.get_ui().progress_bar)};Viewer.prototype.is_node_detached=function(){return this.div&&!document.body.contains(this.div)};Viewer.prototype.is_fullscreen_mode=function(){var fullscreen_sel;if(E.conf.params.fullscreen_sel)fullscreen_sel=E.conf.params.fullscreen_sel;else if(this.player.vjs)fullscreen_sel=".vjs-fullscreen";else if(this.player.jwplayer)fullscreen_sel=".jw-flag-fullscreen";else if(this.player.flowplayer)fullscreen_sel=".is-fullscreen";return fullscreen_sel&&(this.container.is(fullscreen_sel)||this.container.find(fullscreen_sel).length)};Viewer.prototype.get_mouse_progress=function(event){var area=this.get_hover_area();var cursor_x=event.changedTouches?event.changedTouches[0].pageX:event.pageX;var c_offset=this.container.offset();return Math.max(0,Math.min(1,(cursor_x-c_offset.left-area.left)/area.width))};Viewer.prototype.get_mouse_time=function(event){if(event.mouse_time)return event.mouse_time;if(event.type=="seeking")return this.player.get_pos();var progress=this.get_mouse_progress(event);var duration=this.player.get_duration();return Math.floor(progress*duration)};Viewer.prototype.update_drag_image=function(event){var real_time=this.get_mouse_time(event)+this.video_offset;var thumb;this.thumbnails.get(real_time,true,function(_thumb){thumb=_thumb});if(this.update_drag_et===undefined)this.update_drag_et=0;this.update_drag_et=(this.update_drag_et+1)%1e5;if(!thumb)return;if((this.has_thumb_url=this.has_thumb_url||thumb.url)&&E.conf.params.stop_drag_propagation&&/move$/.test(event.type)){event.stopPropagation()}this.drag_div.style.display="block";assign(this.drag_img.style,{"background-image":thumb.url?'url("'+thumb.url+'")':"none","background-position":"-"+thumb.img_x+"px -"+thumb.img_y+"px",width:thumb.width+"px",height:thumb.height+"px",margin:"0 auto","transform-origin":"top center",opacity:"0.9"});this.drag_img.style.transform="scale("+this.container.height()/thumb.height+")";if(E.conf.params.on_drag)E.conf.params.on_drag({E:E,$:$,_this:this,thumb:thumb});this.drag_pending_msg.style.display="none";if(thumb.is_fake){this.drag_pending_msg.style.top=thumb.height/2-7.5+"px";this.pending_msg.innerHTML=thumb.msg+"<br>Refresh for thumbnails";this.drag_pending_msg.style.display="block"}if(thumb.url)return;var _this=this;_this.thumbnails.get(real_time,false,function(update_drag_et,_thumb){if(_this.update_drag_et!=update_drag_et)return;if(_this.drag_enabled&&_thumb&&_thumb.url&&_this.drag_div.style.display=="block"){_this.update_drag_image(event)}}.bind(null,this.update_drag_et))};Viewer.prototype.display_drag_image=function(event){if(!this.drag_enabled)return;var _this=this;this.update_drag_image(event);this.player.once("seeked",function(){_this.drag_div.style.display="none"})};Viewer.prototype.add_styles=function(){var styles=[],container=this.container;if(this.player.name=="hola"){this.div.style.zIndex=1112;styles=[{selector:".vjs-mouse-display-tooltip",property:"display",value:"none"},{selector:".vjs-loading-spinner",property:"z-index",value:"1"},{selector:".vjs-settings-menu",property:"z-index",value:"1112"}]}else if(this.player.vjs){this.div.style.zIndex=1112;styles=[{selector:".vjs-mouse-display",property:"display",value:"none"},{selector:".vjs-control-bar",property:"z-index",value:"2"},{selector:".vjs-control-bar.fake_active .vjs-slider-bar:after",property:"display",value:"none"},{selector:".vjs-thumbnail-holder",property:"display",value:"none"}]}else if(this.player.jwplayer){styles=[{selector:".jw-tooltip-time",property:"display",value:"none"},{selector:".jw-controls",property:"z-index",value:"2"},{selector:".jw-controlbar-center-group",property:"position",value:"relative"}]}else if(this.player.flowplayer){styles=[{selector:".fp-timestamp, .fp-timeline-tooltip.fp-tooltip",property:"display",value:"none"}]}if(E.conf.params.styles)styles=styles.concat(E.conf.params.styles);var style=styles.map(function(s){var parent=container;if(s.parent_selector)parent=container.closest(s.parent_selector);parent.find(s.selector).css(s.property,s.value);var selector=(s.parent_selector||E.conf.params.abs_container||E.conf.params.container||"")+" "+s.selector;return selector+" {"+s.property+": "+s.value+" !important}"}).join("\n");if(E.style_injected[style])return;var style_el=document.createElement("style");style_el.textContent=style;document.head.appendChild(style_el);E.style_injected[style]=true};Viewer.prototype.subscribe=function(elem,sel,name,fn,use_capture){if(elem instanceof $)elem=elem[0];if(!elem)return;var _this=this;var _fn=function(ev){var is_sel_fn=typeof sel=="function";if(is_sel_fn&&sel().has(ev.target).length||!is_sel_fn&&(!sel||ev.target.matches(sel+", "+sel+" *"))){fn(ev)}};var names=Array.isArray(name)?name:[name];names.forEach(function(_name){elem.addEventListener(_name,_fn,use_capture);_this.listeners.push({elem:elem,name:_name,fn:_fn,use_capture:use_capture})})};Viewer.prototype.unsubscribe=function(elem){var listeners=this.listeners.filter(function(l){return l.elem});var left=[];if(elem){listeners=listeners.filter(function(l){if(l.elem==elem)return true;left.push(l)})}listeners.forEach(function(l){l.elem.removeEventListener(l.name,l.fn,l.use_capture)});this.listeners=left};Viewer.prototype.detach=function(){if(!this.inited)return;this.unsubscribe();dom_util.remove(this.img);dom_util.remove(this.div);this.uninit_drag()};Viewer.prototype.format_time=function(sec){return format_sec(sec).slice(0,-4)};Viewer.prototype.check_seeking=function(event){var now=Date.now();clearTimeout(this.seeking_timeout);if(event.type!="seeking"){this.last_move=now;return true}if(this.last_move&&now-this.last_move<500)return;var last_seeking=this.last_seeking;this.last_seeking=now;if(!last_seeking||now-last_seeking>500)return;this.seeking_timeout=setTimeout(this.move_cancel.bind(this),700);return true};Viewer.prototype.move_cancel=function(event){if(this.dragging||!this.visible)return;this.visible=false;this.div.style.display="none";if(this.hide_watermark)this.hide_watermark();if(E.conf.on_hide)E.conf.on_hide({$:$,_this:this,E:E});this.last_move=null;this.last_seeking=null;clearTimeout(this.seeking_timeout)};Viewer.prototype.on_move=function(event){var _this=this;if(E.conf.params.hide_timeout){clearTimeout(this.hide_timer);this.hide_timer=setTimeout(function(){if(_this.thumbnails.vtimeline)_this.thumbnails.vtimeline.hide()},E.conf.params.hide_timeout)}if(event.data&&event.data.skip)return;if(this.thumbnails.spark_player.container.hola_autoplay_playing_muted)return;if(!this.thumbnails.is_allowed())return void this.move_cancel();if(this.on_move_et===undefined)this.on_move_et=0;this.on_move_et=(this.on_move_et+1)%1e6;if(!this.check_seeking(event))return;this.init_drag(event);if(this.drag_inited)this.update_drag_handler();var area=this.get_hover_area();if(!area)return;if(!this.dragging&&!this.check_hover_area(event))return void this.move_cancel();var mouse_time=this.get_mouse_time(event);var real_time=mouse_time+this.video_offset;var thumb;this.thumbnails.get(real_time,true,function(_thumb){thumb=_thumb});if(!thumb||this.player.get_duration()<1)return void this.move_cancel();if((this.has_thumb_url=this.has_thumb_url||thumb.url)&&E.conf.params.stop_drag_propagation&&/move$/.test(event.type)){event.stopPropagation()}if(!this.first_shown){this.first_shown=true;E.stats.inc("unique_shown_n")}if(!this.first_shown_after_play&&this.player.is_playing()){this.first_shown_after_play=true;E.stats.inc_d("shown_after_play_n")}this.visible=true;var c_offset=this.container.offset();var point=get_event_point(event,c_offset);var left_pos=point.left-area.left-thumb.width/2-2;if(this.should_align_to_progress_bar())left_pos=Math.max(0,Math.min(left_pos,area.width-thumb.width-4));left_pos=area.left+left_pos;left_pos=Math.max(0,Math.min(left_pos,this.container.width()-thumb.width-4));var top_pos=area.top;assign(this.div.style,{left:left_pos+"px",top:top_pos+"px",display:"block"});assign(this.img.style,{"background-image":thumb.url?'url("'+thumb.url+'")':"none","background-position":"-"+thumb.img_x+"px -"+thumb.img_y+"px","transform-origin":"bottom",transform:this.is_fullscreen_mode()?"scale(1.5, 1.5)":"none",width:thumb.width+"px",height:thumb.height+"px"});var thumb_height=this.thumbnails.height||E.conf.ext_info_enabled&&def_thumb_height;this.img.style.setProperty(area.height<thumb_height?"bottom":"top",0,"important");if(this.show_watermark)this.show_watermark();if(E.conf.on_show)E.conf.on_show({$:$,_this:this,E:E});$(this.text_el).text(this.format_time(mouse_time+(E.conf.add_offset_to_pos?this.video_offset:0)));this.pending_msg.style.display="none";if(thumb.is_fake){this.pending_msg.style.top=thumb.height/2-7.5+"px";this.pending_msg.innerHTML=thumb.msg+"<br>Refresh for thumbnails";this.pending_msg.style.display="block"}if(thumb.url)return;this.thumbnails.get(real_time,false,function(on_move_et,_thumb){if(_this.on_move_et!=on_move_et)return;if(_this.visible&&_thumb&&_thumb.url)_this.on_move(event)}.bind(null,this.on_move_et))};Viewer.prototype.is_ad_banner_visible=function(){var ima=this.player.vjs&&this.player.vjs.ima;if(ima)return ima.adContainerDiv&&ima.adContainerDiv.style.display=="block"};Viewer.prototype.get_hover_area=function(with_limit){if(this.native_controls)return this.get_native_hover_area();var progress_bar=this.get_progress_bar();if(!progress_bar.length||!dom_util.is_visible(progress_bar[0]))return this.hover_area;var p_offset=progress_bar.offset(),c_offset=this.container.offset();var p_width=progress_bar.width(),p_height=progress_bar.height();var thumb_height=this.thumbnails.height||E.conf.ext_info_enabled&&def_thumb_height;var area_height=thumb_height+Math.max(22,p_height+6);var area={left:p_offset.left-c_offset.left,width:p_width,top:p_offset.top-c_offset.top+p_height-area_height,height:area_height+3};if(with_limit){var c_height=this.container.height();if(this.thumbnails.vtimeline&&this.thumbnails.vtimeline.tlwrap)c_height-=$(this.thumbnails.vtimeline.tlwrap).height()||0;var diff=c_height*.7-area.top;if(diff>0){area.top+=diff;area.height-=diff}if(this.is_ad_banner_visible()){diff=area.height-Math.max(20,p_height);if(diff>0){area.top+=diff;area.height-=diff}}area_height=E.conf.params.area_height||E.conf.params.disable_wide_area&&p_height;if(area_height){diff=area.height-area_height;area.top+=diff;area.height-=diff}}this.hover_area=area;return area};Viewer.prototype.guess_native_controls=function(){function _pad(num,size){return("0"+num).slice(-size)}function sec2text(sec,opt){opt=opt||{};sec=Math.floor(sec);var hours=Math.floor(sec/(60*60));sec-=hours*60*60;var mins=Math.floor(sec/60);sec-=mins*60;return(hours>0?hours+":":"")+_pad(mins,opt.force_two_digit_min||hours>0||mins>9?2:1)+":"+_pad(sec,2)}function text2width(font,text){var canvas=text2width.canvas=text2width.canvas||document.createElement("canvas");var ctx=canvas.getContext("2d");ctx.font=font;return Math.round(ctx.measureText(text).width)}function platform_gt(width,desktop_val,mobile_val){return width>(util.is_mobile?mobile_val:desktop_val)}function is_control_available(elem,name){var clist=elem.controlsList;switch(name){case"fullscreen":if(clist&&clist.contains("nofullscreen"))return false;if(util.is_chrome)return elem.webkitSupportsFullscreen;if(util.is_firefox)return document.mozFullScreenEnabled;if(util.is_edge)return document.webkitFullscreenEnabled;return true;case"download":if(!util.is_chrome||clist&&clist.contains("nodownload"))return false;var src=util.is_enabled(html5)?html5.get_hola_video_source(elem):elem.currentSrc;return!util.is_blob_url(src);case"captions":return elem.textTracks.length;case"cast":if(!util.is_chrome||clist&&clist.contains("noremoteplayback"))return false;return false;default:return true}}var font,control_bar,autocalc=-1,$v=$(this.player.html5);var vwidth=$v.width(),vheight=$v.height();var is_big_player=util.is_safari?vwidth>210:!this.spark_player.is_small();if(util.is_chrome&&util.browser.version>66){font="12px Arial";if(vwidth>740){control_bar={frame:{left:0,width:vwidth,top:vheight-54,height:32},items:{padding1:32,timeline:autocalc,padding2:32}}}else{control_bar={frame:{left:0,width:vwidth,top:vheight-24,height:24},items:{padding1:16,timeline:autocalc,padding2:16}}}}else if(is_big_player&&util.is_chrome){font="12px Arial";control_bar={frame:{left:0,width:vwidth,top:vheight-32,height:32},items:{play:32,ctime:text2width(font,sec2text($v[0].currentTime)),padding1:4,duration:text2width(font,"/ "+sec2text($v[0].duration)),padding2:18,timeline:autocalc,padding3:18,mute:32,padding4:18,volume:70,padding5:18,fullscreen:32,download:32,cast:32,captions:32}}}else if(is_big_player&&util.is_firefox&&util.is_linux){font="12px Arial";control_bar={frame:{left:0,width:vwidth,top:vheight-28,height:28},items:{play:28,timeline:autocalc,padding1:5,duration:text2width(font,sec2text($v[0].duration)),mute:28,volume:35,fullscreen:28,captions:28}}}else if(is_big_player&&util.is_firefox&&!util.is_linux){font="14px Arial";control_bar={frame:{left:0,width:vwidth,top:vheight-40,height:40},items:{padding1:10,play:30,padding2:8,timeline:autocalc,padding3:8,time:text2width(font,sec2text($v[0].currentTime)+" / "+sec2text($v[0].duration)),padding4:8,mute:30,volume:70,captions:30,fullscreen:30,padding5:10}}}else if(is_big_player&&util.is_edge){font="20px Arial";control_bar={frame:{left:0,width:vwidth,top:vheight-55,height:55},items:{play:55,padding1:5,ctime:text2width(font,sec2text($v[0].currentTime,{force_two_digit_min:true})),padding2:10,timeline:autocalc,padding3:10,duration:text2width(font,sec2text($v[0].duration,{force_two_digit_min:true})),mute:55,fullscreen:55}}}else if(is_big_player&&util.is_safari&&$v[0].played.length){font="14px Arial";control_bar={frame:{left:0,width:vwidth,top:vheight-35,height:30},items:{padding1:15,backward:platform_gt(vwidth,340,321)?27:0,play:25,forward:platform_gt(vwidth,370,350)?27:0,padding2:10,ctime:vwidth>275?text2width(font,sec2text($v[0].currentTime,{force_two_digit_min:true})):0,padding3:vwidth>275?5:0,timeline:autocalc,padding4:5,duration:text2width(font,"-"+sec2text($v[0].duration,{force_two_digit_min:true})),padding5:5,volume:platform_gt(vwidth,315,0)?40:0,padding6:15}}}else return;var controls=[],items=Object.keys(control_bar.items);for(var i=0;i<items.length;i++){var current=items[i];var width=control_bar.items[current];if(!is_control_available($v[0],current)||!width)continue;var frame=control_bar.frame;var auto_idx=controls.findIndex(function(e){return e.autowidth});if(auto_idx>=0){controls[auto_idx].width-=width;for(var j=auto_idx+1;j<controls.length;j++)controls[j].left-=width}var last=controls.length?controls[controls.length-1]:{left:0,width:0,top:frame.top,height:frame.height};controls.push({name:current,left:last.left+last.width,width:width!=autocalc?width:frame.width-last.left-last.width,top:frame.top,height:frame.height,autowidth:width==autocalc})}return controls};Viewer.prototype.get_native_hover_area=function(){var controls,_timeline,video=this.player.html5;var is_valid_time=function(time){return!isNaN(time)&&time>=0&&time<Infinity};if(!is_valid_time(video.currentTime)||!is_valid_time(video.duration)||!(controls=this.guess_native_controls())){return}_timeline=controls.find(function(o){return o.name=="timeline"});if(util.is_edge){return{left:_timeline.left,width:_timeline.width,top:_timeline.top+16,height:16}}return _timeline};Viewer.prototype.check_hover_area=function(event){if(event.type=="seeking")return true;var area=this.get_hover_area(true);if(!area)return false;var point=get_event_point(event,this.container.offset());return point.top>=area.top&&point.top<=area.top+area.height&&point.left>=area.left&&point.left<=area.left+area.width};Viewer.prototype.should_align_to_progress_bar=function(){if(E.conf.params.should_align_to_progress_bar)return true;return this.player.name=="hola"};Viewer.prototype.update_drag_handler=function(){var area=this.get_hover_area(true);if(!area)return;var progress_bar=this.get_progress_bar();if(progress_bar&&progress_bar.length){var p_offset=progress_bar.offset();var c_offset=this.container.offset();area=assign({},area,{left:c_offset.left-p_offset.left+area.left,top:c_offset.top-p_offset.top+area.top})}assign(this.drag_handler.style,{left:area.left+"px",top:area.top+"px",width:area.width+"px",height:area.height+"px"})};var Thumbnails=function(player,ctx){this.spark_player=player;this.player=player.controls;this.ctx=ctx;this.method=this.player.get_video_type_name();this.adaptive=ctx.attached_bws&&ctx.attached_bws.adaptive||!ctx.attached_bws&&util.is_adaptive(this.method);this.video_url=util.absolute_uri(this.player.get_url());this.listeners=[];if(!this.is_video_supported())return E.stats.inc_d("unsupported_video");this.load_thumb_et={};this.urls={};this.attach();this.subscribe(this.player.get_ui().progress_bar,"mousemove",this.retry_attach.bind(this))};Thumbnails.prototype.subscribe=function(elem,name,fn,use_capture){if(elem instanceof $)elem=elem[0];if(!elem)return;var _this=this;var names=Array.isArray(name)?name:[name];names.forEach(function(_name){elem.addEventListener(_name,fn,use_capture);_this.listeners.push({elem:elem,name:_name,fn:fn,use_capture:use_capture})})};Thumbnails.prototype.retry_attach=function(){if(this.thumbs||Date.now()<this.last_retry_ts+3e3||this.loading_task){return}E.stats.inc_d("info_fetch_retry_n");this.last_retry_ts=Date.now();this.attach()};Thumbnails.prototype.attach=function(){var _this=this;var player=this.player;var native=player.tech=="native"&&(player.hola_java_proxy||player.proxy);if(native&&native.module_cb){native.module_cb(id,"set_conf",JSON.stringify({full_frame_thumbnails:E.conf.params.full_frame_thumbnails}))}this.load_thumb_info(function(){if(_this.viewer||!_this.thumbs&&!E.conf.ext_info_enabled||_this.spark_player.is_floating()){return}if(native&&native.module_cb){native.module_cb(id,"init",JSON.stringify(_this.thumb_info));return}if(native&&native.thumbnails_init){native.thumbnails_init(_this.thumb_info);return}log.info("obtained info");if(E.conf.hidden&&!E.conf.debug)return void log.info("skip due to hidden mode");_this.viewer=new Viewer(_this);if(_this.thumbs&&!util.is_mobile&&E.conf.params.visual_timeline&&util.is_enabled(timeline)){_this.vtimeline=new timeline.Widget(_this)}_this.add_watermark()})};Thumbnails.prototype.load_thumb_info=function(cb){if(this.thumbs)return void cb(this.thumbs);if(this.loading_task)return void this.loading_task.push(cb);this.loading_task=[cb];var _this=this;var _finally=function(){var cbs=_this.loading_task;if(!cbs)return;for(var i=0;i<cbs.length;i++)cbs[i]();_this.loading_task=undefined};var cb_err=function(e){E.stats.inc("info_fetch_fail_n");E.stats.inc_d("info_fetch_fail_exception_n");log.warn("error during fetch thumbs info: "+e);_finally()};var thumb_info_handler=function(data){var res=data&&data.res;if(!res||!(res.info&&res.urls||res.size&&res.type))return void _finally();
var info=res.info,urls=res.urls,cdns=res.cdns;var rows=Math.sqrt(info.group_size),thumbs={};urls.forEach(function(url,_id){thumbs[_id*info.group_size*info.interval]={url:url,id:_id+1,sprites:{width:info.width,height:info.height,interval:info.interval,count:info.group_size,rows:rows}}});_this.thumb_info=res;_this.thumbs=thumbs;_this.cdns=cdns;_this.interval=thumbs[0].sprites.interval;_this.height=thumbs[0].sprites.height;_this.width=thumbs[0].sprites.width;_this.per_img=_this.interval*thumbs[0].sprites.count;_finally()};E.stats.inc("info_fetch_try_n");E.spark_modules.api.get_thumb_info(this.video_url,function(data){try{thumb_info_handler(data)}catch(e){cb_err(e)}})};Thumbnails.prototype.load_thumb=function(thumb_id,url,cb){cb=cb||function(){};if(this.urls[thumb_id])return void cb(this.urls[thumb_id]);if(this.load_thumb_et[thumb_id])return void this.load_thumb_et[thumb_id].push(cb);var _this=this;this.load_thumb_et[thumb_id]=[cb];E.stats.inc("fetch_try_n");log.info("fetch thumb "+thumb_id);var _finally=function(res){var cbs=_this.load_thumb_et[thumb_id];delete _this.load_thumb_et[thumb_id];if(!cbs)return;for(var i=0;i<cbs.length;i++)cbs[i](res)};var cb_err=function(e){E.stats.inc("fetch_fail_n");log.warn("error during fetch thumb: "+e);setTimeout(function(){delete _this.load_thumb_et[thumb_id]},3e3);_finally()};E.spark_modules.api.get_thumb(this.cdns,this.video_url,url,function(data){if(!data||data.err||!data.res)return void cb_err(new Error(data.err||"no thumb"));log.info("thumb "+thumb_id+" is fetched");E.stats.inc_d("fetch_success_n");var reader=new window.FileReader;reader.onloadend=function(){_this.urls[thumb_id]=reader.result;_finally(_this.urls[thumb_id])};reader.readAsDataURL(data.res)})};Thumbnails.prototype.get=function(time,immediately,cb){cb=cb||function(){};if(!this.thumbs){if(E.conf.ext_info_enabled){return void cb({is_fake:true,msg:this.err_msg,img_x:0,img_y:0,width:160,height:90})}return void cb()}var thumb_id=util.floor_mul(time,this.per_img);var idx=Math.floor(time%this.per_img/this.interval);var setting=this.thumbs[thumb_id];if(!setting)return void cb();var width=setting.sprites.width,height=setting.sprites.height;var thumb={width:width,height:height,img_x:idx%5*width,img_y:Math.floor(idx/5)*height,url:this.urls[setting.id]};this.load_thumb(setting.id,setting.url);if(immediately)return void cb(thumb);this.load_thumb(setting.id,setting.url,function(url){cb(assign(thumb,{url:url}))})};Thumbnails.prototype.detach=function(){if(this.loading_task)this.loading_task=undefined;this.listeners.forEach(function(l){l.elem.removeEventListener(l.name,l.fn,l.use_capture)});this.listeners=[];this.hide();if(this.vtimeline)this.vtimeline.detach()};Thumbnails.prototype.show=function(){if(!this.viewer&&this.thumbs)return this.attach()};Thumbnails.prototype.hide=function(){if(!this.viewer)return;this.viewer.detach();this.viewer=null;if(this.vtimeline){this.vtimeline.off();this.vtimeline.detach();this.vtimeline=null}if(this.watermark){$(this.watermark.pic).parent().remove();clearTimeout(this.watermark.defer)}delete this.watermark};Thumbnails.prototype.is_video_supported=function(){return this.video_url&&!this.player.is_live_stream()&&(!this.adaptive||this.method=="hls"||this.method=="dash")};Thumbnails.prototype.add_watermark=function(){if(!E.spark_modules.watermark||this.watermark)return;this.watermark=E.spark_modules.watermark;var container=this.viewer?this.viewer.get_container()[0]:this.player.get_ui&&this.player.get_ui().container;if(!this.watermark||!container)return this.watermark=null;this.watermark.apply({v:this.player,container:container});var set_watermark_visible,_this=this,visible=true;(set_watermark_visible=function(v){if(!_this.watermark)return;if(v&&_this.watermark.defer)_this.watermark.defer=clearTimeout(_this.watermark.defer);if(visible==v)return;if(v&&(visible=v)){$(_this.watermark.pic).css("opacity","");return $(_this.watermark.pic).removeClass("hola_hidden")}_this.watermark.defer=setTimeout(function(){if(!_this.watermark)return;$(_this.watermark.pic).css("opacity","0");visible=v;var duration=0;var property=$(_this.watermark.pic).css("transition-property");property=(property||"").split(" ");var idx=Math.max(property.lastIndexOf("opacity"),property.lastIndexOf("all"));if(idx>=0){duration=$(_this.watermark.pic).css("transition-duration");duration=(duration||"").split(" ");duration=parseFloat(duration[idx%duration.length]||"0")*1e3}_this.watermark.defer=setTimeout(function(){if(!_this.watermark)return;$(_this.watermark.pic).addClass("hola_hidden");$(_this.watermark.pic).css("opacity","");_this.watermark.defer=0},duration)},util.get(E.conf,"watermark_delay",2e3))}).call(this,false);var hide_watermark=set_watermark_visible.bind(null,false);var show_watermark=set_watermark_visible.bind(null,true);$(_this.watermark.pic).on("mouseenter",show_watermark);$(_this.watermark.pic).on("mouseleave",hide_watermark);if(this.vtimeline){this.vtimeline.hide_watermark=hide_watermark;this.vtimeline.show_watermark=show_watermark}if(this.viewer){this.viewer.hide_watermark=hide_watermark;this.viewer.show_watermark=show_watermark;return}this.player.vjs.on("userinactive",hide_watermark);var control=this.player.vjs.controlBar.progressControl;control.on("mouseout",hide_watermark);control.on("touchcancel",hide_watermark);control.on("touchend",hide_watermark);control.on("mousemove",show_watermark);control.on("touchmove",show_watermark)};Thumbnails.prototype.check_attached=function(){if(this.viewer&&this.viewer.is_node_detached()){log.info("reattach");var is_vtimeline_shown=this.vtimeline&&this.vtimeline.shown;this.hide();this.show();if(is_vtimeline_shown)this.vtimeline.show()}};Thumbnails.prototype.turn_on=function(){this.disabled=false};Thumbnails.prototype.turn_off=function(){this.disabled=true};Thumbnails.prototype.is_allowed=function(){if(this.disabled||this.player.is_any_ad_mode()||this.player.is_live_stream()){return false}if(E.conf.is_allowed)return E.conf.is_allowed({$:$,E:E,_this:this});return true};E.default_conf={params:{}};E.style_injected={};E.init=function(spark_modules,conf){E.spark_modules=spark_modules;log=spark_modules.log;log.notice("thumbnails init conf %o",conf);E.conf=conf;E.conf.ext_info_enabled=util.has_ext&&E.conf.debug_ext;E.stats=spark_modules.stats;if(util.is_enabled(timeline))timeline.init(spark_modules,conf);E.spark_modules.players.on("attach",on_player_attach);E.inited=true;log.info("inited");E.stats.inc_d("init_n")};return E});
define("/svc/cdn/pub/play_icon.js",["cash","/svc/cdn/pub/util.js","/svc/cdn/pub/dom_util.js"],function($,util,dom_util){var E={};var svg_shadow='<defs><filter id="shadow%id%">'+'<feDropShadow dx="0" dy="0" stdDeviation="2"/></filter></defs>';var max_logo_size=30;var def_styles={".hola_preview_icon":{position:"absolute","pointer-events":"none"},".hola_preview_icon svg":{width:"100%",height:"100%",fill:"#ffffff",stroke:"#ffffff"},".hola_preview_icon_countdown .icon-bg":{filter:"url(#shadow)"},".hola_preview_playing .hola_preview_icon":{visibility:"hidden"},".hola_preview_no_icon .hola_preview_icon":{visibility:"hidden"},".hola_preview_playing .hola_preview_icon_countdown":{visibility:"visible","z-index":"9999999"},".hola_preview_playing.hola_preview_blur .hola_preview_icon":{visibility:"visible","z-index":"9999999"},".hola_preview_icon .hola_preview_icon_cancel":{display:"block !important",height:"auto !important",width:"auto !important","line-height":"normal !important",margin:"0 -100% !important",padding:"0 1px !important","text-align":"center !important",color:"#fff !important","text-shadow":"0 0 2px #000 !important","transform-origin":"50% 0 !important","font-size":"12px !important","white-space":"nowrap !important","pointer-events":"auto !important",cursor:"pointer !important"},".hola_preview_icon .hola_preview_icon_cancel:hover":{transform:"scale(1.1)"},".hola_preview_icon .hola_preview_icon_cancel:after":{content:"",display:"none !important"},".hola_preview_icon .hola_preview_icon_cancel:before":{content:"",display:"none !important"}};function get_icon_pos_size(opt){var pos=opt.pos;if(typeof pos=="function")pos=pos();var size=opt.size_px?opt.size_px:(opt.size||.25)*pos.height+(opt.shadow?10:0);var top,left,loc=(opt.location||"center").split("-");var margin=opt.get_margin?opt.get_margin(size):opt.margin||10;if(loc[0]=="center"){left=(pos.width-size)/2;top=(pos.height-size)/2}else{top=loc[0]=="top"?margin:pos.height-size-margin;left=loc[1]=="left"?margin:pos.width-size-margin}return{pos:pos,top:top,left:left,size:size}}var logo_svg=[["M34,82.4c0,20.2,16.1,36.6,36,36.6s36-16.3,36-36.6c0-24.6-28-32.8-36-"+"61.4C62,49.7,34,57.8,34,82.4z M57,69 c2.7,0,5,3.1,5,7s-2.1,7-5,7c-2.6,"+"0-5-3.1-5-7S54.3,69,57,69z M98,83c0,15.4-12.6,28-28,28S42,98.4,42,"+"83h4c1,14,11.4,23.7,24,24 c12.7-0.3,23-10,24-24H98z M83,69c2.7,0,5,3.1,"+"5,7s-2.3,7-5,7s-5-3.1-5-7S80.3,69,83,69z","97,28 93,24 90,21 86,25 83,28 87,32 90,35 94,31","27.5,56 24.3,59.2 21,62.5 24.2,65.7 27.5,69 30.8,65.7 34,62.5 30.8,59.2","109.9,38.1 105,29 100.1,38.1 91,43 100,48 105,57 109.9,47.9 119,43","38,55 44,44 55,38 44,32 38,21 32,32 21,38 31.9,44.1"],["M34,82.4c0,20.2,16.1,36.6,36,36.6s36-16.3,36-36.6c0-24.6-28-32.8-36-"+"61.4C62,49.7,34,57.8,34,82.4z M90,69 c2,0,3.7,3.1,3.7,7S92,83,90,"+"83s-3.7-3.1-3.7-7S88,69,90,69z M98.1,83h2.9c0,15.4-9.2,28-20.5,28S60,"+"98.4,60,83h2.9 c0.7,14,8.4,23.7,17.6,24C89.8,106.7,97.3,97,98.1,83z "+"M74.7,76c0,3.9-1.6,7-3.7,7c-1.9,0-3.7-3.1-3.7-7s1.7-7,3.7-7 S74.7,72.1,"+"74.7,76z","101,30 96,25 92,21 87,26 83,30 88,35 92,39 97,34","29.5,50 25.3,54.2 21,58.5 25.3,62.8 29.5,67 33.8,62.7 38,58.5 33.7,54.2","111.2,40.8 107,33 102.8,40.8 95,45 102.7,49.3 107,57 111.2,49.2 119,45","40,51 45.3,41.3 55,36 45.3,30.7 40,21 34.7,30.7 25,36 34.6,41.4"],["M33.9,82.5c0,20.2,16.1,36.6,36,36.6c10.8,0,20.4-4.8,27-12.3C92.8,101.7,"+"90,92.9,90,83h2.1c0.4,9.6,3.1,17.1,6.9,21.1 c4.4-6,6.9-13.5,6.9-21.6"+"c0-24.6-28-32.8-36-61.4C61.9,49.8,33.9,57.9,33.9,82.5z M98,69c1.5,0,2.7,"+"3.1,2.7,7s-1.1,7-2.7,7 c-1.4,0-2.7-3.1-2.7-7S96.6,69,98,69z","112,43 108,47 105,50 109,54 112,57 116,53 119,50 115,46","44,47 48.6,38.6 57,34 48.6,29.4 44,21 39.4,29.4 31,34 39.4,38.6","43,54 35.9,50.1 32,43 28.1,50.1 21,54 28.1,57.9 32,65 35.9,57.9","95,49 99.9,39.9 109,35 99.9,30.1 95,21 90.1,30.1 81,35 90,40"],["M34,82.4c0,20.2,16.1,36.6,36,36.6s36-16.3,36-36.6c0-24.6-28-32.8-36-"+"61.4C62,49.7,34,57.8,34,82.4z","113,48 110,51 107,54 110,57 113,60 116,57 119,54 116,51","57,28 53,24 50,21 46,25 43,28 47,32 50,35 54,31","99,53 104.7,42.7 115,37 104.7,31.3 99,21 93.3,31.3 83,37 93.3,42.7","39.3,50.3 48,45.5 39.3,40.7 34.5,32 29.7,40.7 21,45.5 29.7,50.3 34.5,59"],["M34,82.4c0,20.2,16.1,36.6,36,36.6s36-16.3,36-36.6c0-24.6-28-32.8-36-"+"61.4C62,49.7,34,57.8,34,82.4z","114,48 111,51 109,53 112,56 114,58 117,55 119,53 116,50","55,27 52,24 49,21 46,24 43,27 46,30 49,33 52,30","106.7,32.3 100.5,21 94.3,32.3 83,38.5 94.2,44.8 100.5,56 106.7,44.7 118,"+"38.5","41.3,49.3 51,44 41.3,38.7 36,29 30.7,38.7 21,44 30.6,49.4 36,59"],["M34,82.4c0,20.2,16.1,36.6,36,36.6s36-16.3,36-36.6c0-24.6-28-32.8-36-"+"61.4C62,49.7,34,57.8,34,82.4z","113,48 110,51 107,54 110,57 113,60 116,57 119,54 116,51","57,28 53,24 50,21 46,25 43,28 47,32 50,35 54,31","99,53 104.7,42.7 115,37 104.7,31.3 99,21 93.3,31.3 83,37 93.3,42.7","39.3,50.3 48,45.5 39.3,40.7 34.5,32 29.7,40.7 21,45.5 29.7,50.3 34.5,59"],["M34,82.4c0,8.1,2.6,15.6,6.9,21.6c3.8-3.9,6.6-11.5,6.9-21.1H50c0,10-2.8,"+"18.8-7,23.8c6.6,7.6,16.2,12.3,27,12.3 c19.9,0,36-16.3,36-36.6c0-24.6-28-"+"32.8-36-61.4C62,49.7,34,57.8,34,82.4z M42,83c-1.5,0-2.7-3.1-2.7-7s1.2-7,"+"2.7-7s2.7,3.1,2.7,7 S43.4,83,42,83z ","112,43 108,47 105,50 109,54 112,57 116,53 119,50 115,46","44,47 48.6,38.6 57,34 48.6,29.4 44,21 39.4,29.4 31,34 39.4,38.6","43,54 35.9,50.1 32,43 28.1,50.1 21,54 28.1,57.9 32,65 35.9,57.9","95,49 99.9,39.9 109,35 99.9,30.1 95,21 90.1,30.1 81,35 90,40"],["M34,82.4c0,20.2,16.1,36.6,36,36.6s36-16.3,36-36.6c0-24.6-28-32.7-36-"+"61.4C62,49.7,34,57.8,34,82.4z M50,69 c2,0,3.7,3.1,3.7,7S52,83,50,"+"83s-3.7-3.1-3.7-7S48,69,50,69z M80,83c0,15.4-9.2,28-20.5,28S39,98.4,39,"+"83h2.9 c0.7,14,8.2,23.7,17.6,24c9.2-0.3,16.8-10,17.6-24H80z M72.7,76c0,"+"3.9-1.8,7-3.7,7c-2.1,0-3.7-3.1-3.7-7s1.7-7,3.7-7 S72.7,72.1,72.7,76z ","101,30 96,25 92,21 87,26 83,30 88,35 92,39 97,34","29.5,50 25.2,54.3 21,58.5 25.2,62.7 29.5,67 33.7,62.8 38,58.5 33.7,54.2","111.2,40.8 107,33 102.8,40.8 95,45 102.7,49.3 107,57 111.2,49.2 119,45","40,51 45.3,41.3 55,36 45.3,30.7 40,21 34.7,30.7 25,36 34.6,41.4"]];function Logo(opt,conf){this.opt=opt;this.conf=conf;this.index=0;this.opacity=conf.opacity||opt.logo_loader_opacity;var svg=this.get_svg();var $logo=this.logo=$("<div>"+svg+"</div>");$logo.addClass(conf.css_class||"hola_preview_loader_logo");$logo.css({position:"absolute",opacity:conf.hide?0:this.opacity});if(conf.pos)this.update_position(conf.pos);this.logo_ready();this.start_hiding=false;if(conf.watermark)conf.watermark.pause();if(conf.animate){$logo.addClass("hola_preview_loader_init");this.animate()}}Logo.prototype.update_position=function(pos){var size=Math.min(max_logo_size,Math.max(20,pos.width*.1))*(pos.scale||1);var margin=this.opt.icon_loader_margin===undefined?size/4:this.opt.icon_loader_margin;var pos_size=get_icon_pos_size({pos:pos,shadow:true,margin:margin,get_margin:this.conf.get_margin,size_px:size,location:pos.location||this.conf.location||"top-right"});this.logo.css({width:size+"px",height:size+"px",top:pos.top+pos_size.top+"px",left:pos.left+pos_size.left+"px"});if(pos.opacity)this.logo.css({opacity:this.opacity=pos.opacity})};Logo.prototype.animate=function(){if(this.animating)return;this.animating=true;this._animate()};Logo.prototype._animate=function(ts){if(!this.animating)return;var _this=this;function next(){_this.rm_anim=requestAnimationFrame(_this._animate.bind(_this))}if(!this.start){this.rm_t=setTimeout(function(){_this.logo.removeClass("hola_preview_loader_init");_this.start=ts;next()});return}if(ts-this.start<60)return next();this.start=ts;this.index++;this.redraw();if(!this.start_hiding||this.index>0)return next();if(this.hiding)return;this.hiding=true;this.rm_t=setTimeout(function(){_this.logo.addClass("hola_preview_loader_hide");_this.rm_t=clearTimeout(_this.rm_t);next();if(_this.conf.watermark)_this.conf.watermark.resume(_this.conf.logo_loader_hide_duration)},1e3)};Logo.prototype.pause=function(){this.rm_anim=cancelAnimationFrame(this.rm_anim);this.animating=false;this.index=0;this.redraw()};Logo.prototype.redraw=function(){if(this.is_index_max()){this.index=0;if(this.conf.animate_once)return this.pause()}this._redraw()};Logo.prototype.show=function(){this.start_hiding=false;if(this.logo)this.logo.css({opacity:this.opacity,display:""})};Logo.prototype.hide=function(quick){if(quick)return void this.logo.css({display:"none"});this.start_hiding=true};Logo.prototype.remove=function(){this.rm_anim=cancelAnimationFrame(this.rm_anim);this.rm_t=clearTimeout(this.rm_t);dom_util.remove(this.logo);this.logo=undefined};util.inherits(SparkLogo,Logo);function SparkLogo(opt){SparkLogo.super_.apply(this,arguments)}SparkLogo.prototype.get_svg=function(){var svg_frame=logo_svg[this.index];return'<svg viewBox="0 0 140 140"><g>'+'<path class="logo_path" d="'+svg_frame[0]+'"/>'+'<polygon class="logo_path" points="'+svg_frame[1]+'"/>'+'<polygon class="logo_path" points="'+svg_frame[2]+'"/>'+'<polygon class="logo_path" points="'+svg_frame[3]+'"/>'+'<polygon class="logo_path" points="'+svg_frame[4]+'"/>'+"</g></svg>"};SparkLogo.prototype.logo_ready=function(){this.path_el=this.logo.find(".logo_path")};SparkLogo.prototype.is_index_max=function(){return this.index>=logo_svg.length};SparkLogo.prototype._redraw=function(){var svg_frame=logo_svg[this.index];svg_frame.forEach(function(data,i){if(!this.path_el||!this.path_el[i])return;var attr=i==0?"d":"points";this.path_el[i].setAttribute(attr,data)}.bind(this))};util.inherits(CustomLogo,Logo);function CustomLogo(opt){this.steps=24;CustomLogo.super_.apply(this,arguments)}CustomLogo.prototype.get_svg=function(){var opt=this.opt;return'<svg viewBox="0 0 '+opt.width+" "+opt.height+'"><g>'+opt.svg_node+"</g></svg>"};CustomLogo.prototype.logo_ready=function(){var g=this.g=this.logo.find("g")[0];g.style.transformOrigin="50% 0"};CustomLogo.prototype.is_index_max=function(){return this.index>=this.steps};CustomLogo.prototype._redraw=function(){this.g.style.transform="rotate3d(0, 1, 0, "+this.index*(360/this.steps)+"deg)"};function Icon(opt){this.opt=opt;this.tr=opt.tr||function(){};this.container=opt.container;this.update();this._countdown=this.opt.countdown_on_hover*1e3}Icon.prototype.is_allowed=function(){if(this.opt.is_allowed)return this.opt.is_allowed()};Icon.prototype.update=function(){if(this.is_allowed())this.show();else this.hide()};Icon.prototype.show=function(){if(this.elem||this.off_img_load)return;var img,_this=this,opt=this.opt;if((img=$(opt.img)[0])&&!opt.icon_countdown&&img.tagName=="IMG"&&!dom_util.is_img_loaded(img)){this.off_img_load=dom_util.on_img_load(img,function(){_this.off_img_load=null;_this.show()});return}if(opt.on_show)opt.on_show();var icon='<g><path d="M 0,0 0,20 14,10 Z"/></g>';var stroke_width=3;var r=40/2-stroke_width/2;var cir=this.cir=Math.ceil(2*Math.PI*r);var circle="",class_name=util.is_ie?"":'class="icon-bg" ';var bg_circle="<g><circle "+class_name+'cx="5" cy="10" fill="#333" '+'fill-opacity="0.7" r="'+r+'" stroke-width="0"></circle></g>';class_name=opt.class||"hola_preview_icon";if(opt.icon_countdown){class_name+=" "+(opt.cd_class||"hola_preview_icon_countdown")+" hola_top_element";circle='<g><circle class="icon-progress" cx="-10" cy="5" '+'fill-opacity="0" r="'+r+'" stroke="#FFFFFF" stroke-dasharray="'+cir+'" stroke-dashoffset="0" stroke-width="'+stroke_width+'" transform="rotate(-90)"></circle></g>'}var svg='<svg viewBox="-20 -15 50 50">'+svg_shadow.replace("%id%","")+bg_circle+icon+circle+"</svg>";var elem=this.elem=$('<div class="'+class_name+'">'+svg+"</div>").css({"z-index":opt.z_index});this.update_pos();if(opt.on_countdown_cancel){class_name=opt.cl_class||"hola_preview_icon_cancel";var cancel=$('<span class="'+class_name+'">'+this.tr("countdown_cancel")+"</span>");var on_cancel=function(e){e.stopImmediatePropagation();e.preventDefault();_this.cancel()};cancel.on("click",on_cancel);cancel.on("touchstart",on_cancel);var cancel_event=function(e){e.stopImmediatePropagation();e.preventDefault()};cancel.on("mouseup",cancel_event);cancel.on("mousedown",cancel_event);cancel.on("pointerup",cancel_event);elem.append(cancel)}var info,c=this.container;if(c&&(info=$(c.info)[0]))$(info).before(elem);else{if(opt.icon_countdown&&c)$(c).append(elem);else if(img)$(img).after(elem);else $(c).append(elem)}if(opt.icon_countdown){this.update_countdown_fn=this.update_countdown.bind(this);this.rm_anim=requestAnimationFrame(this.update_countdown_fn)}};Icon.prototype.update_pos=function(opt){opt=opt?Object.assign(this.opt,opt):this.opt;var pos=opt.img_pos;if(typeof pos=="function")pos=pos();var pos_size=get_icon_pos_size({shadow:opt.shadow,location:opt.icon_location,size:opt.icon_size,pos:pos,margin:opt.icon_margin,size_px:opt.size_px});var top=(opt.icon_countdown?0:pos.top)+pos_size.top;var left=(opt.icon_countdown?0:pos.left)+pos_size.left;var size=pos_size.size;this.elem.css({position:"absolute",width:size+"px",height:size+"px",top:top+"px",left:left+"px"});clearTimeout(this.update_pos_to);this.update_pos_to=setTimeout(this.update_pos.bind(this),200)};Icon.prototype.cancel=function(){if(this.opt.on_countdown_cancel)this.opt.on_countdown_cancel();this.hide()};Icon.prototype.hide=function(){if(!this.elem)return;if(this.opt.on_hide)this.opt.on_hide();if(this.rm_anim)this.rm_anim=cancelAnimationFrame(this.rm_anim);if(this.off_img_load)this.off_img_load();if(this.update_to)this.update_to=clearTimeout(this.update_to);if(this.update_pos_to)this.update_pos_to=clearTimeout(this.update_pos_to);this.off_img_load=null;this.elem.remove();this.elem=null};Icon.prototype.get_el_params=function(el){var size,frect,rect=$(el)[0].getBoundingClientRect();if(this.fr_pos){frect={top:rect.top+this.fr_pos.top,left:rect.left+this.fr_pos.left};frect.right=frect.left+rect.width;frect.bottom=frect.top+rect.height;size=this.fr_pos.win}else size={width:window.innerWidth,height:window.innerHeight};rect=frect||rect;var opt=this.opt;if(opt.is_top||this.fr_et||!opt.msg)return{rect:rect,size:size};var _this=this;this.fr_et=true;opt.msg.get_frame_pos_cb(function(pos){_this.fr_pos=pos;_this.fr_et=undefined});return{rect:rect,size:size}};Icon.prototype.is_on_screen=function(el){var margin=5;function is_in(side,len){return rect[side]>=-margin&&rect[side]<=len+margin}var p=this.get_el_params(el),rect=p.rect;var h=p.size.height,w=p.size.width;var top_in=is_in("top",h),bottom_in=is_in("bottom",h);var left_in=is_in("left",w),right_in=is_in("right",w);var y_in=top_in&&bottom_in||rect.top<=0&&rect.bottom>=h;var x_in=left_in&&right_in||rect.left<=0&&rect.right>=w;return y_in&&x_in&&(!this.opt.check_z_index||dom_util.in_front(this.container))};Icon.prototype.update_countdown=function(ts){if(!this.opt.disable_visibility_check&&!this.is_on_screen(this.opt.visibility_check_icon?this.elem[0]:this.container)){this.update_to=setTimeout(this.update_countdown_fn,200);this._countdown_ts=undefined;return}if(!this._countdown_ts)this._countdown_ts=ts;var elapsed=Math.min(1,(ts-this._countdown_ts)/this._countdown);this._update_countdown(elapsed);if(elapsed==1){if(this.opt.on_navigate)this.opt.on_navigate();return}this.rm_anim=requestAnimationFrame(this.update_countdown_fn)};Icon.prototype._update_countdown=function(val){if(!this.elem)return;var $circle=$(this.elem).find(".icon-progress");if(!$circle||!$circle.length)return;$circle.css("stroke-dashoffset",-val*this.cir)};E.Icon=Icon;E.Logo=E.SparkLogo=SparkLogo;E.CustomLogo=CustomLogo;E.init=function(){if(!E.styles){E.styles=util.get_stylesheet(def_styles);$("head").append("<style>"+E.styles+"</style>")}};return E});
define("/svc/cdn/pub/feature/preview/debug.js",["cash","/svc/cdn/pub/util.js","/svc/cdn/pub/play_icon.js","/svc/cdn/pub/dom_util.js"],function($,util,play_icon,dom_util){var sec_ms=1e3;var E={};var preview_module;E.def_styles={".hola_preview_debug":{"pointer-events":"none",position:"absolute",display:"block",border:"2px dashed #f00","z-index":"2147483647",padding:"10px","box-sizing":"border-box"},".hola_preview_debug span":{color:"#fff",background:"rgba(0,0,0,0.5)",display:"inline-block",padding:"4px 2px",font:"bold 13px/13px Tahoma"},".hola_preview_debug.no_video":{"border-style":"solid"},".hola_preview_debug.has_video":{"border-style":"solid","border-color":"#ff0"},".hola_preview_debug.active":{"border-color":"#0f0"},".hola_preview_ext_info":{position:"absolute",display:"block","z-index":"2147483647","box-sizing":"border-box",background:"rgba(50,50,50,0.7)",color:"#fff",padding:"1em","font-size":"12px","line-height":"1.13"},".hola_preview_ext_info > a":{position:"absolute",top:"0",left:"0",width:"100%",height:"100%"},".hola_preview_ext_info svg.question":{position:"absolute",right:"0.5em",bottom:"0.5em",height:"1.6em",width:"1.6em"},".hola_preview_ext_info.has_video_ready":{display:"none"},".hola_preview_ext_info > div":{"text-align":"left",padding:"0.85em 34px 0.95em 1.25em",position:"relative"},".hola_preview_ext_info > div:not(.hola_preview_ext_info_tooltip)":{"min-height":"33%","background-color":"rgba(0, 156, 214, 0.6)"},".hola_preview_ext_info > div > div:first-child":{"font-weight":"bold","font-size":"133.33333%","letter-spacing":"-0.4px",margin:"0"},".hola_preview_ext_info > div > div+div":{margin:"0.5em 0 0 0"},".hola_preview_ext_info._smaller":{"font-size":"10px"},".hola_preview_ext_info._smaller > div":{padding:"0.5em 20px 0.5em 0.5em"},".hola_preview_ext_info._smaller > div > div:first-child":{"letter-spacing":"0"},".hola_preview_ext_info._smallest":{padding:"2px"},".hola_preview_ext_info._smallest > div":{"pointer-events":"none"},".hola_preview_ext_info._smallest > div > div:first-child":{"font-size":"100%"},".hola_preview_ext_info_logo":{"z-index":"2147483647 !important"},".hola_preview_ext_info_tooltip":{"margin-top":"2em","background-color":"rgba(0, 156, 214, 0.9)",width:"300px","font-size":"12px","border-radius":"4px",border:"1px solid rgba(200, 220, 255, 1)"},".hola_preview_viewport_debug":{border:"1px dashed #00f",background:"rgba(200,200,255,0.4)"}};var assign=Object.assign;var tooltip_text="This is a local Spark Configurator helper message. In "+"production, Video Previews are generated automatically, and this kind of "+"overlay is never displayed to users.\n\nNote: ignore this if it appears on "+"non-video links.";var ext_conf={title:{no_mapping:"**Spark Demo Mode**",not_requested:"Hover to generate preview",waiting_mapping:"Waiting for video to play",download_queue:"Downloading original",downloading:"Downloading original",generate_queue:"Generating preview",generating:"Generating preview",deleting:"Generating preview",download_queue_full:"Error: Download queue is full",generate_queue_full:"Error: Generation queue is full",error:"Error generating preview",disabled:"Disabled"},extra:{no_mapping:"Play to generate Video Preview",waiting_mapping:"Original video in other tab did not start. "+"Play it to start generation process.",download_queue:function(info){return"Waiting to download original video to a Spark server "+"(position "+info.position+")"},downloading:function(info){var progress=info.progress||(info.chunks?Math.floor(100*info.chunks/info.total):0)+"%";return"Downloading original video to a Spark server ("+progress+")"},generate_queue:function(info){return"Original video waiting to be processed (queue position "+info.position+")"},generating:"Spark server is generating the Video Preview",deleting:"Spark server is deleting original video",generate_queue_full:"Generate queue full",download_queue_full:"Download queue full",error:"Additional configuration on control panel is needed"},tooltip:{no_mapping:tooltip_text},progressing:["waiting_mapping","download_queue","downloading","generate_queue","generating","deleting"],min_show_time:{download_queue:4,downloading:3,generate_queue:4,generating:3,deleting:3}};var question_svg='<svg viewBox="0 0 24 24"><g><path fill="currentColor" d="'+"M12 24C5.373 24 0 18.627 0 12S5.373 0 12 0s12 5.373 12 12-5.373 12-12 12zm"+"0-22C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm"+"1.753 10.695c-.307.129-.514.481-.514.875v1.407h-1.948V13.57c0-1.205.675"+"-2.267 1.717-2.706.853-.36 1.336-1.264 1.173-2.201-.134-.78-.789-1.445-1.554"+"-1.582a1.912 1.912 0 0 0-1.614.431 1.992 1.992 0 0 0-.696 1.518H8.369c0"+"-1.174.507-2.281 1.392-3.037a3.859 3.859 0 0 1 3.202-.864c1.571.28 2.861 "+"1.593 3.138 3.191.32 1.86-.644 3.658-2.348 4.375zm-.514 6.246h-1.948v-1.982h"+'1.948v1.982z"/></g></svg>';function mouse_within(el,ev){if(ev&&ev.type=="mousemove")return dom_util.pointer_within(el,ev)}function get_mid_rect(check_x){var opt=E.conf.autoplay||{};var h_percentage=opt.area_height||10;var w_percentage;if(check_x)w_percentage=opt.area_width||10;return dom_util.get_mid_rect(h_percentage,w_percentage)}function poll_mapping(preview){if(preview.polling_mapping||preview.get_url())return;preview.polling_mapping=true;update_mapping(preview)}function set_debug_rect_interval(preview,delay){clearInterval(preview.update_debug_interval);preview.update_debug_interval=setInterval(preview.draw_debug_rect.bind(preview),(delay||3)*sec_ms)}function toggle_debug_tooltip(preview,ev){var tooltip;if(!(tooltip=preview.debug_tooltip))return;if(!ev){return tooltip.css("display",preview.debug_tooltip_shown?"":"none")}var icon=tooltip.siblings().find("svg.question");var show=icon.length&&mouse_within(icon,ev);if(show==preview.debug_tooltip_shown||show&&preview.debug_tooltip_t)return;preview.debug_tooltip_t=clearTimeout(preview.debug_tooltip_t);preview.debug_tooltip_shown=false;if(!show)return void tooltip.css("display","none");preview.debug_tooltip_t=setTimeout(function(){preview.debug_tooltip_t=null;preview.debug_tooltip_shown=true;tooltip.css("display","")},250)}function uninit_debug_listeners(preview){if(preview.debug_elems)preview.debug_elems.off("mouseover",preview.debug_mouseover);preview.debug_elems=null;preview.debug_mouseover=null;if(preview.debug_doc_mousemove)$(document).off("mousemove",preview.debug_doc_mousemove);preview.debug_doc_mousemove=null;if(preview.debug_click){$("#hola_preview_debug_"+preview.uniq_id).off("click",preview.debug_click)}preview.debug_click=null}function update_mapping(preview){if(!preview.polling_mapping||preview.get_url())return void(preview.polling_mapping=false);setTimeout(function(){preview_module.get_previews([{type:"page",url:preview.href}],E.conf,function(){if(!preview.debug_is_shown)return;if(!preview.get_url())return update_mapping(preview);preview.polling_mapping=false;preview.get_video().enable_ext_info()})},3*sec_ms)}E.draw_debug_active=function(_uniq_id,active){if(E.conf.debug)$("#hola_preview_debug_"+_uniq_id).toggleClass("active",!!active)};E.draw_debug_viewport=function(check_x){if(!E.conf.debug)return;var $viewport=$(".hola_preview_viewport_debug");if(!$viewport||!$viewport.length){$viewport=$("<div>");$viewport.addClass("hola_preview_debug hola_preview_viewport_debug");$(document.body).append($viewport)}var mid_rect=dom_util.client_rect2page_rect(get_mid_rect(check_x));$viewport.css({top:mid_rect.top+"px",left:mid_rect.left+"px",width:mid_rect.width+"px",height:mid_rect.height+"px"})};E.draw_rect=function(preview,rect){rect=dom_util.client_rect2page_rect(rect||(preview.img[0]||preview.el).getBoundingClientRect());var $rect=$("#hola_preview_debug_"+preview.uniq_id);if(!$rect||!$rect.length){var ext_class="hola_preview_ext_info";$rect=$("<div id=hola_preview_debug_"+preview.uniq_id+">").toggleClass("hola_preview_debug",preview_module.conf.debug).toggleClass(ext_class+" hola_top_element",!preview_module.conf.debug).appendTo($(document.body));if(!preview_module.conf.debug){uninit_debug_listeners(preview);var logo_opt={rect:$rect,pos:rect,get_margin:function(size){return 10+size/8},hide:true,location:"top-right",opacity:.8,watermark:preview_module.watermark,logo_loader_hide_duration:preview_module.conf.logo_loader_hide_duration,css_class:"hola_preview_loader_logo "+ext_class+"_logo"};preview.logo=new play_icon.Logo(preview.opt,logo_opt);$rect.after(preview.logo.logo);preview.debug_elems=$([$rect[0],preview.el]).add(preview.links).on("mouseover",preview.debug_mouseover=function(){if(preview.debug_is_shown)return;preview.debug_is_shown=true;$rect.css("display","");preview.logo.show();preview.logo.animate();preview.get_video().enable_ext_info();set_debug_rect_interval(preview,1);poll_mapping(preview);if(preview.debug_doc_mousemove)return;$(document).on("mousemove",preview.debug_doc_mousemove=function(ev){toggle_debug_tooltip(preview,ev);if(preview.debug_elems.get().find(function(el){return mouse_within(el,ev)})){return}preview.debug_is_shown=false;preview.polling_mapping=false;preview.logo.pause();preview.logo.hide(true);preview.get_video().disable_ext_info();set_debug_rect_interval(preview);$rect.css("display","none");$(document).off("mousemove",preview.debug_doc_mousemove);preview.debug_doc_mousemove=null})});$rect.on("click",preview.debug_click=function(){if(preview.polling_mapping)preview.waiting_mapping=true;$rect.off("click",preview.debug_click);preview.debug_click=null})}}$rect.toggleClass("no_video",!!preview.has_info&&!preview.has_video);$rect.toggleClass("has_video",!!preview.has_video);var new_pos={top:rect.top-2+"px",left:rect.left-2+"px",width:rect.width+2+"px",height:rect.height+2+"px"};var update_logo_position=function(){if(!preview.logo)return;var pos=assign({},rect,preview.progressing&&{location:"center",scale:3,opacity:.3});if(!util.equal_deep(pos,preview.debug_logo_pos))preview.logo.update_position(pos);preview.debug_logo_pos=pos};if(!util.equal_deep(new_pos,preview.last_pos)){$rect.css(new_pos);$rect.toggleClass("_smaller",rect.width<200);$rect.toggleClass("_smallest",rect.width<150);preview.last_pos=new_pos;update_logo_position()}var info=preview.get_info();if(preview_module.conf.debug){var lines=[];for(var s in info)lines.push("<span>"+s+": <b>"+info[s]+"</b></span>");$rect.html(lines.join("<br/>"));return}else if(!preview.debug_is_shown)$rect.css("display","none");if(info&&info.status=="error"&&/^toobusy/.test(info.error))info=preview.last_info||{status:"download_queue_full"};if(info&&info.status=="no_mapping"&&preview.waiting_mapping)info={status:"waiting_mapping"};else preview.waiting_mapping=false;if(info&&info.status=="no_mapping")preview.should_fake_info=true;if(info&&preview.should_fake_info){var show_time=preview.show_time;var required=Object.keys(ext_conf.min_show_time).concat(["ready"]);var status=info.status,index=required.indexOf(status);for(var i=0;i<index;i++){var r=required[i],shown=show_time[r]||0,missing;if(!((missing=ext_conf.min_show_time[r]-shown)>0))continue;var chunks=0,position=5,total=20;var fake_info={status:r,chunks:19,total:total,position:0};var next=fake_info;for(var j=0;j<missing;j++){if(!shown){position=Math.floor(Math.random()*position);chunks+=Math.floor(Math.random()*(total-chunks));next=assign({},fake_info,{position:position,chunks:chunks})}preview.info_queue.push(next)}show_time[r]=shown+missing}show_time[status]=(show_time[status]||0)+1;if(status!="ready"||show_time[status]<2)preview.info_queue.push(info)}preview.showing_fake_info=preview.info_queue.length;info=preview.showing_fake_info?preview.info_queue.shift():info;if(!info)return;if(info.status=="ready"){$rect.addClass("has_video_ready");preview.showing_fake_info=false;preview.uninit_debug_rect();if(preview.debug_is_shown)preview.hover();return}if(!preview.debug_is_shown&&util.equal_deep(info,preview.last_info))return;preview.last_info=info;var title=ext_conf.title[info.status]||"";var extra=ext_conf.extra[info.status]||"";var tooltip=ext_conf.tooltip[info.status]||"";if(typeof extra=="function")extra=extra(info);if(extra&&(info.status=="no_mapping"||(preview.progressing=ext_conf.progressing.includes(info.status)))){preview.progress_dots+=".";if(preview.progress_dots.length>5)preview.progress_dots=".";extra+=preview.progress_dots}else preview.progress_dots="";update_logo_position();var overlay=$("<div>").html("<div>"+title+"</div>"+(extra?"<div>"+extra+"</div>":"")).appendTo($rect.empty());if(tooltip){overlay.append($(question_svg).addClass("question"));preview.debug_tooltip=$("<div>").addClass("hola_preview_ext_info_tooltip").html(tooltip).appendTo($rect);toggle_debug_tooltip(preview)}$("<a>").attr("href",preview.href).attr("target","_blank").appendTo($rect)};E.init_debug_rect=function(preview){if(!(preview.use_debug_rect=E.conf.debug||E.conf.ext_info_enabled))return;preview.progress_dots="";preview.info_queue=[];preview.show_time={};set_debug_rect_interval(preview)};E.uninit_debug_rect=function(preview){if(!preview.use_debug_rect)return;preview.update_debug_interval=clearInterval(preview.update_debug_interval);preview.use_debug_rect=false;uninit_debug_listeners(preview);if(preview.logo)preview.logo.remove();preview.logo=null;preview.get_video().disable_ext_info();$("#hola_preview_debug_"+preview.uniq_id).remove()};E.init=function(_preview_module){preview_module=_preview_module;E.conf=preview_module.conf};return E});
define("/svc/cdn/pub/feature/preview/editor.js",{__stub:1});
define("/svc/cdn/pub/feature/preview/controls.js",{__stub:1});
define("/svc/cdn/pub/promo_db.js",["/util/util.js","/util/events.js","/svc/cdn/pub/util.js"],function(zutil,events,util){var E=PromoData;var MAX_REDIRECTS=7;var assign=Object.assign;var arr_props=["Creatives","Extensions","MediaFiles","TrackingEvents","VideoClicks"];function get_xml(url,cb){var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.onreadystatechange=function(){if(xhr.readyState!=xhr.DONE)return;if(xhr.status!=200)return cb();cb(xhr.responseXML)};xhr.send()}function xml2json(xml,_arr_props){_arr_props=_arr_props||[];var json={},i;var children=xml.children;if(!xml)return;if(xml.nodeType!=1)return xml2json(children[0],_arr_props);var name=xml.nodeName;if(xml.children&&xml.children.length){if(_arr_props.includes(name)){json[name]=[];for(i=0;i<xml.children.length;i++)json[name].push(xml2json(xml.children[i],_arr_props))}else{json[name]={};for(i=0;i<xml.children.length;i++)assign(json[name],xml2json(xml.children[i],_arr_props))}}else{json[name]=xml.innerHTML.replace(/[\s\S]*CDATA\[([^\]]+)\][\s\S]*/,"$1")}if(xml.attributes&&xml.attributes.length){json.attr={};for(i=0;i<xml.attributes.length;i++){var attr=xml.attributes[i].name;json.attr[attr]=xml.getAttribute(attr)}}return json}var TRACKING_EVENTS={start:"AD_START",firstQuartile:"AD_FIRST_QUARTILE",midpoint:"AD_MIDPOINT",thirdQuartile:"AD_THIRD_QUARTILE",complete:"AD_COMPLETE",creativeView:"AD_CREATIVE_VIEW"};zutil.inherits(PromoData,events.EventEmitter);function PromoData(opt){this._playlist=opt.playlist;this._playlist_url=opt.playlist_url;this._playlist_ttl=opt.playlist_ttl_sec||60;this._disable_reload=opt.disable_playlist_reload;this._playlist_ts=0;this._vast_url=opt.vast_url;this._source=null;this._source_playlist=null;this._state="IDLE";if(this._vast_url)this._source_type="vast";else if(this._playlist_url)this._source_type="remote_playlist";else if(this._playlist)this._source_type="built_in_playlist";this._load()}PromoData.prototype.get_playlist=function(){var playlist;if(this._source){this._source_playlist=this._source.get_playlist();this._load();return this._source_playlist}if(this._playlist&&this._playlist.length){var playlist_num=Math.random()*this._playlist.length|0;playlist=this._playlist[playlist_num].slice();if(Date.now()-this._playlist_ts>this._playlist_ttl*1e3)this._load();return playlist}};PromoData.prototype.onready=function(cb){if(this._state!="IDLE")return void cb();this.on("ready",cb)};PromoData.prototype._ready=function(){if(this._state!="IDLE")return;this._state="READY";this.emit("ready")};PromoData.prototype._load=function(){if(this._disable_reload&&this._source_playlist&&this._source_playlist.length){return}var _this=this;if(this._source_type=="vast"){this._source=null;get_xml(this._vast_url,function(xml){_this._xml=xml;_this._json=xml2json(xml,arr_props);if(_this._json.Playlist)_this._source=new Playlist({json:_this._json.Playlist});else _this._source=new Vast({xml:_this.xml,json:_this._json});if(_this._source._state=="READY")return void _this._ready();_this._source.on("ready",_this._ready.bind(_this))});return}if(this._source_type=="remote_playlist"){this._playlist=null;util.get_json(this._playlist_url,function(data){_this._ready();if(!data)return;_this._playlist=data.playlist;_this._playlist_ts=Date.now()});return}};zutil.inherits(Playlist,events.EventEmitter);function Playlist(opt){this._url=opt.url;this._json=opt.json;this._items=[];var _this=this;if(this._json){this._items=Object.keys(this._json).map(function(type){return new Vast({url:_this._json[type].Ad,type:type.toLowerCase()})});if(this._items.length)this._items[0].on("ready",_this.emit.bind(_this,"ready"));else this.emit("ready")}else this.emit("ready")}Playlist.prototype.get_playlist=function(){if(!this._items.length)return;var playlist=[];this._items.forEach(function(vast){var vast_playlist=vast.get_playlist();if(vast_playlist&&vast_playlist.length)playlist=playlist.concat(vast_playlist)});return playlist};zutil.inherits(Vast,events.EventEmitter);function Vast(opt){this._url=opt.url;this._type=opt.type;this._json=opt.json;this._last_update=0;this._creatives=[];this._xml=opt.xml;this._json=opt.json;this._ad_wrapper_url=null;this._ad_wrapper=null;this._redirect_num=opt.redirect_num||0;this._state="IDLE";var _this=this;this._load(function(){_this._ad_wrapper_url=zutil.get(_this._json,"VAST.Ad.Wrapper.VASTAdTagURI",null);if(_this._ad_wrapper_url&&_this._redirect_num<MAX_REDIRECTS){_this._ad_wrapper=new Vast({url:_this._ad_wrapper_url,redirect_num:_this._redirect_num+1});_this._ad_wrapper.one("ready",_this.set_ready_state.bind(_this))}else _this.set_ready_state()})}Vast.prototype.set_ready_state=function(){this._state="READY";this.emit("ready")};Vast.prototype.get_playlist=function(){if(this._ad_wrapper)return this._ad_wrapper._get_playlist();if(this._ad_wrapper_url||!this._json)return;var inline;if(!(inline=zutil.get(this._json,"VAST.Ad.InLine",null)))return;var linear;try{linear=inline.Creatives[0].Creative.Linear}catch(e){}if(!linear)return;var media_files=linear.MediaFiles;var duration=linear.Duration;if(!media_files||!media_files.length||!duration)return;media_files=media_files.filter(function(media){return media.attr.type=="video/mp4"}).sort(function(m1,m2){return m1.attr.width-m2.attr.width});if(!media_files.length)return;var offset=this._type=="postroll"?Infinity:0;var trackers={};trackers.AD_IMPRESSION=inline.Impression;trackers.AD_ERROR=inline.Error;if(linear.TrackingEvents){linear.TrackingEvents.forEach(function(ev){var ev_name=ev.attr.event;if(ev_name in TRACKING_EVENTS)trackers[TRACKING_EVENTS[ev_name]]=ev.Tracking})}var click_url;try{click_url=linear.VideoClicks[0].ClickThrough}catch(e){}return[{offset:offset,duration:parseInt(duration.split(":")[2],10),type:"linear",url:media_files[0].MediaFile,click_url:click_url,trackers:trackers}]};Vast.prototype.check_ttl=function(){if(!this._url)return;if(Date.now()-this._last_update>this.ttl_sec*1e3)this.load()};Vast.prototype._load=function(cb){if(this._json||!this._url)return void cb();this._last_update=Date.now();var _this=this;get_xml(this._url,function(xml){if(!xml)return void(this.ttl_sec=this._err_ttl_sec);_this._xml=xml;_this._json=xml2json(xml,arr_props);cb()})};return E});
define("/svc/cdn/pub/promo_ui.js",["/util/util.js","/util/events.js","/svc/cdn/pub/dom_util.js"],function(zutil,events,dom_util){var E=PromoUI;E.states={IDLE:"IDLE",ERROR:"ERROR",STARTED:"STARTED",ENDED:"ENDED"};E.events={STATE_CHANGE:"STATE_CHANGE"};var css=[".spark_preview_promo_nonlinear, .spark_preview_promo_video {","  top: 0;","  left: 0;","  position: absolute!important;","  visibility: hidden;","  object-fit: cover;","  opacity: 1;","  transition: opacity 0.3s ease-in-out;","  margin: 0!important;","  display: block!important;","}",".spark_preview_promo_video.hola_fade_out {","  opacity: 0;","}"].join("\n");function get_css(opt){var _css=css;if(opt&&opt.keyframes_show){_css+="\n@keyframes preview_promo_show {\n  "+opt.keyframes_show.join("\n  ")+"\n}"}if(opt&&opt.keyframes_hide){_css+="\n@keyframes preview_promo_hide {\n  "+opt.keyframes_hide.join("\n  ")+"\n}"}return _css}function track_event(event,url){var img=new Image;img.src=url}function PromoUI(container,ad_opt,opt){this._container=container;if(!container.shadowRoot)container.attachShadow({mode:"open"});this._ad_opt=ad_opt;this._opt=opt;this._ad=null;this._render()}PromoUI.prototype.destroy=function(){if(!this._ad)return;this._ad.destroy();this._ad=null};PromoUI.prototype._render=function(){this._container.shadowRoot.innerHTML="<style>"+get_css(this._opt)+"</style>";if(this._ad_opt.type=="non_linear")this._ad=new NonLinear(this._container,this._ad_opt,this._opt);else this._ad=new Linear(this._container,this._ad_opt,this._opt);this._ad.show()};PromoUI.prototype.on=function(event,cb){this._ad.on(event,cb)};zutil.inherits(Linear,events.EventEmitter);function Linear(container,ad_opt,opt){this._width=dom_util.width(container);this._height=dom_util.height(container);this._container=container.shadowRoot;this._ad_opt=ad_opt;this._opt=opt;this._promo=null;this.state=E.states.IDLE;this._render()}Linear.prototype.destroy=function(){var _this=this;this.hide(function(){_this._rm_listeners();dom_util.remove(_this._promo);dom_util.remove(_this._link)})};Linear.prototype.hide=function(cb){cb=cb||function(){};var opt=this._opt;var hide_delay;if(opt.keyframes_hide){hide_delay=opt.keyframes_hide_dur_sec||1;this._promo.style.animation="preview_promo_hide "+hide_delay+"s";this._promo.style.animationFillMode="forwards"}else this._promo.style.visibility="hidden";this._promo.pause();if(hide_delay)setTimeout(cb,hide_delay*1e3);else cb()};Linear.prototype.show=function(){var opt=this._opt;if(opt.keyframes_show){var dur=opt.keyframes_show_dur_sec||1;this._promo.style.animation="preview_promo_show "+dur+"s";this._promo.style.animationFillMode="forwards"}this._promo.style.visibility="visible";this._promo.play()};Linear.prototype._add_listeners=function(){this._add_trackers();this.__on_ended=this._on_ended.bind(this);this.__on_error=this._on_error.bind(this);this.__on_meta=this._on_meta.bind(this);this._promo.addEventListener("ended",this.__on_ended);this.source.addEventListener("error",this.__on_error);this._promo.addEventListener("loadedmetadata",this.__on_meta)};Linear.prototype._add_trackers=function(){var fn,promo=this._promo;var trackers=this._ad_opt.trackers;if(!trackers)return;this._rm_tracker_fns=[];if(trackers.AD_START){fn=function(){track_event("AD_START",trackers.AD_START)};promo.addEventListener("play",fn);this._rm_tracker_fns.push(promo.removeEventListener.bind(promo,"play",fn))}if(trackers.AD_IMPRESSION){fn=function(){track_event("AD_IMPRESSION",trackers.AD_IMPRESSION)};promo.addEventListener("play",fn);this._rm_tracker_fns.push(promo.removeEventListener.bind(promo,"play",fn))}var progress_25=trackers.AD_FIRST_QUARTILE;var progress_50=trackers.AD_MIDPOINT;var progress_75=trackers.AD_THIRD_QUARTILE;if(progress_25||progress_50||progress_75){fn=function(){var progress=Math.ceil(promo.currentTime/promo.duration*100);if(progress_25&&progress>=25){track_event("AD_FIRST_QUARTILE",progress_25);progress_25=undefined}if(progress_50&&progress>=50){track_event("AD_MIDPOINT",progress_50);progress_50=undefined}if(progress_75&&progress>=75){track_event("AD_THIRD_QUARTILE",progress_75);progress_75=undefined}};promo.addEventListener("timeupdate",fn);this._rm_tracker_fns.push(promo.removeEventListener.bind(promo,"timeupdate",fn))}if(trackers.AD_COMPLETE){fn=function(){track_event("AD_COMPLETE",trackers.AD_COMPLETE)};promo.addEventListener("ended",fn);this._rm_tracker_fns.push(promo.removeEventListener.bind(promo,"ended",fn))}if(trackers.AD_ERROR){fn=function(){track_event("AD_ERROR",trackers.AD_ERROR)};this.source.addEventListener("error",fn);this._rm_tracker_fns.push(this.source.removeEventListener.bind(this.source,"error",fn))}};Linear.prototype._rm_trackers=function(){if(!this._rm_tracker_fns)return;this._rm_tracker_fns.forEach(function(rm_track_fn){rm_track_fn()});this._rm_tracker_fns=[]};Linear.prototype._on_ended=function(){this.destroy();this._update_state(E.states.ENDED)};Linear.prototype._on_video_play=function(){if(this.state!=E.states.IDLE||this._ad_opt.offset!=0)return;this._update_state(E.states.STARTED);this.show()};Linear.prototype._on_video_ended=function(){if(this.state!=E.states.IDLE||this._ad_opt.offset!=Infinity)return;this._update_state(E.states.STARTED);this.show()};Linear.prototype._on_error=function(){this._rm_listeners();this.hide();this._update_state(E.states.ERROR)};Linear.prototype._on_meta=function(){var dur=this._promo.duration;if(dur<=this._ad_opt.duration)return;this.speed=+(dur/this._ad_opt.duration).toFixed(2);this._update_speed()};Linear.prototype._on_timeupdate=function(){if(this.state!=E.states.IDLE)this._update_state(E.states.STARTED);this.show()};Linear.prototype._render=function(){var ad_opt=this._ad_opt;var promo=this._promo=document.createElement("video");var container=this._container;var _this=this;promo.muted=true;promo.setAttribute("muted",1);promo.setAttribute("playsinline",1);promo.style.width=this._width+"px";promo.style.height=this._height+"px";promo.className="spark_preview_promo_video";if(ad_opt.click_url){if(this._opt.disable_click_link){container.appendChild(promo);["click","touchend"].forEach(function(ev_name){promo.addEventListener(ev_name,function(event){window.open(ad_opt.click_url);if(!_this._opt.disable_click_destroy)_this.destroy();event.preventDefault();event.stopPropagation()})})}else{this._link=document.createElement("a");this._link.href=ad_opt.click_url;this._link.target="_blank";this._link.appendChild(promo);container.appendChild(this._link)}}else container.appendChild(promo);var source=this.source=document.createElement("source");source.setAttribute("type","video/mp4");promo.appendChild(source);this._add_listeners();source.setAttribute("src",ad_opt.url)};Linear.prototype._rm_listeners=function(){this._rm_trackers();this._promo.removeEventListener("ended",this.__on_ended);this._promo.removeEventListener("loadedmetadata",this.__on_meta);this.source.removeEventListener("error",this.__on_error)};Linear.prototype._update_speed=function(){this._promo.defaultPlaybackRate=this.speed;this._promo.playbackRate=this.speed};Linear.prototype._update_state=function(state){this.state=state;this.emit(E.events.STATE_CHANGE,state)};zutil.inherits(NonLinear,events.EventEmitter);function NonLinear(container,ad_opt,opt){this._width=dom_util.width(container)||1;this._height=dom_util.height(container)||1;this._container=container.shadowRoot;this._ad_opt=ad_opt;this._opt=opt;this.state=E.states.IDLE;this._render()}NonLinear.prototype.destroy=function(){this.hide();dom_util.remove(this.promo)};NonLinear.prototype.hide=function(){var _opt=this._opt;if(_opt.keyframes_hide){var dur=_opt.keyframes_hide_dur_sec||1;this.promo.style.animation="preview_promo_hide "+dur+"s";this.promo.style.animationFillMode="forwards"}else this.promo.style.visibility="hidden"};NonLinear.prototype.show=function(){var _opt=this._opt;if(_opt.keyframes_show){var dur=_opt.keyframes_show_dur_sec||1;this.promo.style.animation="preview_promo_show "+dur+"s";this.promo.style.animationFillMode="forwards"}this.promo.style.visibility="visible";this.__on_ended_timeout=setTimeout(this._on_ended.bind(this),this._ad_opt.duration*1e3)};NonLinear.prototype._add_listeners=function(){this.__on_error=this._on_error.bind(this);this.__on_load=this._on_load.bind(this);this.__on_timeupdate=this._on_timeupdate.bind(this);this.promo.addEventListener("load",this.__on_load);this.promo.addEventListener("error",this.__on_error)};NonLinear.prototype._on_ended=function(){this._rm_listeners();this.hide();this._update_state(E.states.ENDED)};NonLinear.prototype._on_error=function(){this._rm_listeners();this.hide();this._update_state(E.states.ERROR)};NonLinear.prototype._on_load=function(){this.promo_width=this.promo.naturalWidth;this.promo_height=this.promo.naturalHeight;this._update_size()};NonLinear.prototype._on_timeupdate=function(){if(this.state!=E.states.IDLE)return;this._update_state(E.states.STARTED);this.show()};NonLinear.prototype._render=function(){var promo=this.promo=document.createElement("img");promo.className="spark_preview_promo_nonlinear";promo.style.visibility="hidden";this._container.appendChild(promo);this._add_listeners();promo.setAttribute("src",this._ad_opt.url)};NonLinear.prototype._rm_listeners=function(){if(this.promo)this.promo.removeEventListener("load",this.__on_load);if(this.__on_ended_timeout)this.__on_ended_timeout=void clearTimeout(this.__on_ended_timeout);this.promo.removeEventListener("error",this.__on_error)};NonLinear.prototype._update_state=function(state){this.state=state;this.emit(E.events.STATE_CHANGE,state)};NonLinear.prototype._update_size=function(){this.promo.style.width=this._width;var new_height=this.promo_height*this._width/this.promo_width;this.promo.style.height=new_height+"px";this.promo.style.top=(this._height-new_height)/2+"px"};return E});
define("/svc/cdn/pub/feature/preview/promo.js",{__stub:1});
define("/svc/cdn/pub/autoplay_policy.js",["/svc/cdn/pub/util.js"],function(util){var E={};var policy,state;var STATES={idle:"idle",in_progress:"in_progress",ready:"ready"};var callbacks=[];var small_mp4,small_mp4_with_sound;function reset(){policy={sound:null,sound_err:null,muted:null,muted_err:null};state=STATES.idle}reset();small_mp4="data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wN"+"DEAAAAIZnJlZQAAAu1tZGF0AAACrQYF//+p3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE1N"+"SByMjkwMSA3ZDBmZjIyIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtM"+"jAxOCAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjP"+"TEgcmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT1oZXggc3VibWU9NyBwc"+"3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xI"+"HRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb"+"21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTMgbG9va2FoZWFkX3RocmVhZHM9MSBzbGljZWRfdGhyZ"+"WFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxhY2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0c"+"mFpbmVkX2ludHJhPTAgYmZyYW1lcz0zIGJfcHlyYW1pZD0yIGJfYWRhcHQ9MSBiX2JpYXM9MCBka"+"XJlY3Q9MSB3ZWlnaHRiPTEgb3Blbl9nb3A9MCB3ZWlnaHRwPTIga2V5aW50PTI1MCBrZXlpbnRfb"+"WluPTEgc2NlbmVjdXQ9NDAgaW50cmFfcmVmcmVzaD0wIHJjX2xvb2thaGVhZD00MCByYz1jcmYgb"+"WJ0cmVlPTEgY3JmPTI4LjAgcWNvbXA9MC42MCBxcG1pbj0wIHFwbWF4PTY5IHFwc3RlcD00IGlwX"+"3JhdGlvPTEuNDAgYXE9MToxLjAwAIAAAAAwZYiEAD//8m+P5OXfBeLGOfKE3xkODvFZuBflHv/+V"+"wJIta6cbpIo4ABLoKBaYTkTAAAC7m1vb3YAAABsbXZoZAAAAAAAAAAAAAAAAAAAA+gAAAPoAAEAA"+"AEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAIAAAIYdHJhawAAAFx0a2hkAAAAAwAAAAAAAAAAAAAAAQAAAAAAA"+"APoAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAACgA"+"AAAWgAAAAAAJGVkdHMAAAAcZWxzdAAAAAAAAAABAAAD6AAAAAAAAQAAAAABkG1kaWEAAAAgbWRoZ"+"AAAAAAAAAAAAAAAAAAAQAAAAEAAVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAV"+"mlkZW9IYW5kbGVyAAAAATttaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmA"+"AAAAAAAAAEAAAAMdXJsIAAAAAEAAAD7c3RibAAAAJdzdHNkAAAAAAAAAAEAAACHYXZjMQAAAAAAA"+"AABAAAAAAAAAAAAAAAAAAAAAACgAFoASAAAAEgAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAABj//wAAADFhdmNDAWQACv/hABhnZAAKrNlCjfkhAAADAAEAAAMAAg8SJZYBA"+"AZo6+JLIsAAAAAYc3R0cwAAAAAAAAABAAAAAQAAQAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAA"+"AABAAAAFHN0c3oAAAAAAAAC5QAAAAEAAAAUc3RjbwAAAAAAAAABAAAAMAAAAGJ1ZHRhAAAAWm1ld"+"GEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAA"+"B1kYXRhAAAAAQAAAABMYXZmNTguMjkuMTAw";small_mp4_with_sound="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc2"+"8ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG/"+"/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAA"+"AALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAA"+"IAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAE"+"AAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAA"+"AAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAA"+"AAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcm"+"VmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAA"+"AAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAf"+"QAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAA"+"ABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAA"+"EAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAA"+"AAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=";function detect(muted,cb){var v=document.createElement("video");v.muted=muted;v.setAttribute("muted",muted);v.setAttribute("playsinline",1);v.src=muted&&util.is_ios?small_mp4:small_mp4_with_sound;var p=v.play();if(p&&p.catch){p.catch(function(e){cb(e.message,false);cb=null}).then(function(){if(cb)cb(null,true)});return}if(v.paused)return cb("play refused");var listener=function(e){v.removeEventListener("playing",listener);v.removeEventListener("error",listener);v.removeEventListener("abort",listener);v.removeEventListener("pause",listener);if(e.type=="playing")return cb(null,true);var err="not playing: "+e.type,msg;if(e.type=="error"&&(msg=v.error&&v.error.message))err+=", "+msg;cb(err,false)};v.addEventListener("playing",listener);v.addEventListener("error",listener);v.addEventListener("abort",listener);v.addEventListener("pause",listener)}function detect_muted(cb){detect(true,function(err,muted){policy.muted=muted;policy.muted_err=err||policy.muted_err;cb()})}function detect_sound(cb){detect(false,function(err,sound){policy.sound=sound;policy.sound_err=err||policy.sound_err;cb()})}E.get_policy=function(cb){if(state==STATES.ready)return void cb(policy);if(state==STATES.in_progress)return void callbacks.push(cb);state=STATES.in_progress;function finish_detect(){state=STATES.ready;cb(policy);while(callbacks.length){cb=callbacks.shift();cb(policy)}}if(util.is_windows&&util.is_ie&&!(util.guess.version>=10)){policy.sound=true;policy.muted=true;return void finish_detect()}if(util.is_ios){policy.sound=false;return void detect_muted(finish_detect)}detect_sound(function(){detect_muted(finish_detect)})};E.can_autoplay=function(cb){E.get_policy(function(_policy){if(_policy.sound)return void cb("sound",_policy);if(_policy.muted)return void cb("muted",_policy);cb(false,_policy)})};E.t={reset:reset};return E});
define("/svc/cdn/pub/widget_info.js",["cash","/util/util.js","/util/events.js","/svc/cdn/pub/play_icon.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/l10n.js"],function($,zutil,events,play_icon,dom_util,l10n){var E={};var spark;var pr_class="hola_widget_";var css=[".hola_widget_info_popup {","  position: absolute;","  z-index: 2000 !important;","  pointer-events: all;","  background-color: rgba(28, 28, 28, 0.9);","  white-space: nowrap;","  width: auto;","  padding: 2px 0;","  margin: 0;","  color: #fff;","  letter-spacing: -0.2px;","}",".hola_widget_info_popup li {","  list-style-type: none;","}",".hola_widget_info_content {","  margin: 0;","  padding: 0;","}",".hola_widget_menu_item_link {","  height: 21px;","  cursor: pointer;","  padding: 0 3.7px;","  clear: both;","}",".hola_widget_menu_link {","  display: block !important;","  color: #fff;","  font-size: 9px;","  text-align: left;","  line-height: 1;","}",".hola_widget_version {","  color: #eee;","  font-size: 8px;","  padding-top: 2px;","  text-align: left;","  line-height: 1;","}",".hola_widget_menu_pwd_text a,",".hola_widget_menu_pwd_text a:hover {","  display: block;","  color: #fff !important;","  text-decoration: none;","  border-color: #fff;","}",".hola_widget_menu_pwd_text {","  display: inline-block;","  padding-left: 2.5px;","  height: 17px;","  vertical-align: middle;","  margin-bottom: 13px;","  line-height: 1;","}",".hola_widget_menu_icon_link {","  width: 21px !important;","  height: 21px !important;","  display: inline-block !important;","  text-align: left;","}",".hola_widget_menu_icon_link svg {","  opacity: 0.8;","  width: 100%;","  height: 100%;","  fill: #fff;","  stroke: #fff;","}"].join("\n");dom_util.add_style("data-spark-widget-info",css);function create_el(base,el,cl){return $("<"+el+">").addClass(base+(cl||""))}zutil.inherits(InfoPopup,events.EventEmitter);function InfoPopup(ctx,div,opt){this.ctx=ctx;this.parent=this._get_parent(div,opt);this.opt=opt;this.create=create_el.bind(this,pr_class);this._init()}InfoPopup.prototype.info_show=function(e){e.preventDefault();if(this.popped)return this._hide();var parent,el=this.root[0],x=e.clientX,y=e.clientY;var max_right=window.innerWidth,max_bottom=window.innerHeight;if(parent=this._get_overflow_parent(el)){var parent_rect=parent.getBoundingClientRect();var el_rect=el.getBoundingClientRect();if(parent_rect.width<el_rect.width)return this.uninit();max_right=Math.min(max_right,Math.max(parent_rect.right,el_rect.left));max_bottom=Math.min(max_bottom,Math.max(parent_rect.bottom,el_rect.top))}var left_shift=Math.max(0,x+el.offsetWidth-max_right+5);var top_shift=Math.max(0,y+el.offsetHeight-max_bottom+5);var rect=this.parent[0].getBoundingClientRect();el.style.left=Math.max(0,x-rect.left-left_shift)+"px";el.style.top=Math.max(0,y-rect.top-top_shift)+"px";this._show();if(this.logo)this.logo.animate()};InfoPopup.prototype.uninit=function(){this._hide();if(this.root[0].parentNode)this.root.remove();if(this.opt.ref_container&&this.parent[0].parentNode)this.parent.remove();if(this.on_info_show_fn)this.ctx.off("info_show",this.on_info_show_fn);if(this.on_info_hide_fn)this.ctx.off("info_hide",this.on_info_hide_fn);if(this.on_hide_fn)document.removeEventListener("click",this.on_hide_fn)};InfoPopup.prototype._add_child=function(e){var _this=this;var h={powered_by:{create:function(opt){opt=opt||{};var el=_this.create("li","menu_item_link");var href=opt.href||"#";var icon=_this.create("a","menu_icon_link").attr("href",href).attr("target","_blank");_this.logo=new play_icon.Logo({},{animate:true,opacity:1,css_class:pr_class+"menu_icon_link",animate_once:true});icon.append(_this.logo.logo);var pwd=_this.create("a","menu_link").text(opt.label).attr("href",href).attr("target","_blank");pwd=_this.create("div","menu_pwd_text").append(pwd);if(opt.version){pwd.append(_this.create("div","version").text(opt.version))}return el.append(icon).append(pwd)},on_click:function(evt){evt.stopPropagation();_this._hide()}}};if(!this.menu)this.menu=this.create("ul","info_content");var it=h[e.type],el=it.create(e.opt);if(it.on_click)el.on("click",it.on_click);return this.menu.append(el)};InfoPopup.prototype._get_overflow_parent=function(el){if(this.opt.in_parent)return this.parent[0];var parent=el;while(parent=parent.parentElement){var style=window.getComputedStyle(parent);if(style.overflowX!="visible"||style.overflowY!="visible")return parent}};InfoPopup.prototype._get_parent=function(div,opt){if(!opt.ref_container)return $(div);div=$(opt.ref_container);var pos=div.position();var p=$("<div>").css({position:"absolute",top:pos.top+"px",left:pos.left+"px",width:div.width()+"px","pointer-events":"none",height:div.height()+"px"});$(opt.ref_container).after(p);return p};InfoPopup.prototype._hide=function(){this.root.css({visibility:"hidden",opacity:0});this.popped=false};InfoPopup.prototype._init=function(){this.on_hide_fn=function(e){if(this.popped)this._hide()}.bind(this);this.on_info_hide_fn=function(e){if(!this.popped)return;this._hide();if(this.logo)this.logo.pause();if(e){e.stopPropagation();e.preventDefault()}return false}.bind(this);this.on_info_show_fn=this.info_show.bind(this);this.root=this.create("div","info_popup");this._hide();this._add_child(this.opt.child);this.ctx.on("info_show",this.on_info_show_fn);this.ctx.on("info_hide",this.on_info_hide_fn);document.addEventListener("click",this.on_hide_fn);this.parent.append(this.root.append(this.menu));this.inited=true};InfoPopup.prototype._show=function(){this.root.css({visibility:"visible",opacity:1});this.popped=true};E.powered_by=function(ctx,opt){var _opt={in_parent:opt.in_parent,child:{type:"powered_by",opt:{version:spark.version_short,label:l10n.spark_t("powered_by_text"),href:"http://holaspark.com?cam=wm_"+opt.module_id+"_"+spark.customer}},ref_container:opt.ref_container};return new InfoPopup(ctx,opt.el,_opt)};E.init=function(_spark){spark=_spark};return E});
define("/svc/cdn/pub/feature/preview/modal_box.js",["cash","/svc/cdn/pub/util.js"],function($,util){var assign=Object.assign;var E=ModalBox;function ModalBox(preview,opt,preview_module){this.preview=preview;this.opt=opt;this.preview_module=preview_module;var inited=this.init();preview_module.stats.inc("navigate_modal_try_n");preview_module.stats.inc("navigate_modal_"+!!inited+"_n");if(!inited)return void preview.link.click();preview.pause();preview.countdown_cancel();if(preview.countdown)preview.countdown.hide();preview_module.shows_modal_box=true}ModalBox.prototype.init=function(){var preview=this.preview;var opt=this.opt;var preview_info=this.preview_info=preview.get_map_info();var preview_module=this.preview_module;var stats=preview_module.stats;if(!preview_info)return void stats.inc("navigate_modal_no_info_n");this.paused_players=[];var video;if(preview_module.spark.customer=="golfchannel"){var iframe_src=preview_info.frame_url;if(!iframe_src)return void stats.inc("navigate_modal_no_iframe_src_n");iframe_src=iframe_src.replace(/#playerurl=.*$/,"#playerurl="+encodeURIComponent(preview_module.spark.top_url));iframe_src+=(/#/.test(iframe_src)?"&":"#")+"spark_share_disable";iframe_src=iframe_src.replace("autoplay","autoPlay");video=$(document.createElement("iframe"));video.attr({src:iframe_src,allow:"autoplay",seamless:"seamless",frameborder:"0",allowfullscreen:true});video.css("background","#222222")}this.video=video;var background=this.background=$(document.createElement("div"));background.css(assign({position:"fixed","z-index":1e7,background:"rgba(0, 0, 0, 0.8)",top:"0",left:"0",width:"100%",height:"100%",transition:"opacity .3s ease-in-out",opacity:"0"},opt.style.background));var modal=this.modal=$(document.createElement("div"));background.append(modal);modal.css(assign({position:"fixed",background:"#0f1012","border-radius":"2px",border:"1px solid #222","box-shadow":"0 2px 2px 0 rgba(0,0,0,0.1)"},opt.style.modal));modal.addClass("hola_preview_modal_box spark_injected_player");var title=this.title=$(document.createElement("div"));modal.append(title);var description=preview_info.description||preview_info.video_title||preview.link_info.description;this.title_padding=5;title.text(description);title.css(assign({padding:this.title_padding+"px 8%"},opt.style.title));modal.append(video);video.css(assign({position:"relative",left:opt.margin+"px"},opt.style.video));var _this=this;if(!opt.no_button){var full_link=this.full_link=$(document.createElement("div"));modal.append(full_link);full_link.css(assign({width:"120px",height:"40px",margin:"auto",position:"relative",top:"30px",background:"#4c8ca7","text-align":"center","line-height":"40px","border-radius":"5px",cursor:"pointer"},opt.style.full_link));full_link.text(util.get(opt,"text.full_article","Full article"));full_link.on("click",function(){var progress,player;if(opt.use_frame_url)progress=_this.get_video_progress();else{player=_this.get_spark_player();progress=player&&player.get_pos()}if(progress>10){stats.inc("navigate_modal_full_click_seek_n");if(opt.use_frame_url){preview.link.href+="#spark_seek="+Math.floor(progress)+"s"}else if(player)player.save_position()}stats.inc("navigate_modal_full_click_n");_this.destroy();preview.link.click()})}var close=this.close_btn=$(document.createElement("div"));modal.append(close);close.css(assign({position:"absolute",right:"20px",top:"20px",width:"30px",height:"30px","border-radius":"15px",background:"#aaa","line-height":"30px","text-align":"center","font-family":"sans-serif","font-size":"18px",cursor:"pointer"},opt.style.close));close.text("X");close.on("click",this.on_close_click=this.close.bind(this));background.on("click",this.on_bg_click=function(ev){if(!ev.target||ev.target==background[0])_this.close()});$(document.body).append(background);this.update_position();if(util.is_mobile){$(window).on("orientationchange",this.on_orientationchange=util.debounce(this.update_position.bind(this),30)).on("resize",this.on_orientationchange)}setTimeout(function(){background.css("opacity","1")});preview_module.spark.players.forEach(function(p){if(!p.controls||!p.controls.is_playing())return;_this.paused_players.push(p);p.controls.pause()});if(opt.close_after){var last_progress,no_action=0;this.progress_interval=setInterval(function(){var progress=_this.get_video_progress();if(progress===undefined||progress!=last_progress){last_progress=progress;no_action=0;return}if(progress&&++no_action>opt.close_after)_this.close()},1e3)}return true};ModalBox.prototype.update_position=function(){var opt=this.opt;var margin=opt.margin;var size=this.preview_info.video_nat_size||this.preview_info.video_size||"160x90";var video_size=this.preview_module.links.size_util.parse(size);var aspect_ratio=video_size.height/video_size.width;var window_width=$("body").innerWidth()||window.innerWidth;var window_height=window.innerHeight;var orientation=window_width>window_height?"landscape":"portrait";if(!this.initial_orientation)this.initial_orientation=orientation;var title=this.title,title_height=title.height();var orig_title_height=title_height;if(title_height<(opt.margin_top=opt.margin_top||opt.margin)){var css={margin:(opt.margin_top-title_height)/2+"px 0"},m;if((m=title.css("line-height").match(/^(\d+)px$/))&&m[1]){var line_height=+m[1];if(line_height<title_height/2-2*this.title_padding)css["line-height"]=opt.margin_top-2*this.title_padding+"px"}title.css(css);title_height=opt.margin_top}var video_width,video_height,modal_width,modal_height,modal_top;if(util.is_mobile&&opt.full_screen_on_landscape&&orientation=="landscape"&&this.initial_orientation=="portrait"){modal_width=window_width;modal_height=window_height;modal_top=0;video_width=modal_width-2*margin;video_height=modal_height-title_height-margin}else{video_width=Math.min(window_width*.9,window_width-2*margin,800);video_height=video_width*aspect_ratio;if(video_height>window_height*.6){video_height=window_height*.6;video_width=video_height/aspect_ratio}modal_width=video_width+2*margin;modal_height=Math.ceil(title_height+video_height+(this.full_link&&this.full_link.height()||0)+margin);modal_top=modal_height+window_height*.4>window_height?Math.floor((1-modal_height/window_height)/2*100):20}this.video.css({height:video_height+"px",width:video_width+"px"});this.modal.css({width:modal_width+"px",height:modal_height+"px",top:modal_top+"%",left:(window_width-modal_width)/2+"px"});if(title.height()!=orig_title_height)this.update_position()};ModalBox.prototype.get_spark_player=function(){return this.preview_module.spark.players.find(function(p){return $(p.container).closest(this.background).length}.bind(this))};ModalBox.prototype.get_video_progress=function(){var opt=this.opt;if(opt.use_frame_url){var frames=this.preview_module.spark.msg.frames;var content_window=this.video[0].contentWindow;var frame=Object.keys(frames).find(function(f){return frames[f].frame==content_window});return frame&&frames[frame].video_progress}var player=this.get_spark_player();return player&&player.get_pos()};ModalBox.prototype.close=function(){var paused_players=this.paused_players;if(paused_players.length){setTimeout(function(){paused_players.forEach(function(p){p.controls.play()})},500)}this.destroy()};ModalBox.prototype.destroy=function(){this.preview_module.stats.inc("navigate_modal_close_n");if(this.on_close_click){this.on_close_click=void this.close_btn.off("click",this.on_close_click)}var background=this.background;if(this.on_bg_click)this.on_bg_click=void background.off("click",this.on_bg_click);background.css("opacity","0");setTimeout(function(){background.remove()},500);if(this.on_orientationchange){$(window).off("orientationchange",this.on_orientationchange).off("resize",this.on_orientationchange)}this.paused_players=[];this.progress_interval=void clearInterval(this.progress_interval);this.preview_module.shows_modal_box=false};return E});
define("/svc/cdn/pub/feature/preview/index.js",["cash","/svc/cdn/pub/util.js","/util/events.js","/svc/cdn/pub/play_icon.js","/svc/cdn/pub/feature/preview/debug.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/l10n.js","/svc/cdn/pub/feature/preview/editor.js","/svc/cdn/pub/feature/preview/controls.js","/svc/cdn/pub/feature/preview/promo.js","/svc/cdn/pub/autoplay_policy.js","/svc/cdn/pub/widget_info.js","/svc/cdn/pub/feature/preview/modal_box.js"],function($,util,events,play_icon,preview_debug,dom_util,l10n,editor,controls,promo,autoplay_policy,widget_info,modal_box){var trace=/spark_trace=1/.test(location.search);var perr;var E=new util.events;E.util=util;E.previews_map={};var assign=Object.assign,t;var module_id="preview";var log;var uniq_id=0;var autoload={},preload={};var sec_ms=1e3,min_ms=60*sec_ms;var week_sec=7*24*60*60;E.previews=new PreviewsController;var AUTOPLAY_RANDOM=1;var AUTOPLAY_VIEW=2;var AUTOPLAY_SELECTOR=3;var AVG_TTFB=1e3;var LOADER_GROW=0;var LOADER_BAR=1;var LOADER_FADE=2;var REP_REQ_DELAY=10;E.default_conf={line_loader:LOADER_FADE,logo_loader_opacity:"0.6",autoload:{count:10,scroll_perc:0},autoplay:{selector:"*"},autoplay_popular:{count:3,stop_on_action:false,load_count:200},blur:{start:60,icon:80,end:100,level:10},call_to_action:{delay:3,text:"Watch video",opacity:50},preview_over_player:{},fade_time:500,navigate_on_hover_sec:2,countdown_on_hover:5,link_tags:[],live:{endpoint:"/live_previews/preview.mp4",size:"1280x720",cdns:[{host:"ve-cdn.h-cdn.com",hostname:"ve-cdn.h-cdn.com"}]},streaming_cache:60,modal_box:{style:{},text:{},margin:20}};E.default_storage={previews:{}};E.watermark_conf={delay:function(dur,pos){return dur/2-pos}};var def_styles={".hola_preview_container":{margin:"0",padding:"0",border:"0",position:"absolute !important","z-index":"auto",overflow:"hidden"},".hola_preview_background":{position:"absolute",top:"0",left:"0","object-fit":"cover"},".hola_preview_popup":{"border-width":"2px","border-style":"solid","border-color":"#ff0000","background-color":"#000000","box-sizing":"content-box","z-index":"2147483347",transition:"opacity .3s ease-in-out, transform .3s ease-in-out",opacity:"0"},".hola_preview_popup.hola_preview_shown":{transform:"scale(1) !important"},".hola_preview_text_link_popup":{padding:"2px","border-color":"#888","background-color":"#eee",overflow:"visible"},".hola_preview_text_link_popup>a":{display:"block",position:"relative",width:"100%",height:"100%",overflow:"hidden"},".hola_preview_text_link_popup .hola_video_preview":{visibility:"visible"},".hola_preview_first_frame.hola_video_preview":{visibility:"visible"},".hola_popup_arrow, .hola_popup_arrow_border":{position:"absolute",width:"0",height:"0",top:"100%","border-style":"solid",transform:"skewX(30deg)"},".hola_popup_arrow":{left:"35px","border-color":"#eee transparent transparent transparent","border-width":"20px 0 0 50px"},".hola_popup_arrow_border":{left:"31px","border-color":"#888 transparent transparent transparent","border-width":"22px 0 0 56px"},".hola_preview_popup_visible":{opacity:"1"},".hola_preview_popup .hola_preview_poster":{width:"100%",height:"100%"},".hola_preview_title":{position:"absolute",width:"100%","line-height":"24px",bottom:"0","padding-left":"5px",overflow:"hidden","font-size":"14px","white-space":"nowrap","text-overflow":"ellipsis",color:"#ffffff","background-color":"rgba(0, 0, 0, 0.7)"},".hola_preview_playing .hola_video_preview":{visibility:"visible"},".hola_preview_poster":{top:"0",left:"0","max-width":"inherit !important","max-height":"inherit !important",margin:"0 !important",position:"absolute",transition:"opacity 0.1s ease-in-out, transform 0.3s ease-in-out",opacity:"1 !important"},".hola_preview_playing .hola_preview_poster":{opacity:"0 !important"},".hola_video_preview":{top:"0",left:"0",position:"absolute !important",visibility:"hidden","object-fit":"cover",opacity:"1",transition:"opacity 0.3s ease-in-out",margin:"0 !important",display:"block !important"},".hola_video_preview.hola_fade_out":{opacity:"0"},".hola_preview_img":{visibility:"hidden"},".hola_preroll":{"background-size":"contain","background-position":"50% 50%","background-repeat":"no-repeat","background-image":"url(//ve.h-cdn.com/svc/preview/pub/img/watermark-contour.svg)","pointer-events":"none",position:"absolute",transition:"width, height, left, top, opacity 0.25s ease-in 0.25s","transition-timing-function":"ease-in","transition-duration":"0.5s",width:"0%",height:"0%",left:"50%",top:"50%"},".hola_preroll_end":{width:"200%",height:"200%",left:"-50%",top:"-50%",opacity:"0"},".hola_preroll_img_img":{width:"100%",height:"100%"},".hola_preroll_img":{"pointer-events":"none",position:"absolute",width:"100%",height:"100%",left:"0",top:"0"},".hola_preview_loader":{top:"0",left:"0",width:"0",position:"absolute",transition:"width 0.2s",height:"2px","max-height":"2px","background-color":"#ff0000","z-index":1},".hola_preview_loader.hola_preview_first_frame":{"z-index":1},".hola_preview_loader_logo":{all:"initial","pointer-events":"none",position:"absolute",top:"0",left:"0",display:"block",width:"30px",height:"30px","min-width":"20px","min-height":"20px","max-width":"140px","max-height":"140px",opacity:"0",transition:"opacity 0.2s","z-index":1,"-webkit-filter":"drop-shadow(0 0 2px rgba(0,0,0,.4))",filter:"drop-shadow(0 0 2px rgba(0,0,0,.4))"},".hola_preview_loader_hide":{transition:"opacity 0.7s ease-in-out",opacity:"0 !important"},".hola_preview_loader_logo svg":{width:"100%",height:"100%",fill:"#ffffff",stroke:"#ffffff",transition:"transform 0.2s ease-in-out",transform:"scale(1)"},".hola_preview_loader_init svg":{transform:"scale(0.1)"},".hola_preview_loader_hide svg":{transition:"transform 0.5s ease-in-out",transform:"scale(0.1)"},".hola_preview_duration_container":{"pointer-events":"none",position:"absolute"},".hola_preview_duration":{position:"absolute",color:"#fff","background-color":"rgba(0, 0, 0, 0.7)","line-height":"12px","font-size":"12px",padding:"2px 4px","border-radius":"2px","letter-spacing":"0.5px"},".hola_preview_over_player_elem":{display:"block",position:"absolute",width:"100%",height:"100%",left:"0",top:"0",overflow:"hidden",cursor:"pointer"},".hola_preview_over_player_img":{position:"absolute",width:"100%",height:"100%",left:"0",top:"0"},".hola_preview_over_player_text":{display:"none",position:"absolute",width:"100%",height:"100%",left:"0",top:"0",color:"#fff",padding:"50px 0 0 16px","font-size":"24px"},".hola_preview_playing .hola_preview_over_player_text":{display:"block"},".hola_preview_call_to_action":{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",opacity:"0",transition:"opacity .35s linear"},".hola_preview_text":{position:"absolute",top:"0",left:"0",width:"100%","text-align":"center","margin-top":"12%",color:"#fff","font-weight":"bold","white-space":"nowrap"}};if(util.is_enabled(preview_debug)&&preview_debug.def_styles)assign(def_styles,preview_debug.def_styles);E.video_cache=function(){var cached_videos={};return{get:function(url,opt){return cached_videos[url]||(cached_videos[url]=new CachedVideo(url,opt))},purge:function(url){if(!url){for(var u in cached_videos)this.purge(u)}if(cached_videos[url])cached_videos[url]=cached_videos[url].uninit()},uninit:function(){if(util.is_mocha())this.purge()}}}();function apply_pixel_ratio(url){var ratio=E.pixel_ratio,cur_size;if(ratio==1||!(cur_size=size_from_url(url)))return;var size_util=E.links.size_util;cur_size=size_util.parse(cur_size);var new_size=size_util.serialize({width:cur_size.width*ratio,height:cur_size.height*ratio});return replace_size_in_url(url,new_size)}function apply_styles(opt){var styles=util.clone_deep(def_styles);if(opt.line_loader==LOADER_GROW){styles[".hola_preview_loading .hola_preview_poster"]={transform:"scale(1.1)"}}var loader_style=styles[".hola_preview_loader"];if(opt.line_loader_height){loader_style.height=opt.line_loader_height+"px";loader_style["max-height"]=opt.line_loader_height+"px"}if(opt.line_loader_color)loader_style["background-color"]=opt.line_loader_color;var popup_style=styles[".hola_preview_popup"];if(opt.popup_border_width)popup_style["border-width"]=opt.popup_border_width+"px";if(opt.popup_border_color)popup_style["border-color"]=opt.popup_border_color;if(opt.duration_location){var dur_style=styles[".hola_preview_duration"];var dur_loc=opt.duration_location.split("-");dur_style.margin=(opt.duration_margin||4)+"px";dur_style[dur_loc[0]]="0";dur_style[dur_loc[1]]="0"}if(opt.fade_time){styles[".hola_video_preview.hola_fade_out"]["transition-duration"]=opt.fade_time+"ms"}E.conf.logo_loader_hide_duration=Math.max(get_transition_duration(styles[".hola_preview_loader_hide"],"opacity"),get_transition_duration(styles[".hola_preview_loader_logo svg"],"transform"));var blur=opt.blur;if(blur&&blur.text_margin){styles["span.hola_preview_text.hola_preview_text_top"]={"margin-top":"-"+blur.text_margin};styles["span.hola_preview_text.hola_preview_text_bottom"]={"margin-top":blur.text_margin}}if(E.conf.show_purge_icon||E.conf.debug||E.spark.is_editor_mode)assign(styles,controls.styles);if(opt.transform_css)opt.transform_css(styles);E.styles=util.get_stylesheet(styles);if(blur){var step=function(pos,level){return"    "+pos+"% { filter: blur("+level+"px); }"};var keyframes=blur.keyframes||[step(0,0),step(blur.start,0),step(blur.end,blur.level)];E.styles+="\n@keyframes preview_blur {\n"+keyframes.join("\n")+"\n}"}$("head").append("<style>"+E.styles+"</style>")}function autoload_next(){if(autoload.loading||autoload.paused||autoload.stopped)return;if(!autoload.queue.length)return void(autoload.loading=null);var next=autoload.queue.shift(),video;if(next.has_bytes||(video=next.get_video(true)).loaded||video.error&&!video.conn_error){return void autoload_next()}autoload.loading=video;video.once("ready",function(){if(video.loaded){E.stats.inc_d("autoload_loaded_n");video.autoloaded=true}if(video.conn_error)autoload.queue.push(next);autoload.loading=null;autoload_next()});E.stats.inc("autoload_load_n");video.start()}function force_update_links(opt){var nl=E.links.filter(get_new_links(opt),opt);E.get_previews(nl,opt,function(is_updated){if(!is_updated)return;var _opt=assign({},opt);nl.forEach(function(l){if(l.text_link&&util.is_mobile)return;var p=new Preview(l,_opt);E.stats.add_preview(p);E.previews.add(p);p.init();E.stats.inc("preview_n")});E.emit("has_previews")})}function get_mid_rect(check_x){var opt=E.conf.autoplay||{};var h_percentage=opt.area_height||10;var w_percentage;if(check_x)w_percentage=opt.area_width||10;return dom_util.get_mid_rect(h_percentage,w_percentage)}function get_new_links(opt){return E.links.get(opt).filter(is_new_link.bind(null,opt))}E.get_previews=function(new_links,opt,cb){if(!new_links.length)return void cb();var count=E.stats.inc_d("get_previews_n");if([5,10,20,50].indexOf(count)>-1)E.stats.inc_d("get_previews_over_"+count+"_n");E.stats.inc_d("get_previews_url_n",new_links.length);var _opt=assign({full:opt.debug||opt.ext_info_enabled},opt);var err_handler=function(e){E.stats.inc_d("get_previews_fail_n");var msg=e.message||"unknown";log.info("get_previews error: "+msg);perr({id:"get_previews_error",err:msg});cb(false)};E.links.force_get_db(new_links,_opt,function(res){var data;if(!(data=res&&res.res))return void err_handler(new Error("no links data"));new_links.forEach(function(p){handle_links_db_entry(data[p.url])});E.previews.update();cb(true)})};function get_transition_duration(css,prop){var transition=(css&&css.transition||"all 0s").split(",");for(var i=transition.length-1;i>=0;i--){var prop_value=transition[i].trim();var m=/^(\S*)\s*(\S*)(\s*\S*\s*(\S*))?$/.exec(prop_value);if(m[1]!="all"&&m[1]!=prop)continue;var ret=parseFloat(m[2])*(/ms$/i.test(m[2])?1:sec_ms);if(m[4]){ret+=parseFloat(m[4])*(/ms$/i.test(m[4])?1:sec_ms)}return ret}return 0}function get_url(){var opt=this.opt||{},src=E.previews_map[this.href];if(E.conf.get_preview_url){var p_url=E.conf.get_preview_url({$:$,_this:this,E:E});if(p_url)return p_url}var page_url;if(!src&&this.is_video_url&&(page_url=util.get(this,"link_info.page_url"))){src=E.previews_map[page_url]}var has_url=typeof src=="string"||src&&src.url;if(!has_url||src.info&&src.info.status=="error")return;if(src.error=="not ready")this.not_ready=true;var switch_fast_cdns=E.fast_cdns&&!this.fast_cdns&&!(this.video&&(this.video.headers_received||this.video.loaded));if(!this.cdns||switch_fast_cdns){if(!src.cdns)E.stats.inc_d("no_cdns_n");else if(!src.cdns.length)E.stats.inc_d("no_cdns_empty_n");if(this.cdns)E.stats.inc_d("switch_fast_cdns_n");this.fast_cdns=E.fast_cdns;this.cdns=!src.force_cdns&&this.fast_cdns||(src.cdns&&src.cdns.length?src.cdns:opt.cdn&&[opt.cdn]);if(this.cdns){this.cdns=this.cdns.map(function(c){return util.protocol=="https:"?c.hostname:c.host})}else this.cdns=[src.cdn];if(E.cdn_host&&this.cdns[0]!=E.cdn_host&&!src.force_cdns)this.cdns.unshift(E.cdn_host);this.current_cdn=0;this.cdn_host=E.cdn_host}var cdn_host=this.cdns[this.current_cdn];if(!cdn_host)return;var url=src.url||src;url=util.protocol+"//"+cdn_host+url;if(util.has_ext)return url+(url.indexOf("?")==-1?"?":"&")+"ext=true";return url}function handle_links_db_entry(d){if(!d)return;var url_fail=function(reason){E.stats.inc_d("get_previews_url_fail_n");E.stats.inc_d("get_previews_url_fail_"+reason+"_n")};var video_url=d.full_video_url||d.type=="video"&&d.url,preview;if((d.live||d.db&&d.db.live)&&E.conf.live.enable&&video_url){preview={live:true,url:E.conf.live.endpoint+"?customer="+E.spark.customer+"&url="+encodeURIComponent(video_url)+"&size="+E.conf.live.size+(E.conf.live_no_cache?"&ts="+encodeURIComponent(window.spark_live_cache_seed):"")+"#t=2",cdns:E.conf.live.cdns,force_cdns:true}}else if(!(preview=d.preview)){if(!E.conf.disable_map_cache&&E.storage.get(["previews",d.url])&&E.previews_map[d.url]&&E.previews_map[d.url].from_cache){delete E.previews_map[d.url];E.storage.unset(["previews",d.url]);E.stats.inc_d("map_cache_delete_n")}url_fail("processing");return}if(typeof preview=="string")preview={url:preview};if(preview.error){if(typeof preview.error!="string")url_fail("unknown");else if(preview.error.includes("disconnected agent"))url_fail("disconnected_agent");else if(preview.error.startsWith("Error:"))url_fail("exception");else url_fail(preview.error.replace(/[^a-zA-Z0-9_]/g,"_"));log.info("get_previews error: "+preview.error+" "+d.url)}assign(preview,util.pick(d,"cdn","from_page_links"),map_cache_extra_info(d));if(preview.video_url=video_url)preview.cache_url=E.spark.video2cache(preview.video_url);E.previews_map[d.url]=preview;if(!preview.live)update_preview_url(d.url);if(!E.conf.disable_map_cache){E.storage.set(["previews",d.url],assign({update:Date.now()},util.pick(preview,"url","cdns","cdn","initial_url","force_cdns","live"),map_cache_extra_info(d)))}E.stats.set_ms_since_d("first_ready_from_web_ms");E.stats.set_ms_since_d("first_ready_ms")}function init_autoload(p_list){autoload.previews=p_list;if(autoload.inited){if(p_list)start_autoload();return}if(E.conf.mobile_wifi_only&&util.is_mobile_cellular_con())return void log.info("skip autoload due to mobile cellular network");if(E.conf.preview_streaming&&util.is_safari)return void log.info("skip autoload due to CSP");autoload.inited=true;autoload.queue=[];E.conf.autoload.count=E.conf.autoload.count||E.default_conf.autoload.count;if(E.conf.autoload.scroll_perc===undefined)E.conf.autoload.scroll_perc=E.default_conf.autoload.scroll_perc;E.on("has_previews_db",start_autoload);on_scroll(autoload.onscroll=util.debounce(start_autoload,300));E.on("loading",pause_autoload);if(p_list)start_autoload()}function init_autoplay(opt){var _init_autoplay=function(popular){if(popular&&popular.length)opt.autoplay_videos=(opt.autoplay_videos||[]).concat(popular);if(util.is_mobile&&E.preview_on_touch)return;if(util.is_mobile||opt.autoplay.enable&&(opt.autoplay.type==AUTOPLAY_VIEW||opt.autoplay.type==AUTOPLAY_SELECTOR)||opt.autoplay_videos&&opt.autoplay_videos.length){E.init_autoplay(opt);if(!util.is_mobile)return}var random_enabled=opt.autoplay_interval_enabled||opt.autoplay.enable&&opt.autoplay.type==AUTOPLAY_RANDOM;var random_interval=opt.autoplay_interval||opt.autoplay.random_interval;if(random_enabled&&random_interval)init_random_autoplay(opt)};E.one("has_previews",function(){if(!opt.autoplay_popular.enable)return void _init_autoplay();E.spark_modules.api.get_playlists(["1h","6h","1d"],opt.autoplay_popular.load_count,{plain:"video_info.cache_url",min_views:50},_init_autoplay,_init_autoplay)})}function init_preview_over_player(opt){function detach(player,ctx){if(player&&player.attached_preview_over_player){player.attached_preview_over_player.detach();delete player.attached_preview_over_player;return}if(ctx&&ctx.attached_preview_over_player){ctx.attached_preview_over_player.detach();delete ctx.attached_preview_over_player}}var ctx_attached,players=0;E.spark.players.on("attach",function(player,ctx){ctx_attached=true;if(ctx.attached_preview_over_player||player.controls.is_playing()||player.controls.is_ad_active()){return}ctx.attached_preview_over_player=new PreviewOverPlayer(player);player.controls.once("timeupdate",detach.bind(null,null,ctx));player.controls.once("play",detach.bind(null,null,ctx));player.controls.once("started",detach.bind(null,null,ctx))});E.spark.players.on("add",function(player){if(opt.show_not_attached&&!opt.show_not_attached(player))return;players++;var video_url;if(opt.check_controls_url&&(video_url=player.controls.get_url())){if(!E.spark.is_allowed(player.check_skip_video(video_url)))return void log.info("video_url is not allowed");player.attached_preview_over_player=new PreviewOverPlayer(player,false,video_url);player.controls.once("timeupdate",detach.bind(null,null,player));player.controls.once("play",detach.bind(null,player));player.controls.once("started",detach.bind(null,player));return}function create_instance(){if(ctx_attached||players>1||player.controls.is_playing())return;player.attached_preview_over_player=new PreviewOverPlayer(player,true);player.controls.once("play",detach.bind(null,player));player.controls.once("started",detach.bind(null,player))}setTimeout(function(){if(ctx_attached||players>1||player.controls.is_playing())return;if(E.links.get_page_db()&&E.links.get_page_db().video_url)return create_instance();E.links.once("set_page_info",create_instance)},200)});E.spark.players.on("remove",function(player){detach(player)});E.spark.players.on("detach",detach)}function init_random_autoplay(opt){var autoplay=function(){var main=E.previews.get_group("main");if(main.some(function(p){return p.active&&!p.autoplay}))return;var curr=main.filter(function(p){return p.get_url()&&p.in_viewport(true)});var r=curr[Math.floor(Math.random()*curr.length)];main.for_each(function(p){if(p==r)p.show(null,true);else p.hide()})};var interval=opt.autoplay_interval||opt.autoplay.random_interval;setInterval(autoplay,interval*1e3);autoplay()}function init_visibility_checks(){if(E.off_visibility_checks)return;function update(preview){var previews=preview?[preview]:E.previews.get_all();previews.filter(function(p){return p.get_url()}).forEach(function(p){var in_viewport=!!p.in_viewport(true);if(!!p.visible==in_viewport)return;p.visible=in_viewport;p.emit(in_viewport?"visible":"hidden")})}var update_all=update.bind(null,null);E.off_visibility_checks=on_page_update(util.debounce(update_all,100),3e3);E.on("try_activate",update)}function is_new_link(opt,l){if(l.no_video||l.current)return false;if(!l.force_video){if(l.root)return false;var href=$(l.link).attr("href");if(href&&href[0]=="#"&&!opt.href_keep_hash)return false}if($(l.link).hasClass("hola_preview_poster"))return false;if($(l.link).attr("spark_preview_manual"))return false;return!$(l.link).prop("hola-video-preview-id")}function is_video_playing(){return E.spark.players.find(function(pl){var p;if(!(p=pl.controls)||!(p.is_ad_active()&&(p.is_ad_playing()||p.is_ad_loading())||p.is_playing())){return}var c=pl.container,rect=c.getBoundingClientRect();return dom_util.in_rect(rect,dom_util.visual_viewport())})}function mouse_in_parent(el,ev){if(!ev||ev.reused)return;if(ev.currentTarget==el||ev.srcElement==el)return true;if(!ev.srcElement)return;return $(ev.srcElement).parents().filter(el).length}function mouse_within(el,ev){if(ev&&ev.type=="mousemove")return dom_util.pointer_within(el,ev)}function map_cache_extra_info(obj){var ret={},_modal_box=E.conf.modal_box||{};if(_modal_box.enable){assign(ret,util.pick(obj,"video_size","video_nat_size","description","video_title"));if(_modal_box.use_frame_url)ret.frame_url=obj.frame_url}return ret}function map_cache_has_extra_info(obj){var _modal_box=E.conf.modal_box||{};if(!_modal_box.enable)return true;if(!obj.video_size&&!obj.video_nat_size||!obj.description&&!obj.video_title){return false}if(_modal_box.use_frame_url&&!obj.frame_url)return false;return true}function no_object_fit(){return util.is_ie||util.is_edge&&util.browser.version<16}function object_fit_css(v){var video_ratio=v.videoWidth/v.videoHeight;var el_ratio=v.width/v.height;var new_width,new_height;if(video_ratio>el_ratio){new_width=v.height*video_ratio;new_height=v.height}else{new_width=v.width;new_height=v.width/video_ratio}return{width:Math.round(new_width)+"px",height:Math.round(new_height)+"px",marginTop:Math.round((v.height-new_height)/2)+"px",marginLeft:Math.round((v.width-new_width)/2)+"px"}}function on_page_update(cb,interval){on_scroll(cb);E.on("has_previews_db",cb);E.on("preview_attr_update",cb);var int;if(interval)int=setInterval(cb,interval);cb();return function(){E.off("scroll",cb);E.off("has_previews_db",cb);E.off("preview_attr_update",cb);clearInterval(int)}}function on_scroll(cb){E.on("scroll",cb);if(E.scroll_listener)return;E.scroll_listener=function(){E.emit("scroll")};if(util.is_mobile)$(window).on("orientationchange",E.scroll_listener);var pos={};var scroll_el=document.documentElement||document.body.parentNode||document.body;$(window).on("scroll",function(){var top=window.pageYOffset!==undefined?window.pageYOffset:scroll_el.scrollTop;var left=window.pageXOffset!==undefined?window.pageXOffset:scroll_el.scrollLeft;if(pos.top==top&&pos.left==left)return;pos={top:top,left:left};E.scroll_listener()});if(!window.visualViewport)return;window.visualViewport.addEventListener("scroll",E.scroll_listener);window.visualViewport.addEventListener("resize",E.scroll_listener)}function pause_autoload(preview,opt){opt=opt||{};var ctx=opt.ctx||autoload,cb=opt.cb||autoload_next;var name=opt.name||"autoload";if(ctx.paused||ctx.loading&&ctx.loading==preview.video)return;ctx.paused=true;var resume_autoload=function(){preview.off("played",resume_autoload);preview.off("hide",resume_autoload);preview.off("error",resume_autoload);if(ctx.loading||ctx.queue.length)E.stats.inc_d(name+"_resume_n");ctx.paused=false;cb()};preview.on("played",resume_autoload);preview.on("hide",resume_autoload);preview.on("error",resume_autoload);if(ctx.loading)E.stats.inc_d(name+"_pause_n")}var sent_autoplay_perr;function play(video,preview){var p=video.play();if(!p||!p.catch)return p;E.stats.inc_d("play_promise_n");p.catch(function(e){e=e.message||""+e;E.stats.inc_d("play_promise_error_n");var fail;if(/initiated by a user|user didn't interact|user denied permission/.test(e)){fail="gesture_needed";if(E.can_autoplay){perr({id:"preview_can_mismatch_not_allowed",throttle:1,info:{can_autoplay:E.can_autoplay}});E.stats.inc("can_mismatch_not_allowed_n")}E.gesture_needed=true;preview.hide({force:true});stop_autoload()}else if(/interrupted by a call to pause/.test(e))fail="interrupted_pause";else if(/no supported source/.test(e))fail="unsupported";else fail="unknown";if(E.conf.detailed_stats)E.stats.inc_d("play_promise_error_"+fail+"_n");if(sent_autoplay_perr)return;sent_autoplay_perr=true;perr({id:"preview_play_promise_error",info:{fail:fail,details:e}})});return p}function pick_preview_size(url){var sizes,cur_size;if(!(sizes=E.conf.available_sizes)||!(cur_size=size_from_url(url)))return;var new_size;if(E.conf.compare_by_width)new_size=E.links.size_util.find_bigger_by_width(cur_size,sizes);else new_size=E.links.size_util.find_bigger(cur_size,sizes);return replace_size_in_url(url,new_size)}function replace_size_in_url(url,new_size){return url.replace(/&size=\d{1,4}x\d{1,4}/,"&size="+new_size)}function size_from_url(url){var size=/&size=(\d{1,4}x\d{1,4})/.exec(url);return size&&size[1]}function start_autoload(){if(autoload.stopped)return;var p_list=autoload.previews||E.previews.get_group("main").get_all();var scroll=E.conf.autoload.scroll_perc/100;var scroll_offset=window.innerHeight+window.pageYOffset;var queue=p_list.filter(function(p){if(!p.get_url()||p.video&&(p.video.loaded||p.video.active||p.video.error&&!p.video.conn_error)){return}p.autoload_offset=$(p.el).offset();return autoload.previews||scroll_offset/p.autoload_offset.top>=scroll}).sort(function(p1,p2){var o1=p1.autoload_offset,o2=p2.autoload_offset;return o1.top-o2.top||o1.left-o2.left});p_list.forEach(function(p){delete p.autoload_offset});var first_in=queue.findIndex(function(p){return p.in_viewport()});if(first_in>-1)queue.splice(0,first_in);var urls=[];autoload.queue=queue.filter(function(p){p.update_size();var url=p.get_url();if(urls.includes(url))return false;urls.push(url);return true}).slice(0,E.conf.autoload.count);autoload_next()}function stats_init(){E.stats=E.spark_modules.stats;E.stats.add_preview=function(preview){var id=preview.get_id();preview.on("hover",this.try_wrapper(this.hover,id));preview.on("unhover",this.try_wrapper(this.unhover,id));preview.on("loaded",this.try_wrapper(this.loaded,id));preview.on("played",this.try_wrapper(this.played,id));preview.on("autoplay",this.try_wrapper(this.autoplay,id));preview.on("countdown_show",this.try_wrapper(this.countdown_show,id));preview.on("countdown_cancel",this.try_wrapper(this.countdown_cancel,id));preview.on("navigate",this.try_wrapper(this.navigate,id));preview.on("link_click",this.try_wrapper(this.click,id));preview.on("hide",this.try_wrapper(this.autoplay_end,id));preview.on("link_click",this.try_wrapper(this.autoplay_end,id));preview.on("visible",this.try_wrapper(this.visible,id));this.data[id]={hover:{},autoplay:{},preview:preview,visible_cnt:0,played:0}};E.stats.mod_init=function(reset){this.init(reset);if(reset){this.data.forEach(function(ctx){assign(ctx,{hover:{},autoplay:{}})})}else this.data=[];this.total_hover_ms=0;this.total_load_ms=0;this.total_cache_load_ms=0;this.total_play_ms=0;this.total_autoplay_ms=0;this.played_hover_ms=0;this.played_load_ms=this.played_load_n=0;this.auto_played_load_ms=this.auto_played_load_n=0;this.loaded_not_played_hover_ms=this.loaded_not_played_hover_n=0;this.ttfb={}};E.stats.get_stats=function(){var _this=this;this.data.forEach(function(p,id){_this.unhover(id)});this.set_avg("hover_ms",this.total_hover_ms,"hover_n");this.set_avg("load_ms",this.total_load_ms,(this.get("loaded_n")||0)+(this.get("loaded_nosize_n")||0));this.set_avg_d("cache_load_ms",this.total_cache_load_ms,"cache_loaded_n");this.set_avg_d("play_ms",this.total_play_ms,"played_n");this.set_avg_d("autoplay_play_ms",this.total_autoplay_ms,"played_n");this.set_avg_d("played_hover_ms",this.played_hover_ms,"played_n");this.set_avg_d("played_load_ms",this.played_load_ms,this.played_load_n);this.set_avg_d("autoplay_played_load_ms",this.auto_played_load_ms,this.auto_played_load_n);this.set_avg_d("loaded_not_played_hover_ms",this.loaded_not_played_hover_ms,this.loaded_not_played_hover_n);for(var k in this.ttfb)this.set_avg_d("ttfb_"+k+"_ms",this.ttfb[k],"ttfb_"+k+"_n");this.get_performance_stats();return this.o};E.stats.hover=function(id){var ctx=this.data[id];if(ctx.hover.active)return;ctx.hover={active:true,start:util.date_monotonic()};if(!ctx.load_start)ctx.load_start=ctx.hover.start};E.stats.autoplay=function(id){var ctx=this.data[id];if(ctx.autoplay.active)return;ctx.autoplay={active:true,start:util.date_monotonic()};if(!ctx.load_start)ctx.load_start=ctx.autoplay.start};E.stats.inc_frequent_d=function(s){this.inc_d(s,1,false,true)};E.stats.inc_frequent=function(s){this.inc(s,1,false,true)};E.stats.unhover=function(id){var ctx=this.data[id],hover=ctx.hover;if(!hover.active)return;hover.active=false;hover.end=util.date_monotonic();var hover_time=hover.end-hover.start;var is_live=util.get(ctx,"preview.is_live");if(hover.played){var played_ms=hover.end-hover.play_start;this.total_play_ms+=played_ms;this.played_hover_ms+=hover.play_start-hover.start;this.inc("played_n");if(is_live)this.inc("live_played_n");E.spark.set_event("preview_played",{played_ms:Math.round(played_ms),link:ctx.preview.href,is_organic:!ctx.preview.is_link_by_spark,is_autoplay:false},ctx.preview.el);if(played_ms>500)this.inc_d("played_over_500ms");if(played_ms>1e3)this.inc_d("played_over_1sec");if(hover_time>500)this.inc_d("played_hover_over_500ms_n");if(ctx.load_start==hover.start){this.inc("unique_played_n");this.played_load_ms+=ctx.load_ms||0;this.played_load_n++}}else if(ctx.preview.get_url()){this.inc_frequent_d("not_played_n");if(hover_time>500)this.inc_d("not_played_hover_over_500ms_n")}if(ctx.loaded&&!hover.played){this.loaded_not_played_hover_ms+=hover_time;this.loaded_not_played_hover_n++}this.inc_frequent("hover_n");if(is_live)this.inc_frequent("live_hover_n");if(hover_time>500)this.inc_d("hover_over_500ms_n");this.total_hover_ms+=hover_time;if(ctx.loaded)return;delete ctx.load_start;if(hover_time<300)this.inc_frequent_d("hover_under_300ms_n");else if(hover_time<500)this.inc_frequent_d("hover_under_500ms_n")};E.stats.loaded=function(id,opt){var ctx=this.data[id];if(ctx.loaded)return;if(!ctx.load_start){this.inc_d(ctx.hover.start?"loaded_after_unhover_n":"loaded_before_hover_n");return}ctx.loaded=true;ctx.load_ms=util.date_monotonic()-ctx.load_start;if(ctx.load_ms>2*min_ms)return;opt=opt||{};if(opt.from_cache){this.total_cache_load_ms+=ctx.load_ms;this.inc_d("cache_loaded_n");this.inc_d("cache_loaded_bytes",opt.size)}else{this.total_load_ms+=ctx.load_ms;if(opt.size){this.inc("loaded_n");this.inc_d("loaded_bytes",opt.size);if(util.get(ctx,"preview.is_live"))this.inc("live_loaded_n")}else this.inc("loaded_nosize_n")}if(!ctx.hover.active)this.inc_d("loaded_after_unhover_n")};E.stats.played=function(id){var ctx=this.data[id];[ctx.hover,ctx.autoplay].find(function(method){if(method.active&&!method.played){method.played=true;method.play_start=util.date_monotonic();E.spark.set_event("preview_play",{link:ctx.preview.href,is_organic:!ctx.preview.is_link_by_spark,is_autoplay:method==ctx.autoplay},ctx.preview.el);return true}});ctx.played++};E.stats.autoplay_end=function(id){var ctx=this.data[id],autoplay=ctx.autoplay;if(!autoplay.active)return;autoplay.active=false;autoplay.end=util.date_monotonic();if(autoplay.played){var played_ms=autoplay.end-autoplay.play_start;this.total_autoplay_ms+=played_ms;if(played_ms>500)this.inc_d("autoplay_played_over_500ms");if(played_ms>1e3)this.inc_d("autoplay_played_over_1sec");if(ctx.load_start==autoplay.start){this.inc("autoplay_unique_played_n");this.auto_played_load_ms+=ctx.load_ms||0;this.auto_played_load_n++}E.spark.set_event("preview_played",{played_ms:Math.round(played_ms),link:ctx.preview.href,is_organic:!ctx.preview.is_link_by_spark,is_autoplay:true},ctx.preview.el)}};E.stats.click=function(id){var ctx=this.data[id],hover=ctx.hover,autoplay=ctx.autoplay;if(hover.click||hover.navigate)return;var method=hover.played?hover:autoplay.played?autoplay:hover;hover.click=true;var played_ms=method.played?util.date_monotonic()-method.play_start:0;E.spark.set_event("preview_click",{link:ctx.preview.href,played:ctx.played,played_ms:Math.round(played_ms),is_organic:!ctx.preview.is_link_by_spark,is_autoclick:false,is_autoplay:method==autoplay,playing:method.played},ctx.preview.el);var name="click_"+(method.played?"on_playing":ctx.preview.get_url()?"not_playing":"no_mapping");this.inc(name+"_n");if(util.date_monotonic()-hover.start>500)this.inc_d(name+"_hover_over_500ms_n");if(!method.played&&ctx.played)this.inc("click_played_n")};E.stats.navigate=function(id){var ctx=this.data[id],_this=this;
[ctx.hover,ctx.autoplay].find(function(method){if(method.active&&!method.navigate&&!method.click){method.navigate=true;_this.inc("auto_click_on_playing_n");return true}})};E.stats.countdown_show=function(id){var stats=this.data[id].hover;if(!stats.active||stats.countdown_show)return;stats.countdown_show=true;this.inc_d("countdown_show_n")};E.stats.countdown_cancel=function(id){var stats=this.data[id].hover;if(!stats.active||stats.countdown_cancel)return;stats.countdown_cancel=true;this.inc_d("countdown_cancel_n")};E.stats.visible=function(id){var ctx=this.data[id];this.inc_frequent_d("thumb_visible_"+(ctx.visible_cnt++?"again_":"")+"n");E.spark.set_event("preview_visible",{link:ctx.preview.href,is_organic:!ctx.preview.is_link_by_spark,count:ctx.visible_cnt},ctx.preview.el)};E.stats.set_ttfb=function(s,ms){if(ms>2*min_ms)return;this.ttfb[s]=(this.ttfb[s]||0)+ms;this.inc_d("ttfb_"+s+"_n")};E.stats.get_performance_stats=function(){if(!E.conf.detailed_stats||!window||!window.performance||!window.performance.getEntries){return}var entries=window.performance.getEntries(),ret={};var push=function(key,value){if(value<0||value>2*min_ms)return;if(!ret[key])ret[key]=[];ret[key].push(value)};for(var i=this.performance_count||0;i<entries.length;i++){var e=entries[i];if(!/preview\.mp4\?customer=/.test(e.name))continue;push("connect",e.connectEnd-e.connectStart);push("dns",e.domainLookupEnd-e.domainLookupStart);push("duration",e.duration);push("redirect",e.redirectEnd-e.redirectStart);push("response",e.responseEnd-e.responseStart)}this.performance_count=entries.length;for(var key in ret){this.set_d("perf_"+key+"_ms",Math.round(ret[key].reduce(function(agg,v){return agg+v})/ret[key].length))}};E.stats.try_wrapper=function(func,arg){return perr.try_wrapper({prefix:"preview_stats"},func.bind(this,arg))};E.stats.mod_init()}function stop_autoload(){autoload.stopped=true;autoload.queue=[];if(!autoload.onscroll)return;E.off("scroll",autoload.onscroll);autoload.onscroll=null;E.off("has_previews_db",start_autoload);E.off("loading",pause_autoload)}function toggle_info_popup(ev,el,ref_container){var info_popup;if(info_popup=toggle_info_popup.info_popup){var popped=info_popup.popped;info_popup=info_popup.uninit();if(popped){ev.stopPropagation();ev.preventDefault();return}}toggle_info_popup.info_popup=widget_info.powered_by(E,{el:el,module_id:module_id,in_parent:true,ref_container:ref_container});toggle_info_popup.info_popup.info_show(ev)}function update_links(opt,links){var nl;if(links&&E.conf.avoid_links_rescan)nl=links.filter(is_new_link.bind(null,opt));else nl=get_new_links(opt);nl=E.links.filter(nl,opt);if(!nl.length)return;var used_cache;nl.forEach(function(l){if(l.text_link&&util.is_mobile)return;var p=new Preview(l,opt),cache;E.stats.add_preview(p);E.previews.add(p);p.init();E.stats.inc("preview_n");if(E.conf.disable_map_cache||!(cache=E.storage.get(["previews",p.href]))||!map_cache_has_extra_info(cache)){return}E.previews_map[p.href]=assign({},cache,{from_cache:true});if(E.conf.check_lazy_img_load)p.update_size(l);else update_preview_url(p.href);p.update();E.stats.set_ms_since_d("first_ready_from_cache_ms");E.stats.set_ms_since_d("first_ready_ms");E.stats.inc_d("map_cache_use_n");used_cache=true});E.emit("has_previews");if(used_cache)E.emit("has_previews_db")}function update_links_db(opt,links){(links||E.links.get_db(null,opt)).forEach(function(d){if(!d.db)return;handle_links_db_entry(d)});E.previews.update();E.storage.sync();E.emit("has_previews_db")}function update_preview_url(href){var preview,url;if(!(preview=E.previews_map[href])||!(url=preview.initial_url||preview.url)){return}preview.initial_url=url;url=apply_pixel_ratio(url)||url;url=pick_preview_size(url)||url;if(E.conf.transform_preview_url)url=E.conf.transform_preview_url(url)||url;preview.url=url}function within(outer,inner){var o=outer.getBoundingClientRect();var i=inner.getBoundingClientRect();return i.left>=o.left&&i.top>=o.top&&i.right<=o.right&&i.bottom<=o.bottom}util.inherits(CachedVideo,events.EventEmitter);function CachedVideo(url,opt){this.url=url;this.progress=0;this.loaded=this.active=false;this.ready=!!opt.ready;this.rep_req_delay=REP_REQ_DELAY;if(!opt.skip_preload)this.start()}CachedVideo.prototype.start=function(){if(this.active)return;this.active=true;if(!this.url||!this.url.startsWith("http"))return void setTimeout(this.onerror.bind(this,"wrong_url"),0);this.conn_error=false;var xhr=new XMLHttpRequest;xhr.onprogress=this.onprogress.bind(this);xhr.onload=this.onload.bind(this);xhr.onerror=this.onerror.bind(this,"fetch_error");xhr.open("GET",this.url,true);xhr.responseType="blob";xhr.send();this.start_ts=Date.now()};CachedVideo.prototype.set_ready=function(error){if(this.ready=!error)delete this.error;this.emit("ready");this.active=false;this.ttfb_stat()};CachedVideo.prototype.onload=function(event){var _this=this,xhr=event&&event.target;if(xhr&&xhr.status!=200){var reader=new FileReader;reader.onload=function(){E.stats.inc_d("xhr_status_"+xhr.status+"_n");if(xhr.status==404&&!_this.unique_status_reported){E.stats.inc("xhr_status_404_unique_n");_this.unique_status_reported=true}var conn_error=_this.conn_error=[503,205].includes(xhr.status);_this.onerror(reader.result[0]=="{"?JSON.parse(reader.result):{status:"error",error:reader.result});if(conn_error)_this.emit("conn_error",xhr.status)};return void reader.readAsText(xhr.response)}if(xhr&&URL&&URL.createObjectURL)this.result=URL.createObjectURL(xhr.response);this.from_cache=this.completed().from_cache;this.loaded_size=util.get(xhr,"response.size",0);this.loaded=true;this.emit("loaded");this.set_ready()};CachedVideo.prototype.onprogress=function(event){this.ttfb_ts=this.ttfb_ts||Date.now();var xhr=event&&event.target;if(!xhr||xhr.readyState<2||xhr.status!=200)return;this.headers_received=true;this.progress=event.loaded/event.total;this.emit("progress")};CachedVideo.prototype.completed=function(){CachedVideo.load_cnt[this.url]=(CachedVideo.load_cnt[this.url]||0)+1;return{from_cache:CachedVideo.load_cnt[this.url]>1}};CachedVideo.prototype.onerror=function(error){var internal=typeof error=="string";var conn_error=error=="fetch_error";this.conn_error=this.conn_error||conn_error;this.error=internal?{error:error}:error;this.set_ready(this.error);if(!internal&&error.status&&this.ext_info_enabled)setTimeout(this.start.bind(this),this.rep_req_delay*sec_ms);if(conn_error)this.emit("conn_error",error)};CachedVideo.prototype.enable_ext_info=function(){this.ext_info_enabled=true;this.rep_req_delay=1;this.start()};CachedVideo.prototype.disable_ext_info=function(){this.ext_info_enabled=false;this.rep_req_delay=REP_REQ_DELAY};CachedVideo.prototype.get_src=function(){return this.result||this.url};CachedVideo.prototype.ttfb_stat=function(){if(!E.conf.detailed_stats||!this.start_ts||!this.ttfb_ts)return;E.stats.set_ttfb("xhr_"+(this.error?"error":"success"),this.ttfb_ts-this.start_ts);this.start_ts=null;this.ttfb_ts=null};CachedVideo.prototype.uninit=function(){this.ttfb_stat();if(this.result&&URL.revokeObjectURL)URL.revokeObjectURL(this.result);this.result=undefined};CachedVideo.load_cnt={};function Duration(preview,opt){this.preview=preview;this.opt=assign({},this.preview.opt,opt);E.links.on("update_db",this.update.bind(this));preview.on("hover",this.hover.bind(this));preview.on("unhover",this.unhover.bind(this));this.update()}Duration.prototype.update=function(){this.duration=E.links.get_db([{url:this.preview.href}])[0].duration;if(this.duration&&isFinite(this.duration))this.show();else this.hide()};var sent_not_img_perr;Duration.prototype.show=function(){if(this.elem||this.off_img_load)return;var img=$(this.preview.img)[0],_this=this;if(img.tagName!="IMG"){if(!sent_not_img_perr)perr({id:"preview_img_not_img",info:{tag_name:img.tagName}});sent_not_img_perr=true}else if(!dom_util.is_img_loaded(img)){this.off_img_load=dom_util.on_img_load(img,function(){_this.off_img_load=null;_this.show()});return}var text=util.date_ms_to_dur(this.duration*1e3).replace(/^00:/,"");var pos=this.preview.get_position(true);if(pos.width<(this.opt.duration_min_width||160))return;var elem=$("<div class=hola_preview_duration_container>"+"<div class=hola_preview_duration>"+text+"</div></div>");elem.css({top:pos.top+"px",left:pos.left+"px",width:pos.width+"px",height:pos.height+"px",transform:pos.transform});var outer_container;if(outer_container=this.preview.create_relative_container()){$(img).after(outer_container);$(outer_container).append(elem);elem.css({top:0,left:0});elem=$(outer_container)}else $(img).after(elem);this.elem=elem};Duration.prototype.hide=function(){if(!this.elem)return;if(this.off_img_load)this.off_img_load();this.off_img_load=null;this.elem.remove();this.elem=null};Duration.prototype.hover=function(){if(this.elem)$(this.elem).css("display","none")};Duration.prototype.unhover=function(){if(this.elem)$(this.elem).css("display","")};function PreviewOverPlayer(player,use_top_url,video_url){this.opt=E.conf.preview_over_player;this.player=player;if(typeof this.opt.get_container=="function")this.container=this.opt.get_container($,this.player.container);else this.container=$(this.player.container);this.container.addClass("hola_preview_over_player");this.elem=$("<div/>").attr("class","hola_preview_over_player_elem").attr("data-spark_feature","preview_over_player").attr("data-spark_preview_link","");if(use_top_url)this.elem.attr("data-spark_preview_page_url",E.spark.top_url);else this.elem.attr("data-spark_preview_video_url",player.url||video_url);this.img=$("<div/>").attr("class","hola_preview_over_player_img").attr("data-spark_preview_img","").appendTo(this.elem);var text=$("<div/>").addClass("hola_preview_over_player_text hola_top_element").text(t("preview_text_over_player")).appendTo(this.elem);this.insert_elem();this.elem.on("mousedown",player.controls.play.bind(player.controls));if(this.opt.text_styles)text.css(this.opt.text_styles);if(this.opt.elem_styles)this.elem.css(this.opt.elem_styles);if(this.opt.img_styles)this.img.css(this.opt.img_styles);E.links.scan()}PreviewOverPlayer.prototype.insert_elem=function(){var fn;if(fn=this.opt.insert_to_func){if(typeof fn=="string")fn=new Function("$","elem","video",this.opt.insert_to_func);return fn($,this.elem,this.player.html5)}var insert_after_sel=".vjs-poster, .jw-preview";if(this.opt.insert_after_sel)insert_after_sel=this.opt.insert_after_sel;var insert_after=this.container.find(insert_after_sel).first();if(!insert_after.length)insert_after=this.player.html5;this.elem.css("z-index",$(insert_after).css("z-index"));this.elem.insertAfter(insert_after)};PreviewOverPlayer.prototype.detach=function(){this.container.removeClass("hola_preview_over_player");if(this.elem)this.elem.remove()};PreviewOverPlayer.get_player=function(el){return E.spark.players.find(function(p){if(!p.attached&&!E.conf.preview_over_player.navigate_not_attached)return;var preview=p.attached&&p.attached.attached_preview_over_player||p.attached_preview_over_player;return preview&&preview.container.is(el)})};function PreviewsController(){this.groups={}}PreviewsController.prototype.add=function(preview){var group_name=$(preview.el).data("hola_preview_group")||"main";var group=this.get_group(group_name);preview.group=group;group.add(preview)};PreviewsController.prototype.update=function(){Object.values(this.groups).forEach(function(g){g.update()})};PreviewsController.prototype.get_all=function(){return Object.values(this.groups).reduce(function(all,g){return all.concat(g.get_all())},[])};PreviewsController.prototype.destroy=function(elements){Object.values(this.groups).forEach(function(g){g.destroy(elements)})};PreviewsController.prototype.get_group=function(name){var group=this.groups[name];if(!group){group=new PreviewsGroup;this.groups[name]=group}return this.groups[name]};PreviewsController.prototype.uninit_group=function(name){this.groups[name].destroy();delete this.groups[name]};function PreviewsGroup(){this.previews=[]}PreviewsGroup.prototype.add=function(preview){this.previews.push(preview)};PreviewsGroup.prototype.update=function(){this.previews.forEach(function(p){p.update()})};PreviewsGroup.prototype.destroy=function(elements){this.previews=this.previews.filter(function(p){if(elements&&!elements.includes(p.el))return true;p.destroy()})};PreviewsGroup.prototype.filter=function(func){return this.previews.filter(func)};PreviewsGroup.prototype.some=function(func){return this.previews.some(func)};PreviewsGroup.prototype.for_each=function(func){this.previews.forEach(func)};PreviewsGroup.prototype.find=function(element){return this.previews.find(function(p){return p.el==element})};PreviewsGroup.prototype.get_all=function(){return this.previews};function Preview(link,opt){this.group=null;this.opt=assign({},opt);var el=this.el=link.link,$el=$(el);this.keep_playing=!!el.getAttribute("data-spark_keep_playing");this.link=el.tagName=="A"?el:link.links&&link.links[0]||el;this.link_info=link;this.links=link.links;this.unite=link.unite;this.href=E.links.get_href(el,opt);this.is_video_url=!!link.video_url;this.lazy_img_load=E.conf.check_lazy_img_load&&(!link.size||E.links.size_util.calc(link.size)<E.conf.check_lazy_img_load);var no_poster=link.by_spark&&!link.poster;this.opt.first_frame=no_poster&&link.by_spark!="preview_over_player";if(no_poster)this.opt.fade_time=0;this.use_autoplay=!util.is_safari&&!this.opt.first_frame&&!opt.preview_streaming;this.streaming_cache=util.is_safari&&opt.preview_streaming&&opt.streaming_cache*sec_ms;this.active=false;this.has_info=false;this.uniq_id=++uniq_id;if(this.is_playlist_link=["playlist","widget"].includes(link.by_spark)){this.is_playlist_slide_tile=$el.is(".hola_playlist_slide "+".hola_playlist_tile");this.is_playlist_slide_link=$el.hasClass("hola_playlist_stile");this.is_playlist_panel_link=$el.hasClass("hola_playlist_ptile");if(this.opt.blur&&this.opt.blur.disable_on_playlist)this.opt.blur=false}if(this.is_playlist_panel_link&&!this.opt.disable_slide_opt&&this.opt.line_loader==LOADER_FADE&&(!this.opt.icon_loader_location||this.opt.icon_loader_location=="top-right")){this.opt.icon_loader_location="top-left"}this.is_watch_later_link=link.by_spark=="watch_later";this.is_preview_over_player_link=link.by_spark=="preview_over_player";this.is_link_by_spark=link.by_spark;this.try_fallback_agent=!!opt.preview_streaming||this.opt.line_loader==LOADER_GROW;this.video_status=[];this.video_start=[];this.img=link.img;this.click_pass_through=E.conf.click_pass_through&&!$(this.img).parent().closest(this.el).length;this.text_link=link.text_link;this.description=link.description;this.ignore_autoplay=util.is_mobile&&this.is_playlist_panel_link;this.no_hover_control=$el.data("hola_preview_no_hover_control");this.no_countdown=$el.data("hola_preview_no_countdown");if(!this.text_link)this.loader=new Loader(this);if(!this.is_playlist_link){if(this.opt.icon_location&&!this.text_link)this.icon=E.play_icon(this);if(this.opt.duration_location&&!this.text_link)this.duration=new Duration(this);this.add_info_menu()}this.preroll=new Preroll(this,this.opt.preroll);if($el.data("hola_preview_no_icon"))this.parent_el().addClass("hola_preview_no_icon");if(this.opt.on_init)this.opt.on_init({$:$,E:E,_this:this});if(this.keep_playing){E.keep_playing_preview=this;setTimeout(function(){this.show()}.bind(this),400)}}util.inherits(Preview,events.EventEmitter);Preview.prototype.add_info_menu=function(){if(!E.conf.show_info_popup||util.is_mobile||!util.is_enabled(widget_info)){return}var _this=this;this.on_contextmenu=function(e){if(_this.played_n)toggle_info_popup(e,_this.el,_this.container)};$(this.el).on("contextmenu",this.on_contextmenu)};Preview.prototype.add_text=function(text){var $container=$(this.container),line_height=$container.height()+"px";var description=this.description;var font_el=$(this.link).find("*").get().filter(function(x){return x.innerText==description});var font;if(font_el=font_el.pop())font=$(font_el).css("font");var font_size,max_font_size=Math.ceil($container.width()/15),m;if(font_el&&(m=$(font_el).css("font-size").match(/^(\d+)px$/))&&m[1]){font_size=Math.min(+m[1],max_font_size)}else font_size=max_font_size;var add=function(key){if(!text[key])return;var span=$('<span class="hola_preview_text hola_preview_text_'+key+'"></span>');span.text(text[key]);if(font)span.css("font",font);span.css({"line-height":line_height,"font-size":font_size+"px"});if(text.append)$container.append(span);else $container.after(span)};add("top");add("bottom")};Preview.prototype.call_to_action=function(opt){var $container=$(this.container);var bg=$('<div class="hola_preview_call_to_action"></div>');bg.css("background","rgba(0,0,0,"+opt.opacity/100+")");$container.after(bg);setTimeout(function(){bg.css("opacity",1)});var text=$('<span class="hola_preview_text"></span>');text.text(opt.text);text.css("line-height",$container.height()+"px");bg.append(text);this.call_to_action_elem=bg};Preview.prototype.countdown_cancel=function(){this.emit("countdown_cancel");if(this.rm_navigate)this.rm_navigate=clearTimeout(this.rm_navigate)};Preview.prototype.countdown_show=function(){var opt=this.opt.preview_over_player;if(this.is_preview_over_player_link&&(E.can_autoplay==false||opt.disable_navigate||E.can_autoplay=="muted"&&!opt.navigate_muted)||this.no_navigate()){return}if(!this.opt.countdown_on_hover)return this.navigate();if(this.countdown||!this.countdown_enabled&&!this.opt.icon_location)return;this.emit("countdown_show");opt={icon_location:"center"};if(this.countdown_enabled){assign(opt,{icon_countdown:true,visibility_check_icon:true,on_navigate:this.navigate.bind(this),on_countdown_cancel:this.countdown_cancel.bind(this)})}this.countdown=E.play_icon(this,opt);var parent=this.parent_el();parent.addClass("hola_preview_countdown")};Preview.prototype.create_elements=function(){if(this.video_el)return;var pos=this.get_position();var container=this.container=document.createElement("div");var outer_container;if(outer_container=this.outer_container=this.create_relative_container()){outer_container.appendChild(container);pos.top=pos.left=0}container.hola_preview=this;this.popup=pos.popup;$(container).addClass("hola_preview_container hola_top_element");$(container).css({top:pos.top+"px",left:pos.left+"px",width:pos.width+"px",height:pos.height+"px",transform:pos.transform});if(E.conf.on_create_el)E.conf.on_create_el({E:E,$:$,pos:pos,container:container});if(this.click_pass_through)$(container).css("pointer-events","none");var v=this.create_video_el(pos.width,pos.height);if(util.is_safari&&E.conf.safari_fix_size_bug>0){clearTimeout(this.safari_fix_size_bug_timer);$(v).css("opacity","0.01");$(v).css("z-index","-1");this.safari_fix_size_bug_timer=setTimeout(function(){$(v).css("opacity","");$(v).css("z-index","")},E.conf.safari_fix_size_bug)}var poster,canvas;if(!this.text_link){poster=$(this.img).clone();if(this.img[0]&&this.img[0].currentSrc)poster.attr("src",this.img[0].currentSrc);try{if(E.spark.customer=="ard_de"&&util.is_mobile)poster[0].style.setProperty("opacity","0","important")}catch(err){}poster.css("visibility","");poster.addClass("hola_preview_poster")}if(this.opt.fade_time){canvas=$("<canvas class=hola_preview_background></canvas>");canvas.css({width:pos.width+"px",height:pos.height+"px"});this.canvas=canvas[0]}if(pos.popup){$(container).addClass("hola_preview_popup");if(this.text_link){$(container).addClass("hola_preview_text_link_popup");$(container).append("<div class=hola_popup_arrow_border></div>");$(container).append("<div class=hola_popup_arrow></div>")}setTimeout(function(){$(container).addClass("hola_preview_popup_visible")},100);var link=document.createElement("a");$(link).attr({href:this.href,spark_ve_preview:"none"});if(canvas)$(link).append(canvas);link.appendChild(v);if(poster)$(link).append(poster);if(!this.text_link&&this.description){$(link).append('<div class="hola_preview_title hola_top_element">'+this.description+"</div>")}container.appendChild(link)}else{$(poster).css({width:($(this.img)[0].clientWidth||$(this.img).width())+"px",height:($(this.img)[0].clientHeight||$(this.img).height())+"px"});if(canvas)$(container).append(canvas);container.appendChild(v);$(container).append(poster)}if(outer_container)container=outer_container;if(E.watermark)E.watermark.apply({v:v,container:container});var _attach=this.opt.custom_attach&&this.opt.custom_attach.attach;if(E.conf.fix_poster){E.conf.fix_poster($,{_this:this,E:E,poster:poster,container:container,img:this.img})}if(_attach&&_attach(this,$));else if(pos.popup)$(document.body).append(container);else if(this.opt.last_in_container)this.img.parent().append(container);else this.img.after(container);E.emit("loading",this);if(!this.promo)this.create_promo(v,E.conf.promo)};Preview.prototype.create_promo=function(preview_video,opt){if(promo&&promo.__stub)return;if(!(this.promo=promo.create(preview_video,opt)))return;var _this=this;this.promo.on(promo.EVENT_STATE_CHANGE,function(state){if(state!=promo.STATE_ENDED)return;if(!_this.promo_played)E.stats.inc("promo_played_uniq_n");_this.promo_played=true;E.stats.inc("promo_played_n")})};Preview.prototype.create_relative_container=function(){if(!E.conf.position_relative||!E.conf.position_relative(this.el,$))return;var pos=this.get_position();var dummy_div=document.createElement("div");$(this.img).after(dummy_div);var dummy_pos=$(dummy_div).jqPosition();$(dummy_div).remove();var outer_container=document.createElement("div");$(outer_container).css({top:pos.top-dummy_pos.top+"px",left:pos.left-dummy_pos.left+"px",position:"relative"});return outer_container};Preview.prototype.create_video_el=function(width,height){if(this.streaming_cache_el){this.video_el=this.streaming_cache_el;this.video_el.currentTime=0;this.video_el.setAttribute("width",Math.ceil(width));this.video_el.setAttribute("height",Math.ceil(height));clearTimeout(this.streaming_cache_t);return this.video_el}var src=this.get_video().get_src();if(this.opt.fix_preview_url){src=this.opt.fix_preview_url({E:E,$:$,src:src,width:width,height:height})}var video_preroll,video_preroll_played;if(this.opt.get_video_preroll){video_preroll=this.opt.get_video_preroll({_this:this,E:E,$:$,src:src})}var v=document.createElement("video"),_this=this;var $v=$(v);v.muted=true;v.setAttribute("muted",1);v.setAttribute("playsinline",1);v.setAttribute("width",Math.ceil(width));v.setAttribute("height",Math.ceil(height));if(this.is_live)v.currentTime=2;if(this.use_autoplay)v.setAttribute("autoplay",1);v.className="hola_video_preview";$v.one("canplaythrough",this.emit.bind(this,"loaded"));function onended(){if(video_preroll&&!video_preroll_played){video_preroll_played=true;var $s=$v.find("source");if($s.length){$s[0].setAttribute("src",src);v.muted=true;v.setAttribute("muted",1);v.load();v.play()}else{v.src=src;v.play()}return}if(_this.promo&&_this.promo.is_active()){_this.promo.once(promo.EVENT_STATE_CHANGE,onended);return}var blur;if(blur=_this.opt.blur){if(blur.text&&!blur.text.delay&&_this.played_n==1)_this.add_text(blur.text);if(!blur.allow_loop)return}if(!_this.autoplay)play(v,_this);_this.emit("loop_restart");_this.rm_loop=setTimeout(function(){if(_this.active)play(v,_this)},0)}$v.on("ended",onended);var on_error=this.video_error.bind(this,this.current_cdn);if(this.streaming_cache&&util.is_safari){$v.on("error",on_error);v.src=video_preroll||src}else if(!E.conf.no_src){var s=document.createElement("source");$(s).prop({type:"video/mp4",src:video_preroll||src});v.appendChild(s);s.addEventListener("error",on_error)}this.video_el=v;return v};Preview.prototype.destroy=function(){if(this.opt.on_uninit)this.opt.on_uninit({$:$,E:E,_this:this});this.hide();if(this.on_doc_mousemove)$(document).off("mousemove",this.on_doc_mousemove);this.on_doc_mousemove=null;if(this.on_parents_scroll)this.scrollable_parents.off("scroll",this.on_parents_scroll);this.on_parents_scroll=null;this.scrollable_parents=null;if(this.video){this.video.off("loaded",this.on_loaded);if(this.on_conn_error)this.video.off("conn_error",this.on_conn_error);this.on_conn_error=null}this.video=null;this.streaming_cache_el=null;clearTimeout(this.streaming_cache_t);var $el=$(this.el);if(this.on_mousemove)$el.off("mousemove",this.on_mousemove);this.on_mousemove=null;if(this.$hover_el){this.$hover_el.off("mouseenter",this.on_hover);this.$hover_el.off("mouseleave",this.on_unhover)}if(util.is_mobile&&E.preview_on_touch){$el.off("touchstart",this.on_touchstart);$el.off("touchend",this.on_touchend)}$el.off("mouseenter",this.on_hover);$el.off("click",this.on_click);if(this.is_playlist_link)$el.off("mouseleave",this.on_unhover);if(this.links){var _this=this;this.links.each(function(_t){$(_t).off("mouseenter",_this.on_hover);$(_t).off("click",_this.on_click)})}this.img.off("mouseenter",this.on_hover);$el.removeProp("hola-video-preview-id");if(util.is_enabled(preview_debug))preview_debug.uninit_debug_rect(this);if(this.duration)this.duration.hide();if(this.icon)this.icon.hide();if(this.controls)this.controls.destroy();if(this.on_contextmenu)$el.off("contextmenu",this.on_contextmenu);E.video_cache.purge(this.get_url());this.emit("uninit")};Preview.prototype.draw_debug_rect=function(rect){if(this.use_debug_rect&&util.is_enabled(preview_debug))preview_debug.draw_rect(this,rect)};Preview.prototype.error=function(){this.was_error=true;this.emit("error")};Preview.prototype.get_id=function(){return this.uniq_id};Preview.prototype.get_img_size_el=function(overlay){if(this.text_link)return this.el;return E.links.get_img_size_el(this.img,this.opt,overlay)};Preview.prototype.get_info=function(){var src=E.previews_map[this.href];var video=this.video?this.get_video():null;if(video&&video.error){return video.url?assign({status:"error"},video.error):{status:"no_mapping"}}if(video&&video.ready||this.opt.preview_streaming&&this.video_status[this.current_cdn]=="bytes"){return{status:"ready"}}if(this.status_video&&this.status_video.error)return assign({status:"error"},this.status_video.error);if(!src)return{status:"no_mapping"};if(src.info)return src.info;if(src.error)return{status:src.url?"ready":"error",error:src.error};if(!video)return{status:"not_loaded"}};Preview.prototype.get_map_info=function(){return E.previews_map[this.href]};Preview.prototype.get_size=function(){var url=this.get_url();return url&&size_from_url(url)};Preview.prototype.get_url=function(size){var url=get_url.call(this);if(url&&size)return replace_size_in_url(url,size);return url};Preview.prototype.get_video=function(fallback){var video=E.video_cache.get(this.get_url(),Preview._build_video_cache_opt(this.opt));if(video==this.video)return video;if(this.video){this.video.off("loaded",this.on_loaded);if(this.on_conn_error)this.video.off("conn_error",this.on_conn_error)}video.once("loaded",this.on_loaded=this.video_loaded.bind(this));if(fallback||!this.opt.preview_streaming){video.once("conn_error",this.on_conn_error=this.next_cdn.bind(this))}this.video=video;return video};Preview.prototype.got_bytes=function(cdn){this.ttfb_stat(cdn);this.has_bytes=true;this.draw_debug_rect();this.emit("progress");if(!this.try_fallback_agent)return;this.video_status[cdn]="bytes";if(cdn!=this.current_cdn&&this.video_status[this.current_cdn]!="bytes")this.next_cdn("switch_back_bytes",cdn)};Preview.prototype.hide=function(opt){if(E.keep_playing_preview===this)return;this.safari_fix_size_bug_timer=clearTimeout(this.safari_fix_size_bug_timer);if(E.conf.force_native_autoplay&&util.is_mobile)return this.hide_simple_preview();this.hover_timer=this.hover_timer_elapsed=clearTimeout(this.hover_timer);this.show_timer=this.show_timer_elapsed=clearTimeout(this.show_timer);if(trace)console.log("TRACE >hide %o",this);opt=opt||{};if(this.rm_hide)this.rm_hide=clearTimeout(this.rm_hide);if(this.on_ready){this.video.off("ready",this.on_ready);this.on_ready=null}if(this.loader&&!opt.keep_loader)this.loader.hide();if(this.preroll)this.preroll.hide();if(this.call_to_action_elem)this.call_to_action_elem=void this.call_to_action_elem.remove();this.last_mouse_event=null;if(this.on_doc_mousemove)$(document).off("mousemove",this.on_doc_mousemove);this.on_doc_mousemove=null;if(this.on_doc_mouseleave)$(document).add("html").off("mouseleave",this.on_doc_mouseleave);this.on_doc_mouseleave=null;if(this.unite&&this.on_mouseleave)this.unite.off("mouseleave",this.on_mouseleave);this.on_mouseleave=null;if(this.on_parents_scroll)this.scrollable_parents.off("scroll",this.on_parents_scroll);this.on_parents_scroll=null;this.scrollable_parents=null;if(this.rm_shown)this.rm_shown=clearTimeout(this.rm_shown);$(this.container).parent().find(".hola_preview_text").remove();if(this.container)$(this.container).removeClass("hola_preview_shown");this.draw_debug_rect();if(!this.active&&!opt.force)return;if(!opt.preserve_elements&&!opt.force)this.emit("hide");clearTimeout(this.play_timeout);if(this.rm_call_to_action)this.rm_call_to_action=clearTimeout(this.rm_call_to_action);if(this.rm_loop)this.rm_loop=clearTimeout(this.rm_loop);if(this.rm_navigate)this.rm_navigate=clearTimeout(this.rm_navigate);var parent=this.parent_el();if(this.countdown){this.countdown.hide();this.countdown=null;parent.removeClass("hola_preview_countdown")}this.countdown_enabled=false;if(this.on_link_click)this.off("link_click",this.on_link_click);this.on_link_click=null;if(util.is_enabled(preview_debug))preview_debug.draw_debug_active(this.uniq_id,false);this.active=false;if(opt.error)$(this.el).addClass("hola_preview_error");if(this.on_mousemove)$(this.el).off("mousemove",this.on_mousemove);this.on_mousemove=null;if(this.on_timeupdate)$(this.video_el).off("timeupdate",this.on_timeupdate);this.on_timeupdate=null;if(this.on_play)$(this.video_el).off(this.play_evt,this.on_play);this.on_play=null;if(this.on_playing)$(this.video_el).off("playing",this.on_playing);this.on_playing=null;if(this.on_meta)$(this.video_el).off("loadedmetadata",this.on_meta);this.on_meta=null;if(this.on_bytes){$(this.video_el).off("progress",this.on_bytes).off("loadedmetadata",this.on_bytes)}this.on_bytes=null;this.hide_blur();if(opt.preserve_elements)return;parent.removeClass("hola_preview_loading");parent.removeClass("hola_preview_playing");parent.removeClass("hola_preview_blur");var _this=this;function remove_elements(){if(_this.unwatch_class)_this.unwatch_class();if(_this.unwatch_style)_this.unwatch_style();$(_this.img).removeClass("hola_preview_img");$(_this.el).parent().removeClass("hola_preview_link_container");_this.remove_elements()}if(opt.force)remove_elements();else this.rm_hide=setTimeout(remove_elements,500);if(this.promo){this.promo.destroy();this.promo=null}if(trace)console.log("TRACE <hide %o",this)};Preview.prototype.hide_blur=function(force){clearTimeout(this.rm_blur);$(this.video_el).css("animation",null);if(force&&this.video_el)void this.video_el.offsetWidth};Preview.prototype.show_simple_preview=function(){if(this.preview_v){this.preview_v.style.display="block";return}var img=$(this.img)[0];var src=this.get_video().get_src();var v=this.preview_v=document.createElement("video");v.muted=v.autoplay=v.loop=true;v.setAttribute("muted",1);v.setAttribute("playsinline",1);Object.assign(v.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%",background:"black",opacity:0});v.addEventListener("play",function(){v.style.opacity=1});v.src=src;img.parentNode.insertBefore(v,img.nextSibling);return v};Preview.prototype.hide_simple_preview=function(){if(!this.preview_v)return console.error("Preview hide_preview no video %s",this);this.preview_v.style.display="none"};Preview.prototype.hover=function(event){var hover_delay=E.conf.hover_delay;if(typeof hover_delay=="function")hover_delay=hover_delay({E:E,_this:this,$:$});if(hover_delay){if(!this.hover_timer_elapsed){if(this.hover_timer)return;this.hover_timer=setTimeout(function(){this.hover_timer_elapsed=true;this.hover(event)}.bind(this),hover_delay);return}}if(trace)console.log("TRACE >hover %o %o",this,event);if(this.simple_preview)return this.show_simple_preview();if(util.is_ios)return;this.hovering=true;this.fallback_on_error=this.try_fallback_agent;
if(this.showing_fake_info)return;var skip_hover=E.conf.skip_hover;if(skip_hover){var url=this.href;var info=E.links.get_db([{url:url}]);if(skip_hover($,{E:E,_this:this,url:url,info:info&&info[0]})){return}}E.emit("try_activate",this);this.emit("hover");if(this.no_hover_control)return;this.show(event);if(trace)console.log("TRACE <hover %o %o",this,event)};Preview.prototype.in_middle=function(check_x){var img=$(this.img);if(this.text_link||!img.width()||!img.height())return;var rect=img[0].getBoundingClientRect();var result=dom_util.in_rect(rect,get_mid_rect(check_x));this.draw_debug_rect(rect);if(util.is_enabled(preview_debug))preview_debug.draw_debug_active(this.uniq_id,result);return result};Preview.prototype.in_viewport=function(entirely,check_z_index){var img=$(this.img);if(this.text_link||!img.width()||!img.height())return;var rect=img[0].getBoundingClientRect();this.draw_debug_rect(rect);return dom_util.in_rect(rect,dom_util.visual_viewport(),entirely)&&(!check_z_index||dom_util.in_front($().add(img).add(this.link).add(this.links),rect))};Preview.prototype.init=function(){var _this=this,$el=$(this.el);$el.prop("hola-video-preview-id",this.uniq_id);function hide_on_scroll(){if(E.active_preview)E.active_preview.hide();E.active_preview=undefined;document.removeEventListener("scroll",hide_on_scroll)}if(util.is_mobile&&E.preview_on_touch){$el.on("touchstart",this.on_touchstart=function(){_this.show();E.active_preview=_this;document.addEventListener("scroll",hide_on_scroll)});$el.on("touchend",this.on_touchend=function(){_this.hide();E.active_preview=undefined;document.removeEventListener("scroll",hide_on_scroll)})}if(E.conf.simple_preview&&E.conf.simple_preview!="desktop_safari"||E.conf.simple_preview=="desktop_safari"&&util.is_safari&&!util.is_mobile){console.log("spark simple_preview");this.simple_preview=true;this.$hover_el=$el.closest("div");this.$hover_el.on("mouseenter",this.on_hover=this.hover.bind(this));this.$hover_el.on("mouseleave",this.on_unhover=this.unhover.bind(this));return}if(E.conf.simple_hover){this.$hover_el=$el.closest("div");this.$hover_el.on("mouseenter",this.on_hover=this.hover.bind(this));this.$hover_el.on("mouseleave",this.on_unhover=this.unhover.bind(this))}else if(!this.is_playlist_slide_link||!this.ignore_autoplay){$el.on("mouseenter",this.on_hover=this.hover.bind(this));$el.on("click",this.on_click=this.emit.bind(this,"link_click"));if(this.is_playlist_link)$el.on("mouseleave",this.on_unhover=this.unhover.bind(this));if(this.links&&this.links.length){this.links=this.links.filter(function(_t){return!within(_this.el,_t)}).each(function(_t){$(_t).on("mouseenter",_this.on_hover);$(_t).on("click",_this.on_click);$el.add(_t)})}if(!this.img.parents().filter($el).length)this.img.on("mouseenter",this.on_hover)}if((E.conf.show_purge_icon||E.conf.debug||E.spark.is_editor_mode)&&util.conf.ext_api_key&&!this.text_link&&util.is_enabled(controls)){this.controls=new controls(this)}if(util.is_enabled(preview_debug))preview_debug.init_debug_rect(this);this.update();if(E.conf.autoplay.type!=AUTOPLAY_SELECTOR&&!(this.is_playlist_link&&$el.hasClass("hola_playlist_tile"))||this.ignore_autoplay){return}var on_attr_update=E.emit.bind(E,"preview_attr_update");this.unwatch_style=dom_util.attr_watch(this.el,{attr:"style",watch_fn:on_attr_update});this.unwatch_class=dom_util.attr_watch(this.el,{attr:"class",watch_fn:on_attr_update})};Preview.prototype.init_fade=function(){var _this=this,opt=this.opt,v=this.video_el;$(v).on("timeupdate",this.on_timeupdate=function(){var delay=(v.duration-v.currentTime)*sec_ms-opt.fade_time;if(!_this.fade_timeout&&delay<1e3){_this.fade_timeout=setTimeout(function(){if(_this.video_el)$(_this.video_el).addClass("hola_fade_out")},delay)}});var captured=false;var capture_frame=function(){if(!_this.video_el)return;var c=_this.canvas;$(c).attr({height:v.videoHeight,width:v.videoWidth});if(no_object_fit())$(c).css(object_fit_css(v));else $(c).css({height:v.offsetHeight+"px",width:v.offsetWidth+"px"});try{c.getContext("2d").drawImage(v,0,0)}catch(e){return}captured=true};$(v).on("playing",this.on_playing=function(){if(!captured){if(util.is_ie)setTimeout(capture_frame,150);else capture_frame()}if(_this.fade_timeout)_this.fade_timeout=clearTimeout(_this.fade_timeout);$(v).removeClass("hola_fade_out")})};Preview.prototype.init_modal_box=function(){if(!E.conf.modal_box.enable||!E.conf.modal_box.show_on_click||this.is_preview_over_player_link||this.is_playlist_link||!this.el||this.modal_box_on_click||!util.is_enabled(modal_box)){return}var _this=this;$(this.el).on("click",this.modal_box_on_click=function(ev){ev.stopImmediatePropagation();ev.preventDefault();_this.uninit_modal_box();new modal_box(_this,E.conf.modal_box,E)})};Preview.prototype.is_narrow_screen=function(){var width;if(!util.is_mobile||!(width=this.opt.screen_width))return true;return window.screen.width<=width};Preview.prototype.next_cdn=function(reason,cdn){E.stats.inc_d("next_cdn_n");if(reason)E.stats.inc_d("next_cdn_"+reason+"_n");if(!this.cdns)return;this.current_cdn=cdn!==undefined?cdn:(this.current_cdn+1)%this.cdns.length;if(!this.hovering)return;var evt=this.last_mouse_event;this.hide({force:true,keep_loader:true});this.show(evt)};Preview.prototype.object_fit_fallback=function(){var v=this.video_el,_this=this;var fit=function(){$(v).css(object_fit_css(v));if(_this.on_meta)$(v).off("loadedmetadata",_this.on_meta);_this.on_meta=null};if(v.readyState>0)fit();else $(v).on("loadedmetadata",this.on_meta=fit)};Preview.prototype.navigate=function(){if(!this.link||typeof this.link.click!="function"||this.no_navigate()){if(this.countdown)this.countdown.hide();return}this.emit("navigate");var ctx=E.stats.data[this.get_id()];var hover=ctx.hover,autoplay=ctx.autoplay;var method=hover.played?hover:autoplay.played?autoplay:hover;var played_ms=method.played?util.date_monotonic()-method.play_start:0;E.spark.set_event("preview_click",{played_ms:Math.round(played_ms),link:this.href,is_organic:!this.is_link_by_spark,played:ctx.played,is_autoclick:true,is_autoplay:method==autoplay},this.el);if(this.is_preview_over_player_link){var player;if(!(player=PreviewOverPlayer.get_player(this.el)))return;if(E.can_autoplay=="muted")player.controls.muted(true);player.play();return}if(this.link.target=="_blank"&&this.opt.navigate_remove_target)this.link.target="_self";if(this.on_link_click)this.off("link_click",this.on_link_click);this.on_link_click=null;if(util.is_enabled(modal_box)&&E.conf.modal_box.enable)return void new modal_box(this,E.conf.modal_box,E);E.spark.save_navigate(this.href,"preview_autoclick");this.link.click()};Preview.prototype.no_navigate=function(){if(E.shows_modal_box)return;if(!this.is_preview_over_player_link)return this.autoplay&&is_video_playing();var player=PreviewOverPlayer.get_player(this.el);return player&&player.controls&&player.controls.is_ad_active()};Preview.prototype.parent_el=function(){return this.opt.custom_attach&&this.opt.custom_attach.parent_el&&this.opt.custom_attach.parent_el(this,$)||(this.popup?$(this.container):$(this.img).parent())};Preview.prototype.pause=function(){if(!this.active||!this.video_el||this.video_el.paused)return;this.video_el.pause()};Preview.prototype.get_position=function(overlay){var ew,img=this.img,opt=this.opt;var img_size=this.get_img_size_el(overlay);var img_offset=$(img_size).offset();var x=img_offset.left,y=img_offset.top;var width=$(img_size).outerWidth(),height=$(img_size).outerHeight();if((ew=+$(img_size).attr("data-hola-playlist-ew"))&&!isNaN(ew))width*=ew;if(this.text_link){var popup_width=opt.popup_width||196;var popup_height=opt.popup_height||110;var tip_offset={y:30,x:95};return{top:y-popup_height-tip_offset.y,left:x+(this.last_mouse_event?this.last_mouse_event.offsetX-tip_offset.x:0),width:popup_width,height:popup_height,popup:true}}var match_selector=opt.scale_selector?$(this.el).is(opt.scale_selector):true;if(match_selector&&!util.is_mobile&&!overlay&&(opt.scale||width<opt.min_width||height<opt.min_height)&&!this.is_playlist_link&&!this.is_watch_later_link){var scale=opt.scale||Math.max((opt.min_width||0)/width,(opt.min_height||0)/height);var new_width=width*scale,new_height=height*scale;return{top:Math.max(y-(new_height-height)/2,0),left:Math.max(x-(new_width-width)/2,0),width:new_width,height:new_height,popup:true,transform:"scale("+1/scale+")"}}var img_pos=E.conf.custom_position&&E.conf.custom_position(img,$);var $op=$(img).offsetParent();var op_off=!$op[0]||$op[0].tagName=="BODY"?{top:0,left:0}:$op.offset();return{top:img_pos?img_pos.top:y-op_off.top,left:img_pos?img_pos.left:x-op_off.left,width:width,height:height,transform:"none"}};Preview.prototype.remove_elements=function(){var container=this.container,popup=this.popup;if(!container)return;var outer_container=this.outer_container;var remove=function(){if($(container).parent().length)$(container).remove();if($(outer_container).parent().length)$(outer_container).remove()};if(E.watermark)E.watermark.remove(this.container);this.container=null;this.outer_container=null;this.popup=null;if(this.streaming_cache){this.streaming_cache_el=this.video_el;this.streaming_cache_el.pause();this.streaming_cache_t=setTimeout(function(){this.streaming_cache_el=null}.bind(this),this.streaming_cache)}this.video_el=null;this.canvas=null;this.uninit_modal_box();if(!popup)return void remove();$(container).removeClass("hola_preview_popup_visible");setTimeout(remove,300)};Preview.prototype.resume=function(){if(this.active&&this.video_el&&this.video_el.paused)this.video_el.play()};Preview.prototype.show=function(event,autoplay){if(E.conf.force_native_autoplay&&util.is_mobile){this.emit("autoplay");this.emit("played");return this.show_simple_preview()}var show_delay=E.conf.show_delay;if(typeof show_delay=="function")show_delay=show_delay({E:E,_this:this,$:$});if(trace)console.log("TRACE >show %o",this);if(show_delay){if(!this.show_timer_elapsed){if(this.show_timer)return;this.show_timer=setTimeout(function(){this.show_timer_elapsed=true;this.show(event,autoplay)}.bind(this),show_delay);return}}if(E.gesture_needed)return;var stats_autoplay;if(!autoplay&&this.autoplay&&this.active&&E.conf.autoplay.type!=AUTOPLAY_SELECTOR){event=event||this.last_mouse_event;this.hide({preserve_elements:true,force:true});stats_autoplay=true}if(this.active)return;if(!this.text_link&&(!this.img.width()||!this.img.height()))return void this.error();if(this.rm_hide)this.hide({force:true});var _this=this;this.last_mouse_event=event||this.last_mouse_event;if(!autoplay){var img_size=this.get_img_size_el();var link=event&&event.currentTarget||this.el;if(!this.$hover_el){if(this.on_doc_mousemove)$(document).off("mousemove",this.on_doc_mousemove);var unhover=function(ev){if(!mouse_within(link,ev)&&!mouse_within(img_size,ev)&&!(_this.container&&mouse_within(_this.container,ev))){_this.unhover()}};$(document).on("mousemove",this.on_doc_mousemove=function(ev){_this.last_mouse_event=ev;if(!mouse_in_parent(link,ev))unhover(ev)});if(!this.on_doc_mouseleave){$(document).add("html").on("mouseleave",this.on_doc_mouseleave=this.unhover.bind(this))}if(this.links&&this.links.length&&this.unite)this.unite.on("mouseleave",this.on_mouseleave=unhover);if(this.on_parents_scroll)this.scrollable_parents.off("scroll",this.on_parents_scroll);this.scrollable_parents=$(link).parents().filter(function(el){var $el=$(el),scrollable=["scroll","auto"];if(window.Node&&window.Node.ELEMENT_NODE!=el.nodeType)return false;return scrollable.includes($el.css("overflow-x"))||scrollable.includes($el.css("overflow-y"))}).add(document).on("scroll",this.on_parents_scroll=function(){if(!_this.last_mouse_event)return;_this.last_mouse_event.reused=true;_this.on_doc_mousemove(_this.last_mouse_event)})}if(E.conf.autoplay.type!=AUTOPLAY_SELECTOR){this.group.for_each(function(p){if(p.active&&p.autoplay&&p.autoplay!="always")p.hide()})}}if(E.conf.mobile_wifi_only&&util.is_mobile_cellular_con())return void log.info("skip preview due to mobile cellular network");this.update_size();var video=this.get_video();if(!video.get_src())return void this.error();if(autoplay||stats_autoplay){E.emit("try_activate",this);this.emit("autoplay")}this.autoplay=autoplay;if(util.is_enabled(preview_debug))preview_debug.draw_debug_active(this.uniq_id,true);if(E.conf.hidden)return void log.info("skip preview due to hidden mode");this.active=true;if(this.text_link&&!this.on_mousemove){$(this.el).on("mousemove",this.on_mousemove=function(ev){_this.last_mouse_event=ev})}if(this.loader){if(!video.ready){E.emit("loading",this);var on_load;if(this.opt.preview_streaming)this._show();else on_load=this._show.bind(this);this.loader.show(on_load,this.hide.bind(this));if(trace)console.log("TRACE <show %o",this);return}this.loader.show()}else if(this.text_link&&!video.ready){if(trace)console.log("TRACE <2show %o",this);return void video.on("ready",this.on_ready=function(){if(video.ready)_this._show();else _this.hide()})}this._show();if(trace)console.log("TRACE <3show %o",this)};Preview.prototype.show_blur=function(blur){if(!blur||this.played_n>1&&!blur.restart_loop)return;if(typeof blur.links_selector=="string"&&!$(this.link).is(blur.links_selector)){return}if(blur.restart_loop)this.hide_blur(true);var _this=this,parent=this.parent_el();var dur=isFinite(this.video_el.duration)&&this.video_el.duration||5;$(this.video_el).css({animation:"preview_blur "+dur+"s","animation-fill-mode":"forwards"});if(blur.text&&blur.text.delay){this.rm_blur=setTimeout(function(){_this.add_text(blur.text)},blur.text.delay*sec_ms)}if(typeof this.opt.countdown_on_hover!="number")return;this.rm_navigate=setTimeout(function(){parent.addClass("hola_preview_blur");_this.countdown_show()},dur*blur.icon/100*sec_ms)};Preview.prototype.ttfb_stat=function(cdn,error){if(!E.conf.detailed_stats||!this.video_start[cdn])return;E.stats.set_ttfb("video_"+(error?"error":"success"),Date.now()-this.video_start[cdn]);this.video_start[cdn]=null};Preview.prototype.unhover=function(){if(trace)console.log("TRACE >unhover %o",this);if(this.simple_preview)return this.hide_simple_preview();this.hovering=false;this.emit("unhover");if(this.no_hover_control)return;if(this.opt.first_frame&&this.video_el){this.video_el.pause();this.video_el.currentTime=0}this.hide({preserve_elements:this.opt.first_frame});if(trace)console.log("TRACE <unhover %o",this)};Preview.prototype.uninit_modal_box=function(){if(!this.el||!this.modal_box_on_click)return;$(this.el).off("click",this.modal_box_on_click);this.modal_box_on_click=null};Preview.prototype.update=function(){var video=this.get_url();this.has_info=true;if(this.icon)this.icon.update();if(video){var link_href=$(this.link).attr("href");if(link_href&&!this.has_video){var new_href=E.spark.gen_page_url(link_href,E.conf.link_tags,{customer_generated:true});$(this.link).attr("href",new_href)}if(!this.has_video)E.stats.inc("preview_mapped_n");this.has_video=true;if(E.conf.debug)log.debug("Preview #"+this.uniq_id+" video:"+video);this.is_live=E.previews_map[this.href]&&E.previews_map[this.href].live;if(this.is_live&&this.controls)this.controls=void this.controls.destroy()}else{if(this.active)this.hide();this.has_video=false}$(this.el).prop("hola-video-preview-has-video",this.has_video);this.draw_debug_rect();if(E.conf.add_gif)E.conf.add_gif($,{E:E,_this:this,link:this.el});if(this.active)return;if(E.active_preview==this)return void this.show(null,true);if(this.has_video&&this.opt.first_frame&&!this.shown_first_frame){this._show(true);this.shown_first_frame=true}};var sent_update_size_perr;Preview.prototype.update_size=function(link_info){var url,check_lazy_img_load=this.lazy_img_load||link_info;if(!check_lazy_img_load&&this.page_links_size_updated||!(url=this.get_url())){return}var src=E.previews_map[this.href];if(!src)return;var from_page_links=src.from_page_links;if(!check_lazy_img_load&&!from_page_links)return;var from_cache=src.from_cache;var perr_infix=from_cache?"_cache":from_page_links?"_from_page_links":"";E.stats.inc_d("lazy_img_load_check"+perr_infix+"_n");var info=link_info||E.links.get_link_info(this.el,E.conf);var size_util=E.links.size_util;this.page_links_size_updated=this.page_links_size_updated||from_page_links;if(!size_util.calc(info.size))return;var cur_size=size_from_url(url);if(cur_size&&info.size==cur_size)return;this.lazy_img_load=this.lazy_img_load&&!!link_info;if(cur_size&&!from_page_links&&size_util.parse(info.size).width<size_util.parse(cur_size).width*(E.conf.check_lazy_img_load_ratio_threshold||1.15)){return}E.stats.inc_d("lazy_img_load_update"+perr_infix+"_n");if(!sent_update_size_perr){perr({id:"preview_update_size",info:{old_size:cur_size,new_size:info.size,from_cache:from_cache,from_page_links:from_page_links}});sent_update_size_perr=true}var update_size=function(p_url){if(!cur_size)return p_url+"&size="+info.size;return replace_size_in_url(p_url,info.size)};if(typeof src=="string")E.previews_map[this.href]=update_size(src);else src.url=src.initial_url=update_size(src.url);update_preview_url(this.href)};Preview.prototype.video_error=function(cdn){this.ttfb_stat(cdn,true);if(!this.try_fallback_agent)return void this.hide({error:true});if(!this.fallback_on_error||cdn!=this.current_cdn)return;this.video_status[cdn]="error";var video=this.video;this.next_cdn("video_error");if(video==this.video&&!E.conf.debug)return;var _this=this;var off=function(){video.off("progress",ok).off("loaded",ok).off("ready",ready);_this.status_video=video;_this.draw_debug_rect()};var ok=function(){off();if(_this.video_status[_this.current_cdn]=="bytes")return;_this.next_cdn("switch_back",cdn)};var ready=function(){off();if(video.conn_error||_this.video_status[_this.current_cdn]=="bytes")return;E.stats.inc_d("no_fallback_on_error_n");_this.fallback_on_error=false};video.once("progress",ok).once("loaded",ok).once("ready",ready);video.start()};Preview.prototype.video_loaded=function(){this.emit("loaded",{from_cache:this.video.from_cache,size:this.video.loaded_size})};Preview.prototype._show=function(first_frame){var _this=this,img=this.img,opt=this.opt,video=this.get_video();if(!video.get_src()||!this.text_link&&(!img.width()||!img.height())){this.active=false;return void this.hide()}this.draw_debug_rect();$(this.el).removeClass("hola_preview_error");this.create_elements();if(!this.popup&&!this.click_pass_through)$(img).addClass("hola_preview_img");$(this.el).parent().addClass("hola_preview_link_container");var parent=this.parent_el();setTimeout(function(){if(_this.active)parent.addClass("hola_preview_loading")});this.preroll.show();if(this.popup){this.rm_shown=setTimeout(function(){$(_this.container).addClass("hola_preview_shown")})}this.play_evt=this.use_autoplay?"play":"playing";if(this.on_play)$(this.video_el).off(this.play_evt,this.on_play);this.played_n=0;$(this.video_el).on(this.play_evt,this.on_play=function(){_this.init_modal_box();_this.played_n++;if(_this.played_n>3&&_this.ignore_autoplay||opt.max_replay&&_this.played_n>opt.max_replay){setTimeout(_this.hide.bind(_this))}_this.show_blur(opt.blur);if(_this.played_n>1)return;_this.play_timeout=setTimeout(function(){_this.preroll.end();_this.emit("played");if(E.can_autoplay==false){perr({id:"preview_can_mismatch_allowed",throttle:1,info:{error:E.spark._autoplay_policy.muted_err||E.spark._autoplay_policy.sound_err}});E.stats.inc_d("can_mismatch_allowed_n")}if(video.autoloaded)E.stats.inc_d("autoload_played_n");parent.removeClass("hola_preview_loading");parent.addClass("hola_preview_playing")})});this.on_bytes=this.got_bytes.bind(this,this.current_cdn);$(this.video_el).one("progress",this.on_bytes).one("loadedmetadata",this.on_bytes);if(first_frame&&this.opt.first_frame){$(this.video_el).attr({preload:"metadata"}).addClass("hola_preview_first_frame")}else if(!this.use_autoplay)play(this.video_el,this);this.video_start[this.current_cdn]=Date.now();if(opt.fade_time&&!opt.blur)this.init_fade();if(no_object_fit())this.object_fit_fallback();if(this.is_playlist_link){["navigate_on_hover_enabled","countdown_on_hover","navigate_on_hover_sec"].forEach(function(e){opt[e]=$(_this.el).data("hola_preview_"+e)})}if(opt.call_to_action&&opt.call_to_action.enable){this.rm_call_to_action=setTimeout(function(){_this.call_to_action(opt.call_to_action)},opt.call_to_action.delay*1e3)}if(this.no_countdown||this.no_navigate())return;var is_target_blank=this.el&&this.el.target=="_blank";if((!this.autoplay||util.is_mobile)&&(!is_target_blank||opt.navigate_remove_target)&&opt.navigate_on_hover_enabled&&!first_frame&&this.is_narrow_screen()){this.countdown_enabled=true;if(is_target_blank){this.on("link_click",this.on_link_click=function(){_this.countdown_cancel();if(_this.countdown)_this.countdown.hide()})}if(opt.blur)return;if(typeof opt.navigate_on_hover_sec=="number"){this.rm_navigate=setTimeout(this.countdown_show.bind(this),opt.navigate_on_hover_sec*sec_ms)}else if(typeof opt.countdown_on_hover=="number")this.countdown_show()}};Preview._build_video_cache_opt=function(opt){return{ready:opt.line_loader==LOADER_GROW,skip_preload:opt.line_loader==LOADER_GROW||opt.first_frame||opt.preview_streaming}};function Loader(preview){this.preview=preview;this.opt=this.preview.opt;this.is_logo=!this.opt.disable_logo_loader;this.video_ready_fn=this.video_ready.bind(this);this.video_progress_fn=this.video_progress.bind(this);this._initial_progress=.1}Loader.prototype.show=function(on_ready,on_error){if(this.active)return;this.active=true;this.video=this.preview.get_video();if(this.video.error)return;this.on_ready=on_ready;this.on_error=on_error;var pos=this.preview.get_position(true);var wait_progress=(true||this.preview.not_ready)&&!this.video.headers_received;this.wait_headers=wait_progress&&!this.opt.preview_streaming;if(this.opt.line_loader==LOADER_BAR){this.max_width=pos.width;this.elem=document.createElement("div");$(this.elem).addClass("hola_preview_loader");if(this.preview.opt.first_frame)$(this.elem).addClass("hola_preview_first_frame");$(this.elem).css({display:this.wait_headers?"none":"block",top:pos.top+"px",left:pos.left+"px",transform:pos.transform});$(this.preview.img).after(this.elem)}if(this.is_logo){var logo_opt=this.opt,logo_class=play_icon.Logo,custom_logo;if(custom_logo=util.get(E.spark,"conf.general.logo_svg")){logo_class=play_icon.CustomLogo;logo_opt=assign({},this.opt,custom_logo)}this.logo=new logo_class(logo_opt,{hide:wait_progress,animate:true,location:this.opt.icon_loader_location,pos:this.preview.get_position(true),watermark:E.watermark,logo_loader_hide_duration:E.conf.logo_loader_hide_duration});$(this.preview.img).after(this.logo.logo)}this.ready=false;if(this.video.ready){this.video_progress_fn();this.video_ready_fn();return}if(this.opt.preview_streaming){$(this.elem).css({transition:"width "+AVG_TTFB/1e3+"s linear"});setTimeout(this.video_progress_fn);this.preview.on("progress",this.video_progress_fn);this.preview.on("played",this.video_ready_fn);return}this.video_progress_fn();this.video.on("ready",this.video_ready_fn);this.video.on("progress",this.video_progress_fn);this.video.start()};Loader.prototype.hide=function(){if(!this.active)return;this.active=false;this.video.off("ready",this.video_ready_fn);this.video.off("progress",this.video_progress_fn);this.preview.off("played",this.video_ready_fn);this.preview.off("progress",this.video_progress_fn);if(this.ready_t)this.ready_t=clearTimeout(this.ready_t);if(this.rm_t)this.rm_t=clearTimeout(this.rm_t);if(this.elem)$(this.elem).remove();if(this.logo)this.logo.remove();this.on_ready=null;this.on_error=null};Loader.prototype.video_ready=function(){if(!this.video.ready&&this.on_error&&!this.opt.preview_streaming)return this.on_error();this.ready=true;if(this.video.ready&&this.on_ready)this.on_ready();var _this=this;if(this.max_width){this.ready_t=setTimeout(function(){$(_this.elem).css({width:_this.max_width+"px",maxWidth:_this.max_width+"px"})},0)}if(this.logo)this.logo.hide();this.rm_t=setTimeout(function(){$(_this.elem).css("display","none")},200)};Loader.prototype.video_progress=function(){if(this.ready)return;if(this.logo&&this.preview.has_bytes)return void this.logo.show();var $elem=this.elem?$(this.elem):null;if(this.preview.not_ready||this.wait_headers){if(!this.video.headers_received&&!this.video.ready)return;if($elem)$elem.css({display:"block"});if(this.logo)this.logo.show();this.preview.not_ready=false}if(!$elem)return;var streaming_progress=0;if(this.preview.has_bytes){streaming_progress=.9;$elem.css({transition:""})}else if(this.preview.opt.preview_streaming)streaming_progress=.8;var progress=Math.max(this._initial_progress,this.video.progress,streaming_progress);$elem.css({width:progress*this.max_width+"px",maxWidth:progress*this.max_width+"px"})};function Preroll(preview,enable){if(!enable)return this;if(typeof enable=="object")this.opt=enable;this.preview=preview}Preroll.prototype.show=function(){if(!this.preview)return;var opt=this.opt;if(opt&&(!opt.live_only||this.preview.is_live)){this.logo=document.createElement("div");$(this.logo).addClass("hola_preroll_img");var img=document.createElement("img");img.src=opt.img_href;$(this.logo).addClass("hola_preroll_img_img");this.logo.appendChild(img);this.preview.container.appendChild(this.logo);this.hide_timer=setTimeout(function(){this.hide()}.bind(this),opt.duration||2e3);return}this.logo=document.createElement("div");$(this.logo).addClass("hola_preroll");this.preview.container.appendChild(this.logo)};Preroll.prototype.end=function(){if(!this.logo)return;if(this.opt)return;var _this=this;$(this.logo).addClass("hola_preroll_end");setTimeout(function(){if(_this.logo&&+$(_this.logo).css("opacity")==0)_this.hide()},2e3)};Preroll.prototype.hide=function(){clearTimeout(this.hide_timer);if(!this.logo)return;if($(this.logo).parent().length)$(this.logo).remove();delete this.logo};E.init_autoplay=function(opt){var list_to_play;var a_opt=E.conf.autoplay||{};var autoplay_videos_list=[];var popular_opt=E.conf.autoplay_popular;var always=popular_opt.enable&&!popular_opt.stop_on_action;var is_autoplay_video=function(p){var cache_url=E.previews_map[p.href]&&E.previews_map[p.href].cache_url;return cache_url&&p.get_url()&&(E.conf.autoplay_videos||[]).includes(cache_url)};var is_regular_autoplay=a_opt.enable||util.is_mobile;function autoplay_videos(){if(E.conf.show_purge_icon)return;var videos;if(!(videos=E.conf.autoplay_videos)||!videos.length)return;var list=E.previews.get_group("main").filter(function(p){return is_autoplay_video(p)&&p.in_viewport(true,opt.check_z_index)});if(popular_opt&&popular_opt.enable)list=list.slice(0,popular_opt.count);autoplay_videos_list.forEach(function(p){if(!list.includes(p))p.hide()});list.forEach(function(p){if(!p.active)p.show(null,always?"always":true)});autoplay_videos_list=list}function cancel_autoplay_videos(){autoplay_videos_list.forEach(function(p){p.hide()});autoplay_videos_list=[]}function play_preview(p){if(E.shows_modal_box)return void cancel_autoplay();var active=E.active_preview;if(active==p||active&&!p&&active.ignore_autoplay&&active.in_viewport(true)){return}cancel_autoplay();if(p&&is_autoplay_video(p))p=null;if(!p)return autoplay_videos();if(always)autoplay_videos();else cancel_autoplay_videos();E.active_preview=p;if(!util.is_mobile||!E.conf.navigate_on_hover_enabled)p.off("loop_restart",play_next).on("loop_restart",play_next);p.on("hide",cancel_autoplay);p.on("error",play_next);p.show(null,true)}function play_next(){if(!opt.update_interval&&a_opt.type==AUTOPLAY_SELECTOR)update();if(!list_to_play||list_to_play.length<2)return;var _list_to_play=list_to_play.filter(function(p){return(!p.was_error||p==E.active_preview)&&p.in_viewport(true,opt.check_z_index)});if(_list_to_play.length<2)return;var index=_list_to_play.indexOf(E.active_preview);index=++index%_list_to_play.length;play_preview(_list_to_play[index])}function cancel_autoplay(){var p;if(!(p=E.active_preview))return;p.off("loop_restart",play_next);p.off("hide",cancel_autoplay);p.off("error",play_next);p.hide();E.active_preview=undefined}var update=util.throttle(function(){if(!is_regular_autoplay)return void autoplay_videos();var main=E.previews.get_group("main");var p_list=main.filter(function(p){return p.get_url()});if(p_list.find(function(p){return p.active&&!p.autoplay}))return void cancel_autoplay();if(a_opt.type==AUTOPLAY_SELECTOR&&a_opt.selector){p_list=p_list.filter(function(p){return $(p.el).is(a_opt.selector)});if(p_list.length)init_autoload(p_list)}if(!p_list||!p_list.length)return void cancel_autoplay();list_to_play=p_list.filter(function(p){var entirely;if(a_opt.entirely!==undefined)entirely=a_opt.entirely;else{entirely=util.is_top||p.is_playlist_slide_tile||!p.is_preview_over_player_link&&!p.is_playlist_panel_link}return(opt.autoplay_el&&$(p.el).hasClass(opt.autoplay_el)||!opt.autoplay_el&&(!p.ignore_autoplay||p==E.active_preview&&p.is_playlist_panel_link)&&(a_opt.type==AUTOPLAY_SELECTOR||p.in_middle()))&&p.in_viewport(entirely,opt.check_z_index)});if(a_opt.type!=AUTOPLAY_SELECTOR&&!opt.autoplay_el){var is_area=a_opt.active_area;if(util.is_enabled(preview_debug))preview_debug.draw_debug_viewport(is_area);if(is_area){list_to_play=list_to_play.filter(function(p){return p.in_middle(is_area)})}}if(E.active_preview&&list_to_play.includes(E.active_preview))return;play_preview(list_to_play[0])},300);if(opt.autoplay_el)return void E.on("start_preview",update);if(util.is_mobile&&E.conf.scroll_pause){var scroll_timeout;on_scroll(function(){if(scroll_timeout)clearTimeout(scroll_timeout);if(E.active_preview)E.active_preview.pause();scroll_timeout=setTimeout(function(){if(E.active_preview)E.active_preview.resume()},500)})}E.off_autoplay=on_page_update(update,opt.update_interval);if(util.is_enabled(preview_debug)&&is_regular_autoplay&&a_opt.type!=AUTOPLAY_SELECTOR){preview_debug.draw_debug_viewport(a_opt.active_area)}};E.preload_preview=function(queue,opt){if(E.conf.mobile_wifi_only&&util.is_mobile_cellular_con())return void log.info("skip preload due to mobile cellular network");if(E.conf.preview_streaming&&util.is_safari)return void log.info("skip preload due to CSP");opt=opt||{};preload.queue=(preload.queue||[]).concat(queue);var preload_next=function(){if(preload.loading||preload.paused)return;if(!preload.queue.length)return void(preload.loading=null);var next=preload.queue.shift(),pctx={href:next.url};var video=E.video_cache.get(get_url.call(pctx),Preview._build_video_cache_opt(opt));if(video.loaded||video.error)return void preload_next();preload.loading=video;video.once("ready",function(){if(video.loaded){E.stats.inc_d("preload_loaded_n");video.preloaded=true}preload.loading=null;preload_next()});E.stats.inc("preload_load_n");video.start()};setTimeout(preload_next);E.on("loading",function(preview){pause_autoload(preview,{ctx:preload,cb:preload_next,name:"preload"})})};E.play_icon=function(preview,opt){opt=assign({},preview.opt,opt);var icon_opt={tr:opt.tr||t,countdown_on_hover:opt.countdown_on_hover,is_allowed:function(){if(opt.is_allowed)return opt.is_allowed();var p=E.previews_map[preview.href];return p&&(!p.error||p.error=="same_size"||p.error=="not ready")},pos:opt.pos||preview.get_position.bind(preview,true),icon_size_px:opt.icon_size_px,icon_size:opt.icon_size,shadow:true,icon_location:opt.icon_location,icon_margin:opt.icon_margin,get_margin:opt.get_margin,img:preview.img,img_pos:opt.img_pos||function(){return preview.get_position(!opt.icon_countdown)},icon_countdown:opt.icon_countdown,on_show:opt.on_show,on_hide:opt.on_hide,on_countdown_cancel:opt.on_countdown_cancel,container:preview.container,msg:E.spark.msg,on_navigate:opt.on_navigate,visibility_check_icon:opt.visibility_check_icon,check_z_index:opt.check_z_index};return new play_icon.Icon(icon_opt)};E.is_available=function(){if(util.is_ios){var os_ver=util.guess.version&&util.guess.version.split(".");os_ver=+(os_ver&&os_ver[0]);return!os_ver||os_ver>=10}return true};function add_mute(opt){var $=opt.$;var player=opt.player;var container=player.container;if(player.mute_btn)return;var div=player.mute_btn=document.createElement("div");div.style.position="absolute";
div.style.backgroundColor="#FFFFFF";div.style.padding="5px";div.style.left="10px";div.style.top="25px";div.style.fontSize="15px";div.style.zIndex=3;div.style.cursor="pointer";div.innerText="TAP TO UNMUTE";function is_ad(){return $(container).find(".powa-sell-bar").css("display")!="none"}function is_muted(){if(is_ad()){return $(container).find(".powa-sell-bar-unmute").css("display")!="none"}else return player.html5.muted}function show_hide(){if(is_muted())div.style.display="block";else div.style.display="none"}$(div).on("click",function(){player.html5.muted=false;div.style.display="none";if(!is_muted())return;if(is_ad())$(container).find(".powa-sell-bar-mute").trigger("click")});div.style.display="none";$(container).append(div);player.mute_interval=setInterval(show_hide,2500)}function mute_btn_add_player(player){add_mute({player:player,$:$})}function mute_btn_remove_player(player){if(!player.mute_btn)return;$(player.mute_btn).remove();player.mute_btn=undefined;clearInterval(player.mute_interval)}function init_mute_button(){if(!/spark_test_mute=1/.test(location.href))return;E.spark.players.on("attach",mute_btn_add_player);E.spark.players.on("add",mute_btn_add_player);E.spark.players.on("remove",mute_btn_remove_player);E.spark.players.forEach(mute_btn_add_player)}E.init=function(spark_modules,conf,spark){log=spark_modules.log;log.notice("preview init conf %o",conf);if(window.spark_video_previews&&window.spark_video_previews.disabled)return console.log("video preview disabled");perr=spark_modules.perr;E.spark=spark;E.spark_modules=spark_modules;E.links=spark_modules.links;E.watermark=spark_modules.watermark;t=l10n.get_t("video_previews");E.conf=conf;if(util.is_enabled(preview_debug))preview_debug.init(E);if(util.is_enabled(controls))controls.init(E,spark,E.spark_modules);if(E.conf.autoplay_preview_navigation)E.conf.link_tags.push({name:"spark_vp",type:"auto"});E.conf.debug=!!E.conf.debug||!!spark.conf.debug;E.conf.ext_info_enabled=util.has_ext&&E.conf.debug_ext;E.conf.blur=E.conf.blur.enable&&E.conf.blur;E.conf.preview_streaming=!E.conf.disable_streaming&&!E.conf.ext_info_enabled&&(!util.is_safari||E.conf.streaming_safari);E.conf.edit_ext=E.conf.edit_ext||spark.is_editor_mode;if(typeof E.conf.preview_on_touch=="function")E.preview_on_touch=E.conf.preview_on_touch({E:E,$:$});else E.preview_on_touch=E.conf.preview_on_touch;E.storage=E.spark_modules.storage;E.storage.set_leaf_max_stale("previews",week_sec);E.pixel_ratio=(E.conf.pixel_ratio=="max"?window.devicePixelRatio:Math.min(E.conf.pixel_ratio,window.devicePixelRatio))||1;E.cdn_host=E.conf.cdn_host||util.url2sparkorigin(E.spark.top_url);if(E.cdn_host&&!E.conf.available_sizes){E.conf.available_sizes=["160x90","200x112","252x142","310x174","412x232","534x300","640x360","768x432","828x466","1280x720"]}if(E.conf.modal_box.enable&&E.conf.modal_box.use_frame_url)E.spark.report_frame_video_progress=true;if(E.conf.promo&&util.is_enabled(promo))promo.init(E.conf.promo);init_mute_button();stats_init();apply_styles(E.conf);if(E.conf.preview_over_player.enable)init_preview_over_player(E.conf.preview_over_player);if(E.conf.autoload.enable)init_autoload();init_visibility_checks();if(E.conf.edit_ext&&util.is_enabled(editor))editor.init(E.spark,E,E.spark_modules);if(E.conf.check_lazy_img_load)E.stats.inc_d("lazy_img_load_init_n");play_icon.init();init_autoplay(E.conf);if(E.conf.autoplay.type==AUTOPLAY_SELECTOR)E.links.scan({allow_hidden:E.conf.autoplay.selector});if(E.conf.debug||E.conf.ext_info_enabled){E.links.on("update",E.on_force_update_links=force_update_links.bind(null,E.conf));force_update_links(E.conf)}else{E.links.on("update",E.on_update_links=update_links.bind(null,E.conf));E.links.on("update_db",E.on_update_links_db=update_links_db.bind(null,E.conf));update_links(E.conf);update_links_db(E.conf)}E.links.on("detach",function(detached){E.previews.destroy(detached)});if(E.conf.skip_autoplay_check)return E.can_autoplay="muted";autoplay_policy.can_autoplay(function(can,policy){E.can_autoplay=can;E._autoplay_policy=policy;E.stats.inc_d("can_play_"+can+"_n");if(!can)stop_autoload()});if(E.conf.feature_init)E.conf.feature_init({E:E,$:$})};if(util.is_mocha()){var uninit=function(){if(E.on_force_update_links)E.links.off("update",E.on_force_update_links);if(E.on_update_links)E.links.off("update",E.on_update_links);if(E.on_update_links_db)E.links.off("update_db",E.on_update_links_db);E.off("has_previews_db");E.off("preview_attr_update");E.off("scroll");E.off("loading");E.off("start_preview");E.off("try_activate");if(E.off_autoplay)E.off_autoplay();E.off_autoplay=null;if(E.off_visibility_checks)E.off_visibility_checks();E.off_visibility_checks=null;E.previews=new PreviewsController;E.previews_map=E.t.previews_map={};autoload=E.t.autoload={};E.video_cache.uninit()};E.t={uninit:uninit,previews_map:E.previews_map,Preview:Preview,get_previews:E.get_previews,get_new_links:get_new_links,get_transition_duration:get_transition_duration,autoload:autoload,PreviewsGroup:PreviewsGroup,PreviewsController:PreviewsController,stop_autoload:stop_autoload,replace_size_in_url:replace_size_in_url,size_from_url:size_from_url,update_preview_url:update_preview_url}}return E});
define("/svc/cdn/pub/feature/playlist/promo.js",["/svc/cdn/pub/promo_db.js","/svc/cdn/pub/promo_ui.js","/svc/cdn/pub/dom_util.js"],function(promo_db,promo_ui,dom_util){var E={};var promo_data;var stop_event=function(event){event.preventDefault();event.stopPropagation()};function PlaylistPromo(container,opt){this._db=opt&&new promo_db(opt)||promo_data;if(!this._db)return;this._container=container;this._state={idx:0};var _this=this;this._db.onready(function(){_this._playlist=_this._db.get_playlist();if(!_this._playlist||!_this._playlist.length)return;_this._check_state()})}PlaylistPromo.prototype.destroy=function(){if(this._ad)this._ad.destroy();dom_util.remove(this._el)};PlaylistPromo.prototype._next=function(){if(this._ad){this._ad.destroy();this._ad=null}this._state.idx++;if(this._state.idx>=this._playlist.length){this._state.idx=0;this._playlist=this._db.get_playlist()}this._check_state()};PlaylistPromo.prototype._create_ad=function(promo_opt){var _this=this;if(!this._el){this._el=document.createElement("div");["click","touchend"].forEach(function(ev_name){_this._el.addEventListener(ev_name,stop_event)});var rect=this._container.getBoundingClientRect();Object.assign(this._el.style,{left:0,top:0,overflow:"hidden",position:"absolute",width:rect.width?rect.width+"px":"100%",height:rect.height?rect.height+"px":"100%"});this._container.appendChild(this._el);this._container.removeAttribute("href")}this._ad=new promo_ui(this._el,promo_opt,Object.assign({disable_click_link:true,disable_click_destroy:true},E._opt));this._ad.on(promo_ui.events.STATE_CHANGE,function(state){if(state==promo_ui.states.ENDED||state==promo_ui.states.ERROR)_this._next()})};PlaylistPromo.prototype._check_state=function(){if(this._ad)return;var promo_opt=this._playlist[this._state.idx];if(!promo_opt)return;setTimeout(this._create_ad.bind(this,promo_opt),100)};E.create=function(tile,promo_opt){return new PlaylistPromo(tile,promo_opt)};E.init=function(opt){if(!opt||!opt.enable)return;E._opt=opt;promo_data=new promo_db(opt)};return E});
define("/svc/cdn/pub/widget.js",["cash","/svc/cdn/pub/util.js","/util/events.js","/svc/cdn/pub/play_icon.js","/util/url.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/l10n.js","/svc/cdn/pub/feature/playlist/promo.js","/svc/cdn/pub/perr.js"],function($,util,events,play_icon,zurl,dom_util,l10n,playlist_promo,perr){var assign=Object.assign,id="widget";var E={};var path="//ve-image-cdn.h-cdn.com/svc/preview/pub/img/";var wm_svg=path+"watermark.svg";var wm_transparent=path+"watermark-transparent.svg";var pr_countdown="hola_preview_navigate_on_hover_enabled";var pr_class="hola_widget_";var preload_css=function(){var loaded=false;return function(){if(loaded)return;loaded=true;dom_util.preload_css(util.player_url+require.zdot("widget_css"))}}();function add_powered_by_btn(root,opt){if(!opt.add_powered_logo)return;var link,el,create=create_el.bind(this,pr_class);link=create("a","powered_text");var img=E.create_img("hola_widget_powered_by_logo");link.append(img.create(wm_transparent)).attr("href","http://holaspark.com?cam=wm_"+id+"_"+E.spark.customer).attr("target","_blank").append($("<div>").text(l10n.spark_t("powered_by_text")));el=create("div","powered");root.append(el.append(create("div","powered_info").append(link)));return el}function add_watch_later(res){if(!E.spark.is_feature_inited("watch_later"))return;E.spark.features.watch_later.module.storage.set(res.url,res)}function create_el(base,el,cl){return $("<"+el+">").addClass(base+(cl||""))}function format_sec(sec){sec=Math.round(sec);var s=sec%60;var min=Math.floor(sec%3600/60);var hour=Math.floor(sec/3600);return(hour?pad(hour,2)+":":"")+pad(min,2)+":"+pad(s,2)}function get_scroll_parent(node){var style=getComputedStyle(node);var ex_static=style.position=="absolute";var overflow_re=/(auto|scroll)/;if(style.position=="fixed")return document.body;for(var parent=node;parent=parent.parentElement;){style=getComputedStyle(parent);if(ex_static&&style.position=="static")continue;if(overflow_re.test(style.overflow+style.overflowY+style.overflowX))return parent}return document.body}function get_source(res){return res.source||zurl.get_host(E.spark.top_url).replace(/^www\./,"")}function pad(num,size){return("000"+num).slice(-size)}function play_next(next,is_click){if(this.opt.handlers.play_next)return void this.opt.handlers.play_next(next,is_click);if(this.opt.events.play_next)this.opt.events.play_next(next,is_click);this.log.debug("switching to another video");this.stats.inc(is_click?"next_click_n":"next_autoplay_n");var page_url;if(!(page_url=next.url||next.page_url||next.location))return;if(this.opt.events.next_url)this.opt.events.next_url(next,is_click);var _this=this;return void setTimeout(function(){window.top.location.href=_this.get_link_url(page_url)},0)}function sec_to_dur(s){return util.date_ms_to_dur(s*1e3).replace(/^00:/,"")}function set_div_size(div,opt){var rows=opt.rows||"auto",cols=opt.cols||"auto";if(rows!="auto"&&cols!="auto")return void assign(opt,{cols:cols,rows:rows});var dsize,tsize=opt.size;dsize={width:$(div).width(),height:$(div).height()};var add=function(num,key,skey,border){opt[key]=num=="auto"?Math.floor(dsize[skey]/(tsize[skey]+border)):num};add(cols,"cols","width",4);add(rows,"rows","height",4)}util.inherits(Window,events.EventEmitter);function Window(_id,opt){this.id=_id;this.opt=opt;this.active=true;this._render()}Window.prototype.bind_events=function(){var _this=this;this.close.on("click",function(){_this.emit("close")})};Window.prototype.destroy=function(){if(!this.active)return;this.active=false;this.view.remove()};Window.prototype.get_container=function(){return this.container};Window.prototype.get_view=function(){return this.view};Window.prototype.get_drag_area=function(){return this.view};Window.prototype._render=function(){var size=assign({width:"600px",height:"450px"},this.opt.div_size);var view=$("<div>").addClass("hola_widget_view");var container=$("<div>").addClass("hola_widget_container").css({width:size.width,height:size.height});var title=$("<div>").addClass("hola_widget_title").text(this.opt.title||"Videos");view.append(title);this.close=$("<div>").addClass("hola_widget_view_close");view.append(this.close);view.append(container);this.container=container;this.view=view};function Composer(){this.window_id=0;this.windows=[];this.wopt={};this.has_overlay=false}Composer.prototype.create_window=function(opt){if(!this.has_overlay)this._create_overlay();var w=new Window(++this.window_id,opt);this.windows.push(w);var view=w.get_view();$(view).css({display:"block",position:"absolute"});this.overlay.append(view);$(view).css({top:"50%",left:"50%","margin-left":"-"+Math.floor($(view).width()/2)+"px","margin-top":"-"+Math.floor($(view).height()/2)+"px"});this.wopt[w.id]={};this.wopt[w.id].handlers={close:this._window_close.bind(this,w),mousedown:this._window_mousedown.bind(this,w),mouseup:this._window_mouseup.bind(this,w),mousemove:this._window_mousemove.bind(this,w)};w.on("close",this.wopt[w.id].handlers.close);var area=w.get_drag_area();area.on("mousedown",this.wopt[w.id].handlers.mousedown);w.bind_events();this._update_zindex();return w.get_container()};Composer.prototype._create_overlay=function(){this.overlay=$("<div>").addClass("hola_widget_overlay");$(document.body).append(this.overlay);this.has_overlay=true;var _this=this;this.overlay.on("click",function(event){if(event.target==_this.overlay.get(0))_this._destroy()})};Composer.prototype._destroy=function(){var _this=this;this.windows.forEach(function(w){_this._window_close_int(w)});$(this.overlay).remove();this.has_overlay=false;this.window_id=0};Composer.prototype._update_zindex=function(w){this.windows.push(this.windows.splice(this.windows.indexOf(w),1)[0]);for(var i in this.windows)this.windows[i].get_view().css({"z-index":i+1})};Composer.prototype._window_close=function(w){this._window_close_int(w);if(!this.windows.length)this._destroy()};Composer.prototype._window_close_int=function(w){var area=w.get_drag_area();var handlers=this.wopt[w.id].handlers;this.overlay.off("mousemove",handlers.mousemove);this.overlay.off("mouseup",handlers.mouseup);area.off("mousedown",handlers.mousedown);w.off("close",handlers.close);delete this.wopt[w.id];w.destroy();this.windows.splice(this.windows.indexOf(w),1)};Composer.prototype._window_mousedown=function(w,event){if(this.wopt[w.id].drag_start)return;this.overlay.on("mousemove",this.wopt[w.id].handlers.mousemove);this.overlay.on("mouseup",this.wopt[w.id].handlers.mouseup);this.wopt[w.id].drag_start={x:event.screenX,y:event.screenY};this._update_zindex(w)};Composer.prototype._window_mouseup=function(w,event){if(!this.wopt[w.id].drag_start)return;this.overlay.off("mousemove",this.wopt[w.id].handlers.mousemove);this.overlay.off("mouseup",this.wopt[w.id].handlers.mouseup);var pos={x:event.screenX,y:event.screenY};var drag_start=this.wopt[w.id].drag_start;this._window_move(w,pos.x-drag_start.x,pos.y-drag_start.y);this.wopt[w.id].drag_start=null};Composer.prototype._window_mousemove=function(w,event){var pos={x:event.screenX,y:event.screenY};var drag_start=this.wopt[w.id].drag_start;this._window_move(w,pos.x-drag_start.x,pos.y-drag_start.y);this.wopt[w.id].drag_start=pos};Composer.prototype._window_move=function(w,dx,dy){var pos=this.wopt[w.id].pos||(this.wopt[w.id].pos={x:0,y:0});pos.x+=dx;pos.y+=dy;w.get_view().css({transform:"translate("+pos.x+"px, "+pos.y+"px)"})};Composer.get=function(){var composer;return function(){return composer=composer?composer:new Composer}}();util.inherits(Widget,events.EventEmitter);function Widget(pl,div,opt){opt=assign({events:{},handlers:{},autoclick:{}},opt);E.spark=opt.spark;if(!E.t)E.t=l10n.get_t(id);this.opt=opt;opt.size=opt.size||{width:190,height:130};if(!opt.skip_default_menu&&E.spark.is_feature_inited("watch_later")){(opt.menu||(opt.menu=[])).push({title:this.t("add_to_watch_later"),handler:function(item,props){add_watch_later({url:props.page_url,img:props.poster||props.video_poster,title:util.str_longest(props.description,props.title)})}})}this.div=div?$(div):Composer.get().create_window(opt);set_div_size(this.div,opt);this.log=opt.log||{debug:function(){},info:function(){}};this.stats=opt.stats||{inc:function(){}};this.pl=pl||[];this.tiles=[];this.rtl=opt.rtl;this.img=E.create_img("hola_widget_poster_img");if(this.rtl===undefined)this.rtl=dom_util.detect_direction(this.div[0])=="rtl";this.inited=true;this._history_init();this.render()}E.Widget=Widget;E.Widget.prototype.t=function(text,opt){var strings=this.opt.strings||{};if(!strings[text])return E.t(text,opt);if(typeof strings[text]=="string")return strings[text];return strings[text](opt)};E.Widget.prototype.mark_played=function(){if((this.opt.autoclick||{}).type=="loop")return;var h=this.history;this.pl.forEach(function(el){if(h.page_url[el.page_url]||h.url_key[el.url_key])el.played=true})};E.Widget.prototype.get_next=function(){var opt=this.opt.autoclick||{},pl=this.pl,type=opt.type;if(!opt.enable||!pl.length)return;if(type=="tile"){if(opt.tile!==undefined||pl.find(function(e){return!e.played&&!e.is_static})){return pl[opt.tile||0]}type="random"}if(type=="random"){var f=pl.filter(function(e){return!e.is_static});if(!f.length)f=pl;return f[Math.floor(Math.random()*f.length)]}pl=pl.filter(function(e){return!e.played});var idx=0;var len=pl.length,pos=this._get_cursor_pos();if(pos==idx)idx++;idx=len?idx%len:0;return pl[idx]};E.Widget.prototype.it_list=function(){if(!this.inited)return;this.hola_widget_main.addClass("hola_widget_list");this.pl.forEach(this.render_list_item.bind(this));var root=$(get_scroll_parent(this.hola_widget_main.get(0)));var _this=this;this.scroll_root=root;this.load_more_et=null;this.scroll_fn=util.throttle(function(){if(_this.load_more_et)return;var h=root.height(),sh=root.get(0).scrollHeight;var st=root.get(0).scrollTop;if(sh-st-h<=250){_this.scroll_root.off("scroll",_this.scroll_fn);if(_this.opt.load_more_fn){_this.opt.load_more_fn(function(res){if(!res)return;_this.pl=res;_this.it_list()})}}},200);root.on("scroll",this.scroll_fn);this.scroll_fn()};E.Widget.prototype.get_link_url=function(url){return url&&E.spark.gen_page_url(url,this.opt.link_tags||[])};E.Widget.prototype.render_list_item=function(res){var meta=[],opt=this.opt,t=E.t,_this=this;if(!opt.skip_author)meta.push(get_source(res));if(res.total)meta.push(t("item_views",{num:util.scaled_number(res.total)}));if(res.ts)meta.push(l10n.time_ago(res.ts));var p=res.poster||res.video_poster||"";var d=util.str_longest(res.description,res.title);var cl_prefix="hola_widget_list_item";var create=create_el.bind(this,cl_prefix);var r=create("a").attr({"data-watch-later-item":1,"data-spark_preview_link":"","data-spark_feature":"widget",href:this.get_link_url(res.page_url||res.location)||"#"});var img=create("div","_poster_img").css({"background-image":"url('"+p+"')"}).attr({"data-spark_preview_img":"","data-spark_preview_img_src":p});if(!opt.hide_duration&&res.dur)img.append(create("div","_duration").text(format_sec(res.dur)));var poster_div=create("div","_poster");if(res.video_poster){poster_div.css({background:"url("+res.video_poster+") no-repeat #fff","background-size":"100% 100%"})}r.append(create("div","_poster_wrap").append(poster_div.append(img)));var desc_wrap=create("div","_description_wrap");var meta_div=create("div","_meta");for(var i=0;i<meta.length;i++)meta_div.append(create("div","_meta_item").text(meta[i]));r.append(desc_wrap.append(create("div","_title").text(util.str_trunc(d||"",50))).append(meta_div).append(create("div","_description").text(res.description||"")));r.on("click",function(event){event.preventDefault();event.stopPropagation();play_next.call(_this,res,true)});E.set_preview_url(r,res,opt);var item=create("div","_wrap").append(r);var m;var _opt={dom:item,remove:function(){$(item).remove();if(_this.opt.events.item_remove)_this.opt.events.item_remove(res)}};if(opt.menu){m=create("div","_menu").html('<div class="'+cl_prefix+'_menu_btn_wrap">'+'<button class="'+cl_prefix+'_menu_btn"></button>'+"</div>");var ul=$("<ul>");opt.menu.forEach(function(menu_item){var li=$("<li>").text(menu_item.title).on("click",menu_item.handler.bind(menu_item,_opt,res));ul.append(li)});m.append(ul);desc_wrap.append(m)}if(opt.actions){m=create("div","_actions");opt.actions.forEach(function(menu_item){var div=$("<div>").attr("title",menu_item.title).addClass(menu_item.class_name).on("click",menu_item.handler.bind(menu_item,_opt,res));m.append(div)});desc_wrap.append(m)}var actions=item.find(".hola_widget_list_item_actions");actions.on("click",function(event){event.preventDefault();event.stopPropagation()});var menu=item.find(".hola_widget_list_item_menu");menu.on("click",function(event){event.preventDefault();event.stopPropagation();_this.hola_widget_main.find(".hola_widget_list_item_menu_visible").removeClass("hola_widget_list_item_menu_visible").filter(function(elem){return elem!=menu.get(0)}).find("ul").css("display","none");menu.addClass("hola_widget_list_item_menu_visible");var _ul=menu.find("ul");_ul.css("display",_ul.css("display")=="block"?"none":"block")});img.on("error",function img_on_error(){img.off("error",img_on_error);img.attr("src",wm_svg);img.css("object-fit","contain")});item.find("a").prop("data-watch-later-conf",{position:"tl",margin:{x:2,y:2},z_index:"auto",pos_elem_sel:""});this.hola_widget_main.append(item);if(this.opt.events.item_add)this.opt.events.item_add(res)};E.Widget.prototype.it_tiles=function(size,cb){var pl=this.pl,opt=this.opt,row=opt.rows;var ts,off={top:0,left:0},col=opt.cols;var tborder=this.opt.tborder||4,lborder=this.opt.lborder||4;function get_len(pl_len){var len=row*col;while(len){if(pl_len>=len)return len;len-=col;row--;if(row<opt.min_rows)return 0}}if(opt.skip_small&&!get_len(pl.length))return this.stats.inc("small_playlist_n");var btn_size=0;if(opt.add_play_button)btn_size=opt.play_button_size||48;ts={width:Math.round((size.width-lborder*(col+1))/col),height:Math.round((size.height-btn_size-tborder*(row+1))/row)};for(var i=0;i<row;i++){var top=off.top+i*tborder+i*ts.height+tborder;for(var j=0;j<col;j++){if(pl.length<=i*col+j)return;cb.apply(this,[i*col+j,{top:top,height:ts.height,width:ts.width,left:off.left+j*lborder+j*ts.width+lborder}])}}if(btn_size){btn_size={top:size.height-btn_size-tborder,left:Math.round(lborder/2),width:btn_size,height:btn_size};cb.call(this,"play_btn",btn_size)}};E.Widget.prototype.update=function(){if(!this.div)return;var size={width:this.div.width(),height:this.div.height()};if(this.size.width!=size.width||this.size.height!=size.height){this.size=size;this.it_tiles(this.size,this.update_tile)}setTimeout(this.update.bind(this),500)};E.Widget.prototype.update_tile=function(idx,size){var tile;if(idx=="play_btn")return this._update_play_btn(idx,size);if(!(tile=this.tiles[idx]))return;tile.css({top:size.top+"px",left:size.left+"px",height:size.height+"px",width:size.width+"px"});var icon=tile.find(".hola_preview_icon");if(icon.length){var w=icon.width();icon.css({top:(size.height-w)/2+"px",left:(size.width-w)/2+"px"})}};E.Widget.prototype.add_hover=function(tile){if(!tile.poster)return;var _this=this;var update=function(){if(tile.poster.hasClass("hola_preview_countdown"))tile.addClass("hola_widget_tile_hover");if(tile.rm_hover)return;tile.rm_hover=setTimeout(function(){if(tile.poster.hasClass("hola_preview_playing")||tile.poster.hasClass("hola_preview_countdown")){tile.addClass("hola_widget_tile_hover")}},_this.opt.hover_anim_time*1e3)};tile.wait_fn=function(start){if(tile.rm_hover)tile.rm_hover=clearTimeout(tile.rm_hover);if(tile.unwatch_class)tile.unwatch_class=tile.unwatch_class();tile.removeClass("hola_widget_tile_hover");if(!start)return;tile.unwatch_class=dom_util.attr_watch(tile.poster[0],{attr:"class",watch_fn:update});update()};tile.hover_fn=function(){tile.wait_fn(true);tile.on("mousemove",tile.move_fn)};tile.unhover_fn=function(){tile.wait_fn();tile.off("mousemove",tile.move_fn)};tile.move_fn=function(){if(!tile.poster.hasClass("hola_preview_countdown"))tile.wait_fn(true)};tile.on("mouseenter",tile.hover_fn);tile.on("mouseleave",tile.unhover_fn)};E.Widget.prototype.create_tile=function(next,idx){var link,opt=this.opt,create=create_el.bind(this,pr_class);var tile=opt.disable_link_tile||!(link=next.url||next.page_url)?create("div","tile"):create("a","tile").attr("href",this.get_link_url(link));var _this=this,stats_inc=_this.opt.handlers.stats_inc;this.on_link_click=function(e){if(e.type=="contextmenu"||!_this._is_ctrl_click(e)){if(opt.handlers.on_context_menu&&e.type=="contextmenu")opt.handlers.on_context_menu(e,tile,idx,next,opt);return e.preventDefault()}if(!stats_inc)return;["next_click_n","next_middle_click_n","next_url_n"].forEach(function(name){stats_inc(name,_this.type,_this.opt._state)})};["click","auxclick","contextmenu"].forEach(function(name){tile.on(name,_this.on_link_click)});return tile};E.Widget.prototype.render_play_btn=function(idx,topt){var el=create_el(pr_class,"div",idx);this.play_btn=this.icon_show(el,false,topt,{size_px:topt});this._update_play_btn(idx,topt);this.hola_widget_main.append(el)};E.Widget.prototype.render_tile=function(idx,size){if(idx=="play_btn")return this.render_play_btn(idx,size);var info=$("<span>").addClass("hola_widget_info");var itop=$("<div>").addClass("hola_widget_info_top");var opt=this.opt,next=this.pl[idx];var tile=this.create_tile(next,idx);tile.css({top:size.top+"px",left:size.left+"px",height:size.height+"px",width:size.width+"px"});tile.attr("pl_idx",idx);if(playlist_promo&&!playlist_promo.__stub&&next.type=="promo"){this.hola_widget_main.append(tile);this.tiles.push(tile);this.promo=playlist_promo.create(tile[0],next.promo);return}if(opt.add_dbg_info)opt.add_dbg_info(tile,next,opt);var css=opt.css||{};if(next.poster){tile.img=this.img.create(next.poster,next);tile.img.attr("data-spark_preview_img","");var poster=tile.poster=$("<div>").addClass("hola_widget_poster").attr("data-spark_feature","widget").attr("data-spark_preview_link","");poster.attr("data-spark_preview_page_url",next.url||next.page_url);poster.attr("spark_video_title",util.str_longest(next.title,next.description));poster.prop("data-watch-later-conf",{position:this.rtl?"tl":"tr",margin:{x:2,y:2},z_index:"auto",pos_elem_sel:""});E.set_preview_url(poster,next,opt);tile.append(poster.append(tile.img))}if(next.description){itop.append($("<div>").addClass("hola_widget_description").text(next.description))}if(css.font_size)info.css({"font-size":css.font_size+"px"});if(opt.show_play_icon)this.icon_show(tile,false,size);if(!opt.hide_views&&next.total)this.views_show(itop,size,next.total);info.append(itop);if(!opt.hide_duration&&next.dur)this._duration_show(info,size,next.dur);if(opt.show_info)info.addClass("hola_widget_info_static");if(opt.show_category&&next.category){var category=$("<div>").addClass("hola_widget_category");category.css("display","none");category.attr("category",next.category);category.text(next.category);tile.append(category)}this.hola_widget_main.append(tile.append(info));this.tiles.push(tile);if(!opt.disable_info_hide)this.add_hover(tile)};E.Widget.prototype.render=function(){this.log.debug("widget render");this.hola_widget_main=$("<div>").addClass("hola_widget_main");this.div.append(this.hola_widget_main);this.div.addClass("hola_widget hola_top_element");add_powered_by_btn.call(this,this.div,this.opt);if(this.rtl)this.div.addClass("hola_widget_rtl");this.stats.inc("popup_n");if(this.opt.events.show)this.opt.events.show();this.size={width:this.div.width(),height:this.div.height()};this.mark_played();this.next=this.get_next();if(this.opt.mode=="list")this.it_list();else{this.it_tiles(this.size,this.render_tile);var el;if((el=this.pl.indexOf(this.next))!=-1&&!isNaN(+(this.opt.autoclick||{}).timeout)){el=this.tiles[el];this.icon_show(el,true,{width:el.width(),height:el.height()})}this.update();this._bind_events()}};E.Widget.prototype.views_show=function(root,pos,views){if(pos.width<this.opt.size.width/2)return;var text=this.t("item_views",{num:this.opt.views_count(views||0)});root.append($("<div>").addClass("hola_widget_views").text(text))};E.Widget.prototype.icon_show=function(tile,is_countdown,size,iopt){var _this=this,autoclick=this.opt.autoclick;var pos={top:0,left:0,height:size.height,width:size.width};var opt={tr:this.t.bind(this),is_allowed:function(){return true},pos:pos,shadow:true,icon_location:"center",img:tile.img,img_pos:pos,icon_countdown:is_countdown,container:tile,disable_visibility_check:this.opt.disable_visibility_check,is_top:util.is_top,msg:E.spark.msg};if(is_countdown){var on_navigate=function(){play_next.call(_this,_this.pl[+tile.attr("pl_idx")],false)};var cancel=function(){if(autoclick.on_cancel_autoclick)autoclick.on_cancel_autoclick()};var on_show=function(){tile.addClass("hola_widget_next_countdown");_this.on_countdown(true)};var on_hide=function(){tile.removeClass("hola_widget_next_countdown");_this.on_countdown();if(tile.poster)tile.poster.data(pr_countdown,false)};assign(opt,{on_countdown_cancel:cancel.bind(this),on_show:on_show,countdown_on_hover:autoclick.timeout,on_hide:on_hide,on_navigate:on_navigate})}var icon;this.icons=this.icons||[];this.icons.push(icon=new play_icon.Icon(assign(opt,iopt)));return icon};E.Widget.prototype.on_countdown=function(is_shown){var click=this.opt.autoclick||{};if(!click.navigate_on_hover_enabled)return;this.tiles.forEach(function(e){if(e=e.poster)e.data(pr_countdown,!is_shown)})};E.Widget.prototype.uninit=function(){if(!this.inited)return;if(this.uninit_fn)this.ctx.off("widget_hide",this.uninit_fn);this.hola_widget_main.off("click",this.on_main_fn);if(this.on_play_fn)this.play_btn.container.off("click",this.on_play_fn);this._cancel_event(this.hola_widget_main,"off",["mouseup","pointerup"]);if(this.icons){this.icons.forEach(function(e){e.hide()});this.icons=undefined}var _this=this;this.tiles.forEach(function(e){if(_this.on_link_click){["click","auxclick","contextmenu"].forEach(function(name){e.on(name,_this.on_link_click)})}if(!e.wait_fn)return;e.wait_fn();e.off("mousemove",e.move_fn);e.off("mouseenter",e.hover_fn);e.off("mouseleave",e.unhover_fn)});if(this.scroll_root)this.scroll_root.off("scroll",this.scroll_fn);this.div.removeClass("hola_widget hola_top_element");this.div.empty();this.div=this.hola_widget_main=undefined;this.img.uninit();if(this.promo){this.promo.destroy();this.promo=null}this.inited=false};E.Widget.prototype._bind_events=function(){this.on_main_fn=function(e){var idx,cl="hola_widget_tile",tile=$(e.target);if(!tile.hasClass(cl))tile=tile.parents("."+cl);if(!tile.length||this._is_ctrl_click(e))return;e.preventDefault();e.stopPropagation();idx=+tile.attr("pl_idx");play_next.call(this,this.pl[idx],true)}.bind(this);this.hola_widget_main.on("click",this.on_main_fn);if(this.play_btn&&this.opt.handlers.play){this.on_play_fn=function(e){e.preventDefault();e.stopPropagation();this.opt.handlers.play()}.bind(this);this.play_btn.container.on("click",this.on_play_fn)}this._cancel_event(this.hola_widget_main,"on",["mouseup","pointerup"])};E.Widget.prototype._cancel_event=function(el,type,evts){this.on_cancel_event=this.on_cancel_event||function(e){e.stopImmediatePropagation();e.preventDefault()};var _this=this;evts.forEach(function(e){el[type](e,_this.on_cancel_event)})};E.Widget.prototype._duration_show=function(root,pos,sec){if(pos.width<this.opt.size.width/2)return;root.append($("<div>").addClass("hola_widget_duration").text(sec_to_dur(sec)))};E.Widget.prototype._get_cursor_pos=function(){var page_url=E.spark.get_top_url();var p=(this.opt.autoclick||{}).player,url_key=p&&p.url_key;var pl=this.pl;for(var i=0;i<pl.length;i++){var url=pl[i].url||pl[i].page_url||pl[i].url_key;if(url==page_url||url==url_key)return i}};E.Widget.prototype._history_init=function(){var key;var history=E.spark.history&&E.spark.history.data||[];var _this=this;this.history={page_url:{},url_key:{}};history.forEach(function(e){if(e.page_url)_this.history.page_url[e.page_url]=e;if(key=e.url_key||e.cache_url)_this.history.url_key[key]=e})};E.Widget.prototype._is_ctrl_click=function(e){return e.ctrlKey||e.shiftKey||e.metaKey||e.button&&e.button==1};E.Widget.prototype._update_play_btn=function(idx,topt){if(!this.play_btn)return;this.play_btn.container.css({position:"absolute",left:topt.left+"px",width:topt.width+"px",height:topt.height+"px",top:topt.top+"px"});var pos=util.pick(topt,"width","height");this.play_btn.update_pos({pos:pos,img_pos:pos,size_px:pos.height})};E.set_preview_url=function(el,next,opt){opt=opt||{};var url,type,disable_preview=opt.skip_preview||next.disable_preview;if(!disable_preview)url=next.orig_url||next.url||next.video_url||next.page_url;el.attr("data-spark_feature","playlist").attr("data-spark_preview_page_url",url?util.absolute_uri(url):"").attr("data-spark_preview_link","");if(type=next.media_info&&next.media_info.video_type)el.attr("data-hola-video-type",type);var autoclick=opt.autoclick||{};if(autoclick.navigate_on_hover_enabled){["navigate_on_hover_enabled","countdown_on_hover","navigate_on_hover_sec"].forEach(function(e){el.data("hola_preview_"+e,autoclick[e])})}if(!disable_preview&&(url=next.video_url))el.attr("data-spark_preview_video_url",util.absolute_uri(url))};E.create_img=function(cl){var reported,imgs=[];if(!(reported=E.create_img.reported))reported=E.create_img.reported={};return{create:function(url,info){var div=$("<div>").addClass(cl);div.css({"background-image":"url('"+url+"')"}).attr("data-spark_preview_img","").attr("data-spark_preview_img_src",url).attr("data-spark-src",url);if(!info||!info.url_md5||!util.is_chrome)return div;var on_error=function(e){if(reported[info.url_md5])return;perr({id:"widget_poster_error",delay:false,info:{poster_url:url,url_md5:info.url_md5}});reported[info.url_md5]=true};var img=$("<img>").css({display:"none"}).attr("src",url).on("error",on_error);imgs.push({el:img,cb:on_error});return div.append(img)},uninit:function(){imgs.forEach(function(e){e.el.off("error",e.cb)})}}};E.init=function(){preload_css();play_icon.init()};return E});
define("/svc/cdn/pub/feature/watch_later/index.js",{__stub:1});
define("/svc/cdn/pub/feature/position_memory/index.js",{__stub:1});
define("/svc/cdn/pub/feature/playlist/editor.js",{__stub:1});
define("/svc/cdn/pub/feature/playlist/util.js",["cash","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/util.js"],function($,dom_util,util){var E={};var assign=Object.assign;var pr_class="hola_playlist_";var cancel_click_events=["mousedown","pointerdown","mouseup","pointerup"];var styles={600:{pbottom_css:{padding:"0 12px 12px"},pdesc_css:{"font-size":"12px"},pdur_css:{"font-size":"10px"},plabel_css:{"font-size":"12px"},plabel_info_css:{"min-width":"20px"},plabel_type_css:{"min-width":"20px"}},700:{pbottom_css:{padding:"0 14px 14px"},pdesc_css:{"font-size":"14px"},pdur_css:{"font-size":"12px"},plabel_css:{"font-size":"14px"},plabel_info_css:{"min-width":"30px"},plabel_type_css:{"min-width":"30px"}},900:{pbottom_css:{padding:"0 16px 16px"},pdesc_css:{"font-size":"16px"},pdur_css:{"font-size":"14px"},plabel_css:{"font-size":"16px"},plabel_info_css:{"min-width":"60px"},plabel_type_css:{"min-width":"60px"}}};E.fscreen_zindex=2147483647;E.wm_url="//ve-image-cdn.h-cdn.com/svc/preview/pub/img/watermark-transparent.svg";E.add_rm_fs_listener=function(remove,cb){var f=remove?"removeEventListener":"addEventListener";["","webkit","ms","moz"].forEach(function(e){document[f](e+"fullscreenchange",cb)})};E.cancel_event=function(el,type,evts){evts=evts||cancel_click_events;this.on_cancel_event=this.on_cancel_event||function(e){e.stopImmediatePropagation();e.preventDefault()};var _this=this;evts.forEach(function(e){el[type](e,_this.on_cancel_event)})};E.create_el=function(base,el,cl){return $("<"+el+">").addClass(base+(cl||""))};E.create_tile=function(next,stats_inc){var link,opt=this.opt;var create=E.create_el.bind(this,pr_class);var tile=opt.disable_link_tile||!(link=!this.ctx.is_inline()&&next.url||next.page_url)?create("div","tile "+pr_class+"ptile"):create("a","tile "+pr_class+"ptile").attr("href",link);var _this=this;this.on_link_click=function(e){if(e.type=="contextmenu"||!E.is_ctrl_click(e)){if(e.type=="contextmenu")_this.ctx.emit("info_show",e);return e.preventDefault()}["next_click_n","next_middle_click_n","next_url_n"].forEach(function(name){stats_inc(name,_this.type,_this.opt._state)})};["click","auxclick","contextmenu"].forEach(function(name){tile.on(name,_this.on_link_click)});return tile};E.get_container_pos=function(ctx,use_video,get_max){var pos,c=$(ctx.container),v=E.get_video(ctx);function get_pos(a,b,offset){var p=offset&&a.offset()||{};p.width=Math.round(Math.max(a.width(),b?b.width():0));p.height=Math.round(Math.max(a.height(),b?b.height():0));return p}if(get_max&&v.length)pos=get_pos(c,v,true);else{if(!use_video)pos=get_pos(c,undefined,true);if(v.length&&(use_video||!pos.height||!pos.width))pos=assign({},pos,get_pos(v,undefined,use_video))}return pos||{}};E.get_frame_container=function(ctx,opt){return dom_util.is_fullscreen()&&(!ctx.ended||ctx.ended&&!opt.use_container_on_end)?E.get_video(ctx):ctx.container};E.get_popup_size=function(dsize,opt){var conf=opt.pnext_conf,size=conf.size;return conf.min_width>dsize.width?size.min:util.is_mobile?size.mobile:size.def};E.get_video=function(ctx){var c=$(ctx.container),v=ctx.controls.get_ui().media;return v?$(v):c[0].tagName=="VIDEO"?c:c.find("video")};E.get_widget_conf=function(conf,size){var i,s=Object.keys(styles).sort(function(a,b){return a-b});for(i=0;i<s.length;i++){if(size.width<=s[i])break}i=Math.min(i,s.length-1);return assign({},styles[s[i]],conf)};E.is_ctrl_click=function(e){return e.ctrlKey||e.shiftKey||e.metaKey||e.button&&e.button==1};E.is_visible=function(el){return!!(el[0]&&el.css("display")!="none"&&el.css("opacity")!="0"&&el.css("visibility")!="hidden")};E.on_fullscreen=function(e){var s={};e=e||{is_fullscreen:dom_util.is_fullscreen()};if(this.opt.set_z_index)this.opt.set_z_index({s:s,E:E,e:e,_this:this,$:$});else s["z-index"]=e.is_fullscreen?E.fscreen_zindex:this.opt.zindex+1;$(this.root).css(s)};E.sec_to_dur=function(s){return util.date_ms_to_dur(s*1e3).replace(/^00:/,"")};E.show_element=function(el,show){el.css("display",show||show===undefined?"block":"none")};E.Popup=Popup;function Popup(){}Popup.prototype.add_css_element=function(root,el,type){var conf=this.conf,key=type+"_css";if(conf[key])el.css(conf[key]);root.append(el)};Popup.prototype.set_bg_color=function(el,name){var color;if(color=this.conf[name])el.css({"background-color":color})};Popup.prototype.draw_label=function(root,next,_pr_class){var type,el,s;var create=E.create_el.bind(this,_pr_class);if(!(type=next.type))return;var label=create("div","label "+_pr_class+"label_"+type);if(type=="rank"){el=create("div","label_info").text("#"+next.rank);this.add_css_element(label,el,"plabel_info");this.set_bg_color(el,type+"_bgcolor")}this.add_css_element(root,label,"plabel");el=create("div","label_type");if(s=next.type_str?next.type_str:["hot","new","rank"].includes(type)?this._t(type):""){el.text(s)}this.add_css_element(label,el,"plabel_type");this.set_bg_color(el,type+"_bgcolor")};return E});
define("/svc/cdn/pub/feature/playlist/suggestion_btn.js",["cash","/svc/cdn/pub/feature/playlist/util.js","/svc/cdn/pub/dom_util.js"],function($,playlist_util,dom_util){var pr_class="hola_playlist_";var cancel_click_events=["mousedown","pointerdown","mouseup","pointerup"];var E=SuggestionButton;var stats;function SuggestionButton(playlist,opt){this.playlist=playlist;this.container=playlist_util.get_frame_container(playlist,opt);this.controls=playlist.controls;this.type="sugg_btn";this.conf=opt[this.type+"_conf"];this.opt=opt;this.inited=true;this.on_active=this.set_active.bind(this,true);this.on_inactive=this.set_active.bind(this,false);this.show()}SuggestionButton.prototype.update_pos=function(){var pos=playlist_util.get_container_pos(this.playlist);this.update(pos);this.update_pos_to=setTimeout(this.update_pos.bind(this),500);return pos};SuggestionButton.prototype.on_click=function(e){e.stopImmediatePropagation();e.preventDefault();if(stats)stats.inc("sugg_btn_click_n");this.controls.pause()};SuggestionButton.prototype.on_mouseenter=function(e){this.hovered=true;this.on_active()};SuggestionButton.prototype.on_mouseleave=function(e){this.hovered=false;if(!this.controls.is_user_active())this.on_inactive()};SuggestionButton.prototype.bind_btn_events=function(type){var _this=this;["click","mouseenter","mouseleave"].forEach(function(e){var name="on_"+e+"_fn";if(!_this[name])_this[name]=_this["on_"+e].bind(_this);_this.button[type](e,_this[name])});playlist_util.cancel_event.call(this,this.button,type,cancel_click_events)};SuggestionButton.prototype.set_active=function(is_active){if(!is_active&&this.hovered)return;this.button[is_active?"addClass":"removeClass"](pr_class+"active")};SuggestionButton.prototype.bind_events=function(){this.uninit_fn=this.uninit.bind(this);this.playlist.on("detach",this.uninit_fn);this.playlist.on("frame_hide",this.uninit_fn);this.on_fullscreen_fn=playlist_util.on_fullscreen.bind(this);this.playlist.on("fullscreenchange",this.on_fullscreen_fn);this.bind_btn_events("on");this.controls.on("user_active",this.on_active);this.controls.on("user_inactive",this.on_inactive)};SuggestionButton.prototype.uninit=function(opt){if(!this.inited||opt&&opt.type!=this.type)return;this.playlist.off("detach",this.uninit_fn);this.playlist.off("frame_hide",this.uninit_fn);this.playlist.off("fullscreenchange",this.on_fullscreen_fn);this.bind_btn_events("off");this.controls.off("user_active",this.on_active);this.controls.off("user_inactive",this.on_inactive);this.hide(opt);this.inited=false};SuggestionButton.prototype.update=function(topt){if(!this.button)return;var size=this.conf.size||{},m=this.conf.margin;size=size.width||(topt.width<=900?64:96);dom_util.style_important(this.button[0],{position:"absolute",width:size+"px",height:size+"px",top:(topt.height-size)/2+"px",right:m.right+"px"});return size};SuggestionButton.prototype.render=function(topt){this.button=playlist_util.create_el(pr_class,"div","sugg_btn");this.update(topt);playlist_util.show_element(this.button);return this.button};SuggestionButton.prototype.show=function(){$(this.container).after(this.render(this.update_pos()));this.bind_events();this.set_active(this.controls.is_user_active())};SuggestionButton.prototype.hide=function(opt){if(this.button[0].parentNode)this.button.remove();this.button=undefined;if(this.update_pos_to)this.update_pos_to=clearTimeout(this.update_pos_to)};E.init=function(_stats){stats=_stats};return E});
define("/svc/cdn/pub/feature/playlist/side_btn.js",["cash","/util/events.js","/util/util.js","/svc/cdn/pub/feature/playlist/util.js","/svc/cdn/pub/dom_util.js"],function($,events,zutil,playlist_util,dom_util){var playlist;var assign=Object.assign;var pr_class="hola_playlist_";var cancel_click_events=["mousedown","pointerdown","mouseup","pointerup"];var wn_types={popup:"pnext",tile:"ptile",panel:"ppanels",slide:"pslide"};var E=SideButton;zutil.inherits(SideButton,events.EventEmitter);function SideButton(_playlist,opt){this.playlist=_playlist;this.container=playlist_util.get_frame_container(_playlist,opt);this.controls=_playlist.controls;this.conf=opt.sbutton_conf;this.session=playlist.session[_playlist.id]||{};this.pnext=this.playlist[wn_types[opt.on_pause]];this.max_len=opt.pinline_conf.cols*opt.pinline_conf.rows;var views=this.session.views,pl=this.pnext.playlist;this.unplayed=pl.filter(function(e){if(!views.find(function(ve){return ve.url_md5==e.url_md5}))return e});this.opt=opt;this.els={};this.type="sbutton";this.inited=true;this.on_active=this.set_active.bind(this,true);this.on_inactive=this.set_active.bind(this,false);this.show()}SideButton.prototype.update_pos=function(init){if(!this.root)return;var _this=this,pos=playlist_util.get_container_pos(this.playlist);$(this.root).css({width:pos.width+"px",height:pos.height+"px"});["left","right"].forEach(function(e){_this._update_side_btn(e,pos)});this.update_pos_to=setTimeout(this.update_pos.bind(this),500);return pos};SideButton.prototype.set_active=function(is_active){if(!is_active&&this.hovered)return;this.root[is_active?"addClass":"removeClass"](pr_class+"active")};SideButton.prototype.uninit=function(opt){if(!this.inited||opt&&opt.type!=this.type)return;this.playlist.off("detach",this.uninit_fn);this.playlist.off("frame_hide",this.uninit_fn);this.playlist.off("fullscreenchange",this.on_fullscreen_fn);this._bind_slide_click("off");this.controls.off("user_active",this.on_active);this.controls.off("user_inactive",this.on_inactive);this.hide(opt);this.inited=false};SideButton.prototype.show=function(){var _this=this,c=$(this.container);this.root=playlist_util.create_el(pr_class,"div","next_control");dom_util.style_important(this.root[0],{display:"block","pointer-events":"none","margin-left":c.css("margin-left"),position:"absolute"});this.root.css({top:0,left:0});var pos=this.update_pos(true);["left","right"].forEach(function(e){_this._render_side_btn(e,pos)});c.after(this.root);this._bind_events();this.set_active(this.controls.is_user_active())};SideButton.prototype.hide=function(opt){if(this.root[0].parentNode)this.root.remove();this.root=undefined;if(this.update_pos_to)this.update_pos_to=clearTimeout(this.update_pos_to)};SideButton.prototype._bind_events=function(){this.uninit_fn=this.uninit.bind(this);this.playlist.on("detach",this.uninit_fn);this.playlist.on("frame_hide",this.uninit_fn);this.on_fullscreen_fn=playlist_util.on_fullscreen.bind(this);this.playlist.on("fullscreenchange",this.on_fullscreen_fn);this._bind_slide_click("on");this.controls.on("user_active",this.on_active);this.controls.on("user_inactive",this.on_inactive)};SideButton.prototype._bind_slide_click=function(type){var _this=this,els=this.els;["left","right"].forEach(function(side){var ev,el,name=side+"_side_btn";if(!(el=els[name]))return;var views=_this.session.views;_this[name]=_this[name]||function(e){e.stopImmediatePropagation();e.preventDefault();var curr=_this.session.curr;switch(side){case"right":if(curr==views.length-1){if(_this.unplayed.length){views.push(_this.unplayed[0]);curr++}}else curr++;break;case"left":if(curr)curr--;break}if(playlist){playlist.play_next(_this.playlist,{next:views[curr]},true,this.type,_this.opt._state,true)}};el[type]("click",_this[name]);ev=name+"_hover";_this[ev]=_this[ev]||function(e){_this.hovered=true;_this.on_active()};el[type]("mouseenter",_this[ev]);ev=name+"_unhover";_this[ev]=_this[ev]||function(e){_this.hovered=false;if(!_this.controls.is_user_active())_this.on_inactive()};el[type]("mouseleave",_this[ev]);playlist_util.cancel_event.call(this,el,type,cancel_click_events)})};SideButton.prototype._render_side_btn=function(side,topt){var el=playlist_util.create_el(pr_class,"div","side_btn "+pr_class+side+"_btn");this.els[side+"_side_btn"]=el;this._update_side_btn(side,topt);var curr=this.session.curr,views=this.session.views;playlist_util.show_element(el,side=="left"?curr:curr<views.length-1||curr<this.max_len&&this.unplayed.length);this.root.append(el)};SideButton.prototype._update_side_btn=function(side,topt){var el;if(!(el=this.els[side+"_side_btn"]))return;var size=this.conf.size||{},m=this.conf.margin;size=size.width||(topt.width<=900?64:96);dom_util.style_important(el[0],assign({position:"absolute",width:size+"px",height:size+"px",top:(topt.height-size)/2+"px"},side=="left"?{left:m.left+"px"}:{right:m.right+"px"}));return size};E.init=function(_playlist){playlist=_playlist};return E});
define("/svc/cdn/pub/feature/playlist/popup.js",["cash","/util/events.js","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/feature/playlist/util.js","/svc/cdn/pub/widget.js"],function($,events,zutil,util,playlist_util,widget){var assign=Object.assign,pr_class="hola_playlist_";var playlist;var poster_ew=1.182,ms_sec=1e3;var E={};zutil.inherits(NextPopup,events.EventEmitter);function NextPopup(ctx,div,opt){this.ctx=ctx;this.pnext=ctx.pnext;this.type="pnext";this.opt=opt;this.conf=opt.pnext_conf;this.div=$(div);this.img=widget.create_img(pr_class+"poster_img");if(this.pnext.next)this.render();this.inited=true}NextPopup.prototype.render=function(){playlist.log.debug("next popup render");var opt=this.opt,create=playlist_util.create_el.bind(this,pr_class);var overlay=create("div","overlay"),main=create("div","main");var els=this.els={},css=this.opt.css||{},arr=["poster"];if(!opt.is_min_size)arr=arr.concat(["description","sec_timer"]);else this.div.addClass(pr_class+"min_size");arr.forEach(function(cl){main.append(els[cl]=create("div",cl))});this.div.addClass("hola_next_suggestion "+pr_class+"wrapper "+pr_class+"x_animation "+pr_class+"active").append(overlay);if(util.is_mobile)this.div.addClass("mobile");playlist_util.show_element(this.div);var next=this.pnext.next;if(next.poster){if(!(util.is_ie||util.is_edge&&util.browser.version<16))els.poster.addClass("def_width");var img=this.img.create(next.poster,next);if(!opt.is_min_size)img.attr("data-hola-playlist-ew",poster_ew);els.poster.append(img)}if(next.description&&els.description)els.description.text(next.description);widget.set_preview_url(main,next,opt);if(css.background_color)overlay.css({"background-color":css.background_color});var sec_timer=els.sec_timer;if(css.font_size){this.div.css({"font-size":css.font_size+"px"});if(sec_timer)sec_timer.css({"font-size":css.font_size-1+"px"})}this.t_hidden=sec_timer&&sec_timer.css("display")=="none";els.close=$("<a>").addClass(pr_class+"close skip-preview").attr("href","#");els.main=main;this.div.append(main).append(els.close);if(this.ctx.emit)this.ctx.emit("widget_ready");this.bind_events();playlist.delayed_scan();playlist.popup_inc("show",this.opt._state)};NextPopup.prototype.sec_left=function(opt){var sec_timer,left=Math.ceil(opt.left);if(!(sec_timer=this.els.sec_timer))return;if(left<=playlist.conf.sec_before_end){sec_timer.html(playlist._t("text",{left:left}));if(this.t_hidden)this.t_hidden=!!playlist_util.show_element(sec_timer)}else if(!this.t_hidden)this.t_hidden=!playlist_util.show_element(sec_timer,false)};NextPopup.prototype.play_next=function(is_click){if(this.play_t)this.play_t=clearTimeout(this.play_t);if(this.ctx.is_ad_active&&this.ctx.is_ad_active()){this.play_t=setTimeout(this.play_next.bind(this,is_click),500);return}var opt=this.opt;if(opt.no_switch&&!is_click)return playlist.log.info("not switching due to conf");if(this.hidden&&!opt.force_switch)return playlist.log.debug("not switching due to closed popup");playlist.play_next(this.ctx,this.pnext,is_click,this.type,opt._state,this.ctx.is_inline());this.uninit()};NextPopup.prototype.close=function(){playlist.popup_inc("close",this.opt._state);if(this.ctx.emit)this.ctx.emit("close_popup",{type:this.type});this.uninit()};NextPopup.prototype.bind_events=function(){var _this=this;var one=function(target,event,cb){var fn=function(e){e.preventDefault();e.stopPropagation();cb();target.off(event,fn)};target.on(event,fn);return fn};this.on_close_fn=one(this.els.close,"click",this.close.bind(this));this.on_main_fn=one(this.els.main,"click",function(){_this.play_next(true)});if(!this.ctx.on)return;this.sec_left_fn=this.sec_left.bind(this);this.play_next_fn=this.play_next.bind(this);this.uninit_fn=this.uninit.bind(this);this.ctx.on("sec_left",this.sec_left_fn);this.ctx.on("video_finished",this.play_next_fn);this.ctx.on("widget_hide",this.uninit_fn)};NextPopup.prototype.uninit=function(opt){if(!this.inited||opt&&opt.type!=this.type)return;playlist.log.debug("next popup uninit");if(this.sec_left_fn)this.ctx.off("sec_left",this.sec_left_fn);if(this.play_next_fn)this.ctx.off("video_finished",this.play_next_fn);if(this.uninit_fn)this.ctx.off("widget_hide",this.uninit_fn);this.img.uninit();this.els.close.off("click",this.on_close_fn);this.els.main.off("click",this.on_main_fn);this.div.removeClass(pr_class+"active");this.inited=false};zutil.inherits(NextPopupFrame,events.EventEmitter);function NextPopupFrame(_playlist,opt){this.playlist=_playlist;this.hidden=false;this.pnext=_playlist.pnext;this.conf=opt.pnext_conf;this.size=playlist_util.get_popup_size(playlist_util.get_container_pos(this.playlist),opt);opt.is_min_size=this.size==this.conf.size.min;this.type="pnext";this.container=playlist_util.get_frame_container(_playlist,opt);this.vtline=$(_playlist.container).find(".hola_visual_timeline_holder");this.opt=opt;this.show();this.inited=true}NextPopupFrame.prototype.get_container=function(){return this.main};NextPopupFrame.prototype.update_pos=function(){if(this.hidden||!this.root)return;this.update_pos_to=setTimeout(this.update_pos.bind(this),500);if(this.on_main)return;var bmargin,opt=this.opt;var pos=playlist_util.get_container_pos(this.playlist);var conf=this.conf;if(!conf.dis_autopos){var cbar=this.playlist.get_control_bar();bmargin=conf.margin.bottom+(cbar&&playlist_util.is_visible(cbar)&&cbar.height())+(playlist_util.is_visible(this.vtline)&&this.vtline.height())}else bmargin=this.opt.margin_bottom;var add_widget_to_body=typeof opt.add_widget_to_body=="function"?opt.add_widget_to_body({E:E,_this:this,$:$,util:util}):opt.add_widget_to_body;var s=add_widget_to_body?{top:pos.top,left:pos.left}:{top:0,left:0};this.root.css({top:s.top+pos.height-bmargin-this.size.height+"px",left:s.left+pos.width-this.size.width-conf.margin.right+"px"})};NextPopupFrame.prototype.close=function(){this.hidden=true;this.root.css("display","none")};NextPopupFrame.prototype.bind_events=function(){this.uninit_fn=this.uninit.bind(this);this.close_fn=this.close.bind(this);this.on_fullscreen_fn=playlist_util.on_fullscreen.bind(this);this.playlist.on("detach",this.uninit_fn);this.playlist.on("close_popup",this.close_fn);this.playlist.on("frame_hide",this.uninit_fn);this.playlist.on("fullscreenchange",this.on_fullscreen_fn)};NextPopupFrame.prototype.uninit=function(opt){if(!this.inited||opt&&opt.type!=this.type)return;playlist.log.debug("popup frame uninit");this.playlist.off("detach",this.uninit_fn);this.playlist.off("close_popup",this.close_fn);this.playlist.off("frame_hide",this.uninit_fn);this.playlist.off("fullscreenchange",this.on_fullscreen_fn);if(this.opt.delay_hide)setTimeout(this.hide.bind(this),this.opt.delay_hide*ms_sec);else this.hide();this.inited=false};NextPopupFrame.prototype.show=function(){var size=this.size,opt=this.opt,c=$(this.container)[0];var s={height:size.height+"px",width:size.width+"px"};this.root=$("<div>").addClass("hola_playlist hola_top_element").css(assign({height:s.height,width:s.width,display:"block","pointer-events":"all","font-size":size.font_size},this.conf.root_css));this.main=$("<div>").addClass(pr_class+"wrapper");this.update_pos();this.bind_events();if(opt._state!="preload"){this.hover_fn=function(){this.on_main=true}.bind(this);this.unhover_fn=function(){this.on_main=false}.bind(this);this.main.on("mouseenter",this.hover_fn);this.main.on("mouseleave",this.unhover_fn);this.root.append(this.main);var add_widget_to_body=typeof opt.add_widget_to_body=="function"?opt.add_widget_to_body({E:E,_this:this,$:$,util:util}):opt.add_widget_to_body;if(add_widget_to_body)document.body.appendChild(this.root.get(0));else $(c).after(this.root);this.on_fullscreen_fn();this.playlist.set_show_time(this.type)}};NextPopupFrame.prototype.hide=function(opt){if(opt&&opt.type!=this.type)return;this.playlist.emit("widget_hide",{type:this.type});if(this.hover_fn)this.main.off("mouseenter",this.hover_fn);if(this.unhover_fn)this.main.off("mouseleave",this.unhover_fn);var clear=function(){this.root.remove()}.bind(this);if(opt&&opt.force)clear();else setTimeout(clear,ms_sec);if(this.update_pos_to)this.update_pos_to=clearTimeout(this.update_pos_to)};E.init=function(_playlist){playlist=_playlist};E.NextPopup=NextPopup;E.NextPopupFrame=NextPopupFrame;return E});
define("/svc/cdn/pub/feature/playlist/slide.js",["cash","/svc/cdn/pub/util.js","/svc/cdn/pub/feature/playlist/util.js","/svc/cdn/pub/widget.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/feature/preview/index.js","/svc/cdn/pub/feature/playlist/promo.js"],function($,util,playlist_util,widget,dom_util,preview,playlist_promo){var assign=Object.assign,pr_class="hola_playlist_";var selected_tile=pr_class+"selected_tile";var ms_sec=1e3;var playlist;var E=SlidePopup;util.inherits(SlidePopup,playlist_util.Popup);function SlidePopup(ctx,div,opt){var live_tile_on=/spark_live_playlist=1/.test(document.referrer);var p0=ctx.pslide&&ctx.pslide.playlist&&ctx.pslide.playlist[0];if(live_tile_on&&p0){var nurl="https://www.foxnews.com/video/5614615980001#sp=watch-live";p0=Object.assign({},p0,{orig_url:nurl,page_url:nurl,page_key:nurl});if(p0.media_info)p0.media_info=Object.assign({},p0.media_info,{page_url:nurl});p0.live_tile="https://247preview.foxnews.com/hls/live/2020027/"+"fncv3preview/index.m3u8";p0.poster="https://media2.foxnews.com/BrightCove/694940094001/"+"2018/03/19/694940094001_5754212826001_5614615980001-vs.jpg";ctx.pslide.playlist[0]=p0}this.ctx=ctx;this.pslide=this.ctx.pslide;this.opt=opt;this.div=$(div);this.type="pslide";this.tiles=[];this.icons=playlist.icons_handler(ctx,this.type,opt);this.img=widget.create_img(pr_class+"poster_img");this.prev_idx=this.idx=0;this.is_preview_enabled=playlist.spark.is_feature_inited("video_previews")&&util.is_mobile;this.touches={};this.size=this._get_size();this.conf=playlist_util.get_widget_conf(opt.pslide_conf,this.size);if(this.size.video_height<this.conf.min_height)return void this.ctx.emit("frame_hide",{type:"pslide"});this._render();this.info_popup=playlist.create_info_popup(ctx,this.div);this.inited=true}SlidePopup.prototype.on_cancel_autoclick=function(){this.autoclick_cancelled=true;this.ctx.on_cancel_autoclick()};SlidePopup.prototype.uninit=function(opt){if(!this.inited||opt&&opt.type!=this.type)return;playlist.log.debug("slide popup uninit");if(this.uninit_fn)this.ctx.off("widget_hide",this.uninit_fn);if(this.info_popup)this.info_popup=this.info_popup.uninit();var _this=this,main=this.els.hola_playlist_main;["touchstart","touchmove","touchend"].forEach(function(t){main.off(t,this.on_touch_fn)}.bind(this));if(this.on_main_fn)main.off("click",this.on_main_fn);this._bind_slide_click("off");this._uninit_autoslide();this.icons.uninit();this.tiles.forEach(function(e){if(!e)return;if(_this.on_link_click){["click","auxclick","contextmenu"].forEach(function(name){e.on(name,_this.on_link_click)})}if(e.wait_fn){e.wait_fn();if(e.move_fn)e.off("mousemove",e.move_fn);e.off("mouseenter",e.hover_fn);e.off("touchstart",e.hover_fn);e.off("mouseleave",e.unhover_fn)}});this.img.uninit();this.div.removeClass("hola_playlist hola_top_element");this.div.empty();this.div=this.els=undefined;if(this.promo){this.promo.destroy();this.promo=null}this.inited=false};SlidePopup.prototype.update=function(){if(!this.div)return;var size=this._get_size();if(this.size.width!=size.width||this.size.height!=size.height){this.size=size;this._it_tiles(this.idx,size,this._update_tile,this.offset)}setTimeout(this.update.bind(this),500)};SlidePopup.prototype._add_hover=function(prev,cur){if(!util.is_mobile)return playlist.add_hover.call(this,cur);var anim=this.conf.hover_anim_time*ms_sec;if(prev.rm_hover)prev.rm_hover=clearTimeout(prev.rm_hover);prev.removeClass(pr_class+"tile_hover");var on_hover=function(){if(cur.poster&&cur.poster.hasClass("hola_preview_playing"))return void cur.addClass(pr_class+"tile_hover");cur.rm_hover=setTimeout(on_hover,anim)};cur.rm_hover=setTimeout(on_hover,anim)};SlidePopup.prototype._autoslide=function(){var opt=this.opt.pslide_conf.autoslide;if(!opt||!opt.enable)return;this._stop_autoslide();this.autoslide_t=setTimeout(this._slide.bind(this,opt.direction),opt.interval*ms_sec)};SlidePopup.prototype._bind_events=function(){var main=this.els.hola_playlist_main;this.on_touch_fn=this._on_touch.bind(this);["touchstart","touchmove","touchend"].forEach(function(t){main.on(t,this.on_touch_fn)}.bind(this));this._bind_slide_click("on");if(this.is_preview_enabled)preview.init_autoplay({autoplay_el:selected_tile});this.on_main_fn=function(e){if(this.info_popup&&this.info_popup.popped)return this.ctx.emit("info_hide",e);var tile;if(!(tile=this._get_tile(e)))return void this.ctx.controls.play();if(!playlist_util.is_ctrl_click(e))this._play_tile(tile)}.bind(this);main.on("click",this.on_main_fn);if(!this.ctx.on)return;this.uninit_fn=this.uninit.bind(this);this.ctx.on("widget_hide",this.uninit_fn)};SlidePopup.prototype._bind_slide_click=function(type){var _this=this,els=this.els;["left","right"].forEach(function(side){var el,name=side+"_side_btn";if(!(el=els[name]))return;_this[name]=_this[name]||function(e){e.stopImmediatePropagation();e.preventDefault();_this._slide(side)};el[type]("click",_this[name]);playlist_util.cancel_event.call(this,el,type)})};SlidePopup.prototype._get_size=function(){var v=playlist_util.get_video(this.ctx);var size={width:this.div.width(),height:this.div.height()};size.video_height=v.length?v.height():size.height;if(dom_util.is_fullscreen()&&(v=v[0])){var r=v.videoWidth?v.videoHeight/v.videoWidth:.75;size.video_height=Math.round(r*size.width)}size.video_height=size.video_height||size.height;return size};SlidePopup.prototype._get_tile=function(e){var tile=$(e.target);if(!tile.hasClass(pr_class+"tile"))tile=tile.parents("."+pr_class+"tile");return tile.length?tile:undefined};SlidePopup.prototype._init_autoslide=function(){if(!util.get(this.opt,"pslide_conf.autoslide.enable"))return;this.div.on("mouseenter",this.on_mouseenter=this._stop_autoslide.bind(this));this.div.on("mouseleave",this.on_mouseleave=this._autoslide.bind(this));this._autoslide()};SlidePopup.prototype._it_tiles=function(idx,size,cb,offset){var i,j,pos,pl=this.pslide.playlist,len=pl.length;var conf=this.conf;var k=conf.tile_size_coef||.666;var btn_size,_this=this,anim,hlen=Math.floor(len/2);var ts={height:Math.round(size.video_height*k),width:Math.round(size.width*k)};if(conf.tile_ratio){if(ts.height/ts.width>1)ts.height=ts.width*conf.tile_ratio|0;else ts.width=Math.min(ts.height/conf.tile_ratio|0,ts.width)}var left=Math.round((size.width-ts.width)/2+(offset||0));var changed=this.prev_idx!=idx||!this.tiles.length;ts.top=Math.round((size.height-ts.height)/2);var lborder;if(typeof conf.lborder=="number")lborder=conf.lborder;else lborder=ts.top/ts.width<.1?ts.top:.05*ts.width;if(changed||!offset)anim=true;if(!util.is_mobile){btn_size=assign({},ts,{width:32});["left","right"].forEach(function(e){cb.call(_this,e,btn_size)})}if(conf.dis_autopos||conf.add_floating_play_button){btn_size=Math.min(Math.round(size.height-ts.top-ts.height),48);btn_size={top:ts.top+ts.height,left:Math.round(lborder/2),width:btn_size,height:btn_size};cb.call(this,"play_btn",btn_size)}cb.call(this,idx,assign({},ts,{left:left,anim:anim,sel:true}));if(changed){this._add_hover(this.tiles[this.prev_idx],this.tiles[idx]);if(this.is_preview_enabled)setTimeout(function(){preview.emit("start_preview")},ms_sec);this.prev_idx=idx}for(j=1,i=idx+1;i<=idx+hlen;i++,j++){pos=i>=len?i-len:i;cb.call(this,pos,assign(ts,{left:left+j*(ts.width+lborder),anim:anim&&j==1}))}for(j=hlen,i=idx-hlen;i<idx;i++,j--){pos=i<0?len+i:i;cb.call(this,pos,assign(ts,{left:left-j*(ts.width+lborder),anim:anim&&j==1}))}};SlidePopup.prototype._on_touch=function(e){var t,o,sx,sy,start,move,touches=this.touches;if(!e||!(t=e.touches))return;var tile=this._get_tile(e),skip=!tile;var get_xy=function(touch){return touch?{x:touch.pageX,y:touch.pageY}:{x:0,y:0}};t=t[0];switch(e.type){case"touchstart":touches=this.touches={};touches[e.type]=get_xy(t);break;case"touchmove":touches[e.type]=get_xy(t);if(!skip){start=touches.touchstart||get_xy();o=t.pageX-start.x;sx=Math.abs(o);sy=Math.abs(t.pageY-start.y);if(sy>sx)break;this.offset=o;this._it_tiles(this.idx,this.size,this._update_tile,this.offset);if(e.cancelable)e.preventDefault()}break;case"touchend":start=touches.touchstart||get_xy();move=touches.touchmove||get_xy();o=start.x-move.x;sx=Math.abs(o);sy=Math.abs(start.y-move.y);this.touches={};if(sx>=5&&touches.touchmove!==undefined){if(!skip){if(Math.abs(o)<15||sy>sx){this.offset=0;this._it_tiles(this.idx,this.size,this._update_tile,this.offset)}else this._slide(Math.sign(o)>0?"right":"left");if(e.cancelable)e.preventDefault()}}else if(sy<sx||touches.touchmove===undefined){if(skip)this.ctx.controls.play();else this._play_tile(tile);if(e.cancelable)e.preventDefault()}break}};SlidePopup.prototype._play_tile=function(tile){var idx=+tile.attr("pl_idx");if(this.ctx.ab_test)this.ctx.ab_test.send_click(idx,this.pslide.playlist[idx-1]);playlist.play_next(this.ctx,{next:this.pslide.playlist[idx]},true,this.type,this.opt._state)};SlidePopup.prototype._render=function(){playlist.log.debug("slide popup render");var _this=this,els=this.els={};[pr_class+"overlay",pr_class+"main"].forEach(function(cl){_this.div.append(els[cl]=$("<div>").addClass(cl))});this.div.addClass("hola_playlist "+pr_class+"slide hola_top_element");if(this.conf.autoclick_tile!==undefined)this.pslide.next=this.pslide.playlist[this.conf.autoclick_tile];this._it_tiles(this.idx,this.size,this._render_tile);this.update();playlist.add_powered_by_btn(this.div);playlist_util.show_element(this.div);this._init_autoslide();this._bind_events();playlist.delayed_scan();playlist.popup_inc("show",this.opt._state,"slide")};SlidePopup.prototype._render_play_btn=function(idx,topt){var el=playlist_util.create_el(pr_class,"div",idx);this.els[idx]=el;this.play_icon=this.icons.add_icon(el,topt,{size_px:topt.height});this._update_play_btn(idx,topt);this.els.hola_playlist_main.append(el)};SlidePopup.prototype._render_side_btn=function(side,topt){var el=playlist_util.create_el(pr_class,"div","side_btn");this.els[side+"_side_btn"]=el;this._update_side_btn(side,topt);var svg_ns="http://www.w3.org/2000/svg";var svg=document.createElementNS(svg_ns,"svg");svg.setAttributeNS(null,"viewBox","0 0 "+topt.width+" "+topt.width);svg.setAttributeNS(null,"width","100%");svg.setAttributeNS(null,"height","100%");var path={right:"m 12.59,20.34 4.58,-4.59 -4.58,-4.59 1.41,-1.41 6,6 -6,6 z",left:"M 19.41,20.09 14.83,15.5 19.41,10.91 18,9.5 l -6,6 6,6 z"};var p=document.createElementNS(svg_ns,"path");p.setAttributeNS(null,"d",path[side]);p.setAttributeNS(null,"fill","#fff");svg.appendChild(p);this.els.hola_playlist_main.append(el.append($(svg)))};SlidePopup.prototype._render_tile=function(idx,topt){if(idx=="left"||idx=="right")return this._render_side_btn(idx,topt);if(idx=="play_btn")return this._render_play_btn(idx,topt);var opt=this.opt,create=playlist_util.create_el.bind(this,pr_class);var info=create("span","pinfo"),next=this.pslide.playlist[idx];var tile=playlist_util.create_tile.call(this,next,playlist.stats_inc);if(this.is_preview_enabled)tile.addClass(pr_class+"stile");this.tiles[idx]=tile.attr("pl_idx",idx);this._update_tile(idx,topt);if(next.type=="promo"&&util.is_enabled(playlist_promo)){this.els.hola_playlist_main.append(tile);this.promo=playlist_promo.create(tile[0],next.promo);return}var live_tile=next.live_tile;if(live_tile){opt.autoclick={};widget.set_preview_url(tile,next,opt);tile.attr("data-spark_preview_video_url",live_tile);tile.attr("spark_ve_preview_live",1);tile.attr("data-spark_ve_preview_live",1);tile.attr("data-spark_keep_playing",1)}else widget.set_preview_url(tile,next,opt);if(next.poster){tile.img=this.img.create(next.poster,next);tile.poster=create("div","poster").append(tile.img);tile.append(tile.poster)}var el,bel=create("div","bottom"),conf=this.conf;if(next.dur||next.total){el=$("<div>");if(!conf.hide_duration&&next.dur){el.append(create("span","duration").text(playlist_util.sec_to_dur(next.dur)))}if(!conf.hide_views&&next.total){el.append(create("span","views").text(playlist.views_to_text(next.total)))}this.add_css_element(bel,el,"pdur")}if(!live_tile&&next.description){el=create("div","description").text(next.description);this.add_css_element(bel,el,"pdesc")}if(opt.show_category&&next.category){var category=create("div","category");category.css("display","none");category.attr("category",next.category);category.text(next.category);info.append(category)}if(!conf.hide_label)this.draw_label(info,next,pr_class);this.add_css_element(info,bel,"pbottom");playlist.add_dbg_info(info,next,conf);tile.append(tile.info=info);if(typeof conf.customize_tile_fn=="function"){try{conf.customize_tile_fn($,tile,next,opt,conf)}catch(e){return void playlist.log.err("invalid customize_tile_fn function: "+(e&&e.toString())||"JS Error")}}this.els.hola_playlist_main.append(tile);this._update_tile(idx,topt)};SlidePopup.prototype._slide=function(dir){var len=this.tiles.length;this.idx=(this.idx+(dir=="left"?-1:1))%len;this.idx=this.idx<0?this.idx+len:this.idx;this.offset=0;this._it_tiles(this.idx,this.size,this._update_tile);this._autoslide()};SlidePopup.prototype._stop_autoslide=function(){clearTimeout(this.autoslide_t)};SlidePopup.prototype._t=function(str){return playlist._t(str)};SlidePopup.prototype._uninit_autoslide=function(){this._stop_autoslide();if(this.on_mouseenter)this.div.off("mouseenter",this.on_mouseenter);if(this.on_mouseleave)this.div.off("mouseleave",this.on_mouseleave)};SlidePopup.prototype._update_play_btn=function(idx,topt){if(!this.play_icon)return;var play_btn_style={position:"absolute",width:topt.width+"px",height:topt.height+"px",top:topt.top+"px",left:topt.left+"px"};if(this.conf.play_btn_style)assign(play_btn_style,this.conf.play_btn_style);if(this.conf.fix_btn_style){this.conf.fix_btn_style(play_btn_style,{E:E,_this:this,idx:idx,topt:topt})}dom_util.style_important(this.play_icon.container[0],play_btn_style);var pos=util.pick(topt,"width","height");this.play_icon.update_pos({pos:pos,img_pos:pos,size_px:pos.height})};SlidePopup.prototype._update_side_btn=function(side,topt){var el;if(!(el=this.els[side+"_side_btn"]))return;dom_util.style_important(el[0],assign({position:"absolute",width:topt.width+"px",height:topt.height+"px",top:topt.top+"px"},side=="left"?{left:0}:{right:0}))};SlidePopup.prototype._update_tile=function(idx,topt){if(idx=="left"||idx=="right")return this._update_side_btn(idx,topt);if(idx=="play_btn")return this._update_play_btn(idx,topt);var cl={add:[],remove:[]},tile;if(!(tile=this.tiles[idx]))return;dom_util.style_important(tile[0],{position:"absolute",top:topt.top+"px",left:topt.left+"px",height:topt.height+"px",width:topt.width+"px"});cl[topt.sel?"add":"remove"].push("selected_tile");cl[topt.anim?"add":"remove"].push("anim_tile");for(var s in cl)cl[s].forEach(function(e){tile[s+"Class"](pr_class+e)});if(topt.sel){if(this.icon)this.icon=this.icons.rm_icon(this.icon);if(!this.autoclick_cancelled){this.icon=playlist.add_autoclick(this.icons,{pl_idx:idx,container:tile,size:topt,playlist:this.pslide.playlist,on_cancel_autoclick:this.on_cancel_autoclick.bind(this)},this.ctx,this.conf,this.opt)}}var icon=tile.find("."+pr_class+"icon");if(icon.length){var w=icon.height();icon.css({top:(topt.height-w)/2+"px",left:(topt.width-w)/2+"px"})}};E.init=function(_playlist){playlist=_playlist};return E});
define("/svc/cdn/pub/feature/playlist/tile.js",["cash","/svc/cdn/pub/util.js","/util/events.js","/svc/cdn/pub/feature/playlist/util.js","/svc/cdn/pub/dom_util.js"],function($,util,events,playlist_util,dom_util){var playlist,assign=Object.assign;var E=TilePopupFrame;util.inherits(TilePopupFrame,events.EventEmitter);function TilePopupFrame(_playlist,opt,type){this.playlist=_playlist;this.conf=opt[type+"_conf"];this.opt=opt;this.type=type;this.cbar_cl={};this.container=playlist_util.get_frame_container(_playlist,opt);if(opt.get_frame_container){this.container=opt.get_frame_container({E:E,_this:this,$:$,util:util})}this.show();this.inited=true}TilePopupFrame.prototype.get_container=function(){return this.root};TilePopupFrame.prototype.set_cbar_class=function(is_active){var c=$(this.container);var fn=is_active?c.removeClass:c.addClass;for(var cl in this.cbar_cl)fn.call(c,cl)};TilePopupFrame.prototype.set_cbar_active=function(){var active,_this=this,c=this.container;if((active=this.playlist.master)&&active.userActive){if($(c).hasClass("vjs-ended"))this.cbar_cl["vjs-ended"]=1;if($(c).hasClass("vjs-controls-disabled"))this.cbar_cl["vjs-controls-disabled"]=1;this.set_cbar_class(true);active.userActive(true)}else if(active=this.opt.player&&this.opt.player.set_cbar_active){active=active($,c,this.opt);if(active&&!this.active_unwatch){this.active_unwatch=dom_util.attr_watch($(active.el)[0],{attr:active.attr||"class",toggle_pattern:active.cl||active.pattern,watch_fn:function(){if(!active.cl||!$(active.el).hasClass(active.cl))_this.set_cbar_active()}})}}};TilePopupFrame.prototype.update_pos=function(){if(!this.root)return;var m=this.conf.margin,is_fs=dom_util.is_fullscreen();var pos=playlist_util.get_container_pos(this.playlist,undefined,is_fs);pos.width-=m.left+m.right;pos.height-=m.top+m.bottom;if(!this.conf.dis_autopos){this.set_cbar_active();pos.height-=this.playlist.get_bottom_offset()}var imp={width:pos.width+"px",height:pos.height+"px"};if(this.add_offset){imp.top=pos.top+m.top+"px";imp.left=pos.left+m.left+"px"}else if(this.conf.use_video_pos&&!is_fs){var vpos=playlist_util.get_container_pos(this.playlist,true);imp.width=vpos.width+"px";imp.left=vpos.left+m.left+"px"}$(this.root).css(imp);this.update_pos_to=setTimeout(this.update_pos.bind(this),500)};TilePopupFrame.prototype.bind_events=function(){this.uninit_fn=this.uninit.bind(this);this.on_fullscreen_fn=playlist_util.on_fullscreen.bind(this);this.playlist.on("detach",this.uninit_fn);this.playlist.on("frame_hide",this.uninit_fn);this.playlist.on("fullscreenchange",this.on_fullscreen_fn)};TilePopupFrame.prototype.uninit=function(opt){if(!this.inited||opt&&opt.type!=this.type)return;playlist.log.debug("tile popup frame uninit");this.playlist.off("detach",this.uninit_fn);this.playlist.off("frame_hide",this.uninit_fn);this.playlist.off("fullscreenchange",this.on_fullscreen_fn);if(this.active_unwatch)this.active_unwatch();this.hide();this.inited=false};TilePopupFrame.prototype.show=function(){this.root=$("<div>");var position="absolute";var opt=this.opt;if(opt.set_position){position=opt.set_position({E:E,_this:this,$:$,util:util,dom_util:dom_util})}dom_util.style_important(this.root[0],assign({display:"block","pointer-events":"all",position:position,"background-color":"#000"},this.conf.root_css));var c;this.bind_events();if(opt._state=="preload")this.update_pos();else if(c=$(this.container)[0]){var add_widget_to_body=typeof opt.add_widget_to_body=="function"?opt.add_widget_to_body({E:E,_this:this,$:$,util:util}):opt.add_widget_to_body;if(add_widget_to_body){this.add_offset=1;this.update_pos();document.body.appendChild(this.root.get(0))}else{var s={top:0,left:0};if(opt.add_offset||opt.add_top_offset){var p=$(c).position();s.top=p.top+"px";if(opt.add_offset)s.left=p.left+"px"}this.root.css(s);this.update_pos();$(c).after(this.root)}this.on_fullscreen_fn();if(opt.fix_popup_frame)opt.fix_popup_frame({$:$,E:E,_this:this,util:util});this.playlist.set_show_time(this.type)}};TilePopupFrame.prototype.hide=function(opt){if(opt&&opt.type!=this.type)return;if(!this.conf.dis_autopos)this.set_cbar_class();this.playlist.emit("widget_hide",{type:this.type});this.root.remove();if(this.update_pos_to)this.update_pos_to=clearTimeout(this.update_pos_to)};E.init=function(_playlist){playlist=_playlist};return E});
define("/svc/cdn/pub/feature/playlist/panels.js",["cash","/svc/cdn/pub/util.js","/svc/cdn/pub/feature/playlist/util.js","/svc/cdn/pub/widget.js","/svc/cdn/pub/feature/playlist/editor.js","/svc/cdn/pub/feature/playlist/promo.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/feature/preview/index.js"],function($,util,playlist_util,widget,playlist_editor,playlist_promo,dom_util,preview){var assign=Object.assign;var pr_class="hola_playlist_",selected_tile=pr_class+"selected_tile";var playlist;var cancel_click_events=["mousedown","pointerdown","mouseup","pointerup"];var pr_countdown="hola_preview_navigate_on_hover_enabled";var ms_sec=1e3;var E={};util.inherits(PanelsPopup,playlist_util.Popup);function PanelsPopup(ctx,div,opt){var live_tile_on=/spark_live_playlist=1/.test(document.referrer);var p0=ctx.ppanels&&ctx.ppanels.playlist&&ctx.ppanels.playlist[0];if(live_tile_on&&p0){var nurl="https://www.foxnews.com/video/5614615980001#sp=watch-live";p0=Object.assign({},p0,{orig_url:nurl,page_url:nurl,page_key:nurl});if(p0.media_info)p0.media_info=Object.assign({},p0.media_info,{page_url:nurl});p0.live_tile="https://247preview.foxnews.com/hls/live/2020027/"+"fncv3preview/index.m3u8";p0.poster="https://media2.foxnews.com/BrightCove/694940094001/"+"2018/03/19/694940094001_5754212826001_5614615980001-vs.jpg";ctx.ppanels.playlist[0]=p0}this.ctx=ctx;this.ppanels=this.ctx.ppanels;this.vsize=this.ctx.vsize;this.opt=opt;this.div=$(div);this.type="ppanels";this.icons=playlist.icons_handler(ctx,this.type,opt);this.tiles=[];this.elements=[];this.restore=[];if(this.ctx.__panels_ui){this.ctx.__panels_ui._clear();dom_util.force_redraw(this.div)}this.ctx.__panels_ui=this;this.is_preview_enabled=playlist.spark.is_feature_inited("video_previews")&&util.is_mobile;if(playlist.edit_box_enabled()){this.edit_box=new playlist_editor(this.type,playlist.spark.customer,playlist.spark.spark_zone.name)}this.size={width:this.div.width(),height:this.div.height()};this.conf=playlist_util.get_widget_conf(opt.ppanels_conf,this.size);this.img=widget.create_img(pr_class+"poster_img");this.render();this.info_popup=playlist.create_info_popup(ctx,this.div);this.inited=true}PanelsPopup.prototype._clear=function(){var instance=this.ctx.__panels_ui;if(!instance)return;if(instance._clear_timeout)instance._clear_timeout=void clearTimeout(instance._clear_timeout);instance.video.removeClass(pr_class+"video");delete instance.video[0].pl_orig_style;instance.html5.removeClass(pr_class+"blur");if(instance.opt.html5_css){instance.html5.attr("style",instance.html5[0].pl_orig_style||"");delete instance.html5[0].pl_orig_style}instance.send_resize();if(instance._state_timeout){clearTimeout(instance._state_timeout);delete instance._state_timeout;instance._set_player_animation(false)}delete instance.ctx.__panels_ui};PanelsPopup.prototype.it_tiles=function(size,tile_cb,bg_cb){var i,col=3,row=3,k=.666,conf=this.conf,vs=this.vsize;var top,lborder=conf.lborder,tborder=conf.tborder;var vw=Math.round(vs.width*k),vh=Math.round(vs.height*k);var side={width:Math.round(size.width-vw-lborder),height:Math.round((size.height-(row-1)*tborder)/row)};var bottom={width:Math.round((vw-lborder)/2),height:side.height};tile_cb.apply(this,[0,{top:0,height:vh,width:vw,left:0}]);for(i=0;i<row;i++){top=i*(side.height+tborder);tile_cb.apply(this,[i+1,{top:top,height:side.height,width:side.width,left:lborder+vw}])}for(i=0;i<col-1;i++){tile_cb.apply(this,[1-i+1+row,{top:top,height:bottom.height,width:bottom.width,left:i*(bottom.width+lborder)}])}if(bg_cb){bg_cb.apply(this,[0,{top:0,height:size.height,left:vw,width:size.width-vw}]);bg_cb.apply(this,[1,{top:top-tborder,left:0,width:size.width,height:bottom.height+tborder}])}};PanelsPopup.prototype.update=function(){if(!this.div)return;var size={width:this.div.width(),height:this.div.height()};if(this.size.width!=size.width||this.size.height!=size.heigth){this.size=size;this.it_tiles(this.size,this._update_tile)}setTimeout(this.update.bind(this),500)};PanelsPopup.prototype.update_vtile=function(idx,size){dom_util.style_important(this.video_tile[0],{position:"absolute",top:size.top+"px",left:size.left+"px",height:size.height+"px",width:size.width+"px"})};PanelsPopup.prototype._update_tile=function(idx,size){var icon,tile;if(!idx)this.update_vtile(idx,size);else if(tile=this.tiles[idx]){dom_util.style_important(tile[0],{position:"absolute",top:size.top+"px",left:size.left+"px",height:size.height+"px",width:size.width+"px"});if((icon=tile.find("."+pr_class+"icon"))&&icon.length){var w=icon.height();icon.css({top:(size.height-w)/2+"px",left:(size.width-w)/2+"px"})}}};PanelsPopup.prototype.render_controls=function(size){if(!this.opt.resize_video)return;var el,c=$(this.ctx.container);if((el=c.find(".vjs-big-play-button"))&&el.length||(el=c.find(".big-play-btn"))&&el.length){el.addClass(pr_class+"play_button");this.restore.push({el:el,cl:pr_class+"play_button",style:el.attr("style")});el.css({left:size.width/2+"px",top:size.height/2+"px"})}};PanelsPopup.prototype.send_resize=function(){if(!this.conf.disable_resize&&this.is_cbar_found()&&(this.ctx.controls||{}).name=="ooyala"){window.dispatchEvent(new Event("resize"))}};PanelsPopup.prototype.is_cbar_found=function(){var cbar=this.ctx.get_control_bar();return cbar&&this.video[0].contains(cbar[0])};PanelsPopup.prototype.render_vtile=function(idx,size){var el,create=playlist_util.create_el.bind(this,pr_class);var opt=this.opt;var tile=this.video_tile=create("div","tile "+pr_class+"vtile");var _this=this,info=create("span","info");setTimeout(function(){_this.send_resize();tile.addClass(pr_class+(opt._state=="playing"?"playing":"play"))},ms_sec);this.update_vtile(idx,size);tile.attr("pl_idx",idx);if(!this.is_cbar_found())tile.css({"pointer-events":"all"});var player=this.ctx.player||{},vinfo=this.ctx.video_info||{};var hola_vjs=(player.controls||{}).name=="hola";if(!hola_vjs&&vinfo.title){el=create("div","description").text(vinfo.title);this.add_css_element(info,el,"vdesc")}if(!hola_vjs&&!opt.hide_duration&&!this.conf.hide_duration&&player.get_duration()&&player.get_duration()!=Infinity){el=create("div","duration").text(playlist_util.sec_to_dur(player.get_duration()));this.add_css_element(info,el,"vdur")}if(!this.conf.disable_play_icon){el=this.icons.add_icon(tile[0],size);el.elem.css({"pointer-events":"all"})}this.els.hola_playlist_main.append(tile.append(info));this.tiles[idx]=tile;var s={width:size.width+"px",height:size.height+"px"};if(opt.height_auto)delete s.height;if(opt.video_css)assign(s,opt.video_css);this.video[0].pl_orig_style=this.video.attr("style")||"";this.video.css(s);if(opt.force_video_size)dom_util.style_important(this.video[0],s);this.video.addClass(pr_class+"video");if(opt.html5_css){this.html5[0].pl_orig_style=this.html5.attr("style")||"";this.html5.css(opt.html5_css)}this.render_controls(size)};PanelsPopup.prototype.add_hover=function(tile){var on_hover=function(_tile){if(this.is_preview_enabled)_tile.removeClass(selected_tile)}.bind(this);playlist.add_hover.call(this,tile,on_hover)};PanelsPopup.prototype._render_tile=function(idx,size){if(!idx)return this.render_vtile(idx,size);var opt=this.opt,create=playlist_util.create_el.bind(this,pr_class);var info=create("span","pinfo"),next=this.ppanels.playlist[idx-1];var conf=this.conf;var tile=playlist_util.create_tile.call(this,next,playlist.stats_inc);tile.addClass(pr_class+(idx<3?"x":idx==3?"xy":"y")+"_animation "+pr_class+"active");dom_util.style_important(tile[0],{position:"absolute",top:size.top+"px",left:size.left+"px",height:size.height+"px",width:size.width+"px","pointer-events":"all"});tile.attr("pl_idx",idx);if(next.type=="promo"&&util.is_enabled(playlist_promo)){this.els.hola_playlist_main.append(tile);this.tiles[idx]=tile;this.elements.push(tile);this.promo=playlist_promo.create(tile[0],next.promo);return}var live_tile=next.live_tile;if(live_tile){opt.autoclick={};widget.set_preview_url(tile,next,opt);tile.attr("data-spark_preview_video_url",live_tile);tile.attr("spark_ve_preview_live",1);tile.attr("data-spark_ve_preview_live",1);tile.attr("data-spark_keep_playing",1)}else widget.set_preview_url(tile,next,opt);if(next.poster){tile.img=this.img.create(next.poster,next);tile.poster=create("div","poster").append(tile.img);tile.append(tile.poster)}var el,bel=create("div","bottom");if(next.dur||next.total){el=$("<div>");if(!conf.hide_duration&&next.dur){el.append(create("span","duration").text(playlist_util.sec_to_dur(next.dur)))}if(!conf.hide_views&&next.total){el.append(create("span","views").text(playlist.views_to_text(next.total)))}this.add_css_element(bel,el,"pdur")}if(!live_tile&&next.description){el=create("div","description").text(next.description);this.add_css_element(bel,el,"pdesc")}if(!conf.hide_label)this.draw_label(info,next,pr_class);this.add_css_element(info,bel,"pbottom");playlist.add_dbg_info(info,next,conf);if(conf.show_info)info.addClass(pr_class+"info_static");if(!conf.disable_hint&&util.is_mobile){tile.addClass(pr_class+"mobile");bel=create("div","bottom_hint");bel.css({width:size.width+"px"});el=create("div","hint_text").text(playlist._t("hint_text"));this.add_css_element(info,bel.append(el),"bhint")}if(opt.show_category&&next.category){var category=create("div","category");category.css("display","none");category.attr("category",next.category);category.text(next.category);info.append(category)}tile.append(info);if(typeof conf.customize_tile_fn=="function"){try{conf.customize_tile_fn($,tile,next,opt,conf)}catch(e){return void playlist.log.err("invalid customize_tile_fn function: "+(e&&e.toString())||"JS Error")}}this.els.hola_playlist_main.append(tile);this.tiles[idx]=tile;this.elements.push(tile);if(!opt.disable_info_hide)this.add_hover(tile);if(!this.edit_box)return;$(tile).on("contextmenu",tile.on_contextmenu=this.edit_box.render_edit_button.bind(this.edit_box,tile,idx,next))};PanelsPopup.prototype.render_bg=function(idx,size){var bg=$("<div>").addClass(pr_class+"overlay");dom_util.style_important(bg[0],{position:"absolute",top:size.top+"px",left:size.left+"px",height:size.height+"px",width:size.width+"px"});bg.addClass(pr_class+(idx==0?"x":"y")+"_animation "+pr_class+"active");this.els.hola_playlist_bg.append(bg);this.elements.push(bg)};PanelsPopup.prototype._set_player_animation=function(in_progress){var player=this.ctx.player;if(!player||!player.set_state)return;var state={};state[player.states.WN_PANEL_ANIMATION]=in_progress;player.set_state(state)};PanelsPopup.prototype._enter_animation_mode=function(){this._set_player_animation(true);if(this._state_timeout)this._state_timeout=void clearTimeout(this._state_timeout);var _this=this;this._state_timeout=setTimeout(function(){delete _this._state_timeout;_this._set_player_animation(false)},ms_sec)};PanelsPopup.prototype.render=function(){playlist.log.debug("panel popup render");var el,v,c=$(this.ctx.container),opt=this.opt;if(!c.length||!(v=playlist_util.get_video(this.ctx))||!v.length)return;this._enter_animation_mode();var idx,_this=this,els=this.els={},panels=this.ppanels;this.video=dom_util.is_fullscreen()||opt.resize_video?v:c;this.html5=v;if(!this.conf.disable_blur&&opt._state!="playing")this.html5.addClass(pr_class+"blur");if(opt._state=="playing")playlist.stats.inc_d("auto_trigger_shown_n");[pr_class+"bg",pr_class+"main"].forEach(function(cl){_this.div.append(els[cl]=$("<div>").addClass(cl))});this.div.addClass("hola_playlist "+pr_class+"panel hola_top_element");if(this.ctx.rtl)this.div.addClass(pr_class+"rtl");if(el=playlist.add_powered_by_btn(this.div))this.elements.push(el);playlist_util.show_element(this.div);this.it_tiles(this.size,this._render_tile,this.render_bg);this.update();this.bind_events();if(this.conf.autoclick_tile!==undefined)panels.next=panels.playlist[this.conf.autoclick_tile];if((idx=panels.playlist.indexOf(panels.next)+1)&&(el=this.tiles[idx])){playlist.add_autoclick(this.icons,{pl_idx:idx-1,container:el,size:{width:el.width(),height:el.height()},playlist:panels.playlist},this.ctx,this.conf,opt)}if(this.thumbnails=this.ctx.video_ctx.attached_thumbnails)this.thumbnails.turn_off();playlist.delayed_scan();playlist.popup_inc("show",this.opt._state,"panel")};PanelsPopup.prototype.bind_events=function(){if(this.is_preview_enabled)preview.init_autoplay({autoplay_el:selected_tile});this.on_main_fn=function(e){if(this.info_popup&&this.info_popup.popped)return this.ctx.emit("info_hide",e);var ctrl,idx,tile=$(e.target);if(!tile.hasClass(pr_class+"tile"))tile=tile.parents("."+pr_class+"tile");if(!tile.length)return;idx=+tile.attr("pl_idx");if(!idx&&(ctrl=this.ctx.controls)){if(this.opt._state!="playing"&&!ctrl.is_playing())return void ctrl.play();playlist.stats.inc_d("auto_trigger_discard_n");this.ctx.playing_discarded=true;this.uninit();return}if(!idx)return;if(this.is_preview_enabled&&!tile.hasClass(selected_tile)){this.tiles.forEach(function(el){if(el)el.removeClass(selected_tile)});tile.addClass(selected_tile);setTimeout(function(){preview.emit("start_preview")});return}tile.removeClass(selected_tile);if(!playlist_util.is_ctrl_click(e)){if(this.ctx.ab_test){this.ctx.ab_test.send_click(idx,this.ppanels.playlist[idx-1])}if(this.opt._state=="playing")playlist.stats.inc_d("auto_trigger_click_n");playlist.play_next(this.ctx,{next:this.ppanels.playlist[idx-1]},true,this.type,this.opt._state)}}.bind(this);var main=this.els.hola_playlist_main;main.on("click",this.on_main_fn);playlist_util.cancel_event.call(this,main,"on",cancel_click_events);if(!this.ctx.on)return;this.uninit_fn=this.uninit.bind(this);this.ctx.on("widget_hide",this.uninit_fn);if(!this.opt.autoclick.navigate_on_hover_enabled)return;this.on_countdown_fn=this.on_countdown.bind(this);this.ctx.on("on_countdown",this.on_countdown_fn)};PanelsPopup.prototype.on_countdown=function(is_shown){this.tiles.forEach(function(e){if(e)e.data(pr_countdown,!is_shown)})};PanelsPopup.prototype.uninit=function(opt){if(!this.inited||opt&&opt.type!=this.type)return;playlist.log.debug("panel popup uninit");opt=opt||{};if(this.uninit_fn)this.ctx.off("widget_hide",this.uninit_fn);if(this.on_countdown_fn)this.ctx.off("on_countdown",this.on_countdown_fn);if(this.info_popup)this.info_popup=this.info_popup.uninit();var main=this.els.hola_playlist_main;main.off("click",this.on_main_fn);playlist_util.cancel_event.call(this,main,"off",cancel_click_events);this.icons.uninit();this.video_tile.removeClass(pr_class+"play");this.video_tile.removeClass(pr_class+"playing");var _this=this;this.elements.forEach(function(e){e.removeClass(pr_class+"active");if(_this.on_link_click){["click","auxclick","contextmenu"].forEach(function(name){e.on(name,_this.on_link_click)})}if(e.on_contextmenu)e.off("contextmenu",e.on_contextmenu);if(!e.wait_fn)return;e.wait_fn();if(e.move_fn)e.off("mousemove",e.move_fn);e.off("mouseenter",e.hover_fn);e.off("touchstart",e.hover_fn);e.off("mouseleave",e.unhover_fn)});this.restore.forEach(function(e){e.el.removeClass(e.cl);e.el.attr("style",e.style||"")});if(this.thumbnails)this.thumbnails.turn_on();if(this.edit_box)this.edit_box=void this.edit_box.uninit();if(!this.opt.skip_orig_style)this.video.attr("style",this.video[0].pl_orig_style||"");this._enter_animation_mode();if(opt.force)this._clear();else this._clear_timeout=setTimeout(this._clear.bind(this),ms_sec);this.img.uninit();this.div=this.els=undefined;if(this.promo){this.promo.destroy();this.promo=null}this.inited=false};PanelsPopup.prototype._t=function(str){return playlist._t(str)};function PanelsPopupFrame(_playlist,opt){this.playlist=_playlist;this.conf=opt.ppanels_conf;this.opt=opt;this.type="ppanels";this.inited=true;this.container=playlist_util.get_frame_container(_playlist,opt);if(opt.get_frame_container){this.container=opt.get_frame_container({E:E,_this:this,$:$,util:util})}if(this.playlist.__panels_frame_ui){this.playlist.__panels_frame_ui._clear();dom_util.force_redraw(this.container)}this.playlist.__panels_frame_ui=this;this.show()}PanelsPopupFrame.prototype._clear=function(){var instance=this.playlist.__panels_frame_ui;if(!instance)return;if(instance._clear_timeout)instance._clear_timeout=void clearTimeout(instance._clear_timeout);if(instance.root)instance.root.remove();dom_util.remove(instance.el_root);$(instance.container).removeProp("hola_root_container");instance.el_root=instance.root=undefined;if(instance.orig_css===undefined)return;var el=$(instance.container).parent();el.attr("style",instance.orig_css);instance.orig_css=undefined};PanelsPopupFrame.prototype.get_container=function(){return this.root};PanelsPopupFrame.prototype.update_pos=function(init){if(!this.root)return;var m=this.conf.margin,s={},opt=this.opt;var pos=playlist_util.get_container_pos(this.playlist,opt.resize_video);if(init){pos.width-=m.left+m.right;pos.height-=m.top+m.bottom;assign(s,{width:pos.width+"px",height:pos.height+"px"});if(opt.add_offset||opt.add_top_offset){var p=$(this.container).position();s.top=p.top+"px";if(opt.add_offset)s.left=p.left+"px"}if(this.conf.use_video_pos)s.left=pos.left+m.left+"px"}if(this.add_offset)assign(s,{top:pos.top+m.top+"px",left:pos.left+m.left+"px"});this.root.css(s);if(this.conf.on_update_pos)this.conf.on_update_pos({E:E,_this:this,s:s,$:$});this.update_pos_to=setTimeout(this.update_pos.bind(this),500);return pos};PanelsPopupFrame.prototype.on_fullscreen=function(e){playlist_util.on_fullscreen.call(this,e);if(!this.root)return;var $c=$(this.container);this.root.css({"margin-bottom":$c.css("margin-bottom"),"margin-top":$c.css("margin-top")})};PanelsPopupFrame.prototype.bind_events=function(){this.uninit_fn=this.uninit.bind(this);this.detach_fn=function(){this.uninit({type:this.type,force:true})}.bind(this);this.on_fullscreen_fn=this.on_fullscreen.bind(this);this.playlist.on("detach",this.detach_fn);this.playlist.on("frame_hide",this.uninit_fn);this.playlist.on("fullscreenchange",this.on_fullscreen_fn)};PanelsPopupFrame.prototype.uninit=function(opt){if(!this.inited||opt&&opt.type!=this.type)return;playlist.log.debug("tile popup frame uninit");this.playlist.off("detach",this.detach_fn);this.playlist.off("frame_hide",this.uninit_fn);this.playlist.off("fullscreenchange",this.on_fullscreen_fn);this.hide(opt);this.inited=false};PanelsPopupFrame.prototype.show=function(){var c=$(this.container),opt=this.opt;this.el_root=document.createElement("div");this.root=$(this.el_root);var root_css={display:"block","margin-left":c.css("margin-left"),"pointer-events":"none",position:"absolute"};root_css=assign(root_css,this.conf.root_css);dom_util.style_important(this.el_root,root_css);if(opt._state=="preload")this.update_pos(true);else{var allow=!dom_util.is_fullscreen()||opt.allow_fullscreen;var w=c.width(),h=c.height();if(!allow){var mtop=parseInt(c.css("margin-top")),screen=window.screen;var mbottom=parseInt(c.css("margin-bottom"));var position=c.css("position");if(position=="absolute"&&mtop==mbottom||position=="fixed"&&w==screen.width&&h==screen.height){allow=true}}var p=c.parent();if(allow&&this.playlist.player_pos&&w&&h&&(!opt.fix_parent_div||opt.fix_parent_div&&(w=p.width())&&(h=p.height()))){if(opt.fix_parent_div||opt.parent_css){var s=opt.parent_css||{};if(opt.fix_parent_div){s=assign({},s,{position:"relative",width:w+"px",height:h+"px"})}this.orig_css=p.attr("style")||"";p.css(s)}var vsize;var add_widget_to_body=typeof opt.add_widget_to_body=="function"?opt.add_widget_to_body({E:E,_this:this,$:$,util:util}):opt.add_widget_to_body;if(add_widget_to_body)this.add_offset=1;else this.root.css({top:0,left:0});this.playlist.vsize=vsize=this.update_pos(true);if(vsize.width<this.conf.min_width)this.uninit({type:this.type,force:true});else{if(this.add_offset)document.body.appendChild(this.el_root);else c.after(this.root);c.prop("hola_root_container",this.el_root)}this.on_fullscreen();if(opt.fix_popup_frame)opt.fix_popup_frame({$:$,E:E,_this:this,util:util});this.playlist.set_show_time(this.type)}else opt._state="hidden"}this.bind_events()};PanelsPopupFrame.prototype.hide=function(opt){this.playlist.emit("widget_hide",opt);opt=opt||{};if(opt.force)this._clear();else this._clear_timeout=setTimeout(this._clear.bind(this),ms_sec);if(this.update_pos_to)this.update_pos_to=clearTimeout(this.update_pos_to)};E.init=function(_playlist){playlist=_playlist};E.PanelsPopup=PanelsPopup;E.PanelsPopupFrame=PanelsPopupFrame;return E});
define("/svc/cdn/pub/feature/playlist/index.js",["cash","/util/es6_shim.js","/util/events.js","/util/url.js","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/ajax.js","/svc/cdn/pub/feature/preview/index.js","/svc/cdn/pub/widget.js","/svc/cdn/pub/play_icon.js","/svc/cdn/pub/l10n.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/feature/playlist/promo.js","/svc/cdn/pub/msg.js","/svc/cdn/pub/widget_info.js","/svc/cdn/pub/feature/playlist/editor.js","/svc/cdn/pub/feature/playlist/util.js","/svc/cdn/pub/feature/playlist/suggestion_btn.js","/svc/cdn/pub/feature/playlist/side_btn.js","/svc/cdn/pub/feature/playlist/popup.js","/svc/cdn/pub/feature/playlist/slide.js","/svc/cdn/pub/feature/playlist/tile.js","/svc/cdn/pub/feature/playlist/panels.js"],function($,shim,events,zurl,zutil,util,ajax,preview,widget,play_icon,l10n,dom_util,playlist_promo,_msg,widget_info,playlist_editor,playlist_util,suggestion_btn,side_btn,popup_ui,slide_ui,tile_ui,panels_ui){var assign=Object.assign,log={},E={},id="playlist",ms_sec=1e3;var api,perr;var wm_url="//ve-image-cdn.h-cdn.com/svc/preview/pub/img/watermark-transparent"+".svg";var max_find_retries=5,hash_param="spark_wn";var debug_hints,t,cache={};var pr_class="hola_playlist_";var pr_countdown="hola_preview_navigate_on_hover_enabled";var wn_type={popular:"rank",trending:"hot",rank:"rank",hot:"hot","new":"new"};var wn_type_pri={rank:0,hot:1,"new":2};E.session={};E.default_conf={zindex:10,page_blacklist:[],pnext_conf:{margin:{bottom:10,right:5},size:{mobile:{height:58,width:130,font_size:"8px"},def:{height:109,width:244,font_size:"14.6px"},min:{height:60,width:80,font_size:"8px"}},min_width:400,sec_before_end:5,sec_after_start_dur:5,seek_sec_delay:5,sec_after_start:10,sec_after_end_dur:10,content:{popular:1,trending:1,"new":1}},ptile_conf:{margin:{top:0,left:0,right:0,bottom:0},size:{width:190,height:130},lborder:4,tborder:4,content:{popular:1,trending:1,"new":1},hover_anim_time:2},ppanels_conf:{min_width:520,margin:{top:0,left:0,right:0,bottom:0},size:{width:190,height:130},content:{rank:2,"new":1,hot:2},lborder:4,tborder:4,hover_anim_time:2},pslide_conf:{min_height:50,margin:{top:0,left:0,right:0,bottom:0},content:{popular:1,trending:1,"new":1},dis_autopos:util.is_mobile,hover_anim_time:2,screen_size:{width:600,height:960},autoslide:{interval:10,direction:"right"}},sbutton_conf:{margin:{left:10,right:10}},sugg_btn_conf:{margin:{left:10,right:10}},pinline_conf:{cols:4,rows:5},papp_conf:{rows:1,cols:12,content:{popular:1,trending:1,"new":1}},autoclick:{countdown_on_hover:5,navigate_on_hover_sec:3,count:7,paused_count:60},views_count:util.scaled_number,on_pause:"panel",on_end:"tile",sec_before_end:30,margin_bottom:41,min_rows:2,allow_mobile:false,seek_sec_delay:10,max_preload_len:-1,min_width:520,link_tags:[],disable_wn_button:false,auto_trigger:{threshold:20,disable_sec:10,min_views:10}};var wn_types={popup:"pnext",tile:"ptile",panel:"ppanels",slide:"pslide"};var links_cache={};function add_conf_func(fname,func){if(typeof func!="function")return;E[fname]=function(container){return func(function(s){return $(document).find(s)},container)}}function add_domains(params,opt){if(opt.cont_src=="all")return;var d=opt.domains||[];var hostname=!opt.cont_src||!d.length?E.host:d.join(" ");if(E.conf.fix_hostname)hostname=E.conf.fix_hostname(hostname,{E:E});return params.hostname=hostname}function close_plugins(controls){if(E.close_plugins)E.close_plugins(controls);else if(controls&&controls.name=="jwplayer"){try{controls.jwplayer.plugins.related.close()}catch(e){}}}function draw_widget(ctx,type,div,opt){var f;switch(type){case"pnext":f=popup_ui&&popup_ui.NextPopup;break;case"ppanels":f=panels_ui&&panels_ui.PanelsPopup;break;case"pslide":f=slide_ui;break}if(E.conf.is_draw_widget_allowed&&!E.conf.is_draw_widget_allowed({ctx:ctx,type:type,E:E})){return}if(util.is_enabled(f))ctx[type+"_widget"]=new f(ctx,div,opt)}function filter_playlist(src,dst,type,hits,opt){opt=opt||{};var key,types=opt.types||[],urls=opt.urls||{},pages=opt.pages||{};for(var e,i=0;i<src.length&&dst.length<hits;i++){e=src[i];key=e.url_md5||e.page_url||e.video_url||e.url||e.url_key;if(urls[key]||opt.page_key&&e.page_key==opt.page_key||opt.url_key&&e.url_key==opt.url_key){continue}if(opt.history&&(opt.history.page_key[e.page_key]||opt.history.url_key[e.url_key])){e.played=true;continue}if(opt.views&&opt.views.find(function(ev){return ev.url_md5==e.url_md5})){continue}if(opt.pmap){var link,u=e.page_url||e.video_url;if(opt.miss&&(!(link=opt.pmap[u])||!link.preview||link.preview.error)){opt.miss.push(u);continue}if(opt.load)opt.load.push(link)}if(e.page_key&&opt.spage){if(pages[e.page_key]){opt.spage.push(e.url_md5);continue}pages[e.page_key]=true}dst.push(assign(e,{rank:i+1,preview:!!opt.pmap}));if(type)e.type=types[type];urls[key]=true}}function find_next_video(ctx,opt,cb){cb=cb||function(){};var size=zutil.is_mocha()||!opt._ctx?{width:400,height:300}:get_div_size(undefined,opt);var types=get_pl_conf_type(opt);var _preload=function(type,_cb){preload(type,ctx,size,opt,function(data){var _size=get_widget_size(type,size,opt);get_playlist(ctx,type,opt,_size,data,_cb)})};var wait=types.length;for(var i=0;i<types.length;i++){_preload(types[i],function(){if(!--wait)cb()})}}function get_container(player){var c,el=player.controls.get_ui().container;if(c=E.conf.player&&E.conf.player.container)return typeof c=="function"?c($,el):$(el).closest(c).get(0);return player.container||el}function get_content_map(type,dim,content){var len,idx=0,map=Array(dim.rows*dim.cols);for(var key in content){if(!(len=content[key]))continue;if(type!="ppanels")len=dim.cols*(Math.floor(len/dim.rows)||1);for(var i=0;i<len;i++)map[idx++]=[key]}return map}function get_div_size(div,opt,conf){var ctx,size;if(!(ctx=opt._ctx))size={width:$(div).width(),height:$(div).height()};else{var cbar,m;conf=conf||opt.ptile_conf;size=playlist_util.get_container_pos(ctx);if(m=conf.margin){size.width-=m.left+m.right;size.height-=m.top+m.bottom}if(!conf.dis_autopos&&(cbar=ctx.get_control_bar()))size.height-=cbar.height()}return size}function get_links_info(links,type,size,cb){if(!links.length)return void cb({});var res={};var new_links=[];var link_info,cache_key;for(var i=0;i<links.length;i++){cache_key=size+"_"+links[i];if(link_info=links_cache[cache_key]){res[links[i]]=assign({},link_info);continue}new_links.push({url:links[i],type:type,size:size,by_spark:"playlist_preload"})}if(!new_links.length)return void cb(res);E.links.force_get_db(new_links,undefined,function(links_info){if(!links_info||!links_info.res)return void cb(res);var cache_key;for(var link in links_info.res){cache_key=size+"_"+link;links_cache[cache_key]=res[link]=links_info.res[link]}cb(res)})}function get_pl_by_api(ctx,type,opt){var pl,master=ctx.master||{};if(!(pl=master.hola_playlist||master.spark_playlist))return;assign(opt,pl);delete opt.playlist;return pl.playlist}function get_pl_by_custom_fn(ctx,type,opt,ws,data,cb){var type_conf=opt[type+"_conf"]||{};var allow_custom_fn_iframe=opt.allow_custom_fn_iframe||type_conf.allow_custom_fn_iframe;if(!util.is_top&&!allow_custom_fn_iframe)return void E.msg.get_custom_fn_playlist_cb(cb);var custom_fn=type_conf.custom_fn||opt.custom_fn;if(typeof custom_fn!="function")return void cb();custom_fn(function(playlist){if(cache)cache.custom_fn_playlist=playlist;cb(playlist)},ctx,type,opt)}function get_pl_by_selector(ctx,type,opt,ws,data,cb){var sel=opt.selectors;if(!sel||!Object.keys(sel).length)return void cb();var pname="sel_playlist",c=cache[pname]=cache[pname]||{};if(c.playlist)return void cb(c.playlist);E.msg.sel_playlist_cb(function(pl){c.playlist=c.playlist||pl});var items,len=0,base=document,win=window.self;if(sel.item){var old_win;for(items=$(base).find(sel.item);!items.get(0);items=$(base).find(sel.item)){if(win.parent==win)break;old_win=win;try{win=win.parent;base=win.document;log.debug("going to parent..",win.name)}catch(e){win=old_win;base=old_win.document;break}}if(!items.get(0)){c.fn_retry=c.fn_retry||0;if(c.fn_retry<max_find_retries){c.fn_retry++;setTimeout(function(){find_next_video(ctx,opt)},2e3)}return void cb()}c.fn_retry=0;len=items.length}cache.target_win=win;var playlist=[];if(len&&opt.use_links_js)playlist=get_pl_links_info(items);else{var get_prop=function(el,prop){return(el||{})[prop]};var get_func=function(el,prop){return el?$(el)[prop]():""};var get_img_src=function(el){return el?E.links.get_img_src(el,{}):""};var get_fn=function(selector,selector_js,_cb,prop,idx){var _$=function(selector){return $(base).find(selector)};if(typeof selector=="function")return selector(_$,idx);if(selector_js){var fn=new Function("_$","pc",selector_js);return fn(_$,idx)}return _cb(_$(selector).get(idx),prop)};var u=get_url_type(ctx)+"_url";for(var idx=0,next={url:1};idx<len||!len&&next.url;idx++){next={poster:get_fn(sel.img,sel.img_js,get_img_src,"src",idx),description:get_fn(sel.desc,sel.desc_js,get_func,"text",idx)};if(next[u]=get_fn(sel.link,sel.link_js,get_prop,"href",idx))playlist.push(next);if(next.page_url)next.page_key=E.spark.page2cache(next.page_url)}}c.playlist=history_filter(playlist,[],ctx,type,opt);cb(c.playlist)}function get_pl_by_tags(ctx,type,opt,ws,data,cb){var pname=type+"_playlist",c=cache[pname]=cache[pname]||{};if(c.playlist)return void cb(c.playlist);var items=$("["+(opt.pl_attr||"spark_playlist,hola_spark_playlist")+"]");if(!items.length){c.fn_retry=c.fn_retry||0;if(c.fn_retry==max_find_retries)return void cb(c.playlist=[]);c.fn_retry++;return void setTimeout(function(){find_next_video(ctx,opt)},2e3)}c.fn_retry=0;cb(c.playlist=get_pl_links_info(items))}function get_pl_by_views(ctx,map,views,key,data,period,opt,cb){ctx=ctx||{};opt=assign({url_type:get_url_type(ctx)},opt);var count=opt.count||5,previews={},page_url=E.spark.get_top_url();var url_key=ctx.player&&ctx.player.url_key;var is_preview_enabled=E.spark.is_feature_inited("video_previews")&&!opt.disable_preview_filter;var add_pl_item=function(pl,added,arr,count,opts,order){var ple,e,cid;for(var i=0;i<arr.length;i++){e=arr[i];if(added[e.url_md5]||!(ple=playlist_entry(e,opt,opts)))continue;var page_url=ple.location||ple.page_url||ple.media_info&&ple.media_info.page_url||"";if(!is_page_url_allowed(page_url,opt))continue;if(opt.get_entry_id&&(cid=opt.get_entry_id(ple))){if(cid=="ignore"||added[cid])continue;added[cid]=true}ple.order=order;ple.page_views=e.page_views;pl.push(ple);added[e.url_md5]=true;if(is_preview_enabled)previews[ple.page_url||ple.video_url]=1;if(!--count)return}};var prepare=function(opts){var res={},rcount=count*2;for(var v in views){var harr=data[key+period[v].h]||[],rarr=[],farr=[];var larr=data[key+period[v].l]||[],lobj={},pl=res[v]=[];var added={};larr.forEach(function(v){lobj[v.url_md5]=v});harr.forEach(function(e){if(!lobj[e.url_md5])return void farr.push(e);rarr.push(e)});add_pl_item(pl,added,rarr,rcount,opts,0);add_pl_item(pl,added,farr,rcount,opts,1);add_pl_item(pl,added,larr,rcount,opts,2);pl.sort(function(a,b){return a.order-b.order||b.page_views-a.page_views||b.total-a.total}).forEach(function(p){delete p.order;delete p.page_views})}return res};var res=prepare(),keys=Object.keys(previews);get_links_info(keys,opt.url_type,opt.preload_size,function(pr){var views,res_pl=[],hits=opt.count,col=map[0].length;if(keys.length&&!pr)perr({id:"playlist_no_links_data",playlist_urls:keys});var opts={urls:{},pages:{},types:wn_type,miss:[],spage:[],page_key:E.spark.page2cache(page_url),url_key:url_key};if(is_preview_enabled)opts.load=[];if(hits>0&&is_inline(ctx))views=(E.session[ctx.id]||{}).views;var filter=assign({pmap:pr,history:E.history,views:views},opts);map.forEach(function(row,i){row.forEach(function(p,j){filter_playlist(res[p],res_pl,p,i*col+j+1,filter)})});function fill_playlist(opts){for(var p in res){filter_playlist(res[p],res_pl,p,hits,opts);if(res_pl.length==hits)return true}}var i,fkeys=["fall","history","pmap","views"];for(i=0;res_pl.length<hits&&i<fkeys.length;i++){delete filter[fkeys[i]];fill_playlist(filter)}if(res_pl.length==hits&&opts.load&&opts.load.length&&hits<=opt.max_preload_len){preview.preload_preview(opts.load)}if(res_pl.length<hits&&debug_hints){var dbg=["empty_desc","empty_poster","allow_empty"];for(i=0;i<dbg.length;i++){var o={};o[dbg[i]]=1;res=prepare(o);if(fill_playlist(assign({pmap:pr},opts))||fill_playlist(opts)){break}}while(res_pl.length<hits)res_pl.push({})}if(keys.length&&opts.miss.length){perr({id:"playlist_missing_preview",playlist_urls:opts.miss})}if(opts.spage.length){perr({id:"playlist_videos_on_single_page",playlist_urls:opts.spage})}cb(res_pl)})}function get_pl_conf_type(opt){if(opt._force_type)return[opt._force_type];var types=[];if(opt.on_pause=="popup"||opt.on_end=="popup")types.push("pnext");if(opt.on_pause=="tile"||opt.on_end=="tile")types.push("ptile");if(opt.on_pause=="panel"||opt.on_end=="panel")types.push("ppanels");if(!opt.disable_slide&&(types.includes("ptile")||types.includes("ppanels")||opt.on_pause=="slide"||opt.on_end=="slide")){types.push("pslide")}return types}function get_pl_links_info(items){var pl=[],opt={};for(var i=0;i<items.length;i++){var a=$(items[i]).find("a");if(!a.length)continue;var info=E.links.get_link_info(a[0],opt);if(info&&info.poster&&info.description&&info.url){pl.push(zutil.pick(info,"poster","description","video_url","page_url"))}}return pl}function get_pl_missing_info(ctx,lkey,pl,opt,cb){var add_poster,pages="";pl.forEach(function(e){pages+=(pages?" ":"")+e.page_url;if(!add_poster&&!e.poster)add_poster=true});opt=assign({cont_src:"all",by_pages:pages},opt);if(!add_poster)opt.ignore="poster video_poster";var cb_err=function(e){log.err(util.zerr_e2s(e));cb()};var playlists_handler=function(sdata){if(!sdata||!sdata.length){if(!sdata)E.stats.inc_d("get_static_playlists_err_n");return void cb()}sdata.forEach(function(e){var vi;if(!(vi=e.video_info))return void cb();assign(lkey[e._url_key],zutil.pick(vi,"poster","video_poster","description","title","dur","total"))});cb(lkey)};get_playlists(ctx,["1h"],5,opt,playlists_handler,cb_err)}function get_pl_remote(ctx,type,opt,ws,data,cb){var pconf=opt[type+"_conf"]||{};if(!zutil.is_mocha()&&ctx==E)return void cb();var url=pconf.playlist_url;if(!url&&typeof pconf.playlist_url_fn=="function")url=pconf.playlist_url_fn(ctx);if(!url)return void cb();var pname=type+"_playlist";var c=cache[pname]=cache[pname]||{};if(c.playlist)return void cb(c.playlist);var curl=cache[url]=cache[url]||{};ajax.raw({url:url,data_type:"json"},function(res){if(typeof pconf.prepare_remote_data=="function"){try{res=pconf.prepare_remote_data(res)}catch(e){log.err("invalid prepare_remote_data function: "+(e&&e.toString())||"JS Error")}}curl.res=res=res.playlist||res;if(!res.length)return void cb();res.forEach(function(e){if(!e.page_key&&e.page_url)e.page_key=E.spark.page2cache(e.page_url)});c.playlist=history_filter(res,[],ctx,type,assign({},opt,ws));cb(c.playlist)},function(e){log.err(util.zerr_e2s(e))})}function get_pl_static(ctx,type,opt,ws,pl,cb){var pconf=opt[type+"_conf"]||{};if(type=="pslide"&&!(pconf.static_list||[]).length){type=(opt.ptile_conf.static_list||[]).length?"ptile":(opt.ppanels_conf.static_list||[]).length?"ppanels":"";pconf=opt[type+"_conf"]||{}}var sl,pname=type+"_static";if(!(sl=pconf.static_list)||!sl.length)return void cb(pl);var c=cache[pname]=!(is_inline(ctx)&&opt._state=="preload")&&cache[pname]||{};if(c.playlist||!pconf.force_static_list&&(!pl||!pl.length)||!zutil.is_mocha()&&ctx==E){return void cb(c.playlist)}if(!pl&&pconf.force_static_list)pl=[];var mrow=0,mcol=0,lkey={},missing=[];var url_type=get_url_type(ctx);sl.forEach(function(e){e=assign({},e);e.row--;if(e.col)e.col--;mrow=Math.max(e.row,mrow);mcol=Math.max(e.col||0,mcol);if(e.type=="promo"&&util.is_enabled(playlist_promo)){if(typeof e.col=="number")lkey["promo_"+e.row+"_"+e.col]=e;else lkey["promo_"+e.row]=e;return}lkey[e.page_url]=e;if(!e.video_url&&url_type=="video")url_type="page";if(e.poster&&e.description&&!e.force_load)return;missing.push(e)});mrow=Math.max((pconf.rows||1)-1,mrow);mcol=Math.max((pconf.cols||1)-1,mcol);var cb_err=function(e){log.err(util.zerr_e2s(e));c.playlist={};cb()};var static_playlist_handler=function(){try{var d,_e,res=[];opt=assign({url_type:url_type},opt);for(_e in lkey){d=lkey[_e];var idx=mcol?d.row*(mcol+1)+d.col:d.row;if(!res[idx])res[idx]=[];if(d.type=="promo"&&util.is_enabled(playlist_promo)){res[idx].push(assign({},d));continue}d.video_info=zutil.omit(d,"page_url");if(_e=playlist_entry(d,opt)){if(d.type_str&&!d.type)d.type="new";_e.is_static=true;res[idx].push(assign(_e,zutil.pick(d,"type","type_str","disable_preview")))}}for(var i=0;i<res.length;i++){if(!(_e=res[i])||!_e.length)continue;d=[];filter_playlist(_e,d,undefined,1,{history:E.history});pl[i]=d.length?d[0]:_e[0]}cb(c.playlist)}catch(e){cb_err(e)}};c.playlist=pl;if(!missing.length)return void static_playlist_handler();get_pl_missing_info(ctx,lkey,missing,opt,static_playlist_handler)}function get_pl_top_vstats(ctx,type,opt,ws,data,cb){ws=ws||{};var range,pname=type+"_playlist",hits=ws.rows*ws.cols;var c=cache[pname]=!(is_inline(ctx)&&opt._state=="preload")&&cache[pname]||{};if(c.playlist||!data||!zutil.is_mocha()&&ctx==E||!["pslide","pnext","ppanels"].includes(type)&&(ws.cols<opt.min_rows||ws.rows<opt.min_rows||!hits)){return void cb(c.playlist)}if(c.et)return void c.et.push(cb);c.et=[cb];var _finally=function(playlist){var cbs=c.et;if(!cbs)return;c.et=undefined;for(var i=0;i<cbs.length;i++)cbs[i](playlist)};if(!(range=get_popular_range(type,ws,opt)))return void _finally(c.playlist=[]);var cb_err=function(e){log.err(util.zerr_e2s(e));c.playlist={};_finally()};var playlist_handler=function(res){try{if(!zutil.is_mocha()&&res.length<hits&&!["pnext","papp"].includes(type)){res=[]}else if(type=="ppanels"&&util.has_ext){var rank={};range.map.forEach(function(p,i){p=p[0]||"rank";res[i].type=p;res[i].rank=rank[p]=(rank[p]||0)+1})}else if(type!="ppanels"){res=res.slice(0,hits).sort(function(a,b){return b.played==a.played?b.total-a.total:+!!a.played-+!!b.played})}c.playlist=res;_finally(c.playlist)}catch(e){cb_err(e)}};var key=(add_domains({},opt)?"site_":"customer_")+"popular_";var _opt=assign({},opt,{count:hits});get_pl_by_views(ctx,range.map,range.view,key,data,range.period,_opt,playlist_handler)}function get_playlist(ctx,type,opt,ws,data,cb){var pl,next_by,next_fn;if(pl=get_pl_by_api(ctx,type,opt))return void cb(pl);switch(next_by=get_type_next_by(type,opt)){case"popular":case"slide":case"panels":case"trending":next_fn=get_pl_top_vstats;break;case"selector":next_fn=get_pl_by_selector;break;case"remote":next_fn=get_pl_remote;break;case"tags":next_fn=get_pl_by_tags;break;case"custom_fn":next_fn=get_pl_by_custom_fn;break;case"none":log.debug("next video popup disabled");break;default:log.debug("unsupported option: "+next_by);break}return next_fn&&next_fn(ctx,type,opt,ws,data,cb)}function get_playlist_next(ctx,pl,type,opt){var type_opt=opt[type+"_conf"]||{};if(typeof type_opt.get_playlist_next=="function"){try{return type_opt.get_playlist_next(ctx,pl,type,opt)}catch(e){return void log.err("invalid custom get_playlist_next function: "+(e&&e.toString())||"JS Error")}}if(!pl.length)return;if(opt.cursor_disabled||type!="pnext"&&!opt.force_next){if(!pl.find(function(e){return!e.played&&!e.is_static})){var f=pl.filter(function(e){return!e.is_static});if(!f.length)f=pl;return f[Math.floor(Math.random()*f.length)]}if(type=="ppanels"){pl=pl.concat().sort(function(a,b){return b.type==a.type?a.rank-b.rank:wn_type_pri[wn_type[a.type]]-wn_type_pri[wn_type[b.type]]})}return pl[0]}if(ctx.is_inline()){var s;if(!(s=E.session[ctx.id]))return pl[0];if(s.curr==s.views.length-1)return pl[s.curr];return s.views[s.curr+1]}pl=E.conf.loop?pl:pl.filter(function(e){return!e.played});var idx=E.spark.storage_db.get_int(pr_class+"cursor")+1||0;var len=pl.length,pos=get_playlist_pos(ctx,pl);if(pos==idx)idx++;else if(pos!==undefined&&!opt.disable_play_next)idx=pos+1;idx%=len;if(pos==idx&&!E.conf.loop)return;E.spark.storage_db.set(pr_class+"cursor",idx);return pl[idx]}function get_playlist_pos(ctx,pl,el){el=el||{};var page_url=el.url||el.page_url||E.spark.get_top_url();var p=ctx.player,url_key=el.url_key||p&&p.url_key;for(var i=0;i<pl.length;i++){var url=pl[i].url||pl[i].page_url||pl[i].url_key;if(url==page_url||url==url_key)return i}}function get_playlist_url(url){if(!url)return{};url=zurl.parse(util.absolute_uri(url));if(url.hash){var hash=util.remove_from_qs(url.hash.substr(1),["spark_watch_next"]);url.hash=hash?"#"+hash:""}if(url.search){var query=util.remove_from_qs(url.search.substr(1),["spark_watch_next"]);url.path=url.pathname+(query?"?"+query:"")}var orig_url=zurl.uri_obj_href(url);url=E.spark.gen_page_url(orig_url,E.conf.link_tags);return{orig_url:orig_url,url:url}}function get_playlists(ctx,last,hits,opt,cb,cb_err){cb_err=cb_err||function(){};var p=zutil.pick(opt,"by_pages","ignore","ts_limit","limit_to","min_views","cdn_host");add_domains(p,opt);if(opt.map_vinfo)p.map_vinfo=1;p.dplatform=util.is_mobile?"mobile":"desktop";var s,page=E.spark.get_top_url(),url=ctx.player&&ctx.player.url||"";if(!opt.disable_type&&(s=util.url2videotype(url)||util.url2videotype(page))){p.video_type=s}if(!opt.disable_category&&(s=util.show_url2category(page)||opt.force_category)){p.category=s}if(!opt.disable_language&&(s=util.url2lang(page)))p.lang=s;if(hits>=1e3)perr({id:"playlist_max_hits",delay:false,hits:hits});hits=Math.max(hits,opt.min_hits||0);api.get_playlists(last,hits,p,cb,cb_err)}function get_popular_range(type,dim,opt){var last=[],view={},hits=0,conf=opt[type+"_conf"];var period={popular:{h:"1w",l:"1d"},trending:{h:"1d",l:"6h"},"new":{h:"new"},rank:{h:"1w",l:"1d"},hot:{h:"1d",l:"6h"}};E.set_pl_period(conf,["popular","trending","rank","hot"],period);var map=opt.map||get_content_map(type,dim,conf.content);map.forEach(function(r){r.forEach(function(e){view[e]=(view[e]||0)+1})});for(var v in view){hits+=view[v];last.push(period[v].h);if(period[v].l)last.push(period[v].l)}return hits&&{last:last,map:map,period:period,view:view}}function get_preload_size(ctx,div,opt){var max,size=get_div_size(div,opt),types=get_pl_conf_type(E.conf);var get_size=function(type){var s;switch(type){case"pnext":s=playlist_util.get_popup_size(size,opt);return{width:2*s.height,height:s.height};case"ptile":s=get_widget_size(type,size,opt);return{width:Math.floor(size.width/s.cols),height:Math.floor(size.height/s.rows)};case"ppanels":return{width:Math.floor(.4*size.width),height:Math.floor(.4*size.height)};case"pslide":return size}};types.forEach(function(e){var s;if(e=="pslide"&&!ctx.is_slide_allowed()||!(s=get_size(e)))return;if(!max||max.width*max.height<s.width*s.height)max=s});return max?max.width+"x"+max.height:"400x320"}function get_spark_link(){return"http://holaspark.com?cam=wm_"+id+"_"+E.spark.customer}function get_type_next_by(type,opt,types){var next_by,pconf=opt[type+"_conf"]||{};if(type=="pslide"&&!pconf.next_by){types=types||get_pl_conf_type(E.conf);next_by=(types.includes("ptile")?opt.ptile_conf.next_by:opt.ppanels_conf.next_by)||"slide"}return next_by||pconf.next_by||opt.next_by||(type=="pnext"?"selector":type=="ppanels"?"panels":"popular")}function get_url_type(ctx){return is_inline(ctx)?"video":"page"}function get_widget_container(ctx,type,opt){if(!ctx.attached)return;var f;switch(type){case"pnext":f=popup_ui&&popup_ui.NextPopupFrame;break;case"ptile":f=tile_ui;break;case"ppanels":f=panels_ui&&panels_ui.PanelsPopupFrame;break;case"pslide":f=tile_ui;break}if(util.is_enabled(f))return ctx[type+"_popup"]=new f(ctx,opt,type)}function get_widget_div(opt){var div=$("<div>").css({display:"block","pointer-events":"all"});var size=opt.div_size||{width:"600px",height:"450px"};div.css(assign({top:0,left:0,position:"absolute"},size));div=div.get(0);if(E.conf.z_index)div.css("z-index",E.conf.z_index);document.body.appendChild(div);return div}function get_widget_size(type,size,opt){var map,conf=opt.ptile_conf||{};if(conf.next_by=="none")return{cols:3,rows:3};if(type=="papp")return{cols:1,rows:12};if(type=="ppanels")return{cols:1,rows:5};if(["pslide","pnext"].includes(type)){conf=opt[type+"_conf"]||{};return type=="pnext"?{cols:conf.cols||4,rows:conf.rows||5}:{cols:conf.cols||1,rows:conf.rows||5}}var res={},rows=conf.rows||"auto",cols=conf.cols||"auto";if((map=opt.map||conf.map)&&map.length){var row=map[0];if(map.length>1)rows=map.length;if(row.length>1)cols=row.length;res.map=map}if(rows!="auto"&&cols!="auto")return assign(res,{cols:cols,rows:rows});var tsize=opt.size||conf.size;var add=function(num,key,skey,border){res[key]=num=="auto"?Math.floor(size[skey]/(tsize[skey]+border)):num};add(cols,"cols","width",conf.lborder);add(rows,"rows","height",conf.tborder);return res}function history_filter(src,dst,ctx,type,opt){var hits,opts={urls:{},url_key:(ctx.player||{}).url_key,page_key:E.spark.page2cache(E.spark.get_top_url())};if(type=="pslide"||type=="ptile"||type=="papp"){var conf=opt[type+"_conf"];hits=opt.rows*opt.cols||conf.rows*conf.cols||9}else if(type=="ppanels")hits=5;if(hits){filter_playlist(src,dst,undefined,hits,assign({history:E.history},opts));if(dst.length<hits)filter_playlist(src,dst,undefined,hits,opts);if(dst.length<hits)dst=[]}else dst=src;return dst}function history_init(){var key;var history=E.spark_modules.history.data||[];var h=E.history={page_key:{},url_key:{}};history.forEach(function(e){if(e.page_url)h.page_key[E.spark.page2cache(e.page_url)]=e;if(key=e.url_key||e.cache_url)h.url_key[key]=e});for(var name in cache){if(name.endsWith("_playlist")&&cache[name])cache[name].playlist=undefined}return h}function host_init(url){E.host=zurl.parse(url).hostname}function invalidate(){cache.sel_playlist=undefined;E.msg.invalidate()}function is_inline(ctx){return ctx&&ctx.is_inline&&ctx.is_inline()}function is_page_url_allowed(url,opt){var blacklist=opt.page_blacklist;if(!blacklist)return true;for(var i=0;i<blacklist.length;i++){if(url.includes(blacklist[i]))return false}return true}function on_player_ad_attach(player,ctx){log.debug("on player ad attached "+player.id);var pl,id=player.wrapper.id;if(!(pl=E.playlist.find(function(p){return p.ended&&p.id==id})))return;pl.ad_active=true;player.once("detach_ad",function(ctx){log.debug("on player ad detached "+player.id);pl.ad_active=false})}function on_player_attach(player,ctx){log.debug("on player attached "+player.id);if(E.conf.is_player_allowed&&!E.conf.is_player_allowed({E:E,player:player,ctx:ctx})){return log.info("player is excluded")}if(!E.monitor)E.monitor=setInterval(update_players,500);var pl_ctx,id=player.wrapper.id,sess=E.session[id];var rm=function(pl){var index=E.playlist.indexOf(pl);if(index>=0){E.playlist.splice(index,1);pl.detach(pl.player);pl.player.controls.off("next_suggestion_play",_play_next)}};player.media_info=(sess&&sess.views[sess.curr]||{}).media_info;if(!(pl_ctx=ctx.attached_pl)){var pl_prev;pl_ctx=ctx.attached_pl=util.is_app?new PlaylistApp({id:id}):new Playlist({id:id});pl_ctx.video_ctx=ctx;if(pl_prev=E.playlist.find(function(pl){return pl.ended&&pl_ctx.id==pl.id})){if(E.conf.copy_ctx_on_reattach&&!player.controls.is_playing()&&!pl_prev.played_inline){assign(pl_ctx,zutil.pick(pl_prev,"started","ended","is_live"))}rm(pl_prev)}pl_ctx.attach(player);E.playlist.push(pl_ctx);if(E.conf.ab_test&&E.conf.ab_test.enable){pl_ctx.ab_test=ab_test;ab_test.init(E.conf.ab_test.groups,player,E.spark,util.is_mobile?"mobile":"desktop",util.browser&&util.browser.browser,util.guess&&util.guess.os)}}var show_suggestion=function(hide){this.show_suggestion=!hide;this.monitor_playback()};var on_ended=pl_ctx.video_finished.bind(pl_ctx,false);var _play_next=pl_ctx.video_finished.bind(pl_ctx,true);var on_show_suggestion=show_suggestion.bind(pl_ctx);var on_hide_suggestion=show_suggestion.bind(pl_ctx,true);var controls=player.controls;controls.on("pre-ended",on_ended);controls.on("next_suggestion_show",on_show_suggestion);controls.on("next_suggestion_hide",on_hide_suggestion);controls.on("next_suggestion_play",_play_next);history_init();player.once("detach",function(_ctx){log.debug("on player detached "+player.id);if(!pl_ctx.ended){pl_ctx=_ctx.attached_pl=rm(pl_ctx);controls.off("next_suggestion_play",_play_next)}controls.off("pre-ended",on_ended);controls.off("next_suggestion_show",on_show_suggestion);controls.off("next_suggestion_hide",on_hide_suggestion);if(!E.playlist.length)E.monitor=clearInterval(E.monitor)})}function play_url(ctx,next,is_click,type,state,play_inline){if(next.type=="none")return;log.debug("switching to another video");if(ctx.autoclick&&ctx.autoclick.inline_hide_all&&ctx.hide_all)ctx.hide_all();ctx.loading_next=true;var metric=is_click?"next_click_n":"next_autoclick_n";E.stats_inc(metric,type,state,play_inline);var _is_inline=ctx.is_inline&&ctx.is_inline();var url=!_is_inline&&next.url||next.page_url;if(_is_inline&&!play_inline&&!url&&next.media_info)url=get_playlist_url(next.media_info.page_url).url;if(url){invalidate();next.played=true;E.stats_inc("next_url_n",type,state);return void setTimeout(function(){(cache.target_win||window.top).location.href=url})}if(!ctx.controls)return;next.played=true;ctx.played_inline=true;ctx.container.spark_wn_played_inline=true;log.debug("attempt to play next sources:",next);E.stats_inc("next_src_n",type,state,play_inline);url=next.video_url||next.url;E.spark.content_modified=true;ctx.controls.play_src([{url:url,poster:next.poster,title:next.title,description:next.description,type:util.guess_link_type(url)}]);invalidate()}function playlist_entry(e,opt,dbg){var dur,p,d,vi=e.video_info||{};var use=function(key){return opt.map_vinfo?vi[key]:opt["use_"+key]&&vi[key]};p=use("video_poster")||vi.poster||vi.video_poster;d=use("title")||util.str_longest(vi.description,vi.title);dbg=dbg||{};if(!dbg.allow_empty&&(!dbg.empty_poster&&!p||!dbg.empty_desc&&!d||opt.disable_live&&vi.is_live)){return}var entry={poster:p,description:d,total:vi.total||0,url_md5:e.url_md5};if(opt.show_category)entry.category=e.category||"unknown";if(!opt.hide_duration)entry.dur=vi.dur;if(d&&entry.dur&&(dur=playlist_util.sec_to_dur(entry.dur))&&d.startsWith(dur)){entry.description=d.replace(dur,"")}entry.media_info={page_url:e.location||e.page_url,video_url:vi.url,title:vi.title,description:vi.description,video_type:vi.video_type};if(opt.url_type=="page"){if(entry.page_url=entry.media_info.page_url)entry.page_key=E.spark.page2cache(entry.page_url)}else entry.video_url=entry.media_info.video_url;if(vi.url){entry.url_key=vi.cache_url||E.spark.video2cache(vi.url,util.get_adaptive_type(vi.url))}if(entry.video_url||entry.page_url)return entry}function playlist_widget(div,opt,cb){opt=opt||{};if(!div)div=get_widget_div(opt);var type,ctx=opt._ctx||{};if(!opt._ctx){opt=assign({tile:opt.tile||opt.tile===undefined},opt);if(opt.tile)opt.pnext_conf={next_by:"none"};opt.next_by=opt.type||(opt.selectors?"selector":"popular");var ptile_conf=opt.ptile_conf={};if(opt.rows&&opt.cols){ptile_conf.rows=opt.rows;ptile_conf.cols=opt.cols}if(opt.size)ptile_conf.size=opt.size;if(opt.autoclick_tile!==undefined)ptile_conf.autoclick_tile=opt.autoclick_tile;zutil.defaults_deep(opt,E.default_conf)}if(!(type=get_pl_conf_type(opt)[0]))return void cb();if(opt._ctx&&!(opt.preload_size=ctx.preload_size))ctx.preload_size=opt.preload_size=get_preload_size(ctx,div,opt);var ws,size=get_div_size(div,opt);var playlist_handler=function(pl){if(!pl||!pl.length){if(ctx.monitoring)ctx.monitoring.err(type,"no_data");return}if(["ptile","ppanels","pslide"].includes(type)&&pl.length<ws.rows*ws.cols){if(ctx.monitoring)ctx.monitoring.err(type,"not_enough_data");return}var name,tpl,ftype=get_pl_conf_type(opt)[0];if(type=="pnext"&&(name=opt.pnext_conf&&opt.pnext_conf.next_by))ctx[type]=cache[name+"_playlist"];if(!(tpl=ctx[type])||tpl.playlist!=pl||!tpl.next){tpl=ctx[type]={};tpl.playlist=pl;update_playlist(ctx,pl,type);if(type!="ptile"&&!tpl.next)tpl.next=get_playlist_next(ctx,pl,type,opt)}if(opt._state=="preload"||opt._state=="hidden"||type!=ftype||typeof div=="function"&&(!(div=div(ctx,type,opt))||!(div=div.get_container()))){return}$(div).empty();if(opt._state=="hidden")return;
if(type=="ptile"){ptile_widget_uninit.call(ctx);var conf=opt.ptile_conf;var autoclick_type=conf.autoclick_type?conf.autoclick_type:typeof conf.autoclick_tile=="number"||!opt.force_next||opt.cursor_disabled?"tile":opt.loop?"random":"history";if(conf.remote)autoclick_type="random";var autoclick=conf.autoclick||ctx.is_autoclick_allowed&&ctx.is_autoclick_allowed()&&ctx.get_autoclick_count();if(E.edit_box_enabled())ctx.edit_box=new playlist_editor(type);ctx.info_popup=E.create_info_popup(ctx,div);var wopt={spark:E.spark,stats:E.stats,mode:"tile",add_powered_logo:opt.add_powered_logo,log:log,rtl:ctx.rtl,tborder:conf.tborder,lborder:conf.lborder,min_rows:conf.min_rows,rows:conf.rows,cols:conf.cols,skip_small:conf.skip_small,size:conf.size,skip_author:opt.skip_author,hide_duration:opt.hide_duration||conf.hide_duration,skip_preview:opt.skip_preview,show_play_icon:conf.show_play_icon,hide_views:conf.hide_views,show_info:conf.show_info,hover_anim_time:conf.hover_anim_time,add_play_button:conf.add_play_button,play_button_size:conf.play_button_size,views_count:opt.views_count,disable_link_tile:opt.disable_link_tile,css:opt.css,add_dbg_info:E.add_dbg_info,disable_visibility_check:opt.disable_visibility_check,link_tags:E.conf.link_tags,autoclick:{enable:!ctx.autoclick_cancelled&&opt._state=="ended"&&!!autoclick,timeout:autoclick,player:ctx.player,type:autoclick_type,on_cancel_autoclick:ctx.on_cancel_autoclick&&ctx.on_cancel_autoclick.bind(ctx),tile:conf.autoclick_tile},strings:{item_views:t.bind(null,"views_text"),countdown_cancel:t("countdown_cancel")},events:{show:function(){E.popup_inc("show",opt._state,"tile")}},handlers:{play:function(){ctx.controls.play()},play_next:function(next,is_click){if(is_click&&ctx.info_popup&&ctx.info_popup.popped){return ctx.emit("info_hide")}E.play_next(ctx,{next:next},is_click,type,opt._state)},on_context_menu:function(e,tile,idx,next,_opt){ctx.emit("info_show",e);if(!ctx.edit_box)return;ctx.edit_box.render_edit_button(tile,idx,next,_opt)},stats_inc:function(_name){E.stats_inc(_name,type,opt._state)}},show_category:conf.show_category!==undefined?conf.show_category:opt.show_category};assign(wopt.autoclick,zutil.pick(opt.autoclick,"countdown_on_hover","navigate_on_hover_enabled","navigate_on_hover_sec"));ctx.ptile_widget=new widget.Widget(ctx.ptile.playlist||[],div,wopt);if(ctx.on)ctx.on("widget_hide",ptile_widget_uninit,ctx);return}draw_widget(ctx,type,div,opt)};preload(type,ctx,size,opt,function(data){ws=get_widget_size(type,get_div_size(div,opt),opt);get_playlist(ctx,type,opt,ws,data,function(pl){get_pl_static(ctx,type,opt,undefined,pl,function(pl){try{playlist_handler(pl)}catch(e){log.debug(e)}if(opt.done_cb)opt.done_cb();cb()})})})}function preload(type,ctx,size,opt,cb){var master=ctx.master||{};if(master.hola_playlist||master.spark_playlist)return void cb([]);var hits=0,c=cache.preload=cache.preload||{};if(c.playlist||!zutil.is_mocha()&&ctx==E)return void cb(c.playlist);var _finally=function(playlist){var cbs=c.et;if(!cbs)return;c.et=undefined;for(var i=0;i<cbs.length;i++)cbs[i](playlist)};var last=[];var types=get_pl_conf_type(E.conf);types.forEach(function(e){var next_by=get_type_next_by(e,opt,types);if(!["panels","popular","slide","trending"].includes(next_by))return;var ws=get_widget_size(e,size,opt)||{};if(ws.rows*ws.cols<=0)return;hits=Math.max(ws.rows*ws.cols,hits);var range=get_popular_range(e,ws,opt)||{};if(!range.last)return;range.last.forEach(function(l){if(!last.includes(l))last.push(l)})});if(!hits)return void cb(c.playlist={});if(opt._state!="preload")E.stats_inc("no_preload_n",type,opt._state,is_inline(ctx));if(c.et)return void c.et.push(cb);c.et=[cb];var cb_err=function(e){log.err(util.zerr_e2s(e));c.playlist={};_finally()};var playlists_handler=function(res){if(!res)E.stats.inc_d("get_playlists_err_n");if(E.conf.fix_playlists)E.conf.fix_playlists(res);_finally(c.playlist=res)};get_playlists(ctx,last,hits,opt,playlists_handler,cb_err)}function ptile_widget_uninit(opt){if(!this.ptile_widget||opt&&opt.type!="ptile")return;if(this.info_popup)this.info_popup=this.info_popup.uninit();if(this.edit_box)this.edit_box=void this.edit_box.uninit();this.ptile_widget=void this.ptile_widget.uninit();this.off("widget_hide",ptile_widget_uninit)}function set_media_info(next){var info=assign({},next.media_info);E.spark.msg.set_title_cb(next.title||"",info,function(){E.spark.msg.set_description_cb(next.description!=next.title?next.description||"":"",info,function(){})})}function setup_msg_handlers(){E.msg.add_top_handler("sel_playlist",function(){return(cache.sel_playlist||{}).playlist});E.msg.add_top_handler("invalidate",function(){cache.sel_playlist=undefined;find_next_video(E,E.conf)});E.msg.add_top_handler("is_frame_floating",function(idx){var w;if(!(w=(E.msg.frames[idx]||{}).frame))return;var f=$("iframe").get().find(function(_f){return _f.contentWindow==w});return f&&E.conf.is_frame_floating($,f)});E.msg.add_top_handler("get_custom_fn_playlist",function(){return cache&&cache.custom_fn_playlist||[]});var update=function(is_fs){E.playlist.forEach(function(pl){pl.emit("fullscreen",is_fs)})};E.msg.add_frame_handler("fullscreen",update);playlist_util.add_rm_fs_listener(false,function(){var is_fs=dom_util.is_fullscreen();if(util.is_top)E.msg.fullscreen("all",is_fs);update(is_fs)})}function update_players(){E.playlist.forEach(function(pl){pl.monitor_playback()})}function update_playlist(ctx,pl,type){var key,h=E.history;var url_type=get_url_type(ctx);if(url_type=="page")key=pl[0].page_url?"page_url":"url";pl.forEach(function(el){if(!el.orig_url){var res=get_playlist_url(el[key]);el.orig_url=res.orig_url;el[key]=res.url}if(!E.conf.loop&&(h.page_key[el.page_key]||h.url_key[el.url_key]))el.played=true});if(type=="ptile"&&url_type=="video"){pl=pl.sort(function(a,b){return b.played==a.played?b.total-a.total:+!!a.played-+!!b.played})}}zutil.inherits(Playlist,events.EventEmitter);function Playlist(opt){if(!(this instanceof Playlist))return new Playlist(opt);this.id=opt.id||0;this.log=log;this.allowed={};opt=this.opt=assign({_ctx:this},E.conf);this.autoclick=opt.autoclick;var _this=this;var types=get_pl_conf_type(this.opt);types.forEach(function(type){_this.allowed[type]=true});this.pnext_rule=this.init_pnext_rule(function(left){if(left)return _this.emit("sec_left",left);_this.emit("video_finished")});this.monitoring=new Monitoring}Playlist.prototype.set_show_time=function(type){var name=type+"_show_time_",diff=+Date.now()-this[type+"_start_t"];E.stats.set_d(name+"max",Math.max(E.stats.get(name+"max")||0,diff));E.stats.inc_d(name+"total",diff);E.stats.inc_d(name+"count");E.stats.set_avg_d(name+"avg",name+"total",name+"count")};Playlist.prototype.hide_popup=function(type,force){var opt=this.opt;this.monitoring.hide(type);var _t=type+"_popup";var etype=type+"_et";$(this.container).removeClass(pr_class+"active_"+type);if(this[etype])this[etype]=false;if(!this[_t])return;this[_t]=undefined;this.emit("frame_hide",{type:type,force:force});if(opt.on_hide_popup)opt.on_hide_popup({_this:this,E:E,$:$})};Playlist.prototype.show_popup=function(type,state){var _this=this;if(E.conf.can_show_popup&&!E.conf.can_show_popup({E:E,type:type,state:state,_this:this})){return}var et=type+"_et";if(this[et])return;this.hide_popup(type);if(state!="preload"){if(this.ab_test)this.ab_test.send_show(type);this.monitoring.show(type,state)}var opt=assign(this.opt,{_force_type:type,_state:state});this[type+"_start_t"]=+Date.now();this[et]=true;if(opt.on_show_popup)opt.on_show_popup({_this:this,E:E,$:$});playlist_widget(get_widget_container,opt,function(){if(!_this.attached||!_this[et])return;_this[et]=undefined;if(opt._state!="preload")_this.monitoring.render(!!_this[type+"_popup"],type,opt._state);if(opt._state!="preload"&&_this[type+"_popup"]){_this.controls.emit("playlist.show");$(_this.container).addClass(pr_class+"active_"+type);if(opt._state=="ended")close_plugins(_this.controls)}if(opt._state=="preload"||opt._state=="hidden")_this.hide_popup(type,true)})};Playlist.prototype.is_floating_set=function(){return E.is_floating_mode&&E.is_floating_mode(this.container)||$(this.container).hasClass("floating-video")||$(this.container).closest(".floating-video").length>0||$(window.document.body).hasClass("floating-video-iframe")||this.is_floating};Playlist.prototype.is_floating_mode=function(){var is_floating=this.is_floating_set(),isize=this.win_size;if(!is_floating&&E.conf.fl_mode_detect&&isize&&isize.width==window.innerWidth&&isize.height==window.innerHeight){var pos=playlist_util.get_container_pos(this);var ipos=this.player_pos;is_floating=ipos&&(pos.top!=ipos.top||pos.left!=ipos.left)&&(pos.width!=ipos.width||pos.height!=ipos.height)}if(E.conf.is_frame_floating&&!util.is_top&&!this.is_fl_et){this.is_fl_et=true;var _this=this;E.msg.is_frame_floating_cb(function(res){_this.is_fl_et=false;if(_this.is_floating==res)return;_this.is_floating=res;_this.monitor_playback()})}if(this.is_floating_old&&!is_floating)this.update_size();return this.is_floating_old=is_floating};Playlist.prototype.is_ad_active=function(){return E.is_ad_playing&&E.is_ad_playing(this.container)||this.controls.is_ad_active()||this.controls.ad_active||this.ad_active};Playlist.prototype.is_type_allowed=function(type){return this.allowed[type]||this[type]};Playlist.prototype.update_widget=function(type,allow_popup,opt){var popup=type+"_popup";opt=opt||{};if(!this[popup]&&allow_popup)this.show_popup(type,opt.state);else if(this[popup]&&!allow_popup)this.hide_popup(type,opt.force)};Playlist.prototype.is_slide_allowed=function(){var swidth=window.screen.width,sheight=window.screen.height;if(swidth>sheight){swidth=sheight;sheight=window.screen.width}var size=this.pslide_conf.screen_size;return this.is_type_allowed("pslide")&&this.player_pos&&(this.player_pos.width<=this.opt.min_width||util.is_mobile&&swidth<size.width&&sheight<size.height)};Playlist.prototype.is_inline=function(){return this.autoclick.mode=="inline"};Playlist.prototype.is_inline_forced=function(){return this.is_inline()&&this.autoclick.force_inline};Playlist.prototype.is_autoclick_allowed=function(){return!!this.autoclick.mode};Playlist.prototype.get_autoclick_count=function(){return this.opt._state=="paused"?this.autoclick.paused_count:this.autoclick.count};Playlist.prototype.init_auto_trigger=function(){var opt=this.opt.auto_trigger;if(!opt||!opt.enable||this.loading_task||this.auto_trigger||util.is_mobile){return}if(opt.sec_to_video_end){var delay=(this.player.get_duration()||0)-opt.sec_to_video_end;if(delay>(opt.min_delay||0))return void(this.auto_trigger=delay);return}var _this=this;var headtmap_response_handler=function(ret){if(!_this.loading_task)return;E.stats.inc_d("auto_trigger_fetch_success_n");var data=ret&&ret.res;if(!data||!data.view_sec||!data.view_sec.length)return void E.stats.inc_d("auto_trigger_fetch_no_data_n");if(data.total<opt.min_views){E.stats.inc_d("auto_trigger_disabled_min_views_n");log.info("too few views for auto trigger");return}var max=0;data.view_sec.forEach(function(v){max=Math.max(max,v)});var threshold=max*opt.threshold/100;var pos=data.view_sec.findIndex(function(v){return v<threshold});E.stats.inc_d("auto_trigger_has_data_n");if(pos<=0||pos>_this.player.get_duration()-opt.disable_sec){E.stats.inc_d("auto_trigger_disabled_sec_n");log.info("auto trigger threshold not reached");return}_this.auto_trigger=pos*data.interval;E.stats.inc_d("auto_trigger_set_n")};E.stats.inc_d("auto_trigger_fetch_try_n");this.loading_task=true;api.get_heatmaps(this.video_ctx.video_url,function(ret){try{headtmap_response_handler(ret)}catch(e){E.stats.inc_d("auto_trigger_fetch_fail_n");perr({id:"playlist_heatmap_info_fail",throttle:1,info:{error:""+e}});log.warn("error during fetch heatmap info: "+e)}_this.loading_task=false})};Playlist.prototype.validate_auto_trigger=function(pos){var opt=this.opt.auto_trigger;if(!opt||!opt.enable||this.loading_task||!this.auto_trigger||pos<this.auto_trigger||this.playing_discarded){return}var auto_trigger=pos+this.opt.seek_sec_delay;if(auto_trigger>this.player.get_duration()-opt.disable_sec)this.auto_trigger=0;this.auto_trigger=auto_trigger;E.stats.inc_d("auto_trigger_delayed_n")};Playlist.prototype.init_pnext_rule=function(cb){var _this=this,opt=this.opt,conf=opt.pnext_conf;var rules={redir:{on_pause:!opt.disable_popup_on_pause,sec_before_end:opt.sec_before_end,hide_on_end:opt.hide_on_end,seek_sec_delay:opt.seek_sec_delay},inline:{on_pause:!conf.disable_popup_on_pause,sec_before_end:conf.sec_before_end,sec_after_start_dur:conf.sec_after_start_dur,seek_sec_delay:conf.seek_sec_delay}};var ended_ts,left_sec=0,seeked,old_dur=0,old_pos=0;var type=this.is_inline()?"inline":"redir",rule=rules[type];var tile_left_sec=0;if(type!="inline"&&opt.on_end=="tile")tile_left_sec=left_sec=rule.sec_before_end=rule.sec_before_end/2;return{is_allowed:function(pos,dur,wopt){switch(wopt.state){case"paused":return dur&&pos>2&&rule.on_pause&&pos>=conf.sec_after_start;case"playing":return dur&&pos>2&&(dur-pos<=rule.sec_before_end||pos>=conf.sec_after_start&&pos<=conf.sec_after_start+rule.sec_after_start_dur||!wopt.force&&_this.pnext_popup&&_this.pnext_popup.on_main);case"ended":return!rule.hide_on_end&&(rule.no_switch||left_sec||opt.on_end=="popup")}},set_time_left:function(pos,dur,state){var left,delay,seek=rule.seek_sec_delay;if(dur&&pos&&(old_dur!=dur||old_pos!=pos)){left=dur-pos;if(left<=seek&&pos-old_pos>=2||pos<old_pos){seeked=true;left_sec=left}else if(seeked&&left>seek){seeked=false;left_sec=tile_left_sec}old_dur=dur;old_pos=pos;delay=seeked?seek:rule.sec_before_end;if(left_sec&&left<=delay)left=delay-(left_sec-left)}else if(state=="ended"&&!opt.no_switch){delay=seeked?seek:opt.on_end=="popup"?_this.get_autoclick_count():rule.sec_before_end;if(!ended_ts)ended_ts=Date.now();if((left=delay-left_sec-(Date.now()-ended_ts)/1e3)<=0){seeked=left_sec=0;return cb()}}if(left!==undefined)cb({left:left})}}};Playlist.prototype.is_sbutton_allowed=function(){if(!util.is_enabled(side_btn))return false;var opt=this.opt;return this.is_inline()&&this[wn_types[opt.on_pause]]&&!this.ppanels_popup&&!opt.disable_sbutton&&(opt.force_sbutton||!this.player.is_small())};Playlist.prototype.is_sugg_btn_allowed=function(){if(!util.is_enabled(suggestion_btn))return false;var opt=this.opt;return["tile","panel"].includes(opt.on_pause)&&opt.enable_sugg_btn&&!this.is_sbutton_allowed()&&this[wn_types[opt.on_pause]]&&!this.ppanels_popup&&!this.is_floating_mode()&&this.player.controls.is_playing()&&!this.player.is_small()};Playlist.prototype.is_ended=function(){return this.ended&&(!this.is_custom_ended||this.is_custom_ended())};Playlist.prototype.is_manual_pause=function(){this.autoplay=this.autoplay||E.spark.get_feature_if_inited("autoplay");return!this.autoplay||this.autoplay.is_manual_pause(this.player)};Playlist.prototype.is_player_paused=function(){var cntr=this.controls;var is_seeking=cntr.is_seeking()||cntr.scrubbing();return cntr.is_paused()&&!is_seeking&&!(this.ended||this.is_ended()||(cntr.get_ui().media||{}).ended)&&this.is_manual_pause()||this.ppanels_popup&&is_seeking};Playlist.prototype.is_auto_trigger_enabled=function(){var pos=this.player.get_pos();return!this.is_player_paused()&&!this.is_ended()&&this.auto_trigger&&!this.playing_discarded&&pos>this.auto_trigger};Playlist.prototype.monitor_playback=function(){if(!this.attached||this.loading_next)return;if(E.conf.on_monitor_playback&&E.conf.on_monitor_playback({E:E,_this:this})){return}var dur=this.player.get_duration(),pos=this.player.get_pos();if(pos-this.last_pos>2)this.validate_auto_trigger(pos);this.last_pos=pos;var cntr=this.controls,opt=this.opt,ended=this.is_ended();var paused=this.is_player_paused();var _this=this;var is_type_enabled=function(type){return opt.on_pause==type&&pos&&(paused||type=="popup")||opt.on_end==type&&(ended||type=="popup"&&!paused&&!(_this.ptile_popup||_this.ppanels_popup||_this.pslide_popup))||type=="panel"&&_this.is_auto_trigger_enabled()};if(dur&&this.is_live===undefined)this.is_live=this.player.attached&&cntr.is_live_stream();var is_floating=this.is_floating_mode()||this.wait_size_update;var allow=!this.is_ad_active()&&!is_floating&&this.player.is_extra_ui_allowed({feature:"playlist"});var wopt={state:ended?"ended":paused?"paused":"playing",force:!allow};var allow_popup=allow&&!this.is_live&&this.is_type_allowed("pnext")&&is_type_enabled("popup")&&(this.pnext_rule.is_allowed(pos,dur,wopt)||this.show_suggestion);this.update_widget("pnext",allow_popup,wopt);var allow_mobile=!util.is_mobile||!E.conf.disable_mobile;var buffered=cntr.get_buffered()||[];var bpos=cntr.html5?cntr.html5.currentTime:pos;var started=bpos&&buffered.length&&Math.floor(bpos)>buffered.start(0)||ended;started=this.started=this.started||started;var allow_slide=this.is_slide_allowed()||is_type_enabled("slide");allow_popup=allow&&this.is_type_allowed("ptile")&&!allow_slide&&allow_mobile&&started&&is_type_enabled("tile");this.update_widget("ptile",allow_popup,wopt);allow_popup=this.is_type_allowed("ppanels")&&!allow_slide&&allow&&(!dom_util.is_fullscreen()||dom_util.is_fullscreen()&&!opt.disable_fullscreen)&&started&&is_type_enabled("panel");this.update_widget("ppanels",allow_popup,wopt);allow_popup=allow&&allow_slide&&started&&(is_type_enabled("slide")||is_type_enabled("tile")||is_type_enabled("panel")&&!_this.is_auto_trigger_enabled());this.update_widget("pslide",allow_popup,wopt);this.pnext_rule.set_time_left(pos,dur,wopt.state);allow=this.is_sbutton_allowed();if(allow&&!this.sbtn)this.sbtn=new side_btn(this,opt);else if(!allow&&this.sbtn)this.sbtn=void this.emit("frame_hide",{type:"sbutton"});allow=this.is_sugg_btn_allowed();if(allow&&!this.sugg_btn)this.sugg_btn=new suggestion_btn(this,opt);else if(!allow&&this.sugg_btn)this.sugg_btn=void this.emit("frame_hide",{type:"sugg_btn"});this.update_wn_button();if(wopt.state=="ended"&&(this.ptile_popup||this.ppanels_popup||this.pslide_popup)){close_plugins(this.controls)}};Playlist.prototype.update_wn_button=function(){var player=this.player,opt=this.opt;if(!player.controls||player.controls.name!="hola"||!["tile","panel"].includes(opt.on_pause)||!this[wn_types[opt.on_pause]]||opt.disable_wn_button){return}if(!this.wn_btn){this.wn_btn=player.controls.custom_buttons.add({class_name:"vjs_watch_next_btn",text:t("watch_next_title"),order:12});this.wn_btn.on("click",function(){player.controls.pause()})}this.wn_btn.force_hide(this.is_floating_mode()||!player.controls.is_playing())};Playlist.prototype.get_control_bar=function(){var cbar=E.conf.control_bar?this.container.find(E.conf.control_bar):$(this.controls.get_ui().control_bar);return cbar.length&&cbar};Playlist.prototype.get_bottom_offset=function(){var cbar,pbar,h=0,master=this.master;if(!(cbar=this.get_control_bar())||!playlist_util.is_visible(cbar)&&!(master&&master.userActive)){return h}h+=cbar.height();if((pbar=$(this.controls.get_ui().progress_bar))&&pbar.length){var co=cbar.offset(),po=pbar.offset();if(co.top>po.top)h+=pbar.height();else if(this.opt.pbar_autopos)h-=po.top-co.top;else if(!this.opt.disable_ooyala_autopos&&this.player.name=="ooyala"&&(pbar=pbar.find(".oo-scrubber-bar"))&&pbar.length){po=pbar.offset();if(po.top>co.top)h-=po.top-co.top}}return h};Playlist.prototype.on_start_preload=function(){for(var type in this.allowed)this.update_widget(type,true,{state:"preload"});this.init_auto_trigger()};Playlist.prototype.update_size=function(){var wait,resize,_this=this,is_floating=this.is_floating_set();if(!this.update_size_fn)this.update_size_fn=this.update_size.bind(this);if(is_floating!=this.is_floating_old){if(is_floating)this.monitor_playback();else wait=true}if(is_floating)return;if(wait||(resize=!util.is_mobile&&this.win_size&&(this.win_size.width!=window.innerWidth||this.win_size.height!=window.innerHeight))){if(this.wait_size_update)clearTimeout(this.wait_size_update);this.wait_size_update=setTimeout(function(){_this.wait_size_update=_this.monitor_playback()},650);if(resize)this.monitor_playback()}this.win_size={width:window.innerWidth,height:window.innerHeight};if(this.ppanels_popup)return;this.player_pos=undefined;var pos=playlist_util.get_container_pos(this);if(this.update_to)this.update_to=clearTimeout(this.update_to);if(!pos.width&&this.update_retry<10){this.update_retry++;return void(this.update_to=setTimeout(this.update_size_fn,50))}this.update_retry=0;this.player_pos=pos};Playlist.prototype.attach=function(player){var _this=this;this.player=player;this.controls=player.controls;this.master=this.controls.get_player();this.loading_next=false;if(!(this.container=get_container(player)))return log.err("player container not found");this.was_played_inline=this.container.spark_wn_played_inline;this.before_unload=this.detach.bind(this);util.on("beforeunload",this.before_unload);this.rtl=this.opt.rtl!==undefined?this.opt.rtl:dom_util.detect_direction(this.container)=="rtl";this.on_start_preload_cb=this.on_start_preload.bind(this);this.player.once("buffer_5sec",this.on_start_preload_cb);this.pslide_conf=this.opt.pslide_conf;if(E.is_ended)this.is_custom_ended=E.is_ended(player);if(this.html5=this.player.html5){$(this.html5).on("play",this.on_play=function(){setTimeout(function(){_this.monitor_playback()})})}this.attached=true;this.update_retry=0;if(this.opt.on_attach)this.opt.on_attach({_this:this,E:E,$:$,util:util});this.update_size();var sess;if(!(sess=E.session[_this.id])){E.session[_this.id]={views:[{video_url:this.player.url,media_info:{video_url:_this.player.url,page_url:E.spark.get_top_url()}}],curr:0}}window.addEventListener("resize",this.update_size_fn);var handle_player_data=function(d){d.title=_this.controls.get_title()||d.title;d.description=_this.controls.get_description()||d.description;_this.video_info=d;var views=(E.session[_this.id]||{}).views;if(views&&views[0].video_url==_this.player.url){var info={description:d.description,title:d.title};views=assign(views[0],{poster:d.poster},info);if(views.media_info)assign(views.media_info,info)}};var media_info=sess&&(sess.views[sess.curr]||{}).media_info;if(media_info)handle_player_data(media_info);else player.get_player_info_cb(handle_player_data);var c=$(this.container).parent()[0];this.attr_unwatch=dom_util.attr_watch(c,{attr:"class",toggle_pattern:this.opt.floating_class||/(floating|sticky)/,watch_fn:function(){_this.monitor_playback()}});this.fullscreen_change_fn=function(is_fs){this.emit("fullscreenchange",{is_fullscreen:is_fs});this.hide_all();if(this.sbtn)this.sbtn=void this.emit("frame_hide",{type:"sbutton"});this.monitor_playback()}.bind(this);this.on("fullscreen",this.fullscreen_change_fn);log.debug("attached "+player.id)};Playlist.prototype.hide_all=function(){["ppanels","pslide","ptile","pnext"].forEach(function(type){if(this.is_type_allowed(type))this.hide_popup(type,{force:true})}.bind(this))};Playlist.prototype.detach=function(){if(!this.attached)return;log.debug("detach");this.attached=false;this.emit("detach");this.hide_all();util.off("beforeunload",this.before_unload);window.removeEventListener("resize",this.update_size_fn);if(this.fullscreen_change_fn)this.off("fullscreen",this.fullscreen_change_fn);if(this.attr_unwatch)this.attr_unwatch();if(this.wn_btn){this.player.controls.custom_buttons.remove(this.wn_btn);this.wn_btn=null}this.player.off("buffer_5sec",this.on_start_preload_cb);if(this.on_play)$(this.html5).off("play",this.on_play);if(this.update_to)this.update_to=clearTimeout(this.update_to);if(this.wait_size_update)this.wait_size_update=clearTimeout(this.wait_size_update);this.loading_task=undefined;if(this.opt.on_detach)this.opt.on_detach({_this:this,E:E,$:$,util:util})};Playlist.prototype.video_finished=function(is_click){if(!this.pnext_popup&&this.ptile_popup&&is_click){return E.play_next(this,this.ptile,is_click,"pnext","ended",this.is_inline())}if(this.ended=!is_click){var p=this.player;if(this.pnext_rule.is_allowed(p.get_duration(),p.get_pos(),{state:"ended"})){return}}this.emit("video_finished",is_click)};Playlist.prototype.on_cancel_autoclick=function(){this.autoclick_cancelled=this.opt._state!="paused"};function Monitoring(){this.possible_ui_switch={ppanels_pslide:true,pslide_ppanels:true}}Monitoring.prototype.show=function(type,state){var tm_now=Date.now();if(this[type]){this.stats_inc(["render_duplicate",type]);this[type].last_tm=Date.now();return}this.stats_inc(["render",type]);this.stats_inc(["render_"+(state||"unknown"),type]);this.ui_switch=this.prev_ui&&tm_now-this.prev_ui.remove_tm<2e3&&(this.possible_ui_switch[this.prev_ui.type+"_"+type]||this.prev_ui.type==type);if(this.ui_switch)this.stats_inc(["ui_switch",this.prev_ui.type+"_"+type]);this[type]={init_tm:tm_now,last_tm:tm_now,err_code:null,rendered:this.ui_switch&&this.prev_ui.rendered,type:type}};Monitoring.prototype.stats_inc=function(names,postfix){if(typeof names=="string")names=[names];postfix=postfix||"_n";var name="mon";for(var i=0;i<names.length;i++){name+="_"+names[i];E.stats.inc(name+postfix)}};Monitoring.prototype.hide=function(type){if(!this[type])return;this.prev_ui=this[type];this.prev_ui.remove_tm=Date.now();this[type]=undefined};Monitoring.prototype.err=function(type,code){var _session;if(_session=this[type])_session.err_code=code};Monitoring.prototype.render=function(success,type,state){this.stats_inc(["rendered",type]);var _session;if(!(_session=this[type]))return this.stats_inc(["rendered_fail","no_session",type]);if(success){if(_session.rendered)this.stats_inc(["rendered_duplicate",type,state||"unknown"]);else this.stats_inc(["rendered_success",type,state||"unknown"]);_session.rendered=true}else this.stats_inc(["rendered_fail",_session.err_code||"unknown",type])};zutil.inherits(PlaylistApp,events.EventEmitter);function PlaylistApp(opt){if(!(this instanceof PlaylistApp))return new PlaylistApp(opt);this.id=opt.id||0;this.log=log;this.allowed={};this.playlist_items=[];opt=this.opt=assign({_ctx:this},E.conf)}PlaylistApp.prototype.attach=function(player){var _this=this;this.player=player;this.controls=player.controls;this.on_start_preload_cb=this.load_playlist.bind(this);this.monitor_playback_cb=this.monitor_playback.bind(this);this.player.once("buffer_5sec",this.on_start_preload_cb);this.controls.on("play",this.monitor_playback_cb);this.controls.on("pause",this.monitor_playback_cb);this.attached=true;if(!E.session[_this.id]){E.session[_this.id]={views:[{video_url:this.player.url,media_info:{video_url:_this.player.url,page_url:E.spark.get_top_url()}}],curr:0}}player.get_player_info_cb(function(d){d.title=_this.controls.get_title()||d.title;d.description=_this.controls.get_description()||d.description;_this.video_info=d;var views=(E.session[_this.id]||{}).views;if(views&&views[0].video_url==_this.player.url){assign(views[0],{description:d.description,poster:d.poster,title:d.title})}});log.debug("attached "+player.id)};PlaylistApp.prototype.is_inline=function(){return true};PlaylistApp.prototype.is_inline_forced=function(){return true};PlaylistApp.prototype.monitor_playback=function(){var p=this.controls,opt=this.opt;if(!p.is_idle())this.ended=false;var ended=this.ended;var is_seeking=p.is_seeking()||p.scrubbing();var paused=p.is_paused()&&!is_seeking&&!ended;var has_items=this.playlist_items.length>0;var expanded=has_items&&(paused&&opt.on_pause!="none"||ended&&opt.on_end!="none");var visible=has_items&&(expanded||p.fullscreen());if(visible&&!this.prev_visible)this.exec("show");if(expanded&&!this.prev_expanded)this.exec("expand");else if(!expanded&&this.prev_expanded)this.exec("collapse");if(!visible&&this.prev_visible)this.exec("hide");if(opt.autoclick.mode=="inline"){if(expanded&&ended&&(!this.prev_ended||this.pending_countdown))this.start_countdown();else this.pending_countdown=false;if(this.check_state("is_countdown_active")&&!this.check_state("is_player_visible")){this.exec("stop_countdown")}else if(this.check_state("is_countdown_stopped")&&this.check_state("is_player_visible")){this.start_countdown()}}this.prev_expanded=expanded;this.prev_ended=ended;this.prev_visible=visible};PlaylistApp.prototype.video_finished=function(){this.ended=true;this.monitor_playback()};PlaylistApp.prototype.update_countdown=function(){};PlaylistApp.prototype.start_countdown=function(){if(this.check_state("is_player_visible")){this.exec("start_countdown",this.opt.autoclick.count);this.pending_countdown=false}else this.pending_countdown=true};PlaylistApp.prototype.load_playlist=function(){var _this=this,type="papp";var opt=assign(this.opt,{_state:"preload",cont_src:"all",min_rows:1});var conf=_this.opt.papp_conf;var range=get_popular_range(type,conf,opt)||{};var num=conf.rows*conf.cols;get_playlists(opt._ctx,range.last,num,opt,function(res){if(!res)return void E.stats.inc_d("get_playlists_err_n");var size=get_widget_size(type,{},opt);get_playlist(opt._ctx,type,opt,size,res,function(pl){_this.playlist_items=pl;if(!pl||!pl.length)return;var data=pl.map(function(p){return{video_url:p.media_info.video_url,poster_url:p.poster,title:p.description,dur:p.dur,preview:p.preview}});_this.exec("init",data);_this.monitor_playback()})})};PlaylistApp.prototype.exec=function(fn,data){return this.controls.hola_java_proxy.module_cb("playlist",fn,data?JSON.stringify(data):"")};PlaylistApp.prototype.check_state=function(fn){return this.exec(fn)=="true"};PlaylistApp.prototype.detach=function(){if(!this.attached)return;this.exec("collapse");this.exec("hide");log.debug("detach");this.attached=false;this.emit("detach");this.player.off("buffer_5sec",this.on_start_preload_cb);this.controls.off("play",this.monitor_playback_cb);this.controls.off("pause",this.monitor_playback_cb)};E.add_autoclick=function(icons,icon,ctx,conf,opt){var auto_trigger=ctx.is_auto_trigger_enabled&&ctx.is_auto_trigger_enabled();if(opt._state!="ended"&&!conf.autoclick_on_pause&&!auto_trigger||ctx.autoclick_cancelled){return}var count=conf.autoclick||auto_trigger&&opt.auto_trigger.autoclick_sec||(ctx.is_autoclick_allowed()?ctx.get_autoclick_count():undefined);if(!isNaN(count)){return icons.add_icon(icon.container,icon.size,assign({autoclick:count},icon))}};E.add_dbg_info=function(el,next,conf){var is_preview_enabled=E.spark.is_feature_inited("video_previews");if(debug_hints&&conf.next_by!="remote"&&(!next.description||!next.poster||is_preview_enabled&&!next.preview)){var text;if(!next.url_md5){text="watch more videos to fill up the panels and wait 15m for "+"database to update"}else{text=[];["poster","description"].forEach(function(e){if(!next[e])text.push(e)});if(is_preview_enabled&&!text.length&&!next.preview)text.push("preview");text="missing "+text.join(", ")}el.append(playlist_util.create_el(pr_class,"span","dbg_info").text(text))}};E.add_hover=function(tile,cb){if(!tile.poster)return;var _this=this;var update_class=function(add){var hclass=pr_class+"tile_hover";if(add&&(tile.poster.hasClass("hola_preview_playing")||tile.poster.hasClass("hola_preview_countdown"))){tile.is_preview_playing=true;if(!tile.hasClass(hclass))tile.addClass(hclass)}else{if(tile.hasClass(hclass))tile.removeClass(hclass);if(tile.unwatch_class)tile.unwatch_class=tile.unwatch_class();if(tile.is_preview_playing&&cb)cb(tile,add);tile.is_preview_playing=false}};var update=function(){if(tile.poster.hasClass("hola_preview_countdown"))update_class(true);if(tile.rm_hover)return;tile.rm_hover=setTimeout(function(){update_class(true)},_this.conf.hover_anim_time*ms_sec)};tile.wait_fn=function(start){if(tile.rm_hover)tile.rm_hover=clearTimeout(tile.rm_hover);update_class();if(tile.unwatch_class)tile.unwatch_class=tile.unwatch_class();if(!start)return;tile.unwatch_class=dom_util.attr_watch(tile.poster[0],{attr:"class",watch_fn:update});update()};tile.hover_fn=function(){if(tile.is_preview_playing)return;tile.wait_fn(true);if(tile.move_fn)tile.on("mousemove",tile.move_fn)};tile.unhover_fn=function(){tile.wait_fn();if(tile.move_fn)tile.off("mousemove",tile.move_fn)};if(util.is_mobile)return tile.on("touchstart",tile.hover_fn);tile.move_fn=function(){if(!tile.poster.hasClass("hola_preview_countdown"))tile.wait_fn(true)};tile.on("mouseenter",tile.hover_fn);tile.on("mouseleave",tile.unhover_fn);
};E.add_powered_by_btn=function(root){if(!E.conf.add_powered_logo)return;var link,el;var create=playlist_util.create_el.bind(this,pr_class);var img=widget.create_img(pr_class+"powered_by_logo");link=create("a","powered_text");link.append(img.create(wm_url));link.attr("href",get_spark_link()).attr("target","_blank").append($("<div>").text(l10n.spark_t("powered_by_text")));el=create("div","powered "+pr_class+"active");root.append(el.append(create("div","powered_info").append(link)));return el};E.create_info_popup=function(ctx,div){if(E.conf.show_info_popup&&!util.is_mobile&&util.is_enabled(widget_info)){return widget_info.powered_by(ctx,{el:div,module_id:id})}};E.delayed_scan=function(){setTimeout(function(){try{E.links.scan()}catch(e){}},0)};E.edit_box_enabled=function(){return util.is_enabled(playlist_editor)&&E.conf.edit_ext&&util.conf.ext_api_key};E.icons_handler=function(ctx,type,opt){var icons=[];return{add_icon:function(container,size,iopt){iopt=iopt||{};var pos={top:0,left:0,height:size.height,width:size.width};var icon={disable_visibility_check:opt.disable_visibility_check,tr:t,is_allowed:function(){return true},pos:pos,icon_location:"center",img_pos:pos,size_px:iopt.size_px,is_top:util.is_top,msg:E.spark.msg,shadow:true,container:container,"class":pr_class+"icon"};if(iopt.autoclick!==undefined){var cl=pr_class+"next_countdown";var on_navigate=function(){E.play_next(ctx,{next:iopt.playlist[iopt.pl_idx]},false,type,opt._state)};var cancel=function(){if(iopt.on_cancel_autoclick)return iopt.on_cancel_autoclick();ctx.on_cancel_autoclick()};var on_show=function(){container.addClass(cl);if(ctx.emit)ctx.emit("on_countdown",true);container.data(pr_countdown,false)};var on_hide=function(){container.removeClass(cl);if(ctx.emit)ctx.emit("on_countdown");container.data(pr_countdown,false)};assign(icon,{on_countdown_cancel:cancel,on_show:on_show,icon_countdown:true,on_hide:on_hide,on_navigate:on_navigate,cl_class:pr_class+"icon_cancel",cd_class:pr_class+"icon_countdown",countdown_on_hover:iopt.autoclick})}icons.push(icon=new play_icon.Icon(icon));return icon},rm_icon:function(icon){var i;if((i=icons.indexOf(icon))==-1)return;icons[i].hide();icons.splice(i,1)},uninit:function(){icons.forEach(function(e){e.hide()});icons=[]}}};E.is_playlist_active=function(spark_player){var _id=spark_player.wrapper.id;var pl=E.playlist.find(function(p){return p.id==_id});return!!(pl.pnext_popup||pl.ptile_popup||pl.ppanels_popup||pl.pslide_popup)};E.play_next=function(ctx,pl,is_click,type,state,force_inline){var next=pl.next;force_inline=force_inline||ctx.is_inline_forced&&ctx.is_inline_forced();if(!force_inline)return play_url(ctx,next,is_click,type,state);var views,sess=E.session[ctx.id]||{},curr=sess.curr;if(!(views=sess.views))return log.debug("view session not found");if((curr=views.indexOf(next))==-1){views.push(next);curr=sess.curr+1}sess.curr=curr;next=views[curr];play_url(ctx,next,is_click,type,state,true);setTimeout(set_media_info.bind(null,next),100)};E.popup_inc=function(name,state,type){E.stats.inc("total_"+name+"_popup_n");E.stats.inc("total_"+state+"_"+name+"_popup_n");name=(type?type+"_":"")+name+"_popup_";E.stats.inc(name+"n");E.stats.inc(name+state+"_n")};E.set_pl_period=function(conf,types,period){types.forEach(function(type){var e;if(!(e=conf[type+"_period"]))return;e=e.split("_");period[type].h=e[0]||period[type].h;period[type].l=e[1]||period[type].l})};E.stats_inc=function(name,type,state,inline){E.stats.inc(name);if(!type)return;E.stats.inc(type+"_"+name);if(state){E.stats.inc(state+"_"+name);E.stats.inc(type+"_"+state+"_"+name)}if(inline){E.stats.inc(type+"_inline_"+name);if(state)E.stats.inc(type+"_inline_"+state+"_"+name)}};E.views_to_text=function(v){return t("views_text",{num:E.conf.views_count(v||0)})};E.was_played_inline=function(spark_player){var _id=spark_player.wrapper.id;var pl=E.playlist.find(function(p){return p.id==_id});return pl&&pl.was_played_inline};var ab_test={info:{}};ab_test.init=function(groups,player,spark,platform,browser,os){if(ab_test.inited)return console.log("ab_test already inited");ab_test.inited=true;ab_test.rand=Math.random();ab_test.groups=groups;ab_test.info.group="none";for(var group in groups){if(ab_test.rand<groups[group]){ab_test.info.group=group;break}}ab_test.player=player;ab_test.spark=spark;ab_test.info.platform=platform;ab_test.info.os=os;ab_test.info.browser=browser;ab_test.info.user_agent=navigator.userAgent;setTimeout(function(){ab_test.send_init()},2e3)};ab_test.get_info=function(){var info=ab_test.info,player=ab_test.player;info.page_url=ab_test.spark.get_top_url();info.video_url=player.url;info.title=player.video_info&&player.video_info.title;info.width=player.container&&player.container.offsetWidth;info.height=player.container&&player.container.offsetHeight;return info};ab_test.send_init=function(){if(!ab_test.inited)return console.log("ab_test send but not inited");if(ab_test.sent)return console.log("ab_test already sent");ab_test.sent=true;var info=ab_test.get_info();perr({id:"ab_test_init",info:{ab_test:info},delay:false})};ab_test.send_click=function(click_id,o){if(!ab_test.inited)return console.log("ab_test send_click but not inited");if(ab_test.sent_click)return console.log("ab_test already sent_click");ab_test.sent_click=true;var info=ab_test.get_info();info.click_id=click_id;info.click_page_url=o&&o.page_url;info.click_title=o.media_info&&o.media_info.title;perr({id:"ab_test_click",info:{ab_test:info},delay:false})};ab_test.send_show=function(type){if(!ab_test.inited)return console.log("ab_test send_show but not inited");if(ab_test.sent_show)return console.log("ab_test already sent_show");ab_test.sent_show=true;var info=ab_test.get_info();info.type=type;perr({id:"ab_test_show",info:{ab_test:info},delay:false})};E.init=function(spark_modules,conf,spark){E.spark_modules=spark_modules;E.spark=spark;E.links=spark_modules.links;E.log=log=spark_modules.log;log.notice("playlist init conf %o",conf);E.conf=conf;E.api=api=E.spark_modules.api;if(conf.on_init){if(conf.on_init({E:E,$:$,util:util})=="skip"){log.notice("playlist disabled via conf on_init");return}}var params=E.spark.params||{};perr=spark_modules.perr;E.conf.link_tags.push({name:hash_param,type:E.conf.disable_hash?"query":"auto"});if(params.debug_hints)debug_hints=true;var ptile_conf=E.conf.ptile_conf;if(ptile_conf.num_mode=="manual"){ptile_conf.cols=ptile_conf.cols||3;ptile_conf.rows=ptile_conf.rows||3}debug_hints=util.has_ext&&E.conf.debug_hints||spark.conf.debug;play_icon.init();E._t=t=l10n.get_t(id);l10n.override(E.conf.strings||{},id);E.playlist=[];E.frames=[];E.stats=E.spark_modules.stats;if(util.is_enabled(suggestion_btn))suggestion_btn.init(E.stats);if(util.is_enabled(side_btn))side_btn.init(E);if(util.is_enabled(popup_ui))popup_ui.init(E);if(util.is_enabled(slide_ui))slide_ui.init(E);if(util.is_enabled(tile_ui))tile_ui.init(E);if(util.is_enabled(panels_ui))panels_ui.init(E);if(E.edit_box_enabled())playlist_editor.init(E.spark_modules);E.msg=_msg("pl",{child_frames:true});setup_msg_handlers();if(!E.conf.disable_css)dom_util.preload_css(util.player_url+require.zdot("playlist_css"));add_conf_func("is_ad_playing",E.conf.ad_detect);add_conf_func("is_floating_mode",E.conf.persistent_detect);add_conf_func("is_ended",E.conf.is_ended);add_conf_func("close_plugins",E.conf.close_plugins);E.spark.api.playlist_widget=playlist_widget;E.spark.on("set_top_url",host_init);history_init();host_init(E.spark.get_top_url());if(!E.conf.disable_ui){if(!zutil.is_mocha())find_next_video(E,E.conf);E.spark_modules.players.on("attach",on_player_attach);E.spark_modules.players.on("attach_ad",on_player_ad_attach)}if(util.is_enabled(playlist_promo))playlist_promo.init(E.conf.promo);E.inited=true;log.debug("inited")};E.t={find_next_video:find_next_video,cache:cache,history_init:history_init};return E});
define("/svc/cdn/pub/feature/autoplay/index.js",{__stub:1});

define("/svc/cdn/pub/feature/video_search/index.js",{__stub:1});
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/zdot.js",[],function(){var E={settings:{open:"{[",close:"]}",it:"it",html:true},include:function(){return""},helpers:{}};var html_escape_table={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function html_escape(s){return s.replace(/[&<>"']/g,function(m){return html_escape_table[m]||m})}var js_escape_table={"'":"\\'",'"':'\\"',"\r":"\\r","\n":"\\n","	":"\\t","\\":"\\\\"};function js_escape(s){return"'"+s.replace(/'|"|\r|\n|\t|\\/g,function(m){return js_escape_table[m]||m})+"'"}function script_escape(s){return s.replace(/<(?=!--|\/?script)/gi,"<\\")}function to_str(val){return val==null?"":""+val}function to_json(val){return val===undefined?"undefined":JSON.stringify(val)}function regex_escape(s){return s.replace(/[[\]{}()*+?.\\^$|\/]/g,"\\$&")}E.last_err=undefined;function scan_block(c,scan){var re=c.open_close_re,m,index,depth,s=scan.s,found;for(depth=0,re.lastIndex=0;m=re.exec(s);){if(m[0]==c.open){if(!depth&&m.index){index=m.index;break}depth++;continue}if(!depth)continue;depth--;if(!depth){found=true;break}}if(index===undefined)index=re.lastIndex||s.length;if(depth)E.last_err='no closing block: "'+s.substr(0,50)+'"';scan.m=s.substr(0,index);scan.s=s.substr(index);scan.found=found;return!!s}function extend(obj){for(var i=1;i<arguments.length;i++){var source=arguments[i];if(!source)continue;for(var prop in source)obj[prop]=source[prop]}return obj}E.template=function(input,c){E.last_err=undefined;c=extend({},E.settings,c);c.open_close_re=new RegExp(regex_escape(c.open)+"|"+regex_escape(c.close),"g");input=""+input;var a=[],it=c.it;var _html_escape=c.html?"html_escape":"";var _script_escape=c.html?"script_escape":"";var _include=c.include||E.include;a.push({stmt:"'use strict'; var out = \"\", tmp, def, helpers, g;\n"+"if ("+it+" && "+it+".helpers)\n"+"{ helpers = "+it+".helpers; g = helpers; }\n"+"if ("+it+" && "+it+".def)\n"+"    def = "+it+".def;\n"});function expr(s){a.push({expr:s})}function stmt(s){a.push({stmt:s})}function handle_template(tmpl){var m,_m,scan,op,op_base,sep;for(scan={s:tmpl};scan_block(c,scan);){m=scan.m;if(!scan.found){a.push({val:m});continue}_m=m.slice(c.open.length,-c.close.length);if(_m[_m.length-1]=="-"){_m=_m.slice(0,-1);if(scan.s.startsWith("\n"))scan.s=scan.s.slice(1)}if(op=/^( |-|!|=|([a-z0-9_]+)(\S*)(\s|$))([\S\s]*)$/i.exec(_m)){_m=op[5];op_base=op[2]||op[1];sep=op[4];op=op[2]?op[2]+op[3]:op[1]}else op_base=undefined;switch(op_base){case it:if(sep){stmt(op+' = (function(){ var out = "";\n');handle_template(_m);stmt("; return out; })();\n")}else expr(_html_escape+"(to_str("+op+"))");break;case"=":if(_m.startsWith("json "))expr(_script_escape+"(to_json("+_m.slice(5)+"))");else expr("to_str("+_m+")");break;case"!":expr(_html_escape+"(to_str("+_m+"))");break;case" ":stmt(_m+";\n");break;case"if":stmt("if ("+_m+"){\n");break;case"else":stmt("} else if ("+(sep&&_m.trim()||"1")+"){\n");break;case"fi":stmt("}\n");break;case"include":handle_template(""+_include(_m));break;case"MD5":expr(it+'.MD5(""');handle_template(_m);expr('"")');break;case"MD5_CDN":expr(it+'.MD5_CDN(""');handle_template(_m);expr('"")');break;case"MD5_CDNP":expr(it+'.MD5_CDNP(""');handle_template(_m);expr('"")');break;case"CDN_LINK":case"CDN_REMOTE":expr(it+'.CDN_LINK(""');handle_template(_m);expr('"", '+(op_base=="CDN_REMOTE")+")");break;default:if(c.it_shortcut&&op_base&&/^[a-z_][a-z_0-9.[\]]*$/i.exec(op)){expr(_html_escape+"(to_str("+it+"."+op+"))");break}E.last_err="template unknown section: "+m.substr(0,50);a.push({val:m})}}}handle_template(input);a.push({stmt:"return out;\n"});var fn="",in_expr=false;function set_in_expr(_in_expr){if(_in_expr==in_expr)fn+=in_expr?"+":"";else{fn+=_in_expr?"out += ":";\n";in_expr=_in_expr}}for(var i=0;i<a.length;i++){var _a=a[i],v=_a.val||_a.expr||_a.stmt;if(!v)continue;set_in_expr(!!(_a.val||_a.expr));fn+=_a.val?js_escape(v):v}set_in_expr(false);try{return new Function("html_escape","script_escape","to_str","to_json",it,fn).bind(null,html_escape,script_escape,to_str,to_json)}catch(e){console.log("could not create a template function",fn);throw e}};return E})})();
define("/svc/cdn/pub/feature/share/index.js",{__stub:1});
define("/svc/cdn/pub/feature/casting/index.js",{__stub:1});
define("/svc/cdn/pub/feature/youtube_controls/shortcuts.js",{__stub:1});
define("/svc/cdn/pub/feature/youtube_controls/seek_zones.js",{__stub:1});
define("/svc/cdn/pub/feature/youtube_controls/index.js",{__stub:1});
define("/svc/cdn/pub/feature/video_panel/index.js",{__stub:1});
define("/svc/cdn/pub/feature/sticky_player/index.js",{__stub:1});
define("/svc/cdn/pub/feature/heatmap/index.js",{__stub:1});
define("/svc/cdn/pub/feature/newsreel/widget.js",{__stub:1});
define("/svc/cdn/pub/feature/newsreel/index.js",{__stub:1});
define("/svc/cdn/pub/feature/top_pages/promo.js",{__stub:1});
define("/svc/cdn/pub/feature/top_pages/index.js",{__stub:1});
define("/svc/cdn/pub/feature/image_preview/index.js",{__stub:1});
define("/svc/cdn/pub/watermark.js",["cash","/svc/cdn/pub/util.js"],function($,util){var E=Watermark;var def_styles={".hola_watermark.hola_hidden":{visibility:"hidden",opacity:"0"},".hola_watermark":{position:"absolute !important","z-index":"999","max-width":"50px","max-height":"50px","min-width":"20px","min-height":"20px",width:"30%",height:"40%",opacity:"1",transition:"opacity 0.5s ease-in-out","pointer-events":"auto","background-size":"contain","background-repeat":"no-repeat","background-image":"url(//ve.h-cdn.com/svc/preview/pub/img/watermark-contour.svg)"},".hola_watermark.rel_x":{},".hola_watermark.rel_y":{},".hola_watermark:hover":{"background-image":"url(//ve.h-cdn.com/svc/preview/pub/img/watermark-contour.svg)"},".hola_watermark:hover .hola_hint":{visibility:"visible"},".hola_watermark:hover .hola_hint.hola_hidden":{visibility:"hidden"},".hola_watermark .hola_hint::after":{display:"inline-block","align-self":"center",content:"''",width:"0",position:"absolute",height:"0","border-style":"solid"},".hola_watermark .hola_hint::before":{display:"inline-block","align-self":"center",content:"''",width:"0",position:"absolute",height:"0","border-style":"solid"},".hola_watermark .hola_hint":{visibility:"hidden","box-shadow":"0 2px 2px 0 rgba(17, 42, 52, 0.69)","text-align":"center",display:"inline-block","align-self":"center","line-height":"20px","font-size":"14px",position:"relative","border-radius":"4px","border-style":"solid","border-width":"1px",padding:"8px 15px","white-space":"nowrap"}};var def_settings={corner:"top-right",max_icon_shift:{x:"8px",y:"8px"},icon_shift:{x:"2%",y:"4%"},hint_shift:{x:"0px",y:"auto"},hint_bg:"white",hint_fg:"rgba(0, 82, 113, 0.82)",hint_pointer_shift:"auto",hint_pointer_size:"10px",hint_text:"Powered by Hola Spark"};function Watermark(spark,opt){opt=util.extend_deep({},util.clone_deep(def_settings),util.clone_deep(opt));if(!(this instanceof Watermark)){if(!opt.enable)return;return new Watermark(spark,opt)}var _this=this;this.spark=spark;this.customer=opt.customer;this.module=opt.module;this.css_name=opt.module+"_watermark";this.stats=_this.spark.stats.alloc(_this.module+".watermark");var styles={},style;var conf_styles=util.extend_deep({},util.clone_deep(def_styles),opt.extra_css,opt.extra_css_fn?opt.extra_css_fn():undefined);for(style in conf_styles){styles[style.replace(".hola_watermark","."+this.css_name)]=conf_styles[style]}var fix_px=function(size){return/\d$/.test(""+size)?size+"px":size};var wm_style=styles["."+this.css_name];if(opt.static){opt.delay=function(duration,pos){return 0};Object.assign(wm_style,{height:"10%",width:"auto","max-height":"140px","max-width":"140px",transition:null})}this.delay=opt.delay;if(opt.icon_url)wm_style["background-image"]="url("+opt.icon_url+")";if("icon_hover_url"in opt){styles["."+this.css_name+":hover"]["background-image"]=opt.icon_hover_url?"url("+opt.icon_hover_url+")":null}if(typeof opt.corner=="string"){opt.corner={topright:0,bottomright:1,bottomleft:2,topleft:3,tr:0,br:1,bl:2,tl:3}[opt.corner.toLowerCase().replace(/[-_]+/g,"")]}opt.corner=Math.min(3,Math.max(0,opt.corner||0))|0;opt.max_icon_shift=opt.max_icon_shift||{};var x_shift=opt.corner==0||opt.corner==1?"right":"left";var y_shift=opt.corner==0||opt.corner==3?"top":"bottom";var iy_shift=opt.corner==0||opt.corner==3?"bottom":"top";wm_style[x_shift]=fix_px(opt.max_icon_shift.x);wm_style[y_shift]=fix_px(opt.max_icon_shift.y);opt.icon_shift=opt.icon_shift||{};styles["."+this.css_name+".rel_x"][x_shift]=fix_px(opt.icon_shift.x);styles["."+this.css_name+".rel_y"][y_shift]=fix_px(opt.icon_shift.y);var icon_shift={rel_x:/%$/.test(opt.icon_shift.x),rel_y:/%$/.test(opt.icon_shift.y),x:parseInt(opt.icon_shift.x),y:parseInt(opt.icon_shift.y),max_x:parseInt(opt.max_icon_shift.x),max_y:parseInt(opt.max_icon_shift.y)};this.use_rel=function(cont,axis){var shift=1;if(icon_shift["rel_"+axis])shift=(axis=="x"?$(cont).width():$(cont).height())/100;return icon_shift["max_"+axis]>shift*icon_shift[axis]};wm_style["background-position-x"]=x_shift=="right"?"100%":"0%";wm_style["background-position-y"]=y_shift=="bottom"?"100%":"0%";var hint_style=styles["."+this.css_name+" .hola_hint"];var hint_style_a=styles["."+this.css_name+" .hola_hint::after"];var hint_style_b=styles["."+this.css_name+" .hola_hint::before"];hint_style_a[iy_shift]="100%";hint_style_b[iy_shift]="100%";var color_rotate=function(c){return y_shift=="top"?"transparent transparent "+c:c+" transparent transparent"};hint_style_a["border-color"]=color_rotate(opt.hint_bg);hint_style_b["border-color"]=color_rotate(opt.hint_fg);hint_style.background=opt.hint_bg;hint_style["border-color"]=opt.hint_fg;hint_style.color=opt.hint_fg;if(opt.hint_pointer_shift=="auto"){this.hint_pointer_shift="auto";delete opt.hint_pointer_shift}opt.hint_pointer_shift=parseInt(opt.hint_pointer_shift||"8px");hint_style_a[x_shift]=opt.hint_pointer_shift+"px";hint_style_b[x_shift]=opt.hint_pointer_shift-1+"px";opt.hint_pointer_size=this.hint_pointer_size=parseInt(opt.hint_pointer_size);hint_style_a["border-width"]=opt.hint_pointer_size+"px";hint_style_b["border-width"]=opt.hint_pointer_size+1+"px";opt.hint_shift=opt.hint_shift||{};if(opt.hint_shift.y=="auto"){opt.hint_shift.y=y_shift=="top"?"calc(100% + "+(opt.hint_pointer_size+1)+"px)":(parseInt(hint_style["line-height"])||0)+(parseInt(hint_style.padding)||0)*2+(parseInt(hint_style["border-width"])||0)*2+opt.hint_pointer_size+1+"px"}hint_style[y_shift]=fix_px(opt.hint_shift.y);this.hint_shift=parseInt(opt.hint_shift.x);if(x_shift=="left"){hint_style[x_shift]=this.hint_shift+"px";delete this.hint_shift}this.hint_text=opt.hint_text;this.doc=opt.doc||document;this.x_shift=x_shift;var old_fallback=this.x_shift=="top"?"."+this.css_name+" .hola_hint {\n    top: 110%;\n}\n":"";$(this.doc).find("head").append("<style>"+old_fallback+util.get_stylesheet(styles)+"</style>")}Watermark.prototype.pause=function(){this.paused=true};Watermark.prototype.resume=function(after){var _this=this;this.rm_resume=setTimeout(function(){_this.rm_resume=clearTimeout(_this.rm_resume);_this.paused=false;if(_this.last_duration_change)_this.last_duration_change()},after)};Watermark.prototype.apply=function(opt){if(this.container)this.remove(this.container);this.container=opt.container;var hint=this.hint=this.doc.createElement("div");$(hint).addClass("hola_hint hola_top_element");$(hint).html(this.hint_text);var pic=this.pic=this.doc.createElement("div");pic.appendChild(hint);$(pic).addClass(this.css_name);$(pic).addClass("hola_hidden");this.style=this.doc.createElement("style");pic.appendChild(this.style);this.link=this.doc.createElement("a");var cam="wm_"+this.module+"_"+this.customer;$(this.link).attr("href","http://holaspark.com?cam="+cam);$(this.link).attr("target","_blank");$(this.link).attr("style","position: static !important;");this.link.appendChild(pic);opt.container.appendChild(this.link);var _this=this;this.rm_dur=on_duration_change(opt.v,function(duration){var _pic=_this.pic;if(!duration||!_pic||!$(_pic).hasClass("hola_hidden"))return;var cb=_this.last_duration_change=function(){_this.rm_dur=clearTimeout(_this.rm_dur);if(_this.paused)return;delete _this.last_duration_change;var pos=opt.v.currentTime||opt.v.get_pos&&opt.v.get_pos()||0;var opt_delay=_this.delay&&_this.delay(duration,pos)||0;var delay=Math.max(0,opt_delay)*1e3;_this.rm_dur=setTimeout(function(){$(_pic).removeClass("hola_hidden")},delay)};var html5=opt.v.html5||window.HTMLMediaElement&&opt.v instanceof window.HTMLMediaElement&&opt.v;if(html5){$(html5).on("playing",cb);$(html5).on("seeked",cb)}cb()});$(pic).one("mouseenter",this.on_size_known.bind(this,opt));this.rm_size=setTimeout(this.on_size_known.bind(this,opt),0);this.rm_size_ensure=setTimeout(this.on_size_known.bind(this,opt),5e3);this.stats.inc("apply_n")};Watermark.prototype.on_size_known=function(opt){if(!this.hint||!this.pic)return;var hint=this.hint,pic=this.pic;var small_for_hint=$(opt.container).innerWidth()<=$(hint).outerWidth()||$(opt.container).innerHeight()<=$(hint).outerHeight()+$(pic).height();ensure_class(hint,small_for_hint,"hola_hidden");ensure_class(pic,this.use_rel(opt.container,"x"),"rel_x");ensure_class(pic,this.use_rel(opt.container,"y"),"rel_y");if(this.hint_pointer_shift=="auto"){var hint_pointer_shift=Math.max(1,(Math.min($(pic).innerWidth(),$(pic).innerHeight())>>1)-this.hint_pointer_size);var styles={},elements=["after","before"];for(var i=0;i<elements.length;i++){var s=styles["."+this.css_name+" .hola_hint::"+elements[i]]={};s[this.x_shift]=hint_pointer_shift-i+"px"}$(this.style).text(util.get_stylesheet(styles))}if(!("hint_shift"in this))return;$(hint).css("right",$(hint).innerWidth()+this.hint_shift-$(pic).innerWidth()+"px")};Watermark.prototype.remove=function(container){if(container&&container!=this.container)return;this.container=null;this.rm_size=clearTimeout(this.rm_size);this.rm_size_ensure=clearTimeout(this.rm_size_ensure);this.rm_dur=clearTimeout(this.rm_dur);this.rm_resume=clearTimeout(this.rm_resume);if(this.hint){$(this.hint).remove();this.hint=null}if(this.pic){$(this.pic).remove();this.pic=null}if(this.link){$(this.link).remove();this.link=null}if(this.style){$(this.style).remove();this.style=null}this.stats.inc("remove_n")};function ensure_class(elem,cond,c){$(elem)[cond?"addClass":"removeClass"](c)}function on_duration_change(player,cb,sync){var html5=player.html5||window.HTMLMediaElement&&player instanceof window.HTMLMediaElement&&player;var duration=html5&&html5.duration||player.get_duration&&player.get_duration()||0;if(duration||sync)return void cb(duration==Infinity?60:duration);if(html5){return void $(html5).on("durationchange",on_duration_change.bind(null,player,cb,true))}return setTimeout(on_duration_change.bind(null,player,cb),1e3)}return E});
define("/svc/cdn/pub/features.js",["/util/util.js","/util/url.js","/svc/cdn/pub/util.js","/svc/cdn/pub/spark_features.js","/svc/cdn/pub/feature/persistent/index.js","/svc/cdn/pub/feature/thumbnails/index.js","/svc/cdn/pub/feature/preview/index.js","/svc/cdn/pub/feature/watch_later/index.js","/svc/cdn/pub/log.js","/svc/cdn/pub/links.js","/svc/cdn/pub/feature/position_memory/index.js","/svc/cdn/pub/feature/playlist/index.js","/svc/cdn/pub/feature/autoplay/index.js","/svc/cdn/pub/feature/video_search/index.js","/svc/cdn/pub/feature/share/index.js","/svc/cdn/pub/feature/casting/index.js","/svc/cdn/pub/feature/youtube_controls/index.js","/svc/cdn/pub/feature/video_panel/index.js","/svc/cdn/pub/widget.js","/svc/cdn/pub/feature/sticky_player/index.js","/svc/cdn/pub/l10n.js","/svc/cdn/pub/feature/heatmap/index.js","/svc/cdn/pub/feature/newsreel/index.js","/svc/cdn/pub/feature/top_pages/index.js","/svc/cdn/pub/feature/image_preview/index.js","/svc/cdn/pub/perr.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/api.js","/svc/cdn/pub/watermark.js"],function(zutil,zurl,util,spark_features,persistent,thumbnails,preview,watch_later,_log,links,position_memory,playlist,autoplay,video_search,share,casting,youtube_controls,video_panel,widget,sticky_player,l10n,heatmap,newsreel,top_pages,image_preview,perr,dom_util,api,watermark){var qs_o=zurl.qs_parse((location.search||"").substr(1));var qs_features=(qs_o.spark_features||"").split(",");var spark;var E={},assign=Object.assign;var delayed_modules=[];E.libs=spark_features.libs;E.libs.links.module=links;E.libs.widget.module=widget;E.features=spark_features.features;E.features.persistent.module=persistent;E.features.video_previews.module=preview;E.features.thumbnails.module=thumbnails;E.features.watch_later.module=watch_later;E.features.position_memory.module=position_memory;E.features.playlist.module=playlist;E.features.autoplay.module=autoplay;E.features.casting.module=casting;E.features.youtube_controls.module=youtube_controls;E.features.share.module=share;E.features.video_search.module=video_search;E.features.video_panel.module=video_panel;E.features.heatmap.module=heatmap;E.features.newsreel.module=newsreel;E.features.top_pages.module=top_pages;E.features.image_previews.module=image_preview;E.modules=assign({},E.features,E.libs);function delayed_feature_init(){delayed_modules.forEach(function(o){feature_init(o)})}function add_feature_styles(name,conf){if(!conf.extra_css_fn)return;try{var extra_css_fn=conf.extra_css_fn;if(typeof extra_css_fn=="string")extra_css_fn=new Function("conf",extra_css_fn);var styles=util.get_stylesheet(extra_css_fn(conf));dom_util.add_style("data-spark_extra_css_"+name,styles)}catch(e){spark.spark_log.err('invalid extra_css_fn function in "'+name+'": '+(e&&e.toString())||"JS Error")}}function feature_init(o){if(o.inited||!util.is_enabled(o.module))return;if(o.wait_for_master_sync&&(!util.is_top&&!spark.has_master||util.is_unfriendly_iframe&&!spark.storage.master_synced)){if(o.module.wait_init){perr.try_wrapper({prefix:o.name},o.module.wait_init)(spark,spark.conf[o.name])}return void delayed_modules.push(o)}(o.dep||[]).forEach(function(dep){feature_init(E.modules[dep])});o.inited=true;if(o.manifest==2)return void init_feature_m2(o);var platform_conf=util.get_platform_conf(spark.conf[o.name]);if(util.is_enabled(l10n))l10n.override(platform_conf.strings||{},o.name);perr.try_wrapper({prefix:o.name},o.module.init)(spark,spark.conf[o.name]);add_feature_styles(o.name,platform_conf)}function init_feature_m2(o){var def_conf=o.module.default_conf||{};var conf=util.get_feature_conf(spark.conf[o.name],def_conf);if(util.is_enabled(l10n))l10n.override(conf.strings||{},o.name);var modules=o.modules||[];var spark_modules={};for(var i=0;i<modules.length;i++){switch(modules[i]){case"api":if(util.is_enabled(api))spark_modules.api=api;break;case"history":spark_modules.history=spark.history;break;case"links":spark_modules.links=spark.links;break;case"log":spark_modules.log=spark.spark_log.fork(o.module_id||o.name);break;case"perr":spark_modules.perr=perr;break;case"players":spark_modules.players=spark.players;break;case"stats":spark_modules.stats=spark.stats.alloc(o.module_id||o.name,null,conf);break;case"storage":spark_modules.storage=spark.storage.alloc(o.module_id||o.name,{def:o.module.default_storage||{}});break;case"watermark":var watermark_conf=assign({customer:spark.customer,module:o.module_id||o.name},o.module.watermark_conf||{},conf.watermark||{});if(util.is_enabled(watermark)&&watermark_conf.enable)spark_modules.watermark=new watermark(spark,watermark_conf);break}}perr.try_wrapper({prefix:o.name},o.module.init)(spark_modules,conf,spark);add_feature_styles(o.name,conf)}function init_features(){delayed_modules=[];var s="",d="";var gconf=spark.conf.general||{};var _is_allowed=spark._is_browser_allowed(gconf.browsers)&&spark.is_os_allowed(gconf.os)&&spark.is_url_allowed(gconf.urls);for(var feature in E.features){var o=E.features[feature];if(o.module&&_is_allowed&&use_feature(feature)){feature_init(o);s+=(s?", ":"")+o.title}else d+=(d?", ":"")+o.title}if(delayed_modules.length){if(util.is_unfriendly_iframe)spark.storage.once("master_synced",delayed_feature_init);else spark.msg.once("master_found",delayed_feature_init)}if(s){spark.api.features=s;print_console_banner(s,d)}}function print_console_banner(enabled,disabled){if(zutil.is_mocha()||spark.get_conf("general.disable_console_banner"))return;var print=function(_msg,style){if(!util.is_chrome)style="";console.log(_msg,style)};print("%cVideo enhancements powered by HolaSpark.com v"+spark.version,"color: blue; font-size: 15px");if(spark.is_editor_mode)print("%cEDITOR MODE","color: red; font-size: 15px");print("%chttp://holaspark.com/?cam=wm_devconsole","color: blue");if(util.CG("privacy"))print("%cGDPR-CCPA mode enabled","color: green");print("%cEnabled features: "+enabled,"color: blue");if(disabled)print("%cAvailable features: "+disabled,"color: green");console.log("Embedded in "+spark.customer+" frame: "+location.href)}function spark_mvp_preload(){function use_video_search_mvp(){return spark.params.spark_video_search||E.is_feature_enabled_by_conf(spark.orig_conf.video_search)}function use_sticky_player_mvp(){return spark.params.spark_sticky_player||E.is_feature_enabled_by_conf(spark.orig_conf.sticky_player)}function load_external_module(mod){util.load_script("//ve-image-cdn.h-cdn.com/"+mod+".js?customer="+spark.customer)}var conf=spark.orig_conf.video_search||{};if(use_video_search_mvp()&&conf.force_mvp)load_external_module("video_search");if(use_sticky_player_mvp())sticky_player.init(spark,spark.conf.sticky_player)}function use_feature(feature){if(util.is_app&&!["persistent","thumbnails","position_memory","playlist"].includes(feature)){return}var enabled=E.is_feature_enabled(feature);var code_exists=!!E.features[feature].module.init;if(enabled&&!code_exists)spark.spark_log.warn(feature+" code missing - enable in CP");return enabled||code_exists&&spark.force_enable(feature)}function uninit(){Object.keys(E.modules).forEach(function(m){E.modules[m].inited=false})}E.get_features=function(){var res=[];for(var f in E.features){if(E.is_feature_enabled(f))res.push(E.features[f].id||f)}return res.join(",")};E.get_feature_if_inited=function(feature){return E.is_feature_inited(feature)&&E.modules[feature].module};E.is_feature_available=function(feature){var fn=zutil.get(E.features[feature],"module.is_available");return!fn||fn()};E.is_feature_enabled=function(feature){return E.is_feature_available(feature)&&(E.is_feature_enabled_by_conf(spark.conf[feature]||{})||E.is_feature_enabled_by_qs(feature))};E.is_feature_enabled_by_qs=function(feature){return qs_features.includes(feature)};E.is_feature_enabled_by_conf=function(conf){conf=conf||{};if(util.has_ext)return conf.enable;var platform_conf=util.get_platform_conf(conf)||{};if(!platform_conf.disable&&spark._is_browser_allowed(platform_conf.browsers)&&spark.is_os_allowed(platform_conf.os)&&spark.is_url_allowed(platform_conf.urls)&&spark._is_platform_allowed(platform_conf.platform)){return conf.enable}return false};E.is_feature_inited=function(feature){return E.modules[feature]&&E.modules[feature].inited};E.init=function(_spark){spark=_spark;spark.features=E.features;spark.modules=E.modules;init_features();spark_mvp_preload()};E.t={uninit:uninit,use_feature:use_feature};return E});
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/date.js",[],function(){var E=date_get;E.sec={NANO:1/1e9,MS:.001,SEC:1,MIN:60,HOUR:60*60,DAY:24*60*60,WEEK:7*24*60*60,MONTH:30*24*60*60,YEAR:365*24*60*60};E.ms={};for(var key in E.sec)E.ms[key]=E.sec[key]*1e3;var ms=E.ms;function pad(num,size){return("000"+num).slice(-size)}E.ms_to_dur=function(_ms){var s="",sec=Math.floor(_ms/1e3);if(sec<0){s+="-";sec=-sec}var days=Math.floor(sec/(60*60*24));sec-=days*60*60*24;var hours=Math.floor(sec/(60*60));sec-=hours*60*60;var mins=Math.floor(sec/60);sec-=mins*60;if(days)s+=days+" "+(days>1?"Days":"Day")+" ";return s+pad(hours,2)+":"+pad(mins,2)+":"+pad(sec,2)};E.dur_to_str=function(dur,opt){opt=opt||{};var parts=[];dur=+dur;function chop(period,name){if(dur<period)return;var number=Math.floor(dur/period);parts.push(number+name);dur-=number*period}chop(ms.YEAR,"y");chop(ms.MONTH,"mo");if(opt.week)chop(ms.WEEK,"w");chop(ms.DAY,"d");chop(ms.HOUR,"h");chop(ms.MIN,"min");chop(ms.SEC,"s");if(dur)parts.push(dur+"ms");if(!parts.length)return"0s";return parts.slice(0,opt.units||parts.length).join(opt.sep||"")};E.monotonic=undefined;E.init=function(){var adjust,last;if(typeof window=="object"&&window.performance&&window.performance.now){adjust=Date.now()-window.performance.now();E.monotonic=function(){return window.performance.now()+adjust}}else if(is_node&&!global.mocha_running){var now_fn=function(){var data=process.hrtime();var seconds=data[0],nanos=data[1];return Math.floor(seconds*E.ms.SEC+nanos*E.ms.NANO)};adjust=Date.now()-now_fn();E.monotonic=function(){return now_fn()+adjust}}else{last=adjust=0;E.monotonic=function(){var now=Date.now()+adjust;if(now>=last)return last=now;adjust+=last-now;return last}}};E.init();E.str_to_dur=function(str,opt){opt=opt||{};var month="mo|mon|months?";if(opt.short_month)month+="|m";var m=str.replace(/ /g,"").match(new RegExp("^(([0-9]+)y(ears?)?)?"+"(([0-9]+)("+month+"))?(([0-9]+)w(eeks?)?)?(([0-9]+)d(ays?)?)?"+"(([0-9]+)h(ours?)?)?(([0-9]+)(min|minutes?))?"+"(([0-9]+)s(ec|econds?)?)?(([0-9]+)ms(ec)?)?$","i"));if(!m)return;return ms.YEAR*(+m[2]||0)+ms.MONTH*(+m[5]||0)+ms.WEEK*(+m[8]||0)+ms.DAY*(+m[11]||0)+ms.HOUR*(+m[14]||0)+ms.MIN*(+m[17]||0)+ms.SEC*(+m[20]||0)+(+m[23]||0)};E.months_long=["January","February","March","April","May","June","July","August","September","October","November","December"];E.months_short=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var months_short_lc=E.months_short.map(function(m){return m.toLowerCase()});E.days_long=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];E.days_short=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var days_short_lc=E.days_short.map(function(d){return d.toLowerCase()});var days_long_lc=E.days_long.map(function(d){return d.toLowerCase()});E.locale={months_long:E.months_long,months_short:E.months_short,days_long:E.days_long,days_short:E.days_short,AM:"AM",PM:"PM"};E.get=date_get;function date_get(d,_new){var y,mon,day,H,M,S,_ms;if(d===undefined)return new Date;if(d==null)return new Date(null);if(d instanceof Date)return _new?new Date(d):d;if(typeof d=="string"){var m;d=d.trim();if(m=/^((\d\d\d\d)-(\d\d)-(\d\d)|(\d\d?)-([A-Za-z]{3})-(\d\d(\d\d)?))\s*([\sT](\d\d):(\d\d)(:(\d\d)(\.(\d\d\d))?)?Z?)?$/.exec(d)){H=+m[10]||0;M=+m[11]||0;S=+m[13]||0;_ms=+m[15]||0;if(m[2]){y=+m[2];mon=+m[3];day=+m[4];if(!y&&!mon&&!day&&!H&&!M&&!S&&!_ms)return new Date(NaN);return new Date(Date.UTC(y,mon-1,day,H,M,S,_ms))}if(m[5]){y=+m[7];mon=months_short_lc.indexOf(m[6].toLowerCase())+1;day=+m[5];if(m[7].length==2){y=+y;y+=y>=70?1900:2e3}return new Date(Date.UTC(y,mon-1,day,H,M,S,_ms))}}if(/^\d+$/.test(d))return new Date(+d);return new Date(d)}if(typeof d=="number")return new Date(d);throw new TypeError("invalid date "+d)}E.to_sql_ms=function(d){d=E.get(d);if(isNaN(d))return"0000-00-00 00:00:00.000";return pad(d.getUTCFullYear(),4)+"-"+pad(d.getUTCMonth()+1,2)+"-"+pad(d.getUTCDate(),2)+" "+pad(d.getUTCHours(),2)+":"+pad(d.getUTCMinutes(),2)+":"+pad(d.getUTCSeconds(),2)+"."+pad(d.getUTCMilliseconds(),3)};E.to_sql_sec=function(d){return E.to_sql_ms(d).slice(0,-4)};E.to_sql=function(d){return E.to_sql_ms(d).replace(/( 00:00:00)?....$/,"")};E.from_sql=E.get;E.to_month_short=function(d){d=E.get(d);return E.months_short[d.getUTCMonth()]};E.to_month_long=function(d){d=E.get(d);return E.months_long[d.getUTCMonth()]};E.to_jdate=function(d){d=E.get(d);return(pad(d.getUTCDate(),2)+"-"+E.months_short[d.getUTCMonth()]+"-"+pad(d.getUTCFullYear()%100,2)+" "+pad(d.getUTCHours(),2)+":"+pad(d.getUTCMinutes(),2)+":"+pad(d.getUTCSeconds(),2)).replace(/( 00:00)?:00$/,"")};E.to_log_file=function(d){d=E.get(d);return d.getUTCFullYear()+pad(d.getUTCMonth()+1,2)+pad(d.getUTCDate(),2)+"_"+pad(d.getUTCHours(),2)+pad(d.getUTCMinutes(),2)+pad(d.getUTCSeconds(),2)};E.from_log_file=function(d){var m=d.match(/^(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})$/);if(!m)return;return new Date(Date.UTC(m[1],m[2]-1,m[3],m[4],m[5],m[6]))};E.to_log_ms=function(d){return E.to_sql_ms(d).replace(/-/g,".")};E.from_rcs=function(d){var m=d.match(/^(\d{4})\.(\d{2})\.(\d{2})\.(\d{2})\.(\d{2})\.(\d{2})$/);if(!m)return;return new Date(Date.UTC(m[1],m[2]-1,m[3],m[4],m[5],m[6]))};E.to_rcs=function(d){return E.to_sql_sec(d).replace(/[-: ]/g,".")};E.align=function(d,align){d=E.get(d,1);switch(align.toUpperCase()){case"MS":break;case"SEC":d.setUTCMilliseconds(0);break;case"MIN":d.setUTCSeconds(0,0);break;case"HOUR":d.setUTCMinutes(0,0,0);break;case"DAY":d.setUTCHours(0,0,0,0);break;case"WEEK":d.setUTCDate(d.getUTCDate()-d.getUTCDay());d.setUTCHours(0,0,0,0);break;case"MONTH":d.setUTCDate(1);d.setUTCHours(0,0,0,0);break;case"YEAR":d.setUTCMonth(0,1);d.setUTCHours(0,0,0,0);break;default:throw new Error("invalid align "+align)}return d};E.add=function(d,dur){d=E.get(d,1);dur=normalize_dur(dur);if(dur.year)d.setUTCFullYear(d.getUTCFullYear()+dur.year);if(dur.month)d.setUTCMonth(d.getUTCMonth()+dur.month);["day","hour","min","sec","ms"].forEach(function(key){if(dur[key])d.setTime(+d+dur[key]*ms[key.toUpperCase()])});return d};function normalize_dur(dur){var aliases={years:"year",months:"month",days:"day",hours:"hour",minutes:"min",minute:"min",mins:"min",seconds:"sec",second:"sec",secs:"sec",y:"year",mo:"month",d:"day",h:"hour",m:"min",s:"sec"};var norm={};for(var k in dur)norm[aliases[k]||k]=dur[k];return norm}E.describe_interval=function(_ms){return _ms<2*ms.MIN?Math.round(_ms/ms.SEC)+" sec":_ms<2*ms.HOUR?Math.round(_ms/ms.MIN)+" min":_ms<2*ms.DAY?Math.round(_ms/ms.HOUR)+" hours":_ms<2*ms.WEEK?Math.round(_ms/ms.DAY)+" days":_ms<2*ms.MONTH?Math.round(_ms/ms.WEEK)+" weeks":_ms<2*ms.YEAR?Math.round(_ms/ms.MONTH)+" months":Math.round(_ms/ms.YEAR)+" years"};E.time_ago=function(d,until_date){var _ms=E.get(until_date)-E.get(d);if(_ms<ms.SEC)return"right now";return E.describe_interval(_ms)+" ago"};E.ms_to_str=function(_ms){var s=""+_ms;return s.length<=3?s+"ms":s.slice(0,-3)+"."+s.slice(-3)+"s"};E.parse=function(text,opt){opt=opt||{};if(opt.fmt)return E.strptime(text,opt.fmt);var d,a,i,v,_v,dir,_dir,amount,now=opt.now;now=!now?new Date:new Date(now);text=text.replace(/\s+/g," ").trim().toLowerCase();if(!text)return;if(text=="now")return now;if(!isNaN(d=E.get(text)))return d;d=now;a=text.split(" ");dir=a.includes("ago")?-1:a.includes("last")?-1:a.includes("next")?1:undefined;for(i=0;i<a.length;i++){v=a[i];if(/^(ago|last|next)$/.test(v));else if(v=="today")d=E.align(d,"DAY");else if(v=="yesterday")d=E.align(+d-ms.DAY,"DAY");else if(v=="tomorrow")d=E.align(+d+ms.DAY,"DAY");else if((_v=days_short_lc.indexOf(v))>=0)d=new Date(+E.align(d,"WEEK")+_v*ms.DAY+(dir||0)*ms.WEEK);else if((_v=days_long_lc.indexOf(v))>=0)d=new Date(+E.align(d,"WEEK")+_v*ms.DAY+(dir||0)*ms.WEEK);else if(_v=/^([+-]?\d+)(?:([ymoinwdhs]+)(\d.*)?)?$/.exec(v)){if(amount!==undefined)return;amount=dir!==undefined?Math.abs(+_v[1]):+_v[1];if(_v[2]){a.splice(i+1,0,_v[2]);if(_v[3])a.splice(i+2,0,_v[3])}continue}else if(/^([ywdhs]|years?|months?|mon?|weeks?|days?|hours?|minutes?|min|seconds?|sec)$/.test(v)){_v=v[0]=="m"&&v[1]=="i"?ms.MIN:v[0]=="y"?ms.YEAR:v[0]=="m"&&v[1]=="o"?ms.MONTH:v[0]=="w"?ms.WEEK:v[0]=="d"?ms.DAY:v[0]=="h"?ms.HOUR:ms.SEC;amount=amount===undefined?1:amount;_dir=dir===undefined?opt.dir||1:dir;if(_v==ms.MONTH)d.setUTCMonth(d.getUTCMonth()+_dir*amount);else if(_v==ms.YEAR)d.setUTCFullYear(d.getUTCFullYear()+_dir*amount);else d=new Date(+d+_v*amount*_dir);amount=undefined}else return;if(amount!==undefined)return}if(amount!==undefined)return;return d};E.strptime=function(str,fmt){function month(m){return months_short_lc.indexOf(m.toLowerCase())}var parse={"%":["%",function(){},0],a:["[a-z]+",function(m){},0],A:["[a-z]+",function(m){},0],b:["[a-z]+",function(m){d.setUTCMonth(month(m))},2],B:["[a-z]+",function(m){d.setUTCMonth(month(m))},2],y:["[0-9]{2}",function(m){d.setUTCFullYear(+m+(m<70?2e3:1900))},1],Y:["[0-9]{4}",function(m){d.setUTCFullYear(+m)},1],m:["[0-9]{0,2}",function(m){d.setUTCMonth(+m-1)},2],d:["[0-9]{0,2}",function(m){d.setUTCDate(+m)},3],H:["[0-9]{0,2}",function(m){d.setUTCHours(+m)},4],M:["[0-9]{0,2}",function(m){d.setUTCMinutes(+m)},5],S:["[0-9]{0,2}",function(m){d.setUTCSeconds(+m)},6],s:["[0-9]+",function(m){d=new Date(+m)},0],L:["[0-9]{0,3}",function(m){d.setUTCMilliseconds(+m)},7],z:["[+-][0-9]{4}",function(m){var timezone=+m.slice(0,3)*3600+m.slice(3,5)*60;d=new Date(+d-timezone*1e3)},8],Z:["[a-z]{0,3}[+-][0-9]{2}:?[0-9]{2}|[a-z]{1,3}",function(m){m=/^([a-z]{0,3})(?:([+-][0-9]{2}):?([0-9]{2}))?$/i.exec(m);if(m[1]=="Z"||m[1]=="UTC")return;var timezone=+m[2]*3600+m[3]*60;d=new Date(+d-timezone*1e3)},8],I:["[0-9]{0,2}",function(m){d.setUTCHours(+m)},4],p:["AM|PM",function(m){if(d.getUTCHours()==12)d.setUTCHours(d.getUTCHours()-12);if(m.toUpperCase()=="PM")d.setUTCHours(d.getUTCHours()+12)},9]};var ff=[];var ff_idx=[];var re=new RegExp("^\\s*"+fmt.replace(/%(?:([a-zA-Z%]))/g,function(_,fd){var d=parse[fd];if(!d)throw Error("Unknown format descripter: "+fd);ff_idx[d[2]]=ff.length;ff.push(d[1]);return"("+d[0]+")"})+"\\s*$","i");var matched=str.match(re);if(!matched)return;var d=new Date(0);for(var i=0;i<ff_idx.length;i++){var idx=ff_idx[i];var fun=ff[idx];if(fun)fun(matched[idx+1])}return d};E.apply_tz=function(date,tz){var timezone=+tz.slice(1,3)*36e5+tz.slice(4,6)*6e4;var sign=tz.slice(0,1)=="+"?1:-1;return new Date(date.getTime()+sign*timezone)};var utc_local={local:{getSeconds:function(d){return d.getSeconds()},getMinutes:function(d){return d.getMinutes()},getHours:function(d){return d.getHours()},getDay:function(d){return d.getDay()},getDate:function(d){return d.getDate()},getMonth:function(d){return d.getMonth()},getFullYear:function(d){return d.getFullYear()},getYearBegin:function(d){return new Date(d.getFullYear(),0,1)}},utc:{getSeconds:function(d){return d.getUTCSeconds()},getMinutes:function(d){return d.getUTCMinutes()},getHours:function(d){return d.getUTCHours()},getDay:function(d){return d.getUTCDay()},getDate:function(d){return d.getUTCDate()},getMonth:function(d){return d.getUTCMonth()},getFullYear:function(d){return d.getUTCFullYear()},getYearBegin:function(d){return new Date(Date.UTC(d.getUTCFullYear(),0,1))}}};E.strftime=function(fmt,d,opt){function hours12(hours){return hours==0?12:hours>12?hours-12:hours}function ord_str(n){var i=n%10,ii=n%100;if(ii>=11&&ii<=13||i==0||i>=4)return"th";switch(i){case 1:return"st";case 2:return"nd";case 3:return"rd"}}function week_num(l,d,first_weekday){var wday=l.getDay(d);if(first_weekday=="monday")wday=wday==0?wday=6:wday-1;var yday=(d-l.getYearBegin(d))/ms.DAY;return Math.floor((yday+7-wday)/7)}function padx(n,padding,length){if(typeof padding=="number"){length=padding;padding="0"}if(padding===undefined)padding="0";length=length||2;var s=""+n;if(padding)for(;s.length<length;s=padding+s);return s}opt=opt||{};d=E.get(d);var locale=opt.locale||E.locale;var formats=locale.formats||{};var tz=opt.timezone;var utc=opt.utc!==undefined?opt.utc:opt.local!==undefined?!opt.local:true;if(tz!=null){utc=true;if(typeof tz=="string"){var sign=tz[0]=="-"?-1:1;var hours=parseInt(tz.slice(1,3),10);var mins=parseInt(tz.slice(3,5),10);tz=sign*(60*hours+mins)}if(typeof tz=="number")d=new Date(+d+tz*6e4)}var l=utc?utc_local.utc:utc_local.local;function replace(fmt){return fmt.replace(/%([-_0]?.)/g,function(_,c){var mod,padding,day;if(c.length==2){mod=c[0];if(mod=="-")padding="";else if(mod=="_")padding=" ";else if(mod=="0")padding="0";else return _;c=c[1]}switch(c){case"A":return locale.days_long[l.getDay(d)];case"a":return locale.days_short[l.getDay(d)];case"B":return locale.months_long[l.getMonth(d)];case"b":return locale.months_short[l.getMonth(d)];case"C":return padx(Math.floor(l.getFullYear(d)/100),padding);case"D":return replace(formats.D||"%m/%d/%y");case"d":return padx(l.getDate(d),padding);case"e":return l.getDate(d);case"F":return replace(formats.F||"%Y-%m-%d");case"H":return padx(l.getHours(d),padding);case"h":return locale.months_short[l.getMonth(d)];case"I":return padx(hours12(l.getHours(d)),padding);case"j":day=Math.ceil((+d-l.getYearBegin(d))/(1e3*60*60*24));return pad(day,3);case"k":return padx(l.getHours(d),padding===undefined?" ":padding);case"L":return pad(Math.floor(d.getMilliseconds()),3);case"l":return padx(hours12(l.getHours(d)),padding===undefined?" ":padding);case"M":return padx(l.getMinutes(d),padding);case"m":return padx(l.getMonth(d)+1,padding);case"n":return"\n";case"o":return""+l.getDate(d)+ord_str(l.getDate(d));case"P":return(l.getHours(d)<12?locale.AM:locale.PM).toLowerCase();case"p":return l.getHours(d)<12?locale.AM:locale.PM;case"R":return replace(formats.R||"%H:%M");case"r":return replace(formats.r||"%I:%M:%S %p");case"S":return padx(l.getSeconds(d),padding);case"s":return Math.floor(+d/1e3);case"T":return replace(formats.T||"%H:%M:%S");case"t":return"	";case"U":return padx(week_num(l,d,"sunday"),padding);case"u":day=l.getDay(d);return day==0?7:day;case"v":return replace(formats.v||"%e-%b-%Y");case"W":return padx(week_num(l,d,"monday"),padding);case"w":return l.getDay(d);case"Y":return l.getFullYear(d);case"y":return(""+l.getFullYear(d)).slice(-2);case"Z":if(utc)return"GMT";var tz_string=d.toString().match(/\((\w+)\)/);return tz_string&&tz_string[1]||"";case"z":if(utc)return"+0000";var off=typeof tz=="number"?tz:-d.getTimezoneOffset();return(off<0?"-":"+")+pad(Math.abs(Math.trunc(off/60)),2)+pad(off%60,2);default:return c}})}return replace(fmt)};E.compile_schedule=function(expr){var re=/^(\d\d?)(?::(\d\d?))?-(\d\d?)(?::(\d\d?))?$/;var parts=expr.split(/\s+/);var intervals=[];for(var i=0;i<parts.length;i++){if(!parts[i])continue;var m=re.exec(parts[i]);if(!m)throw new Error("Schedule syntax error: "+expr);var from=m[1]*ms.HOUR,to=m[3]*ms.HOUR;if(m[2])from+=m[2]*ms.MIN;if(m[4])to+=m[4]*ms.MIN;intervals.push({from:from%ms.DAY,to:to%ms.DAY})}return function(d){var t=E.get(d)%ms.DAY;for(var i=0;i<intervals.length;i++){var interval=intervals[i];if(interval.from<interval.to){if(t>=interval.from&&t<interval.to)return true}else{if(t<interval.to||t>=interval.from)return true}}return false}};return E})})();
(function(){var __hola_stub_define;var is_node_ff=typeof module=="object"&&module.exports;if(!is_node_ff)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/sprintf.js",[],function(){var E=sprintf;E.sprintf=sprintf;var has=Object.prototype.hasOwnProperty;function sprintf(fmt){if(has.call(E.cache,fmt))return E.cache[fmt](arguments);E.cache[fmt]=E.parse(fmt);E.cache_n++;if(E.cache_cb)E.cache_cb(fmt);return E.cache[fmt](arguments)}E.cache={};E.cache_n=0;E.to_int=function(num){return(num=+num)>=0?Math.floor(num):-Math.floor(-num)};E.thousand_grouping=function(num_s){var m=/^([-+])?(\d*)(\.\d*)?$/.exec(num_s);if(!m)return num_s;m[2]=(m[2]||"").replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1"+",");return(m[1]||"")+m[2]+(m[3]||"")};E.stringify=function(value,replacer){if(is_array(replacer)){var r={},v;for(var i=0,l=replacer.length;i<l;i++){v=value_of(replacer[i]);if(typeof v=="string"||typeof v=="number")r[v]=true}replacer=r}else if(typeof replacer!="function")replacer=undefined;return _stringify("",{"":value},replacer,[])};function json_escape(str){return JSON.stringify(str)}function _stringify(key,holder,replacer,stack){var value;try{value=holder[key]}catch(e){value="__ERROR__: "+e}if(value&&typeof value=="object"&&typeof value.toJSON=="function")value=value.toJSON(key);if(typeof replacer=="function")value=replacer.call(holder,key,value);value=value_of(value);switch(typeof value){case"boolean":return value?"true":"false";case"string":return json_escape(value);case"number":return Number.isFinite(value)?json_escape(value):"null";case"object":if(value===null)return"null";if(stack.indexOf(value)>=0)return'"__CIRCULAR__"';stack.push(value);var s,a=[],p,ret;if(is_array(value)){for(var i=0,l=value.length;i<l;i++){s=_stringify(""+i,value,replacer,stack);a.push(s==null?"null":s)}ret="["+a.join(",")+"]"}else{for(p in value){if(!has.call(value,p))continue;if(typeof replacer=="object"&&!replacer[p])continue;if((s=_stringify(p,value,replacer,stack))!=null)a.push(json_escape(p)+":"+s)}ret="{"+a.join(",")+"}"}stack.pop();return ret;default:return undefined}}function value_of(v){return typeof v=="object"&&(v instanceof Number||v instanceof String||v instanceof Boolean)?v.valueOf():v}function is_array(a){return Object.prototype.toString.call(a)=="[object Array]"}function stringify(value){try{return JSON.stringify(value)}catch(e){return E.stringify(value)}}E.parse_fast=function(fmt){var _fmt=fmt,match=[],arg_names=0,cursor=1;var pad_chr,pad_chrs,arg_padded,f,s=stringify;f='var out = "", arg, arg_s, sign;\n';for(;_fmt;_fmt=_fmt.substring(match[0].length)){if(match=/^[^%]+/.exec(_fmt))f+="out += "+s(match[0])+";\n";else if(match=/^%%/.exec(_fmt))f+='out += "%";\n';else if(match=/^%(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?(')?([bcdefoOsuxX])/.exec(_fmt)){var positional=match[1],keyword=match[2],sign=match[3];var pad_zero=match[4],pad_min=match[5],pad_max=match[6];var precision=match[7],thousand_grouping=match[8]=="'";var conversion=match[9],keyword_list=[];if(keyword){arg_names|=1;var _keyword=keyword,kmatch;if(!(kmatch=/^([a-z_][a-z_\d]*)/i.exec(_keyword)))throw"sprintf: invalid keyword property name "+_keyword;keyword_list.push(kmatch[1]);while(_keyword=_keyword.substring(kmatch[0].length)){if(kmatch=/^\.([a-z_][a-z_\d]*)/i.exec(_keyword))keyword_list.push(kmatch[1]);else if(kmatch=/^\[(\d+)\]/.exec(_keyword))keyword_list.push(kmatch[1]);else throw"sprintf: invalid keyword format "+_keyword}}else arg_names|=2;if(arg_names===3){throw"sprintf: mixing positional and named placeholders is "+"not (yet) supported"}f+="sign = false;\n";if(keyword_list.length){f+="arg = argv["+cursor+"]";for(var k=0;k<keyword_list.length;k++)f+="["+s(keyword_list[k])+"]";f+=";\n"}else if(positional)f+="arg = argv["+positional+"];\n";else f+="arg = argv["+cursor++ +"];\n";if(/[^sO]/.test(conversion))f+="arg = +arg;\n";switch(conversion){case"b":f+="arg_s = arg.toString(2);\n";break;case"c":f+="arg_s = String.fromCharCode(arg);\n";break;case"d":f+='arg = sprintf.to_int(arg); arg_s = ""+arg;\n';if(thousand_grouping)f+="arg_s = sprintf.thousand_grouping(arg_s);\n";break;case"e":f+="arg_s = arg.toExponential("+(precision?s(precision):"")+");\n";break;case"f":if(precision)f+="arg_s = arg.toFixed("+precision+");\n";else f+='arg_s = ""+arg;\n';if(thousand_grouping)f+="arg_s = sprintf.thousand_grouping(arg_s);\n";break;case"o":f+="arg_s = arg.toString(8);\n";break;case"O":f+="arg_s = stringify(arg);\n";break;case"u":f+='arg = arg >>> 0; arg_s = ""+arg;\n';break;case"x":f+="arg_s = arg.toString(16);\n";break;case"X":f+="arg_s = arg.toString(16).toUpperCase();\n";break;case"s":f+='arg_s = ""+arg;\n';if(precision)f+="arg_s = arg_s.substring(0, "+precision+");\n";break}if(/[def]/.test(conversion)){if(sign)f+='if (arg>=0) arg_s = "+"+arg_s;\n';f+='sign = arg_s[0]=="-" || arg_s[0]=="+";\n'}pad_chr=!pad_zero?" ":pad_zero=="0"?"0":pad_zero[1];pad_chrs=s(pad_chr)+".repeat(Math.max("+ +pad_max+"-arg_s.length, 0))";arg_padded=!pad_max?"arg_s":pad_min?"arg_s+"+pad_chrs:/[def]/.test(conversion)&&pad_chr=="0"?"(sign ? arg_s[0]+"+pad_chrs+"+arg_s.slice(1) : "+pad_chrs+"+arg_s)":pad_chrs+"+arg_s";f+="out += "+arg_padded+";\n"}else throw"sprintf invalid format "+_fmt}f+="return out;\n";return new Function(["sprintf","stringify","argv"],f).bind(null,sprintf,stringify)};E.parse_slow=function(fmt){var _fmt=fmt,match=[],arg_names=0,cursor=1;var _f=[],out,arg,arg_s,argv,sign;function f(fn){_f.push(fn)}for(;_fmt;_fmt=_fmt.substring(match[0].length))(function(){if(match=/^[^%]+/.exec(_fmt)){var _match=match;f(function(){return out+=_match[0]})}else if(match=/^%%/.exec(_fmt))f(function(){return out+="%"});else if(match=/^%(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?(')?([bcdefoOsuxX])/.exec(_fmt)){var positional=match[1],keyword=match[2],sign=match[3];var pad_zero=match[4],pad_min=match[5],pad_max=match[6];var precision=match[7],thousand_grouping=match[8]=="'";var conversion=match[9],keyword_list=[],_cursor=cursor;if(keyword){arg_names|=1;var _keyword=keyword,kmatch;if(!(kmatch=/^([a-z_][a-z_\d]*)/i.exec(_keyword)))throw"sprintf: invalid keyword property name "+_keyword;keyword_list.push(kmatch[1]);while(_keyword=_keyword.substring(kmatch[0].length)){if(kmatch=/^\.([a-z_][a-z_\d]*)/i.exec(_keyword))keyword_list.push(kmatch[1]);else if(kmatch=/^\[(\d+)\]/.exec(_keyword))keyword_list.push(kmatch[1]);else throw"sprintf: invalid keyword format "+_keyword}}else arg_names|=2;if(arg_names===3){throw"sprintf: mixing positional and named placeholders is "+"not (yet) supported"}f(function(){sign=false});if(keyword_list.length){f(function(){arg=argv[_cursor];for(var k=0;k<keyword_list.length&&arg!=null;k++)arg=arg[keyword_list[k]]})}else if(positional)f(function(){arg=argv[positional]});else{f(function(){arg=argv[_cursor]});cursor++}if(/[^sO]/.test(conversion))f(function(){return arg=+arg});switch(conversion){case"b":f(function(){arg_s=arg.toString(2)});break;case"c":f(function(){arg_s=String.fromCharCode(arg)});break;case"d":f(function(){arg=sprintf.to_int(arg);arg_s=""+arg});if(thousand_grouping)f(function(){arg_s=sprintf.thousand_grouping(arg_s)});break;case"e":f(function(){arg_s=arg.toExponential(precision?precision:undefined)});break;case"f":if(precision)f(function(){arg_s=arg.toFixed(precision)});else f(function(){arg_s=""+arg});if(thousand_grouping)f(function(){arg_s=sprintf.thousand_grouping(arg_s)});break;case"o":f(function(){arg_s=arg.toString(8)});break;case"O":f(function(){arg_s=stringify(arg)});break;case"u":f(function(){arg=arg>>>0;arg_s=""+arg});break;case"x":f(function(){arg_s=arg.toString(16)});break;case"X":f(function(){arg_s=arg.toString(16).toUpperCase()});break;case"s":f(function(){arg_s=""+arg});if(precision)f(function(){arg_s=arg_s.substring(0,precision)});break}if(/[def]/.test(conversion)){if(sign)f(function(){if(arg>=0)arg_s="+"+arg_s});f(function(){sign=arg_s[0]=="-"||arg_s[0]=="+"})}var pad_chr=!pad_zero?" ":pad_zero=="0"?"0":pad_zero[1];f(function(){var pad_chrs=pad_chr.repeat(Math.max(+pad_max-arg_s.length,0));var arg_padded=!pad_max?arg_s:pad_min?arg_s+pad_chrs:sign&&pad_chr[0]=="0"?arg_s[0]+pad_chrs+arg_s.slice(1):pad_chrs+arg_s;out+=arg_padded})}else throw"sprintf invalid format "+_fmt})();return function(_argv){argv=_argv;out="";for(var i=0;i<_f.length;i++)_f[i](argv);return out}};E.parse=function(){try{if(new Function("return 1")()==1)return E.parse_fast}catch(e){}return E.parse_slow}();E.vsprintf=function(fmt,argv,opt){if(opt){if(opt.fast)return E.parse_fast(fmt)([fmt].concat(argv));if(opt.slow)return E.parse_slow(fmt)([fmt].concat(argv))}return E.sprintf.apply(null,[fmt].concat(argv))};return E})})();
(function(){var __hola_stub_define;var is_node=typeof module=="object"&&module.exports&&module.children;var is_rn=typeof global=="object"&&!!global.nativeRequire||typeof navigator=="object"&&navigator.product=="ReactNative";if(!is_node&&!is_rn)define=define||self.define;else define=require("./require_node.js").define(module,"../");define("/util/rate_limit.js",[],function(){var E=rate_limit;function rate_limit(rl,ms,n){var now=Date.now();if(!rl.count||rl.ts+ms<now){rl.count=1;rl.ts=now;return true}rl.count++;return rl.count<=n}E.leaky_bucket=function leaky_bucket(size,rate){this.size=size;this.rate=rate;this.time=Date.now();this.level=0};E.leaky_bucket.prototype.inc=function(inc){if(inc===undefined)inc=1;var now=Date.now();this.level-=this.rate*(now-this.time);this.time=now;if(this.level<0)this.level=0;var new_level=this.level+inc;if(new_level>this.size)return false;this.level=new_level;return true};return E})})();
(function(){var __hola_stub_define,process;var is_node=typeof module=="object"&&module.exports&&module.children;var is_rn=typeof global=="object"&&!!global.nativeRequire||typeof navigator=="object"&&navigator.product=="ReactNative";if(is_rn){define=require("./require_node.js").define(module,"../",require("/util/date.js"),require("/util/util.js"),require("/util/sprintf.js"),require("/util/rate_limit.js"),require("/util/escape.js"));process={nextTick:function(fn){setTimeout(fn,0)},env:{}}}else if(!is_node){define=define||self.define;process={env:{}}}else{define=require("./require_node.js").define(module,"../");if(is_node){process=global.process||require("_process");require("./config.js");var cluster=require("cluster");var version=require("./version.js").version}}define("/util/zerr.js",["/util/date.js","/util/util.js","/util/sprintf.js","/util/rate_limit.js","/util/escape.js"],function(date,zutil,sprintf,rate_limit,zescape){var E,_zerr;var env=process.env;var zerr=function(msg){_zerr(L.ERR,arguments)};E=zerr;E.zerr=zerr;var L=E.L={EMERG:0,ALERT:1,CRIT:2,ERR:3,WARN:4,NOTICE:5,INFO:6,DEBUG:7};var perr_pending=[];var LINV=E.LINV={};for(var k in L)LINV[L[k]]=k;["debug","info","notice","warn","err","crit"].forEach(function(l){var level=L[l.toUpperCase()];E[l]=function(){return _zerr(level,arguments)}});E.assert=function(exp,msg){if(!exp)zerr.crit(msg)};E.json=function(o,replacer,space){try{return JSON.stringify(o,replacer,space)||""}catch(e){return"[circular]"}};E.is=function(level){return level<=E.level};["debug","info","notice","warn","err"].forEach(function(l){var level=L[l.toUpperCase()];E.is[l]=function(){return level<=E.level}});E.perr=function(id,info,opt){E._zerr(!opt||opt.level===undefined?L.ERR:opt.level,["perr "+id+" "+E.json(info)]);if(perr_pending&&perr_pending.length<100)perr_pending.push(Array.from(arguments))};var perr_hooks=[];E.add_perr_hook=perr_hooks.push.bind(perr_hooks);var perr_dropped={};var perr_orig=E.perr;function wrap_perr(perr_fn){var send=perr_fn,pre_send;if(typeof perr_fn!="function"){send=perr_fn.send;pre_send=perr_fn.pre_send}return function(id,info,opt){opt=opt||{};var _rate_limit=opt.rate_limit||{};var ms=_rate_limit.ms||date.ms.HOUR,count=_rate_limit.count||10;var disable_drop_count=_rate_limit.disable_drop_count;var rl_hash=perr_orig.rl_hash=perr_orig.rl_hash||{};var rl=rl_hash[id]=rl_hash[id]||{};if(pre_send)pre_send(id,info,opt);perr_hooks.filter(function(h){return h.ids.test(id)}).forEach(function(h){h.fn(id,info,opt)});if(opt.rate_limit===false||rate_limit(rl,ms,count)){if(perr_dropped[id]){if(!disable_drop_count&&info&&typeof info!="string")info.w=perr_dropped[id];perr_dropped[id]=null}return send(id,info,opt)}perr_dropped[id]=(perr_dropped[id]||0)+1;if(info&&typeof info!="string")info=zerr.json(info);zerr("perr %s %s rate too high %s %d %d",id,info,zerr.json(rl),ms,count)}}E.perr_install=function(install_fn){E.perr=wrap_perr(install_fn(perr_orig,perr_pending||[]));perr_pending=null};function err_has_stack(err){return err instanceof Error&&err.stack}E.e2s=function(err){if(!is_node&&err_has_stack(err)){var e_str=""+err,e_stack=""+err.stack;return e_stack.startsWith(e_str)?e_stack:e_str+" "+e_stack}return err_has_stack(err)?""+err.stack:""+err};E.on_exception=undefined;var in_exception;E.set_exception_handler=function(prefix,err_func){E.on_exception=function(err){if(!(err instanceof TypeError||err instanceof ReferenceError)||err.sent_perr){return}if(in_exception)return;in_exception=1;err.sent_perr=true;err_func((prefix?prefix+"_":"")+"etask_typeerror",null,err);in_exception=0}};E.on_unhandled_exception=undefined;E.catch_unhandled_exception=function(func,obj){return function(){var args=arguments;try{return func.apply(obj,Array.from(args))}catch(e){E.on_unhandled_exception(e)}}};E.set_level=function(level){var prev="L"+LINV[E.level];level=level||env.ZERR;if(!level)return prev;var val=L[level]||L[level.replace(/^L/,"")];if(val!==undefined)E.level=val;return prev};E.get_stack_trace=function(opt){if(!opt)opt={};if(opt.limit===undefined)opt.limit=Infinity;if(opt.short===undefined)opt.short=true;var old_stack_limit=Error.stackTraceLimit;if(opt.limit)Error.stackTraceLimit=opt.limit;var stack=zerr.e2s(new Error);if(opt.limit)Error.stackTraceLimit=old_stack_limit;if(opt.short){stack=stack.replace(/^.+util\/etask.+$/gm,"    ...").replace(/( {4}\.\.\.\n)+/g,"    ...\n")}return stack};E.log=[];E.log.max_size=200;E.log_tail=function(size){return(E.log||[]).join("\n").substr(-(size||4096))};function log_tail_push(msg){E.log.push(msg);if(E.log.length>E.log.max_size)E.log.splice(0,E.log.length-E.log.max_size/2)}if(is_node){E.ZEXIT_LOG_DIR=env.ZEXIT_LOG_DIR||"/tmp/zexit_logs";E.prefix="";E.level=L.NOTICE;E.flush=function(){};E.set_log_buffer=function(on){if(!on){if(E.log_buffer){E.flush();E.log_buffer(0)}return}E.log_buffer=require("log-buffer");E.log_buffer(32*1024);E.flush=function(){E.log_buffer.flush()};setInterval(E.flush,1e3).unref()};var node_init=function(){if(zutil.is_mocha())E.level=L.WARN;else E.prefix=!cluster.isMaster?"C"+cluster.worker.id+" ":""};var init=function(){if(is_node)node_init();E.set_level()};init();var zerr_format=function(args){return args.length<=1?args[0]:sprintf.apply(null,args)};var __zerr=function(level,args){var msg=zerr_format(args);var k=Object.keys(L);var prefix=E.hide_timestamp?"":E.prefix+date.to_sql_ms()+" ";if(env.CURRENT_SYSTEMD_UNIT_NAME)prefix="<"+level+">"+prefix;var res=prefix+k[level]+": "+msg;console.error(res);log_tail_push(res)};E.set_logger=function(logger){__zerr=function(level,args){var msg=zerr_format(args);logger(level,msg);log_tail_push(E.prefix+date.to_sql_ms()+": "+msg)}};_zerr=function(level,args){if(level>E.level)return;__zerr(level,args)};E._zerr=_zerr;E.zexit=function(args){var stack;if(err_has_stack(args)){stack=args.stack;__zerr(L.CRIT,[E.e2s(args)])}else{var e=new Error;stack=e.stack;__zerr(L.CRIT,arguments)}if((args&&args.code)!="ERR_ASSERTION")console.error("zerr.zexit was called",(new Error).stack);E.flush();if(process.zon&&process.zon.main){var LCRIT=2;var LCONSOLE=256;var emb_zutil=process.binding("zutil");emb_zutil.zerr(LCRIT|LCONSOLE,"perr node_zexit "+E.e2s(args));process.exit(1)}if(env.NODE_ENV=="production"){var conf=require("./conf.js");var zcounter_file=require("./zcounter_file.js");zcounter_file.inc("server_zexit");args=zerr_format(arguments);write_zexit_log({id:"lerr_server_zexit",info:""+args,ts:date.to_sql(),backtrace:stack,version:version,app:conf.app});E.flush()}debugger;process.exit(1)};var write_zexit_log=function(json){try{var file=require("./file.js");file.mkdirp(E.ZEXIT_LOG_DIR);file.write_atomic_e(E.ZEXIT_LOG_DIR+"/"+date.to_log_file()+"_zexit_"+process.pid+".log",E.json(json))}catch(e){E.zerr(E.e2s(e))}}}else{var chrome;E.log=[];var L_STR=E.L_STR=["EMERGENCY","ALERT","CRITICAL","ERROR","WARNING","NOTICE","INFO","DEBUG"];E.log.max_size=200;if(is_rn){E.level=L.WARN;E.hide_timestamp=true}else{chrome=self.chrome;E.conf=self.conf;E.level=self.is_tpopup?L.CRITICAL:E.conf&&E.conf.zerr_level?L[self.conf.zerr_level]:L.WARN}var console_method=function(l){if(is_rn)return l<=L.NOTICE?"log":l<=L.INFO?"info":"debug";return l<=L.ERR?"error":!chrome?"log":l===L.WARN?"warn":l<=L.INFO?"info":"debug"};_zerr=function(l,args){var s;try{var fmt=""+args[0];var fmt_args=Array.prototype.slice.call(args,1);s=(fmt+(fmt_args.length?" "+E.json(fmt_args):"")).substr(0,1024);var prefix=(E.hide_timestamp?"":date.to_sql_ms()+" ")+L_STR[l]+": ";if(E.is(l)){Function.prototype.apply.bind(console[console_method(l)],console)([prefix+fmt].concat(fmt_args))}log_tail_push(prefix+s)}catch(err){try{console.error("ERROR in zerr "+(err.stack||err),arguments)}catch(e){}}if(l<=L.CRIT)throw new Error(s)};E._zerr=_zerr;var post=function(url,data){var use_xdr=typeof XDomainRequest=="function"&&!("withCredentials"in XMLHttpRequest.prototype);var req=use_xdr?new XDomainRequest:new XMLHttpRequest;req.open("POST",url);if(req.setRequestHeader){req.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8")}req.send(zescape.qs(data));return req};var perr_transport=function(id,info,opt){opt=zutil.clone(opt||{});var qs=opt.qs||{},data=opt.data||{};data.is_json=1;if(info&&typeof info!="string")info=zerr.json(info);if(opt.err&&!info)info=""+(opt.err.message||zerr.json(opt.err));data.info=info;qs.id=id;if(!opt.no_zerr){zerr._zerr(opt.level,["perr "+id+(info?" info: "+info:"")+(opt.bt?"\n"+opt.bt:"")])}return post(zescape.uri(E.conf.url_perr+"/perr",qs),data)};var perr=function(perr_orig,pending){while(pending.length)perr_transport.apply(null,pending.shift());return perr_transport};E.perr_install(perr)}return E})})();
define("/svc/cdn/pub/spark_log.js",["/util/zerr.js"],function(zerr){var E={};E._conf={level:"no",max_size:8192};E._log_fn=typeof console!="undefined"?console.log.bind(console):function(){};E._log_id=1;E._logs=[];var log_types={no:{level:0},crit:{level:1},err:{level:2,code:"ERR"},warn:{level:3,code:"WRN"},notice:{level:4},info:{level:5,code:"INF"},debug:{level:6,code:"DBG"}};function log_level_handler(log_type){return function(msg){try{var log_instance=this;var ts=Date.now();var id=E._log_id++;E._logs.push({msg:msg,ts:ts,prefix:log_instance._prefix_str,id:id});if(E._logs.length>=E._conf.max_size)E._logs.splice(0,E._conf.max_size/2|0);if(E._conf.level=="no"||log_type.level>log_types[E._conf.level].level){return}var args=Array.prototype.slice.call(arguments);args[0]=log_instance._prefix_log_str+args[0];(zerr[E._conf.level]||zerr).apply(zerr,args)}catch(err){console.error("log_level_handler error %s %s",msg,err)}}}function log(prefix){this._prefix=prefix?typeof prefix=="string"?[prefix]:prefix:[];this._prefix_str=this._prefix.join("|");this._prefix_log_str=this._prefix_str?"["+this._prefix_str+"] ":"";this._frame_str=window.top==window?"1":"0"}log.prototype.err=log_level_handler(log_types.err);log.prototype.warn=log_level_handler(log_types.warn);log.prototype.info=log_level_handler(log_types.info);log.prototype.debug=log_level_handler(log_types.debug);log.prototype.notice=log_level_handler(log_types.notice);log.prototype.fork=function(prefix){var new_prefix=this._prefix.slice();new_prefix.push(prefix);return new log(new_prefix)};E.log=log;E.init=function(conf){Object.assign(E._conf,conf);zerr.set_level((E._conf.level||"NOTICE").toUpperCase());return new log};return E});
define("/svc/cdn/pub/spark.js",["cash","/util/util.js","/util/url.js","/svc/cdn/pub/util.js","/svc/cdn/pub/cdnlist.js","/svc/cdn/pub/spark_features.js","/svc/cdn/pub/log.js","/svc/cdn/pub/links.js","/util/events.js","/svc/cdn/pub/spark_layout.js","/util/escape.js","/svc/cdn/pub/l10n.js","/svc/cdn/pub/msg.js","/svc/cdn/pub/ga.js","/svc/cdn/pub/storage.js","/svc/cdn/pub/spark_stats.js","/svc/cdn/pub/spark_player.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/api.js","/svc/cdn/pub/editor.js","/svc/cdn/pub/perr.js","/svc/cdn/pub/features.js","/svc/cdn/pub/widget_info.js","/svc/cdn/pub/spark_log.js"],function($,zutil,zurl,util,cdnlist,spark_features,_log,links,events,spark_layout,zescape,l10n,msg,ga,storage,spark_stats,spark_players,dom_util,api,editor,perr,features,widget_info,spark_log){var qs_o=zurl.qs_parse((location.search||"").substr(1));var E=new util.events,assign=Object.assign,id="spark";var ms_sec=1e3,ms_min=60*ms_sec,ms_hour=60*ms_min;var ms_day=24*ms_hour,ms_week=7*ms_day;window.spark_web=window.spark_web||{};E.api=window.spark_web;var log=_log?_log.set_type(id):{warn:function(){},info:function(){}};E._log=log;if(!events)events={EventEmitter:function(){}};function check_spark_navigate(){if(!util.is_top)return;var referrer,navigate;if(!(referrer=document.referrer)||!(navigate=E.storage.get("spark_navigate"))){return}var now=Date.now();Object.keys(navigate).forEach(function(key){if(now-navigate[key].ts>3*ms_min)delete navigate[key]});E.storage.set_and_sync("spark_navigate",navigate);if(navigate[E.top_url]&&navigate[E.top_url].referrer==referrer)E.spark_navigate=navigate[E.top_url].source||true}function debug_init(){E.api.debug=debug_spark;if(storage.db.get("spark_debug")){var debug_conf=true;try{debug_conf=JSON.parse(storage.db.get("spark_debug"))}catch(e){}debug_spark(debug_conf)}if(util.get_spark_uri("spark_debug"))debug_spark()}function debug_spark(v){if(!E.conf)return;util.is_debug=E.conf.debug=v===undefined?true:v;E.spark_log.info("spark debug mode is "+E.conf.debug);if(E.conf.debug)storage.db.set("spark_debug",JSON.stringify(E.conf.debug));else storage.db.clr("spark_debug")}function detect_window_params(){E.params={};for(var p in window.spark_conf||{})E.params["spark_"+p]=window.spark_conf[p]}function filter_link_tags_from_url(url){function get_feature_tags(feature,conf){var platform_conf=util.get_platform_conf(conf);if(util.has_ext)return conf.enable&&platform_conf.link_tags;if(!features.is_feature_available(feature))return;if(!platform_conf.disable&&E._is_browser_allowed(platform_conf.browsers)&&E.is_os_allowed(platform_conf.os)&&E._is_platform_allowed(platform_conf.platform)){return conf.enable&&platform_conf.link_tags}}function get_zone_tags(zone){var res=[];for(var feature in features.features)res=res.concat(get_feature_tags(feature,zone[feature]||{})||[]);return res}var zones=get_zones_array(E.orig_conf.zones);var tags=get_zone_tags(E.orig_conf);zones.forEach(function(conf){tags=tags.concat(get_zone_tags(conf))});var fragment_tags=[],query_tags=[];tags.forEach(function(tag){if(tag.type=="fragment")fragment_tags.push(tag.name);else query_tags.push(tag.name)});var u=zurl.parse(url),is_params=u.search||u.hash;if(u.search){var query=util.remove_from_qs(u.search.substr(1),query_tags);u.path=u.pathname+(query?"?"+query:"")}if(u.hash){var hash=util.remove_from_qs(u.hash.substr(1),fragment_tags);u.hash=hash?"#"+hash:""}return is_params?zurl.uri_obj_href(u):url}function filter_params_from_url(url){var u=zurl.parse(url);function parse_params(s){if(!s)return;var ret={params:[]},h=s.substr(1).split("&");h.forEach(function(p){var has_val=p.search("=")>-1;var name=p.substr(0,has_val?p.search("="):undefined);var val=has_val?p.substr(p.search("=")+1):undefined;if(/^hola_/.test(name))name=name.replace("hola_","spark_");if(/^spark_/.test(name)){ret.spark_params=ret.spark_params||{};ret.spark_params[name]=val||true}else ret.params.push(p)});return ret}var p,modified;E.params=E.params||{};if((p=parse_params(u.search))&&p.spark_params){assign(E.params,p.spark_params);u.path=u.pathname+(p.params.length?"?"+p.params.join("&"):"");modified=true}if((p=parse_params(u.hash))&&p.spark_params){assign(E.params,p.spark_params);u.hash=p.params.length?"#"+p.params.join("&"):undefined;modified=true}if(modified)url=zurl.uri_obj_href(u);return url}function final_params(){E.final_params=true;E.emit("final_params");if(E.params.spark_debug!==undefined)debug_spark(E.params.spark_debug)}function ga_init(){if(!ga||ga.__stub)return;var ga_conf=E.get_conf("general.google_analytics");if(ga_conf&&ga_conf.enable)E.google_analytics=new ga(ga_conf,E)}function geoip_required_for_init(conf){var zones=Object.values(conf.zones||{});return!!zones.find(function(r){return zutil.get(r,"country.include.length")||zutil.get(r,"country.exclude.length")})}function get_ads_txt_domains(ads_txt){if(!ads_txt)return;var max_size=500*100*2;if(ads_txt.length>max_size)return;var domains={},l;var lines=ads_txt.split("\n");for(var i=0;i<lines.length;i++){l=lines[i];if(l[0]=="#")continue;l=l.replace(/\s*#.+$/g,"");if(/^\s*$/.test(l))continue;if(/(contact|subdomain)=/i.test(l))continue;l=l.split(",");if(l.length<2)return;var domain=l[0].toLowerCase().replace(/^\s*"|"\s*$/g,"");if(domain.length<3||/[#<>=\/\ ]/.test(domain))return;domains[domain]=1}return Object.keys(domains)}function get_spark_conf(){var spark_conf=storage.db.get_json("spark_conf")||storage.db.get_json("hola_spark_conf");var window_spark_conf=typeof window!="undefined"&&(window.spark_conf||window.hola_spark_conf);if(!window_spark_conf&&!spark_conf)return;spark_conf=zutil.extend_deep({},window_spark_conf,spark_conf);if(!get_spark_conf.get_spark_conf_warn){E.spark_log.warn("using hola_spark_conf "+JSON.stringify(spark_conf));get_spark_conf.get_spark_conf_warn=true}return spark_conf}function get_conf(){var conf=E.orig_conf||{};var zones=get_zones_array(conf.zones);var c=zones.find(function(r){function url_match(){return(r.by_frame_url?E.frame_url:E.top_url).match(r.match)}function country_match(){var code=zutil.get(util.geoip,"country");var include=zutil.get(r.country,"include",[]);var exclude=zutil.get(r.country,"exclude",[]);return(!include.length||include.includes(code))&&(!exclude.length||!exclude.includes(code))}function custom_match(){var fn;if(fn=r.is_match_allowed)fn=typeof fn=="string"?new Function(fn):fn;return!fn||fn({top_url:E.top_url})}var editor_mode_skip=E.is_editor_mode&&zutil.get(r,"general.disable_editor_mode");return url_match()&&country_match()&&custom_match()&&!editor_mode_skip});var force_zone=qs_o.spark_force_zone;if(force_zone){c=zones.find(function(r){return r.name===force_zone})||c;console.log("spark force zone %s %s %o",force_zone,c.name==force_zone?"OK":"FAILED",c)}c=c||conf;if(conf&&conf.conf_overload)conf.conf_overload({conf:conf,c:c,E:E,qs_o:qs_o});E.api.conf=conf;E.api.spark_zone=E.spark_zone=c;E.spark_zone.name=E.spark_zone.name||"default";for(var feature in features.features){if((c[feature]||{use_default_conf:true}).use_default_conf)c[feature]=conf[feature]}if(conf.disable)c.disable=true;var final={general:zutil.clone_deep(conf.general)};final=zutil.extend_deep(final,c,get_spark_conf());if(E.params.spark_conf){var spark_conf=zescape.parse.http_words(E.params.spark_conf);for(var i=0;i<spark_conf.length;i++){zutil.set(final,spark_conf[i][0],spark_conf[i][1]=="false"?false:spark_conf[i][1])}}return final}function get_friendly_frame_el(){try{var iframes=window.top.document.querySelectorAll("iframe");for(var i=0;i<iframes.length;i++){if(iframes[i].contentWindow==window)return iframes[i]}}catch(e){}}function get_zones_array(zones){var array=Object.values(zones||{});array.sort(function(a,b){return a.order-b.order});return array}function init_api(){E.api.$=$;E.api.ver=E.ver;E.api.tag_id=E.tag_id;E.api.version=E.version;E.api.get_raw_stats=function(module){var _spark_stats=E.stats.get_stats();var ret=module&&_spark_stats[module]||_spark_stats;console.log("Spark stats\n"+JSON.stringify(ret));return ret};E.api.layout_add=spark_layout&&!spark_layout.__stub?spark_layout.add:function(){};E.api._spark=E}function init_conf(next){E.conf=get_conf();if(!util.is_enabled(l10n))return next();l10n.init({spark:E});var platform_conf=util.get_platform_conf(E.conf.general);l10n.override(platform_conf.strings||{},"general");next()}function init_history(){var max_entries=200;E.history_storage=E.storage.alloc("history",{def:{views:[]}});E.history_storage.set_max_limit("views",max_entries);E.on("video_view",function(info){if(!info.page_url||!info.cache_url)return;var idx,v;var history=E.history_storage.get("views");var mod=0;while((v=history.find(function(v,i){idx=i;return(v.url_key||v.cache_url)==info.cache_url}))&&mod<5){E.history_storage.splice("views",idx,1);history=E.history_storage.get("views");mod++}E.history_storage.push_and_sync("views",assign({ts:new Date},info))});if(util.is_unfriendly_iframe&&E.history_storage.get_parent("was_top")&&E.history_storage.prev.views){var history=E.history_storage.get("views");E.history_storage.prev.views.forEach(function(v){if(!history.find(function(v2){return(v2.url_key||v2.cache_url)==v.cache_url})){E.history_storage.push_and_sync("views",v)}})}var get_history=function(limit){var data=E.history_storage.get("views");if(limit)data=data.slice(-limit);return data.reverse()};E.history={data:get_history(),get:get_history}}function init_spark_log(){var level=util.get(E.loader,"loader_conf.log.log_level")||"no";var log_conf=assign({level:level},E.get_orig_conf("general.modules.log")||{});if(util.get_spark_uri("spark_debug"))log_conf.level="debug";E.spark_log=spark_log.init(log_conf);E.spark_log.info("log inited");E.spark_log_module=spark_log}function init_spark_random(next){if(E.get_orig_conf("general.disable_storage"))return next();var conf;if(storage.is_stub()||!(conf=E.get_orig_conf("general.sync_spark_random"))||!conf.enable){return next()}if(util.is_mobile){console.debug("sync_spark_random init, top: "+util.is_top+" frame: "+E.frame_url+" sr: "+storage.db.get("spark_random")+" synced: "+storage.db.get("spark_random_synced")+" master: "+conf.master_hostname+" host: "+zurl.parse(E.frame_url).hostname)}if(util.is_top||conf.master_hostname!=zurl.parse(E.frame_url).hostname){window.spark_random_synced=!!storage.db.get("spark_random_synced");if(util.is_mobile&&!window.spark_random_synced){var cnt=+(storage.db.get("spark_random_unsynced_cnt")||0);console.debug("sync_spark_random goto init_conf, synced: "+window.spark_random_synced," cnt: "+cnt);if(cnt>2){storage.db.set("spark_random",""+(Math.random()*100|0));window.spark_random_synced=true}else storage.db.set("spark_random_unsynced_cnt",""+(cnt+1))}return next()}var master_found_handler=function(){if(util.is_mobile)console.debug("sync_spark_random got master, frame: "+E.frame_url);var spark_random;try{spark_random=storage.db.get("spark_random");if(!spark_random||spark_random=="0"){spark_random=Math.random()*100|0;storage.db.set("spark_random",""+spark_random);this.new_spark_random=true}else spark_random=+spark_random}catch(e){return set_spark_random_handler()}if(util.is_mobile){console.debug("sync_spark_random send msg, sr: "+spark_random+" "+this.new_spark_random)}E.msg.set_spark_random_cb(spark_random,util.is_mobile&&this.new_spark_random,set_spark_random_handler)};var set_spark_random_handler=function(result){if(result&&result.spark_random&&util.is_mobile&&(this.new_spark_random||result.unsynced_cnt>2)){console.debug("sync_spark_random hack: "+JSON.stringify(result));storage.db.set("spark_random",""+result.spark_random);window.spark_random_synced=true;return next()}window.spark_random_synced=result&&result.synced&&result.spark_random==storage.db.get("spark_random");if(util.is_mobile){console.debug("sync_spark_random got msg: "+JSON.stringify(result)+" synced: "+window.spark_random_synced)}next()};if(E.has_master)return void master_found_handler();if(util.is_mobile)console.debug("sync_spark_random wait for master");E.msg.once("master_found",master_found_handler)}function init_stats(){spark_stats.set_dependecies(E,log);E.stats=new spark_stats(id);E.stats.o.timing=util.get_script_timing(true)}function init_xhr_api(){if(!util.is_enabled(api))return void E.spark_log.info("api is disabled");api.init(E,{cdns:E.conf.cdns,customer:E.customer,debug:E.conf.debug,get_top_url:function(cb){E.verify_top_url_cb(function(){cb(E.top_url)})},spark_zone:E.spark_zone.name,stats:E.stats.alloc("api")})}function is_friendly_frame_allowed_by_css(css_filter){try{var current_frame;if(current_frame=get_friendly_frame_el())return dom_util.is_el_allowed_by_css(current_frame,css_filter)}catch(e){}return true}function msg_init(){if(E.msg)return;var find_frame=function(idx){if(!E.msg.frames[idx])return;var w=E.msg.frames[idx].frame;return $("iframe").get().find(function(_f){return _f.contentWindow==w})};E.msg=new msg(id,{child_frames:true,handlers:[{type:"top",name:"set_event",func:function(frame_idx,customer,_id,data){E.set_event(_id,data)}},{type:"top",name:"get_top_url",func:function(){var page_expires;try{page_expires=/expires/.test(JSON.stringify(window.__NUXT__))}catch(err){}return{top_url:E.get_top_url(),modified:E.top_url_modified,top_url_full:location.href,page_expires:page_expires}}},{type:"top",name:"get_params",func:E.get_params},{type:"top",name:"get_spark_navigate",func:function(){return E.spark_navigate}},{type:"top",name:"set_title",opt:{exec_on_self:true},func:function(idx,val,info){run_player_conf_func("set_title_func",val,info)}},{type:"top",name:"set_description",opt:{exec_on_self:true},func:function(idx,val,info){return run_player_conf_func("set_description_func",val,info)}},{type:"top",name:"check_frame_css",func:function(idx,filter){var f=find_frame(idx);return f&&dom_util.is_el_allowed_by_css(f,filter)}},{type:"top",name:"set_spark_random",func:function(idx,val,keep_old){if(storage.is_stub()||E.get_orig_conf("general.disable_storage")){return}try{var old_val=storage.db.get("spark_random");var ret={spark_random:old_val,synced:old_val==val&&storage.db.get("spark_random_synced"),unsynced_cnt:storage.db.get("spark_random_unsynced_cnt")};if(!old_val||!keep_old)storage.db.set("spark_random",""+val);storage.db.set("spark_random_synced","1");return ret}catch(e){}}},{type:"top",name:"get_frame_pos",func:function(idx){var f=find_frame(idx);return f&&(f=f.getBoundingClientRect())&&{win:{height:window.innerHeight,width:window.innerWidth},top:f.top,left:f.left}}},{type:"top",name:"update_perr_info",func:function(idx,perr_info){if(E.stats)E.stats.perr_info=perr_info}}]});if(E.msg._has_master)E.has_master=true;else E.msg.on("master_found",function(){E.has_master=true})}function run_player_conf_func(fn,val,info){if(!(fn=E.get_conf("general.player."+fn)))return;try{fn=typeof fn=="string"?new Function("$","val","info",fn):fn;return fn($,val,info)}catch(e){E.spark_log.err("invalid conf_func function: "+(e&&e.toString())||"JS Error")}}function set_font_family(){var font=E.get_conf("general.font_family");var font_roboto=E.get_conf("general.font_roboto");var load_default=false,fonts=[];if(!font)load_default=true;else if(font!="auto"){fonts.push(font);var styles=document.body&&getComputedStyle(document.body);var page_font=styles&&styles.fontFamily;if(!page_font)load_default=true;else fonts.push(page_font)}if(load_default){fonts.push((font_roboto?"Roboto, ":"")+"Arial, Helvetica, sans-serif")}if(fonts.length){var style="";if(load_default&&font_roboto)style="@import url('"+require.zdot("font_roboto_css")+"');\n";style+=".hola_top_element { font-family: "+fonts.join(",")+" !important; }";dom_util.add_style("data-spark-font",style)}}function set_page_view(){if(!util.is_top||E.is_spark_site)return;if(E.google_analytics)E.google_analytics.report_metric("page_view_n",1);if(E.get_conf("general.perr.disable_page_view"))return;var info={cache_url:E.cache_top_url,spark_zone:E.spark_zone.name};if(util.is_mobile)info.is_mobile=true;if(E.params.spark_wn)info.watch_next_url=true;E.set_unique_view_info("page",info);if(E.spark_disabled||E.get_conf("general.stats.disable")||E.get_conf("general.perr.send_page_view")){perr({id:"spark_page_view",delay:false,info:info});var send_long_page_view=E.get_conf("general.perr.send_long_page_view");if(send_long_page_view){setTimeout(function(){delete info.unique;perr({id:"spark_long_page_view",delay:false,info:info})},send_long_page_view*ms_sec)}return}E.stats.add_perr_payload("page_view",info)}function set_top_url(url){if(util.is_app)url="http://"+E.customer+".holaspark.com/";url=filter_params_from_url(url);url=filter_link_tags_from_url(url);if(util.clean_top_url(url)==util.clean_top_url(E.top_url))return E.top_url;if(util.is_top&&!E.top_url_modified){if(E.top_url)E.top_url_modified=true;else{var loader_url=window.spark_loader&&window.spark_loader.top_url;if(loader_url){loader_url=filter_params_from_url(loader_url);loader_url=filter_link_tags_from_url(loader_url);E.top_url_modified=loader_url&&util.clean_top_url(loader_url)!=util.clean_top_url(url)}}}E.cache_top_url=E.page2cache(url);E.top_url=url;var _url=zurl.parse(url);E.is_spark_site=_url.hostname=="holaspark.com";E.is_site_root=_url.pathname=="/";E.emit("set_top_url",url);if(util.is_top&&!E.final_params)final_params();return E.top_url}function setup_ad_sources(){if(E.is_spark_site||zutil.is_mocha())return;var handle_ads=function(res){var srcs=(res||[]).concat(util.CG("ad_sources",[])).concat(spark_features.ad_sources);util.CS("ad_sources",srcs);if(res&&res.length&&util.is_enabled(links))links.append_rejected_origins(res)};var clean_ads=function(){E.storage.set("ads_txt",{data:[],date:new Date});handle_ads()};if(E.get_conf("general.disable_ads_txt"))return handle_ads();var get_storage_ads=function(){var ads=E.storage.get("ads_txt");if(ads&&ads.data&&new Date-new Date(ads.date)<ms_week)return ads.data};var ads;if(ads=get_storage_ads())return handle_ads(ads);if(!util.is_top){E.storage.on("master_synced",function(){if(ads=get_storage_ads())return handle_ads(ads)});return}if(!util.is_enabled(api))return E.spark_log.info("api is disabled; no /ads.txt request");api.get_ads_txt(function(res){res=get_ads_txt_domains(res);if(!res)return clean_ads();E.storage.set("ads_txt",{data:res,date:new Date});handle_ads(res)},clean_ads)}var report_timer=10,report_timeout;function timed_report(){clearTimeout(report_timeout);report_timeout=setTimeout(E.send_report,report_timer*ms_sec);var conf=E.get_conf("general.stats",{timer_from:300,timer:300});report_timer=new Date-E.loader.init_ts>(conf.timer_from||0)*ms_sec&&conf.timer||120}function validate_frame(next,stop){function frame_disabled(){E.spark_log.info("spark disabled in frame");stop()}if(util.is_top)return next();var sel_filter=E.get_conf("general.player.filter_frame_by_css");if(!sel_filter)return next();if(util.is_friendly_iframe){if(!is_friendly_frame_allowed_by_css(sel_filter))return void frame_disabled();return next()}wait_storage_master_sync(function(){E.msg.check_frame_css_cb(sel_filter,function(is_allowed){if(!is_allowed)return void frame_disabled();next()})})}var wait_geoip=function(next){if(!geoip_required_for_init(E.orig_conf)||util.geoip.country)return void next();if(!util.is_enabled(cdnlist)){E.spark_log.err("geoip is required, but cdnlist.js is disabled");return void next()}if(!cdnlist.bootstraps)return void next();E.spark_log.info("spark waiting for geoip to init");cdnlist.bootstraps.once("geoip_received",next)};function wait_storage_master_sync(cb){if(E.storage.master_synced)return cb();E.storage.once("master_synced",cb)}function wait_top_url_sync(next){if(!util.is_unfriendly_iframe||E.get_orig_conf("general.dont_wait_top_url_sync")){return next()}wait_storage_master_sync(function(){E.verify_top_url_cb(next)})}function get_browser(list){var browser=util.browser&&util.browser.browser;if(!browser||!util.browser||!list)return browser;var in_list=function(br){return list.exclude&&list.exclude.includes(br)||list.include&&list.include.includes(br)};if(util.browser.ucbrowser&&in_list("ucbrowser"))return"ucbrowser";if(util.browser.samsung_browser&&in_list("samsung_browser"))return"samsung_browser";var wv_browser=browser=="safari"?"ios_browser":"android_browser";if(util.browser.webview&&in_list(wv_browser))return wv_browser;return browser}E._is_browser_allowed=function(list){var browser=get_browser(list);return util.is_item_allowed(list,browser)};E._is_platform_allowed=function(opt){if(!opt)return true;if(util.is_app)return!opt.app_disabled;return util.is_mobile?!opt.mobile_disabled:!opt.desktop_disabled};E.api.events=[];E.api.event_stats=function(){var ret={};E.api.events.forEach(function(e){ret[e.event]=ret[e.event]||0;ret[e.event]++});console.log("Spark event stats\n"+JSON.stringify(ret))};E.api.off=function(_id,cb){return E.ext_events.off(_id,cb)};E.api.on=function(_id,cb){return E.ext_events.on(_id,cb)};E.api.once=function(_id,cb){return E.ext_events.once(_id,cb)};E.detect_top_url=function(){set_top_url(util.get_top_url())};E.ext_events=new util.events;E.force_enable=function(feature){var vars=features.modules[feature].force_enable||features.modules[feature].name;if(!vars)return false;var enable=false;if(typeof vars=="string")vars=[vars];vars.forEach(function(v){["hola_","spark_"].forEach(function(prefix){var param=prefix+v;enable=enable||[true,1].includes(window[param])||["true","1","on"].includes(util.get_spark_uri({},param))||["true","1","on"].includes(storage.db.get(param))})});return enable};E.gen_page_url=function(url,tags,opt){opt=opt||{};url=util.absolute_uri(url);var url_obj=zurl.parse(url);var fragment_parts=zurl.qs_parse((url_obj.hash||"").substr(1));var query_parts=zurl.qs_parse((url_obj.search||"").substr(1));var all_params=assign({},fragment_parts,query_parts);var fragment={},query={};var is_hash=!url_obj.hash||tags.some(function(tag){return tag.type=="fragment"})||Object.keys(fragment_parts).some(function(key){return/^spark_|^hola_/.test(key)});tags.forEach(function(tag){var value=tag.value||1;if(tag.type=="auto"&&all_params[tag.name])return;if(tag.type=="fragment"||tag.type=="auto"&&is_hash)fragment[tag.name]=value;else query[tag.name]=value});if(Object.keys(fragment).length){url_obj.hash="#"+zescape.qs(assign(fragment_parts,fragment));url=zurl.uri_obj_href(url_obj)}if(Object.keys(query).length)url=zurl.qs_add(url,query);return opt.customer_generated?url:util.page2link(url)};E.geoip_required=function(conf){return geoip_required_for_init(conf)};E.get_cdn_conf=function(key){return zutil.get(E._gen,key)};E.get_conf=function(key,def_value){return zutil.get(E.conf,key,def_value)};E.get_feature_if_inited=features.get_feature_if_inited;E.get_features=features.get_features;E.get_orig_conf=function(key,def_value){return zutil.get(E.orig_conf,key,def_value)};E.get_params=function(){return E.params};E.get_top_url=function(){return set_top_url(util.get_top_url())};E.is_allowed=function(skip_reasons){var block={forced_by_uri:true,filtered_out:true,origin_not_allowed:true};if(Array.isArray(E.conf.allow_skip_reasons))E.conf.allow_skip_reasons.forEach(function(r){block[r]=false});return!Object.keys(skip_reasons).find(function(r){return block[r]})};E.is_feature_enabled=features.is_feature_enabled;E.is_feature_inited=features.is_feature_inited;E.is_os_allowed=function(list){var os=util.guess&&util.guess.os;return util.is_item_allowed(list,os)};E.is_url_allowed=function(list){return util.check_url(E.top_url,list)};E.is_video_url_allowed=function(video_url,conf){conf=conf||util.get_platform_conf(E.conf.video_previews);var videos={exclude:conf.exclude_video_for_mapping||[]};if(!util.check_url(video_url,videos))return false;var exclude=E.get_orig_conf("video_previews.exclude_video_for_mapping_glob")||[];return util.check_url(video_url,{exclude:exclude})};E.log=function(module){var _spark_log=log?log.set_module(module):{notice:function(){},info:function(){}};_spark_log.debug_spark=function(){var args=[].slice.call(arguments);_spark_log[E.conf.debug?"notice":"info"].apply(_spark_log,args)};return _spark_log};E.page2cache=function(url){url=url.replace(/\/\/www\./,"//");if(util.CG("transform.page2cache")){url=util.gconf_apply("transform.page2cache",[url,{mobile:util.is_mobile}],util.def_url2cache(url))}else url=util.def_url2cache(url);return url.replace(/^((?:http|https):)?(\/\/)?/i,"http://")};E.save_navigate=function(href,source){var navigate=E.storage.get("spark_navigate")||{};navigate[href]={source:source,referrer:E.top_url,ts:Date.now()};E.storage.set_and_sync("spark_navigate",navigate)};E.send_report=function(e){try{var drop=E.get_conf("general.drop_stats_ratio");var random=+storage.db.get("spark_random")/100||Math.random();if(random<drop)return}catch(err){console.log("spark send_report failed")}var unload=e&&e.type=="beforeunload";timed_report();if(!E.stats.perr_payload.page_view&&(!E.stats.has_normal&&!E.get_conf("general.stats.ab_test"))&&(!Object.keys(E.stats.perr_payload)||E.stats.skipped<3&&!unload)&&(!E.stats.has_freq||E.stats.skipped<10&&!unload)){E.stats.skipped++;return}var no_beacon=(util.is_safari||util.is_ios)&&!util.has_beacon;if(unload&&no_beacon)return;E.stats.send_perr()};E.set_event=function(_id,data,el){if(!E.params.spark_enable_events&&!E.get_conf("general.enable_events"))return;var __id="spark_"+_id;var info=assign({event:__id},data);E.api.events.push(info);E.ext_events.emit(__id,data);E.ext_events.emit("spark_any",info);el=el||document;if(el&&el.dispatchEvent){var e1,e2;if(typeof CustomEvent=="function"){e1=new CustomEvent(__id,{bubbles:true,detail:data});e2=new CustomEvent("spark_any",{bubbles:true,detail:info})}else if(typeof CustomEvent=="object"&&document.createEvent){var evt=document.createEvent("CustomEvent");e1=evt.initCustomEvent(__id,true,false,info);evt=document.createEvent("CustomEvent");e2=evt.initCustomEvent("spark_any",true,false,info)}if(e1&&e2){el.dispatchEvent(e1);el.dispatchEvent(e2)}}if(!util.is_top)E.msg.set_event(E.customer,_id,assign({frame:E.frame_url},data))};E.set_unique_view_info=function(type,info){var now=Date.now();var is_other_day=function(last){if(!last)return true;last=+last;return now-last>ms_day||now-last>6*ms_hour&&new Date(now).getUTCDate()!=new Date(last).getUTCDate()};var unique=[];var reported=E.storage.get(type+"_view_reported");if(is_other_day(reported)){if(!reported)unique.push("first");unique.push("1d");E.storage.set(type+"_view_reported",now)}var view_reports=E.storage.get(type+"_view_reports")||{};if(is_other_day(view_reports[E.spark_zone.name])){if(!view_reports[E.spark_zone.name])unique.push("first_zone");unique.push("1d_zone");view_reports[E.spark_zone.name]=now;E.storage.set(type+"_view_reports",view_reports)}if(!unique.length)return;if(info)info.unique=unique;return unique};E.spark_event=function(data){var f=features.features[data.id],cb;if(cb=f&&f.inited&&f.module&&f.module.app_events)cb(data)};E.verify_top_url_cb=function(cb){cb=cb||function(){};var get_top_url=function(_cb){var urls=util.get_location_urls();if(util.is_top||urls.root_top_url){return _cb({top_url:urls.root_top_url||urls.top_url,modified:E.top_url_modified})}E.msg.get_top_url_cb(_cb)};var get_params,get_navigate;if(util.is_top){get_params=function(_cb){_cb(E.params)};get_navigate=function(_cb){_cb()}}else{get_params=function(_cb){E.msg.get_params_cb(_cb)};get_navigate=function(_cb){E.msg.get_spark_navigate_cb(_cb)}}get_top_url(function(res){if(res){set_top_url(res.top_url);E.top_url_modified=res.modified;E.page_expires=res&&res.page_expires;E.top_url_full=res&&res.top_url_full}get_params(function(params){if(params){E.params=params;final_params()}get_navigate(function(navigate){if(!util.is_top&&navigate)E.spark_navigate=navigate;cb(E.top_url)})})})};E.video2cache=function(url){return util.video2cache(url)};function editor_mode(next){var spark_mode=storage.db.get("spark_mode")||E.params.spark_mode;E.is_editor_mode=spark_mode=="editor";if(!E.is_editor_mode||!util.is_enabled(editor))return void next();editor.init(E,function(inited){if(!inited)E.is_editor_mode=false;next()})}function init(next){init_history();init_stats();init_xhr_api();E.players=spark_players.init(E,E.spark_log.fork("players"));setup_ad_sources();ga_init();debug_init();E.verify_top_url_cb();E.spark_disabled=!util.has_ext&&!E.params.spark_enable&&E.get_conf("disable");set_page_view();if(E.spark_disabled)return next();E.version=E.version_short+" Zone "+E.spark_zone.name;if(util.is_enabled(widget_info))widget_info.init(E);features.init(E);init_api();util.on("zbeforeunload",perr.try_wrapper({prefix:id},function(e){if(E.players){E.players.update_view_sec("unload");E.players.ad_summary("zbeforeunload")}E.send_report(e)}));timed_report();if(spark_layout&&!spark_layout.__stub)spark_layout.init(E);set_font_family();next()}function Queue(arr,cb,cb_err){this._arr=arr;this._idx=0;this._cb=cb;this._cb_err=cb_err}Queue.prototype._next=function(){var idx=this._idx++;var fn=this._arr[idx];if(!fn)return this._stop();try{fn(this._next.bind(this),this._stop.bind(this))}catch(e){console.error("Queue error %o",e);this._cb_err(e)}};Queue.prototype._stop=function(){this._arr=[];this._idx=0;this._cb()};Queue.prototype.start=function(){this._next()};E.init=function(opt,cb,cb_err){cb=cb||function(){};cb_err=cb_err||function(){};E._gen=opt.gen;E.loader=opt.loader;E.ver=E.loader.ver;E.tag_id=(E.loader.tag||{}).id;E.version_short=(E.ver||"0.0.0")+".T"+E.tag_id;E.orig_conf=opt.conf;E.customer=opt.loader.customer;E.frame_url=location.href;detect_window_params();init_spark_log();E.detect_top_url();msg_init();E.storage=storage.init(E,E.get_orig_conf("general.modules.storage"));E.storage_db=storage.db;check_spark_navigate();var queue=new Queue([wait_geoip,wait_top_url_sync,init_spark_random,editor_mode,init_conf,validate_frame,init],cb,cb_err);queue.start()};if(zutil.is_mocha()){var uninit=function(){features.t.uninit();if(E.links)E.links.t.uninit();api.t.uninit();delete E.msg};E.t={Storage:storage,filter_params_from_url:filter_params_from_url,uninit:uninit,get_conf:get_conf,filter_link_tags_from_url:filter_link_tags_from_url,get_ads_txt_domains:get_ads_txt_domains}}return E});
define("/svc/cdn/pub/flowplayer_hls_engine.js",{__stub:1});
define("/svc/cdn/pub/jwplayer_hls_provider.js",{__stub:1});
define("/svc/cdn/pub/vjs_hls_provider.js",{__stub:1});
define("/svc/cdn/pub/cdn_deps.js",{__stub:1});
require(["/util/es6_shim.js","/util/util.js","/svc/cdn/pub/util.js","/svc/cdn/pub/cdn_svc.js","/svc/cdn/pub/wrapper.js","/svc/cdn/pub/mode.js","/svc/cdn/pub/log.js","/svc/cdn/pub/cdnlist.js","/svc/cdn/pub/autodetect.js","/svc/cdn/pub/load_perf.js","/svc/cdn/pub/storage.js","/svc/cdn/pub/spark.js","/svc/cdn/pub/cdn_deps.js","/svc/cdn/pub/dom_util.js","/svc/cdn/pub/perr.js"],function(shim,zutil,util,cdn_svc,_wrapper,mode,_log,cdnlist,autodetect,load_perf,storage,spark,cdn_deps,dom_util,perr){if(window.hola_cdn&&window.hola_cdn.log){window.hola_cdn.loaded_twice=true;window.hola_cdn.log.warn("Hola loader.js already loaded. If you are using "+"Spark Player there is no need to load it separately, it is included "+"with Spark Player");window.hola_cdn.perr({id:"loader_already_loaded"});return}var E=new util.events;E.init_ts=util.date_monotonic();var CG=E.CG=util.gconf_get;E.videos=[];E.wrapper=[];E.hooks=[];E.log=_log;E.util=util;E.util.dom=dom_util;E.require=require;var log=_log.set_module("loader");var zones,gen;E.perr=perr;function JSON_parse(s){return JSON.parse(s,function(k,v){if(!v||typeof v!="object"||Object.keys(v).length!=1)return v;if(v.__ISODate__)return new Date(v.__ISODate__);if(v.__Function__){return new Function("","return ("+v.__Function__+");")()}if(v.__RegExp__){var parsed=/^\/(.*)\/(\w*)$/.exec(v.__RegExp__);if(!parsed)throw new Error("failed parsing regexp");return new RegExp(parsed[1],parsed[2])}if(v.__Infinity__)return v.__Infinity__<0?-Infinity:Infinity;return v})}var zdot_json=window.spark_dbg_conf=JSON_parse(require.zdot("json"))||{};if(util.is_ie&&util.browser.version<=11&&zdot_json.spark&&zdot_json.spark.zones){var json_zones=JSON.parse(require.zdot("json")).spark.zones;zdot_json.spark.zones=zutil.map_obj(json_zones,function(zone){return JSON_parse(JSON.stringify(zone))})}var assign=Object.assign;E.tag=zutil.is_mocha()?{id:123}:zdot_json.test&&zdot_json.test.tag||{};E.customer=zdot_json.customer;E._customer={status:zdot_json.customer_status,end:zdot_json.customer_end,name:zdot_json.customer};E.suspended=E._customer.status=="suspended";if(E._customer.status=="disabled"){E.disabled=true;E.disabled_reason="account closed"}E.loader_conf=zdot_json.loader||{};E.provider=zdot_json.provider||{};E.spark=zdot_json.spark||{};E.ad_sources=zdot_json.ad_sources||[];zones=zdot_json.zones||{};gen=zdot_json.gen||{};E.init_delay=!!zutil.get(E.loader_conf,"perr.enable_init_delay");E.ver=util.ver=util.conf.ver=zutil.is_mocha()?"1.0.0-mocha":require.zdot("version");util.is_zlxc=require.zdot("zlxc");function get_alt_loader_url(){var url;if(url=util.get_spark_uri("spark_loader_at"))return decodeURIComponent(url);return storage.db.get("__spark_loader_at")}var alt_loader;if(E.loader_conf.redirect_allowed&&(alt_loader=get_alt_loader_url())){if(!util.script_exists(alt_loader)){log.console("loading alternative loader.js at: "+alt_loader);util.load_script(alt_loader,function(){log.console("alternative loader.js loaded")});return}}E.jtest=window.hola_cdn&&window.hola_cdn.jtest||{};E.api=window.hola_cdn&&window.hola_cdn.api||{};window.hola_cdn=E.util.loader=E;E.jtest_init=function(ua,platform,_gen,_spark){if(!zutil.is_mocha())return;if(_gen)gen=assign(gen,_gen);if(_spark)E.spark=assign(E.spark,_spark);util.browser_init(ua,platform);E.t={on_init_ready:auto_detect_start}};function conf_init(){var conf=assign({bootstrap_cdns:require.zdot("agents"),loader:E.loader_conf},zutil.pick(E,"customer","ver","provider","ad_sources"),zutil.pick(zdot_json,"transform","disable_video_stats","privacy"),util.get_uri_conf());conf=zutil.extend_deep(conf,E.get_dbg_conf());if(zutil.get(E.spark,"general.modules.storage.disable"))storage.disable();util.init(conf);util.log=_log.set_module("util");util.geoip=zutil.clone(storage.db.get_json("hola_geoip")||{});perr.init(conf.perr_url)}var log_inited;function log_init(){if(log_inited)return;log_inited=true;_log.init(E.loader_conf&&E.loader_conf.log)}E.allow_feature_init=function(){return!E.suspended&&(!E.disabled||E.disabled_reason!="account closed")};var bwsaver_active=false;E.bwsaver_active=function(active){if(arguments.length)bwsaver_active=active;return bwsaver_active};function mode_init(){if(!mode||mode.__stub)return;var mode_opts={location:E.jtest.location,CG:CG,rules:[{cdn:1}]};var m=mode.select_mode(mode_opts);if(m.mode=="disabled"){E.disabled=true;E.disabled_reason=m.disabled_reason}var path_last=location.pathname.split("/").slice(-2);var frame=window==top?"top":(window.name?window.name+" (":"")+(path_last[1]||path_last[0])+(window.name?")":"");log.notice("hola spark loader v"+(E.ver||"0.0.0")+" tag "+(E.tag||{}).id+(m.disabled_reason?" mode disabled ("+m.disabled_reason+")":"")+" was loaded in frame: "+frame+(m.disabled_help?"\n"+m.disabled_help:""))}function cdnlist_init(){var geoip_required=cdn_enabled()||ve_enabled()&&spark.geoip_required(E.spark);if(!util.is_enabled(cdnlist)){if(geoip_required)log.warn("geoip is required, but cdnlist.js is disabled");return}cdnlist.init(!E.disabled&&require.zdot("agents"),E,require.zdot("all_agents"),!geoip_required||!E.allow_feature_init())}function cdn_enabled(){return util.is_enabled(cdn_svc)&&!util.get_spark_uri("hola_cdn_disable")}function cdn_init(cb){if(!cdn_enabled())return void cb();cdn_svc.init({loader:E});if(util.is_enabled(cdn_deps)&&!util.is_app)return void cdn_deps.init({loader:E},cb);cb()}function ve_enabled(){return util.is_enabled(spark)&&!util.get_spark_uri("spark_disable")}var suspend_msg=["%c*******************","**","**","**","**","**","** Spark is currently suspended.","** Possible reasons: Evaluation expired or negative account balance.","** Contact support@holaspark.com for additional information.","**","**","**","**","**","*******************"].join("\n");function ve_init(cb,cb_err){if(!ve_enabled())return void cb();if(!E.allow_feature_init()){console.log(suspend_msg,util.is_chrome||util.is_firefox?"color: red; font-size: 16px":"");return void cb()}spark.init({conf:E.spark,loader:E,gen:gen},cb,cb_err)}function feature_init(){var cdn_finish=false;var spark_finish=false;var err;var check_ready=function(){if(cdn_finish&&spark_finish){check_ready=function(){};on_deps_ready(err)}};cdn_init(function(){cdn_finish=true;check_ready()});ve_init(function(){spark_finish=true;check_ready()},function(_err){err=_err;console.error("ve_init error %o",_err);spark_finish=true;check_ready()})}function debug_init(){var hola_debug=storage.session_db.get("hola_debug");if(E.loader_conf.debug||util.get_spark_uri("hola_debug")||(storage.db.get_json("holacdn_debug")||{}).debug||(hola_debug||"false")!="false"){E.debug_mode()}}function loader_init(){if(/hola_debug_no_init/.test(location.search))return console.log("XXX disable loader_init");E.ts=util.date_monotonic();conf_init();if(util.conf&&util.conf.loader&&util.conf.loader.delay_cdn_init){var ms=util.conf.loader.delay_cdn_init({E:E,util:util});if(ms)return setTimeout(loader_init_rest,ms)}loader_init_rest()}function loader_init_rest(){log_init();mode_init();cdnlist_init();feature_init();debug_init()}function wrapper_create(opt){function on_context_created(context){E.videos.push(context);E.emit("wrapper_context_created",wrapper,context);context.once("shutdown",function(){var idx=E.videos.indexOf(context);if(idx>=0)E.videos.splice(idx,1)})}if(E.wrapper.length){if(CG("loader.multiplayer.disabled"))return log.notice("multiplayer mode disabled: skip new player")}var wrapper=new _wrapper(opt);E.wrapper.push(wrapper);wrapper.once("wrapper_attached",function(){wrapper.on("context_created",on_context_created);update_video_ctx(wrapper);if(wrapper.player){wrapper.player.on("state",function(){update_video_ctx(wrapper)})}E.emit("wrapper_attached",wrapper)});wrapper.once("wrapper_detached",function(_opt){wrapper.off("context_created",on_context_created);var index=E.wrapper.indexOf(wrapper);if(index>=0)E.wrapper.splice(index,1);if(wrapper.id==def_player)def_player=E.wrapper.length?E.wrapper[0].id:undefined;if(_opt.err)E.emit("wrapper_error",wrapper);E.emit("wrapper_detached",wrapper)});if(def_player===undefined)def_player=wrapper.id;return wrapper}function update_video_ctx(wrapper){E.video_ctx_latest=wrapper.video_ctx||wrapper.last_video_ctx}function init_player(opt){opt=opt||{};load_perf.push("init_player_start");var wrapper;if(!(wrapper=wrapper_create({player_id:opt.player_id,player_n:opt.player_n,log:opt.log||_log}))){return}wrapper.attach_config(opt);E.attached=true;return wrapper}E.finalize=function(){E.wrapper.forEach(function(w){if(w.attached)w.detach()});E.attached=false;E.wrapper=[];E.videos=[];def_player=undefined;E.emit("finalize")};E.print_load_perf=function(opt){return load_perf.timeline_to_str(E.get_cdn_zone(opt),true)};E._unwrap_opt=function(opt){if(opt===undefined)opt={id:def_player||-1};if(typeof opt=="number")opt={id:opt};if(typeof opt!="object")opt={id:-1};return zutil.extend({id:def_player||-1},opt)};E.get_wrapper=function(opt){opt=E._unwrap_opt(opt);return E.wrapper.find(function(w){return w.id==opt.id})};E.get_cdn_zone=function(opt){var wrapper=E.get_wrapper(opt);return wrapper&&wrapper.cdn&&wrapper.cdn.get_video_zone()};E.get_inited_wrapper=function(opt){if(E.disabled)return;var wrapper=E.get_wrapper(opt);return wrapper&&wrapper.video_ctx&&wrapper};var def_player;E.get_player=function(opt){return(E.get_wrapper(opt)||{}).player};E.list_players=function(opt){opt=opt||{};var log_fn=log[opt.level||"console"].bind(log);if(!E.ad_ctrl||!E.ad_ctrl.groups.length)return log_fn("no players detected so far");function group_describe(group){return"group="+group.players.map(function(p){return p.name+(p.is_ready()?"+":"-")}).join("")}function player_describe(player){if(!player)return"player=<missing>";return"player="+player.name+" tech="+player.tech}function video_describe(video_ctx){if(!video_ctx)return"state=idle";return"method="+video_ctx.method+" video_url="+video_ctx.video_url}log_fn("auto-detected players:");E.ad_ctrl.groups.forEach(function(g){var desc,w=g.wrapper,state=g.describe_state();switch(state){case"inited":desc=(w.id==def_player?"*":" ")+" id="+w.id+" inited=true "+player_describe(w.player)+" "+video_describe(w.video_ctx);break;default:desc="  id="+g.pid+" inited=false reason="+state+" "+group_describe(g);break}log_fn(desc)})};E.select_player=function(id){var hint="use hola_cdn.list_players() to print available options";if(id===undefined)return log.console("missing player id: "+hint);if(!E.get_wrapper(id))return log.console("no initialized player with id="+id+": "+hint);def_player=id;log.console("player id="+id+" selected as a default player")};E.get_video_ctx=function(opt){return(E.get_wrapper(opt)||{}).video_ctx};E._get_problem_reporter=function(opt){var video_ctx=E.get_video_ctx(opt);return video_ctx&&video_ctx.attached_problem_reporter||E.video_ctx_latest&&E.video_ctx_latest.detached_problem_reporter};E._get_bws=function(opt){return(E.get_video_ctx(opt)||{}).attached_bws};E.get_policy=function(opt){var bws;if(bws=E._get_bws(opt))return bws.policy();return"disabled"};E.attached_stats=function(opt){return(E.get_video_ctx(opt)||{}).attached_stats};function get_ordered_list(_zones){return Object.keys(_zones).map(function(z){_zones[z].zone=_zones[z].zone||z;return _zones[z]}).sort(function(a,b){return a.order-b.order})}var timer_id;E.get_stats=function(opt){opt=E._unwrap_opt(opt);var stat=E.attached_stats(opt);if(!stat)return;if(opt.silent)return stat.get_stats_all();clearTimeout(timer_id);if(opt.refresh>0)timer_id=setTimeout(E.get_stats.bind(E,opt),opt.refresh*1e3);return stat.print_stats()};E.api.external_err=function(opt){perr({id:"external_error",delay:false,add_log:true,bt:opt.stack,err:opt.message,info:{error:opt.message,reason:opt.reason}})};E.api.get_spark=function(){return spark};E._get_mode=function(opt){if(E.disabled)return"disabled";var zone=E.get_cdn_zone(opt);if(!zone)return"n/a";return zone.CG("mode")};E.get_mode=function(opt){var m=E._get_mode(opt);if(util.is_android_sdk||util.is_ios_sdk)return m;return m=="cdn"?"hola_cdn":m=="stats"?"origin_cdn":m};E.get_zones=function(){return{gen:gen,zones:get_ordered_list(zones)}};E.set_zones=function(_zones){zones=zutil.is_mocha()?_zones:zones};E.get_log=function(opt){opt=E._unwrap_opt(opt);if(opt.full)return E.log.get_full_history();var group=E.ad_ctrl&&E.ad_ctrl.groups.find(function(g){return g.pid==opt.id});return group?group.log.get_logs():_log.get_logs()};E.print_log=function(opt){log.console(JSON.stringify(E.get_log(opt),null,"	"))};E.get_avail_tech=mode&&!mode.__stub?mode.get_avail_tech:function(){};E.help=function(){log.console("Spark CDN GitHub page (https://github.com/spark-mv/cdn) - "+"Step by step instructions for deployment\n"+"Normal operations commands:\n"+"---------------------------\n"+"hola_cdn.set_mode_hola_cdn() - force cdn mode\n"+"hola_cdn.set_mode_bwsaver() - set bwsaver mode (MP4 only)\n"+"hola_cdn.set_mode_origin_cdn() - force stats mode\n"+"hola_cdn.set_mode_disabled() - disable Spark CDN\n"+"hola_cdn.set_mode_default() - set default mode (use server rules)\n"+"hola_cdn.get_stats() - print current stats to console\n"+"hola_cdn.get_mode() - get current operating mode\n"+"hola_cdn.get_zones() - get current zones conf\n"+"hola_cdn.get_avail_tech(url, player) - return available tech\n"+"Support commands:\n"+"---------------------------------\n"+"hola_cdn.save_log() - save log to disk; send it to Spark CDN "+"support\n"+"hola_cdn.bug_report() - bug report. email id to Spark CDN support\n"+"hola_cdn.print_log(options) - print log, set options.full=1 to "+"print full log history\n"+"hola_cdn.print_load_perf() - print timeline of performance events\n"+"hola_cdn.get_player() - return current player object\n"+"hola_cdn.list_players() - list available players (multiplayer env)\n"+"hola_cdn.select_player(id) - set default player (multiplayer env)\n"+"Debug commands (available only in debug mode):\n"+"---------------------------------\n"+"hola_cdn.debug_mode() - enable commands listed below\n\n"+"hola_cdn.get_log() - get log array\n"+"hola_cdn.gen_unittest() - return generated unittest\n"+"hola_cdn.set_debug(on, modules) - set debug mode on/off on=1 off=0, "+"on can be an object and you can provide explicit modules\n"+"hola_cdn.set_debug_stats(on) - enable/disable stats debug\n"+"hola_cdn.get_dump() - dump of media chunks passed to MediaStream\n"+"hola_cdn.get_conf()- get current conf\n"+"hola_cdn.clear_storage() - clear hola storage (settings, cache)\n",+"hola_cdn.debug_timeline() - debug stats timeline\n"+"hola_cdn.gen_timeline() - return generated timeline\n"+"hola_cdn.gen_timeline_str() - return generated timeline str\n"+"hola_cdn.parse_timeline(s) - parse timeline\n"+"hola_cdn.test_video_origin() - check whether there is a "+"source for current video origin\n"+"hola_cdn.is_browser_in_zone() - check whether there is a rule for "+"current browser\n"+"hola_cdn.test_fallback() - simulate fallback\n"+"hola_cdn.test_js_error() - simulate uncaught js exception\n"+"hola_cdn.test_player_error() - simulate player error\n"+"hola_cdn.test_swf_version() - check whether loaded swf version is "+"latest\n"+"hola_cdn.test_whitelisted_zagents() - check whether whitelisted "+"zagents working\n"+"hola_cdn.test_cors() - check if CORS configured")};E.debug_mode=function(enabled){var hola_debug=true;if(typeof enabled=="boolean"){hola_debug=enabled;var stor=storage.db.get_json("holacdn_debug")||{};stor.debug=hola_debug;storage.db.set_json("holacdn_debug",stor)}storage.session_db.set("hola_debug",hola_debug);util.debug_mode=_log.debug_mode=hola_debug};E.save_log=function(opt){var wrapper=E.get_wrapper(opt);if(!wrapper)return log.notice("no wrapper found");wrapper.save_logs()};E.bug_report=function(uid,opt,full){if(CG("loader.disable_bug_reports"))return;var problem_reporter;if(problem_reporter=E._get_problem_reporter(opt)){problem_reporter.send_problem_report({userid:uid,full:full});if(!full){log.console("To send bug_report with full history log, run: "+"hola_cdn.bug_report(true)")}return}E.list_players({level:"info"});var bugid=+(Math.random()+"").slice(2);perr({id:"err_problem_report",delay:false,full:true,add_log:true,info:{bugid:bugid}});log.console(util.get_perr_link_msg(this.customer,bugid))};function set_mode(m){storage.db.set("hola_mode",m);log.console(m+" mode is now enabled. Please refresh the page and "+"replay the video.\n\n You can always use hola_cdn.get_mode() to verify "+"current operation mode.")}E.set_mode_cdn=E.set_mode_hola_cdn=function(){set_mode("hola_cdn")};E.set_mode_bwsaver=function(){set_mode("bwsaver")};E.set_mode_stats=E.set_mode_origin_cdn=function(){set_mode("origin_cdn")};E.set_mode_disabled=function(){set_mode("disabled")};E.set_mode_default=function(){storage.db.set("hola_mode",null);log.console("default mode is now enabled. Please refresh the page and "+"replay the video. HolaCDN will be initialized based on settings "+"configured for this zone in the portal.\n\n You can always use "+"hola_cdn.get_mode() to verify current operation mode.")};E.console_repair=function(){var i=document.createElement("iframe");document.head.appendChild(i);window.console=i.contentWindow.console};E.get_dbg_conf=function(){var dbg_conf=storage.db.get_json("hola_dbg_conf");var window_dbg_conf=typeof window!="undefined"&&window.hola_dbg_conf;if(!window_dbg_conf&&!dbg_conf)return;dbg_conf=zutil.extend_deep({},window_dbg_conf,dbg_conf);if(!E.get_dbg_conf_warn){log.warn("using hola_dbg_conf "+JSON.stringify(dbg_conf));E.get_dbg_conf_warn=true}return dbg_conf};function auto_detect_start(){util.assert_enabled(autodetect,"autodetect is required but disabled");log.info("autoinit mode, waiting for player");E.ad_ctrl=autodetect.init({wrapper_fn:function(opt){return init_player(opt)}});E.ad_ctrl.start();return E.ad_ctrl}if(E.loader_conf.prototype_js){[Object,Array,String,Number].forEach(function(o){delete o.prototype.toJSON;Object.defineProperty(o.prototype,"toJSON",{writable:false})})}load_perf.init(E.loader_conf.load_perf);loader_init();load_perf.push("loader_init_finish");if(E.loader_conf.send_init_perr)perr({id:"loader_init",delay:false});function on_deps_err(err){err=err||{};perr({id:"loader_autoinit_failure",info:{stack:err.stack,message:err.message}})}function on_deps_ready(err){if(E.disabled)return;if(err)return on_deps_err(err);try{if(!zutil.is_mocha())auto_detect_start();load_perf.push("autodetect_init_finish");E.emit("autodetect_init")}catch(e){on_deps_err(e)}}if(typeof window.hola_cdn_on_load=="function")window.hola_cdn_on_load();return E});define("/svc/cdn/pub/loader.js",["/svc/cdn/pub/config.js","/svc/cdn/pub/cdn.js","/svc/cdn/pub/util.js"],function(){});

}());
